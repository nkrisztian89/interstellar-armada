define("modules/application",[],function(){"use strict";function t(t,e){(!e||a>=e)&&console.log(t)}var e,i,s={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},n="text/plain; charset=utf-8",o=null,r=!0,a=0,h="",l=!0;return{ErrorSeverity:s,getFolder:function(t){return t.length>0&&"/"===t[t.length-1]?t:o?void 0!==o[t]?o[t]:(this.showError("Asked for folder for file type '"+t+"', and folder for such files is not registered!",s.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+t+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),t+"/")},setFolders:function(t){var e="",i=function(e,n,o){var r=-1,a=-1,h="",l="";for(o=o||[];e.indexOf("{{")>=0;){if(!(e.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+e+"'",s.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(r=e.indexOf("{{"),a=e.indexOf("}}"),l=e.substring(r+2,a),h=t[l],!h)return this.showError("Invalid folder name specified! Cannot find referenced folder '"+e.substring(r+2,a)+"' in "+e+"!",s.SEVERE),null;if(!(o.indexOf(l)<0))return this.showError("Circular reference detected among the following folders: "+o.concat(n).join(", "),s.SEVERE),null;e=e.replace(e.substring(r,Math.min(a+3,e.length)),i(h,l,o.concat(n)))}return e}.bind(this);o={};for(e in t)t.hasOwnProperty(e)&&(o[e]=i(t[e],e))},setFileCacheBypassEnabled:function(t){r=t},setLogVerbosity:function(t){a=t},getVersion:function(){return h},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(t){h=t,requirejs.config({urlArgs:this.getVersionURLArg()})},setPreviouslyRunVersion:function(t){e=t,i=void 0===e},isFirstRun:function(){return i},hasVersionChanged:function(){return void 0!==i?e!==h:void this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},isDebugVersion:function(){return l},setDebugVersion:function(t){l=t},getFileURL:function(t,e){return this.getFolder(t)+(e+(r||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(t,e,i){var n="Error: "+t+(i?"\n\n"+i+"\n\n":"\n\n");switch(e){case s.CRITICAL:n+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case s.SEVERE:n+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case s.MINOR:n+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:n+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(n)},log:t,log_DEBUG:t,requestFile:function(t,e,i,n,o){this.log("Requesting file: '"+e+"' from "+(""!==this.getFolder(t)?"folder: '"+this.getFolder(t):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+e+"' successfully loaded.",2),i(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+e+"'.",s.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened."),i()}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+e+"' timed out.",s.SEVERE),i()}.bind(this),n&&r.overrideMimeType(n),o&&(r.responseType=o),r.open("GET",this.getFileURL(t,e),!0),r.send(null)},requestTextFile:function(t,e,i,s){this.requestFile(t,e,function(t){i(t?t.responseText:null)},s||n)},requestXMLFile:function(t,e,i){this.requestFile(t,e,function(t){var n=t?null===t.responseXML?(new DOMParser).parseFromString(t.responseText,"application/xml"):t.responseXML:null;n&&"parsererror"!==n.documentElement.nodeName?i(n):(this.showError("Could not parse XML file: '"+e+"'.",s.SEVERE,"The file could be loaded, but for some reason the parsing of it has failed. \nThe status of the request was: '"+t.statusText+"' when the error happened.\nThe text content of the file:\n"+(t.responseText.length>120?t.responseText.slice(0,120)+"...":t.responseText)),i())}.bind(this),"application/xml")},requestCSSFile:function(t,e,i){var s;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(s=document.createElement("link"),s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.onload=i,s.href=this.getFileURL(t,e),document.head.appendChild(s)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function t(){this._readyToUse=!1,this._onReadyQueue=[],this._triggeredOnreadyQueueLength=0}return t.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},t.prototype.isReadyToUse=function(){return this._readyToUse},t.prototype.resetReadyState=function(){this._readyToUse=!1},t.prototype.resetResource=function(){this._readyToUse=!1,this._onReadyQueue=[]},t.prototype.executeOnReadyQueue=function(){var t;for(this._triggeredOnreadyQueueLength=this._onReadyQueue.length,t=0;t<this._triggeredOnreadyQueueLength;t++)this._onReadyQueue[t]&&this._onReadyQueue[t].call(this),this._onReadyQueue[t]=null;this._onReadyQueue=this._onReadyQueue.length>this._triggeredOnreadyQueueLength?this._onReadyQueue.slice(this._triggeredOnreadyQueueLength):[]},t.prototype.setToReady=function(){this._readyToUse===!1&&(this._readyToUse=!0,this.executeOnReadyQueue())},t.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:t}}),define("modules/screen-manager",["modules/async-resource","modules/application"],function(t,e){"use strict";function i(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var s;return i.prototype=new t.AsyncResource,i.prototype.constructor=i,i.prototype.getCurrentScreen=function(){return this._currentScreen},i.prototype.getScreen=function(t){return t?this._screens[t]:this.getCurrentScreen()},i.prototype.addScreen=function(t,e,i){var s,n=function(){this._screensLoaded++,this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);if(e===!0)for(s in this._screens)this._screens.hasOwnProperty(s)&&this._screens[s].removeFromPage();this._screensToLoad++,this._screens[t.getName()]=t,e===!0?t.replacePageWithScreen(n):t.addScreenToPage(n,i),this._currentScreen||(this._currentScreen=t,this._currentScreen.setActive(!0))},i.prototype.setCurrentScreen=function(t,i,s){var n,o=this.getScreen(t);if(!o)return void e.showError("Cannot switch to screen '"+t+"', because it does not exist!");if(i!==!0&&null!==this._currentScreen)for(this._currentScreen.hide(),n=0;n<this._coveredScreens.length;n++)this._coveredScreens[n].hide();i===!0?(this._coveredScreens.push(this._currentScreen),this._currentScreen.setActive(!1),this._currentScreen=o,o.superimposeOnPage(s)):(this._currentScreen=o,o.show()),this._currentScreen===o&&this._currentScreen.setActive(!0)},i.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop(),this._currentScreen.setActive(!0)},i.prototype.closeOrNavitageTo=function(t){this.getCurrentScreen().isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(t)},i.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},s=new i,{getCurrentScreen:s.getCurrentScreen.bind(s),getScreen:s.getScreen.bind(s),addScreen:s.addScreen.bind(s),setCurrentScreen:s.setCurrentScreen.bind(s),closeSuperimposedScreen:s.closeSuperimposedScreen.bind(s),closeOrNavitageTo:s.closeOrNavitageTo.bind(s),updateAllScreens:s.updateAllScreens.bind(s),executeWhenReady:s.executeWhenReady.bind(s)}}),define("utils/utils",[],function(){"use strict";var t={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},e={LEFT:1,MIDDLE:2,RIGHT:3},i=[],s=" ",n={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"*":106,"numpad +":107,"numpad -":109,"/":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"-":173,",":188,".":190},o={};return o.EMPTY_ARRAY=i,o.ScaleMode=t,o.MouseButton=e,o.scalesWithWidth=function(e,i,s){return e===t.WIDTH||e===t.MINIMUM&&s>i||e===t.MAXIMUM&&i>=s},o.xScalesWithWidth=function(e,i,s){return e===t.ASPECT||e===t.WIDTH||e===t.MINIMUM&&s>i||e===t.MAXIMUM&&i>=s},o.yScalesWithHeight=function(e,i,s){return e===t.ASPECT||e===t.HEIGHT||e===t.MINIMUM&&i>s||e===t.MAXIMUM&&s>=i},o.getRGBColorFromXMLTag=function(t){return[parseFloat(t.getAttribute("r")),parseFloat(t.getAttribute("g")),parseFloat(t.getAttribute("b"))]},o.getDimensionsFromXMLTag=function(t){return[parseFloat(t.getAttribute("w")),parseFloat(t.getAttribute("h")),parseFloat(t.getAttribute("d"))]},o.evaluateProduct=function(t){var e,i,s;for(e=t.split("*"),i=1,s=0;s<e.length;s++)i*=parseFloat(e[s]);return i},o.getFirstXMLElement=function(t,e){var i=t.getElementsByTagName(e);return i.length>0?i[0]:null},o.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):n[t]:-1},o.getKeyOfCode=function(t){var e;for(e in n)if(n[e]===t)return e;return"#"+t},o.arraysEqual=function(t,e){var i,s;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,s=t.length;s>i;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},o.objectsEqual=function(t,e){var i,s,n;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t).sort(),!e)return!1;if(s=Object.keys(e).sort(),i.length!==s.length)return!1;for(n=0;n<i.length;n++)if(i[n]!==s[n]||t[i[n]]!==e[s[n]])return!1;return!0},o.equivalent=function(t,e){var i,s,n,r;if("object"==typeof t&&"object"==typeof e){if(null===t||null===e)return t===e;if(t instanceof Array&&e instanceof Array){if(t.length!==e.length)return!1;for(i=0,s=t.length;s>i;i++)if(!o.equivalent(t[i],e[i]))return!1;return!0}if(n=Object.keys(t).sort(),r=Object.keys(e).sort(),n.length!==r.length)return!1;for(i=0,s=n.length;s>i;i++)if(n[i]!==r[i]||!o.equivalent(t[n[i]],e[r[i]]))return!1;return!0}return t===e},o.deepCopy=function(t){var e,i,s;if("object"==typeof t){if(t instanceof Array){for(e=[],i=0;i<t.length;i++)e.push(o.deepCopy(t[i]));return e}for(e={},s=Object.keys(t),i=0;i<s.length;i++)e[s[i]]=o.deepCopy(t[s[i]]);return e}return t},o.removeFromArray=function(t,e){var i=t.indexOf(e);return i>=0?(t.splice(i,1),!0):!1},o.getSafeEnumValue=function(t,e,i){var s;i=i?o.getSafeEnumValue(t,i):null;for(s in t)if(t.hasOwnProperty(s)&&e===t[s])return e;return i||null},o.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},o.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},o.getPaddedStringForNumber=function(t,e,i){var s,n=t.toString(i||10);for(s=n.length;e>s;s++)n="0"+n;return n},o.getDelimitedStringForNumber=function(t){return t>=1e3?o.getDelimitedStringForNumber(Math.floor(t/1e3))+s+o.getPaddedStringForNumber(t%1e3,3):t.toString()},o.getLengthString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" m":Math.round(t)+" m":1e5>t?(t/1e3).toPrecision(3)+" km":o.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},o.getMassString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" kg":Math.round(t)+" kg":1e5>t?(t/1e3).toPrecision(3)+" t":o.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},o.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]?"_":t[e].toUpperCase();return i},o.formatString=function(t,e){var i,s=t.toString();for(i in e)e.hasOwnProperty(i)&&(s=s.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return s},o.formatTimeToMinutes=function(t){var e,i;return e=Math.floor(t/6e4),i=Math.floor(t/1e3)%60,o.getPaddedStringForNumber(e,2)+":"+o.getPaddedStringForNumber(i,2)},o.formatTimeToSeconds=function(t){var e,i;return e=Math.floor(t/1e3)%60,i=Math.floor(t%1e3/10),o.getPaddedStringForNumber(e,2)+"."+o.getPaddedStringForNumber(i,2)},o.executeAsync=function(t){setTimeout(t,0)},o.pointInRect=function(t,e,i,s,n,o){return t>=i&&n>=t&&e>=s&&o>=e},o.getFilenameWithoutExtension=function(t){var e=t.lastIndexOf("."),i=t.lastIndexOf("/");return t=e>0?t.substr(0,e):t,t=i>0?t.substr(i+1):t},o.getLinearMix=function(t,e,i){return t*(1-i)+e*i},o.getMixedColor=function(t,e,i){var s=1-i;return[t[0]*s+e[0]*i,t[1]*s+e[1]*i,t[2]*s+e[2]*i,t[3]*s+e[3]*i]},o.getCSSColor=function(t){return"rgba("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+","+t[3]+")"},o.getHexColor=function(t){return"#"+o.getPaddedStringForNumber(Math.round(255*t[0]),2,16)+o.getPaddedStringForNumber(Math.round(255*t[1]),2,16)+o.getPaddedStringForNumber(Math.round(255*t[2]),2,16)},o.getColor3FromHex=function(t){var e=[0,0,0];return e[0]=parseInt(t.substr(1,2),16)/255,e[1]=parseInt(t.substr(3,2),16)/255,e[2]=parseInt(t.substr(5,2),16)/255,e},o.getGreaterSolutionOfQuadraticEquation=function(t,e,i){var s=e*e-4*t*i;return s>=0?(Math.sqrt(s)-e)/(2*t):NaN},o}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function i(t,e,i,s){return"Invalid value for '"+t+"' ("+e+")"+(s?": "+s:".")+" Using default value "+i+" instead."}function s(t,s,n,o){e.showError(i(t,s,n,o))}function n(t,s,n,o,r){e.log(i(t,s,n,o),void 0!==r?r:_)}function o(t,e,i,s){return"Invalid value for '"+e+"'. Expected "+t+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(s instanceof Array?"["+s.join(", ")+"]":"'"+s+"'")+" instead."}function r(t,i,s,n){e.showError(o(t,i,s,n))}function a(t,i,s,n,r){e.log(o(t,i,s,n),void 0!==r?r:_)}function h(e,i,s,n){return"Unrecognized '"+e+"' value: '"+i+"'. Possible values are are: "+t.getEnumValues(s).join(", ")+". Default value '"+n+"' will be used instead."}function l(t,i,s,n){e.showError(h(t,i,s,n))}function u(t,i,s,n,o){e.log(h(t,i,s,n),void 0!==o?o:_)}var c={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},_=1,p={Errors:c};return p.NUMBER="number",p.VECTOR2={baseType:"array",length:2,elementType:"number"},p.VECTOR3={baseType:"array",length:3,elementType:"number"},p.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},p.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},p.DURATION={baseType:"number",range:[0,void 0]},p.ANGLE_DEGREES={baseType:"number",range:[-360,360]},p.getBooleanValue=function(t,e){if(e=e||{},e.name=e.name||"unnamed boolean","boolean"==typeof t){if(!e.checkFunction||e.checkFunction(t,e.parentObject))return t;e.error=c.CHECK_FAIL_ERROR,e.silentFallback?n(e.name,t,e.defaultValue,e.checkFailMessage):s(e.name,t,e.defaultValue,e.checkFailMessage)}else e.error=c.TYPE_ERROR,e.silentFallback?a("a boolean",e.name,t,e.defaultValue):r("a boolean",e.name,t,e.defaultValue);return null!==e.defaultValue?(t=e.defaultValue,e.defaultValue=null,p.getBooleanValue(t,e)):null},p.getNumberValue=function(t,e,i,n,o,a,h){return"number"==typeof e?n&&!n(e,a)?(s(t,e,i,o),null!==i?p.getNumberValue(t,i,null,n,o,a):null):e:("number"==typeof i&&h||r("a number",t,e,i),null!==i?p.getNumberValue(t,i,null,n,o,a):null)},p.getNumberValueInRange=function(t,i,n,o,a,h,l,u){return"number"==typeof i?((void 0!==n&&n>i||void 0!==o&&i>o)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==n?n:"...")+"-"+(void 0!==o?o:"...")+"). The setting will be changed to fit the valid range."),void 0!==n&&(i=Math.max(n,i)),void 0!==o&&(i=Math.min(i,o))),h&&!h(i,u)?(s(t,i,a,l),null!==a?p.getNumberValueInRange(t,a,n,o,null,h,l,u):null):i):(r("a number",t,i,a),null!==a?p.getNumberValueInRange(t,a,n,o,null,h,l,u):null)},p.getStringValue=function(t,e,i,n,o,a){return"string"==typeof e?n&&!n(e,a)?(s(t,e,i,o),null!==i?p.getStringValue(t,i,null,n,o,a):null):e:(r("a string",t,e,i),null!==i?p.getStringValue(t,i,null,n,o,a):null)},p.getEnumValue=function(i,o,r){var a=t.getSafeEnumValue(i,o);if(r=r||{},r.name=r.name||"unnamed enum "+i.constructor.name,null!==a){if(!r.checkFunction||r.checkFunction(a,r.parentObject))return a;r.error=c.CHECK_FAIL_ERROR,r.silentFallback?n(r.name,a,r.defaultValue,r.checkFailMessage):s(r.name,a,r.defaultValue,r.checkFailMessage)}else{if("object"!=typeof i||0===Object.keys(i).length)return r.error=c.INVALID_ENUM_OBJECT_ERROR,e.showError("Invalid enum object specified for "+r.name+": "+i+", and thus its value ("+o+") cannot be verified!"),null;r.error=c.ENUM_VALUE_ERROR,r.silentFallback?u(r.name,o,i,r.defaultValue):l(r.name,o,i,r.defaultValue)}return null!==r.defaultValue?(o=r.defaultValue,r.defaultValue=null,p.getEnumValue(i,o,r)):null},p.getObjectValue=function(t,e,i,n,o,a){return"object"==typeof e?n&&!n(e,a)?(s(t,e,i,o),null!==i?p.getObjectValue(t,i,null,n,o,a):null):e:(r("an object",t,e,i),null!==i?p.getObjectValue(t,i,null,n,o,a):null)},p.getValueOfType=function(t,i,s,n,o,r,a,h,l){if(r=r||{},void 0===s)return void 0!==n?null!==n?p.getValueOfType(t,i,n,null,o,r,a,h,l):null:void(o||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return i.baseType?p.getValueOfType(t,i.baseType,s,n,o,i,a,h,l):p.getVerifiedObject(t,s,i);switch(i){case"boolean":return p.getBooleanValue(s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:h,parentObject:l});case"number":return r.range?p.getNumberValueInRange(t,s,r.range[0],r.range[1],n,a,h,l):p.getNumberValue(t,s,n,a,h,l);case"string":return p.getStringValue(t,s,n,a,h,l);case"enum":return r.values?p.getEnumValue(r.values,s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:h,parentObject:l}):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return r.properties?p.getVerifiedObject(t,s,r.properties):p.getObjectValue(t,s,n,a,h,l);case"array":return p.getArrayValue(t,s,r.elementType,r.elementTypeParams,r,n,a,h,r.elementCheck,r.elementCheckFailMessage,l);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},p.getArrayValue=function(t,i,n,o,a,h,l,u,c,_,d){var g,f=[];if(i instanceof Array){if(void 0!==a){if(void 0!==a.length&&i.length!==a.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+a.length+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,n,o,a,null,l,u,c,_,d):null;if(void 0!==a.minLength&&i.length<a.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+a.minLength+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,n,o,a,null,l,u,c,_,d):null;if(void 0!==a.maxLength&&i.length>a.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+a.maxLength+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,n,o,a,null,l,u,c,_,d):null}return void 0!==n&&(i.forEach(function(e,i){g=p.getValueOfType(t+"["+i+"]",n,e,null,!1,o,c,_,d),null!==g&&f.push(g)}),i=f),l&&!l(i)?(s(t,i,"["+h.join(", ")+"]",u),null!==h?p.getArrayValue(t,h,n,o,a,null,l,u,c,_,d):null):i}return r("an array",t,i,h),null!==h?p.getArrayValue(t,h,n,o,a,null,l,u,c,_,d):null},p.getVerifiedObject=function(t,i,s,n,o,r,a){var h,l,u,c,_,d,g=n||{},f=[];if("object"==typeof i){for(l in s)if(s.hasOwnProperty(l)){if(u=s[l],g[u.name]&&e.showError("'"+t+"' already has a property named '"+u.name+"', which will be overridden by a new value!"),!u.type&&!a)for(c={},d=Object.keys(u),_=0;_<d.length;_++)"object"==typeof u[d[_]]&&(c[d[_]]=u[d[_]]);g[u.name]=p.getValueOfType(t+"."+u.name,u.type||c||a,i[u.name],u.defaultValue,u.optional,{range:u.range,values:u.values,elementType:u.elementType,elementEnumObject:u.elementEnum,length:u.length,minLength:u.minLength,maxLength:u.maxLength,elementCheck:u.elementCheck,elementCheckFailMessage:u.elementCheckFailMessage,properties:u.properties},u.check,u.checkFailMessage,i),f.push(u.name)}if(!r||o)for(h in i)i.hasOwnProperty(h)&&f.indexOf(h)<0&&(r||e.showError("Unrecognized property '"+h+"' defined for '"+t+"'. The value of this property "+(a?"can be verified only against the default property type":"cannot be verified ")+(o?"but will be included.":"and will be discarded.")),o&&(a?g[h]=p.getValueOfType(t+"."+h,a,i[h]):g[h]=i[h]));return g}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},p.getBooleanValueFromLocalStorage=function(t,e){var i;return i=localStorage[t]===(!0).toString()?!0:localStorage[t]===(!1).toString()?!1:localStorage[t],e=e||{},e.name=e.name||"localStorage."+t,p.getBooleanValue(i,e)},p.getNumberValueFromLocalStorage=function(t,e){var i=parseFloat(localStorage[t]);return isNaN(i)&&(i=localStorage[t]),e=e||{},e.name=e.name||"localStorage."+t,p.getNumberValue(e.name,i,e.defaultValue,e.checkFunction,e.checkFailMessage,e.parentObject,e.silentFallback)},p.getEnumValueFromLocalStorage=function(t,e,i){return i=i||{},i.name=i.name||"localStorage."+e,p.getEnumValue(t,localStorage[e],i)},p.getValueOfTypeFromLocalStorage=function(t,i,s){if("object"==typeof t)return s.values=t.values,p.getValueOfTypeFromLocalStorage(t.baseType,i,s);switch(t){case"boolean":return p.getBooleanValueFromLocalStorage(i,s);case"number":return p.getNumberValueFromLocalStorage(i,s);case"enum":return p.getEnumValueFromLocalStorage(s.values,i,s);default:e.crash()}},p.getNameAndValueDefinitionObject=function(t){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:t,type:"number"}}}},p.getEnumObjectForArray=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},p}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function i(t){var e,n;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){i(t[e]);for(n in t[e])t[e].hasOwnProperty(n)&&(t[e+s+n]=t[e][n]);delete t[e]}}var s=".",n={},o=null,r={},a={};return n.getLanguage=function(){return o},n.setLanguage=function(t){a.hasOwnProperty(t)?o=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},n.languageIsLoaded=function(t){return a.hasOwnProperty(t)},n.loadStrings=function(e,s,h){var l;r[e]={},i(s);for(l in h)h.hasOwnProperty(l)&&"object"==typeof h[l]&&t.getVerifiedObject("strings."+l,s,h[l],r[e],!1,!0,"string");a[e]=t.getVerifiedObject("strings."+l,s,{},null,!0,!0,"string"),o||n.setLanguage(e)},n.get=function(t,e,i){return a[o]&&a[o][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},n.has=function(t,e){return a[o]&&void 0!==a[o][t.name+(e||"")]},n.CATEGORY_SEPARATOR=s,n}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var s=!1,n=!1,o=!1,r=null,a=null,h=null,l=null,u=null,c=null,_=null,p=function(){s&&n&&o&&(t.log("Initialization of "+r+" completed."),document.body.firstElementChild.style.display="none",e.setCurrentScreen(a))},d=function(){t._buildScreensAndExecuteCallback(function(){o=!0,p()})},g=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),n=!0,d()})})},f=function(){t.requestTextFile(h,l,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.log("Game version is: "+t.getVersion(),1),u=i.defaultLanguage,c=i.configFiles.strings,requirejs(["modules/media-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.media.resources,function(){t.log("Game configuration loaded."),s=!0}),g(i.configFiles.settings)})})})};return t._loadGameSettingsAndExecuteCallback=function(){t.showError("You need to override the _loadGameSettings method!")},t._loadGameConfigurationAndExecuteCallback=function(){t.showError("You need to override the _loadGameConfiguration method!")},t._buildScreensAndExecuteCallback=function(){t.showError("You need to override the _buildScreensAndExecuteCallback method!")},t.setGameName=function(t){r=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){h=t},t.setConfigFileName=function(t){l=t},t.getDefaultLanguage=function(){return u},t.getLanguage=function(){return i.getLanguage()||u},t.getLanguages=function(){return Object.keys(c)},t.getDefaultCursor=function(){return _},t.requestLanguageChange=function(s,n,o){return c&&c[s]?(i.languageIsLoaded(s)?(i.setLanguage(s),e.updateAllScreens(),o(!1)):t.requestTextFile(c[s].folder,c[s].filename,function(t){i.loadStrings(s,JSON.parse(t),n),i.setLanguage(s),e.updateAllScreens(),o(!0)}),!0):(t.showError("Cannot change application language to '"+s+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(){return t.log("Initializing "+r+"..."),"file:"===location.protocol?void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar."):(_=document.body.style.cursor,void f())},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavitageTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,s){"use strict";function n(t){return K[t]&&!!K[t].model}function o(t){return K[t]&&K[t].model}function r(t){return K[t]&&K[t].requested}function a(t,i){r(t)?n(t)?i&&i():K[t].onLoadQueue.push(i):(K[t]={},K[t].requested=!0,K[t].onLoadQueue=[i],e.requestTextFile(S,t,function(e){var i;for(K[t].model=document.implementation.createHTMLDocument(),K[t].model.documentElement.innerHTML=e,i=0;i<K[t].onLoadQueue.length;i++)K[t].onLoadQueue[i]()}))}function h(t){return t.caption||s.get({name:t.id})}function l(){K={}}function u(t,e,i){this._name=t,this._elementID=e||t,this._element=null,this._displayStyle=null,this._onShow=i?i[U]:null,this._onHide=i?i[B]:null,this._onEnable=i?i[j]:null,this._onDisable=i?i[G]:null,this._onSelect=i?i[k]:null,this._onUnselect=i?i[H]:null}function c(t,e,s){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=s||{},this._rootElement=null,this._rootElementDefaultDisplayMode=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function _(t,e,i,s){c.call(this,t,e,i),this._progress=this.registerSimpleComponent(E),this._status=this.registerSimpleComponent(b),this._header=this.registerSimpleComponent(M),this._headerID=s}function p(t,e,i,s,n,o){c.call(this,t,e,i),this._onShow=o?o[U]:null,this._onHide=o?o[B]:null,this._onButtonSelect=o?o[q]:null,this._onButtonClick=o?o[W]:null,this._message=this.registerSimpleComponent(O),this._okButton=this.registerSimpleComponent(A,this._onButtonSelect?{select:function(){this._onButtonSelect(this._okButton.isEnabled())}.bind(this)}:null),this._header=this.registerSimpleComponent(x),this._headerID=s,this._okButtonID=n,this._handleKeyUp=function(t){t.keyCode===L?this._okButton.getElement().onclick():(t.keyCode===D||t.keyCode===w)&&this._okButton.select()}.bind(this)}function d(t,e,i,s,n){var o;for(c.call(this,t,e,i),this._menuOptions=s,o=0;o<this._menuOptions.length;o++)void 0===this._menuOptions[o].enabled&&(this._menuOptions[o].enabled=!0);this._selectedIndex=-1,this._onOptionSelect=n?n[z]:null,this._onOptionClick=n?n[X]:null,this._validateStyle(i)}function g(t,e,i,s,n,o){var r;for(c.call(this,t,e,i),this._listElements=s,r=0;r<this._listElements.length;r++)void 0===this._listElements[r].enabled&&(this._listElements[r].enabled=!0);this._subcaptions=n,this._highlightedIndex=-1,this._selectedIndex=-1,this._onElementHighlight=o?o[Y]:null,this._onElementSelect=o?o[J]:null,this._validateStyle(i)}function f(t,e,i,s,n){c.call(this,t,e,i),this._propertyLabelDescriptor=s,this._valueList=n,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(R),this._valueSelector=this.registerSimpleComponent(C),this.onChange=null}function m(t,e,i,s,n,o){c.call(this,t,e,i),this._propertyLabelDescriptor=s,n=n||{},this._min=n.valueList?0:n.min,this._max=n.valueList?n.valueList.length-1:n.max,this._default=n["default"],this._step=n.valueList?1:void 0!==n.step?n.step:1,this._valueList=n.valueList||null,this._propertyLabel=this.registerSimpleComponent(I),this._slider=this.registerSimpleComponent(v),this._valueLabel=this.registerSimpleComponent(N),this.onChange=o||null}var y="_",S="component",T="css",E="progress",b="status",M="header",O="message",A="okButton",x="header",R="property",C="value",I="property",v="slider",N="valueLabel",L=13,D=38,w=40,F="disabled",P="selected",V="highlighted",U="show",B="hide",j="enable",G="disable",k="select",H="unselect",q="buttonselect",W="buttonclick",z="optionselect",X="optionclick",Y="elementhighlight",J="elementselect",Q="data-translation-key",K={};return u.prototype.getName=function(){return this._name},u.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},u.prototype.getElement=function(){return this._element},u.prototype.getContent=function(){return this._element.innerHTML},u.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},u.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},u.prototype.getAttribute=function(t){return this._element[t]},u.prototype.setAttribute=function(t,e){this._element[t]=e},u.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element?this._displayStyle=this._element.style.display:e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},u.prototype.resetComponent=function(){this._element=null,this._displayStyle=null},u.prototype.isVisible=function(){return"none"!==this._element.style.display},u.prototype.hide=function(){this.isVisible()&&(this._element.style.display="none",this._onHide&&this._onHide())},u.prototype.show=function(){this.isVisible()||(this._element.style.display=this._displayStyle,this._onShow&&this._onShow())},u.prototype.setVisible=function(t){t?this.show():this.hide()},u.prototype.isEnabled=function(){return!this._element.classList.contains(F)},u.prototype.disable=function(){this.isEnabled()&&(this._element.classList.add(F),this._onDisable&&this._onDisable())},u.prototype.enable=function(){this.isEnabled()||(this._element.classList.remove(F),this._onEnable&&this._onEnable())},u.prototype.isSelected=function(){return this._element.classList.contains(P)},u.prototype.select=function(){
this.isSelected()||(this._element.classList.add(P),this._onSelect&&this._onSelect())},u.prototype.unselect=function(){this.isSelected()&&(this._element.classList.remove(P),this._onUnselect&&this._onUnselect()),this._element.blur()},c.prototype=new i.AsyncResource,c.prototype.constructor=c,c.prototype.getName=function(){return this._name},c.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i].getName()))},c.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile(T,this._style.cssFilename,function(){this._cssLoaded=!0,n(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,a(this._htmlFilename,function(){this._cssLoaded===!0&&this.setToReady()}.bind(this))},c.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(o(this._htmlFilename).body.firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),this._rootElementDefaultDisplayMode=this._rootElement.style.display,e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},c.prototype._getElementID=function(t){return this._rootElementID+y+t},c.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+y.length)},c.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();else e.log("WARNING! Attempting to initaialize external component "+this._name+" before appending it to the page! It will be initialized automatically once it is added.")},c.prototype.updateComponents=function(){var t,i;if(this._rootElement)for(i=this._rootElement.querySelectorAll("["+Q+"]"),t=0;t<i.length;t++)i[t].innerHTML=s.get({name:i[t].getAttribute(Q),defaultValue:i[t].innerHTML});else e.log("WARNING! Attempting to update external component "+this._name+" before appending it to the page!")},c.prototype.registerSimpleComponent=function(t,e){var i=new u(t,this._getElementID(t),e);return this._simpleComponents.push(i),i},c.prototype.resetComponent=function(){var t;for(this.resetResource(),t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].resetComponent()},c.prototype.isVisible=function(){return!("none"===this._rootElement.style.display)},c.prototype.show=function(){if(this._rootElement){if(!this.isVisible())return this._rootElement.style.display=this._rootElementDefaultDisplayMode,!0}else e.log("WARNING! Attempting to show external component "+this._name+" before appending it to the page!");return!1},c.prototype.hide=function(){if(this._rootElement){if(this.isVisible())return this._rootElement.style.display="none",!0}else e.log("WARNING! Attempting to hide external component "+this._name+" before appending it to the page!");return!1},_.prototype=new c,_.prototype.constructor=_,_.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},_.prototype.setMaxProgress=function(t){this._rootElement?this._progress.getElement().max=t:e.log("WARNING! Attempting to update the maximum progress value of loading box"+this._name+" before appending it to the page!")},_.prototype.updateProgress=function(t){this._rootElement?this._progress.getElement().value=t:e.log("WARNING! Attempting to update the progress value of loading box"+this._name+" before appending it to the page!")},_.prototype.updateStatus=function(t,i,s){this._rootElement?(this._status.setContent(t,i),void 0!==s&&this.updateProgress(s)):e.log("WARNING! Attempting to update the status message of loading box"+this._name+" before appending it to the page!")},p.prototype=new c,p.prototype.constructor=p,p.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton.getElement().onmouseenter=function(){this._okButton.select()}.bind(this),this._okButton.getElement().onmouseleave=function(){this._okButton.unselect()}.bind(this),this._okButton.getElement().onclick=function(){return this._onButtonClick&&this._onButtonClick(this._okButton.isEnabled()),this.hide(),!1}.bind(this),c.prototype.hide.call(this))},p.prototype.show=function(){return c.prototype.show.call(this)?(this._okButton.unselect(),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow(),!0):!1},p.prototype.hide=function(){return c.prototype.hide.call(this)?(document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide(),!0):!1},p.prototype.updateMessage=function(t,i){this._rootElement?this._message.setContent(t,i):e.log("WARNING! Attempting to update the message of info box"+this._name+" before appending it to the page!")},d.prototype=new c,d.prototype.constructor=d,d.prototype._validateStyle=function(t){return"object"!=typeof t?void e.showError("Invalid menu style specified: not an object!"):(t.selectedButtonClassName||e.showError("Attempting to specify a menu style without specifying a class for selected menu buttons!"),void(t.disabledClassName||e.showError("Attempting to specify a menu style without specifying a class for disabled menu buttons!")))},d.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&(this._menuOptions[this._selectedIndex].element.classList.remove(this._style.selectedButtonClassName),this._menuOptions[this._selectedIndex].element.blur()),this._selectedIndex=t,this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].enabled&&(this._menuOptions[this._selectedIndex].element.classList.add(this._style.selectedButtonClassName),this._onOptionSelect&&this._onOptionSelect(!0)))},d.prototype._getMenuClickHandler=function(t){return function(){return this._menuOptions[t].enabled&&(this._selectIndex(t),this._menuOptions[t].action()),this._onOptionClick&&this._onOptionClick(this._menuOptions[t].enabled),!1}.bind(this)},d.prototype._getMenuMouseMoveHandler=function(t){return function(){this._menuOptions[t].enabled&&this._selectIndex(t)}.bind(this)},d.prototype._initializeComponents=function(){var t,e,i;if(c.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.menuClassName),t=0;t<this._menuOptions.length;t++)e=document.createElement("a"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id),e.setAttribute(Q,this._menuOptions[t].id)),e.href="#",e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||"")+(this._menuOptions[t].enabled?"":this._style.disabledClassName),e.innerHTML=h(this._menuOptions[t]),e.onclick=this._getMenuClickHandler(t),e.onmousemove=this._getMenuMouseMoveHandler(t),this._menuOptions[t].element=e,i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i);this._rootElement.onmouseout=this.unselect.bind(this)}},d.prototype.unselect=function(){this._selectIndex(-1)},d.prototype.selectNext=function(){var t=this._selectedIndex;-1===t&&(t=this._menuOptions.length-1);do this._selectIndex((this._selectedIndex+1)%this._menuOptions.length);while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},d.prototype.selectPrevious=function(){var t=this._selectedIndex;-1===t&&(t=0);do this._selectedIndex>0?this._selectIndex(this._selectedIndex-1):this._selectIndex(this._menuOptions.length-1);while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},d.prototype.activateSelected=function(){this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].element.onclick()},g.prototype=new c,g.prototype.constructor=g,g.prototype._validateStyle=function(t){return"object"!=typeof t?void e.showError("Invalid menu style specified: not an object!"):(t.disabledElementClassName||e.showError("Attempting to specify a list style without specifying a class for disabled list elements!"),t.selectedElementClassName||e.showError("Attempting to specify a list style without specifying a class for selected list elements!"),void(t.highlightedElementClassName||e.showError("Attempting to specify a list style without specifying a class for highlighted list elements!")))},g.prototype._highlightIndex=function(t,e){var i;t!==this._highlightedIndex&&(this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.classList.remove(this._style.highlightedElementClassName),this._highlightedIndex=t,this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].enabled&&(this._listElements[this._highlightedIndex].element.classList.add(this._style.highlightedElementClassName),e&&(i=this._listElements[this._highlightedIndex].element,i.offsetTop<this._rootElement.scrollTop?this._rootElement.scrollTop=i.offsetTop:i.offsetTop+i.offsetHeight>this._rootElement.scrollTop+this._rootElement.clientHeight&&(this._rootElement.scrollTop=i.offsetTop+i.offsetHeight-this._rootElement.clientHeight)),this._onElementHighlight&&this._onElementHighlight(t,!0)))},g.prototype._selectIndex=function(t){t!==this._selectedIndex&&((0>t||t>=0&&this._listElements[t].enabled)&&(this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.remove(this._style.selectedElementClassName),this._selectedIndex=t,this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.add(this._style.selectedElementClassName)),this._onElementSelect&&this._onElementSelect(t,t>=0&&this._listElements[t].enabled))},g.prototype.getHighlightedIndex=function(){return this._highlightedIndex},g.prototype.getSelectedIndex=function(){return this._selectedIndex},g.prototype._getElementClickHandler=function(t){return function(){return this._listElements[t].enabled&&(this._highlightIndex(t),this._selectIndex(t)),!1}.bind(this)},g.prototype._getElementMouseMoveHandler=function(t){return function(){this._listElements[t].enabled?this._highlightIndex(t):this._highlightIndex(-1)}.bind(this)},g.prototype._initializeComponents=function(){var t,e,i,n,o;if(c.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.listContainerClassName),e=document.createElement("ul"),e.classList.add(this._style.listClassName),t=0;t<this._listElements.length;t++)o=document.createElement("li"),o.className=this._style.elementContainerClassName||"",n=document.createElement("a"),n.className=(this._style.elementClassName||"")+" "+(this._listElements[t].enabled?"":this._style.disabledElementClassName),this._listElements[t].element=n,n.onclick=this._getElementClickHandler(t),n.onmousemove=this._getElementMouseMoveHandler(t),o.appendChild(n),i=document.createElement("span"),this._listElements[t].captionID&&i.setAttribute(Q,this._listElements[t].captionID),i.className=this._style.captionClassName||"",i.innerHTML=this._listElements[t].caption||s.get({name:this._listElements[t].captionID}),n.appendChild(i),this._subcaptions&&(n.appendChild(document.createElement("br")),i=document.createElement("span"),this._listElements[t].subcaptionID&&i.setAttribute(Q,this._listElements[t].subcaptionID),i.className=this._style.subcaptionClassName||"",i.innerHTML=this._listElements[t].subcaption||s.get({name:this._listElements[t].subcaptionID}),n.appendChild(i)),e.appendChild(o);this._rootElement.onmouseleave=this.unhighlight.bind(this),this._rootElement.appendChild(e)}},g.prototype.unhighlight=function(){this._highlightIndex(-1)},g.prototype.unselect=function(){this._selectIndex(-1)},g.prototype.reset=function(){this.unselect(),this.unhighlight(),this._rootElement.scrollTop=0},g.prototype.highlightNext=function(){var t=this._highlightedIndex;-1===t&&(t=this._listElements.length-1);do this._highlightIndex((this._highlightedIndex+1)%this._listElements.length,!0);while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},g.prototype.highlightPrevious=function(){var t=this._highlightedIndex;-1===t&&(t=0);do this._highlightedIndex>0?this._highlightIndex(this._highlightedIndex-1,!0):this._highlightIndex(this._listElements.length-1,!0);while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},g.prototype.selectHighlighted=function(){this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.onclick()},g.prototype.executeForListElements=function(t){var e;for(e=0;e<this._listElements.length;e++)t(this._listElements[e].element)},f.prototype=new c,f.prototype.constructor=f,f.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._style.selectorClassName&&(this._rootElement.className=this._style.selectorClassName),this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.getElement().setAttribute(Q,this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(h(this._propertyLabelDescriptor)),this._style.propertyContainerClassName&&(this._propertyLabel.getElement().className=this._style.propertyContainerClassName),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector.getElement().onclick=function(){return this.selectNextValue(),!1}.bind(this))},f.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i):e.showError("Attempted to select value: '"+t+"' for '"+h(this._propertyLabelDescriptor)+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},f.prototype.selectValueWithIndex=function(t){var i=this._valueIndex;this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),i!==t&&this.onChange&&this.onChange()):e.showError("Attempted to select value with index '"+t+"' for '"+h(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},f.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},f.prototype.getSelectedIndex=function(){return this._valueIndex},f.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length)},f.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},m.prototype=new c,m.prototype.constructor=m,m.prototype._initializeComponents=function(){var t=function(){this._updateValueLabel(),this.onChange&&this.onChange(this.getValue())}.bind(this);c.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.getElement().setAttribute(Q,this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(h(this._propertyLabelDescriptor)),this._valueList?(this.setValueList(this._valueList),this._valueLabel.show()):(this._valueLabel.hide(),this._updateSlider()),this.setNumericValue(this._default),this._slider.getElement().onchange=t,this._slider.getElement().oninput=t)},m.prototype._updateSlider=function(){this._slider.setAttribute("min",this._min),this._slider.setAttribute("max",this._max),this._slider.setAttribute("step",this._step)},m.prototype._updateValueLabel=function(){this._valueList&&this._valueLabel.setContent(this._valueList[this.getNumericValue()])},m.prototype.setNumericValue=function(t){this._slider.setAttribute("value",t),this._updateValueLabel()},m.prototype.setListedValue=function(t){var i;this._valueList?(i=this._valueIndex.indexOf(t),i>=0?this.setNumericValue(i):e.showError("Cannot set listed value '"+t+"' for slider '"+this.getName()+"', because it is not in the value list!")):e.showError("Cannot set listed value '"+t+"' for slider '"+this.getName()+"', because it has no value list!")},m.prototype.getNumericValue=function(){return parseFloat(this._slider.getAttribute("value"))},m.prototype.getListedValue=function(){return this._valueList[this.getNumericValue()]},m.prototype.getValue=function(){return this._valueList?this.getListedValue():this.getNumericValue()},m.prototype.setValueList=function(t){var e=this.getNumericValue();this._valueList=t,this._min=0,this._max=t.length-1,this._step=1,e>this._max&&(e=0),this._updateSlider(),this.setNumericValue(e)},{ELEMENT_ID_SEPARATOR:y,DISABLED_CLASS_NAME:F,SELECTED_CLASS_NAME:P,HIGHLIGHTED_CLASS_NAME:V,SHOW_EVENT_NAME:U,HIDE_EVENT_NAME:B,BUTTON_SELECT_EVENT_NAME:q,BUTTON_CLICK_EVENT_NAME:W,OPTION_SELECT_EVENT_NAME:z,OPTION_CLICK_EVENT_NAME:X,TRANSLATION_KEY_ATTRIBUTE:Q,clearStoredDOMModels:l,SimpleComponent:u,LoadingBox:_,InfoBox:p,MenuComponent:d,ListComponent:g,Selector:f,Slider:m}}),define("armada/constants",[],function(){"use strict";var t="Interstellar Armada",e="armada_",i=e+"language",s=e+"version";return{GAME_NAME:t,LOCAL_STORAGE_PREFIX:e,LANGUAGE_LOCAL_STORAGE_ID:i,VERSION_LOCAL_STORAGE_ID:s}}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,s){"use strict";function n(t){switch(t){case m.NONE:return 0;case m.FLOAT:return 1;case m.VEC2:return 2;case m.VEC3:return 3;case m.VEC4:return 4;case m.MAT2:return 4;case m.MAT3:return 9;case m.MAT4:return 16;case m.SAMPLER2D:return 1;case m.SAMPLER_CUBE:return 1;case m.INT:return 1;case m.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function o(t){switch(t){case m.NONE:return 0;case m.FLOAT:return 1;case m.VEC2:return 1;case m.VEC3:return 1;case m.VEC4:return 1;case m.MAT2:return 2;case m.MAT3:return 3;case m.MAT4:return 4;case m.SAMPLER2D:return 1;case m.SAMPLER_CUBE:return 1;case m.INT:return 1;case m.BOOL:return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+t+"'!"),0}}function r(t){return t===m.SAMPLER2D||t===m.SAMPLER_CUBE}function a(t){return t?1:0}function h(t,e,i){this._name=t,this._image=e,this._mipmap=void 0!==i?i:!0,this._ids={},this._locations={}}function l(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function u(t,e,i){this.name=t,this.size=e,this.role=i}function c(t,s,n,o){this._name=t,this._type=e.getEnumValue(m,s,{name:"uniform "+this._name+".type",defaultValue:m.NONE}),this._arraySize=n||0,this._unpacked=o,this._unpacked&&(!r(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===m.STRUCT?[]:null,this._locations={},this._numericValues={}}function _(t,e,i,s){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(s*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0}function p(t,e,i,s){this._name=t,this._id=null,this._width=e,this._height=i,this._depthOnly=!!s,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function d(t,e,s,n,o,r,a,h){this._name=t,this._blendMode=n,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=s,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._vertexShaderSource?this._fragmentShaderSource?this._parseShaderSources(o,a,h):i.showError("Cannot initialize shader '"+this._name+"': no fragment shader source specified!"):i.showError("Cannot initialize shader '"+this._name+"': no vertex shader source specified!")}function g(t,e,i,n,o,r){s.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=i===!0,this._alpha=void 0===n||n,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._boundVertexBufferCount=0,this._frameBuffers={},this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._createContext(r),this.setFiltering(o)}var f={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},m={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},y={NONE:"none",MIX:"mix",ADD:"add"},S="u_",T="",E="",b="Texture",M="",O="Cubemap",A=null;return Object.freeze(f),Object.freeze(m),h.prototype.getName=function(){return this._name},h.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},h.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},h.prototype.setMinFiltering=function(t,e,i){if(this._mipmap===!1)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case f.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST);break;case f.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);break;case f.ANISOTROPIC:t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},h.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},h.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},h.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},h.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},l.prototype.getName=function(){return this._name},l.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},l.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},l.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},l.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},l.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;6>i;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},l.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},c.prototype.getName=function(){return this._name},c.prototype.addMember=function(t){this._type===m.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},c.prototype.saveLocation=function(t,e,i,s){s=s||this._name,this._locations[t]||(this._locations[t]={}),this._locations[t][s]=e.getUniformLocation(i.getIDForContext(t),s)},c.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._numericValues={},this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},c.prototype.getLocation=function(t,e,i,s,n){var o=(s||"")+this._name+(n||"");return!s&&!n||this._locations[t]&&void 0!==this._locations[t][o]||this.saveLocation(t,e,i,o),this._locations[t][o]},c.prototype.getArraySize=function(){return this._arraySize},c.prototype.getRawName=function(){var t,e=this._name;return S.length>0&&(t=e.split(S),e=t[t.length-1]),T.length>0&&(e=e.split(T)[0]),e},c.prototype.getTextureType=function(){var t,e;if(this._type!==m.SAMPLER2D)return null;if(t=this.getRawName(),E.length>0){if(e=t.split(E),e.length<2)return null;t=e[e.length-1]}if(b.length>0){if(e=t.split(b),e.length<2)return null;t=e[0]}return t},c.prototype.getCubemapName=function(){var t,e;if(this._type!==m.SAMPLER_CUBE)return null;if(t=this.getRawName(),M.length>0){if(e=t.split(M),e.length<2)return null;t=e[e.length-1]}if(O.length>0){if(e=t.split(O),e.length<2)return null;t=e[0]}return t},c.prototype.getUniformName=function(t){return S+t+T},c.prototype.getTextureUniformRawName=function(t){return E+t+b},c.prototype.getCubemapUniformRawName=function(t){return M+t+O},c.prototype.setConstantValue=function(t,e,s,n,o){var r,h,l,u,c;switch(this._unpacked||(r=this.getLocation(t,e,s,o)),this._type){case m.FLOAT:this._arraySize>0?e.uniform1fv(r,n):(o||this._numericValues[t]!==n)&&(e.uniform1f(r,n),this._numericValues[t]=n);break;case m.VEC2:e.uniform2fv(r,n);break;case m.VEC3:e.uniform3fv(r,n);break;case m.VEC4:e.uniform4fv(r,n);break;case m.MAT2:e.uniformMatrix2fv(r,!1,n);break;case m.MAT3:e.uniformMatrix3fv(r,!1,n);break;case m.MAT4:e.uniformMatrix4fv(r,!1,n);break;case m.SAMPLER2D:case m.SAMPLER_CUBE:case m.INT:if(this._arraySize>0)if(this._unpacked)for(h=0;h<n.length;h++)e.uniform1i(this.getLocation(t,e,s,o,h.toString()),n[h]);else e.uniform1iv(r,n);else(o||this._numericValues[t]!==n)&&(e.uniform1i(r,n),this._numericValues[t]=n);break;case m.BOOL:this._arraySize>0?e.uniform1iv(r,n.map(a)):(c=n?1:0,(o||this._numericValues[t]!==c)&&(e.uniform1i(r,c),this._numericValues[t]=c));break;case m.STRUCT:if(this._arraySize>0)for(h=0;h<n.length;h++)for(l=0;l<this._members.length;l++)void 0!==n[h][this._members[l]._name]&&(u=this._members[l]._name,this._members[l].setConstantValue(t,e,s,n[h][u],this._name+"["+h+"]."));else for(h=0;h<this._members.length;h++)void 0!==n[this._members[h]._name]&&(u=this._members[h]._name,this._members[h].setConstantValue(t,e,s,n[u],this._name+"."));break;default:i.showError("Attempting to set uniform '"+this._name+"', but it has a type that cannot be handled! ("+(this._arraySize>0?"array ("+this._arraySize+") of ":"")+this._type+")")}},c.prototype.setValue=function(t,e,i,s,n){this.setConstantValue(t,e,i,s(),n)},c.prototype.getVectorCount=function(){var t,e;if(this._type===m.STRUCT){for(t=0,e=0;e<this._members.length;e++)t+=this._members[e].getVectorCount();return t}return o(this._type)*(this._arraySize||1)},c.prototype.isSamplerType=function(){return r(this._type)},_.prototype.getName=function(){return this._name},_.prototype.getRole=function(){return this._role},_.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},_.prototype.getSize=function(){return this._data.length/this._vectorSize},_.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},_.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},_.prototype.resetFilledVectors=function(){this._filledVectors=0},_.prototype.freeData=function(){this._data=null},_.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},_.prototype.bind=function(t,e,s){(void 0===this._locations[e.getName()]||-1===this._locations[e.getName()])&&(this._locations[e.getName()]=t.gl.getAttribLocation(e.getIDForContext(t.getName()),this._name));var n=this._locations[e.getName()];n>=0&&t.getBoundVertexBuffer(n)!==this&&(i.log_DEBUG("Binding "+(s?"instance":"vertex")+" buffer '"+this._name+"' to attribute location "+n+" in shader '"+e.getName()+"'.",3),s?this.loadToGPUMemory(t.getName(),t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t.getName()]),t.getBoundVertexBuffer(n)||t.gl.enableVertexAttribArray(n),t.gl.vertexAttribPointer(n,this._vectorSize,t.gl.FLOAT,!1,0,0),t.instancingExt&&(s?t.instancingExt.vertexAttribDivisorANGLE(n,1):t.instancingExt.vertexAttribDivisorANGLE(n,0)),t.setBoundVertexBuffer(n,this))},_.prototype["delete"]=function(t){var e,i;t.gl.deleteBuffer(this._ids[t.getName()]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&(t.setBoundVertexBuffer(i,null),t.gl.disableVertexAttribArray(i)));delete this._ids[t.getName()],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},p.prototype.TEXTURE_LOCATION_NOT_SET=-1,p.prototype.getName=function(){return this._name},p.prototype.getLastTextureBindLocation=function(){return this._textureLocation},p.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},p.prototype.setup=function(t){var e;if(!this._id)switch(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),this._depthOnly&&t.areDepthTexturesAvailable()?(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.DEPTH_COMPONENT,this._width,this._height,0,t.gl.DEPTH_COMPONENT,t.gl.UNSIGNED_SHORT,null),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.TEXTURE_2D,this._textureID,0)):(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID)),e=t.gl.checkFramebufferStatus(t.gl.FRAMEBUFFER)){case t.gl.FRAMEBUFFER_COMPLETE:i.log_DEBUG("Framebuffer '"+this._name+"' successfully created.",2);break;case t.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:
i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case t.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"' ("+e+")!")}},p.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},p.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},p.prototype["delete"]=function(t){t.gl.deleteTexture(this._textureID),this._depthOnly&&t.areDepthTexturesAvailable()||t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},d.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return!0;return!1},d.prototype._getUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e];return null},d.prototype._parseShaderSources=function(e,s,a){var h,l,_,p,d,g,f,y,S,T,E,b,M,O,A,x,R,C,I,v=0,N=1,L={},D={},w=function(t){return""!==t},F=function(t){return"highp"===t||"mediump"===t||"lowp"===t},P=function(e){return t.getSafeEnumValue(m,e,m.NONE)!==m.NONE},V=function(t,e){var i,s,n,o;for(i=!1,n=0;n<d.length;n++)if(s=d[n].split(" "),i){if(s=s.filter(w),s.length>0&&"}"===s[s.length-1].split(";")[0])break;s.length>=2&&(o=F(s[0])?1:0,t.addMember(new c(s[o+1].split(";")[0],s[o],0)))}else"struct"===s[0]&&s[1].split("{")[0]===e&&(i=!0)};for(p=0;2>p;p++){switch(p){case v:d=this._vertexShaderSource.split("\n");break;case N:d=this._fragmentShaderSource.split("\n")}for(C=!1,h=0;h<d.length;h++)if(d[h].length>0)if(g=d[h].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),f=d[h].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===g[0])s&&void 0!==s[g[1]]?(L[g[1]]=s[g[1]],g[2]!==s[g[1]]&&(d[h]=d[h].replace(g[2],s[g[1]]),C=!0)):L[g[1]]=g[2];else if(p===v&&"attribute"===g[0])if(y=F(g[1])?3:2,S=g[y],O=g[y-1],T=n(O),E=e[S],this._numAttributeVectors+=o(O),void 0===E){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(S))return void i.showError("Role for attribute named '"+S+"' not found for shader '"+this._name+"'!");E=this._uniformNamesForInstanceAttributeNames[S],this._instanceAttributes.push(new u(S,T,E))}else this._vertexAttributes.push(new u(S,T,E));else if("uniform"===g[0]){if(y=F(g[1])?3:2,M=g[y],O=g[y-1],this._hasUniform(M)===!1){if("["===f[y]){if(R=!1,x=g[y+1],L[x]&&(x=L[x]),A=parseInt(x,10),r(O)&&a){for(d[h]="",l=0;A>l;l++){for(_=0;y>_;_++)d[h]+=g[_],d[h]+=f[_];d[h]+=M+l.toString()+";\n"}C=!0,R=!0}}else A=0;P(O)?this._uniforms.push(new c(M,O,A,R)):(b=new c(M,"struct",A),V(b,O),this._uniforms.push(b))}switch(p){case v:this._numVertexUniformVectors+=this._getUniform(M).getVectorCount();break;case N:this._numFragmentUniformVectors+=this._getUniform(M).getVectorCount(),r(O)&&(this._numTextureUnits+=this._getUniform(M).getVectorCount());break;default:i.crash()}}else if("varying"===g[0])y=F(g[1])?3:2,O=g[y-1],p===N&&("["===f[y]?(x=g[y+1],L[x]&&(x=L[x]),A=parseInt(x,10)):A=1,this._numVaryingVectors+=o(O)*A);else{for(y=0;""===g[y];)y++;if(P(g[y])||F(g[y]))y=F(g[y])?y+2:y+1,"["===f[y]&&(x=g[y+1],L[x]&&(x=L[x]),D[g[y]]=parseInt(x,10));else{for(l=0;l<this._uniforms.length;l++)if(y=g.indexOf(this._uniforms[l].getName()),y>=0&&this._uniforms[l].getArraySize()>0&&"["===f[y]){if(parseInt(g[y+1],10).toString()===g[y+1]&&parseInt(g[y+1],10)>=this._uniforms[l].getArraySize()){d[h]="",C=!0;break}if(this._uniforms[l].isSamplerType()&&a){for(d[h]="",_=0;y>_;_++)d[h]+=g[_],d[h]+=f[_];for(d[h]+=g[y]+g[y+1],_=y+2;_<f.length;_++)d[h]+=g[_],d[h]+=f[_];d[h]+=g[g.length-1],C=!0;break}}for(I=Object.keys(D),l=0;l<I.length;l++)if(y=g.indexOf(I[l]),y>=0&&"["===f[y]&&parseInt(g[y+1],10).toString()===g[y+1]&&parseInt(g[y+1],10)>=D[g[y]]){d[h]="",C=!0;break}}}if(C)switch(p){case v:this._vertexShaderSource=d.join("\n");break;case N:this._fragmentShaderSource=d.join("\n")}}},d.prototype.getName=function(){return this._name},d.prototype.getIDForContext=function(t){return this._ids[t]},d.prototype.getVertexAttributes=function(){return this._vertexAttributes},d.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},d.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},d.prototype.setupGLProgram=function(t,e){var s,n,o,r,a;if(!this._vertexShaderSource||!this._fragmentShaderSource)return i.log("ERROR: Cannot set up GL shader program for '"+this._name+"', because the vertex or fragment shader source is missing!",1),void(this._ids[t]=null);if(s=e.createShader(e.VERTEX_SHADER),e.shaderSource(s,this._vertexShaderSource),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))return n=e.getShaderInfoLog(s),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(o=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(o,this._fragmentShaderSource),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return n=e.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),r=this._ids[t],e.attachShader(r,s),e.attachShader(r,o),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))return n=e.getProgramInfoLog(r),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+n,e),e.deleteProgram(r),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},d.prototype.getBlendMode=function(){return this._blendMode},d.prototype.assignUniforms=function(t,e){var i;if(t.setCurrentShader(this),e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i].getName()]&&this._uniforms[i].setValue(t.getName(),t.gl,this,e[this._uniforms[i].getName()])},d.prototype.bindVertexBuffers=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this);t.disableUnusedVertexBuffers(this._vertexAttributes.length)},d.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e].getArraySize();return 0},d.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getTextureType(),e&&i.push(e);return i},d.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getCubemapName(),e&&i.push(e);return i},d.prototype.createInstanceBuffers=function(t,e){var i;this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1)));for(i in this._uniformNamesForInstanceAttributeNames)this._uniformNamesForInstanceAttributeNames.hasOwnProperty(i)&&(this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][i]?(this._instanceAttributeBuffers[t][i].resize(e),this._instanceAttributeBuffers[t][i].resetFilledVectors()):this._instanceAttributeBuffers[t][i]=new _(i,this._uniformNamesForInstanceAttributeNames[i],this.getInstanceAttribute(i).size,e))},d.prototype.addDataToInstanceBuffers=function(t,e){var i,s;for(i in this._instanceAttributeBuffers[t])this._instanceAttributeBuffers[t].hasOwnProperty(i)&&(s=this._instanceAttributeBuffers[t][i].getRole(),e.hasOwnProperty(s)&&this._instanceAttributeBuffers[t][i].addVector(e[s](!0)))},d.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i].bind(t,this,!0)},d.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i]["delete"](t);this._instanceAttributeBuffers=[]},d.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},d.prototype.isAllowedByRequirements=function(t){return this._numAttributeVectors<=t.requiredAttributeVectors&&this._numVertexUniformVectors<=t.requiredVertexUniformVectors&&this._numVaryingVectors<=t.requiredVaryingVectors&&this._numTextureUnits<=t.requiredTextureUnits&&this._numFragmentUniformVectors<=t.requiredFragmentUniformVectors},g.prototype=new s.AsyncResource,g.prototype.constructor=g,g.prototype._createContext=function(t){var e,s;i.log("Initializing WebGL context...",1),s={alpha:this._alpha,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",s)}catch(n){}if(!this.gl){i.log("Initializing a regular context failed, initializing experimental context...",1),s.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",s)}catch(n){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}e=this.gl,this._antialiasing&&!e.getContextAttributes().antialias&&(t||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",e),this._antialiasing=!1),this._maxBoundTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=e.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=e.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=e.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),e.clearDepth(1),e.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],e.depthMask(!0),this._currentDepthMask=!0,e.enable(e.BLEND),this._blendingEnabled=!0,e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW)},g.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize:"N/A"},g.prototype.getName=function(){return this._name},g.prototype.isAntialiased=function(){return this._antialiasing},g.prototype.getFiltering=function(){return this._filtering},g.prototype.setFiltering=function(e){var s;if(e=t.getSafeEnumValue(f,e,this._filtering),e!==this._filtering)for(this._filtering=e,this._filtering===f.ANISOTROPIC&&(this.anisotropicFilterExt||(i.log("Anisotropic filtering is set, but the required extension is not available. Trilinear filtering will be used.",1),this._filtering=f.TRILINEAR)),s=0;s<this._textures.length;s++)this._textures[s].setMinFiltering&&(this.bindTexture(this._textures[s]),this._textures[s].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},g.prototype.isInstancingAvailable=function(){return!!this.instancingExt},g.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},g.prototype.setColorMask=function(t){(this._currentColorMask[0]!==t[0]||this._currentColorMask[1]!==t[1]||this._currentColorMask[2]!==t[2]||this._currentColorMask[3]!==t[3])&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this._currentColorMask=t)},g.prototype.setDepthMask=function(t){this._currentDepthMask!==t&&(this.gl.depthMask(t),this._currentDepthMask=t)},g.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},g.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},g.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},g.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},g.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},g.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t.getName()]&&(this._vertexBuffers[t.getName()]=t)},g.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},g.prototype.setBoundVertexBuffer=function(t,e){this._boundVertexBuffers[t]=e,e&&t>=this._boundVertexBufferCount&&(this._boundVertexBufferCount=t+1)},g.prototype.disableUnusedVertexBuffers=function(t){var e;for(e=t;e<this._boundVertexBufferCount;e++)this.gl.disableVertexAttribArray(e),this._boundVertexBuffers[e]=null;this._boundVertexBufferCount=t},g.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},g.prototype.setupVertexBuffers=function(){var t,e,i,s,n,o;if(this.isReadyToUse()!==!0){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i]["delete"](this);for(s=0,t=0;t<this._models.length;t++)s+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(n=this._shaders[t].getVertexAttributes(),e=0;e<n.length;e++)this.addVertexBuffer(new _(n[e].name,n[e].role,n[e].size,s));for(o=0,t=0;t<this._models.length;t++)for(e=this._models[t].getMinLOD();e<=this._models[t].getMaxLOD();e++)o+=this._models[t].loadToVertexBuffers(this,o,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},g.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},g.prototype.addFrameBuffer=function(t){void 0===this._frameBuffers[t.getName()]&&(i.log_DEBUG("Adding new framebuffer '"+t.getName()+"' to context ("+this._name+")...",2),this._frameBuffers[t.getName()]=t,this.isReadyToUse()&&this._frameBuffers[t.getName()].setup(this))},g.prototype.setupFrameBuffers=function(){var t;if(!this.isReadyToUse())for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},g.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t]["delete"](this);this._frameBuffers={}},g.prototype.setup=function(){i.log_DEBUG("Setting up context '"+this._name+"'...",2),this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},g.prototype.clear=function(){var t;for(i.log_DEBUG("Clearing context '"+this._name+"'...",2),this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBufferCount=0,this._boundVertexBuffers=[]},g.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},g.prototype.setCurrentFrameBuffer=function(t){t?this._frameBuffers[t].bind(this):this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},g.prototype.getCurrentShader=function(){return this._currentShader},g.prototype.setCurrentShader=function(t){var e,s;if(this._currentShader!==t){if(i.log_DEBUG("Switching to shader: "+t.getName(),3),s=t.getIDForContext(this._name)){switch(this.gl.useProgram(s),e=t.getBlendMode()){case y.MIX:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=e);break;case y.ADD:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=e);break;case y.NONE:break;default:i.crash()}return t.bindVertexBuffers(this),this._currentShader=t,!0}i.log("ERROR: trying to switch to non-initialized shader: '"+t.getName()+"'!",3),this._currentShader=null}return!1},g.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.bindTexture=function(t,e,s){var n=void 0!==e||s;if(void 0===e&&(e=t.getLastTextureBindLocation(this._name),void 0===e||e===p.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[e]&&this._boundTextures[e].texture===t||(t instanceof h?(i.log_DEBUG("Binding texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof l?(i.log_DEBUG("Binding cubemap texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof p?(i.log_DEBUG("Binding framebuffer texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this.gl,e)):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:n}),this._boundTextures[e].reserved!==n&&(this._boundTextures[e].reserved=n,i.log_DEBUG((n?"Reserved":"Freed")+" texture unit index "+e+".",3)),e},g.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},g.prototype.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},g.prototype.satisfiesRequirements=function(t){return this._maxVertexAttributes>=t.requiredAttributeVectors&&this._maxVertexShaderUniforms>=t.requiredVertexUniformVectors&&this._maxVaryings>=t.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=t.requiredFragmentUniformVectors&&this._maxBoundTextures>=t.requiredTextureUnits},g.prototype.getMaxTextureSize=function(){return this._maxTextureSize},g.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},g.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(t,e,s){i.showError(t,e,(s?s+"\n\n":"")+"This is a graphics related error.\nInformation about your graphics support:\n"+A.getInfoString())},A=new g("",document.createElement("canvas"),!0,!0,f.BILINEAR,!0),{TextureFiltering:f,ShaderVariableType:m,ShaderBlendMode:y,getUniformName:c.prototype.getUniformName,getTextureUniformRawName:c.prototype.getTextureUniformRawName,getCubemapUniformRawName:c.prototype.getCubemapUniformRawName,ManagedTexture:h,ManagedCubemap:l,ManagedShader:d,FrameBuffer:p,ManagedGLContext:g,requirementsAreSatisfied:A.satisfiesRequirements.bind(A),getMaxTextureSize:A.getMaxTextureSize.bind(A),getMaxCubemapSize:A.getMaxCubemapSize.bind(A),getMaxRenderbufferSize:A.getMaxRenderbufferSize.bind(A),isAntialiasingAvailable:A.isAntialiased.bind(A),isAnisotropicFilteringAvailable:A.isAnisotropicFilteringAvailable.bind(A),isInstancingAvailable:A.isInstancingAvailable.bind(A),areDepthTexturesAvailable:A.areDepthTexturesAvailable.bind(A)}}),define("modules/resource-manager",["utils/utils","modules/application","modules/async-resource"],function(t,e,i){"use strict";function s(t){i.AsyncResource.call(this),this._name=t,this._requested=!1,this._loading=!1,this._hasError=!1,this._requestParams={}}function n(t,i,n){s.call(this,t?t.name||n&&(t&&t.source||a)||e.showError("Cannot initialize instance of "+this.constructor.name+": a name is required!"):null),this._source=t?t.source||null:null,this._sourceFolder=i,this._dataJSON=t,t&&(this._source||(this._loadData(t),this.setToReady()))}function o(t){i.AsyncResource.call(this),this._resourceType=t,this._resources={},this._resourceNames=[],this._numLoadedResources=0,this._numRequestedResources=0}function r(){i.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._resourceClasses=null,this._sourceFolder=null}var a="unnamed";return s.prototype=new i.AsyncResource,s.prototype.constructor=s,s.prototype.getName=function(){return this._name},s.prototype.isRequested=function(e){if(!this._requested)return!1;if(e){if(!this._requestParams)return!1;if(!t.equivalent(this._requestParams,e))return!1}return!0},s.prototype.request=function(i){this._loading&&!t.equivalent(this._requestParams||null,i||null)?e.showError("Attempting to request resource '"+this._name+"' with different parameters while it is being loaded!"):(this._requested=!0,this._requestParams=i)},s.prototype.requiresReload=function(){e.showError("Resource class does not implement requiresReload!")},s.prototype.isLoaded=function(){return this.isReadyToUse()},s.prototype.hasError=function(){return this._hasError},s.prototype._requestFiles=function(){e.showError("Attempting to request files for a resource type that has no file request function implemented!")},s.prototype._loadData=function(){return e.showError("Attempting to load data for a resource type that has no data loading function implemented!"),!1},s.prototype.onFinalLoad=function(){this._requested=!1,this._loading=!1,this.setToReady()},s.prototype._onFilesLoad=function(t,e){this._hasError=this._hasError||!this._loadData(e),t===!0&&this.onFinalLoad()},s.prototype.requestLoadFromFile=function(){this.isReadyToUse()===!1&&this._requested===!0&&this._loading===!1&&(this._loading=!0,this._requestFiles(this._requestParams))},s.prototype.getData=function(){return null},n.prototype=new s,n.prototype.constructor=n,n.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},n.prototype._requestFiles=function(){e.requestTextFile(this._sourceFolder,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},n.prototype._loadData=function(t){return this._source=this._source||"",this._dataJSON=t,!0},n.prototype.getData=function(){return this._dataJSON},n.prototype.reloadData=function(){this._loadData(this._dataJSON)},o.prototype=new i.AsyncResource,o.prototype.constructor=o,o.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},o.prototype.addResource=function(t){var i=t.getName();return this._resources[i]?e.showError("Attemtping to add a resource named '"+i+"' that already exists! Data will be overwritten."):this._resourceNames.push(i),this._resources[i]=t,this._resources[i]},o.prototype.getResource=function(t,i){var s;return this._resources[t]?(s=this._resources[t],i&&i.doNotLoad||s.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),s.resetReadyState(),s.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),s):(i&&i.allowNullResult===!0||e.showError("Requested a resource named '"+t+"' from "+this._resourceType+", which does not exist."),null)},o.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},o.prototype.getResourceNames=function(){return this._resourceNames},o.prototype.renameResource=function(t,e){t!==e&&(this._resources[e]=this._resources[t],delete this._resources[t],this._resourceNames[this._resourceNames.indexOf(t)]=e)},o.prototype.moveResourceAfter=function(t,e){this._resourceNames.splice(this._resourceNames.indexOf(t),1),this._resourceNames.splice(this._resourceNames.indexOf(e)+1,0,t)},r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.setToReady=function(){this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0,i.AsyncResource.prototype.setToReady.call(this)},r.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},r.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},r.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},r.prototype.addResource=function(t,e){return this._resourceHolders[t]=this._resourceHolders[t]||new o(t),this._resourceHolders[t].addResource(e)},r.prototype.createResource=function(t,i){return this._resourceClasses?this._resourceClasses[t]?void this.addResource(t,new this._resourceClasses[t](i,this._sourceFolder)):void e.showError("Cannot create resource of type '"+t+"': no resource constructor was assigned for this resource type!"):void e.showError("Cannot create resource of type '"+t+"': no resource constructors were assigned!")},r.prototype._onResourceLoad=function(t,e){var i,s;for(s=this._onResourceLoadFunctionQueue,i=0;i<s.length;i++)s[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(s=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<s.length;i++)s[i]();this.allResourcesAreLoaded()&&this.setToReady()},r.prototype.getResource=function(t,i,s){var n;return(n=this._resourceHolders[t]?this._resourceHolders[t].getResource(i,s):null)?(s&&s.doNotLoad||n.requiresReload(s)&&(this._numRequestedResources++,this.resetReadyState(),n.request(s),n.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(t,i)}.bind(this))),n):(s&&s.allowNullResult===!0||e.showError("Requested a resource named '"+i+"' of type '"+t+"', which does not exist."),null)},r.prototype.requestAllResources=function(){var t,e,i;for(t in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(t))for(e=this._resourceHolders[t].getResourceNames(),i=0;i<e.length;i++)this.getResource(t,e[i])},r.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t].isReadyToUse()},r.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},r.prototype.requestConfigLoad=function(t,i,s,n){e.requestTextFile(i,t,function(t){this._loadConfigFromJSON(JSON.parse(t),s),n&&n()}.bind(this))},r.prototype._loadConfigFromJSON=function(t,e){var i,s,n;this._resourceClasses=e,this._sourceFolder=t.config?t.config.sourceFolder:null;for(i in e)if(e.hasOwnProperty(i))for(s=t[i],n=0;n<s.length;n++)this.addResource(i,new e[i](s[n],this._sourceFolder))},r.prototype.requestResourceLoad=function(){var t;if(e.log_DEBUG("Requesting loading of resources contained in the resource manager...",2),this.allResourcesAreLoaded()===!0)e.log_DEBUG("There are no resources to load, executing set up callback queue right away...",2),this.executeOnReadyQueue();else for(t in this._resourceHolders)this._resourceHolders.hasOwnProperty(t)&&(e.log_DEBUG("Requesting the loading of "+t+" from files...",2),this._resourceHolders[t].requestResourceLoad())},r.prototype.getResourceTypes=function(){return Object.keys(this._resourceHolders)},r.prototype.getResourceNames=function(t){return this._resourceHolders[t]?this._resourceHolders[t].getResourceNames():(e.showError("Asked for the names of resources of type: '"+t+"', but no such resource type exists!"),null)},r.prototype.renameResource=function(t,e,i){this._resourceHolders[t].renameResource(e,i)},r.prototype.moveResourceAfter=function(t,e,i){this._resourceHolders[t].moveResourceAfter(e,i)},r.prototype.executeForAllResourcesOfType=function(t,e){var i,s;for(s=this._resourceHolders[t].getResourceNames(),i=0;i<s.length;i++)e(this._resourceHolders[t].getResource(s[i]),t)},r.prototype.executeForAllResources=function(t){var e,i=Object.keys(this._resourceHolders);for(e=0;e<i.length;e++)this.executeForAllResourcesOfType(i[e],t)},{GenericResource:s,JSONResource:n,ResourceManager:r}}),define("utils/vectors",[],function(){"use strict";var t={},e=.99999,i=1e-7;return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.UNIT3_X=[1,0,0],Object.freeze(t.UNIT3_X),t.UNIT3_Y=[0,1,0],Object.freeze(t.UNIT3_Y),t.UNIT3_Z=[0,0,1],Object.freeze(t.UNIT3_Z),t.fromXMLTag3=function(t){return[parseFloat(t.getAttribute("x")),parseFloat(t.getAttribute("y")),parseFloat(t.getAttribute("z"))];
},t.perpendicular3=function(t){return[t[1],-t[0],0]},t.length2=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)},t.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)},t.getYawAndPitch=function(i){var s,n={};return Math.abs(i[2])>e?(n.yaw=0,n.pitch=i[2]>0?-Math.PI/2:Math.PI/2):(n.yaw=t.angle2uCapped([0,1],t.normal2([i[0],i[1]])),i[0]>0&&(n.yaw=-n.yaw),s=t.rotated2(i,-n.yaw),n.pitch=t.angle2uCapped([1,0],t.normal2([s[1],i[2]])),i[2]<0&&(n.pitch=-n.pitch)),n},t.getRollAndYaw=function(i,s){var n,o={};return Math.abs(i[1])>e?(o.roll=0,o.yaw=i[1]>0?0:Math.PI):(o.roll=t.angle2uCapped([1,0],t.normal2([i[0],i[2]])),i[2]<0&&(o.roll=-o.roll),n=t.rotated2([i[0],i[2]],-o.roll),o.yaw=t.angle2uCapped([0,1],t.normal2([n[0],i[1]])),!s&&Math.abs(o.roll)>Math.PI/2&&(o.yaw=-o.yaw,o.roll-=Math.PI*Math.sign(o.roll))),o},t.getRollAndPitch=function(i,s){var n,o={};return Math.abs(i[1])>e?(o.roll=0,o.pitch=i[1]>0?0:Math.PI):(o.roll=t.angle2uCapped([0,1],t.normal2([i[0],i[2]])),i[0]>0&&(o.roll=-o.roll),n=t.rotated2([i[0],i[2]],-o.roll),o.pitch=t.angle2uCapped([1,0],t.normal2([i[1],n[1]])),!s&&Math.abs(o.roll)>Math.PI/2&&(o.pitch=-o.pitch,o.roll-=Math.PI*Math.sign(o.roll))),o},t.vector4From3=function(t,e){return[t[0],t[1],t[2],e]},t.normal2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return[t[0]*i,t[1]*i]},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled4=function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]},t.rotated2=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=[0,0];return n[0]=t[0]*i+t[1]*-s,n[1]=t[0]*s+t[1]*i,n},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.sumArray3=function(t){var e,i=[0,0,0];for(e=0;e<t.length;e++)i[0]+=t[e][0],i[1]+=t[e][1],i[2]+=t[e][2];return i},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.angle2u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1])},t.angle2uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.mulVec3Mat3=function(t,e){return new Float32Array([e[0]*t[0]+e[3]*t[1]+e[6]*t[2],e[1]*t[0]+e[4]*t[1]+e[7]*t[2],e[2]*t[0]+e[5]*t[1]+e[8]*t[2]])},t.mulVec3Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]])},t.mulVec4Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]])},t.mulMat3Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]])},t.mulMat4Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]])},t.mulMat4Vec4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3]])},t.negate2=function(t){t[0]=-t[0],t[1]=-t[1]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;t[0]*=i,t[1]*=i},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;t[0]*=i,t[1]*=i,t[2]*=i},t.normalize4D=function(t){t[3]=t[3]||i,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.mulCross3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=s*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-s*e[0]},t.rotate2=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=t[0];t[0]=t[0]*i+t[1]*-s,t[1]=n*s+t[1]*i},t}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function i(t,e){this.x=t[0],this.y=t[1],this.z=t[2],e=e||[this.x,this.y],this.u=e[0],this.v=e[1]}function s(t,e,i,s){this.a=t,this.b=e,this.color=i,this.normal=s}function n(e,i,s,n,o,r,a,h){this._mesh=e,this.a=i,this.b=s,this.c=n,this.color=o,this.texCoords=r,this._normals=a||t.normal3(t.cross3(this._mesh.getVector(i,s),this._mesh.getVector(i,n))),this.groupIndices=h||[0,0]}function o(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function r(){this._vertices=[],this._lines=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new i([0,0,0])}function a(t,e,i,s,n,o){var r=[0,0];return r[0]=t+(i-t)*n,r[1]=e+(s-e)*o,r}function h(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function l(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._editedMesh=null,this._minEditedLOD=0,this._maxEditedLOD=0,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={}}var u={POSITION:"position",TEXTURE_COORDINATES:"texCoord",NORMAL:"normal",COLOR:"color",GROUP_INDICES:"groupIndices",TRIANGLE_INDEX:"triangleIndex"},c=[[0,0],[1,1]],_=["3.0"];return Object.freeze(u),i.prototype.getTexCoords=function(){return[this.u,this.v]},i.prototype.setX=function(t){this.x=t},i.prototype.setY=function(t){this.y=t},i.prototype.setZ=function(t){this.z=t},n.prototype.getNormal=function(t){return this._normals[t]||this._normals[0]},r.prototype.getNumLines=function(){return this._lines.length},r.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},r.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},r.prototype.getNumTriangles=function(t){return void 0===t?this._triangles.length:t?this._nTransparentTriangles:this._nOpaqueTriangles},r.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},r.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},r.prototype.setVertex=function(t,e){var i;if(this._vertices.length<t)for(i=this._vertices.length;t>i;i++)this._vertices[i]=this._nullVertex;this._vertices[t]=e,Math.abs(2*this._vertices[t].x)>this._size&&(this._size=Math.abs(2*this._vertices[t].x)),Math.abs(2*this._vertices[t].y)>this._size&&(this._size=Math.abs(2*this._vertices[t].y)),Math.abs(2*this._vertices[t].z)>this._size&&(this._size=Math.abs(2*this._vertices[t].z)),this._vertices[t].x>this._maxX&&(this._maxX=this._vertices[t].x),this._vertices[t].x<this._minX&&(this._minX=this._vertices[t].x),this._vertices[t].y>this._maxY&&(this._maxY=this._vertices[t].y),this._vertices[t].y<this._minY&&(this._minY=this._vertices[t].y),this._vertices[t].z>this._maxZ&&(this._maxZ=this._vertices[t].z),this._vertices[t].z<this._minZ&&(this._minZ=this._vertices[t].z)},r.prototype.appendVertex=function(t,e){this.setVertex(this._vertices.length,new i(t,e))},r.prototype.resetLines=function(){this._lines=[]},r.prototype.addLine=function(t){this._lines.push(t)},r.prototype.setLine=function(t,e){this._lines[t]=e},r.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},r.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},r.prototype.addTriangle=function(t,e){this._triangles.push(t),e||(this._lines.push(new s(t.a,t.b,t.color,t.getNormal(0))),this._lines.push(new s(t.b,t.c,t.color,t.getNormal(0))),this._lines.push(new s(t.c,t.a,t.color,t.getNormal(0)))),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},r.prototype.addTriangleWithParams=function(t,e,i,s){var o,r,a,h,l;return o=s.color||[1,1,1,1],r=s.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:s.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],a=s.normals,h=s.groupIndices||this._currentGroupIndices,l=new n(this,t,e,i,o,r,a,h),this.addTriangle(l,s.withoutLines),l},r.prototype.addQuad=function(t,e,i,n,o){var r,a,h,l;o=o||{},r=Object.create(o),r.withoutLines=!0,r.texCoords=o.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:o.texCoords?[o.texCoords[0],o.texCoords[1],o.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],r.normals=o.normals?4===o.normals.length?[o.normals[0],o.normals[1],o.normals[2]]:o.normals:null,this.addTriangleWithParams(t,e,i,r),a=Object.create(o),a.texCoords=o.useVertexTexCoords?[this._vertices[i].getTexCoords(),this._vertices[n].getTexCoords(),this._vertices[t].getTexCoords()]:o.texCoords?[o.texCoords[2],o.texCoords[3],o.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],a.normals=o.normals?4===o.normals.length?[o.normals[2],o.normals[3],o.normals[0]]:o.normals:null,this.addTriangleWithParams(i,n,t,a),o.withoutLines||(h=o.color||[1,1,1,1],l=o.normals?o.normals[0]:this._triangles[this._triangles.length-1].getNormal(0),this._lines.push(new s(t,e,h,l)),this._lines.push(new s(e,i,h,l)),this._lines.push(new s(i,n,h,l)),this._lines.push(new s(n,t,h,l)))},r.prototype.getSize=function(){return this._size},r.prototype.getMaxX=function(){return this._maxX},r.prototype.getMinX=function(){return this._minX},r.prototype.getMaxY=function(){return this._maxY},r.prototype.getMinY=function(){return this._minY},r.prototype.getMaxZ=function(){return this._maxZ},r.prototype.getMinZ=function(){return this._minZ},r.prototype.getWidth=function(){return this._maxX-this._minX},r.prototype.getHeight=function(){return this._maxY-this._minY},r.prototype.getDepth=function(){return this._maxZ-this._minZ},r.prototype.getBufferData=function(t,e){var i,s,n,o,r,a,h,l,c,_,p,d,g;if(e=e||0,t===!0){for(n=this._lines.length,h=new Float32Array(6*n),i=0;n>i;i++)h[6*i]=this._vertices[this._lines[i].a].x,h[6*i+1]=this._vertices[this._lines[i].a].y,h[6*i+2]=this._vertices[this._lines[i].a].z,h[6*i+3]=this._vertices[this._lines[i].b].x,h[6*i+4]=this._vertices[this._lines[i].b].y,h[6*i+5]=this._vertices[this._lines[i].b].z;for(l=new Float32Array(4*n),i=0;n>i;i++)l[4*i]=0,l[4*i+1]=1,l[4*i+2]=1,l[4*i+3]=1;for(c=new Float32Array(6*n),i=0;n>i;i++)c[6*i]=this._lines[i].normal[0],c[6*i+1]=this._lines[i].normal[1],c[6*i+2]=this._lines[i].normal[2],c[6*i+3]=this._lines[i].normal[0],c[6*i+4]=this._lines[i].normal[1],c[6*i+5]=this._lines[i].normal[2];for(_=new Float32Array(8*n),i=0;n>i;i++)_[8*i]=this._lines[i].color[0],_[8*i+1]=this._lines[i].color[1],_[8*i+2]=this._lines[i].color[2],_[8*i+3]=1,_[8*i+4]=this._lines[i].color[0],_[8*i+5]=this._lines[i].color[1],_[8*i+6]=this._lines[i].color[2],_[8*i+7]=1;for(p=new Float32Array(4*n),i=0;n>i;i++)p[4*i]=0,p[4*i+1]=0,p[4*i+2]=0,p[4*i+3]=0;for(o=this._triangles.length,d=new Float32Array(3*o),i=0;o>i;i++)d[12*i]=0,d[12*i+1]=0,d[12*i+2]=0,d[12*i+3]=0,d[12*i+4]=0,d[12*i+5]=0,d[12*i+6]=0,d[12*i+7]=0,d[12*i+8]=0,d[12*i+9]=0,d[12*i+10]=0,d[12*i+11]=0}else{for(o=this._triangles.length,h=new Float32Array(9*o),i=0;o>i;i++)h[9*i]=this._vertices[this._triangles[i].a].x,h[9*i+1]=this._vertices[this._triangles[i].a].y,h[9*i+2]=this._vertices[this._triangles[i].a].z,h[9*i+3]=this._vertices[this._triangles[i].b].x,h[9*i+4]=this._vertices[this._triangles[i].b].y,h[9*i+5]=this._vertices[this._triangles[i].b].z,h[9*i+6]=this._vertices[this._triangles[i].c].x,h[9*i+7]=this._vertices[this._triangles[i].c].y,h[9*i+8]=this._vertices[this._triangles[i].c].z;for(l=new Float32Array(6*o),i=0;o>i;i++)l[6*i]=this._triangles[i].texCoords[0][0],l[6*i+1]=this._triangles[i].texCoords[0][1],l[6*i+2]=this._triangles[i].texCoords[1][0],l[6*i+3]=this._triangles[i].texCoords[1][1],l[6*i+4]=this._triangles[i].texCoords[2][0],l[6*i+5]=this._triangles[i].texCoords[2][1];for(c=new Float32Array(9*o),i=0;o>i;i++)c[9*i]=this._triangles[i].getNormal(0)[0],c[9*i+1]=this._triangles[i].getNormal(0)[1],c[9*i+2]=this._triangles[i].getNormal(0)[2],c[9*i+3]=this._triangles[i].getNormal(1)[0],c[9*i+4]=this._triangles[i].getNormal(1)[1],c[9*i+5]=this._triangles[i].getNormal(1)[2],c[9*i+6]=this._triangles[i].getNormal(2)[0],c[9*i+7]=this._triangles[i].getNormal(2)[1],c[9*i+8]=this._triangles[i].getNormal(2)[2];for(_=new Float32Array(12*o),i=0;o>i;i++)_[12*i]=this._triangles[i].color[0],_[12*i+1]=this._triangles[i].color[1],_[12*i+2]=this._triangles[i].color[2],_[12*i+3]=this._triangles[i].color[3],_[12*i+4]=this._triangles[i].color[0],_[12*i+5]=this._triangles[i].color[1],_[12*i+6]=this._triangles[i].color[2],_[12*i+7]=this._triangles[i].color[3],_[12*i+8]=this._triangles[i].color[0],_[12*i+9]=this._triangles[i].color[1],_[12*i+10]=this._triangles[i].color[2],_[12*i+11]=this._triangles[i].color[3];for(p=new Float32Array(6*o),i=0;o>i;i++)p[6*i]=this._triangles[i].groupIndices[0],p[6*i+1]=this._triangles[i].groupIndices[1],p[6*i+2]=this._triangles[i].groupIndices[0],p[6*i+3]=this._triangles[i].groupIndices[1],p[6*i+4]=this._triangles[i].groupIndices[0],p[6*i+5]=this._triangles[i].groupIndices[1];for(d=new Float32Array(12*o),i=0;o>i;i++){for(r=e+i,a=[],s=0;4>s;s++)a[s]=r%256/255,r=Math.floor(r/256);d[12*i]=a[0],d[12*i+1]=a[1],d[12*i+2]=a[2],d[12*i+3]=a[3],d[12*i+4]=a[0],d[12*i+5]=a[1],d[12*i+6]=a[2],d[12*i+7]=a[3],d[12*i+8]=a[0],d[12*i+9]=a[1],d[12*i+10]=a[2],d[12*i+11]=a[3]}}return g={},g[u.POSITION]=h,g[u.TEXTURE_COORDINATES]=l,g[u.NORMAL]=c,g[u.COLOR]=_,g[u.GROUP_INDICES]=p,g[u.TRIANGLE_INDEX]=d,g.dataSize=t?2*this._lines.length:3*this._triangles.length,g},r.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},r.prototype.loadToVertexBuffers=function(t,e,i,s){var n=null,r=0,a=this._contextProperties[t.getName()]||new o;return i&&(n=this.getBufferData(!0,e),a.bufferStartWireframe=e,t.setVertexBufferData(n,e),r+=n.dataSize,e+=n.dataSize),s&&(n=this.getBufferData(!1,e),a.bufferStartSolid=e,a.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(n,e),r+=n.dataSize,e+=n.dataSize),this._contextProperties[t.getName()]=a,r},r.prototype.render=function(t,e,i){var s=this._contextProperties[t.getName()];if(e===!0)t.gl.drawArrays(t.gl.LINES,s.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._triangles.length)}},r.prototype.renderInstances=function(t,e,i,s){var n=this._contextProperties[t.getName()];if(e===!0)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,n.bufferStartWireframe,2*this._lines.length,s);else switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles,s);break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles,s);break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length,s)}},r.prototype.addCuboid=function(e,i,s,n,o,r,a,h,l){var u,c,_,p;for(c=+this._vertices.length,this.appendVertex([e-n/2,i-o/2,s+r/2]),this.appendVertex([e+n/2,i-o/2,s+r/2]),this.appendVertex([e+n/2,i+o/2,s+r/2]),this.appendVertex([e-n/2,i+o/2,s+r/2]),this.appendVertex([e-n/2,i+o/2,s-r/2]),this.appendVertex([e+n/2,i+o/2,s-r/2]),this.appendVertex([e+n/2,i-o/2,s-r/2]),this.appendVertex([e-n/2,i-o/2,s-r/2]),this.appendVertex([e+n/2,i+o/2,s-r/2]),this.appendVertex([e-n/2,i+o/2,s-r/2]),this.appendVertex([e-n/2,i+o/2,s+r/2]),this.appendVertex([e+n/2,i+o/2,s+r/2]),this.appendVertex([e-n/2,i-o/2,s-r/2]),this.appendVertex([e+n/2,i-o/2,s-r/2]),this.appendVertex([e+n/2,i-o/2,s+r/2]),this.appendVertex([e-n/2,i-o/2,s+r/2]),this.appendVertex([e+n/2,i-o/2,s-r/2]),this.appendVertex([e+n/2,i+o/2,s-r/2]),this.appendVertex([e+n/2,i+o/2,s+r/2]),this.appendVertex([e+n/2,i-o/2,s+r/2]),this.appendVertex([e-n/2,i+o/2,s-r/2]),this.appendVertex([e-n/2,i-o/2,s-r/2]),this.appendVertex([e-n/2,i-o/2,s+r/2]),this.appendVertex([e-n/2,i+o/2,s+r/2]),_=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],p={color:a,texCoords:h},u=0;6>u;u++)p.normals=[_[u]],this.addQuad(c+4*u,c+4*u+1,c+4*u+2,c+4*u+3,p),l||(p.normals=[t.scaled3(_[u],-1)],this.addQuad(c+4*u+2,c+4*u+1,c+4*u,c+4*u+3,p))},r.prototype.addSphere=function(e,i,s,n,o,r,h,l){var u,c,_,p,d,g,f,m,y,S;for(u=0;o>u;u++)for(_=0;o>_;_++)this.appendVertex([e+n*Math.sin(2*_*Math.PI/o)*Math.cos(2*u*Math.PI/o),i+n*Math.cos(2*_*Math.PI/o),s+n*Math.sin(2*u*Math.PI/o)*Math.sin(2*_*Math.PI/o)]);for(c=this._vertices.length-o*o,o%2===1&&(this._vertices[c+(o+1)/2].setX(e),this._vertices[c+(o+1)/2].setZ(s)),u=0;o>u;u++)for(p=[c+u*o,c+(u+1)%o*o+1,c+u*o+1],d=a(h[0][0],h[0][1],h[2][0],h[2][1],1/(2*o)+u/o,1),g=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/o,1-2/o),f=a(h[0][0],h[0][1],h[2][0],h[2][1],u/o,1-2/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-s)/n],y=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-s)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-s)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:r,texCoords:[d,g,f],normals:[m,y,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:r,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(y,-1)]}),p=o%2===0?[c+u*o+o/2,c+u*o+o/2-1,c+(u+1)%o*o+o/2-1]:[c+(o+1)/2,c+u*o+(o-1)/2,c+(u+1)%o*o+(o-1)/2],d=a(h[0][0],h[0][1],h[2][0],h[2][1],1/(2*o)+u/o,0),g=a(h[0][0],h[0][1],h[2][0],h[2][1],u/o,o%2===0?2/o:1/o),f=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/o,o%2===0?2/o:1/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-s)/n],y=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-s)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-s)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:r,texCoords:[d,g,f],normals:[m,y,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:r,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(y,-1)]}),_=1;o/2-1>_;_++)p=[c+u*o+_,c+(u+1)%o*o+_+1,c+u*o+_+1],d=a(h[0][0],h[0][1],h[2][0],h[2][1],u/o,1-2*_/o),g=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/o,1-2*(_+1)/o),f=a(h[0][0],h[0][1],h[2][0],h[2][1],u/o,1-2*(_+1)/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-s)/n],y=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-s)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-s)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:r,texCoords:[d,g,f],normals:[m,y,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:r,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(y,-1)]}),p=[c+(u+1)%o*o+_+1,c+u*o+_,c+(u+1)%o*o+_],d=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/o,1-2*(_+1)/o),g=a(h[0][0],h[0][1],h[2][0],h[2][1],u/o,1-2*_/o),f=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/o,1-2*_/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-s)/n],y=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-s)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-s)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:r,texCoords:[d,g,f],normals:[m,y,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:r,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(y,-1)]})},l.prototype.LOD_NOT_SET=-1,l.prototype.getName=function(){return this._name},l.prototype.setName=function(t){this._name=t},l.prototype.getMinLOD=function(){return this._minLOD},l.prototype.getMaxLOD=function(){return this._maxLOD},l.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this.getMinLOD(),t),this.getMaxLOD())},l.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},l.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;t>=e;e++)this._meshes.push(new r);return this._meshes[t]},l.prototype.startEditingMeshWithLOD=function(t){this._editedMesh=this.getMeshWithLOD(t),this._minEditedLOD=t,this._maxEditedLOD=t},l.prototype.getCurrentlyEditedMesh=function(){return this._editedMesh},l.prototype.setMinimumEditedLOD=function(t){this._minEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.setMaximumEditedLOD=function(t){this._maxEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.loadFromJSON=function(t,n,o){var r,a,h,l,u,c,p,d,g,f,m,y,S,T,E,b=null,M=null,O=null,A=null,x=function(t,e){var i;if(null===b){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();b=t,M=e}else{for(i=t;b>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=M+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();b=b>t?t:b,M=e>M?e:M}}.bind(this);if(o=o||0,e.log_DEBUG("Loading EgomModel data from file: "+t+" ...",2),"object"!=typeof n)return e.showError("'"+t+"' does not appear to be an JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if(c=n.version,!c)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(_.indexOf(c)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+c+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+_.join(", ")+"."),!1;for(p=null,this._infoProperties=n.info||{},this._name=n.info.name||null,this._scale=n.info.scale||1,O=n.info.defaultLOD[0],A=n.info.defaultLOD[1],p=n.info.colorPalette,g=n.vertices.length,r=0;g>r;r++)for(y=n.vertices[r].i,l=null===O?o:O,u=null===A?o:A,l=n.vertices[r].lod?n.vertices[r].lod[0]:l,u=n.vertices[r].lod?n.vertices[r].lod[1]:u,this.updateLODInfo(l,u),x(l,u),S=new i(n.vertices[r].p),a=l;u>=a;a++)this.getMeshWithLOD(a).setVertex(y,S);for(e.log_DEBUG("Loaded "+g+" vertices.",3),f=n.lines.length,r=0;f>r;r++)for(l=null===O?o:O,u=null===A?o:A,l=n.lines[r].lod?n.lines[r].lod[0]:l,u=n.lines[r].lod?n.lines[r].lod[1]:u,this.updateLODInfo(l,u),x(l,u),T=new s(n.lines[r].a,n.lines[r].b,p?p[n.lines[r].color]:n.lines[r].color,n.lines[r].lum||0,n.lines[r].n),a=l;u>=a;a++)this.getMeshWithLOD(a).addLine(T);for(e.log_DEBUG("Loaded "+f+" lines.",3),m=n.triangles.length,d={},r=0;m>r;r++)for(l=null===O?o:O,u=null===A?o:A,l=n.triangles[r].lod?n.triangles[r].lod[0]:l,u=n.triangles[r].lod?n.triangles[r].lod[1]:u,this.updateLODInfo(l,u),x(l,u),d.color=p?p[n.triangles[r].color]:n.triangles[r].color,d.texCoords=n.triangles[r].t,d.normals=n.triangles[r].n,d.groupIndices=void 0!==n.triangles[r].groups?n.triangles[r].groups:null,d.withoutLines=!0,E=null,a=l;u>=a;a++)E?this.getMeshWithLOD(a).addTriangle(E,d.withoutLines):E=this.getMeshWithLOD(a).addTriangleWithParams(n.triangles[r].a,n.triangles[r].b,n.triangles[r].c,d);for(e.log_DEBUG("Loaded "+m+" triangles.",3),e.log_DEBUG("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),h="Number of triangles per LOD for "+this._name+": ",r=this._minLOD;r<=this._maxLOD;r++)h+=" ["+r+"]: "+this.getMeshWithLOD(r).getNumTriangles();return e.log_DEBUG(h,2),!0},l.prototype.getScale=function(){return this._scale},l.prototype._getLargestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||s>i)&&(i=s);return i},l.prototype._getLowestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||i>s)&&(i=s);return i},l.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getSize():0})},l.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxX():0})},l.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinX():0})},l.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxY():0})},l.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinY():0})},l.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxZ():0})},l.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinZ():0})},l.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getWidth():0})},l.prototype.getHeight=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getHeight():0})},l.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getDepth():0})},l.prototype.getWidthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getWidth(t)*this._scale},l.prototype.getHeightInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getHeight(t)*this._scale},l.prototype.getDepthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getDepth(t)*this._scale},l.prototype.getNumLines=function(t){return t=void 0!==t?t:this._minLOD,t>=0?this.getMeshWithLOD(t).getNumLines():0},l.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},l.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},l.prototype.getNumTriangles=function(t,e){return t=void 0!==t?t:this._minLOD,t>=0?this.getMeshWithLOD(t).getNumTriangles(e):0},l.prototype.addToContext=function(t,i){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var s=this._contextProperties[t.getName()];s?(!s.wireframe&&i&&(e.log_DEBUG("Adding model ("+this._name+") to context in wireframe mode)...",2),s.wireframe=!0,t.resetReadyState()),s.solid||i||(e.log_DEBUG("Adding model ("+this._name+") to context in solid mode)...",2),s.solid=!0,t.resetReadyState()),s.minLOD>this._minLOD&&(e.log_DEBUG("Adding model ("+this._name+") to context with minimum LOD "+this._minLOD+"...",2),s.minLOD=this._minLOD,t.resetReadyState()),s.maxLOD<this._maxLOD&&(e.log_DEBUG("Adding model ("+this._name+") to context with maximum LOD "+this._maxLOD+"...",2),s.maxLOD=this._maxLOD,t.resetReadyState())):(e.log_DEBUG("Adding model ("+this._name+") to context ("+(i?"wireframe":"solid")+" mode)...",2),s=new h,s.wireframe=i,s.solid=!i,s.minLOD=this._minLOD,s.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t.getName()]=s},l.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},l.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this.getMeshWithLOD(i).getBufferData(t,e)},l.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t.getName()],s=0;for(e=i.minLOD;e<=i.maxLOD;e++)s+=this.getMeshWithLOD(e).getBufferSize(i.wireframe,i.solid);return s},l.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var s=this._contextProperties[t.getName()];return this.getMeshWithLOD(i).loadToVertexBuffers(t,e,s.wireframe,s.solid)},l.prototype.render=function(t,e,i,s){s=void 0!==s?s:this._minLOD,this.getMeshWithLOD(s).render(t,e,i)},l.prototype.renderInstances=function(t,e,i,s,n){s=void 0!==s?s:this._minLOD,this.getMeshWithLOD(s).renderInstances(t,e,i,n)},l.prototype.appendVertex=function(t,e){var i;if(this._editedMesh)this._editedMesh.appendVertex(t,e);else for(i=this._minEditedLOD;i<=this._maxEditedLOD;i++)this.getMeshWithLOD(i).appendVertex(t,e)},l.prototype.addLine=function(t){var e;if(this._editedMesh)this._editedMesh.addLine(t);else for(e=this._minEditedLOD;e<=this._maxEditedLOD;e++)this.getMeshWithLOD(e).addLine(t)},l.prototype.addQuad=function(t,e,i,s,n){var o;if(this._editedMesh)this._editedMesh.addQuad(t,e,i,s,n);else for(o=this._minEditedLOD;o<=this._maxEditedLOD;o++)this.getMeshWithLOD(o).addQuad(t,e,i,s,n)},l.prototype.addCuboid=function(t,e,i,s,n,o,r,a,h){var l;if(this._editedMesh)this._editedMesh.addCuboid(t,e,i,s,n,o,r,a,h);else for(l=this._minEditedLOD;l<=this._maxEditedLOD;l++)this.getMeshWithLOD(l).addCuboid(t,e,i,s,n,o,r,a,h)},{VertexAttributeRole:u,Model:l,fvqModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t,e){var i,s=new l;return t&&s.setName(t),i=e||c,s.appendVertex([-1,-1,0]),s.appendVertex([1,-1,0]),s.appendVertex([1,1,0]),s.appendVertex([-1,1,0]),s.addQuad(0,1,2,3,{texCoords:[[i[0][0],i[1][1]],[i[1][0],i[1][1]],[i[1][0],i[0][1]],[i[0][0],i[0][1]]]}),s},turningBillboardModel:function(t,e,i){var s,n=.5-.5*i,o=.5+.5*i,r=.75-.25*i,a=.75+.25*i,h=new l;if(t&&h.setName(t),h.appendVertex([-i,-1,0]),h.appendVertex([i,-1,0]),h.appendVertex([i,1,0]),h.appendVertex([-i,1,0]),h.addQuad(0,1,2,3,{texCoords:[[n,.5],[o,.5],[o,0],[n,0]]}),e)for(s=0;s<e.length;s++)h.appendVertex([i,e[s],-i]),h.appendVertex([-i,e[s],-i]),h.appendVertex([-i,e[s],i]),h.appendVertex([i,e[s],i]),h.addQuad(4*(s+1),4*(s+1)+1,4*(s+1)+2,4*(s+1)+3,{texCoords:[[n,a],[o,a],[o,r],[n,r]]}),h.addQuad(4*(s+1)+3,4*(s+1)+2,4*(s+1)+1,4*(s+1),{texCoords:[[n,a],[o,a],[o,r],[n,r]]});return h},cuboidModel:function(t,e,i,s,n){var o=new l;return t&&o.setName(t),o.addCuboid(0,0,0,e,i,s,n,[[0,1],[1,1],[1,0],[0,0]],!1),o},lineModel:function(t,e,i){var n=new l;return t&&n.setName(t),n.appendVertex([0,0,0]),n.appendVertex(e),n.addLine(new s(0,1,i,e)),n}}}),define("modules/audio",["modules/application"],function(t){"use strict";function e(t,e,i,s){var n=m.currentTime;t.gain.cancelScheduledValues(n),t.gain.setValueAtTime(t.gain.value,n),s?t.gain.setTargetAtTime(e,n,i||T):t.gain.linearRampToValueAtTime(e,n+(i||T))}function i(t,e,i){this._position=t?t.slice():null,this._rolloffFactor=e||E,this._pannerNode=null,this._panningModel=i||b,this._clips={}}function s(t,e,i,s,n,o,r,a){this._soundCategory=t,this._sampleName=e,this._volume=i,this._loop=s,this._shouldStack=n||!1,this._stackTimeThreshold=o||0,this._stackVolumeFactor=r||1,this._sourceNode=null,this._gainNode=null,this._playbackStartTime=0,this._playing=!1,this._onFinish=null,this._soundSource=null,a&&this.setSource(a)}function n(e,i,s,n){m.decodeAudioData(i.response,function(t){M[e]=t,s&&s()},function(){t.showError("Decoding audio sample '"+e+"' failed!"),n&&n()})}function o(t,e,n,o){s.call(g,y.SOUND_EFFECT,t,e,!1),n&&(i.call(f,n,o,b),g.setSource(f)),g.play()}function r(t,i){i?e(u,t,i):u.gain.value=t}function a(t,i){i?e(c,t,i):c.gain.value=t}function h(t,i){i?e(_,t,i):_.gain.value=t}function l(t,i){i?e(p,t,i):p.gain.value=t}var u,c,_,p,d,g,f,m,y={NOME:0,SOUND_EFFECT:1,MUSIC:2,UI:3},S={EQUAL_POWER:"equalpower",HRTF:"HRTF"},T=.01,E=.01,b=S.EQUAL_POWER,M={};return i.prototype.getNode=function(){
return this._pannerNode||(this._pannerNode=m.createPanner(),this._pannerNode.panningModel=this._panningModel,this._pannerNode.refDistance=1,this._pannerNode.rolloffFactor=this._rolloffFactor,this._pannerNode.setPosition(this._position[0],this._position[1],this._position[2]),this._pannerNode.connect(u)),this._pannerNode},i.prototype.setPosition=function(t,e,i){var s;(t!==this._position[0]||e!==this._position[1]||i!==this._position[2])&&(this._position[0]=t,this._position[1]=e,this._position[2]=i,this._pannerNode&&(this._pannerNode.positionX&&(!this._gainNode||this._gainNode.gain.value>0)?(s=m.currentTime,this._pannerNode.positionX.value!==t&&(this._pannerNode.positionX.cancelScheduledValues(s),this._pannerNode.positionX.setValueAtTime(this._pannerNode.positionX.value,s),this._pannerNode.positionX.linearRampToValueAtTime(t,s+T)),this._pannerNode.positionY.value!==e&&(this._pannerNode.positionY.cancelScheduledValues(s),this._pannerNode.positionY.setValueAtTime(this._pannerNode.positionY.value,s),this._pannerNode.positionY.linearRampToValueAtTime(e,s+T)),this._pannerNode.positionZ.value!==i&&(this._pannerNode.positionZ.cancelScheduledValues(s),this._pannerNode.positionZ.setValueAtTime(this._pannerNode.positionZ.value,s),this._pannerNode.positionZ.linearRampToValueAtTime(i,s+T))):this._pannerNode.setPosition(t,e,i)))},i.prototype.setClip=function(t,e){this._clips[t]=e},i.prototype.getClip=function(t){return this._clips[t]},i.prototype.destroy=function(){this._pannerNode&&this._pannerNode.disconnect(),this._pannerNode=null},s.prototype.setSource=function(e){this._soundCategory!==y.SOUND_EFFECT?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because its sound category is not sound effect!"):this._soundSource?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it already has a source!"):this._playing?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it is already playing!"):this._soundSource=e},s.prototype.getVolume=function(){return void 0!==this._volume?this._volume:1},s.prototype.setVolume=function(t){this._volume=t,this._gainNode&&(this._gainNode.gain.value=t)},s.prototype.increaseVolume=function(t){this._volume+=t,this._gainNode&&(this._gainNode.gain.value=this._volume)},s.prototype.rampVolume=function(t,i,s,n){!this._gainNode||s&&this._volume===t||e(this._gainNode,t,i,n),this._volume=t},s.prototype.getPlaybackPosition=function(){var t=m.currentTime-this._playbackStartTime;return this._loop?t%M[this._sampleName].duration:Math.min(t,M[this._sampleName].duration)},s.prototype.isPlaying=function(){return this._playing},s.prototype._startPlayingSample=function(e,i){var s;if(this._sourceNode=m.createBufferSource(),this._sourceNode.buffer=M[this._sampleName],this._sourceNode.onended=function(){this._playing=!1,i&&i()}.bind(this),this._onFinish=i,s=this._sourceNode,void 0!==this._volume&&(this._gainNode=m.createGain(),this._gainNode.gain.value=this._volume,s.connect(this._gainNode),s=this._gainNode),this._loop&&(this._sourceNode.loop=!0),this._soundSource)s.connect(this._soundSource.getNode());else switch(this._soundCategory){case y.SOUND_EFFECT:s.connect(u);break;case y.MUSIC:s.connect(c);break;case y.UI:s.connect(_);break;default:t.showError("Cannot play sound '"+this._sampleName+"', because it has an unkown category: "+this._soundCategory)}this._playing=!0,this._sourceNode.start(m.currentTime,e),this._playbackStartTime=m.currentTime-e},s.prototype.play=function(e,i){var s;if(M[this._sampleName]){if(this._playing)if(e)this.stopPlaying();else if(this._loop)return;this._soundSource&&this._shouldStack?(s=this._soundSource.getClip(this._sampleName),s&&s.isPlaying()&&s.getPlaybackPosition()<=this._stackTimeThreshold?s.increaseVolume(this._volume*this._stackVolumeFactor):(this._startPlayingSample(0,i),this._soundSource&&this._soundSource.setClip(this._sampleName,this))):this._startPlayingSample(0,i)}else this._sampleName&&t.showError("Attempting to play back '"+this._sampleName+"', which is not loaded!")},s.prototype.stopPlaying=function(t){this._sourceNode&&(t?(this.rampVolume(0,t),setTimeout(this._sourceNode.stop.bind(this._sourceNode),1e3*t)):this._sourceNode.stop())},s.prototype.destroy=function(){this.stopPlaying(),this._sourceNode=null,this._gainNode=null,this._position=null},m=new AudioContext,d=m.createDynamicsCompressor(),d.connect(m.destination),p=m.createGain(),p.connect(d),u=m.createGain(),u.connect(p),c=m.createGain(),c.connect(p),_=m.createGain(),_.connect(p),g=new s,f=new i,{SoundCategory:y,PanningModel:S,SoundClip:s,SoundSource:i,loadSample:n,playSound:o,setEffectVolume:r,setMusicVolume:a,setUIVolume:h,setMasterVolume:l}}),define("modules/media-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model","modules/audio"],function(t,e,i,s,n,o,r){"use strict";function a(t){s.GenericResource.call(this,t?t.name:""),this._dataJSON=t,t&&this._loadConfig(t)}function h(t){a.call(this,t)}function l(t){a.call(this,t)}function u(t){a.call(this,t)}function c(t){a.call(this,t)}function _(t){a.call(this,t)}function p(t){a.call(this,t)}function d(){s.ResourceManager.call(this)}function g(t,e){var i={};i[y]=h,i[S]=l,i[T]=u,i[E]=c,i[x]=_,i[C]=p,f.requestConfigLoad(t.filename,t.folder,i,e)}var f,m={VERTEX:"vertex",FRAGMENT:"fragment"},y="textures",S="cubemaps",T="shaders",E="models",b="texture",M="texture",O="shader",A="model",x="soundEffects",R="soundEffect",C="music",I="music",v='#include "',N='"',L="-",D={},w={},F={};return Object.freeze(m),a.prototype=new s.GenericResource,a.prototype.constructor=a,a.prototype._loadConfig=function(t){this._dataJSON=t},a.prototype.getData=function(){return this._dataJSON},a.prototype.reloadData=function(){this._loadConfig(this._dataJSON),this.resetReadyState()},h.prototype=new a,h.prototype.constructor=h,h.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._useMipmap=t.useMipmap===!0,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]},h.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},h.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},h.prototype._handleError=function(t){i.showError("Could not load texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},h.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)s=t.indexOf(o[e]),s>=0&&(-1===r||r>s)&&(r=s,n=t[s]);return-1===r?(i.showError("Texture '"+this.getName()+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},h.prototype._getProcessedParams=function(t){return t=t||{},t.types=t.types||Object.keys(this._typeSuffixes),t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},h.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e=0;e<t.types.length;e++)if(this._typeSuffixes.hasOwnProperty(t.types[e])){if(!this._images[t.types[e]])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[t.types[e]][t.qualities[i]])return!0}return!1},h.prototype._requestFiles=function(t){var e,s,n,o,r;for(t=this._getProcessedParams(t),e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(this._images[n]=this._images[n]||{},s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o]||(r=this._getPath(n,o),w[r]?this._images[n][o]=w[r]:(w[r]=new Image,this._imagesToLoad++,this._images[n][o]=w[r],this._images[n][o].onload=this._getOnLoadImageFunction(n,o).bind(this),this._images[n][o].onerror=this._handleError.bind(this,r))));for(e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o].src||(this._images[n][o].src=i.getFileURL(b,this._getPath(n,o))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},h.prototype._loadData=function(t){return t.error?(i.log("WARNING: Texture from file: "+t.path+" could not be loaded.",1),!1):(i.log_DEBUG("Texture from file: "+t.path+" has been loaded.",2),!0)},h.prototype.getTypes=function(){return Object.keys(this._typeSuffixes)},h.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},h.prototype.getManagedTexture=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot get managed GL texture for '"+this.getName()+"', as it has not been loaded from file yet!"),null):(this._images[t]||(i.showError("The requested texture '"+this.getName()+"' has no type '"+t+"' available!"),t=Object.keys(this._images)[0]),this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new n.ManagedTexture(this.getName(),this._images[t][e],this._useMipmap),this._managedTextures[t][e])},h.prototype.getManagedTexturesOfTypes=function(e,i){var s,n,o;for(e.sort(),s=0;s<this._cachedManagedTexturesOfTypes.length;s++)if(t.arraysEqual(e,this._cachedManagedTexturesOfTypes[s].types)&&t.arraysEqual(i,this._cachedManagedTexturesOfTypes[s].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[s].textures;for(n={},o=this._getMostFittingQuality(i),s=0;s<e.length;s++)n[e[s]]=this.getManagedTexture(e[s],o);return this._cachedManagedTexturesOfTypes.push({types:e,qualityPreferenceList:i,textures:n}),n},h.prototype.getManagedTextures=function(t){return this.getManagedTexturesOfTypes(this.getTypes(),t)},l.prototype=new a,l.prototype.constructor=l,l.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._imageNames=t.imageNames,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]},l.prototype._getPath=function(t,e){return this._basepath+this._imageNames[t]+this._qualitySuffixes[e]+"."+this._format},l.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},l.prototype._handleError=function(t){i.showError("Could not load cube mapped texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},l.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)s=t.indexOf(o[e]),s>=0&&(-1===r||r>s)&&(r=s,n=t[s]);return-1===r?(i.showError("Cubemap '"+this.getName()+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},l.prototype._getProcessedParams=function(t){return t=t||{},t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},l.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){if(!this._images[e])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[e][t.qualities[i]])return!0}return!1},l.prototype._requestFiles=function(t){var e,s,n,o;t=this._getProcessedParams(t);for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(this._images[e]=this._images[e]||{},s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n]||(o=this._getPath(e,n),F[o]?this._images[e][n]=F[o]:(F[o]=new Image,this._imagesToLoad++,this._images[e][n]=F[o],this._images[e][n].onload=this._getOnLoadImageFunction(e,n).bind(this),this._images[e][n].onerror=this._handleError.bind(this,o))));for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n].src||(this._images[e][n].src=i.getFileURL(M,this._getPath(e,n))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},l.prototype._loadData=function(t){return t.error?(i.log("WARNING: Face '"+t.path+"' of cubemap named '"+this.getName()+"' could not be loaded.",1),!1):(i.log_DEBUG("Face '"+t.path+"' of cubemap named '"+this.getName()+"' has been loaded.",2),!0)},l.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},l.prototype.getManagedCubemap=function(e){var s,o,r;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL cubemap for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(s=0;s<this._cachedManagedCubemaps.length;s++)if(t.arraysEqual(e,this._cachedManagedCubemaps[s].qualityPreferenceList))return this._cachedManagedCubemaps[s].cubemap;return r=this._getMostFittingQuality(e),o=new n.ManagedCubemap(this.getName(),[this._images.posX[r],this._images.negX[r],this._images.posY[r],this._images.negY[r],this._images.posZ[r],this._images.negZ[r]]),this._cachedManagedCubemaps.push({qualityPreferenceList:e,cubemap:o}),o},u.prototype=new a,u.prototype.constructor=u,u.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue(n.ShaderBlendMode,t.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0},u.prototype._checkAllSourcesLoaded=function(){this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad&&(this._vertexShaderSource===L&&(this._vertexShaderSource=null),this._fragmentShaderSource===L&&(this._fragmentShaderSource=null),this.onFinalLoad())},u.prototype._loadIncludeSource=function(t,e,i){var s;for(D[e].source=i,this._resolveInclude(t,e),s=0;s<D[e].onLoad.length;s++)D[e].onLoad[s]()},u.prototype._getIncludeFileName=function(t){return t.substr(v.length,t.length-(v.length+N.length))},u.prototype._resolveInclude=function(t,e){var s,n,o=D[e].source;switch(t){case m.VERTEX:n=this._vertexShaderSource.split("\n");break;case m.FRAGMENT:n=this._fragmentShaderSource.split("\n");break;default:i.crash()}for(s=0;s<n.length;s++)if(n[s].substr(0,v.length)===v&&e===this._getIncludeFileName(n[s])){switch(n[s]=o,t){case m.VERTEX:this._vertexShaderSource=n.join("\n");break;case m.FRAGMENT:this._fragmentShaderSource=n.join("\n");break;default:i.crash()}this._resolveSource(t,o);break}this._shaderIncludesLoaded++,this._checkAllSourcesLoaded()},u.prototype._resolveSource=function(t,e){var s,n=e.split("\n"),o=[];for(s=0;s<n.length;s++)n[s].substr(0,v.length)===v&&(o.push(this._getIncludeFileName(n[s])),this._shaderIncludesToLoad++);for(s=0;s<o.length;s++)D[o[s]]?D[o[s]].source?this._resolveInclude(t,o[s]):D[o[s]].onLoad.push(this._resolveInclude.bind(this,t,o[s])):(D[o[s]]={onLoad:[]},i.requestTextFile(O,o[s],this._loadIncludeSource.bind(this,t,o[s])))},u.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},u.prototype._requestFiles=function(){i.requestTextFile(O,this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:m.VERTEX,text:t})}.bind(this)),i.requestTextFile(O,this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:m.FRAGMENT,text:t})}.bind(this))},u.prototype._loadData=function(t){switch(e.getEnumValue(m,t.shaderType,{name:"shaderType",defaultValue:null})){case m.VERTEX:this._vertexShaderSource=t.text||L;break;case m.FRAGMENT:this._fragmentShaderSource=t.text||L;break;default:i.crash()}return t.text&&this._resolveSource(t.shaderType,t.text),this._checkAllSourcesLoaded(),t.text?!0:(i.log("ERROR: There was an error loading "+t.shaderType+" shader of shader program '"+this._name+"'!",1),!1)},u.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},u.prototype.getManagedShader=function(e,s){var o;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL shader for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(e=e||null,o=0;o<this._managedShaderBindings.length;o++)if(t.objectsEqual(this._managedShaderBindings[o].replacedDefines,e))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new n.ManagedShader(this.getName(),this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e,s),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},c.prototype=new a,c.prototype.constructor=c,c.prototype._loadConfig=function(t){return a.prototype._loadConfig.call(this,t),t.model?(this._model=t.model,this._files=[],this._dataJSON=null,void this.setToReady()):(this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,void(this._maxLoadedLOD=-1))},c.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},c.prototype.requiresReload=function(t){return this.isRequested(t)?!1:0===this._files.length?!1:t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()?this.requiresReload({maxLOD:this.getMaxLOD()}):!1},c.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},c.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile(A,this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},c.prototype._requestFiles=function(t){var e,s;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(0>e&&this._files.length>0)for(s=this.getMaxLOD(),e=t.maxLOD+1;s>=e;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},c.prototype._loadData=function(t){return this._model=new o.Model,t.text?(i.log_DEBUG("Model file of max LOD level "+t.maxLOD+" has been loaded for model '"+this.getName()+"'",2),"{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):i.showError("Cannot load Egom Model from file '"+this._getPath(t.maxLOD)+"' - the file needs to start with '{'!"),this._maxLoadedLOD=t.maxLOD,!0):(i.showError("Model file of max LOD level "+t.maxLOD+" could not be loaded for model '"+this.getName()+"'!"),!1)},c.prototype.getEgomModel=function(){return this.isReadyToUse()===!1?(i.showError("Cannot get model object for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._model},_.prototype=new a,_.prototype.constructor=_,_.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._samples=t.samples,this._loadedSamples=0,this._samplesToLoad=0},_.prototype.requiresReload=function(){return!this.isReadyToUse()&&!this.isRequested()},_.prototype._requestFile=function(t){this._samplesToLoad++,i.requestFile(R,this._samples[t],function(e){e?r.loadSample(this._samples[t],e,function(){this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t]})}.bind(this)):(i.showError("Could not load sound sample '"+this.getName()+"'!"),this._samples[t]=null,this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t],error:!0}))}.bind(this),void 0,"arraybuffer")},_.prototype._requestFiles=function(){var t;for(t=0;t<this._samples.length;t++)this._requestFile(t)},_.prototype._loadData=function(t){return t.error?(i.log("WARNING: Sound effect sample from file: "+t.path+" could not be loaded.",1),!1):(i.log_DEBUG("Sound effect sample from file: "+t.path+" has been loaded.",2),!0)},_.prototype.play=function(t,e,s){var n;return this.isReadyToUse()===!1?void i.showError("Cannot play sound effect '"+this.getName()+"', as it has not been loaded from file yet!"):(n=this._samples[Math.floor(Math.random()*this._samples.length)],void(n?r.playSound(n,t,e,s):i.log("WARNING: cannot play sound sample '"+n+"', as there was a problem while loading it.",1)))},_.prototype.createSoundClip=function(t,e,s,n,o,a,h){var l;return this.isReadyToUse()===!1?(i.showError("Cannot create sound source for sound effect '"+this.getName()+"', as it has not been loaded from file yet!"),null):(l=this._samples[Math.floor(Math.random()*this._samples.length)])?new r.SoundClip(t,l,e,s,n,o,a,h):(i.log("WARNING: cannot create sound source for sample '"+l+"', as there was a problem while loading it.",1),null)},p.prototype=new a,p.prototype.constructor=p,p.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._sample=t.sample},p.prototype.requiresReload=function(){return!this.isReadyToUse()&&!this.isRequested()},p.prototype._requestFiles=function(){i.requestFile(I,this._sample,function(t){t?r.loadSample(this._sample,t,function(){this._onFilesLoad(!0,{path:this._sample})}.bind(this)):(i.showError("Could not load music track '"+this.getName()+"'!"),this._sample=null,this._onFilesLoad(!0,{path:this._sample,error:!0}))}.bind(this),void 0,"arraybuffer")},p.prototype._loadData=function(t){return t.error?(i.log("WARNING: Music song from file: "+t.path+" cound not be loaded.",1),!1):(i.log_DEBUG("Music song from file: "+t.path+" has been loaded.",2),!0)},p.prototype.createSoundClip=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot create sound source for music '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._sample?new r.SoundClip(r.SoundCategory.MUSIC,this._sample,t,e):(i.log("WARNING: cannot create sound source for music track '"+this._sample+"', as there was a problem while loading it.",1),null)},d.prototype=new s.ResourceManager,d.prototype.constructor=d,d.prototype.getTexture=function(t,e){return this.getResource(y,t,e)},d.prototype.getCubemap=function(t,e){return this.getResource(S,t,e)},d.prototype.getShader=function(t){return this.getResource(T,t)},d.prototype.getVariantShader=function(t,e){return this.getResource(T,this.getResource(T,t,{doNotLoad:!0}).getVariantShaderName(e),{allowNullResult:!0})||this.getShader(t)},d.prototype.getModel=function(t,e){return this.getResource(E,t,e)},d.prototype.getOrAddModel=function(t){var e=this.getResource(E,t.getName(),{allowNullResult:!0});return e||(e=this.addResource(E,new c({name:t.getName(),model:t}))),e},d.prototype.getSoundEffect=function(t){return this.getResource(x,t)},d.prototype.getMusic=function(t){return this.getResource(C,t)},f=new d,{SoundCategory:r.SoundCategory,requestConfigLoad:g,requestResourceLoad:f.requestResourceLoad.bind(f),getTexture:f.getTexture.bind(f),getCubemap:f.getCubemap.bind(f),getShader:f.getShader.bind(f),getVariantShader:f.getVariantShader.bind(f),getModel:f.getModel.bind(f),getOrAddModel:f.getOrAddModel.bind(f),getSoundEffect:f.getSoundEffect.bind(f),getMusic:f.getMusic.bind(f),getResourceTypes:f.getResourceTypes.bind(f),getResourceNames:f.getResourceNames.bind(f),getResource:f.getResource.bind(f),addResource:f.addResource.bind(f),createResource:f.createResource.bind(f),executeWhenReady:f.executeWhenReady.bind(f),executeOnResourceLoad:f.executeOnResourceLoad.bind(f),executeForAllResources:f.executeForAllResources.bind(f),renameResource:f.renameResource.bind(f),moveResourceAfter:f.moveResourceAfter.bind(f)}}),define("utils/matrices",["utils/vectors"],function(t){"use strict";function e(){var t;for(t=0;t<r.length;t++)if(!r[t].used)return t;return r.push({used:!1,matrix:n.identity4()}),r.length-1}function i(t){return r[t].used=!0,r[t].matrix}function s(t){r[t].used=!1}var n={},o=.99999,r=[],a=0;return n.clearMatrixCount=function(){a=0},n.getMatrixCount=function(){return a},n.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},n.IDENTITY3=n.identity3(),n.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},n.IDENTITY4=n.identity4(),n.null3=function(){return new Float32Array([0,0,0,0,0,0,0,0,0])},n.null4=function(){return new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},n.matrix3=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]])},n.matrix4=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]])},n.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},n.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},n.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},n.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},n.rotation4=function(t,e){var i=Math.cos(e),s=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-s*t[2],(1-i)*t[0]*t[2]+s*t[1],0,(1-i)*t[0]*t[1]+s*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-s*t[0],0,(1-i)*t[0]*t[2]-s*t[1],(1-i)*t[1]*t[2]+s*t[0],i+(1-i)*t[2]*t[2],0,0,0,0,1])},n.rotationAroundPoint4=function(e,i,s){var o=n.rotation4(i,s),r=t.mulVec3Mat4(e,o);return o[12]=e[0]-r[0],o[13]=e[1]-r[1],o[14]=e[2]-r[2],o},n.rotation4m4=function(t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1])},n.lookTowards4=function(e,i){var s,r;return i=i||[0,1,0],s=new Float32Array([1,0,0,0,0,1,0,0,e[0],e[1],e[2],0,0,0,0,1]),Math.abs(t.dot3(i,e))>o&&(i=t.perpendicular3(e)),r=t.cross3(i,e),s[0]=r[0],s[1]=r[1],s[2]=r[2],i=t.cross3(e,r),s[4]=i[0],s[5]=i[1],s[6]=i[2],n.correctedOrthogonal4(s)},n.scaling4=function(t,e,i){return e=e||t,i=i||t,new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},n.translationRotation=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,t[12],t[13],t[14],1])},n.perspective4=function(t,e,i,s){return new Float32Array([i/t,0,0,0,0,i/e,0,0,0,0,(i+s)/(i-s),-1,0,0,2*i*s/(i-s),0])},n.orthographic4=function(t,e,i,s){return new Float32Array([1/t,0,0,0,0,1/e,0,0,0,0,-2/(s-i),0,0,0,-(i+s)/2,1])},n.translationFromXMLTag=function(e){return n.translation4v(t.fromXMLTag3(e))},n.rotation4FromXMLTags=function(t){var e,i,s=n.identity4();for(e=0;e<t.length;e++)i=[0,0,0],"x"===t[e].getAttribute("axis")?i=[1,0,0]:"y"===t[e].getAttribute("axis")?i=[0,1,0]:"z"===t[e].getAttribute("axis")&&(i=[0,0,1]),s=n.prod4(s,n.rotation4(i,parseFloat(t[e].getAttribute("degree"))/180*Math.PI));return s},n.rotation4FromJSON=function(e){var i,s,o,r=n.identity4();if(e)for(i=0;i<e.length;i++){if(o="string"==typeof e[i]?{axis:e[i][0],degrees:parseFloat(e[i].substring(1))}:e[i],"string"==typeof o.axis)switch(o.axis){case"x":case"X":s=t.UNIT3_X;break;case"y":case"Y":s=t.UNIT3_Y;break;case"z":case"Z":s=t.UNIT3_Z}else o.axis instanceof Array&&(s=o.axis);r=n.prod4(r,n.rotation4(s,o.degrees/180*Math.PI))}return r},n.fromVectorsTo3=function(t,e,i){return new Float32Array([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]])},n.fromVectorsTo4=function(t,e,i,s){return s=s||[0,0,0,1],new Float32Array([t[0],t[1],t[2],t.length>3?t[3]:0,e[0],e[1],e[2],e.length>3?e[3]:0,i[0],i[1],i[2],i.length>3?i[3]:0,s[0],s[1],s[2],s[3]])},n.getRowA3=function(t){return[t[0],t[1],t[2]]},n.getRowA3Neg=function(t){return[-t[0],-t[1],-t[2]]},n.getRowA4=function(t){return[t[0],t[1],t[2],t[3]]},n.getRowA4Neg=function(t){return[-t[0],-t[1],-t[2],-t[3]]},n.getRowA43=function(t){return[t[0],t[1],t[2]]},n.getRowA43Neg=function(t){return[-t[0],-t[1],-t[2]]},n.getRowB3=function(t){return[t[3],t[4],t[5]]},n.getRowB3Neg=function(t){return[-t[3],-t[4],-t[5]]},n.getRowB4=function(t){return[t[4],t[5],t[6],t[7]]},n.getRowB4Neg=function(t){return[-t[4],-t[5],-t[6],-t[7]]},n.getRowB43=function(t){return[t[4],t[5],t[6]]},n.getRowB43Neg=function(t){return[-t[4],-t[5],-t[6]]},n.getRowC4=function(t){return[t[8],t[9],t[10],t[11]]},n.getRowC43=function(t){return[t[8],t[9],t[10]]},n.getRowC43Neg=function(t){return[-t[8],-t[9],-t[10]]},n.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},n.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},n.translationVector3=function(t){return[t[12],t[13],t[14]]},n.translationVector4=function(t){return[t[12],t[13],t[14],t[15]]},n.translationLength=function(e){return t.length3([e[12],e[13],e[14]])},n.getVectorYawAndPitch=function(e){var i,s={};return Math.abs(e[2])>o?(s.yaw=0,s.pitch=e[2]>0?-Math.PI/2:Math.PI/2):(s.yaw=t.angle2uCapped([0,1],t.normal2([e[0],e[1]])),e[0]<0&&(s.yaw=-s.yaw),i=t.mulVec3Mat4(e,n.rotation4([0,0,1],-s.yaw)),s.pitch=t.angle2uCapped([1,0],t.normal2([i[1],i[2]])),i[2]>0&&(s.pitch=-s.pitch)),s},n.getYawAndPitch=function(e){var i,s={};return Math.abs(e[6])>o?(s.yaw=0,s.pitch=e[6]>0?-Math.PI/2:Math.PI/2):(s.yaw=t.angle2uCapped([0,1],t.normal2(e[10]>0?[e[4],e[5]]:[-e[4],-e[5]])),e[4]*e[10]<0&&(s.yaw=-s.yaw),i=n.correctedOrthogonal4(n.prod3x3SubOf4(e,n.rotation4([0,0,1],-s.yaw))),s.pitch=t.angle2uCapped([1,0],t.normal2([i[5],i[6]])),i[6]>0&&(s.pitch=-s.pitch)),s},n.getRotations=function(e){var i,s,r={};return i=t.dot3([0,1,0],n.getRowB43(e)),Math.abs(i)>o?(r.alphaAxis=[0,0,1],r.alpha=i>0?0:Math.PI):(r.alphaAxis=t.normal3(t.cross3(n.getRowB43(e),[0,1,0])),r.alpha=t.angle3u(n.getRowB43(e),[0,1,0])),r.alpha>Math.PI&&(r.alpha-=2*Math.PI),s=n.correctedOrthogonal4(n.prod3x3SubOf4(e,n.rotation4(r.alphaAxis,-r.alpha))),i=t.dot3([1,0,0],n.getRowA43(s)),Math.abs(i)>o?(r.gammaAxis=[0,1,0],r.gamma=i>0?0:Math.PI):(r.gammaAxis=t.normal3(t.cross3(n.getRowA43(s),[1,0,0])),r.gamma=t.angle3u(n.getRowA43(s),[1,0,0])),r.gamma>Math.PI&&(r.gamma-=2*Math.PI),r},n.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+"\n"+t[3].toFixed(e)+" "+t[4].toFixed(e)+" "+t[5].toFixed(e)+"\n"+t[6].toFixed(e)+" "+t[7].toFixed(e)+" "+t[8].toFixed(e)},n.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"\n"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"\n"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"\n"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},n.toHTMLString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"<br/>"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"<br/>"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"<br/>"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},n.matrix3from4=function(t){return new Float32Array([t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]])},n.matrix4from3=function(t){return new Float32Array([t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1])},n.transposed3=function(t){return new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])},n.transposed43=function(t){return new Float32Array([t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]]);
},n.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},n.inverse3=function(t){var o,r,a,h,l,u,c,_,p=e();if(u=i(p),n.setMatrix3(u,t),c=n.identity3(),0===n.determinant3(u))return n.null3();for(o=0;3>o;o++){if(Math.abs(u[4*o])<=1e-4){for(r=o+1;Math.abs(u[3*r+o])<=1e-4;)r++;for(a=0;3>a;a++)_=u[3*o+a],u[3*o+a]=u[3*r+a],u[3*r+a]=_,_=c[3*o+a],c[3*o+a]=c[3*r+a],c[3*r+a]=_}for(h=u[4*o],r=0;3>r;r++)u[3*o+r]=u[3*o+r]/h,c[3*o+r]=c[3*o+r]/h;for(r=o+1;3>r;r++)for(l=u[3*r+o]/u[4*o],a=0;3>a;a++)u[3*r+a]=u[3*r+a]-l*u[3*o+a],c[3*r+a]=c[3*r+a]-l*c[3*o+a]}for(o=2;o>=1;o--)for(r=o-1;r>=0;r--)for(a=0;3>a;a++)c[3*r+a]=c[3*r+a]-u[3*r+o]*c[3*o+a];return s(p),c},n.inverse4=function(t){var o,r,a,h,l,u,c,_,p=e();for(u=i(p),n.setMatrix4(u,t),c=n.identity4(),o=0;4>o;o++){if(Math.abs(u[5*o])<=1e-4){for(r=o+1;Math.abs(u[4*r+o])<=1e-4;)r++;for(a=0;4>a;a++)_=u[4*o+a],u[4*o+a]=u[4*r+a],u[4*r+a]=_,_=c[4*o+a],c[4*o+a]=c[4*r+a],c[4*r+a]=_}for(h=u[5*o],r=0;4>r;r++)u[4*o+r]=u[4*o+r]/h,c[4*o+r]=c[4*o+r]/h;for(r=o+1;4>r;r++)for(l=u[4*r+o]/u[5*o],a=0;4>a;a++)u[4*r+a]=u[4*r+a]-l*u[4*o+a],c[4*r+a]=c[4*r+a]-l*c[4*o+a]}for(o=3;o>=1;o--)for(r=o-1;r>=0;r--)for(a=0;4>a;a++)c[4*r+a]=c[4*r+a]-u[4*r+o]*c[4*o+a];return s(p),c},n.inverseOfTranslation4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t[12],-t[13],-t[14],1])},n.inverseOfRotation4=n.transposed4,n.inverseOfScaling4=function(t){return n.scaling4(1/t[0],1/t[5],1/t[10])},n.scaled3=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e])},n.scaled4=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e])},n.correctedOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),s=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,s);return s=t.cross3(n,i),new Float32Array([i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1])},n.straightened=function(t,e){var i,s=new Float32Array(t);for(i=0;i<s.length;i++)s[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i];return s},n.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},n.sum4=function(t,e){return new Float32Array([t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15]])},n.prod3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]])},n.prod4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]])},n.prod3x3SubOf43=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]])},n.prod3x3SubOf4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],0,t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],0,t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10],0,0,0,0,1])},n.prodTranslationRotation4=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[0]*t[12]+e[4]*t[13]+e[8]*t[14],e[1]*t[12]+e[5]*t[13]+e[9]*t[14],e[2]*t[12]+e[6]*t[13]+e[10]*t[14],1])},n.prod34=function(t,e,i){var s=n.prod4(t,e);return n.mul4(s,i),s},n.translatedByVector=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[0],t[13]+e[1],t[14]+e[2],t[15]])},n.translatedByM4=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]])},n.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},n.setIdentity4=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},n.setMatrix3=function(t,e){var i;for(i=0;9>i;i++)t[i]=e[i]},n.setMatrix4=function(t,e){var i;for(i=0;16>i;i++)t[i]=e[i]},n.setRotation4=function(t,e,i){var s=Math.cos(i),n=Math.sin(i);t[0]=s+(1-s)*e[0]*e[0],t[1]=(1-s)*e[0]*e[1]-n*e[2],t[2]=(1-s)*e[0]*e[2]+n*e[1],t[3]=0,t[4]=(1-s)*e[0]*e[1]+n*e[2],t[5]=s+(1-s)*e[1]*e[1],t[6]=(1-s)*e[1]*e[2]-n*e[0],t[7]=0,t[8]=(1-s)*e[0]*e[2]-n*e[1],t[9]=(1-s)*e[1]*e[2]+n*e[0],t[10]=s+(1-s)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},n.setRotationAroundPoint4=function(e,i,s,o){var r;n.setRotation4(e,s,o),r=t.mulVec3Mat4(i,e),e[12]=i[0]-r[0],e[13]=i[1]-r[1],e[14]=i[2]-r[2]},n.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},n.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},n.rotate4=function(t,o,r){var a=e(),h=i(a);n.setRotation4(h,o,r),n.mul4(t,h),s(a)},n.rotateAroundPoint4=function(t,o,r,a){var h=e(),l=i(h);n.setRotationAroundPoint4(l,o,r,a),n.mul4(t,l),s(h)},n.mul4=function(t,o){var r=e(),a=i(r);n.setMatrix4(a,t),t[0]=a[0]*o[0]+a[1]*o[4]+a[2]*o[8]+a[3]*o[12],t[1]=a[0]*o[1]+a[1]*o[5]+a[2]*o[9]+a[3]*o[13],t[2]=a[0]*o[2]+a[1]*o[6]+a[2]*o[10]+a[3]*o[14],t[3]=a[0]*o[3]+a[1]*o[7]+a[2]*o[11]+a[3]*o[15],t[4]=a[4]*o[0]+a[5]*o[4]+a[6]*o[8]+a[7]*o[12],t[5]=a[4]*o[1]+a[5]*o[5]+a[6]*o[9]+a[7]*o[13],t[6]=a[4]*o[2]+a[5]*o[6]+a[6]*o[10]+a[7]*o[14],t[7]=a[4]*o[3]+a[5]*o[7]+a[6]*o[11]+a[7]*o[15],t[8]=a[8]*o[0]+a[9]*o[4]+a[10]*o[8]+a[11]*o[12],t[9]=a[8]*o[1]+a[9]*o[5]+a[10]*o[9]+a[11]*o[13],t[10]=a[8]*o[2]+a[9]*o[6]+a[10]*o[10]+a[11]*o[14],t[11]=a[8]*o[3]+a[9]*o[7]+a[10]*o[11]+a[11]*o[15],t[12]=a[12]*o[0]+a[13]*o[4]+a[14]*o[8]+a[15]*o[12],t[13]=a[12]*o[1]+a[13]*o[5]+a[14]*o[9]+a[15]*o[13],t[14]=a[12]*o[2]+a[13]*o[6]+a[14]*o[10]+a[15]*o[14],t[15]=a[12]*o[3]+a[13]*o[7]+a[14]*o[11]+a[15]*o[15],s(r)},n.correctOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),s=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,s);s=t.cross3(n,i),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=s[0],e[5]=s[1],e[6]=s[2],e[7]=0,e[8]=n[0],e[9]=n[1],e[10]=n[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},n.straighten=function(t,e){var i;for(i=0;i<t.length;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},n}),define("modules/scene/object-3d",["utils/vectors","utils/matrices"],function(t,e){"use strict";function i(t,i,s,n){this._parent=null,this._positionMatrix=t||e.identity4(),this._orientationMatrix=i||e.identity4(),this._scalingMatrix=s||e.identity4(),this._cascadeScalingMatrix=null,this._modelMatrix=null,this._modelMatrixForFrame=null,this._modelMatrixInverse=null,this._modelMatrixInverseForFrame=null,this._size=void 0!==n?n:1,this._insideParent=null,this._lastSizeInsideViewFrustum={width:-1,height:-1},this._positionMatrixInCameraSpace=null}var s,n;return s=function(){function i(){this._positionMatrixInCameraSpace=null,this._modelMatrixForFrame=null,this._modelMatrixInverseForFrame=null}function s(){return this._parent}function n(t){this._parent=t}function o(){return this._positionMatrix}function r(t){t&&(this._positionMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null,this._insideParent=null,this._positionMatrixInCameraSpace=null}function a(){return[this._positionMatrix[12],this._positionMatrix[13],this._positionMatrix[14]]}function h(t,i,s){e.translateByVector(this._positionMatrix,[t,i,s]),this.setPositionMatrix()}function l(t){e.translateByVector(this._positionMatrix,t),this.setPositionMatrix()}function u(t){e.translateByMatrix(this._positionMatrix,t),this.setPositionMatrix()}function c(){return this._orientationMatrix}function _(t){t&&(this._orientationMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null}function p(){return[this._orientationMatrix[0],this._orientationMatrix[1],this._orientationMatrix[2]]}function d(){return[this._orientationMatrix[4],this._orientationMatrix[5],this._orientationMatrix[6]]}function g(){return[this._orientationMatrix[8],this._orientationMatrix[9],this._orientationMatrix[10]]}function f(t,i){0!==i&&(e.rotate4(this._orientationMatrix,t,i),this.setOrientationMatrix())}function m(t){e.mul4(this._orientationMatrix,t),this.setOrientationMatrix()}function y(){return this._scalingMatrix}function S(t){this._scalingMatrix=t,this._modelMatrix=null,this._modelMatrixInverse=null,this._cascadeScalingMatrix=null}function T(t){this.setScalingMatrix(e.scaling4(t))}function E(){return this._cascadeScalingMatrix||(this._cascadeScalingMatrix=this._parent?e.prod3x3SubOf4(this._parent.getCascadeScalingMatrix(),this._scalingMatrix):this._scalingMatrix),this._cascadeScalingMatrix}function b(){return this._modelMatrixForFrame||(this._modelMatrix=this._modelMatrix||e.translationRotation(this._positionMatrix,e.prod3x3SubOf4(this._scalingMatrix,this._orientationMatrix)),this._modelMatrixForFrame=this._parent?e.prod4(this._modelMatrix,this._parent.getModelMatrix()):this._modelMatrix),this._modelMatrixForFrame}function M(){return this._modelMatrixInverseForFrame||(this._modelMatrixInverse=this._modelMatrixInverse||e.inverse4(this.getModelMatrix()),this._modelMatrixInverseForFrame=this._parent?e.prod4(this._parent.getModelMatrixInverse(),this._modelMatrixInverse):this._modelMatrixInverse),this._modelMatrixInverseForFrame}function O(){return this._size}function A(t){this._size=t}function x(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function R(){return null===this._insideParent&&(this._insideParent=this._parent?Math.abs(this._positionMatrix[12])<this._parent.getSize()&&Math.abs(this._positionMatrix[13])<this._parent.getSize()&&Math.abs(this._positionMatrix[14])<this._parent.getSize():!1),this._insideParent}function C(i){return this._positionMatrixInCameraSpace||(this._positionMatrixInCameraSpace=e.translation4v(t.mulVec4Mat4(e.translationVector4(this.getModelMatrix()),i.getViewMatrix()))),this._positionMatrixInCameraSpace}function I(i,s){var n,o,r,a,h,l,u,c,_,p;return r=this.getPositionMatrixInCameraSpace(i),o=this.getCascadeScalingMatrix(),s&&(n=this.getSize()*o[0],r[14]-n>=-i.getNearDistance()||r[14]+n<-i.getViewDistance())?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(a=e.prod34(o,r,i.getProjectionMatrix()),n=this.getSize(),p=1/a[15],h=[0===a[12]?0:a[12]*p,0===a[13]?0:a[13]*p,0===a[14]?0:a[14]*p],l=t.mulVec4Mat4([n,0,0,1],a),u=t.mulVec4Mat4([0,n,0,1],a),c=Math.abs((0===l[0]?0:l[0]/l[3])-h[0]),_=Math.abs((0===u[1]?0:u[1]/u[3])-h[1]),h[0]+c<-1||h[0]-c>1||h[1]+_<-1||h[1]-_>1?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(this._lastSizeInsideViewFrustum.width=c,this._lastSizeInsideViewFrustum.height=_,this._lastSizeInsideViewFrustum))}function v(i,s,n){var o,r;return o=t.mulVec4Mat4(e.translationVector4(this.getModelMatrix()),i),r=this.getScaledSize(),Math.abs(o[0])-r<s&&Math.abs(o[1])-r<s&&Math.abs(o[2])-r<s*n}return function(){this.prototype.resetCachedValues=i,this.prototype.getParent=s,this.prototype.setParent=n,this.prototype.getPositionMatrix=o,this.prototype.setPositionMatrix=r,this.prototype.getOrientationMatrix=c,this.prototype.setOrientationMatrix=_,this.prototype.getScalingMatrix=y,this.prototype.setScalingMatrix=S,this.prototype.setScale=T,this.prototype.getPositionVector=a,this.prototype.translate=h,this.prototype.translatev=l,this.prototype.translateByMatrix=u,this.prototype.getXDirectionVector=p,this.prototype.getYDirectionVector=d,this.prototype.getZDirectionVector=g,this.prototype.rotate=f,this.prototype.rotateByMatrix=m,this.prototype.getCascadeScalingMatrix=E,this.prototype.getModelMatrix=b,this.prototype.getModelMatrixInverse=M,this.prototype.getSize=O,this.prototype.setSize=A,this.prototype.getScaledSize=x,this.prototype.isInsideParent=R,this.prototype.getPositionMatrixInCameraSpace=C,this.prototype.getSizeInsideViewFrustum=I,this.prototype.isInsideShadowRegion=v}},n=s(),n.call(i),{Object3D:i,makeObject3DMixinClass:n}}),define("modules/scene/camera",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/scene/object-3d"],function(t,e,i,s,n){"use strict";function o(t,e,s,n,o,r,a,h,l,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=s,this._followedObjects=n||[],this._startsWithRelativePosition=o,this._defaultRelativePositionMatrix=i.matrix4(r),this._relativePositionMatrix=r,this._worldPositionMatrix=null,this._distanceIsConfined=a?!0:!1,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=h&&h[0]?!0:!1,this._minimumX=h&&h[0]?h[0][0]:0,this._maximumX=h&&h[0]?h[0][1]:0,this._yIsConfined=h&&h[1]?!0:!1,this._minimumY=h&&h[1]?h[1][0]:0,this._maximumY=h&&h[1]?h[1][1]:0,this._zIsConfined=h&&h[2]?!0:!1,this._minimumZ=h&&h[2]?h[2][0]:0,this._maximumZ=h&&h[2]?h[2][1]:0,this._resetsWhenLeavingConfines=l,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null}function r(t,e,s,n,o,r,a,h,l,d,g,f){this._fixed=t,this._pointsTowardsObjects=e,this._fps=s,this._followedObjects=n||[],this._defaultRelativeOrientationMatrix=i.matrix4(o),this._relativeOrientationMatrix=o,this._worldOrientationMatrix=null,this._defaultAlpha=r||0,this._alpha=r||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=h&&void 0!==h[0]?h[0]:u,this._maxAlpha=h&&void 0!==h[1]?h[1]:c,this._minBeta=l&&void 0!==l[0]?l[0]:_,this._maxBeta=l&&void 0!==l[1]?l[1]:p,this._baseOrientation=d,this._pointToFallback=g,this._isTransitionConfiguration=f,this._camera=null}function a(t,e,i,s,o,r,a,h,l){n.Object3D.call(this,e._positionMatrix,i._orientationMatrix),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=s,this._fov=s,this._minFOV=o?o[0]:0,this._maxFOV=o?o[1]:0,this._defaultSpan=r,this._span=r,this._minSpan=a?a[0]:0,this._maxSpan=a?a[1]:0,this._resetsOnFocusChange=h,this._excludeFromCycle=l,this._camera=null}function h(t,e,s,n,h,l,u,c,_){var p=i.getYawAndPitch(s);return new a("",new o(!1,!1,!1,[],!1,i.matrix4(e),null,null,!1),new r(!1,!1,t,[],i.matrix4(s),Math.degrees(p.yaw),Math.degrees(p.pitch),void 0,void 0,r.prototype.BaseOrientation.WORLD,r.prototype.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),n,[h,l],u,[c,_])}function l(t,e,s,o,r,a,h){this._object3D=new n.Object3D(i.identity4(),i.identity4(),i.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=s,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=this.TransitionStyle.NONE,this._defaultTransitionStyle=h||this.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=a||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=null,this._followedNode=null,this._viewMatrix=null,this._inversePositionMatrix=null,this._inverseOrientationMatrix=null,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._combinedExtendedCamera=null,this._updateFOV(),this._updateSpan()}var u=-360,c=360,_=-90,p=90,d=.95,g=1.05,f=.95,m=1.05,y=5;return o.prototype.copy=function(t){var e=new o(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,i.matrix4(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=i.matrix4(this._relativePositionMatrix),e._worldPositionMatrix=i.matrix4(this._worldPositionMatrix),e._isStarting=this._isStarting,e},o.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},o.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),i.setMatrix4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrix=null,this._isStarting=!0},o.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},o.prototype.moveByVector=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),i.translateByVector(this._relativePositionMatrix,t)},o.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},o.prototype.getFollowedPositionVector=function(){var t,i=[0,0,0];if(0===this._followedObjects.length)s.crash();else{for(t=0;t<this._followedObjects.length;t++)e.add3(i,this._followedObjects[t].getPositionVector());i=[i[0]/this._followedObjects.length,i[1]/this._followedObjects.length,i[2]/this._followedObjects.length]}return i},o.prototype.getFollowedPositionMatrix=function(){var t,e=i.identity4();if(0===this._followedObjects.length)s.crash();else{for(t=0;t<this._followedObjects.length;t++)i.translateByMatrix(e,this._followedObjects[t]._positionMatrix);e=i.translation4(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},o.prototype.getFollowedObjectOrientationMatrix=function(){var t;return 0===this._followedObjects.length?s.crash():t=i.matrix4(this._followedObjects[0]._orientationMatrix),t},o.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,s++;s>0&&(this._followedObjects.splice(t,s),0===this._followedObjects.length&&i.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},o.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t?this._worldPositionMatrix=i.translatedByM4(i.translation4m4(i.prodTranslationRotation4(this._relativePositionMatrix,i.prod3x3SubOf4(i.rotation4([1,0,0],Math.PI/2),t))),this.getFollowedPositionMatrix()):s.crash():this._worldPositionMatrix=i.translatedByM4(i.translation4m4(i.prodTranslationRotation4(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&(this._relativePositionMatrix=i.matrix4(this._worldPositionMatrix))):this._worldPositionMatrix=i.matrix4(this._relativePositionMatrix)},o.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrix||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},o.prototype._checkConfines=function(t){var n,o,r;if(r=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.translation4m4(i.prodTranslationRotation4(i.translatedByM4(this._relativePositionMatrix,i.inverseOfTranslation4(this.getFollowedPositionMatrix())),i.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(n=i.translationVector3(r),o=e.length3(n),o<this._minimumDistance||o>this._maximumDistance){if(o>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o=Math.min(Math.max(o,this._minimumDistance),this._maximumDistance),r=i.translation4v(e.scaled3(e.normal3(n),o))}}else if(t&&(n=e.diff3(i.translationVector3(r),t),o=e.length3(n),o<this._minimumDistance||o>this._maximumDistance)){if(o>this._maximumDistance&&this._resetsWhenLeavingConfines)return s.crash(),!1;o=Math.min(Math.max(o,this._minimumDistance),this._maximumDistance),r=i.translation4v(e.sum3(t,e.scaled3(e.normal3(n),o)))}if(this._xIsConfined&&(r[12]<this._minimumX||r[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;r[12]=Math.min(Math.max(r[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(r[13]<this._minimumY||r[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;r[13]=Math.min(Math.max(r[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(r[14]<this._minimumZ||r[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;r[14]=Math.min(Math.max(r[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?this._relativePositionMatrix=i.translatedByM4(i.translation4m4(i.prodTranslationRotation4(r,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):this._relativePositionMatrix=r,!0},o.prototype.update=function(t,s,n,o){var r,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)r=e.scaled3(e.mulVec3Mat4(n,t),o/1e3),i.translateByVector(this._relativePositionMatrix,r);else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(r=i.translationVector3(this._relativePositionMatrix),a=e.length3(r)+n[2]*o/1e3,a<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}this._relativePositionMatrix=i.translation4v(e.scaled3(e.normal3(r),a))}}else this._movesRelativeToObject?i.translateByVector(this._relativePositionMatrix,e.scaled3(e.mulVec3Mat4(n,i.rotation4([1,0,0],-Math.PI/2)),o/1e3)):i.translateByVector(this._relativePositionMatrix,e.scaled3(e.mulVec3Mat4(n,i.prod3x3SubOf4(t,i.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))),o/1e3));if(!this._isTransitionConfiguration){if(!this._checkConfines(s))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrix=null,!0},r.prototype.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(r.prototype.BaseOrientation),r.prototype.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(r.prototype.PointToFallback),r.prototype.copy=function(t){var e=new r(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),i.matrix4(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=i.matrix4(this._relativeOrientationMatrix),e._worldOrientationMatrix=i.matrix4(this._worldOrientationMatrix),e},r.prototype.setCamera=function(t){this._camera=t},r.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),i.setMatrix4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrix=null},r.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},r.prototype.isFPS=function(){return this._fps},r.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},r.prototype.setFollowedObjects=function(t,e){(0!==this._followedObjects.length||0!==t.length)&&(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},r.prototype.setFollowedObject=function(t,e){(1!==this._followedObjects.length||this._followedObjects[0]!==t)&&this.setFollowedObjects([t],e)},r.prototype.getFollowedObjectsPositionVector=function(){var t,i=[0,0,0];if(0===this._followedObjects.length)s.crash();else{for(t=0;t<this._followedObjects.length;t++)e.add3(i,this._followedObjects[t].getPositionVector());i=[i[0]/this._followedObjects.length,i[1]/this._followedObjects.length,i[2]/this._followedObjects.length]}return i},r.prototype.getFollowedOrientationMatrix=function(){var t;return 0===this._followedObjects.length?s.crash():t=i.matrix4(this._followedObjects[0]._orientationMatrix),t},r.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,s++;if(s>0){if(this._followedObjects.length===s)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(i.setMatrix4(this._relativeOrientationMatrix,this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,s),!1;this._followedObjects.splice(t,s)}}return!0},r.prototype._calculateWorldOrientationMatrix=function(t,n){var o,r,a,h=function(t){this._worldOrientationMatrix=i.prod3x3SubOf4(i.prod3x3SubOf4(i.rotation4([1,0,0],-Math.PI/2),this._relativeOrientationMatrix),t)}.bind(this),l=function(){this._fps?this._worldOrientationMatrix=i.prod3x3SubOf4(i.rotation4([1,0,0],-Math.PI/2),this._relativeOrientationMatrix):this._worldOrientationMatrix=i.matrix4(this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(r=e.normal3(e.diff3(this.getFollowedObjectsPositionVector(),i.translationVector3(t))),this._fps){switch(this._baseOrientation){case this.BaseOrientation.WORLD:o=null;break;case this.BaseOrientation.POSITION_FOLLOWED_OBJECTS:o=n||null;break;case this.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:o=this.followsObjects()?this.getFollowedOrientationMatrix():null;break;default:s.crash()}o?r=e.mulVec3Mat4(r,i.inverseOfRotation4(o)):o=i.IDENTITY4,this._alpha=e.angle2uCapped([0,1],e.normal2([r[0],r[1]])),r[0]<0&&(this._alpha=-this._alpha),this._worldOrientationMatrix=i.prod3x3SubOf4(i.rotation4([1,0,0],-Math.PI/2),i.rotation4([0,0,1],this._alpha)),this._beta=e.angle3uCapped(i.getRowC43Neg(this._worldOrientationMatrix),r),r[2]>0&&(this._beta=-this._beta),this._worldOrientationMatrix=i.prod3x3SubOf4(i.prod3x3SubOf4(i.rotation4([1,0,0],-Math.PI/2),i.rotation4([1,0,0],this._beta)),i.rotation4([0,0,1],this._alpha)),i.mul4(this._worldOrientationMatrix,o)}else this._worldOrientationMatrix||(this._worldOrientationMatrix=i.identity4()),this._worldOrientationMatrix[8]=r[0],this._worldOrientationMatrix[9]=r[1],this._worldOrientationMatrix[10]=r[2],a=e.cross3([1,0,0],r),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],a=e.cross3(r,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix=i.correctedOrthogonal4(this._worldOrientationMatrix);else s.crash();else h(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case this.PointToFallback.WORLD:l();break;case this.PointToFallback.STATIONARY:this._worldOrientationMatrix||(this._worldOrientationMatrix=i.identity4());break;case this.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:n?h(n):l();break;default:s.crash()}else l()},r.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrix||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},r.prototype.update=function(t,s){return!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==this.PointToFallback.STATIONARY?(this._fixed||(this._fps?(this._alpha+=t[1]*s/1e3,this._beta+=t[0]*s/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),this._relativeOrientationMatrix=i.prod3x3SubOf4(i.rotation4([1,0,0],this._beta*Math.PI/180),i.rotation4([0,0,1],this._alpha*Math.PI/180))):this._followedObjects.length>0?i.mul4(this._relativeOrientationMatrix,i.prod34(i.rotation4(e.normal3(i.getRowB43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*s/1e3),i.rotation4(e.normal3(i.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*s/1e3),i.rotation4(e.normal3(i.getRowC43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*s/1e3))):i.mul4(this._relativeOrientationMatrix,i.prod34(i.rotation4(e.normal3(i.getRowC43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*s/1e3),i.rotation4(e.normal3(i.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*s/1e3),i.rotation4(e.normal3(i.getRowB43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*s/1e3)))),this._isTransitionConfiguration||this._cleanupFollowedObjects()?(this._worldOrientationMatrix=null,!0):!1):void 0},n.makeObject3DMixinClass.call(a),a.prototype.copy=function(t,e){var s=new a(t||"",this._positionConfiguration.copy(e),this._orientationConfiguration.copy(e),this._fov,[this._minFOV,this._maxFOV],this._span,[this._minSpan,this._maxSpan]);return s.setPositionMatrix(i.matrix4(this._positionMatrix)),s.setOrientationMatrix(i.matrix4(this._orientationMatrix)),s},a.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._resetsOnFocusChange&&!e&&this.resetToDefaults(!0)},a.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},a.prototype.moveByVector=function(t,e){this._positionConfiguration.moveByVector(t,e)},a.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},a.prototype.getName=function(){return this._name},a.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},a.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},a.prototype.getFOV=function(){return this._fov},a.prototype.getMinFOV=function(){return this._minFOV},a.prototype.getMaxFOV=function(){return this._maxFOV},a.prototype.decreaseFOV=function(){return this.setFOV(this._fov*d,!0),this._fov},a.prototype.increaseFOV=function(){return this.setFOV(this._fov*g,!0),this._fov},a.prototype.setSpan=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._span=Math.min(Math.max(t,this._minSpan),this._maxSpan)},a.prototype.getSpan=function(){return this._span},a.prototype.getMinSpan=function(){return this._minSpan},a.prototype.getMaxSpan=function(){return this._maxSpan},a.prototype.decreaseSpan=function(){return this.setSpan(this._span*f,!0),this._span},a.prototype.increaseSpan=function(){
return this.setSpan(this._span*m,!0),this._span},a.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},a.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},a.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this.setSpan(this._defaultSpan,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},a.prototype.update=function(t,e,i){var s=!0;return s=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this._positionMatrix,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),s=this._positionConfiguration.update(this._orientationMatrix,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&s,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this._orientationMatrix)),s},a.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},a.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},a.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},a.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},a.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},l.prototype.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(l.prototype.TransitionStyle),l.prototype.getViewDistance=function(){return this._viewDistance},l.prototype.getNearDistance=function(){return this._near},l.prototype.getCameraPositionMatrix=function(){return this._object3D._positionMatrix},l.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},l.prototype.getCameraOrientationMatrix=function(){return this._object3D._orientationMatrix},l.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrix=null,this._inversePositionMatrix=null},l.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrix=null,this._inverseOrientationMatrix=null},l.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix(this._object3D._orientationMatrix)},l.prototype.moveToPosition=function(t,e,s){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,s),this._currentConfiguration.setRelativePositionMatrix(i.translation4v(t),!0)},l.prototype.getViewMatrix=function(){return this._viewMatrix||(this._viewMatrix=i.prodTranslationRotation4(this.getInversePositionMatrix(),this.getInverseOrientationMatrix())),this._viewMatrix},l.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrix||(this._inversePositionMatrix=i.inverseOfTranslation4(this._object3D._positionMatrix)),this._inversePositionMatrix},l.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrix||(this._inverseOrientationMatrix=i.inverseOfRotation4(this._object3D._orientationMatrix)),this._inverseOrientationMatrix},l.prototype.getConfiguration=function(){return this._currentConfiguration},l.prototype.getVelocityVector=function(){return this._velocityVector},l.prototype.getProjectionMatrix=function(){return this._projectionMatrix||this._updateProjectionMatrix(this.getFOV(),this.getSpan()),this._projectionMatrix},l.prototype._updateProjectionMatrix=function(t,e){this._near=e/2/Math.tan(Math.radians(t)/2),this._usesVerticalValues?this._projectionMatrix=i.perspective4(e*this._aspect/2,e/2,this._near,this._viewDistance):this._projectionMatrix=i.perspective4(e/2,e/this._aspect/2,this._near,this._viewDistance)},l.prototype.getAspect=function(){return this._aspect},l.prototype.setAspect=function(t){this._aspect=t,this._projectionMatrix=null},l.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},l.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrix=null},l.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrix=null},l.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrix=null},l.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},l.prototype.setSpan=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._span=t,this._currentConfiguration.setSpan(t,!0),this._projectionMatrix=null},l.prototype.decreaseSpan=function(){this._span=this._currentConfiguration.decreaseSpan(),this._projectionMatrix=null},l.prototype.increaseSpan=function(){this._span=this._currentConfiguration.increaseSpan(),this._projectionMatrix=null},l.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},l.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},l.prototype._getFreeCameraConfiguration=function(t,e,s){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),s=s||this.getCameraOrientationMatrix(),t&&(s=i.prod3x3SubOf4(i.rotation4([1,0,0],Math.PI/2),s)),h(t,e,s,this.getFOV(),this._currentConfiguration.getMinFOV(),this._currentConfiguration.getMaxFOV(),this.getSpan(),this._currentConfiguration.getMinSpan(),this._currentConfiguration.getMaxSpan())},l.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._updateFOV(),this._updateSpan(),this._updateProjectionMatrix(this._fov,this._span),this._currentConfiguration.setCamera(this,e),this._previousConfiguration=null},l.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},l.prototype.transitionToFreeCamera=function(t,e,i,s,n){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),s,n)},l.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},l.prototype.transitionToSameConfiguration=function(t,e){var i=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy("",!0),!0),this.startTransitionToConfiguration(i,t,e)},l.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},l.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},l.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},l.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},l.prototype.getFollowedNode=function(){return this._followedNode},l.prototype.moveToOrigoIfNeeded=function(t){var e=this.getCameraPositionMatrix(),s=null;return(e[12]>t||e[12]<-t||e[13]>t||e[13]<-t||e[14]>t||e[14]<-t)&&(s=[-e[12],-e[13],-e[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(i.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(s,!0)),s},l.prototype.followNode=function(t,e,i,s){var n;return e||this._followedNode!==t?(this._followedNode=t,this._followedNode?(n=this._followedNode.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,s),!0):!1):(n=this._scene.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,s),!0):!1)):!0},l.prototype.followObject=function(t,e,i,s){return this.followNode(t.getNode(),e,i,s)},l.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},l.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},l.prototype.followNextNode=function(t,e,i){for(var s=this._scene.getNextNode(this._followedNode),n=this._followedNode;s!==n&&s&&(!s.getNextCameraConfiguration()||!s.isVisible());)if(n||(n=s),s=this._scene.getNextNode(s),t&&this._followedNode&&s===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))return!0;return s&&s.getNextCameraConfiguration()&&s.isVisible()?this.followNode(s,!0,e,i):!1},l.prototype.followPreviousNode=function(t,e,i){for(var s=this._scene.getFirstNode(),n=this._scene.getPreviousNode(this._followedNode),o=this._followedNode;n!==o&&n&&(!n.getNextCameraConfiguration()||!n.isVisible());){if(o||(o=n),t&&n===s&&this.followNode(null,!0,e,i))return;n=this._scene.getPreviousNode(n)}n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)},l.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},l.prototype._getTransitionProgress=function(){var t;if(0===this._transitionDuration)return 0;switch(this._transitionStyle){case this.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case this.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t;default:s.crash()}return-1},l.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV()},l.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},l.prototype.update=function(t){var s,n,o,r,a,h;if(this._extendedCamera=null,this._combinedExtendedCamera=null,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),h=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);s=this._previousConfiguration.getPositionVector(),n=this._currentConfiguration.getPositionVector(),o=this.getCameraPositionVector(),this._setPositionMatrix(i.translation4v(e.sum3(e.scaled3(s,1-h),e.scaled3(n,h)))),this._velocityVector=e.scaled3(e.mulMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t),r=i.prod3x3SubOf4(i.inverseOfRotation4(this._previousConfiguration._orientationMatrix),this._currentConfiguration._orientationMatrix),a=i.getRotations(r),this._setOrientationMatrix(i.identity4()),this._rotate(a.gammaAxis,a.gamma*h),this._rotate(a.alphaAxis,a.alpha*h),this._setOrientationMatrix(i.correctedOrthogonal4(i.prod3x3SubOf4(this._previousConfiguration._orientationMatrix,this.getCameraOrientationMatrix()))),this._updateFOV(h),this._updateSpan(h),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);o=this.getCameraPositionVector(),this._setPositionMatrix(this._currentConfiguration._positionMatrix),this._setOrientationMatrix(this._currentConfiguration._orientationMatrix),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?this._velocityVector=e.scaled3(e.mulMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),1e3/t):this._velocityVector=[0,0,0],this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):this._velocityVector=e.scaled3(e.mulMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t)}},l.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCamera?this._extendedCamera:t&&this._combinedExtendedCamera?this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=new l(this._scene,this._aspect,this._usesVerticalValues,this._viewDistance*y,h(!1,this._object3D._positionMatrix,this._object3D._orientationMatrix,this._fov,this._fov,this._fov,e,e,e)),i.update(0),t?this._combinedExtendedCamera=i:this._extendedCamera=i,i)},{CameraPositionConfiguration:o,CameraOrientationConfiguration:r,CameraConfiguration:a,Camera:l,getFreeCameraConfiguration:h}}),define("modules/scene/renderable-objects",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/scene/object-3d"],function(t,e,i,s,n,o){"use strict";function r(e){switch(e){case t.ScaleMode.WIDTH:return 0;case t.ScaleMode.HEIGHT:return 1;case t.ScaleMode.ASPECT:return 2;case t.ScaleMode.MINIMUM:return 3;case t.ScaleMode.MAXIMUM:return 4;default:s.crash()}}function a(t,e,i,s,n){this._node=null,this._wasRendered=!1,this._shader=t,this._textures={},this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e?!0:e,this._isRenderedWithoutDepthMask=void 0===i?!0:i,this._instancedShader=s||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0!==n?n:!0,this._wasRenderedToShadowMap=!1,this._name=null}function h(t,e,i,s,n,r,h,l){a.call(this,t,e,i,h),o.Object3D.call(this,s,n,r,l),this._visibleSize={width:-1,height:-1},this._insideShadowCastFrustum=null,this._smallestSizeWhenDrawn=0}function l(t,e,s,n,o){a.call(this,e,!1,!0),this._model=t,this._samplerName=s,this._camera=o,this.setTexture(s,n),this.setUniformValueFunction(b,function(){return i.inverse4(i.prod4(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function u(t,e,s,n,o,r,a,l){h.call(this,e,!0,!0,n,o,r),this.setSmallestSizeWhenDrawn(5),this.setTextures(s),this._model=t,this._wireframe=a===!0,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==l?l:this.LOD_NOT_SET,this.setUniformValueFunction(M,function(){return this.getModelMatrix()}),this.setUniformValueFunction(O,function(){return i.transposed3(i.inverse3(i.matrix3from4(this.getModelMatrix())))})}function c(t,e,i,o,r,a,h,l,c){var _,p,d,g,f;for(u.call(this,t,e,i,o,r,a,h,l),this._parameterArrays={},f=Object.keys(c),_=0;_<f.length;_++)if(d=n.getUniformName(f[_]),g=e.getUniformArrayLength(d),g>0){switch(c[f[_]]){case n.ShaderVariableType.FLOAT:break;case n.ShaderVariableType.MAT4:g*=16;break;default:s.showError("Cannot create uniform parameter array with elements of type: '"+c[f[_]]+"'!")}for(this._parameterArrays[f[_]]=new Float32Array(g),p=0;g>p;p++)this._parameterArrays[f[_]][p]=0;this.setUniformValueFunction(f[_],this.createGetParameterArrayFunction(f[_]))}else s.log("Note: cannot initialize parameter array '"+f[_]+"' for parameterized mesh, as the given shader ("+e.getName()+") does not have a uniform array named '"+d+"'.",2),this._parameterArrays[f[_]]=new Float32Array}function _(t,e,i,s,n,o,r,a){h.call(this),this._model=null,this._wireframe=!1,t&&this.init(t,e,i,s,n,o,r,a)}function p(t,e,i){this.color=t,this.size=e,this.timeToReach=i}function d(t,e,i,s,n,o,r,a){h.call(this),this.setSmallestSizeWhenDrawn(.1),this._model=t,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._calculatedSize=[0],this._positionVector=[0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._shouldAnimate=!1,this._duration=0,t&&this.init(t,e,i,s,n,o,r,a)}function g(t,e,i,s,n,o,r,a,h){t.init(e,i,s,r,[new p(n,o,0),new p(n,0,a)],!1,h)}function f(t,e,i,s,n,o,r,a){var h=new d;return g(h,t,e,i,s,n,o,r,a),h}function m(t,e,i,s,n,o,r){return new d(t,e,i,o,[new p(s,n,0)],!1,r)}function y(t,s,n,o,r,a,h){var l,u,c,_;d.call(this,t,s,n,a,[new p(o,r,0)],!1),_=[0,1],e.rotate2(_,h),l=[_[0],0,_[1]],u=e.normal3(i.translationVector3(a)),c=e.getYawAndPitch(u),_=[0,_[1]],e.rotate2(_,c.pitch),l=[l[0],_[0],_[1]],_=[l[0],_[0]],e.rotate2(_,c.yaw),l=[_[0],_[1],l[2]],this.setOrientationMatrix(i.lookTowards4(e.scaled3(u,-1),l)),this.setUniformValueFunction(M,function(){return this.getModelMatrix()})}function S(t,i,s,n,o,r){a.call(this,i,!1,!0,s),this._positionVector=n,this._model=t,this._color=o,this._range=r,this._shift=[0,0,0],this.setUniformValueFunction(v,function(){return this._positionVector}),this._color&&(this.setUniformValueFunction(x,function(){return this._color}),this.setUniformValueFunction(R,function(){return this._shift}),this.setUniformValueFunction(C,function(){return e.length3(this._shift)}),this.setUniformValueFunction(I,function(){return this._range}))}function T(t,e,s,n,o,h,l,u,c,_){a.call(this,e,!1,!0),this.setTextures(s),this._model=t,this._position=n,this._color=l,this._size=o,this._scaleMode=r(h),this._rotationMatrix=i.rotation2(Math.radians(u||0)),this._clipCoordinates=c||B.slice(),this._clipColor=_||[0,0,0,0],this.setUniformValueFunction(v,function(){return this._position}),this.setUniformValueFunction(L,function(){return this._size}),this.setUniformValueFunction(D,function(){return this._scaleMode}),this.setUniformValueFunction(x,function(){return this._color}),this.setUniformValueFunction(w,function(){return this._rotationMatrix}),this.setUniformValueFunction(F,function(){return this._clipCoordinates}),this.setUniformValueFunction(P,function(){return this._clipColor})}var E={NONE:0,FRONT_QUEUE_BIT:1,DISTANCE_QUEUE_BIT:2},b="viewDirectionProjectionInverse",M="modelMatrix",O="normalMatrix",A="billboardSize",x="color",R="shift",C="length",I="farthestZ",v="position",N="direction",L="size",D="scaleMode",w="rotationMatrix",F="clipCoords",P="clipColor",V=0,U=.01,B=[0,1,0,1];return a.prototype.getNode=function(){return this._node},a.prototype.setNode=function(t){this._node=t},a.prototype.getShader=function(){return this._shader},a.prototype.setShader=function(t){this._shader=t},a.prototype.setInstancedShader=function(t){this._instancedShader=t},a.prototype.setTexture=function(t,e){this._textures[t]=e},a.prototype.setTextures=function(t){this._textures=t},a.prototype.isRenderedWithoutDepthMask=function(){return this._isRenderedWithoutDepthMask},a.prototype.isRenderedWithDepthMask=function(){return this._isRenderedWithDepthMask},a.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[n.getUniformName(t)]=e.bind(i||this)},a.prototype.setName=function(t){this._name=t},a.prototype.getName=function(){return this._name},a.prototype.createTextureLocationGetter=function(t,e){var i=e.getName();return function(){return this._textures[t].getLastTextureBindLocation(i)}.bind(this)},a.prototype.addToContext=function(t){var e;this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader);for(e in this._textures)this._textures.hasOwnProperty(e)&&(t.addTexture(this._textures[e]),this._textures[e]instanceof n.ManagedTexture?this.setUniformValueFunction(n.getTextureUniformRawName(e),this.createTextureLocationGetter(e,t)):this._textures[e]instanceof n.ManagedCubemap?this.setUniformValueFunction(n.getCubemapUniformRawName(e),this.createTextureLocationGetter(e,t)):s.showError("Attemtping to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context."))},a.prototype.bindTextures=function(t){var e;for(e in this._textures)this._textures.hasOwnProperty(e)&&t.bindTexture(this._textures[e])},a.prototype.markAsReusable=function(){this._canBeReused=!0},a.prototype.canBeReused=function(){return this._canBeReused},a.prototype.isVisible=function(){return this._visible&&(!this._node||this._node.isVisible())},a.prototype.resetForNewFrame=function(){this._wasRendered=!1,this._wasRenderedToShadowMap=!1},a.prototype.getRenderQueueBits=function(){return this._visible?E.FRONT_QUEUE_BIT:E.NONE},a.prototype.prepareForInstancedRender=function(t,e,i,s){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),t.getCurrentShader()===this._instancedShader&&(this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,s))},a.prototype.shouldBeRendered=function(t){return this._canBeReused!==!0&&this._visible?t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask:!1},a.prototype.prepareForRender=function(t){t.useInstancing&&t.context.getCurrentShader()===this._instancedShader?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),t.context.getCurrentShader()===this._shader&&(this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions)))},a.prototype.performRender=function(){return!0},a.prototype.finishRender=function(){this._wasRendered=!0},a.prototype.render=function(t){return this.shouldBeRendered(t)?(this.prepareForRender(t),t.useInstancing||this.performRender(t),this.finishRender(t),!0):!1},a.prototype._peformRenderInstances=function(t,e){s.showError("Cannot render "+e+" instances of "+this.constructor.name+" to "+t.getName()+" in instanced mode, because no instanced render method was defined for it!")},a.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},a.prototype.shouldBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},a.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},a.prototype.prepareForRenderToShadowMap=function(){return!0},a.prototype.performRenderToShadowMap=function(){return!0},a.prototype.renderToShadowMap=function(t){return this.shouldBeRenderedToShadowMap(t)?(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},a.prototype.shouldAnimate=function(t){return t>0},a.prototype.performAnimate=function(){return!0},a.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},a.prototype.wasRendered=function(){return this._wasRendered},a.prototype.getNumberOfDrawnTriangles=function(){return 0},a.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},a.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},h.prototype=new a,o.makeObject3DMixinClass.call(h),h.prototype.constructor=a,h.prototype.setSmallestSizeWhenDrawn=function(t){this._smallestSizeWhenDrawn=t},h.prototype.getVisibleSize=function(t){return this._visibleSize.width<0&&(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSize},h.prototype.isInsideViewFrustum=function(t){return this.getVisibleSize(t).width>0},h.prototype.getSizeInPixels=function(t){return this.getVisibleSize(t),this._visibleSize.width<0&&s.showError("Attempting to access the size of an object on the screen in pixels, before the size has been calculated."),Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},h.prototype.resetForNewFrame=function(){a.prototype.resetForNewFrame.call(this),h.prototype.resetCachedValues.call(this),this._visibleSize.width=-1,this._visibleSize.height=-1,this._insideShadowCastFrustum=null},h.prototype.getRenderQueueBits=function(t){var e,i,s,n=E.NONE;return e=this.getPositionMatrixInCameraSpace(t),i=this.getCascadeScalingMatrix(),s=this.getSize()*i[0],e[14]-s<=-t.getNearDistance()&&e[14]+s>-t.getViewDistance()&&(n|=E.FRONT_QUEUE_BIT),e[14]-s<=-t.getViewDistance()&&e[14]+s>-t.getExtendedCamera().getViewDistance()&&(n|=E.DISTANCE_QUEUE_BIT),n},h.prototype.shouldBeRendered=function(t){var e,i;return a.prototype.shouldBeRendered.call(this,t)?this.isInsideParent()===!0?void 0===t.parent.isInsideViewFrustum||t.parent.isInsideViewFrustum(t)?(e=t.parent.getVisibleSize(t),i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:!0):(this._visibleSize.width=0,this._visibleSize.height=0,!1):(e=this.getVisibleSize(t),this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:this.isInsideViewFrustum(t)):!1},h.prototype.shouldBeRenderedToShadowMap=function(t){return a.prototype.shouldBeRenderedToShadowMap.call(this,t)?this.isInsideParent()===!0?t.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(t.lightMatrix,t.shadowMapRange,t.shadowMapDepthRatio):!1},l.prototype=new a,l.prototype.constructor=l,l.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},l.prototype.performRender=function(t){this._model.render(t.context,!1)},l.prototype.getNumberOfDrawnTriangles=function(){return 2},u.prototype=new h,u.prototype.constructor=u,u.prototype.LOD_NOT_SET=-1,u.prototype.addToContext=function(t){var e;for(h.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe),e=this._model.getMinLOD();e<=this._model.getMaxLOD();e++)this._model.getSize(e)>this._modelSize&&(this._modelSize=this._model.getSize(e))},u.prototype.getModel=function(){return this._model},u.prototype.getSize=function(){return this._modelSize},u.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},u.prototype.getHeight=function(){return this._model.getHeight()},u.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},u.prototype.getMaxY=function(){return this._model.getMaxY()},u.prototype.getCurrentLOD=function(t){var e,i,s;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else{if(!t)return this.LOD_NOT_SET;if(e=this.getSizeInPixels(t),i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e,i>0)for(s=Math.min(this._model.getMaxLOD(),t.lodContext.maxEnabledLOD);s>=this._model.getMinLOD();s--)if(t.lodContext.thresholds[s]<=i){this._currentLOD=s;break}}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:V},u.prototype.setStaticLOD=function(t){this._staticLOD=t,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET},u.prototype.resetForNewFrame=function(){h.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},u.prototype.shouldBeRendered=function(t){if(h.prototype.shouldBeRendered.call(this,t)){if(this._wireframe===!0)return!0;if(t.depthMask===!0){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(t.depthMask===!1&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},u.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},u.prototype.shouldBeRenderedToShadowMap=function(t){return h.prototype.shouldBeRenderedToShadowMap.call(this,t)?this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0:void 0},u.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},u.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t)),s.log_DEBUG("Rendered model ("+this._model.getName()+") to shadow map.",5)},u.prototype.getNumberOfDrawnTriangles=function(t){return this._wireframe===!1&&this._currentLOD!==this.LOD_NOT_SET?this._model.getNumTriangles(this._currentLOD,t):0},c.prototype=new u([]),c.prototype.constructor=c,c.prototype.createGetParameterArrayFunction=function(t){return function(){return this._parameterArrays[t]}},c.prototype.setFloatParameter=function(t,e,i){this._parameterArrays[t][e]=i},c.prototype.setMat4Parameter=function(t,e,i){var s;for(s=0;16>s;s++)this._parameterArrays[t][16*e+s]=i[s]},_.prototype=new h,_.prototype.constructor=_,_.prototype.init=function(t,e,s,n,o,r,a,l){var u=[n];h.call(this,e,!1,!0,r,a,i.scaling4(n),l),this.setTextures(s),this._model=t,this._wireframe=o===!0,this._wireframe&&(this._isRenderedWithDepthMask=!1),this.setUniformValueFunction(M,function(){return this.getModelMatrix()}),this.setUniformValueFunction(v,function(){return this.getPositionVector()}),this.setUniformValueFunction(N,function(){return i.getRowB43(this._orientationMatrix)}),this.setUniformValueFunction(L,function(t){return t?u:n})},_.prototype.getModel=function(){return this._model},_.prototype.getCurrentLOD=function(){return 0},_.prototype.addToContext=function(t){h.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},_.prototype.isInsideViewFrustum=function(){return!0},_.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},_.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},_.prototype.shouldBeRenderedToShadowMap=function(){return!1},_.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?this._model.getNumTriangles():0},_.prototype.shouldGoInSameRenderQueueInstanced=function(t){return h.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},d.prototype=new h,d.prototype.constructor=d,d.prototype.init=function(t,e,s,n,o,r,a,l){var u,c;if(h.call(this,e,!1,!0,n,i.IDENTITY4,i.IDENTITY4,a),this.setTextures(s),this._model=t,o)for(u=0;u<o[0].color.length;u++)this._color[u]=o[0].color[u];this._size=void 0!==l?l:o?o[0].size:0,this._relativeSize=1,this._calculateSize(),this._states=o||[],this._calculateDuration(),this._currentStateIndex=0,this._looping=r===!0,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._shouldAnimate=!1,this.setUniformValueFunction(v,function(){return c=this.getModelMatrix(),this._positionVector[0]=c[12],this._positionVector[1]=c[13],this._positionVector[2]=c[14],this._positionVector}),this.setUniformValueFunction(A,function(t){
return t?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(x,function(){return this._color}),this._updateShouldAnimate()},d.prototype._calculateDuration=function(){var t;if(this._states.length<=1)return 0;for(this._duration=0,t=0;t<this._states.length;t++)this._duration+=this._states[t].timeToReach},d.prototype._calculateSize=function(){this._calculatedSize[0]=this._size*this._relativeSize,this._visible=this._calculatedSize[0]>=U},d.prototype.getDuration=function(){return this._duration},d.prototype.getSize=function(){return this._calculatedSize[0]},d.prototype.getFinalSize=function(){return 0===this._states.length?this._size:this._states[this._states.length-1].size},d.prototype.getMaxSize=function(){var t,e;if(0===this._states.length)return this._size;for(t=0,e=0;e<this._states.length;e++)this._states[e].size>t&&(t=this._states[e].size);return t},d.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},d.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},d.prototype.getRelativeSize=function(){return this._relativeSize},d.prototype.setRelativeSize=function(t){this._relativeSize=t,this._calculateSize()},d.prototype.getVelocityVector=function(){return this._velocityMatrix},d.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateShouldAnimate()},d.prototype.getStates=function(){return this._states},d.prototype.setAnimationTime=function(t){this._currentStateIndex=0,this._timeSinceLastTransition=0,this.performAnimate(t)},d.prototype.addToContext=function(t){h.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},d.prototype.isInsideViewFrustum=function(){return this._parent&&this.isInsideParent()?this._parent.isInsideViewFrustum():!0},d.prototype.getRenderQueueBits=function(t){return this._visible?h.prototype.getRenderQueueBits.call(this,t):E.NONE},d.prototype.shouldBeRendered=function(t){return this._visible?h.prototype.shouldBeRendered.call(this,t):!1},d.prototype.performRender=function(t){this._model.render(t.context,!1)},d.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},d.prototype.shouldBeRenderedToShadowMap=function(){return!1},d.prototype.shouldAnimate=function(t){return h.prototype.shouldAnimate.call(this,t)?this._shouldAnimate:!1},d.prototype.performAnimate=function(t){var i,s,n;if(this._states.length>1){for(this._timeSinceLastTransition+=t,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping)return this._size=0,void this.markAsReusable();this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}for(this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,n=0;n<this._color.length;n++)this._color[n]=this._states[this._currentStateIndex].color[n]*(1-s)+this._states[i].color[n]*s;this._size=this._states[this._currentStateIndex].size*(1-s)+this._states[i].size*s,this._calculateSize()}this._hasVelocity()&&this.translatev(e.scaled3(this._velocityVector,t/1e3))},d.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?2:0},d.prototype.shouldGoInSameRenderQueueInstanced=function(t){return h.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},y.prototype=new d,y.prototype.constructor=y,y.prototype.isInsideViewFrustum=function(){return!0},y.prototype.shouldBeRendered=function(t){return a.prototype.shouldBeRendered.call(this,t)},S.prototype=new a,S.prototype.constructor=S,S.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},S.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},S.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;3>i;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},S.prototype.performRender=function(t){this._model.render(t.context,!0)},S.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},S.prototype.shouldBeRenderedToShadowMap=function(){return!1},S.prototype.shouldAnimate=function(){return!1},S.prototype.shouldGoInSameRenderQueueInstanced=function(t){return a.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},T.prototype=new a,T.prototype.constructor=T,T.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},T.prototype.performRender=function(t){this._model.render(t.context)},T.prototype.setPosition=function(t){this._position=t},T.prototype.setSize=function(t){this._size=t},T.prototype.setColor=function(t){this._color=t},T.prototype.setAngle=function(t){this._rotationMatrix=i.rotation2(t)},T.prototype.setClipCoordinates=function(t){this._clipCoordinates=t},T.prototype.clipX=function(t,e){this._clipCoordinates[0]=t,this._clipCoordinates[1]=e},T.prototype.clipY=function(t,e){this._clipCoordinates[2]=1-e,this._clipCoordinates[3]=1-t},T.prototype.setClipColor=function(t){this._clipColor=t},T.prototype.setModel=function(t){this._model=t},{RenderQueueBits:E,UNIFORM_COLOR_NAME:x,CLIP_COORDINATES_NO_CLIP:B,RenderableObject:a,RenderableObject3D:h,CubemapSampledFVQ:l,ShadedLODMesh:u,ParameterizedMesh:c,Billboard:_,ParticleState:p,Particle:d,staticParticle:m,initDynamicParticle:g,dynamicParticle:f,BackgroundBillboard:y,PointParticle:S,UIElement:T}}),define("modules/scene/lights",["utils/vectors","utils/matrices","modules/managed-gl"],function(t,e,i){"use strict";function s(i,s){this._color=i,this._direction=t.normal3(s),this._orientationMatrix=e.inverseOfRotation4(e.lookTowards4(this._direction)),this._baseMatrix=null,this._translationVector=null,this._translatedMatrix=null,this._shadowMapBufferNamePrefix=null}function n(t,e,i,s,n,o){this._color=t,this._objectIntensity=e,this._relativePositionVector=i,this._emittingObjects=s,this._totalIntensity=e*(s?s.length:1),this._positionVector=null,this._states=n,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=o,this._uniformColor=null,t&&this._updateUniformColor()}function o(t,e,i,s,o,r,a,h,l){n.call(this,t,e,i,a,h,l),this._relativeSpotDirection=s,this._spotCutoffCosine=Math.cos(Math.radians(o)),this._spotFullIntensityCosine=o>r?Math.cos(Math.radians(r)):0,this._spotDirection=null}var r="lightMatrix",a="shadowMapDepth",h="projMatrix";return s.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},s.prototype.addToContext=function(t,e,s,n,o){var r;if(this._shadowMapBufferNamePrefix=s,e)for(r=0;n>r;r++)t.getFrameBuffer(this.getShadowMapBufferName(r))||t.addFrameBuffer(new i.FrameBuffer(this.getShadowMapBufferName(r),o,o,!0))},s.prototype.reset=function(){this._baseMatrix=null,this._translationVector=null,this._translatedMatrix=null},s.prototype.getTranslatedMatrix=function(){return this._translatedMatrix},s.prototype.startShadowMap=function(s,n,o,l,u,c){var _={};s.setCurrentFrameBuffer(this.getShadowMapBufferName(o)),this._translatedMatrix=e.prodTranslationRotation4(e.translatedByVector(n.getInversePositionMatrix(),t.scaled3(e.getRowC43(n.getCameraOrientationMatrix()),c)),this._orientationMatrix),this._baseMatrix=this._baseMatrix||e.prodTranslationRotation4(n.getInversePositionMatrix(),this._orientationMatrix),this._translationVector=this._translationVector||t.normal3(t.diff3(e.translationVector3(this._translatedMatrix),e.translationVector3(this._baseMatrix))),_[i.getUniformName(r)]=function(){return this._translatedMatrix}.bind(this),_[i.getUniformName(a)]=function(){return u},_[i.getUniformName(h)]=function(){return e.orthographic4(l,l,-u,u)},s.getCurrentShader().assignUniforms(s,_)},s.prototype.getUniformData=function(){return{color:this._color,direction:this._direction,matrix:this._baseMatrix||e.IDENTITY4,translationVector:this._translationVector||t.NULL3}},n.prototype._updateUniformColor=function(){this._uniformColor=this._color.concat(this._totalIntensity)},n.prototype.updateState=function(e){var i,s;if(this._states&&this._states.length>1&&e>0){for(this._timeSinceLastTransition+=e,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping){i=this._states.length-1,this._timeSinceLastTransition=this._states[i].timeToReach;break}this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,this.setObjectIntensity(this._states[this._currentStateIndex].intensity*(1-s)+this._states[i].intensity*s),this.setColor(t.sum3(t.scaled3(this._states[this._currentStateIndex].color,1-s),t.scaled3(this._states[i].color,s)))}},n.prototype.update=function(i){var s,n,o=this._totalIntensity;if(this.updateState(i),this._emittingObjects)if(1===this._emittingObjects.length)this._emittingObjects[0].isVisible()?(this._totalIntensity=this._objectIntensity,this._positionVector=t.sum3(this._emittingObjects[0].getPositionVector(),t.mulVec3Mat4(this._relativePositionVector,e.prod3x3SubOf4(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0]._orientationMatrix)))):this._totalIntensity=0;else{for(this._positionVector=[0,0,0],n=0,s=0;s<this._emittingObjects.length;s++)this._emittingObjects[s]&&!this._emittingObjects[s].canBeReused()&&this._emittingObjects[s].isVisible()&&(t.add3(this._positionVector,this._emittingObjects[s].getPositionVector()),n++);n>0&&(this._positionVector[0]/=n,this._positionVector[1]/=n,this._positionVector[2]/=n),this._totalIntensity=this._objectIntensity*n}else this._totalIntensity=this._objectIntensity,this._positionVector=this._relativePositionVector;this._totalIntensity!==o&&this._updateUniformColor()},n.prototype.getUniformData=function(){return{color:this._uniformColor,position:this._positionVector}},n.prototype.canBeReused=function(){var t;if(!this._emittingObjects)return!1;for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},n.prototype.setColor=function(t){this._color=t,this._updateUniformColor()},n.prototype.setObjectIntensity=function(t){this._objectIntensity=t},n.prototype.addEmittingObject=function(t){this._emittingObjects.push(t)},n.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._totalIntensity>0&&this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._totalIntensity},n.prototype.setAnimationTime=function(t){this._timeSinceLastTransition=0,this._currentStateIndex=0,this.updateState(t)},o.prototype=new n,o.prototype.constructor=o,o.prototype.setSpotDirection=function(t){this._relativeSpotDirection=t},o.prototype.setSpotCutoffAngle=function(t){this._spotCutoffCosine=Math.cos(Math.radians(t))},o.prototype.update=function(e){n.prototype.update.call(this,e),this._emittingObjects&&1===this._emittingObjects.length?this._spotDirection=t.mulVec3Mat4(this._relativeSpotDirection,this._emittingObjects[0]._orientationMatrix):this._spotDirection=this._relativeSpotDirection},o.prototype.getUniformData=function(){return{color:this._uniformColor,spot:[this._spotDirection[0],this._spotDirection[1],this._spotDirection[2],this._spotCutoffCosine],position:this._positionVector.concat(this._spotFullIntensityCosine)}},{UNIFORM_PROJECTION_MATRIX_NAME:h,DirectionalLightSource:s,PointLightSource:n,SpotLightSource:o}}),define("modules/scene/scene-graph",["utils/types","utils/matrices","modules/application","modules/managed-gl","modules/scene/camera","modules/scene/renderable-objects","modules/scene/lights"],function(t,e,i,s,n,o,r){"use strict";function a(){return G}function h(t,e,i,s,n){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=i===!0,this.referenceSize=s||_,this.minimumRelativeSize=n||p}function l(t,e,i,s,n,o,r,a,h,l,u,c,_,p){this.context=t,this.depthMask=e,this.scene=i,this.parent=s,this.camera=n,this.viewportWidth=o,this.viewportHeight=r,this.lodContext=a,this.dt=h||0,this.useInstancing=l||!1,this.instanceQueueIndex=u,this.lightMatrix=c,this.shadowMapRange=_,this.shadowMapDepthRatio=p}function u(t,e,i){this._renderableObject=t,t.setNode(this),this._scene=null,this._parent=null,this._subnodes=[],this._visible=!0,this._renderParameters=new l,this._cameraConfigurations=[],this._hasInstancedSubnodes=e,this._minimumCountForInstancing=i||0,this._canBeReused=!1}function c(t,i,s,o,r,a,h,l,u,c,_,p,d){this._left=t,this._bottom=i,this._width=s,this._height=o,this._shouldClearColorOnRender=r,this._clearColorMask=a,this._clearColor=h,this._shouldClearDepthOnRender=l,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._directionalLights=[],this._directionalLightUniformData=[],this._maxRenderedDirectionalLights=c||0,this._pointLightPriorityArrays=null,this._pointLightUniformData=[],this._maxRenderedPointLights=_||0,this._spotLights=[],this._spotLightUniformData=[],this._maxRenderedSpotLights=p||0,this._rootResourceNode=null,this._resourceObjectIDs=null,this._camera=new n.Camera(this,this._width/this._height,d.useVerticalValues,d.viewDistance,d.configuration||n.getFreeCameraConfiguration(d.fps,d.positionMatrix||e.IDENTITY4,d.orientationMatrix||e.IDENTITY4,d.fov,d.fovRange&&d.fovRange[0]||d.fov,d.fovRange&&d.fovRange[1]||d.fov,d.span,d.spanRange&&d.spanRange[0]||d.span,d.spanRange&&d.spanRange[1]||d.span),d.transitionDuration,d.transitionStyle),this._lodContext=u,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._contextUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._numDrawnTriangles=0,this._contexts=[],this._renderQueues=[],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=null,this.clearNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var _=100,p=.05,d="shadow-map-buffer-",g="-",f=5,m="numDirLights",y="dirLights",S="numPointLights",T="pointLights",E="numSpotLights",b="spotLights",M="cameraMatrix",O="viewProjMatrix",A="cameraOrientationMatrix",x="aspect",R="viewportSize",C="eyePos",I="numRanges",v="shadowMapRanges",N="shadowMapDepthRatio",L="shadowMapTextureSize",D="shadowMaps",w="shadowMapSampleOffsets",F=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],P=0,V=1,U=2,B=3,j=[!0,!0,!0,!0],G="";return u.prototype.canBeReused=function(){var t;if(this._canBeReused)return!0;if(this._renderableObject.canBeReused()){for(t=0;t<this._subnodes.length;t++)if(this._subnodes[t].canBeReused()===!1)return!1;return this._canBeReused=!0,!0}return!1},u.prototype.getScene=function(){return this._scene},u.prototype.setScene=function(t){var e;for(this._scene=t,t&&t.addObjectToContexts(this._renderableObject),e=0;e<this._subnodes.length;e++)this._subnodes[e].setScene(t)},u.prototype.addToRenderQueue=function(t){var e;if(0===this._minimumCountForInstancing){for(e=0;e<t.length;e++)if(t[e].length>0&&0===t[e][0].getMinimumCountForInstancing()&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0].getMinimumCountForInstancing()>0&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),e;return t.push([this]),t.length-1},u.prototype.animateAndAddToRenderQueues=function(t,e,i){var s,n,r,a,h;if(this._visible&&(this._scene.shouldAnimate()&&this._renderableObject.animate(i),a=this._renderableObject.isRenderedWithoutDepthMask(),h=this._renderableObject.isRenderedWithDepthMask(),(a||h)&&(s=this._renderableObject.getRenderQueueBits(e),s&o.RenderQueueBits.FRONT_QUEUE_BIT&&(a&&this.addToRenderQueue(t[V]),h&&this.addToRenderQueue(t[P])),s&o.RenderQueueBits.DISTANCE_QUEUE_BIT&&(a&&this.addToRenderQueue(t[B]),h&&this.addToRenderQueue(t[U]))),this._subnodes.length>0))if(!this._hasInstancedSubnodes||this._subnodes.length<this._subnodes[0].getMinimumCountForInstancing())for(n=0;n<this._subnodes.length;n++)this._subnodes[n].animateAndAddToRenderQueues(t,e,i);else{if(this._scene.shouldAnimate())for(n=0;n<this._subnodes.length;n++)this._subnodes[n]._renderableObject.animate(i);a=this._subnodes[0]._renderableObject.isRenderedWithoutDepthMask(),h=this._subnodes[0]._renderableObject.isRenderedWithDepthMask(),(a||h)&&(s=this._subnodes[0]._renderableObject.getRenderQueueBits(e),s&o.RenderQueueBits.FRONT_QUEUE_BIT&&(a&&(r=this._subnodes[0].addToRenderQueue(t[V]),t[V][r].pop(),t[V][r]=t[V][r].concat(this._subnodes)),h&&(r=this._subnodes[0].addToRenderQueue(t[P]),t[P][r].pop(),t[P][r]=t[P][r].concat(this._subnodes))),s&o.RenderQueueBits.DISTANCE_QUEUE_BIT&&(a&&(r=this._subnodes[0].addToRenderQueue(t[B]),t[B][r].pop(),t[B][r]=t[B][r].concat(this._subnodes)),h&&(r=this._subnodes[0].addToRenderQueue(t[U]),t[U][r].pop(),t[U][r]=t[U][r].concat(this._subnodes))))}},u.prototype.getParent=function(){return this._parent},u.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},u.prototype.getRenderableObject=function(){return this._renderableObject},u.prototype.isVisible=function(){return this._visible&&(!this._parent||this._parent.isVisible())},u.prototype.show=function(){this._visible=!0},u.prototype.hide=function(){this._visible=!1},u.prototype.toggleVisibility=function(){this._visible=!this._visible},u.prototype.addSubnode=function(t){return this._subnodes.push(t),t.setParent(this),this._scene&&t.setScene(this._scene),t},u.prototype.getSubnodes=function(){return this._subnodes},u.prototype.getFirstSubnode=function(){return this._subnodes[0]},u.prototype.getNextSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return e===this._subnodes.length-1?this._subnodes[0]:this._subnodes[e+1];return this._subnodes[0]},u.prototype.getPreviousSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return 0===e?this._subnodes[this._subnodes.length-1]:this._subnodes[e-1];return this._subnodes[this._subnodes.length-1]},u.prototype.addCameraConfiguration=function(t){this._cameraConfigurations.push(t)},u.prototype.hasCameraConfiguration=function(t){var e;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},u.prototype.getNextCameraConfiguration=function(t){var e,s,n=this._cameraConfigurations.length;if(0>=n)return null;if(t){for(e=0;n>e;e++)if(this._cameraConfigurations[e]===t){s=e;break}if(e>=n)return void i.crash()}else s=-1;for(e=(s+1)%n;e!==s&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+1)%n;return this._cameraConfigurations[e]},u.prototype.getPreviousCameraConfiguration=function(t){var e,s,n=this._cameraConfigurations.length;if(0>=n)return null;if(t){for(e=n-1;e>=0;e--)if(this._cameraConfigurations[e]===t){s=e;break}if(0>e)return void i.crash()}else s=n;for(e=(s+n-1)%n;e!==s&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+n-1)%n;return this._cameraConfigurations[e]},u.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e].getName()===t&&i.push(this._cameraConfigurations[e]);return i},u.prototype.resetCameraConfigurations=function(){var t;for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},u.prototype.resetForNewFrame=function(){var t;for(this._renderableObject.resetForNewFrame(),t=0;t<this._subnodes.length;t++)this._subnodes[t].resetForNewFrame()},u.prototype.setRenderParameters=function(t,e,i,s,n,o,r,a,h){this._renderParameters.context=t,this._renderParameters.depthMask=s,this._renderParameters.scene=this._scene,this._renderParameters.parent=this._parent?this._parent._renderableObject:null,this._renderParameters.camera=this._scene.getCamera(),this._renderParameters.viewportWidth=e,this._renderParameters.viewportHeight=i,this._renderParameters.lodContext=this._scene.getLODContext(),this._renderParameters.useInstancing=n,this._renderParameters.instanceQueueIndex=o,this._renderParameters.lightMatrix=r,this._renderParameters.shadowMapRange=a,this._renderParameters.shadowMapDepthRatio=h},u.prototype.render=function(t,e,i,s,n,o,r){var a,h;if(this._visible){if(this.setRenderParameters(t,e,i,s,o,r),h=this._renderableObject.render(this._renderParameters),!n)for(a=0;a<this._subnodes.length;a++)this._subnodes[a].render(t,e,i,s,o,r);return h}return!1},u.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},u.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},u.prototype.renderToShadowMap=function(t,e,i,s,n,o){var r,a;if(this._visible){for(this.setRenderParameters(t,e,i,!0,void 0,void 0,s,n,o),a=this._renderableObject.renderToShadowMap(this._renderParameters),r=0;r<this._subnodes.length;r++)this._subnodes[r].renderToShadowMap(t,e,i,s,n,o);return a}return!1},u.prototype.execute=function(t){var e;for(t(this._renderableObject),e=0;e<this._subnodes.length;e++)this._subnodes[e].execute(t)},u.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].addToContext(t)},u.prototype.getShader=function(){return this._renderableObject.getShader()},u.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].setShader(t)},u.prototype.markAsReusable=function(){var t;for(this._renderableObject.markAsReusable(),t=0;t<this._subnodes.length;t++)this._subnodes[t].markAsReusable();this._canBeReused=!0},u.prototype.cleanUp=function(){var t,e,i;for(t=0;t<this._subnodes.length;t++){for(e=t,i=0;e<this._subnodes.length&&(!this._subnodes[e]||this._subnodes[e].canBeReused()===!0);)e++,i++;this._subnodes.splice(t,i)}for(t=0;t<this._subnodes.length;t++)this._subnodes[t].cleanUp()},u.prototype.getMinimumCountForInstancing=function(){return this._minimumCountForInstancing},u.prototype.getNumberOfDrawnTriangles=function(t){var e,i=0;for(this._renderableObject._wasRendered&&(i+=this._renderableObject.getNumberOfDrawnTriangles(t)),e=0;e<this._subnodes.length;e++)i+=this._subnodes[e].getNumberOfDrawnTriangles(t);return i},u.prototype.destroy=function(){var t;if(this._renderableObject.setNode(null),this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=0;t<this._subnodes.length;t++)this._subnodes[t].destroy(),this._subnodes[t]=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null},c.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction(m,function(){return this._directionalLightUniformData.length}),this.setUniformValueFunction(y,function(){return this._directionalLightUniformData}),this.setUniformValueFunction(S,function(){return this._pointLightUniformData.length}),this.setUniformValueFunction(T,function(){return this._pointLightUniformData}),this.setUniformValueFunction(E,function(){return this._spotLightUniformData.length}),this.setUniformValueFunction(b,function(){return this._spotLightUniformData}),this.setUniformValueFunction(M,function(){return this._camera.getViewMatrix()}),this.setUniformValueFunction(A,function(){return this._camera.getInverseOrientationMatrix()}),this.setUniformValueFunction(x,function(){return this._camera.getAspect()}),this.setUniformValueFunction(r.UNIFORM_PROJECTION_MATRIX_NAME,function(){return this._camera.getProjectionMatrix()}),this.setUniformValueFunction(O,function(){return e.prod4(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setUniformValueFunction(C,function(){return new Float32Array(this._camera.getCameraPositionVector())})},c.prototype._setContextUniformValueFunctions=function(t){var e=this._contexts[t].gl;this.setContextUniformValueFunction(t,R,function(){return[e.drawingBufferWidth*this._width,e.drawingBufferHeight*this._height]})},c.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setUniformValueFunction(I,function(){return this._shadowMapRanges.length}),this.setUniformValueFunction(v,function(){return new Float32Array(this._shadowMapRanges)}),this.setUniformValueFunction(N,function(){return this._shadowMapDepthRatio}),this.setUniformValueFunction(L,function(){return this._shadowMapTextureSize}),this.setUniformValueFunction(w,function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextUniformValueFunction(t,D,function(){var e,i,s=[];for(e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)for(i=0;i<this._shadowMapRanges.length;i++)s.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t].getName()));return new Int32Array(s)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},c.prototype._updateStaticLightUniformData=function(){var t;for(this._directionalLightUniformData=[],t=0;t<this._directionalLights.length&&t<this._maxRenderedDirectionalLights;t++)this._directionalLightUniformData.push(this._directionalLights[t].getUniformData())},c.prototype._clearDynamicLightUniformData=function(){this._pointLightUniformData=[],this._spotLightUniformData=[]},c.prototype._updateDynamicLightUniformData=function(t){var e,i,s,n;for(this._pointLightUniformData=[],e=0,s=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&s<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData.push(this._pointLightPriorityArrays[e][i].getUniformData()),s++);for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._spotLightUniformData=[],s=0,e=0,n=Math.min(this._spotLights.length,this._maxRenderedSpotLights);e<this._spotLights.length&&n>s;e++)this._spotLights[e].update(t),this._spotLights[e].shouldBeRendered(this._camera)&&(this._spotLightUniformData.push(this._spotLights[e].getUniformData()),s++);for(;e<this._spotLights.length;)this._spotLights[e].updateState(t),e++},c.prototype._getShadowMapBufferNamePrefix=function(t){return d+t+g},c.prototype._setupContext=function(t){var e;if(void 0!==t)for(this._setContextUniformValueFunctions(t),this._shadowMappingEnabled&&(this._contexts[t].addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},c.prototype.setRelativeViewport=function(t,e,i,s){this._left=t,this._bottom=e,this._width=i,this._height=s},c.prototype.addToContext=function(t){var e=!1,i=this._contexts.findIndex(function(e){return e.getName()===t.getName()});0>i&&(this._contexts.push(t),i=this._contexts.length-1,e=!0),this._setupContext(i),e&&(this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t))},c.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):i.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},c.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},c.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},c.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},c.prototype.setShadowMapping=function(e){e?(this._shadowMappingEnabled=void 0!==e.enable?e.enable:this._shadowMappingEnabled,this._shadowMappingShader=e.shader||this._shadowMappingShader,this._shadowMapTextureSize=e.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=e.ranges?new Float32Array(e.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=e.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=e.numSamples?t.getNumberValueInRange("shadowMappingParams.numSamples",e.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?F.length/2:0,this._shadowMappingEnabled?1:0):e.numSamples,this._shadowMapSampleOffsets=F.slice(0,2*this._numShadowMapSamples),e.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[])},c.prototype.getRootNode=function(){return this._rootNode},c.prototype.getCamera=function(){return this._camera},c.prototype.shouldAnimate=function(){return this._shouldAnimate},c.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},c.prototype.shouldUpdateCamera=function(){return this._shouldUpdateCamera},c.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},c.prototype.addBackgroundObject=function(t){var e=new u(t);return this._rootBackgroundNode.addSubnode(e),e},c.prototype.addObject=function(t,e){var i=new u(t,!1,e);return this._rootNode.addSubnode(i),i},c.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},c.prototype.addUIObject=function(t){var e=new u(t);return this._rootUINode.addSubnode(e),e},c.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},c.prototype.clear=function(){this.clearNodes(),this.clearDirectionalLights(),this.clearPointLights(),this.clearSpotLights()},c.prototype.clearNodes=function(){this._rootBackgroundNode&&this._rootBackgroundNode.destroy(),this._rootBackgroundNode=new u(new o.RenderableObject3D(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootBackgroundNode.setScene(this),this._rootNode&&this._rootNode.destroy(),this._rootNode=new u(new o.RenderableObject3D(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootNode.setScene(this),this._rootResourceNode&&this._rootResourceNode.destroy(),this._rootResourceNode=new u(new o.RenderableObject3D(null,!1,!1)),this._rootResourceNode.setScene(this),this._resourceObjectIDs={},this._rootUINode&&this._rootUINode.destroy(),this._rootUINode=new u(new o.RenderableObject3D(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootUINode.setScene(this)},c.prototype.clearDirectionalLights=function(){this._directionalLights=[]},c.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(f),t=0;f>t;t++)this._pointLightPriorityArrays[t]=[]},c.prototype.clearSpotLights=function(){this._spotLights=[]},c.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=0;t<i.length;t++)e.push(i[t]._renderableObject);return e},c.prototype.getAll3DObjects=function(){var t,e,i=[],s=this._rootNode._subnodes;for(t=0;t<s.length;t++)e=s[t]._renderableObject,e.getPositionMatrix&&e.getOrientationMatrix&&i.push(e);return i},c.prototype.moveAllObjectsByVector=function(t){var e,i,s=this._rootNode._subnodes;for(e=0;e<s.length;e++)i=s[e]._renderableObject,i.translatev&&i.translatev(t)},c.prototype.moveCameraToOrigoIfNeeded=function(t){
var e=this._camera.moveToOrigoIfNeeded(t);return e&&this.moveAllObjectsByVector(e),e},c.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},c.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},c.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},c.prototype.hasResourcesOfObject=function(t){return!!this._resourceObjectIDs[t]},c.prototype.addResourcesOfObject=function(t,e){var i;e&&this._resourceObjectIDs[e]||(t&&(i=new u(t),this._rootResourceNode.addSubnode(i),i.markAsReusable()),e&&(this._resourceObjectIDs[e]=!0))},c.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},c.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,f-1),this._pointLightPriorityArrays[e].push(t)},c.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},c.prototype.getLODContext=function(){return this._lodContext},c.prototype.getNumberOfDrawnTriangles=function(){return this._numDrawnTriangles},c.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[s.getUniformName(t)]=e.bind(this)},c.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][s.getUniformName(e)]=i.bind(this)},c.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},c.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},c.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},c.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},c.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},c.prototype.hideUI=function(){this._rootUINode.hide()},c.prototype.showUI=function(){this._rootUINode.show()},c.prototype.assignUniforms=function(t,e){this._uniformsUpdated[e.getName()]||(e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdated[e.getName()]=!0,this._uniformsUpdatedForFrame=!0)},c.prototype.cleanUp=function(){var t,e,i,s;for(this._rootNode.cleanUp(),s=0;s<this._pointLightPriorityArrays.length;s++)for(t=0;t<this._pointLightPriorityArrays[s].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[s].length&&(!this._pointLightPriorityArrays[s][e]||this._pointLightPriorityArrays[s][e].canBeReused()===!0);)e++,i++;this._pointLightPriorityArrays[s].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||this._spotLights[e].canBeReused()===!0);)e++,i++;this._spotLights.splice(t,i)}},c.prototype._renderShadowMap=function(t,e,n,o,r,a){var h,l,u=t.gl;if(i.log_DEBUG("Starting new shadow map...",4),this._shadowQueue.length>0){for(s.areDepthTexturesAvailable()?u.clear(u.DEPTH_BUFFER_BIT):u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),l=[],h=0;h<this._shadowQueue.length;h++)this._shadowQueue[h].renderToShadowMap(t,e,n,o,r,a)&&l.push(this._shadowQueue[h]);this._shadowQueue=l}},c.prototype._renderShadowMaps=function(t,e,s){var n,o,r=t.gl;if(this._shadowMappingEnabled){for(i.log_DEBUG("Rendering shadow maps for scene...",4),r.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),r.clearColor(0,0,0,0),t.setColorMask(j),t.disableBlending(),t.setDepthMask(!0),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++)for(this._directionalLights[n].reset(),this._shadowQueue=[],this._shadowQueue=this._shadowQueue.concat(this._rootNode._subnodes),i.log_DEBUG("Rendering shadow maps for light "+n+"...",4),o=this._shadowMapRanges.length-1;o>=0;o--)this._directionalLights[n].startShadowMap(t,this._camera,o,this._shadowMapRanges[o],this._shadowMapRanges[o]*this._shadowMapDepthRatio,this._shadowMapRanges[o]),this._renderShadowMap(t,e,s,this._directionalLights[n].getTranslatedMatrix(),this._shadowMapRanges[o],this._shadowMapDepthRatio);for(n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++)for(o=0;o<this._shadowMapRanges.length;o++)t.bindTexture(t.getFrameBuffer(this._directionalLights[n].getShadowMapBufferName(o)),void 0,!0)}t.setCurrentFrameBuffer(null)},c.prototype._renderBackgroundObjects=function(t,e,s){i.log_DEBUG("Rendering background objects of scene...",4),t.enableBlending(),t.setDepthMask(!1),this._rootBackgroundNode.resetForNewFrame(),this._rootBackgroundNode.render(t,e,s,!1),i.isDebugVersion()&&(this._numDrawnTriangles+=this._rootBackgroundNode.getNumberOfDrawnTriangles())},c.prototype._renderQueue=function(t,e,i,s,n,o){var r,a,h,l=s.length;if(l>0)if(a=s[0].getMinimumCountForInstancing(),a>0&&l>=a&&t.instancingExt){for(h=0,s[0].prepareForInstancedRender(t,n,l),r=0;l>r;r++)s[r].render(t,e,i,o,!0,!0,n)&&h++;h>0&&s[0].renderInstances(t,n,h)}else for(r=0;l>r;r++)s[r].render(t,e,i,o,!0)},c.prototype._renderMainObjects=function(t,e,s,n,o,r){var a;if(i.log_DEBUG("Rendering opaque phase...",4),n.length>0){for(t.setDepthMask(!0),t.disableBlending(),a=0;a<n.length;a++)this._renderQueue(t,e,s,n[a],a,!0);i.isDebugVersion()&&(this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!1))}if(r&&this._renderBackgroundObjects(t,e,s),i.log_DEBUG("Rendering transparent phase...",4),o.length>0){for(t.setDepthMask(!1),t.enableBlending(),a=0;a<o.length;a++)this._renderQueue(t,e,s,o[a],a,!1);i.isDebugVersion()&&(this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!0))}},c.prototype._renderUIObjects=function(t,e,s){var n=t.gl;this._rootUINode._subnodes.length>0&&(t.enableBlending(),n.disable(n.DEPTH_TEST),t.setDepthMask(!1),this._rootUINode.resetForNewFrame(),this._rootUINode.render(t,e,s,!1),i.isDebugVersion()&&(this._numDrawnTriangles+=this._rootUINode.getNumberOfDrawnTriangles()),n.enable(n.DEPTH_TEST))},c.prototype.render=function(t,e){var s,n,o,r,a=t.gl,h=a.drawingBufferWidth,l=a.drawingBufferHeight,u=h*this._width,c=l*this._height;i.log_DEBUG("Rendering scene...",3),this._camera.setAspect(u/c),this._shouldUpdateCamera&&this._camera.update(e),this._numDrawnTriangles=0,this._uniformsUpdated={},this._rootNode.resetForNewFrame(),this._renderQueues=[[],[],[],[]],this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._camera,e),o=this._renderQueues[P].length>0||this._renderQueues[V].length>0,r=this._renderQueues[U].length>0||this._renderQueues[B].length>0,o&&this._renderShadowMaps(t,u,c),this._updateStaticLightUniformData(),a.viewport(this._left*h,this._bottom*l,u,c),this._shouldClearColorOnRender&&(t.setColorMask(this._clearColorMask),a.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),t.setDepthMask(!0),s=this._shouldClearColorOnRender?a.COLOR_BUFFER_BIT:0,s=this._shouldClearDepthOnRender?s|a.DEPTH_BUFFER_BIT:s,a.clear(s),this._uniformsUpdatedForFrame===!1&&t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._uniformsUpdatedForFrame=!1,r&&(n=this._camera,this._camera=this._camera.getExtendedCamera(),this._clearDynamicLightUniformData(),this._renderMainObjects(t,u,c,this._renderQueues[U],this._renderQueues[B],!0),this._camera=n,t.setDepthMask(!0),a.clear(a.DEPTH_BUFFER_BIT),this._uniformsUpdated={}),(o||!r)&&(this._updateDynamicLightUniformData(this._shouldAnimate?e:0),t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._renderMainObjects(t,u,c,this._renderQueues[P],this._renderQueues[V],!r)),n=this._camera,this._camera=this._camera.getExtendedCamera(!0),this._renderUIObjects(t,u,c),this._camera=n},{getDebugInfo:a,LODContext:h,RenderableNode:u,Scene:c}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2},Math.seed=function(t){return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/media-resources","modules/scene/scene-graph","armada/constants","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(t,e){var i,s,n=0;for(i in E)E.hasOwnProperty(i)&&(s=E[i],e.hasOwnProperty(s.name)&&(n+=t[s.name]*e[s.name]));return n}function h(t,e){return{requiredVertexUniformVectors:t[b]+a(t[M],e),requiredAttributeVectors:t[O]+a(t[A],e),requiredVaryingVectors:t[x]+a(t[R],e),requiredTextureUnits:t[C]+a(t[I],e),requiredFragmentUniformVectors:t[v]+a(t[N],e)}}function l(t,e){return{requiredVertexUniformVectors:t.requiredVertexUniformVectors+e.requiredVertexUniformVectors,requiredAttributeVectors:t.requiredAttributeVectors+e.requiredAttributeVectors,requiredVaryingVectors:t.requiredVaryingVectors+e.requiredVaryingVectors,requiredTextureUnits:t.requiredTextureUnits+e.requiredTextureUnits,requiredFragmentUniformVectors:t.requiredFragmentUniformVectors+e.requiredFragmentUniformVectors}}function u(e,i,s,n){this._list=e?t.getArrayValue(s||"OrderedNamedNumericOptions.list",e,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(t,e){return t[this._optionValuePropertyName]-e[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,n&&this.applyLimit(n)}function c(t,e,i){u.call(this,t,y,e,i),this._preferenceList=null,this._updatePreferenceList()}function _(){i.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1}function p(){return f.isShadowMappingEnabled()&&f.isShadowMappingAvailable()}function d(){return f.getShader(f.getShadowMappingShaderName())}function g(){return p()?{enable:!0,shader:f.getManagedShader(f.getShadowMappingShaderName()),textureSize:f.getShadowMapTextureSize(),ranges:f.getShadowRanges(),depthRatio:f.getShadowDepthRatio(),numSamples:f.getNumShadowMapSamples()}:null}var f,m=r.LOCAL_STORAGE_PREFIX+"graphics_",y=t.getNameAndValueDefinitionObject("maximumResolution"),S=t.getNameAndValueDefinitionObject("lod"),T={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},E=T.properties,b="requiredVertexUniformVectors",M="requiredVertexUniformVectorsPer",O="requiredAttributeVectors",A="requiredAttributeVectorsPer",x="requiredVaryingVectors",R="requiredVaryingVectorsPer",C="requiredTextureUnits",I="requiredTextureUnitsPer",v="requiredFragmentUniformVectors",N="requiredFragmentUniformVectorsPer",L={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:b,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:M,type:T,defaultValue:{}},ATTRIBUTE_VECTORS:{name:O,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:A,type:T,defaultValue:{}},VARYING_VECTORS:{name:x,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:R,type:T,defaultValue:{}},TEXTURE_UNITS:{name:C,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:I,type:T,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:v,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:N,type:T,defaultValue:{}}}},D={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:L}}},w=D.properties,F="complexities",P={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:L},DYNAMIC_LIGHTS:{name:"dynamicLights",type:L},REVEAL:{name:"reveal",type:L}}},COMPLEXITIES:{name:F,type:"array",elementType:D,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"}},V=P.FEATURE_REQUIREMENTS.properties,U=t.getNameAndValueDefinitionObject("numRanges"),B=t.getNameAndValueDefinitionObject("maxLights"),j=t.getNameAndValueDefinitionObject("particleCountFactor"),G=m+"antialiasing",k=m+"filtering",H=s.TextureFiltering.TRILINEAR,q=m+"textureQuality",W=m+"cubemapQuality",z=m+"maxLOD",X=m+"shaderComplexity",Y=m+"shadowMapping",J=m+"shadowQuality",Q=m+"shadowDistance",K=m+"pointLightAmount",Z=m+"particleAmount",$=m+"dustParticleAmount",tt="withoutShadows",et="withoutDynamicLights";return u.prototype._getNameFunction=function(t){return t[this._optionNamePropertyName]},u.prototype._checkNameFunction=function(t,e){return e[this._optionNamePropertyName]===t},u.prototype._isWithinLimitFunction=function(t,e){return e[this._optionValuePropertyName]<=t},u.prototype._valueFilterFunction=function(t,e){return t(e[this._optionValuePropertyName])},u.prototype._getInvalidOptionAccessErrorMessage=function(t){return"Invalid option ("+this._optionValuePropertyName+") '"+t+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},u.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},u.prototype.getFilteredNameList=function(t){return this._list.filter(this._valueFilterFunction.bind(this,t)).map(this._getNameFunction.bind(this))},u.prototype.setCurrent=function(t,i){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,t)),this._currentIndex<0&&i&&(this._currentIndex=this._list.length-1),this._currentIndex<0?(e.showError(this._getInvalidOptionAccessErrorMessage(t)),!1):!0},u.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},u.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},u.prototype.getValueForName=function(t){var i=this._list.findIndex(this._checkNameFunction.bind(this,t));return i>=0?this._list[i][this._optionValuePropertyName]:(e.showError(this._getInvalidOptionAccessErrorMessage(t)),0)},u.prototype.applyLimit=function(t){var i=this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,t)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1,e.log("Setting ("+this._optionValuePropertyName+") changed to '"+this.getCurrentName()+"' from '"+i+"' as a result of limiting the setting to "+t+".",1))},u.prototype.decrease=function(){return this._currentIndex>0?(this._currentIndex--,!0):!1},u.prototype.setLowest=function(){this._currentIndex=0},u.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},c.prototype=new u,c.prototype.constructor=c,c.prototype._updatePreferenceList=function(){var t;for(this._preferenceList=[],t=this._currentIndex;t>=0;t--)this._preferenceList.push(this._list[t]);for(t=this._currentIndex+1;t<this._list.length;t++)this._preferenceList.push(this._list[t])},c.prototype.setCurrent=function(t,e){var i;return i=u.prototype.setCurrent.call(this,t,e),this._updatePreferenceList(),i},c.prototype.getPreferenceNameList=function(){return this._preferenceList.map(this._getNameFunction.bind(this))},c.prototype.applyLimit=function(t){u.prototype.applyLimit.call(this,t),this._updatePreferenceList()},_.prototype=new i.AsyncResource,_.prototype.constructor=_,_.prototype._getShaderRequirements=function(t){t=t||{};var e,i=this._getShaderComplexityDescriptor(t.complexityLevelIndex),s=this.getShaderConfig(P.FEATURE_REQUIREMENTS),n=i[w.MAX_DIR_LIGHTS.name],o=void 0===t.numPointLights?this.getMaxPointLights():t.numPointLights,r=o>0?i[w.MAX_SPOT_LIGHTS.name]:0,a=void 0===t.numShadowRanges?this.getNumShadowMapRanges():t.numShadowRanges,u=n*a,c=i[w.NUM_SHADOW_MAP_SAMPLES.name],_={};return _[E.DIR_LIGHT.name]=n,_[E.POINT_LIGHT.name]=o,_[E.SPOT_LIGHT.name]=r,_[E.SHADOW_MAP.name]=u,_[E.SHADOW_MAP_RANGE.name]=a,_[E.SHADOW_MAP_SAMPLE.name]=c,_[E.LUMINOSITY_FACTOR.name]=this.getShaderConfig(P.MAX_LUMINOSITY_FACTORS),_[E.GROUP_TRANSFORM.name]=this.getShaderConfig(P.MAX_GROUP_TRANSFORMS),e=h(i[w.REQUIREMENTS.name],_),i[w.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(e=l(e,h(s[V.SHADOWS.name],_))),i[w.DYNAMIC_LIGHTS_AVAILABLE.name]&&o>0&&(e=l(e,h(s[V.DYNAMIC_LIGHTS.name],_))),i[w.REVEAL_AVAILABLE.name]&&(e=l(e,h(s[V.REVEAL.name],_))),e},_.prototype._shaderRequirementsAreSatisfied=function(t){return s.requirementsAreSatisfied(this._getShaderRequirements(t))},_.prototype._limitShaderComplexities=function(){var t,i=[],s=this.getShaderConfig(P.COMPLEXITIES);for(t=0;t<s.length;t++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:t})?i.push(s[t]):e.log("Defined shader complexity level '"+s[t][w.NAME.name]+"', which has too high requirements and thus will be dropped from the available shader complexities.",1);this.setShaderConfig(P.COMPLEXITIES,i)},_.prototype._setFallbackShaderComplexity=function(t){var e;for(t&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),e=this.getShaderComplexities().indexOf(this.getShaderComplexity());e>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:e});)e--;this.setShaderComplexity(this.getShaderComplexities()[e],!1)},_.prototype.loadConfigurationFromJSON=function(e){var i,n,r,a;for(this._shaderConfig=t.getVerifiedObject("config.graphics.shaders",e.shaders,P),this._limitShaderComplexities(),this._textureQuality=new c(e.context.textureQualities,"config.graphics.context.textureQualities",s.getMaxTextureSize()),this._cubemapQuality=new c(e.context.cubemapQualities,"config.graphics.context.cubemapQualities",s.getMaxCubemapSize()),this._shadowMapQuality=new c(e.context.shadows.qualities,"config.graphics.context.shadows.qualities",s.getMaxRenderbufferSize()),this._shadowRanges=t.getArrayValue("config.graphics.context.shadows.ranges",e.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new u(e.context.shadows.distances,U,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=t.getNumberValue("config.graphics.context.shadows.depthRatio",e.context.shadows.depthRatio),this._pointLightAmount=new u(e.context.pointLightAmounts,B,"config.graphics.context.pointLightAmounts"),this._particleAmount=new u(e.context.particleAmounts,j,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new u(e.context.dustParticleAmounts,j,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new u(e.levelOfDetailSettings.lodLevels,S,"config.graphics.levelOfDetailSettings.lodLevels"),a=new Array(e.levelOfDetailSettings.lodDisplayProfile.limits.length+1),a[0]=0,i=0,n=e.levelOfDetailSettings.lodDisplayProfile.limits.length;n>i;i++)r=e.levelOfDetailSettings.lodDisplayProfile.limits[i],a[this._lodLevel.getValueForName(r.level)+1]=r.objectSizeLessThan;this._lodContext=new o.LODContext(this._lodLevel.getFirstValue(),a,e.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,e.levelOfDetailSettings.lodDisplayProfile.referenceSize,e.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize)},_.prototype._limitSettingByScreenSize=function(t,e,i,s,n){var o,r,a,h;if(t.autoLimitByScreenSize===!0)for(o=Math.max(screen.width,screen.height),r=0,a=t.limits.length;a>r;r++)h=t.limits[r],o<h.screenSizeLessThan&&i()>e.getValueForName(h[n])&&s(h[n],!1)},_.prototype.loadSettingsFromJSON=function(i,n){n=n||!1,n||(this._dataJSON=i),"object"==typeof i.shaders?this.setShaderComplexity(i.shaders.complexity,!1,!0):e.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof i.context?(this.setAntialiasing(t.getBooleanValue(i.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(t.getEnumValue(s.TextureFiltering,i.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(i.context.textureQuality,!1,!0),this.setCubemapQuality(i.context.cubemapQuality.level,!1,!0),this._limitSettingByScreenSize(i.context.cubemapQuality,this._cubemapQuality,this.getCubemapMaxResolution.bind(this),this.setCubemapQuality.bind(this),"level"),this.setShadowMapping(t.getBooleanValue(i.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof i.context.shadows&&(this.setShadowMapQuality(i.context.shadows.quality,!1,!0),this.setShadowDistance(i.context.shadows.distance,!1,!0)),this.setPointLightAmount(i.context.pointLightAmount,!1,!0)):e.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(i.levelOfDetail.maxLevel,!1),this._limitSettingByScreenSize(i.levelOfDetail,this._lodLevel,this.getMaxLoadedLOD.bind(this),this.setLODLevel.bind(this),"level"),this.setParticleAmount(i.particleAmount.amount,!1),this._limitSettingByScreenSize(i.particleAmount,this._particleAmount,this.getParticleCountFactor.bind(this),this.setParticleAmount.bind(this),"amount"),i.particleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(s.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(i.dustParticleAmount.amount,!1),this._limitSettingByScreenSize(i.dustParticleAmount,this._dustParticleAmount,this.getDustParticleCountFactor.bind(this),this.setDustParticleAmount.bind(this),"amount"),i.dustParticleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(s.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},_.prototype.loadFromLocalStorage=function(){var i,n,o=function(s,o,r,a){void 0!==localStorage[s]&&(n={silentFallback:e.hasVersionChanged(),defaultValue:r},i=t.getValueOfTypeFromLocalStorage(o,s,n),(!n.error||e.hasVersionChanged())&&a(i,!!n.error&&n.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};o(G,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),o(k,{baseType:"enum",values:s.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),o(q,{baseType:"enum",values:t.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),o(W,{baseType:"enum",values:t.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),o(z,{baseType:"enum",values:t.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),o(X,{baseType:"enum",values:t.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),o(Y,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),o(J,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&o(Q,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),o(K,{baseType:"enum",values:t.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),o(Z,{baseType:"enum",values:t.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),o($,{baseType:"enum",values:t.getEnumObjectForArray(this.getDustParticleAmounts())},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},_.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(G),localStorage.removeItem(k),localStorage.removeItem(q),localStorage.removeItem(W),localStorage.removeItem(z),localStorage.removeItem(X),localStorage.removeItem(Y),localStorage.removeItem(J),localStorage.removeItem(Q),localStorage.removeItem(K)},_.prototype.getAntialiasing=function(){return this._antialiasing},_.prototype.setAntialiasing=function(t,i){return void 0===i&&(i=!0),s.isAntialiasingAvailable()?this._antialiasing=t:(this._antialiasing=!1,t&&e.log("Attempted to enable antialiasing, but it is not supported and so will be disabled.",1)),i&&(localStorage[G]=t.toString()),this._antialiasing===t},_.prototype.getFiltering=function(){return this._filtering},_.prototype.setFiltering=function(i,n){void 0===n&&(n=!0),i=t.getEnumValue(s.TextureFiltering,i,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=i,s.isAnisotropicFilteringAvailable()||i!==s.TextureFiltering.ANISOTROPIC||(this._filtering=H,e.log("Attempted to set texture filtering to anisotropic, but it is not supported and so a fallback filtering will be applied instead.",1)),n&&(localStorage[k]=i.toString())},_.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},_.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},_.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},_.prototype.setTextureQuality=function(t,e,i){void 0===e&&(e=!0),this._textureQuality.setCurrent(t,i)&&e&&(localStorage[q]=t)},_.prototype.getCubemapMaxResolution=function(){return this._cubemapQuality.getCurrentValue()},_.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},_.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},_.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},_.prototype.setCubemapQuality=function(t,e,i){void 0===e&&(e=!0),this._cubemapQuality.setCurrent(t,i)&&e&&(localStorage[W]=t)},_.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},_.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},_.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},_.prototype.getLOD=function(t){return this._lodLevel.getValueForName(t)},_.prototype.setLODLevel=function(t,e){void 0===e&&(e=!0),this._lodLevel.setCurrent(t)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),e&&(localStorage[z]=t))},_.prototype.getLODContext=function(){return this._lodContext},_.prototype.getShaderComplexity=function(){return this._shaderComplexity},_.prototype._limitShaderFeatures=function(){var t=this.isShadowMappingEnabled(),i=this.getNumShadowMapRanges(),s=this.getMaxPointLights();for(e.log_DEBUG("Checking requirements for current shader complexity...");!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void e.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==t?e.log("Disabled shadow mapping to satisfy requirements of current shader complexity.",1):this.getNumShadowMapRanges()!==i&&e.log("Changed number of shadow map ranges from "+i+" to "+this.getNumShadowMapRanges()+" to satisfy requirements of current shader complexity.",1),this.getMaxPointLights()!==s&&e.log("Changed number of maximum point lights from "+s+" to "+this.getMaxPointLights()+" to satisfy requirements of current shader complexity.",1)},_.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},_.prototype.setShaderComplexity=function(t,i,s){var n=this.getShaderComplexities();void 0===i&&(i=!0),n.indexOf(t)>=0?(this._shaderComplexity!==t&&(this._shaderComplexity=t,this._limitShaderFeatures()),i&&(localStorage[X]=t)):s?(this._shaderComplexity=n[n.length-1],e.log("Attempted to set shader complexity to '"+t+"', which is not supported, and thus '"+this._shaderComplexity+"' has been selected instead.",1)):e.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",e.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[w.LUMINOSITY_TEXTURES_AVAILABLE.name]},_.prototype.getShaderComplexities=function(){return this.getShaderConfig(P.COMPLEXITIES).map(function(t){return t[w.NAME.name]})},_.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(P.SHADOW_MAPPING_SHADER_NAME)},_.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},_.prototype.setShadowMapping=function(t,i,s){return void 0===i&&(i=!0),s||!t||this.canEnableShadowMapping()?this._shadowMappingEnabled!==t&&(this._shadowMappingEnabled=t,!s&&t&&this._limitShaderFeatures()):(this._shadowMappingEnabled=!1,e.log("Attempted to enable shadow mapping, but it is not supported (at the current shader complexity level) and so will be disabled.",1)),i&&(localStorage[Y]=t.toString()),this._shadowMappingEnabled===t},_.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},_.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},_.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},_.prototype.setShadowMapQuality=function(t,e,i){void 0===e&&(e=!0),this._shadowMapQuality.setCurrent(t,i)&&e&&(localStorage[J]=t)},_.prototype.getShadowRanges=function(){var t,e=[],i=this.getNumShadowMapRanges();for(t=0;i>t;t++)e.push(this._shadowRanges[t]);
return e},_.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numShadowRanges:t})}.bind(this))},_.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},_.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},_.prototype.setShadowDistance=function(t,e,i){void 0===e&&(e=!0),this._shadowDistances.setCurrent(t,i)&&e&&(localStorage[Q]=t)},_.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},_.prototype._getShaderComplexityDescriptor=function(t){return void 0===t?this.getShaderConfig(P.COMPLEXITIES).find(function(t){return t[w.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(P.COMPLEXITIES)[t]},_.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[w.MAX_DIR_LIGHTS.name]},_.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numPointLights:t})}.bind(this))},_.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},_.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},_.prototype.setPointLightAmount=function(t,e,i){void 0===e&&(e=!0),this._pointLightAmount.setCurrent(t,i)&&e&&(localStorage[K]=t)},_.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[w.MAX_SPOT_LIGHTS.name]},_.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},_.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},_.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},_.prototype.setParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._particleAmount.setCurrent(t,i)&&e&&(localStorage[Z]=t)},_.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},_.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},_.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},_.prototype.setDustParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._dustParticleAmount.setCurrent(t,i)&&e&&(localStorage[$]=t)},_.prototype.getShaderConfig=function(t){return this._shaderConfig[t.name]},_.prototype.setShaderConfig=function(t,e){this._shaderConfig[t.name]=e},_.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[w.NUM_SHADOW_MAP_SAMPLES.name]},_.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[w.SHADOW_MAPPING_AVAILABLE.name]},_.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},_.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[w.REVEAL_AVAILABLE.name]},_.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[w.DYNAMIC_LIGHTS_AVAILABLE.name]},_.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},_.prototype.getTexture=function(t,e){return e=e||{},e.qualityPreferenceList=this.getTextureQualityPreferenceList(),n.getTexture(t,e)},_.prototype.getCubemap=function(t,e){return e=e||{},e.qualityPreferenceList=this.getCubemapQualityPreferenceList(),n.getCubemap(t,e)},_.prototype.getShader=function(t){return t=n.getVariantShader(t,this.getShaderComplexity()).getName(),this._shadowMappingEnabled||(t=n.getVariantShader(t,tt).getName()),0===this._pointLightAmount.getCurrentValue()&&(t=n.getVariantShader(t,et).getName()),n.getShader(t)},_.prototype.getManagedShader=function(t){var i,n={};return n[this.getShaderConfig(P.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),n[this.getShaderConfig(P.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),n[this.getShaderConfig(P.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),n[this.getShaderConfig(P.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),n[this.getShaderConfig(P.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),n[this.getShaderConfig(P.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),n[this.getShaderConfig(P.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(P.DUST_LENGTH_DIVISOR),n[this.getShaderConfig(P.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(P.MAX_LUMINOSITY_FACTORS),n[this.getShaderConfig(P.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(P.MAX_GROUP_TRANSFORMS),n[this.getShaderConfig(P.DEPTH_TEXTURES_DEFINE_NAME)]=s.areDepthTexturesAvailable()?"1":"0",n[this.getShaderConfig(P.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(P.MAX_SHININESS),i=this.getShader(t).getManagedShader(n,!0),i.isAllowedByRequirements(this._getShaderRequirements())||e.showError("Shader '"+t+"' has too high requirements!"),i},_.prototype.getModel=function(t){return n.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},f=new _,{SHADER_VARIANT_WITHOUT_SHADOWS_NAME:tt,SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME:et,loadConfigurationFromJSON:f.loadConfigurationFromJSON.bind(f),loadSettingsFromJSON:f.loadSettingsFromJSON.bind(f),loadSettingsFromLocalStorage:f.loadFromLocalStorage.bind(f),restoreDefaults:f.restoreDefaults.bind(f),getAntialiasing:f.getAntialiasing.bind(f),setAntialiasing:f.setAntialiasing.bind(f),getFiltering:f.getFiltering.bind(f),setFiltering:f.setFiltering.bind(f),getTextureQualities:f.getTextureQualities.bind(f),getTextureQuality:f.getTextureQuality.bind(f),setTextureQuality:f.setTextureQuality.bind(f),getTextureQualityPreferenceList:f.getTextureQualityPreferenceList.bind(f),getCubemapQualities:f.getCubemapQualities.bind(f),getCubemapQuality:f.getCubemapQuality.bind(f),setCubemapQuality:f.setCubemapQuality.bind(f),getCubemapQualityPreferenceList:f.getCubemapQualityPreferenceList.bind(f),getLODLevels:f.getLODLevels.bind(f),getLODLevel:f.getLODLevel.bind(f),getLOD:f.getLOD.bind(f),setLODLevel:f.setLODLevel.bind(f),getMaxLoadedLOD:f.getMaxLoadedLOD.bind(f),getLODContext:f.getLODContext.bind(f),getShaderComplexity:f.getShaderComplexity.bind(f),setShaderComplexity:f.setShaderComplexity.bind(f),getShaderComplexities:f.getShaderComplexities.bind(f),getMaxLuminosityFactors:f.getShaderConfig.bind(f,P.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:f.getShaderConfig.bind(f,P.MAX_GROUP_TRANSFORMS),getShadowMappingShaderName:f.getShadowMappingShaderName.bind(f),isShadowMappingEnabled:f.isShadowMappingEnabled.bind(f),setShadowMapping:f.setShadowMapping.bind(f),getShadowMapQualities:f.getShadowMapQualities.bind(f),getShadowMapQuality:f.getShadowMapQuality.bind(f),getShadowMapTextureSize:f.getShadowMapTextureSize.bind(f),setShadowMapQuality:f.setShadowMapQuality.bind(f),getShadowDistances:f.getShadowDistances.bind(f),getShadowDistance:f.getShadowDistance.bind(f),setShadowDistance:f.setShadowDistance.bind(f),getShadowDepthRatio:f.getShadowDepthRatio.bind(f),getNumShadowMapSamples:f.getNumShadowMapSamples.bind(f),getMaxDirLights:f.getMaxDirLights.bind(f),getPointLightAmounts:f.getPointLightAmounts.bind(f),getPointLightAmount:f.getPointLightAmount.bind(f),getMaxPointLights:f.getMaxPointLights.bind(f),setPointLightAmount:f.setPointLightAmount.bind(f),getParticleAmounts:f.getParticleAmounts.bind(f),getParticleAmount:f.getParticleAmount.bind(f),getParticleCountFactor:f.getParticleCountFactor.bind(f),setParticleAmount:f.setParticleAmount.bind(f),getDustParticleAmounts:f.getDustParticleAmounts.bind(f),getDustParticleAmount:f.getDustParticleAmount.bind(f),getDustParticleCountFactor:f.getDustParticleCountFactor.bind(f),setDustParticleAmount:f.setDustParticleAmount.bind(f),getMaxSpotLights:f.getMaxSpotLights.bind(f),isShadowMappingAvailable:f.isShadowMappingAvailable.bind(f),areLuminosityTexturesAvailable:f.areLuminosityTexturesAvailable.bind(f),isRevealAvailable:f.isRevealAvailable.bind(f),areDynamicLightsAvailable:f.areDynamicLightsAvailable.bind(f),canEnableShadowMapping:f.canEnableShadowMapping.bind(f),getTexture:f.getTexture.bind(f),getCubemap:f.getCubemap.bind(f),getShader:f.getShader.bind(f),getManagedShader:f.getManagedShader.bind(f),getModel:f.getModel.bind(f),shouldUseShadowMapping:p,getShadowMappingShader:d,getShadowMappingSettings:g,executeWhenReady:f.executeWhenReady.bind(f)}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices"],function(t,e,i){"use strict";function s(t,i,s,n){this._id=t,this._strength=i,this._direction=e.normal3(s),this._duration=n,this._continuous=void 0===n}function n(t,i,s,n){this._id=t,this._strength=i,this._axis=e.normal3(s),this._duration=n,this._continuous=void 0===n}function o(t,e,s){this._positionMatrix=t,this._positionVector=i.translationVector3(t),this._orientationMatrix=e,this._rotated=!i.equal4(e,i.IDENTITY4),this._modelMatrixInverse=null,this._halfWidth=.5*s[0],this._halfHeight=.5*s[1],this._halfDepth=.5*s[2]}function r(t,e,s,n,o,r,a){this._mass=0,this._positionMatrix=i.identity4(),this._orientationMatrix=i.identity4(),this._scalingMatrix=i.identity4(),this._rotationMatrixInverse=null,this._modelMatrixInverse=null,this._velocityMatrix=i.identity4(),this._angularVelocityMatrix=i.identity4(),this._forces=null,this._torques=null,this._bodies=null,this._bodySize=-1,this._fixedOrientation=!1,e&&this.init(t,e,s,n,o,r,a)}var a=5,h=1e-4,l=1e-5;return s.prototype.getID=function(){return this._id},s.prototype.renew=function(t,i,s){this._strength=t,this._direction=e.normal3(i),this._duration=s,this._continuous=void 0===s},s.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},s.prototype.getAccelerationVector=function(t){return e.scaled3(this._direction,this._strength/t)},n.prototype.getID=function(){return this._id},n.prototype.renew=function(t,e,i){this._strength=t,this._axis=e,this._duration=i,this._continuous=void 0===i},n.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},n.prototype.getAngularAccelerationMatrixOverTime=function(t,e){return i.rotation4(this._axis,this._strength/t*e)},o.prototype.getPositionMatrix=function(){return this._positionMatrix},o.prototype.getOrientationMatrix=function(){return this._orientationMatrix},o.prototype.getWidth=function(){return 2*this._halfWidth},o.prototype.getHeight=function(){return 2*this._halfHeight},o.prototype.getDepth=function(){return 2*this._halfDepth},o.prototype._modelTransform=function(t){return this._rotated?e.sum3(e.mulVec3Mat4(t,this._orientationMatrix),this._positionVector).concat(1):e.sum3(t,this._positionVector).concat(1)},o.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||i.prodTranslationRotation4(i.inverseOfTranslation4(this._positionMatrix),i.inverseOfRotation4(this._orientationMatrix)),this._modelMatrixInverse},o.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},o.prototype.checkHit=function(s,n,o,r){var a,h,l,u=this._halfWidth+r,c=this._halfHeight+r,_=this._halfDepth+r;if(s=this._rotated?e.mulVec4Mat4(s,this.getModelMatrixInverse()):e.diff3(s,this._positionVector),this._rotated&&(n=e.mulVec3Mat3(n,i.matrix3from4(i.inverseOfRotation4(this._orientationMatrix)))),0!==n[0])if(n[0]>0){if(a=(-u-s[0])/n[0],h=s[1]+n[1]*a,l=s[2]+n[2]*a,t.pointInRect(h,l,-c,-_,c,_))return 0>=a&&a>=-o?this._modelTransform([-u,h,l,1]):null}else if(a=(u-s[0])/n[0],h=s[1]+n[1]*a,l=s[2]+n[2]*a,t.pointInRect(h,l,-c,-_,c,_))return 0>=a&&a>=-o?this._modelTransform([u,h,l,1]):null;if(0!==n[1])if(n[1]>0){if(a=(-c-s[1])/n[1],h=s[0]+n[0]*a,l=s[2]+n[2]*a,t.pointInRect(h,l,-u,-_,u,_))return 0>=a&&a>=-o?this._modelTransform([h,-c,l,1]):null}else if(a=(c-s[1])/n[1],h=s[0]+n[0]*a,l=s[2]+n[2]*a,t.pointInRect(h,l,-u,-_,u,_))return 0>=a&&a>=-o?this._modelTransform([h,c,l,1]):null;if(0!==n[2])if(n[2]>0){if(a=(-_-s[2])/n[2],h=s[0]+n[0]*a,l=s[1]+n[1]*a,t.pointInRect(h,l,-u,-c,u,c))return 0>=a&&a>=-o?this._modelTransform([h,l,-_,1]):null}else if(a=(_-s[2])/n[2],h=s[0]+n[0]*a,l=s[1]+n[1]*a,t.pointInRect(h,l,-u,-c,u,c))return 0>=a&&a>=-o?this._modelTransform([h,l,_,1]):null;return null},r.prototype.init=function(t,e,s,n,o,r,a){this._mass=t,i.setMatrix4(this._positionMatrix,e),i.setMatrix4(this._orientationMatrix,s),i.setMatrix4(this._scalingMatrix,n),this._rotationMatrixInverse=null,this._modelMatrixInverse=null,i.setMatrix4(this._velocityMatrix,o),i.setIdentity4(this._angularVelocityMatrix),this._forces=[],this._torques=[],this._bodies=r||[],this._bodySize=-1,this._calculateBodySize(),this._fixedOrientation=!!a},r.prototype.getMass=function(){return this._mass},r.prototype.getPositionMatrix=function(){return this._positionMatrix},r.prototype.getOrientationMatrix=function(){return this._orientationMatrix},r.prototype.getScalingMatrix=function(){return this._scalingMatrix},r.prototype.getBodySize=function(){return this._bodySize},r.prototype.getSize=function(){return this._bodySize*this._scalingMatrix[0]},r.prototype.getVelocityMatrix=function(){return this._velocityMatrix},r.prototype.setVelocityMatrix=function(t){this._velocityMatrix=t},r.prototype.getAngularVelocityMatrix=function(){return this._angularVelocityMatrix},r.prototype.addForce=function(t){this._forces.push(t)},r.prototype.addTorque=function(t){this._torques.push(t)},r.prototype.setPositionMatrix=function(t){t&&(this._positionMatrix=t),this._modelMatrixInverse=null},r.prototype.setOrientationMatrix=function(t){t&&(this._orientationMatrix=t),this._rotationMatrixInverse=null,this._modelMatrixInverse=null},r.prototype.setScalingMatrix=function(t){this._scalingMatrix=t,this._modelMatrixInverse=null},r.prototype.getRotationMatrixInverse=function(){return this._rotationMatrixInverse=this._rotationMatrixInverse||i.inverseOfRotation4(this._orientationMatrix),this._rotationMatrixInverse},r.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||i.prodTranslationRotation4(i.inverseOfTranslation4(this._positionMatrix),i.prod3x3SubOf4(this.getRotationMatrixInverse(),i.inverseOfScaling4(this._scalingMatrix))),this._modelMatrixInverse},r.prototype.moveByVector=function(t){i.translateByVector(this._positionMatrix,t),this._modelMatrixInverse=null},r.prototype.addOrRenewForce=function(t,e,i,n){var o,r=!1;for(o=0;o<this._forces.length;o++)if(this._forces[o].getID()===t){this._forces[o].renew(e,i,n),r=!0;break}r===!1&&this.addForce(new s(t,e,i,n))},r.prototype.addOrRenewTorque=function(t,e,i,s){var o,r=!1;for(o=0;o<this._torques.length;o++)if(this._torques[o].getID()===t){this._torques[o].renew(e,i,s),r=!0;break}r===!1&&this.addTorque(new n(t,e,i,s))},r.prototype.addForceAndTorque=function(t,i,o,r){var a=e.normal3(t),h=e.scaled3(a,e.dot3(i,a)),l=e.diff3(i,h);this.addForce(new s("",o,i,r)),this.addTorque(new n("",o*e.length3(l)*e.length3(t),e.normal3(e.cross3(l,a)),r))},r.prototype._calculateBodySize=function(){var t,s,n;for(this._bodySize=0,t=0;t<this._bodies.length;t++)s=i.translationVector3(this._bodies[t]._positionMatrix),n=e.mulVec3Mat3(this._bodies[t].getHalfDimensions(),i.prod3x3SubOf43(this._orientationMatrix,this._bodies[t]._orientationMatrix)),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,n))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[n[0],-n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[-n[0],n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[-n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[-n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(s,[-n[0],-n[1],-n[2]])))},r.prototype.checkHit=function(t,s,n,o){var r,a,h,l,u=null;if(o=o||0,o/=this._scalingMatrix[0],t.push(1),r=e.mulVec4Mat4(t,this.getModelMatrixInverse()),a=e.diff3(s,i.translationVector3(this.getVelocityMatrix())),l=e.length3(a)*n/1e3/this._scalingMatrix[0],Math.abs(r[0])-l<this._bodySize&&Math.abs(r[1])-l<this._bodySize&&Math.abs(r[2])-l<this._bodySize)for(a=e.mulVec3Mat3(a,i.matrix3from4(this.getRotationMatrixInverse())),e.normalize3(a),h=0;null===u&&h<this._bodies.length;h++)u=this._bodies[h].checkHit(r,a,l,o);return u},r.prototype._correctMatrices=function(){i.correctOrthogonal4(this._orientationMatrix),this.setOrientationMatrix(),i.correctOrthogonal4(this._angularVelocityMatrix)},r.prototype.simulate=function(t){var s,n,o,r,u;if(t>0){if(i.translateByVector(this._positionMatrix,e.scaled3(i.translationVector3(this._velocityMatrix),t/1e3)),this.setPositionMatrix(),this._forces.length>0){for(r=i.identity4(),s=0;s<this._forces.length;s++)o=this._forces[s].exert(t)/1e3,o>0&&(n=this._forces[s].getAccelerationVector(this._mass),i.translateByVector(this._positionMatrix,e.scaled3(n,.5*o*o)),i.translateByVector(r,e.scaled3(n,o)));i.translateByMatrix(this._velocityMatrix,r)}if(i.straighten(this._velocityMatrix,h),!this._fixedOrientation){for(s=0;t>s+a/2;s+=a)i.mul4(this._orientationMatrix,this._angularVelocityMatrix);if(this.setOrientationMatrix(),this._torques.length>0){for(u=i.identity4(),s=0;s<this._torques.length;s++)o=this._torques[s].exert(t)/1e3,o>0&&(i.mul4(this._orientationMatrix,this._torques[s].getAngularAccelerationMatrixOverTime(this._mass,.5*o*o)),i.mul4(u,this._torques[s].getAngularAccelerationMatrixOverTime(this._mass,a*o/1e3)));i.mul4(this._angularVelocityMatrix,u)}i.straighten(this._angularVelocityMatrix,l),this._correctMatrices()}}},{Body:o,Force:s,Torque:n,PhysicalObject:r,ANGULAR_VELOCITY_MATRIX_DURATION:a,ANGULAR_VELOCITY_MATRIX_DURATION_S:a/1e3,VELOCITY_MATRIX_ERROR_THRESHOLD:h,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:l}}),define("armada/strings",["modules/strings"],function(t){"use strict";function e(t){var e=t[0].toLowerCase();return"a"===e||"e"===e||"u"===e||"i"===e||"o"===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e}return t.GRAMMAR={DEFINITE_ARTICLE_BEFORE_VOWEL:{name:"grammar.definiteArticle.beforeVowel"},DEFINITE_ARTICLE_BEFORE_CONSONANT:{name:"grammar.definiteArticle.beforeConsonant"},AND:{name:"grammar.and"}},t.FIRST_RUN_NOTE={HEADER:{name:"firstRunNote.header"},MESSAGE:{name:"firstRunNote.message"},BUTTON:{name:"firstRunNote.button"}},t.SCREEN={BACK:{name:"screen.back"},CANCEL:{name:"screen.cancel"}},t.MAIN_MENU={NEW_GAME:{name:"mainMenu.newGame"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"},QUIT:{name:"mainMenu.quit"}},t.MISSIONS={BACK:{name:"missions.backButton"},TITLE:{name:"missions.title"},DIFFICULTY:{name:"missions.difficulty"},LAUNCH_BUTTON:{name:"missions.launchButton"},DEMO_BUTTON:{name:"missions.demoButton"},NOT_COMPLETED:{name:"missions.notCompleted"},BEST_SCORE:{name:"missions.bestScore"},SANDBOX_COMPLETED:{name:"missions.sandboxCompleted"},NO_SELECTED_NAME:{name:"missions.noSelectedName"},NO_SELECTED_DESCRIPTION:{name:"missions.noSelectedDescription"},LOCATION:{name:"missions.location"},LOADING_DESCRIPTION:{name:"missions.loadingDescription"},NO_TRANSLATED_DESCRIPTION:{name:"missions.noTranslatedDescription"},NO_DESCRIPTION:{name:"missions.noDescription"},OBJECTIVES_TITLE:{name:"missions.missionObjectivesTitle"},SPACECRAFT_TITLE:{name:"missions.playerSpacecraftTitle"},SPACECRAFT_DATA:{name:"missions.playerSpacecraftData"},OBJECTIVE_SUBJECTS_SQUAD:{name:"missions.objectiveSubjects.squad"},OBJECTIVE_SUBJECTS_SQUADS:{name:"missions.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAM:{name:"missions.objectiveSubjects.team"},OBJECTIVE_SUBJECTS_TEAMS:{name:"missions.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"missions.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"missions.loseObjective.",optional:!0}},t.OBJECTIVE={DESTROY_ALL_SUFFIX:{name:"destroyAll",optional:!0},DESTROY_SUFFIX:{name:"destroy",optional:!0},COUNT_BELOW_SUFFIX:{name:"countBelow",optional:!0}},t.LOCATION={UNKNOWN:{name:"location.unknown"},SYSTEM:{name:"location.system"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},AUDIO:{name:"settings.audio"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},RESTART_HEADER:{name:"ingameMenu.restartDialog.header"},RESTART_MESSAGE:{name:"ingameMenu.restartDialog.message"},RESTART_RESTART:{name:"ingameMenu.restartDialog.restartButton"},QUIT:{name:"ingameMenu.quit"},QUIT_HEADER:{name:"ingameMenu.quitDialog.header"},QUIT_MESSAGE:{name:"ingameMenu.quitDialog.message"},QUIT_TO_MISSIONS:{name:"ingameMenu.quitDialog.quitToMissionsButton"},QUIT_TO_MAIN_MENU:{name:"ingameMenu.quitDialog.quitToMainMenuButton"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},t.MISSION={PREFIX:{name:"mission.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0},MESSAGES_SUFFIX:{name:".messages.",optional:!0}},t.TEAM={PREFIX:{name:"team.",optional:!0}},t.SQUAD={PREFIX:{name:"squad.",optional:!0}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},SCORE:{name:"battle.score"},HUD_FIREPOWER:{name:"battle.hud.firepower"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_WINGMEN_HEADER:{name:"battle.hud.wingmenHeader"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_OBJECTIVES:{name:"battle.hud.objectives"},HUD_ESCORTED_SHIPS_HEADER:{name:"battle.hud.escortedShipsHeader"},OBJECTIVE_SUBJECTS_SPACECRAFTS:{name:"battle.objectiveSubjects.spacecrafts"},OBJECTIVE_SUBJECTS_SQUADS:{name:"battle.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAMS:{name:"battle.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"battle.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"battle.loseObjective.",optional:!0},LOADING_BOX_LOADING_MISSION:{name:"battle.loadingBox.loadingMission"},LOADING_BOX_ADDING_RANDOM_ELEMENTS:{name:"battle.loadingBox.addingRandomElements"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_FAIL:{name:"battle.message.fail"},MESSAGE_DEFEAT_HEADER:{name:"battle.message.defeat.header"},MESSAGE_DEFEAT_MESSAGE:{name:"battle.message.defeat.message"},MESSAGE_DEFEAT_DEBRIEFING:{name:"battle.message.defeat.debriefingButton"},MESSAGE_DEFEAT_RESTART:{name:"battle.message.defeat.restartButton"},MESSAGE_DEFEAT_SPECTATE:{name:"battle.message.defeat.spectateButton"},MESSAGE_JUMP_ENGAGED:{name:"battle.message.jump.engaged"},MESSAGE_JUMP_PREPARING:{name:"battle.message.jump.preparing"},MESSAGE_NEW_HOSTILES:{name:"battle.message.newHostiles"}},t.PERFORMANCE_LEVEL={PREFIX:{name:"performanceLevel.",optional:!0}},t.DEBRIEFING={BACK:{name:"debriefing.backButton"},VICTORY_TITLE:{name:"debriefing.victoryTitle"},DEFEAT_TITLE:{name:"debriefing.defeatTitle"},GENERIC_TITLE:{name:"debriefing.genericTitle"},SCORE:{name:"debriefing.score"},NEW_RECORD:{name:"debriefing.newRecord"},DESCRIPTION_VICTORY:{name:"debriefing.description.victory"},DESCRIPTION_NEXT_PERFORMANCE:{name:"debriefing.description.nextPerformance"},DESCRIPTION_FAIL:{name:"debriefing.description.fail"},DESCRIPTION_DEFEAT:{name:"debriefing.description.defeat"},DESCRIPTION_LEFT_EARLY:{name:"debriefing.description.leftEarly"},DESCRIPTION_GENERIC:{name:"debriefing.description.generic"},STATISTICS_HEADER:{name:"debriefing.statisticsHeader"},TIME_LABEL_CELL:{name:"debriefing.timeLabelCell"},KILLS_LABEL_CELL:{name:"debriefing.killsLabelCell"},DAMAGE_LABEL_CELL:{name:"debriefing.damageLabelCell"},HIT_RATIO_LABEL_CELL:{name:"debriefing.hitRatioLabelCell"},HULL_INTEGRITY_LABEL_CELL:{name:"debriefing.hullIntegrityLabelCell"},TEAM_SURVIVAL_LABEL_CELL:{name:"debriefing.teamSurvivalLabelCell"},BASE_SCORE_LABEL_CELL:{name:"debriefing.baseScoreLabelCell"},HIT_RATIO_BONUS_LABEL_CELL:{name:"debriefing.hitRatioBonusLabelCell"},HULL_INTEGRITY_BONUS_LABEL_CELL:{name:"debriefing.hullIntegrityBonusLabelCell"},TEAM_SURVIVAL_BONUS_LABEL_CELL:{name:"debriefing.teamSurvivalBonusLabelCell"},SCORE_BREAKDOWN_HEADER:{name:"debriefing.scoreBreakdownHeader"},RESTART_BUTTON:{name:"debriefing.restartButton"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},MASS:{name:"database.mass"},WEAPON_SLOTS:{name:"database.weaponSlots"},THRUSTERS:{name:"database.thrusters"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_GAME_DEV_PARAGRAPH:{name:"about.aboutGameDevParagraph"},LICENSE_NOTE:{name:"about.licenseNote"},CREDITS_HEADER:{name:"about.creditsHeader"},CREDITS_GAME_DESIGN:{name:"about.creditsGameDesign"},CREDITS_PROGRAMMING:{name:"about.creditsProgramming"},CREDITS_REQUIREJS_NOTE:{name:"about.creditsRequireJSNote"},CREDITS_FONTS:{name:"about.creditsFonts"},CREDITS_MODELS:{name:"about.credits3DModels"},CREDITS_TEXTURES:{name:"about.creditsTextures"},CREDITS_MUSIC:{name:"about.creditsMusic"},CREDITS_SFX:{name:"about.creditsSoundEffects"},CREDITS_FREESOUND_NOTE:{name:"about.creditsFreesoundNote"},CREDITS_OTHER_SOUNDS_NOTE:{name:"about.creditsOtherSoundsNote"},CREDITS_SOUND_LICENSE_NOTE:{name:"about.creditsSoundLicenseNote"},CREDITS_TESTING:{name:"about.creditsTesting"},USED_SOFTWARE_HEADER:{name:"about.usedSoftwareHeader"},USED_SOFTWARE_PARAGRAPH:{name:"about.usedSoftwareParagraph"},LICENSE_HEADER:{name:"about.licenseHeader"},LICENSE_PARAGRAPH:{name:"about.licenseParagraph"},REQUIRE_JS_LICENSE:{name:"about.requireJSLicense"},HERE:{name:"about.here"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"},EASY:{name:"setting.easy"},HARD:{name:"setting.hard"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.back"},TITLE:{name:"graphics.title"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},t.AUDIO={PREFIX:{name:"audio.",optional:!0},BACK:{name:"audio.backButton"},TITLE:{name:"audio.title"},MASTER_VOLUME:{name:"audio.masterVolume"},MUSIC_VOLUME:{name:"audio.musicVolume"},SFX_VOLUME:{name:"audio.sfxVolume"},UI_VOLUME:{name:"audio.uiVolume"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.CONTROLS={BACK:{name:"controls.back"},SETTINGS_TITLE:{name:"controls.settingsTitle"},TITLE:{name:"controls.title"},MOUSE_TURN_SENSITIVITY:{name:"controls.mouseTurnSensitivity"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t.TIP={PREFIX:{name:"tip.",optional:!0}},t.getDefiniteArticleForWord=function(i){return t.get(e(i)?t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_VOWEL:t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_CONSONANT)},t.getList=function(e){var i,s;for(i=e[0],s=1;s<e.length-1;s++)i+=", "+e[s];return e.length>1&&(i+=" "+t.get(t.GRAMMAR.AND)+" "+e[e.length-1]),i},t}),define("armada/logic/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","armada/graphics","armada/strings"],function(t,e,i,s,n,o,r,a,h,l,u,c,_){"use strict";function p(t){return lt.getResource(ft,t)}function d(t){return lt.getResource(mt,t)}function g(t){return lt.getResource(yt,t)}function f(t){return lt.getResource(St,t)}function m(t){return lt.getResource(Tt,t)}function y(t){return lt.getResource(Et,t)}function S(t){return lt.getResource(bt,t)}function T(t){return lt.getResource(Mt,t)}function E(t){return lt.getResource(Ot,t)}function b(t,e){return lt.getResource(At,t,{allowNullResult:e})}function M(t){var e,i=[],s=lt.getResourceNames(At);for(e=0;e<s.length;e++)(!t||b(s[e]).shouldShowInDatabase())&&i.push(b(s[e]));return i}function O(){return lt.getResourceTypes()}function A(t){return lt.getResourceNames(t)}function x(t,e){return lt.getResource(t,e)}function R(t,e){n.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",n.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function C(t){t.resource=h.getSoundEffect(t.name)}function I(t,e){t.resource.play(t.volume,e)}function v(t,e,i,s,n,o){return t.resource?t.resource.createSoundClip(h.SoundCategory.SOUND_EFFECT,t.volume,e,s,n,o,i):null}function N(t,e){o.JSONResource.call(this,t,ut,e)}function L(t,e){N.call(this,t,e)}function D(t,e){L.call(this,t,e)}function w(t){D.call(this,t)}function F(t,e){D.call(this,t,e)}function P(t){F.call(this,t,!0)}function V(t){N.call(this,t)}function U(t){D.call(this,t)}function B(t){F.call(this,t,!0)}function j(t){N.call(this,t)}function G(t){F.call(this,t);
}function k(t){this._projectileClass=t?m(t.projectile||R(this,"projectile"))||n.crash():null,this._projectileVelocity=t?t.projectileVelocity||R(this,"projectileVelocity"):0,this._positionVector=t?t.position.slice()||R(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function H(t){this.axis=e.getValueOfType("WeaponRotator.axis",e.VECTOR3,t.axis),this.center=e.getValueOfType("WeaponRotator.center",e.VECTOR3,t.center),this.range=e.getValueOfType("WeaponRotator.range",e.VECTOR2,t.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(e.getValueOfType("WeaponRotator.defaultAngle",e.NUMBER,t.defaultAngle)),this.restricted=!!this.range,this.rotationRate=Math.radians(e.getValueOfType("WeaponRotator.rotationRate",e.NUMBER,t.rotationRate)),this.transformGroupIndex=e.getValueOfType("WeaponRotator.transformGroupIndex",e.NUMBER,t.transformGroupIndex)}function q(t){F.call(this,t)}function W(t){N.call(this,t)}function z(t){N.call(this,t)}function X(t){N.call(this,t)}function Y(t){this.positionMatrix=t?s.translation4v(t.position||R(this,"position")):null,this.orientationMatrix=t?s.rotation4FromJSON(t.rotations||[]):null,this.maxGrade=t?t.maxGrade||R(this,"maxGrade"):0}function J(t){this.positionVector=t?t.position.slice()||R(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||R(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:R(this,"groupIndex"):0}function Q(t){this.className=t?t["class"]||R(this,"class"):null}function K(t){this.className=t?t["class"]||R(this,"class"):null}function Z(t){this.className=t?t["class"]||R(this,"class"):null}function $(t){var e;if(this._name=t.name||"custom",this._weaponDescriptors=[],t.weapons)for(e=0;e<t.weapons.length;e++)this._weaponDescriptors.push(new Q(t.weapons[e]));this._propulsionDescriptor=t.propulsion?new K(t.propulsion):null,this._jumpEngineDescriptor=t.jumpEngine?new Z(t.jumpEngine):null}function tt(e){this._name=e?e.name||R(this,"name"):null,this._fps=e&&"boolean"==typeof e.fps?e.fps:!1,this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=e?"boolean"==typeof e.movable?e.movable:R(this,"movable"):!1,this._turnable=e?"boolean"==typeof e.turnable?e.turnable:R(this,"turnable"):!1,this._positionMatrix=e?s.translation4v(e.position||R(this,"position")):null,this._orientationMatrix=e?s.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._spanRange=e?e.spanRange||null:null,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=e&&"boolean"==typeof e.resetsWhenLeavingConfines?e.resetsWhenLeavingConfines:!1,this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(l.CameraOrientationConfiguration.prototype.BaseOrientation,e.baseOrientation)||n.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(l.CameraOrientationConfiguration.prototype.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(l.CameraOrientationConfiguration.prototype.PointToFallback,e.pointToFallback)||n.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(l.CameraOrientationConfiguration.prototype.PointToFallback).join(", ")+"."):null,this._excludeFromCycle=e&&"boolean"==typeof e.excludeFromCycle?e.excludeFromCycle:!1}function et(e){tt.call(this,e),this._isAimingView="boolean"==typeof e.isAimingView?e.isAimingView:R(this,"isAimingView"),this._followsPosition="boolean"==typeof e.followsPosition?e.followsPosition:R(this,"followsPosition"),e.lookAt=t.getSafeEnumValue(_t,e.lookAt,_t.NONE),this._followsOrientation="boolean"==typeof e.followsOrientation?e.followsOrientation:e.lookAt===_t.NONE,this._lookAtSelf=e.lookAt===_t.SELF?this._followsPosition||this._followsOrientation||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!"):!0:!1,this._lookAtTarget=e.lookAt===_t.TARGET?this._followsOrientation||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!"):!0:!1,this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject?e.rotationCenterIsObject?this._lookAtSelf||!this._followsPosition?n.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"):!0:!1:this._lookAtSelf||!this._followsPosition?!1:R(this,"rotationCenterIsObject"),this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._followsPosition||this._rotationCenterIsObject?n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!"):!0:!1,this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||R(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=e.movesRelativeToObject===!0?!this._rotationCenterIsObject&&this._followsPosition&&this._followsOrientation?!0:n.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!"):!1,this._resetsOnFocusChange="boolean"==typeof e.resetsOnFocusChange?e.resetsOnFocusChange:!1,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function it(e){tt.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll?e.turnAroundAll:!1,this._lookAtAll=t.getSafeEnumValue(pt,e.lookAt,pt.NONE)===pt.ALL?this._turnAroundAll||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!"):!0:!1,this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||R(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._turnAroundAll?n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!"):!0:!1,!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function st(t){this.hullIntegrity=t?t.hullIntegrity||R(this,"hullIntegrity"):0,this.explosionClass=t?f(t["class"]||R(this,"class"))||n.crash():null}function nt(t){this.position=t?t.position||R(this,"position"):null,this.color=t?t.color||R(this,"color"):null,this.intensity=t?t.intensity||R(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function ot(t){this._particle=null,t.particle?this._particle=new P(t.particle):R(this,"particle"),this._position=t?t.position||R(this,"position"):null,this._period=t?t.period||R(this,"period"):0,this._blinks=t?t.blinks||R(this,"blinks"):null,this._intensity=t?t.intensity||R(this,"intensity"):0}function rt(t){F.call(this,t)}function at(t,e){var i={};i[ft]=w,i[mt]=V,i[yt]=U,i[St]=j,i[Tt]=G,i[Et]=q,i[bt]=W,i[Mt]=z,i[Ot]=X,i[At]=rt,lt.requestConfigLoad(t.filename,t.folder,i,function(){lt.requestAllResources(),lt.requestResourceLoad(),e&&e()}),ut=t.folder}function ht(){lt.executeForAllResources(function(t){t.handleGraphicsSettingsChanged()})}var lt,ut,ct={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},_t={NONE:"none",SELF:"self",TARGET:"target"},pt={NONE:"none",ALL:"all"},dt={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},gt={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},ft="skyboxClasses",mt="backgroundObjectClasses",yt="dustCloudClasses",St="explosionClasses",Tt="projectileClasses",Et="weaponClasses",bt="propulsionClasses",Mt="jumpEngineClasses",Ot="spacecraftTypes",At="spacecraftClasses",xt="-",Rt="fvqModel",Ct="squareModel",It="dust",vt="projectileModel-",Nt="-width-",Lt="instanced",Dt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,10],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}},wt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,50],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}};return Object.freeze(ct),Object.freeze(_t),Object.freeze(pt),N.prototype=new o.JSONResource,N.prototype.constructor=N,N.prototype.showResourceAccessError=function(t,e){n.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},N.prototype.handleGraphicsSettingsChanged=function(){},L.prototype=new N,L.prototype.constructor=L,L.prototype._overrideData=function(t,e){N.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||R(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},L.prototype._loadData=function(t){return this._overrideData(null,t),!0},L.prototype.acquireResources=function(t){t=t||{},t.omitShader||(this._shader=c.getShader(this._shaderName),this._instancedShaderName=h.getShader(this._shaderName).getVariantShaderName(Lt),this._instancedShaderName&&(this._instancedShader=c.getShader(this._instancedShaderName)))},L.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=c.getManagedShader(this._shaderName)),this._managedShader)},L.prototype.getInstancedShader=function(){return null===this._instancedShader?(n.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=c.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},L.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},D.prototype=new L,D.prototype.constructor=D,D.prototype._overrideData=function(t,e){L.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},D.prototype._loadData=function(t){return this._overrideData(null,t),!0},D.prototype.acquireResources=function(t){L.prototype.acquireResources.call(this,t),t&&t.model?(this._model=h.getOrAddModel(t.model),this._modelName=this._model.getName()):this._model=c.getModel(this._modelName)},D.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},w.prototype=new D,w.prototype.constructor=w,w.prototype._loadData=function(t){return D.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||R(this,"cubemap"):null,this._cubemap=null,!0},w.prototype.acquireResources=function(){D.prototype.acquireResources.call(this,{model:r.fvqModel(Rt)}),null===this._cubemap&&(this._cubemap=c.getCubemap(this._cubemapName))},w.prototype.getCubemap=function(t){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(t)},w.prototype.handleGraphicsSettingsChanged=function(){D.prototype.handleGraphicsSettingsChanged.call(this),this._cubemap=null},F.prototype=new D,F.prototype.constructor=F,F.prototype._overrideData=function(t,e){var i,s,o;for(D.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||R(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,o=c.getMaxLuminosityFactors();o>i;i++)this._defaultLuminosityFactors.push(0);if(e.defaultLuminosityFactors)for(i=0;i<e.defaultLuminosityFactors.length;i++)s=e.defaultLuminosityFactors[i][0],s<c.getMaxLuminosityFactors()?this._defaultLuminosityFactors[s]=e.defaultLuminosityFactors[i][1]:n.showError("Attempting to set luminosity of group with index "+s+", while there are only "+c.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",n.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this.getName()+"'.");else t&&(this._defaultLuminosityFactors=t._defaultLuminosityFactors.slice())},F.prototype._loadData=function(t){return this._overrideData(null,t),!0},F.prototype.acquireResources=function(t){D.prototype.acquireResources.call(this,t),null===this._texture&&(this._texture=c.getTexture(this._textureName))},F.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},F.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},F.prototype.getTextures=function(t){return this.getTexturesOfTypes(this._texture.getTypes(),t)},F.prototype.getDefaultGroupLuminosity=function(t){return this._defaultLuminosityFactors[t]},F.prototype.handleGraphicsSettingsChanged=function(){D.prototype.handleGraphicsSettingsChanged.call(this),this._texture=null},P.prototype=new F,P.prototype.constructor=P,P.prototype._loadData=function(t){return F.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null,!0},P.prototype.acquireResources=function(){F.prototype.acquireResources.call(this,{model:r.squareModel(Ct)})},P.prototype.getSize=function(){return this._size},P.prototype.getColor=function(){return this._color},P.prototype.getDuration=function(){return this._duration},V.prototype=new N,V.prototype.constructor=V,V.prototype._loadData=function(t){var e;if(N.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor||[1,1,1]:null,this._layers=[],t)if(t.layers)for(e=0;e<t.layers.length;e++)this._layers.push(new P(t.layers[e]));else R(this,"layers");return!0},V.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},V.prototype.getLightColor=function(){return this._lightColor},V.prototype.getLayers=function(){return this._layers},V.prototype.handleGraphicsSettingsChanged=function(){var t;for(N.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._layers.length;t++)this._layers[t].handleGraphicsSettingsChanged()},U.prototype=new D,U.prototype.constructor=U,U.prototype._loadData=function(t){return D.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||R(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||R(this,"range"):0,!0},U.prototype.acquireResources=function(){D.prototype.acquireResources.call(this,{model:r.lineModel(It,[1,1,1],[1,1,1,1])})},U.prototype.getNumberOfParticles=function(){return this._numberOfParticles*c.getDustParticleCountFactor()},U.prototype.getColor=function(){return this._color},U.prototype.getRange=function(){return this._range},B.prototype=new F,B.prototype.constructor=B,B.prototype._loadData=function(e){return F.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(ct,e.type,ct.OMNIDIRECTIONAL):null,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==ct.UNIDIRECTIONAL&&this._type!==ct.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?void 0!==e.duration?e.duration:1:0,this._delay=e&&void 0!==e.delay?e.delay:0,this._particleStates=e?e.particleStates||[]:null,!0},B.prototype.acquireResources=function(){F.prototype.acquireResources.call(this,{model:r.squareModel(Ct)})},B.prototype.getType=function(){return this._type},B.prototype.getDimensions=function(){return this._dimensions},B.prototype.getDirectionSpread=function(){return this._directionSpread},B.prototype.getVelocity=function(){return this._velocity},B.prototype.getVelocitySpread=function(){return this._velocitySpread},B.prototype.getInitialNumber=function(){return this._initialNumber},B.prototype.getSpawnNumber=function(){return this._spawnNumber},B.prototype.getSpawnTime=function(){return this._spawnTime},B.prototype.getDuration=function(){return this._duration},B.prototype.getDelay=function(){return this._delay},B.prototype.getParticleStates=function(){return this._particleStates},B.prototype.getTotalDuration=function(){var t,e=0;for(this._spawnNumber&&this._spawnTime&&(e+=Math.floor(this._duration/this._spawnTime)*this._spawnTime),t=0;t<this._particleStates.length;t++)e+=this._particleStates[t].timeToReach;return e},j.prototype=new N,j.prototype.constructor=j,j.prototype._loadData=function(t){var i;if(N.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],i=0;i<t.particleEmitters.length;i++)this._particleEmitterDescriptors.push(new B(t.particleEmitters[i]));return this._lightStates=t?t.lightStates:null,this._soundEffect=t&&t.soundEffect?e.getVerifiedObject("explosionClasses['"+this._name+"'].soundEffect",t.soundEffect,wt):null,!0},j.prototype.acquireResources=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].acquireResources();this._soundEffect&&C(this._soundEffect)},j.prototype.getParticleEmitterDescriptors=function(){return this._particleEmitterDescriptors},j.prototype.getLightStates=function(){return this._lightStates},j.prototype.getTotalDuration=function(){var t,e,i=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)e=this._particleEmitterDescriptors[t].getTotalDuration(),e>i&&(i=e);return i},j.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(0===this._particleEmitterDescriptors[t]._duration)return!0;return!1},j.prototype.playSound=function(t,e,i,s){var n;this._soundEffect&&(n=v(this._soundEffect,!1,t,e,i,s),n&&n.play())},j.prototype.handleGraphicsSettingsChanged=function(){var t;for(N.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].handleGraphicsSettingsChanged()},G.prototype=new F,G.prototype.constructor=G,G.prototype._loadData=function(t){return F.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._width=t?t.width||1:0,this._mass=t?t.mass||R(this,"mass"):0,this._duration=t?t.duration||R(this,"duration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?this._muzzleFlash=new P(t.muzzleFlash):R(this,"muzzleFlash")),this._lightColor=t?t.lightColor||R(this,"lightColor"):null,this._lightIntensity=t?t.lightIntensity||R(this,"lightIntensity"):0,this._explosionClass=t?f(t.explosion||R(this,"explosion"))||n.crash():null,!0},G.prototype.acquireResources=function(){F.prototype.acquireResources.call(this,{model:r.turningBillboardModel(vt+this._intersectionPositions.join(xt)+Nt+this._width,this._intersectionPositions,this._width)}),this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources()},G.prototype.getDamage=function(){return this._damage},G.prototype.getSize=function(){return this._size},G.prototype.getMass=function(){return this._mass},G.prototype.getDuration=function(){return this._duration},G.prototype.getMuzzleFlash=function(){return this._muzzleFlash},G.prototype.getLightColor=function(){return this._lightColor},G.prototype.getLightIntensity=function(){return this._lightIntensity},G.prototype.getExplosionClass=function(){return this._explosionClass},G.prototype.handleGraphicsSettingsChanged=function(){F.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},k.prototype.getProjectileClass=function(){return this._projectileClass},k.prototype.getProjectileVelocity=function(){return this._projectileVelocity},k.prototype.getForceForDuration=function(t){return this._projectileVelocity*this._projectileClass.getMass()/(t/1e3)},k.prototype.getPositionVector=function(){return this._positionVector},k.prototype.acquireResources=function(){this._projectileClass.acquireResources()},q.prototype=new F,q.prototype.constructor=q,q.prototype._loadData=function(i){var s;if(F.prototype._loadData.call(this,i),this._grade=i?i.grade||R(this,"grade"):0,this._cooldown=i?i.cooldown||R(this,"cooldown"):0,this._barrels=[],i)if(i.barrels)for(s=0;s<i.barrels.length;s++)this._barrels.push(new k(i.barrels[s]));else R(this,"barrels");if(this._attachmentPoint=i?i.attachmentPoint||R(this,"attachmentPoint"):null,this._rotationStyle=i?t.getSafeEnumValue(dt,i.rotationStyle,dt.NONE):null,this._fixed=this._rotationStyle===dt.NONE,this._basePoint=i&&!this._fixed?i.basePoint.slice()||R(this,"basePoint"):null,this._basePoint&&this._basePoint.push(1),this._rotators=[],i&&!this._fixed)if(i.rotators)for(s=0;s<i.rotators.length;s++)this._rotators.push(new H(i.rotators[s]));else R(this,"rotators");return this._fireSound=i?e.getVerifiedObject("weaponClasses['"+this._name+"'].fireSound",i.fireSound,wt):null,this._scoreValue=i?i.scoreValue||R(this,"scoreValue")||0:0,!0},q.prototype.acquireResources=function(t){var e;for(F.prototype.acquireResources.call(this,t),e=0;e<this._barrels.length;e++)this._barrels[e].acquireResources();C(this._fireSound)},q.prototype.getGrade=function(){return this._grade},q.prototype.getCooldown=function(){return this._cooldown},q.prototype.getBarrel=function(t){return this._barrels[t]},q.prototype.getBarrels=function(){return this._barrels},q.prototype.getAttachmentPoint=function(){return this._attachmentPoint},q.prototype.getRotationStyle=function(){return this._rotationStyle},q.prototype.isFixed=function(){return this._fixed},q.prototype.getBasePoint=function(){return this._basePoint},q.prototype.getRotators=function(){return this._rotators},q.prototype.getProjectileClass=function(){return this._barrels[0].getProjectileClass()},q.prototype.getProjectileVelocity=function(){return this._barrels[0].getProjectileVelocity()},q.prototype.getFirepower=function(t){var e,i=0;for(t=t||0,e=0;e<this._barrels.length;e++)i+=Math.max(0,this._barrels[e].getProjectileClass().getDamage()-t);return 1e3*i/this._cooldown},q.prototype.playFireSound=function(t,e,i,s){t?I(this._fireSound,t):v(this._fireSound,!1,e,!0,i,s).play()},q.prototype.getScoreValue=function(){return this._scoreValue},W.prototype=new N,W.prototype.constructor=W,W.prototype._loadData=function(t){var i;return N.prototype._loadData.call(this,t),i=t?t.referenceMass||1:null,this._thrusterBurnParticle=new P(t),this._grade=t?t.grade||R(this,"grade"):0,this._thrust=t?i*t.thrust||R(this,"thrust"):0,this._angularThrust=t?i*Math.radians(t.angularThrust)||R(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||R(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||R(this,"maxTurnBurnLevel"):0,this._thrusterSound=t?e.getVerifiedObject("propulsionClasses['"+this._name+"'].thrusterSound",t.thrusterSound,wt):null,this._scoreValue=t?t.scoreValue||R(this,"scoreValue")||0:0,!0},W.prototype.acquireResources=function(){this._thrusterBurnParticle.acquireResources(),C(this._thrusterSound)},W.prototype.getThrusterBurnParticle=function(){return this._thrusterBurnParticle},W.prototype.getGrade=function(){return this._grade},W.prototype.getThrust=function(){return this._thrust},W.prototype.getAngularThrust=function(){return this._angularThrust},W.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},W.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},W.prototype.handleGraphicsSettingsChanged=function(){N.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},W.prototype.createThrusterSoundClip=function(t){return v(this._thrusterSound,!0,t)},W.prototype.getThrusterSoundVolume=function(){return this._thrusterSound.volume},W.prototype.getScoreValue=function(){return this._scoreValue},z.prototype=new N,z.prototype.constructor=z,z.prototype._loadData=function(t){return N.prototype._loadData.call(this,t),this._engageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].engageSound",t.engageSound,Dt):null,this._disengageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].disengageSound",t.disengageSound,Dt):null,this._prepareVelocity=t?t.prepareVelocity||R(this,"prepareVelocity"):0,this._prepareDuration=t?t.prepareDuration||R(this,"prepareDuration"):0,this._prepareSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].prepareSound",t.prepareSound,wt):null,this._cancelSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].cancelSound",t.cancelSound,wt):null,this._jumpOutAcceleration=t?t.jumpOutAcceleration||R(this,"jumpOutAcceleration"):0,this._jumpOutScaling=t?t.jumpOutScaling||R(this,"jumpOutScaling"):0,this._jumpOutDuration=t?t.jumpOutDuration||R(this,"jumpOutDuration"):0,this._jumpOutSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpOutSound",t.jumpOutSound,wt):null,this._jumpOutExplosionClass=t?f(t.jumpOutExplosion||R(this,"jumpOutExplosion"))||n.crash():null,this._jumpInDeceleration=t?t.jumpInDeceleration||R(this,"jumpInDeceleration"):0,this._jumpInVelocity=t?t.jumpInVelocity||R(this,"jumpInVelocity"):0,this._jumpInScaling=t?t.jumpInScaling||R(this,"jumpInScaling"):0,this._jumpInDuration=t?t.jumpInDuration||R(this,"jumpInDuration"):0,this._jumpInSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpInSound",t.jumpInSound,wt):null,this._jumpInExplosionClass=t?f(t.jumpInExplosion||R(this,"jumpInExplosion"))||n.crash():null,!0},z.prototype.acquireResources=function(){C(this._engageSound),C(this._disengageSound),C(this._prepareSound),C(this._cancelSound),C(this._jumpOutSound),C(this._jumpInSound),this._jumpOutExplosionClass.acquireResources(),this._jumpInExplosionClass.acquireResources()},z.prototype.createEngageSoundClip=function(){return v(this._engageSound,!1)},z.prototype.createDisengageSoundClip=function(){return v(this._disengageSound,!1)},z.prototype.getPrepareVelocity=function(){return this._prepareVelocity},z.prototype.getPrepareDuration=function(){return this._prepareDuration},z.prototype.createPrepareSoundClip=function(t){return v(this._prepareSound,!1,t)},z.prototype.createCancelSoundClip=function(t){return v(this._cancelSound,!1,t)},z.prototype.getJumpOutDuration=function(){return this._jumpOutDuration},z.prototype.getJumpOutAcceleration=function(){return this._jumpOutAcceleration},z.prototype.getJumpOutScaling=function(){return this._jumpOutScaling},z.prototype.createJumpOutSoundClip=function(t){return v(this._jumpOutSound,!1,t)},z.prototype.getJumpOutExplosionClass=function(){return this._jumpOutExplosionClass},z.prototype.getJumpInDuration=function(){return this._jumpInDuration},z.prototype.getJumpInDeceleration=function(){return this._jumpInDeceleration},z.prototype.getJumpInVelocity=function(){return this._jumpInVelocity},z.prototype.getJumpInScaling=function(){return this._jumpInScaling},z.prototype.createJumpInSoundClip=function(t){return v(this._jumpInSound,!1,t)},z.prototype.getJumpInExplosionClass=function(){return this._jumpInExplosionClass},X.prototype=new N,X.prototype.constructor=X,X.prototype._loadData=function(t){return N.prototype._loadData.call(this,t),this._isFighterType=t?"boolean"==typeof t.isFighterType?t.isFighterType:R(this,"isFighterType"):!1,this._fullName=t?t.fullName||R(this,"fullName"):null,this._description=t?"string"==typeof t.description?t.description:R(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null,!0},X.prototype.isFighterType=function(){return this._isFighterType},X.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this.getName()+_.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},X.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this.getName()+_.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},X.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(E(this._goodAgainstTypeNames[t]))},X.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(E(this._badAgainstTypeNames[t]))},X.prototype.isGoodAgainst=function(t){return this._goodAgainstTypeNames.indexOf(t.getName())>=0},X.prototype.isBadAgainst=function(t){return this._badAgainstTypeNames.indexOf(t.getName())>=0},$.prototype.getName=function(){return this._name},$.prototype.getWeaponDescriptors=function(){return this._weaponDescriptors},$.prototype.getPropulsionDescriptor=function(){return this._propulsionDescriptor},$.prototype.getJumpEngineDescriptor=function(){return this._jumpEngineDescriptor},tt.prototype.getName=function(){return this._name},tt.prototype.isFPS=function(){return this._fps},tt.prototype.getFOV=function(){return this._fov},tt.prototype.getFOVRange=function(){return this._fovRange},tt.prototype.getSpan=function(){return this._span},tt.prototype.getSpanRange=function(){return this._spanRange},tt.prototype.isMovable=function(){return this._movable},tt.prototype.isTurnable=function(){return this._turnable},tt.prototype.getPositionMatrix=function(){return this._positionMatrix},tt.prototype.getOrientationMatrix=function(){return this._orientationMatrix},tt.prototype.getAlphaRange=function(){return this._alphaRange},tt.prototype.getBetaRange=function(){return this._betaRange},tt.prototype.getConfines=function(){return this._confines},tt.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},tt.prototype.getBaseOrientation=function(){return this._baseOrientation},tt.prototype.getPointToFallback=function(){return this._pointToFallback},tt.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},tt.prototype.destroy=function(){this._fovRange=null,this._positionMatrix=null,this._orientationMatrix=null,this._alphaRange=null,this._betaRange=null,this._spanRange=null,this._confines=null},et.prototype=new tt,et.prototype.constructor=et,et.prototype.isAimingView=function(){return this._isAimingView},et.prototype.turnsAroundObjects=function(){
return this._rotationCenterIsObject},et.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},et.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},et.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},et.prototype.getDistanceRange=function(){return this._distanceRange},et.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},et.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},et.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},et.prototype.createCameraConfiguration=function(t,e,i,n,o,r,a){var h,u,c=s.getYawAndPitch(this._orientationMatrix);return h=new l.CameraPositionConfiguration(!this.isMovable(),this.turnsAroundObjects(),this.movesRelativeToObject(),this.getPositionFollowedObjectsForObject(t),this.startsWithRelativePosition(),s.matrix4(this._positionMatrix),this.getDistanceRange(),this.getConfines(),this.resetsWhenLeavingConfines()),u=new l.CameraOrientationConfiguration(!this.isTurnable(),this.pointsTowardsObjects(),this.isFPS(),this.getOrientationFollowedObjectsForObject(t),s.matrix4(this._orientationMatrix),Math.degrees(c.yaw),Math.degrees(c.pitch),this.getAlphaRange(),this.getBetaRange(),this.getBaseOrientation()||e,this.getPointToFallback()||i),new l.CameraConfiguration(this.getName(),h,u,this.getFOV()||n,this.getFOVRange()||o,this.getSpan()||r,this.getSpanRange()||a,this.resetsOnFocusChange(),this.shouldExcludeFromCycle())},et.prototype.destroy=function(){tt.prototype.destroy.call(this),this._distanceRange=null},it.prototype=new tt,it.prototype.constructor=it,it.prototype.turnsAroundObjects=function(){return this._turnAroundAll},it.prototype.movesRelativeToObject=function(){return!1},it.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},it.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},it.prototype.getDistanceRange=function(){return this._distanceRange},it.prototype.pointsTowardsObjects=function(){return this._lookAtAll},it.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},it.prototype.resetsOnFocusChange=function(){return!1},it.prototype.destroy=function(){tt.prototype.destroy.call(this),this._distanceRange=null},ot.prototype.acquireResources=function(){this._particle.acquireResources()},ot.prototype.getParticle=function(){return this._particle},ot.prototype.getPosition=function(){return this._position},ot.prototype.getBlinks=function(){return this._blinks},ot.prototype.getPeriod=function(){return this._period},ot.prototype.getIntensity=function(){return this._intensity},ot.prototype.getLightColor=function(){return[this._particle.getColor()[0],this._particle.getColor()[1],this._particle.getColor()[2]]},ot.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new u.ParticleState(this._particle.getColor(),0,0)),i.push(new u.ParticleState(this._particle.getColor(),0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new u.ParticleState(this._particle.getColor(),this._particle.getSize(),0)),i.push(new u.ParticleState(this._particle.getColor(),0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new u.ParticleState(this._particle.getColor(),0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));else i.push(new u.ParticleState(this._particle.getColor(),0,0));return i},ot.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this.getLightColor(),intensity:0,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this.getLightColor(),intensity:this._intensity,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this.getLightColor(),intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});else i.push({color:this.getLightColor(),intensity:0,timeToReach:0});return i},ot.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},rt.prototype=new F,rt.prototype.constructor=rt,rt.prototype._overrideData=function(o,r){var h,l,u,c,_,p,d,g,m,y,S,T;switch(F.prototype._overrideData.call(this,o,r),this._spacecraftType=o?r.type?E(r.type):o._spacecraftType:E(r.type||R(this,"type")),this._fullName=o?r.fullName||o._fullName:r.fullName||R(this,"fullName"),this._description=o?r.description||o._description:r.description||R(this,"description"),this._showInDatabase=o?"boolean"==typeof r.showInDatabase?r.showInDatabase:o._showInDatabase:"boolean"==typeof r.showInDatabase?r.showInDatabase:R(this,"showInDatabase"),this._hitpoints=o?r.hitpoints||o._hitpoints:r.hitpoints||R(this,"hitpoints")||0,this._armor="number"==typeof r.armor?r.armor:o?o._armor:R(this,"armor")||0,this._factionColor=o?r.factionColor||o._factionColor:r.factionColor||R(this,"factionColor")||[0,0,0,0],this._turnStyle=r.turnStyle?t.getSafeEnumValue(gt,r.turnStyle,gt.YAW_PITCH):o?o._turnStyle:gt.YAW_PITCH,this._attackVector=r.attackVector?i.normal3(r.attackVector):o?o._attackVector:[0,1,0],this._attackVectorAngles=[0,0],this._turnStyle){case gt.YAW_PITCH:T=i.getYawAndPitch(this._attackVector),this._attackVectorAngles[0]=T.yaw,this._attackVectorAngles[1]=T.pitch;break;case gt.ROLL_YAW:T=i.getRollAndYaw(this._attackVector),this._attackVectorAngles[0]=T.roll,this._attackVectorAngles[1]=T.yaw;break;case gt.ROLL_PITCH:T=i.getRollAndPitch(this._attackVector),this._attackVectorAngles[0]=T.roll,this._attackVectorAngles[1]=T.pitch;break;default:n.crash()}if(this._attackThresholdAngle=Math.radians(r.attackThresholdAngle)||(o?o._attackThresholdAngle:0),this._mass=o?r.mass||o._mass:r.mass||R(this,"mass"),this._bodies=o&&!r.bodies?o._bodies:[],r.bodies)for(h=0;h<r.bodies.length;h++)this._bodies.push(new a.Body(s.translation4v(r.bodies[h].position||R(this,"bodies[i].position")),s.rotation4FromJSON(r.bodies[h].rotations),r.bodies[h].size));else o||R(this,"bodies");if(this._weaponSlots=o&&!r.weaponSlots?o._weaponSlots:[],r.weaponSlots)for(h=0;h<r.weaponSlots.length;h++)if(r.weaponSlots[h].array)for(u=r.weaponSlots[h].startPosition||R(this,"weaponSlot array startPosition"),c=r.weaponSlots[h].translationVector||R(this,"weaponSlot array translationVector"),_=r.weaponSlots[h].rotations,p=r.weaponSlots[h].maxGrade||R(this,"weaponSlot array maxGrade"),d=r.weaponSlots[h].count||R(this,"weaponSlot array count"),l=0;d>l;l++)this._weaponSlots.push(new Y({position:i.sum3(u,i.scaled3(c,l)),rotations:_,maxGrade:p}));else this._weaponSlots.push(new Y(r.weaponSlots[h]));if(this._maxPropulsionGrade=o?r.maxPropulsionGrade||o._maxPropulsionGrade:r.maxPropulsionGrade||R(this,"maxPropulsionGrade"),this._thrusterSlots=o&&!r.thrusterSlots?o._thrusterSlots:[],r.thrusterSlots)for(h=0;h<r.thrusterSlots.length;h++){if(g=r.thrusterSlots[h].group,m=r.thrusterSlots[h].uses,r.thrusterSlots[h].array)for(u=r.thrusterSlots[h].startPosition||R(this,"thrusterSlot array startPosition"),c=r.thrusterSlots[h].translationVector||R(this,"thrusterSlot array translationVector"),y=r.thrusterSlots[h].size||R(this,"thrusterSlot array size"),d=r.thrusterSlots[h].count||R(this,"thrusterSlot array count"),l=0;d>l;l++)this._thrusterSlots.push(new J({position:i.sum3(u,i.scaled3(c,l)),size:y,groupIndex:g,uses:m}));if(r.thrusterSlots[h].thrusters)for(l=0;l<r.thrusterSlots[h].thrusters.length;l++)S=r.thrusterSlots[h].thrusters[l],S.groupIndex=g,S.uses=m,this._thrusterSlots.push(new J(S))}if(this._views=o&&!r.views?o._views:[],r.views)for(h=0;h<r.views.length;h++)this._views.push(new et(r.views[h]));else o||R(this,"views");if(this._equipmentProfiles=o&&!r.equipmentProfiles?o._equipmentProfiles:{},r.equipmentProfiles)for(h=0;h<r.equipmentProfiles.length;h++)this._equipmentProfiles[r.equipmentProfiles[h].name]=new $(r.equipmentProfiles[h]);if(this._humSound=r.humSound?e.getVerifiedObject("spacecraftClasses['"+this._name+"'].humSound",r.humSound,wt):o?o._humSound:null,this._explosionClass=o?r.explosion?f(r.explosion):o._explosionClass:f(r.explosion||R(this,"explosion")),this._showTimeRatioDuringExplosion=o?r.showTimeRatioDuringExplosion||o._showTimeRatioDuringExplosion:r.showTimeRatioDuringExplosion||R(this,"showTimeRatioDuringExplosion"),this._damageIndicators=o&&!r.damageIndicators?o._damageIndicators:[],r.damageIndicators)for(h=0;h<r.damageIndicators.length;h++)this._damageIndicators.push(new st(r.damageIndicators[h]));else o||R(this,"damageIndicators");if(this._lightSources=o&&!r.lights?o._lightSources:[],r.lights)for(h=0;h<r.lights.length;h++)this._lightSources.push(new nt(r.lights[h]));else o||R(this,"lights");if(this._blinkerDescriptors=o&&!r.blinkers?o._blinkerDescriptors:[],r.blinkers)for(h=0;h<r.blinkers.length;h++)this._blinkerDescriptors.push(new ot(r.blinkers[h]));else o||R(this,"blinkers");this._scoreValue=o?r.scoreValue||o._scoreValue:r.scoreValue||R(this,"scoreValue")||0},rt.prototype._loadData=function(t){var e;return t.basedOn?(e=b(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t),!0},rt.prototype.getSpacecraftType=function(){return this._spacecraftType},rt.prototype.isFighterClass=function(){return this._spacecraftType.isFighterType()},rt.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this.getName()+_.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},rt.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this.getName()+_.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},rt.prototype.shouldShowInDatabase=function(){return this._showInDatabase},rt.prototype.getHitpoints=function(){return this._hitpoints},rt.prototype.getArmor=function(){return this._armor},rt.prototype.getFactionColor=function(){return this._factionColor},rt.prototype.getTurnStyle=function(){return this._turnStyle},rt.prototype.getAttackVector=function(){return this._attackVector},rt.prototype.getAttackVectorAngles=function(){return this._attackVectorAngles},rt.prototype.getAttackThresholdAngle=function(){return this._attackThresholdAngle},rt.prototype.getMass=function(){return this._mass},rt.prototype.getBodies=function(){return this._bodies},rt.prototype.getWeaponSlots=function(){return this._weaponSlots},rt.prototype.getThrusterSlots=function(){return this._thrusterSlots},rt.prototype.getEquipmentProfile=function(t){return this._equipmentProfiles[t]},rt.prototype.getEquipmentProfileNames=function(){return Object.keys(this._equipmentProfiles)},rt.prototype.getViews=function(){return this._views},rt.prototype.getView=function(t){var e;for(e=0;e<this._views.length;e++)if(this._views[e].getName()===t)return this._views[e];return null},rt.prototype.getExplosionClass=function(){return this._explosionClass},rt.prototype.getShowTimeRatioDuringExplosion=function(){return this._showTimeRatioDuringExplosion},rt.prototype.getDamageIndicators=function(){return this._damageIndicators},rt.prototype.getLightSources=function(){return this._lightSources},rt.prototype.getBlinkerDescriptors=function(){return this._blinkerDescriptors},rt.prototype.acquireResources=function(t){var e;for(F.prototype.acquireResources.call(this,t),this._explosionClass.acquireResources(),e=0;e<this._damageIndicators.length;e++)this._damageIndicators[e].explosionClass.acquireResources();for(e=0;e<this._blinkerDescriptors.length;e++)this._blinkerDescriptors[e].acquireResources();this._humSound&&C(this._humSound)},rt.prototype.handleGraphicsSettingsChanged=function(){var t;if(F.prototype.handleGraphicsSettingsChanged.call(this),this._blinkerDescriptors)for(t=0;t<this._blinkerDescriptors.length;t++)this._blinkerDescriptors[t].handleGraphicsSettingsChanged()},rt.prototype.hasHumSound=function(){return!!this._humSound},rt.prototype.createHumSoundClip=function(t){return this._humSound?v(this._humSound,!0,t):null},rt.prototype.getScoreValue=function(){return this._scoreValue},lt=new o.ResourceManager,{SHADER_VARIANT_INSTANCED_NAME:Lt,SOUND_EFFECT:Dt,ParticleEmitterType:ct,ObjectViewLookAtMode:_t,WeaponRotationStyle:dt,SpacecraftTurnStyle:gt,TexturedModelClass:F,getSkyboxClass:p,getBackgroundObjectClass:d,getDustCloudClass:g,getExplosionClass:f,getProjectileClass:m,getWeaponClass:y,getPropulsionClass:S,getJumpEngineClass:T,getSpacecraftType:E,getSpacecraftClass:b,getSpacecraftClassesInArray:M,getClassCategories:O,getClassNames:A,getClass:x,createClass:lt.createResource.bind(lt),EquipmentProfile:$,ObjectView:et,SceneView:it,requestLoad:at,handleGraphicsSettingsChanged:ht,executeForAllClasses:lt.executeForAllResources.bind(lt),renameClass:lt.renameResource.bind(lt),moveClassAfter:lt.moveResourceAfter.bind(lt)}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/scene/camera","armada/logic/classes"],function(t,e,i,s,n){"use strict";function o(){i.AsyncResource.call(this),this._configuration=null,this._settings=null}var r,a,h,l,u,c,_,p={};return p.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},p.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR3},DIRECTION:{name:"direction",type:e.VECTOR3}}},p.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:t.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:t.ScaleMode,optional:!0}}},p.TEXTURE_MAPPING={baseType:"array",elementType:e.VECTOR2,length:2},p.UI_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:p.TEXTURE_MAPPING,optional:!0},SIZE:{name:"size",type:e.VECTOR2},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},COLOR:{name:"color",type:e.COLOR4}}},p.UI_LAID_OUT_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:p.TEXTURE_MAPPING},LAYOUT:{name:"layout",type:p.LAYOUT_DESCRIPTOR},COLOR:{name:"color",type:e.COLOR4}}},p.TEXT_DESCRIPTOR={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR4},FONT_SIZE:{name:"fontSize",type:"number"},FONT_NAME:{name:"fontName",type:"string"},POSITION:{name:"position",type:e.VECTOR2},LAYOUT:{name:"layout",type:p.LAYOUT_DESCRIPTOR,optional:!0}}},p.CRAFT_INDICATOR_POSITIONS={baseType:"array",elementType:{baseType:"array",elementType:e.VECTOR2}},p.STRING_ARRAY={baseType:"array",elementType:"string"},p.getCustomDescriptor=function(e,i){var s,n,o,r,a=t.deepCopy(e);for(o=Object.keys(i),s=0;s<o.length;s++){for(r=a.properties[o[s]],a.properties[o[s]+"S"]={name:r.name+"s",type:{baseType:"object",properties:{}}},n=0;n<i[o[s]].length;n++)a.properties[o[s]+"S"].type.properties[i[o[s]][n].toUpperCase()]={name:i[o[s]][n],type:r.type};delete a.properties[o[s]]}return a},r={CLASSES_SOURCE_FILE:{name:"classes",type:p.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:p.FILE_DESCRIPTOR},MISSION_FILES:{name:"missions",type:{baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}}}},a={USE_REQUEST_ANIM_FRAME:{name:"useRequestAnimFrame",type:"boolean",defaultValue:!0},DEFAULT_RANDOM_SEED:{name:"defaultRandomSeed",type:"number",defaultValue:4718},UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME:{name:"luminosityFactorsArrayName",type:"string",defaultValue:"luminosityFactors"},UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},USE_VERTICAL_CAMERA_VALUES:{name:"useVerticalCameraValues",type:"boolean",defaultValue:!0},MENU_MUSIC:{name:"menuMusic",type:"string"},MUSIC_FADE_IN_DURATION:{name:"musicFadeInDuration",type:"number"},THEME_CROSSFADE_DURATION:{name:"themeCrossfadeDuration",type:"number"},MUSIC_FADE_OUT_DURATION:{name:"musicFadeOutDuration",type:"number"},BUTTON_SELECT_SOUND:{name:"buttonSelectSound",type:n.SOUND_EFFECT},BUTTON_CLICK_SOUND:{name:"buttonClickSound",type:n.SOUND_EFFECT}},h={SHOW_LOADING_BOX_FIRST_TIME:{name:"showLoadingBoxFirstTime",type:"boolean",defaultValue:!0},SHOW_LOADING_BOX_ON_ITEM_CHANGE:{name:"showLoadingBoxOnItemChange",type:"boolean",defaultValue:!0},BACKGROUND_COLOR:{name:"backgroundColor",type:e.COLOR4,defaultValue:[0,0,0,0]},ITEM_VIEW_DISTANCE:{name:"itemViewDistance",type:"number",defaultValue:2e3},ITEM_VIEW_FOV:{name:"itemViewFOV",type:"number",defaultValue:60},ITEM_VIEW_SPAN:{name:"itemViewSpan",type:"number",defaultValue:.2},SHOW_WIREFRAME_MODEL:{name:"showWireframeModel",type:"boolean",defaultValue:!0},WIREFRAME_SHADER_NAME:{name:"wireframeShaderName",type:"string",defaultValue:"oneColorReveal"},WIREFRAME_COLOR:{name:"wireframeColor",type:e.COLOR4,defaultValue:[1,0,0,1]},SHOW_SOLID_MODEL:{name:"showSolidModel",type:"boolean",defaultValue:!0},SOLID_SHADER_NAME:{name:"solidShaderName",type:"string",defaultValue:"shadowMapReveal"},LIGHT_SOURCES:{name:"lightSources",type:"array",elementType:p.LIGHT_SOURCE,minLength:1,maxLength:2},EQUIPMENT_PROFILE_NAME:{name:"equipmentProfileName",type:"string",defaultValue:"default"},START_SIZE_FACTOR:{name:"startSizeFactor",type:"number",defaultValue:"1"},MIN_SIZE_FACTOR:{name:"minimumSizeFactor",type:"number",defaultValue:"0.9"},MAX_SIZE_FACTOR:{name:"maximumSizeFactor",type:"number",defaultValue:"1.6"},MODEL_AUTO_ROTATION:{name:"modelAutoRotation",type:"boolean",defaultValue:!0},MODEL_MOUSE_ROTATION:{name:"modelMouseRotation",type:"boolean",defaultValue:!0},ROTATION_FPS:{name:"rotationFPS",type:"number",defaultValue:60},ROTATION_REVEAL_START_ANGLE:{name:"rotationRevealStartAngle",type:e.ANGLE_DEGREES,defaultValue:90},ROTATION_START_ANGLE:{name:"rotationStartAngle",type:e.ANGLE_DEGREES,defaultValue:180},ROTATION_VIEW_ANGLE:{name:"rotationViewAngle",type:e.ANGLE_DEGREES,defaultValue:60},ROTATION_DURATION:{name:"rotationDuration",type:"number",defaultValue:4e3},ROTATION_MOUSE_SENSITIVITY:{name:"rotationMouseSensitivity",type:"number",defaultValue:1},MODEL_REVEAL_ANIMATION:{name:"modelRevealAnimation",type:"boolean",defaultValue:!0},REVEAL_COLOR:{name:"revealColor",type:e.COLOR4,defaultValue:[1,1,1,1]},REVEAL_FPS:{name:"revealFPS",type:"number",defaultValue:60},REVEAL_DURATION:{name:"revealDuration",type:e.DURATION,defaultValue:2e3},REVEAL_SOLID_DELAY_DURATION:{name:"revealSolidDelayDuration",type:e.DURATION,defaultValue:2e3},REVEAL_TRANSITION_LENGTH_FACTOR:{name:"revealTransitionLengthFactor",type:"number",defaultValue:.15},RENDER_FPS:{name:"databaseRenderFPS",type:"number",defaultValue:60}},l={RENDER_FPS:{name:"battleRenderFPS",type:"number",defaultValue:60},SIMULATION_STEPS_PER_SECOND:{name:"simulationStepsPerSecond",type:"number",defaultValue:60},MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumDustParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumExplosionParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumMuzzleFlashParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING:{name:"minimumProjectileCountForInstancing",type:"number",defaultValue:1},MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumThrusterParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumBlinkerParticleCountForInstancing",type:"number",defaultValue:1},VIEW_DISTANCE:{name:"viewDistance",type:"number",defaultValue:5e3},MOVE_TO_ORIGO_DISTANCE:{name:"moveToOrigoDistance",type:"number"},CAMERA_DEFAULT_TRANSITION_DURATION:{name:"cameraDefaultTransitionDuration",type:"number",defaultValue:1e3},CAMERA_DEFAULT_TRANSITION_STYLE:{name:"cameraDefaultTransitionStyle",type:"enum",values:s.Camera.prototype.TransitionStyle,defaultValue:s.Camera.prototype.TransitionStyle.SMOOTH},CAMERA_PILOTING_SWITCH_TRANSITION_DURATION:{name:"cameraPilotingSwitchTransitionDuration",type:"number",defaultValue:1e3},CAMERA_PILOTING_SWITCH_TRANSITION_STYLE:{name:"cameraPilotingSwitchTransitionStyle",type:"enum",values:s.Camera.prototype.TransitionStyle,defaultValue:s.Camera.prototype.TransitionStyle.SMOOTH},MOMENT_DURATION:{name:"momentDuration",type:e.DURATION,defaultValue:1},BACKGROUND_OBJECT_DISTANCE:{name:"backgroundObjectDistance",type:"number",defaultValue:4500},TURN_ACCELERATION_DURATION_S:{name:"turnAccelerationDurationInSeconds",type:e.DURATION},MAX_COMBAT_FORWARD_SPEED_FACTOR:{name:"maxCombatForwardSpeedFactor",type:"number"},MAX_COMBAT_REVERSE_SPEED_FACTOR:{name:"maxCombatReverseSpeedFactor",type:"number"},MAX_CRUISE_FORWARD_SPEED_FACTOR:{name:"maxCruiseForwardSpeedFactor",type:"number"},MAX_CRUISE_REVERSE_SPEED_FACTOR:{name:"maxCruiseReverseSpeedFactor",type:"number"},STRAFE_SPEED_FACTOR:{name:"strafeSpeedFactor",type:"number"},DEFAULT_MUZZLE_FLASH_DURATION:{name:"defaultMuzzleFlashDuration",type:e.DURATION,defaultValue:500},SELF_FIRE:{name:"selfFire",type:"boolean",defaultValue:!0},DEFAULT_EQUIPMENT_PROFILE_NAME:{name:"defaultEquipmentProfileName",type:"string",defaultValue:"default"},HITBOX_COLOR:{name:"hitboxColor",type:e.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},SHOW_HITBOXES_FOR_HITCHECKS:{name:"showHitboxesForHitchecks",type:"boolean"},TARGET_VIEW_NAME:{name:"targetViewName",type:"string",defaultValue:"target"},TARGET_CHANGE_TRANSITION_DURATION:{name:"targetChangeTransitonDuration",type:e.DURATION,defaultValue:300},TARGET_CHANGE_TRANSITION_STYLE:{name:"targetChangeTransitionStyle",type:"enum",values:s.Camera.prototype.TransitionStyle},TARGET_ORDER_DURATION:{name:"targetOrderDuration",type:"number"},JUMP_PREPARE_VIEW_NAME:{name:"jumpPrepareViewName",type:"string"},JUMP_OUT_VIEW_NAME:{name:"jumpOutViewName",type:"string"},GAME_STATE_DISPLAY_DELAY:{name:"gameStateDisplayDelay",type:"number"},QUIT_DELAY_AFTER_JUMP_OUT:{name:"quitDelayAfterJumpOut",type:"number"},HUD:{name:"hud",TARGET_SWITCH_ANIMATION_DURATION:{name:"targetSwitchAnimationDuration",type:"number"},AIM_ASSIST_APPEAR_ANIMATION_DURATION:{name:"aimAssistAppearAnimationDuration",type:"number"},HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"hullIntegrityDecreaseAnimationDuration",type:"number"},TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"targetHullIntegrityDecreaseAnimationDuration",type:"number"},SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL:{name:"shipIndicatorHighlightAnimationInterval",type:"number"},CENTER_CROSSHAIR:{name:"centerCrosshair",type:p.UI_IMAGE_DESCRIPTOR},CURSOR:{name:"cursor",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{MAPPING:["still","turn"]})},SHIP_ARROW:{name:"shipArrow",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget"],SIZE:["default","target"]})},SHIP_ARROW_POSITION_RADIUS:{name:"shipArrowPositionRadius",type:"number"},TARGET_ARROW_SWITCH_SCALE:{name:"targetArrowSwitchScale",type:"number"},SHIP_INDICATOR:{name:"shipIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget"],SIZE:["minimum","targetMinimum","maximum"]})},SHIP_INDICATOR_SIZE_FACTOR:{name:"shipIndicatorSizeFactor",type:"number"},TARGET_INDICATOR_SWITCH_SCALE:{name:"targetIndicatorSwitchScale",type:"number"},DISTANCE_TEXT_LAYER_LAYOUT:{name:"distanceTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},DISTANCE_TEXT:{name:"distanceText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"]})},AIM_ASSIST_INDICATOR:{name:"aimAssistIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","appear"]})},AIM_ASSIST_INDICATOR_APPEAR_SCALE:{name:"aimAssistIndicatorAppearScale",type:"number"},WEAPON_IMPACT_INDICATOR:{name:"weaponImpactIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["normal","outOfRange"]})},WEAPON_IMPACT_INDICATOR_SWITCH_SCALE:{name:"weaponImpactIndicatorSwitchScale",type:"number"},TARGET_VIEW_LAYOUT:{name:"targetViewLayout",type:p.LAYOUT_DESCRIPTOR},TARGET_VIEW_VIEW_DISTANCE:{name:"targetViewViewDistance",type:"number"},TARGET_VIEW_FOV:{name:"targetViewFOV",type:"number"},TARGET_VIEW_TARGET_ITEM_SHADER:{name:"targetViewTargetItemShader",type:"string"},TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"targetViewTargetItemFullIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"targetViewTargetItemHalfIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"targetViewTargetItemZeroIntegrityColor",type:e.COLOR4},TARGET_INFO_BACKGROUND:{name:"targetInfoBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},TARGET_HULL_INTEGRITY_BAR:{name:"targetHullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"targetInfoTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},TARGET_INFO_TEXT:{name:"targetInfoText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"],FONT_SIZE:["name","others"],POSITION:["name","class","team","firepower","distance","velocity"]})},WINGMEN_STATUS_BACKGROUND:{name:"wingmenStatusBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},WINGMEN_STATUS_HEADER_TEXT:{name:"wingmenStatusHeaderText",type:p.TEXT_DESCRIPTOR},WINGMEN_STATUS_CRAFT_INDICATOR:{name:"wingmenStatusCraftIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{MAPPING:["player","general","interceptor","bomber"],COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed","away"]})},WINGMEN_STATUS_CRAFT_POSITIONS:{name:"wigmenStatusCraftPositions",type:p.CRAFT_INDICATOR_POSITIONS},WINGMEN_STATUS_SQUAD_LAYOUT:{name:"wigmenStatusSquadLayout",type:p.LAYOUT_DESCRIPTOR},WINGMEN_STATUS_SQUAD_TEXT:{name:"wingmenStatusSquadText",type:p.TEXT_DESCRIPTOR},SPEED_BAR:{name:"speedBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","reverseFilled","reverseEmpty"]})},SPEED_BAR_BASE_MAX_SPEED_FACTOR:{name:"speedBarBaseMaxSpeedFactor",type:"number"},SPEED_BAR_DEFAULT_BASE_MAX_SPEED:{name:"speedBarDefaultBaseMaxSpeed",type:"number"},SPEED_BAR_MAX_SPEED_STEP_FACTOR:{name:"speedBarMaxSpeedStepFactor",type:"number"},SPEED_BAR_MAX_SPEED_STEP_BUFFER:{name:"speedBarMaxSpeedStepBuffer",type:"number"},SPEED_TEXT_LAYER_LAYOUT:{name:"speedTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SPEED_TEXT:{name:"speedText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["forward","reverse"],POSITION:["maxForward","maxReverse"]})},SPEED_TARGET_INDICATOR:{name:"speedTargetIndicator",type:p.UI_IMAGE_DESCRIPTOR},HULL_INTEGRITY_BAR:{name:"hullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},FLIGHT_MODE_INDICATOR_BACKGROUND:{name:"flightModeIndicatorBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},FLIGHT_MODE_HEADER_TEXT:{name:"flightModeHeaderText",type:p.TEXT_DESCRIPTOR},FLIGHT_MODE_TEXT:{name:"flightModeText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["free","combat","cruise"]})},DRIFT_ARROW:{name:"driftArrow",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["minSpeed","maxSpeed"]})},DRIFT_ARROW_POSITION_RADIUS:{name:"driftArrowPositionRadius",type:"number"},DRIFT_ARROW_MIN_SPEED:{name:"driftArrowMinSpeed",type:"number"},DRIFT_ARROW_MAX_SPEED_FACTOR:{name:"driftArrowMaxSpeedFactor",type:"number"},TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR:{name:"targetHullIntegrityQuickViewBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["hostileFilled","hostileEmpty","friendlyFilled","friendlyEmpty","filledWhenDecreasing"]})},HEADER_TEXT_LAYER_LAYOUT:{name:"headerTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SMALL_HEADER_TEXT:{name:"smallHeaderText",type:p.TEXT_DESCRIPTOR},BIG_HEADER_TEXT:{name:"bigHeaderText",type:p.TEXT_DESCRIPTOR},SUBHEADER_TEXT:{name:"subheaderText",type:p.TEXT_DESCRIPTOR},MESSAGE_BACKGROUND:{name:"messageBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},MESSAGE_TEXT:{name:"messageText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["default","jump","alert","controlString"]})},MESSAGE_TEXT_MARGIN:{name:"messageTextMargin",type:"number"},TOP_LEFT_TEXT_LAYER_LAYOUT:{name:"topLeftTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SCORE_TEXT:{name:"scoreText",type:p.TEXT_DESCRIPTOR},OBJECTIVES_BACKGROUND:{name:"objectivesBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},OBJECTIVES_HEADER_TEXT:{name:"objectivesHeaderText",type:p.TEXT_DESCRIPTOR},OBJECTIVES_TEXT:{name:"objectivesText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["inProgress","completed","failed"]})},OBJECTIVES_TEXT_OFFSET:{name:"objectivesTextOffset",type:"number"},MAX_OBJECTIVES_DISPLAYED:{name:"maxObjectivesDisplayed",type:"number"},ESCORTS_BACKGROUND:{name:"escortsBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},ESCORTS_HEADER_TEXT:{name:"escortsHeaderText",type:p.TEXT_DESCRIPTOR},ESCORTS_TEXT:{name:"escortsText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["alive","away","destroyed"]})},ESCORTS_HULL_INTEGRITY_BAR:{name:"escortsHullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed"]})},ESCORTS_TEXT_OFFSET:{name:"escortsTextOffset",type:"number"},MAX_ESCORTS_DISPLAYED:{name:"maxEscortsDisplayed",type:"number"},TARGET_SWITCH_SOUND:{name:"targetSwitchSound",type:n.SOUND_EFFECT},TARGET_SWITCH_DENIED_SOUND:{name:"targetSwitchDeniedSound",type:n.SOUND_EFFECT},FLIGHT_MODE_SWITCH_SOUND:{name:"flightModeSwitchSound",type:n.SOUND_EFFECT},MESSAGE_SOUND:{name:"messageSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_SOUND:{name:"newHostilesAlertSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_DURATION:{name:"newHostilesAlertDuration",type:"number"},NEW_HOSTILES_ALERT_BLINK_INTERVAL:{name:"newHostilesAlertBlinkInterval",type:"number"}},WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE:{name:"weaponFireSoundStackMinimumDistance",type:"number"},HIT_SOUND_STACKING_TIME_THRESHOLD:{name:"hitSoundStackingTimeThreshold",type:"number"},HIT_SOUND_STACKING_VOLUME_FACTOR:{name:"hitSoundStackingVolumeFactor",type:"number"},FIRE_SOUND_STACKING_TIME_THRESHOLD:{name:"fireSoundStackingTimeThreshold",type:"number"},FIRE_SOUND_STACKING_VOLUME_FACTOR:{name:"fireSoundStackingVolumeFactor",type:"number"},DEMO_FIGHTER_AI_TYPE:{name:"demoFighterAI",type:"string"},DEMO_SHIP_AI_TYPE:{name:"demoShipAI",type:"string"},DEMO_VIEW_SWITCH_INTERVAL:{name:"demoViewSwitchInterval",type:"number"},DEMO_DOUBLE_VIEW_SWITCH_CHANCE:{name:"demoDoubleViewSwitchChance",type:"number"},MUSIC_VOLUME_IN_MENUS:{name:"musicVolumeInMenus",type:"number"},SFX_VOLUME_IN_MENUS:{name:"sfxVolumeInMenus",type:"number"},AMBIENT_MUSIC:{name:"ambientMusic",type:"string"},ANTICIPATION_MUSIC:{name:"anticipationMusic",type:"string"},COMBAT_MUSIC:{name:"combatMusic",type:p.STRING_ARRAY},VICTORY_MUSIC:{name:"victoryMusic",type:"string"},DEFEAT_MUSIC:{name:"defeatMusic",
type:"string"},DEBRIEFING_VICTORY_MUSIC:{name:"debriefingVictoryMusic",type:"string"},DEBRIEFING_DEFEAT_MUSIC:{name:"debriefingDefeatMusic",type:"string"},COMBAT_THEME_DURATION_AFTER_FIRE:{name:"combatThemeDurationAfterFire",type:"number"},END_THEME_CROSSFADE_DURATION:{name:"endThemeCrossfadeDuration",type:"number"},DEBRIEFING_THEME_FADE_IN_DURATION:{name:"debriefingThemeFadeInDuration",type:"number"},SCORE_FRACTION_FOR_KILL:{name:"scoreFractionForKill",type:{baseType:"number",range:[0,1]}},SCORE_BONUS_FOR_HULL_INTEGRITY:{name:"scoreBonusForHullIntegrity",type:"number"},SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM:{name:"scoreBonusForHullIntegrityTeam",type:"number"},SCORE_BONUS_FOR_TEAM_SURVIVAL:{name:"scoreBonusForTeamSurvival",type:"number"}},u={DEFAULT_FOV:{name:"defaultFOV",type:"number"},DEFAULT_FOV_RANGE:{name:"defaultFOVRange",type:e.VECTOR2},DEFAULT_SPAN:{name:"defaultSpan",type:"number"},DEFAULT_SPAN_RANGE:{name:"defaultSpanRange",type:e.VECTOR2},DEFAULT_BASE_ORIENTATION:{name:"defaultBaseOrientation",type:"enum",values:s.CameraOrientationConfiguration.prototype.BaseOrientation},DEFAULT_POINT_TO_FALLBACK:{name:"defaultPointToFallback",type:"enum",values:s.CameraOrientationConfiguration.prototype.PointToFallback}},c={DEFAULT_PARTICLE_SHADER:{name:"defaultParticleShader",type:"string"}},Object.freeze(p),o.prototype=new i.AsyncResource,o.prototype.constructor=o,o.prototype.loadConfigurationFromJSON=function(t){this._configuration=e.getVerifiedObject("configuration",t,r)},o.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},o.prototype.getSetting=function(t){return this._settings[t.name]},o.prototype.getHUDSetting=function(t){return this._settings[l.HUD.name][t.name]},o.prototype.getDefaultCameraFOV=function(){return this.getSetting(u.DEFAULT_FOV)},o.prototype.getDefaultCameraFOVRange=function(){return this.getSetting(u.DEFAULT_FOV_RANGE)},o.prototype.getDefaultCameraSpan=function(){return this.getSetting(u.DEFAULT_SPAN)},o.prototype.getDefaultCameraSpanRange=function(){return this.getSetting(u.DEFAULT_SPAN_RANGE)},o.prototype.getDefaultCameraBaseOrientation=function(){return this.getSetting(u.DEFAULT_BASE_ORIENTATION)},o.prototype.getDefaultCameraPointToFallback=function(){return this.getSetting(u.DEFAULT_POINT_TO_FALLBACK)},o.prototype.loadSettingsFromJSON=function(t){this._settings=e.getVerifiedObject("general",t.general,a),e.getVerifiedObject("database",t.database,h,this._settings),e.getVerifiedObject("battle",t.battle,l,this._settings),e.getVerifiedObject("camera",t.camera,u,this._settings),e.getVerifiedObject("editor",t.editor,c,this._settings),n.requestLoad(this.getConfigurationSetting(r.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},_=new o,{CONFIGURATION:r,GENERAL_SETTINGS:a,BATTLE_SETTINGS:l,DATABASE_SETTINGS:h,CAMERA_SETTINGS:u,EDITOR_SETTINGS:c,loadConfigurationFromJSON:_.loadConfigurationFromJSON.bind(_),loadSettingsFromJSON:_.loadSettingsFromJSON.bind(_),getConfigurationSetting:_.getConfigurationSetting.bind(_),getSetting:_.getSetting.bind(_),getHUDSetting:_.getHUDSetting.bind(_),getDefaultCameraFOV:_.getDefaultCameraFOV.bind(_),getDefaultCameraFOVRange:_.getDefaultCameraFOVRange.bind(_),getDefaultCameraSpan:_.getDefaultCameraSpan.bind(_),getDefaultCameraSpanRange:_.getDefaultCameraSpanRange.bind(_),getDefaultCameraBaseOrientation:_.getDefaultCameraBaseOrientation.bind(_),getDefaultCameraPointToFallback:_.getDefaultCameraPointToFallback.bind(_),executeWhenReady:_.executeWhenReady.bind(_)}}),define("armada/audio",["utils/types","modules/application","modules/async-resource","modules/audio","modules/media-resources","armada/constants","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){i.AsyncResource.call(this),this._dataJSON=null,this._masterVolume=1,this._musicVolume=1,this._sfxVolume=1,this._uiVolume=1,this._rolloffFactor=0,this._panningModel=null}function h(t,i,s){var o;b[i]&&b[i].name===t||(o=n.getMusic(t),o&&!o.hasError()?n.executeWhenReady(function(){b[i]={name:t,clip:o.createSoundClip(1,s)}}):e.log("Could not initialize music from resource '"+t+"' for theme ID '"+i+"'!"))}function l(t,i,s){void 0===s&&(s=E?t?_:p:t?c:0),t!==E&&(E&&b[E]&&(s>0?b[E].clip.rampVolume(0,s):b[E].clip.stopPlaying()),t&&(b[t]?(b[t].clip.play(!0,i?function(){E===t&&l(i,null,s)}:null),s>0?(b[t].clip.setVolume(0),b[t].clip.rampVolume(1,s)):b[t].clip.setVolume(1)):e.log("Warning: music associated with theme '"+t+"' cannot be played, because it is not loaded!")),E=t)}function u(){var t,e=Object.keys(b);for(t=0;t<e.length;t++)b[e[t]]&&b[e[t]].clip.stopPlaying();E=null}var c,_,p,d,g=o.LOCAL_STORAGE_PREFIX+"audio_",f=.1,m=g+"masterVolume",y=g+"musicVolume",S=g+"sfxVolume",T=g+"uiVolume",E=null,b={};return a.prototype=new i.AsyncResource,a.prototype.constructor=a,a.prototype.loadConfigurationFromJSON=function(e){e.rolloffFactor&&(this._rolloffFactor=t.getNumberValue("configuration.audio.rolloffFactor",e.rolloffFactor,0)),e.panningModel&&(this._panningModel=t.getEnumValue(s.PanningModel,e.panningModel,{name:"configuration.audio.panningModel"}))},a.prototype.loadSettingsFromJSON=function(i,s){return"object"!=typeof i?void e.showError("Cannot initialize audio settings from JSON: audio section missing or has wrong type ('"+typeof i+"')!"):(s=s||!1,s||(this._dataJSON=i),this.setMasterVolume(t.getNumberValue("settings.audio.masterVolume",i.masterVolume,1),!1),this.setMusicVolume(t.getNumberValue("settings.audio.musicVolume",i.musicVolume,1),!1),this.setSFXVolume(t.getNumberValue("settings.audio.sfxVolume",i.sfxVolume,1),!1),void this.setUIVolume(t.getNumberValue("settings.audio.uiVolume",i.uiVolume,1),!1))},a.prototype.loadFromLocalStorage=function(){var i,s,n=function(n,o,r,a){void 0!==localStorage[n]&&(s={silentFallback:e.hasVersionChanged(),defaultValue:r},i=t.getValueOfTypeFromLocalStorage(o,n,s),(!s.error||e.hasVersionChanged())&&a(i,!!s.error&&s.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};n(m,"number",this.getMasterVolume(),this.setMasterVolume.bind(this)),n(y,"number",this.getMusicVolume(),this.setMusicVolume.bind(this)),n(S,"number",this.getSFXVolume(),this.setSFXVolume.bind(this)),n(T,"number",this.getUIVolume(),this.setUIVolume.bind(this)),this.setToReady()},a.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(m),localStorage.removeItem(y),localStorage.removeItem(S),localStorage.removeItem(T)},a.prototype.getMasterVolume=function(){return this._masterVolume},a.prototype.setMasterVolume=function(t,e){return void 0===e&&(e=!0),this._masterVolume=t,s.setMasterVolume(this._masterVolume),e&&(localStorage[m]=t.toString()),this._masterVolume===t},a.prototype.resetMasterVolume=function(){this.setMasterVolume(void 0!==localStorage[m]?localStorage[m]:this._dataJSON.masterVolume)},a.prototype.getMusicVolume=function(){return this._musicVolume},a.prototype.setMusicVolume=function(t,e){return void 0===e&&(e=!0),this._musicVolume=t,s.setMusicVolume(this._musicVolume),e&&(localStorage[y]=t.toString()),this._musicVolume===t},a.prototype.resetMusicVolume=function(){this.setMusicVolume(void 0!==localStorage[y]?localStorage[y]:this._dataJSON.musicVolume)},a.prototype.getSFXVolume=function(){return this._sfxVolume},a.prototype.setSFXVolume=function(t,e){return void 0===e&&(e=!0),this._sfxVolume=t,s.setEffectVolume(this._sfxVolume),e&&(localStorage[S]=t.toString()),this._sfxVolume===t},a.prototype.resetSFXVolume=function(){this.setSFXVolume(void 0!==localStorage[S]?localStorage[S]:this._dataJSON.sfxVolume)},a.prototype.getUIVolume=function(){return this._uiVolume},a.prototype.setUIVolume=function(t,e){return void 0===e&&(e=!0),this._uiVolume=t,s.setUIVolume(this._uiVolume),e&&(localStorage[T]=t.toString()),this._uiVolume===t},a.prototype.resetUIVolume=function(){this.setUIVolume(void 0!==localStorage[T]?localStorage[T]:this._dataJSON.uiVolume)},a.prototype.createSoundSource=function(t){return new s.SoundSource(t,this._rolloffFactor,this._panningModel)},d=new a,r.executeWhenReady(function(){c=r.getSetting(r.GENERAL_SETTINGS.MUSIC_FADE_IN_DURATION),_=r.getSetting(r.GENERAL_SETTINGS.THEME_CROSSFADE_DURATION),p=r.getSetting(r.GENERAL_SETTINGS.MUSIC_FADE_OUT_DURATION)}),{SOUND_RAMP_DURATION:f,SoundCategory:s.SoundCategory,loadConfigurationFromJSON:d.loadConfigurationFromJSON.bind(d),loadSettingsFromJSON:d.loadSettingsFromJSON.bind(d),loadSettingsFromLocalStorage:d.loadFromLocalStorage.bind(d),restoreDefaults:d.restoreDefaults.bind(d),getMasterVolume:d.getMasterVolume.bind(d),setMasterVolume:d.setMasterVolume.bind(d),resetMasterVolume:d.resetMasterVolume.bind(d),getMusicVolume:d.getMusicVolume.bind(d),setMusicVolume:d.setMusicVolume.bind(d),resetMusicVolume:d.resetMusicVolume.bind(d),getSFXVolume:d.getSFXVolume.bind(d),setSFXVolume:d.setSFXVolume.bind(d),resetSFXVolume:d.resetSFXVolume.bind(d),getUIVolume:d.getUIVolume.bind(d),setUIVolume:d.setUIVolume.bind(d),resetUIVolume:d.resetUIVolume.bind(d),createSoundSource:d.createSoundSource.bind(d),executeWhenReady:d.executeWhenReady.bind(d),initMusic:h,playMusic:l,stopMusic:u}}),define("armada/logic/environments",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/logic/classes","armada/configuration","armada/strings","utils/polyfill"],function(t,e,i,s,n,o,r,a,h,l,u,c,_){"use strict";function p(){return b}function d(t){this._class=t}function g(t,e,i,s,n){this._class=t,this._size=e,this._direction=[Math.cos(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(s))],this._angle=Math.radians(n)||0}function f(t,e){this._positionVector=e,this._visualModel=null,this._cloud=t,this._range=t.getRange()}function m(t){this._class=t,this._particles=null,this._visualModel=null}function y(t){this._name=null,this._location=null,this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._camera=null,this._dataJSON=null,void 0!==t&&this.loadFromJSON(t)}function S(){n.AsyncResource.call(this),this._environments=null}var T,E="environments",b="";return d.prototype.addToScene=function(t){this._class.acquireResources(),o.executeWhenReady(function(){t.addBackgroundObject(new r.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(l.getCubemapQualityPreferenceList()),t.getCamera()))}.bind(this))},d.prototype.destroy=function(){this._class=null},g.prototype.addToScene=function(t){t.addDirectionalLightSource(new a.DirectionalLightSource(this._class.getLightColor(),this._direction)),this._class.acquireResources(),o.executeWhenReady(function(){var s,n,o;for(n=this._class.getLayers(),s=0;s<n.length;s++)o=new r.BackgroundBillboard(n[s].getModel(),n[s].getShader(),n[s].getTexturesOfTypes(n[s].getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),n[s].getColor(),n[s].getSize()*this._size,i.translation4v(e.scaled3(this._direction,c.getSetting(c.BATTLE_SETTINGS.BACKGROUND_OBJECT_DISTANCE))),this._angle),o.setRelativeSize(1),t.addBackgroundObject(o)}.bind(this))},g.prototype.destroy=function(){this._class=null,this._direction=null},f.prototype.addToScene=function(t,e){this._visualModel=new r.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass().getColor():null,e?this._range:null),t.addSubnode(new h.RenderableNode(this._visualModel,!1,c.getSetting(c.BATTLE_SETTINGS.MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING)))},f.prototype.getVisualModel=function(){return this._visualModel},f.prototype.simulate=function(t){this._visualModel.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},f.prototype.destroy=function(){this._positionVector=null,this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null),this._cloud=null},m.prototype.getClass=function(){return this._class},m.prototype.getColor=function(){return this._class.getColor().concat(1)},m.prototype.getRange=function(){return this._class.getRange()},m.prototype.addToScene=function(t){var e,i,s;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;i>e;e++)s=new f(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(s);o.executeWhenReady(function(){var e,s;for(this._visualModel=new r.RenderableObject(null,!1,!1,void 0,!1),s=t.addNode(new h.RenderableNode(this._visualModel,!0)),e=0;i>e;e++)this._particles[e].addToScene(s,0===e)}.bind(this))},m.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0]._visualModel.setShift(t.getVelocityVector()[0],t.getVelocityVector()[1],t.getVelocityVector()[2]),e=0;i>e;e++)this._particles[e].simulate(t)},m.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;e>t;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null)},y.prototype.loadFromJSON=function(t){var e,i;for(this._dataJSON=t,this._name=t.name,this._location=t.location,this._skyboxes=[],e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new d(u.getSkyboxClass(t.skyboxes[e]["class"])));for(this._backgroundObjects=[],e=0;e<t.backgroundObjects.length;e++)i=u.getBackgroundObjectClass(t.backgroundObjects[e]["class"]),t.backgroundObjects[e].position||s.showError("No position specified for background object of class '"+i.getName()+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR),this._backgroundObjects.push(new g(i,t.backgroundObjects[e].size||s.showError("No size specified for background object of class '"+i.getName()+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR)||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleAlpha||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleBeta||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleGamma||0));for(this._dustClouds=[],e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new m(u.getDustCloudClass(t.dustClouds[e]["class"])))},y.prototype.getDisplayName=function(){return this._location?t.formatString(_.get(_.LOCATION.SYSTEM),{systemName:this._location}):_.get(_.LOCATION.UNKNOWN)},y.prototype.getData=function(){return this._dataJSON},y.prototype.reloadData=function(){this.loadFromJSON(this._dataJSON)},y.prototype.addToScene=function(t){var e;for(e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);this._camera=t.getCamera()},y.prototype.simulate=function(){var t;if(this._camera)for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera)},y.prototype.removeFromScene=function(){this._camera=null},y.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}this._camera=null},S.prototype=new n.AsyncResource,S.prototype.constructor=S,S.prototype.getEnvironment=function(t){return this._environments[t]||null},S.prototype.getEnvironmentNames=function(){return Object.keys(this._environments)},S.prototype.createEnvironment=function(t){this._environments[t.name]=new y(t)},S.prototype.executeForAllEnvironments=function(t){var e,i=this.getEnvironmentNames();for(e=0;e<i.length;e++)t(this._environments[i[e]],E)},S.prototype.requestLoad=function(){s.requestTextFile(c.getConfigurationSetting(c.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,c.getConfigurationSetting(c.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},S.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new y(t.environments[e]),this._environments[t.environments[e].name]=i},T=new S,{requestLoad:T.requestLoad.bind(T),executeWhenReady:T.executeWhenReady.bind(T),getDebugInfo:p,getEnvironment:T.getEnvironment.bind(T),getEnvironmentNames:T.getEnvironmentNames.bind(T),createEnvironment:T.createEnvironment.bind(T),executeForAllEnvironments:T.executeForAllEnvironments.bind(T),Skybox:d,Environment:y}}),define("modules/pools",[],function(){"use strict";function t(t){this._objectConstructor=t,this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function e(e){var s=i[e.name]||new t(e);return i[e.name]=s,s}var i={};return t.prototype.markAsFree=function(t){this._objectsFree[t]||(this._freeIndices[this._firstLockedIndex]=t,this._objectsFree[t]=!0,this._firstLockedIndex++,this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},t.prototype.getFreeObject=function(){var t;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,t=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),t):null},t.prototype.addObject=function(t){this._objects.push(t),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},t.prototype.getObjects=function(){return this._objects},t.prototype.getObject=function(){var t=this.getFreeObject();return t||(t=new this._objectConstructor,this.addObject(t)),t},t.prototype.hasLockedObjects=function(){return this._firstFreeIndex!==this._firstLockedIndex||!this._objectsFree[this._freeIndices[this._firstFreeIndex]]},t.prototype.getLockedObjectCount=function(){return this._firstFreeIndex===this._firstLockedIndex?this._objectsFree[this._freeIndices[this._firstFreeIndex]]?0:this._objects.length:this._firstFreeIndex<this._firstLockedIndex?this._objects.length-(this._firstLockedIndex-this._firstFreeIndex):this._firstFreeIndex-this._firstLockedIndex},t.prototype.executeForLockedObjects=function(t){var e,i=this._freeIndices.length;if(i>0)for(e=0;i>e;e++)this._objectsFree[e]||t(this._objects[e],e)},t.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},{Pool:t,getPool:e}}),define("armada/logic/SpacecraftEvents",[],function(){"use strict";return{BEING_TARGETED:"beingTargeted",BEING_HIT:"beingHit",TARGET_HIT:"targetHit",ANY_SPACECRAFT_HIT:"anySpacecraftHit",TARGET_FIRED:"targetFired",FIRED:"fired",DESTRUCTED:"destructed",JUMP_ENGAGED:"jumpEngaged",PREPARING_JUMP:"preparingJump",JUMP_OUT_STARTED:"jumpOutStarted",JUMPED_OUT:"jumpedOut",JUMPED_IN:"jumpedIn",ARRIVED:"arrived",JUMP_CANCELLED:"jumpCancelled",COMMAND_RECEIVED:"commandReceived"}}),define("armada/logic/constants",[],function(){"use strict";var t=0,e=1,i=2,s=3;return{SPACECRAFT_LIGHT_PRIORITY:t,EXPLOSION_LIGHT_PRIORITY:e,PROJECTILE_LIGHT_PRIORITY:i,BLINKER_LIGHT_PRIORITY:s}}),define("modules/scene/particle-system",["utils/vectors","utils/matrices","modules/scene/renderable-objects","modules/scene/scene-graph"],function(t,e,i,s){"use strict";function n(t,e,i,s,n,o,r,a,h,l,u){this._positionMatrix=t,this._orientationMatrix=e,this._dimensions=i,this._velocity=s,this._velocitySpread=n,this._initialNumber=o,this._spawnNumber=r,this._spawnTime=a,this._age=0,this._duration=h,this._delay=l||0,this._lastSpawn=0,this._createParticleFunction=u,this._particleDuration=-1,this._size=0,t&&this._calculateSize()}function o(t,e,i,s,o,r,a,h,l,u,c){n.call(this,t,e,i,s,o,r,a,h,l,u,c),this._calculateSize()}function r(t,e,i,s,o,r,a,h,l,u,c,_,p){n.call(this,t,e,i,r,a,h,l,u,c,_,p),this._direction=s,this._directionSpread=o}function a(t,e,i,s,o,r,a,h,l,u,c,_,p){n.call(this,t,e,i,r,a,h,l,u,c,_,p),this._planeNormal=s,this._directionSpread=o}function h(t,s,n,o,r,a,h,l,u){i.RenderableObject3D.call(this,null,!1,!0,t,s,e.IDENTITY4),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=a===!0,this._carriesParticles=h===!0,this._minimumCountForInstancing=l,this._particleCountFactor=void 0!==u?u:1,this._calculateSize()}return n.prototype._calculateSize=function(){var i=this._createParticleFunction();this._size=e.translationLength(this._positionMatrix)+t.length3(this._dimensions)+Math.max((this._velocity+.5*this._velocitySpread)*i._duration*.001+i.getFinalSize(),i.getMaxSize()),i.markAsReusable()},n.prototype.getSize=function(){return this._size},n.prototype.getDuration=function(){return this._duration},n.prototype.getParticleDuration=function(){var t;return-1===this._particleDuration&&(this._particleDuration=0,t=this._createParticleFunction(),this._particleDuration=t._duration,t.markAsReusable()),this._particleDuration},n.prototype._emitParticle=function(){var i,s;return i=this._createParticleFunction(),s=[this._positionMatrix[12]+(Math.random()-.5)*this._dimensions[0],this._positionMatrix[13]+(Math.random()-.5)*this._dimensions[1],this._positionMatrix[14]+(Math.random()-.5)*this._dimensions[2]],i.setPositionMatrix(e.translation4v(t.mulVec3Mat4(s,this._orientationMatrix))),i},n.prototype.emitParticles=function(t,e){var i,s,n;if(i=[],void 0===e&&(e=1),this._delay>0&&(this._delay-=t,this._delay<=0&&(t=-this._delay,this._delay=0)),0===this._delay){if(0===this._age)for(n=Math.round(this._initialNumber*e),this._initialNumber>0&&1>n&&(n=1),s=0;n>s;s++)i.push(this._emitParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<this._duration||0===this._duration);){for(n=Math.round(this._spawnNumber*e),this._spawnNumber>0&&1>n&&(n=1),s=0;n>s;s++)i.push(this._emitParticle());this._lastSpawn+=this._spawnTime}}return i},n.prototype.addToContext=function(t){var e=this._createParticleFunction();e.addToContext(t),e.markAsReusable()},o.prototype=new n,o.prototype.constructor=o,o.prototype._emitParticle=function(){var i,s,o=n.prototype._emitParticle.call(this);return i=this._velocity+(Math.random()-.5)*this._velocitySpread,s=e.translation4(0,i,0),e.rotate4(s,t.UNIT3_X,2*Math.random()*Math.PI),e.rotate4(s,t.UNIT3_Z,2*Math.random()*Math.PI),o.setVelocityVector(e.translationVector3(s)),o},r.prototype=new n,r.prototype.constructor=r,r.prototype._emitParticle=function(){var i,s,o,r=n.prototype._emitParticle.call(this);return i=this._velocity+(Math.random()-.5)*this._velocitySpread,s=e.translation4v(t.scaled3(this._direction,i)),o=Math.abs(this._direction[0])<.75?[1,0,0]:Math.abs(this._direction[1])<.75?[0,1,0]:[0,0,1],t.mulCross3(o,this._direction),t.normalize3(o),e.rotate4(s,o,Math.random()*this._directionSpread/180*Math.PI),e.rotate4(s,this._direction,360*Math.random()/180*Math.PI),r.setVelocityVector(e.translationVector3(s)),r},a.prototype=new n,a.prototype.constructor=r,a.prototype._emitParticle=function(){var i,s,o,r=n.prototype._emitParticle.call(this);return s=this._velocity+(Math.random()-.5)*this._velocitySpread,i=Math.abs(this._planeNormal[0])<.75?[1,0,0]:Math.abs(this._planeNormal[1])<.75?[0,1,0]:[0,0,1],t.mulCross3(i,this._planeNormal),t.normalize3(i),o=e.translation4v(t.scaled3(i,s)),e.rotate4(o,t.cross3(i,this._planeNormal),(Math.random()-.5)*this._directionSpread/180*Math.PI),e.rotate4(o,this._planeNormal,2*Math.random()*Math.PI),r.setVelocityVector(e.translationVector3(o)),r},h.prototype=new i.RenderableObject3D,h.prototype.constructor=h,h.prototype._calculateSize=function(){var t,e=0;for(t=0;t<this._emitters.length;t++)e=Math.max(e,this._emitters[t].getSize());this.setSize(e)},h.prototype.shouldBeRendered=function(){return!1},h.prototype.performAnimate=function(i){var n,o,r,a,h,l;if(!this._keepAlive&&this._age>this._duration)return void this.getNode().markAsReusable();if(this._age+=i,this._emitters)for(n=0;n<this._emitters.length;n++)if(r=this._emitters[n].emitParticles(i,this._particleCountFactor),this._carriesParticles)for(o=0;o<r.length;o++)this.getNode().addSubnode(new s.RenderableNode(r[o],!1,this._minimumCountForInstancing));else for(a=this.getModelMatrix(),h=e.translation4m4(a),l=e.rotation4m4(a),o=0;o<r.length;o++)r[o].translateByMatrix(h),r[o].rotateByMatrix(l),this.getNode()._scene.addNode(new s.RenderableNode(r[o],!1,this._minimumCountForInstancing));this.translatev(t.scaled3(e.translationVector3(this._velocityMatrix),i/1e3))},h.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._carriesParticles){if(this._emitters){for(this._age=0,t=0;t<this._emitters.length;t++)e=this._emitters[t].getParticleDuration(),e>i&&(i=e);this._emitters=null,this._duration=i}}else this._duration=0,this.getNode().markAsReusable()},h.prototype.addToContext=function(t){var e;for(e=0;e<this._emitters.length;e++)this._emitters[e].addToContext(t)},{ParticleEmitter:n,OmnidirectionalParticleEmitter:o,UnidirectionalParticleEmitter:r,PlanarParticleEmitter:a,ParticleSystem:h}}),define("armada/logic/explosion",["utils/vectors","utils/matrices","modules/application","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","modules/scene/particle-system","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/constants","utils/polyfill"],function(t,e,i,s,n,o,r,a,h,l,u,c,_){"use strict";function p(t,i,s,n,o,r){this._class=t,this._positionMatrix=i,this._orientationMatrix=s,this._direction=n,this._carriesParticles=o===!0,this._velocityMatrix=r||e.identity4(),this._visualModel=null}var d,g,f,m="explosion/";return p.prototype.getEmitterParticleConstructor=function(t){var i=this._class.getParticleEmitterDescriptors()[t],s=i.getModel(),n=i.getShader(),o=i.getTexturesOfTypes(i.getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),r=i.getParticleStates(),a=i.getInstancedShader();return function(){var t=f.getObject();return t.init(s,n,o,e.identity4(),r,!1,a),t}.bind(this)},p.prototype.getVisualModel=function(){return this._visualModel},p.prototype._createVisualModel=function(){var t,s,n,o;for(s=[],o=this._class.getParticleEmitterDescriptors(),t=0;t<o.length;t++){switch(o[t].getType()){case u.ParticleEmitterType.OMNIDIRECTIONAL:n=new h.OmnidirectionalParticleEmitter(e.identity4(),e.IDENTITY4,o[t].getDimensions(),o[t].getVelocity(),o[t].getVelocitySpread(),o[t].getInitialNumber(),o[t].getSpawnNumber(),o[t].getSpawnTime(),o[t]._duration,o[t].getDelay(),this.getEmitterParticleConstructor(t));break;case u.ParticleEmitterType.UNIDIRECTIONAL:n=new h.UnidirectionalParticleEmitter(e.identity4(),e.IDENTITY4,o[t].getDimensions(),this._direction,o[t].getDirectionSpread(),o[t].getVelocity(),o[t].getVelocitySpread(),o[t].getInitialNumber(),o[t].getSpawnNumber(),o[t].getSpawnTime(),o[t]._duration,o[t].getDelay(),this.getEmitterParticleConstructor(t));break;case u.ParticleEmitterType.PLANAR:n=new h.PlanarParticleEmitter(e.identity4(),e.IDENTITY4,o[t].getDimensions(),this._direction,o[t].getDirectionSpread(),o[t].getVelocity(),o[t].getVelocitySpread(),o[t].getInitialNumber(),o[t].getSpawnNumber(),o[t].getSpawnTime(),o[t]._duration,o[t].getDelay(),this.getEmitterParticleConstructor(t));break;default:i.crash()}s.push(n)}this._visualModel=new h.ParticleSystem(this._positionMatrix,this._orientationMatrix,this._velocityMatrix,s,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,c.getSetting(c.BATTLE_SETTINGS.MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING),l.getParticleCountFactor())},p.prototype.addToScene=function(e,i,n,o){var h,l=e._scene;s.executeWhenReady(function(){this._createVisualModel(),e.addSubnode(new a.RenderableNode(this._visualModel)),h=this._class.getLightStates(),h&&l.addPointLightSource(new r.PointLightSource(h[0].color,h[0].intensity,t.NULL3,[this._visualModel],h),_.EXPLOSION_LIGHT_PRIORITY),this._class.playSound(i,n,d,g),o&&o(this._visualModel)}.bind(this))},p.prototype.addResourcesToScene=function(t){var e=m+this._class.getName();this._class.acquireResources(),s.executeWhenReady(function(){t.hasResourcesOfObject(e)||(this._createVisualModel(),t.addResourcesOfObject(this._visualModel,e))}.bind(this))},p.prototype.finish=function(){this._visualModel.finishEmitting()},p.prototype.destroy=function(){this._class=null,this._positionMatrix=null,this._orientationMatrix=null,this._direction=null,this._visualModel&&this._visualModel.getNode().markAsReusable(),this._visualModel=null},f=n.getPool(o.Particle),c.executeWhenReady(function(){d=c.getSetting(c.BATTLE_SETTINGS.HIT_SOUND_STACKING_TIME_THRESHOLD),g=c.getSetting(c.BATTLE_SETTINGS.HIT_SOUND_STACKING_VOLUME_FACTOR)}),{Explosion:p}}),define("armada/logic/equipment",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/physics","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/logic/SpacecraftEvents","armada/configuration","armada/logic/constants","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,h,l,u,c,_,p,d,g,f,m){"use strict";function y(t,e,i,s,n){this._class=null,this._visualModel=null,this._physicalModel=null,this._timeLeft=0,this._origin=null,t&&this.init(t,e,i,s,n)}function S(t,e,s){this._class=t,this._spacecraft=e,this._slot=s,this._cooldown=0,this._visualModel=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class.isFixed(),this._lastAimStatus=this._fixed?F.FIXED:F.NO_TARGET}function T(t,e){this._spacecraft=t,this._target=null,this._spacecraftArray=e||null,this._targetHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._timeUntilHostileOrderReset=0,this._timeUntilNonHostileOrderReset=0}function E(t,e){this._propulsionClass=t,this._slot=e,this._visualModel=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function b(t,e){this._class=t,this._drivenPhysicalObject=e,this._thrusterUses={forward:{burn:0,thrusters:[]},reverse:{burn:0,thrusters:[]},strafeLeft:{burn:0,thrusters:[]},strafeRight:{burn:0,thrusters:[]},raise:{burn:0,thrusters:[]},lower:{burn:0,thrusters:[]},yawLeft:{burn:0,thrusters:[]},yawRight:{burn:0,thrusters:[]},pitchUp:{burn:0,thrusters:[]},pitchDown:{burn:0,thrusters:[]},rollLeft:{burn:0,thrusters:[]},rollRight:{burn:0,thrusters:[]}},this._thrusterSoundClip=null}function M(t){this._spacecraft=t,this._assisted=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._locked=!1,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCombatForwardSpeed=0,this._maxCombatReverseSpeed=0,this._maxCruiseForwardSpeed=0,this._maxCruiseReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this.updateForNewPropulsion()}function O(t,e){this._class=t,this._spacecraft=e,this._state=O.JumpState.NONE,this._timeLeft=0,this._soundClip=null,this._originalFlightMode=null,this._originalScalingMatrix=null}var A,x,R,C,I,v,N,L,D,w={FREE:"free",COMBAT:"combat",CRUISE:"cruise"
},F={FIXED:0,NO_TARGET:1,AIMING_OUT_OF_REACH:2,AIMING:3,AIMED_OUT_OF_RANGE:4,AIMED_IN_RANGE:5},P="projectile/",V="weapon/",U=3,B=.02,j="jump",G=200,k=.5,H=2,q=!1,W=0,z=0,X=0,Y=null,J=null;return Object.freeze(w),Object.freeze(F),y.prototype.init=function(t,e,s,n,r){this._class=t,this._physicalModel||(this._physicalModel=new o.PhysicalObject),this._physicalModel.init(t.getMass(),e||i.identity4(),s||i.identity4(),i.scaling4(t.getSize()),n?n.getVelocityMatrix():i.null4(),[],!0),this._timeLeft=t._duration,this._origin=n,r&&this._physicalModel.addForce(r)},y.prototype.canBeReused=function(){return this._timeLeft<=0},y.prototype._createVisualModel=function(t){this._visualModel||(this._visualModel=new h.Billboard),this._visualModel.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._class.getSize(),t,this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,this._class.getInstancedShader())},y.prototype.getVisualModel=function(){return this._visualModel},y.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},y.prototype.addToScene=function(t,e,i){r.executeWhenReady(function(){this._createVisualModel(e),t.addObject(this._visualModel,X),i&&i(this._visualModel)}.bind(this))},y.prototype.addResourcesToScene=function(t,e){var s,n=P+this._class.getName();this._class.acquireResources(),r.executeWhenReady(function(){t.hasResourcesOfObject(n)||(this._createVisualModel(e),t.addResourcesOfObject(this._visualModel,n),s=new m.Explosion(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),s.addResourcesToScene(t))}.bind(this))},y.prototype.simulate=function(t,s){var n,o,r,a,h,l,u,c,_,p,d,g,f,y;if(!this.canBeReused())if(y=Math.min(t,this._class._duration-this._timeLeft),this._timeLeft-=t,this._timeLeft>0){for(this._physicalModel.simulate(t),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),r=i.translationVector3(this._physicalModel._positionMatrix),h=i.translationVector3(this._physicalModel.getVelocityMatrix()),o=s.getObjects(Math.min(r[0],r[0]-h[0]*y/1e3),Math.max(r[0],r[0]-h[0]*y/1e3),Math.min(r[1],r[1]-h[1]*y/1e3),Math.max(r[1],r[1]-h[1]*y/1e3),Math.min(r[2],r[2]-h[2]*y/1e3),Math.max(r[2],r[2]-h[2]*y/1e3)),n=0;n<o.length;n++)if(I&&o[n].showHitbox(),p=o[n]._physicalModel,p&&(q||o[n]!==this._origin)&&(d=p.checkHit(r,h,y)))return l=e.diff3(h,i.translationVector3(p.getVelocityMatrix())),c=e.normal3(l),u=e.length3(l),a=e.mulVec3Mat4(c,i.inverseOfRotation4(o[n]._visualModel._orientationMatrix)),g=e.mulVec4Mat4(d,o[n]._visualModel.getModelMatrix()),f=e.diff3(g,i.translationVector3(p._positionMatrix)),p.addForceAndTorque(f,c,u*this._physicalModel.getMass()*1e3/W,W),_=new m.Explosion(this._class.getExplosionClass(),i.translation4v(g),i.identity4(),e.scaled3(c,-1),!0),_.addToScene(this._visualModel.getNode()._scene.getRootNode(),o[n].getSoundSource(),!0),o[n].damage(this._class.getDamage(),d,e.scaled3(a,-1),this._origin),this._timeLeft=0,void this._visualModel.markAsReusable()}else this._visualModel.markAsReusable()},y.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null},S.prototype.getSlot=function(){return this._slot},S.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},S.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},S.prototype.getFirepower=function(t){return this._class.getFirepower(t)},S.prototype.getRange=function(t){return(this._class.getProjectileVelocity()+(t||0))*this._class.getProjectileClass()._duration/1e3},S.prototype.getCooldown=function(){return this._class.getCooldown()},S.prototype.getOrigoPositionMatrix=function(){return this._origoPositionMatrix=this._origoPositionMatrix||i.translatedByVector(this._slot?this._slot.positionMatrix:i.IDENTITY4,e.mulVec3Mat4(e.scaled3(this._class.getAttachmentPoint(),-1),i.prod3x3SubOf4(i.scaling4(this._class.getModel().getScale()/(this._spacecraft?this._spacecraft.getPhysicalScalingMatrix()[0]:1)),this._slot?this._slot.orientationMatrix:i.IDENTITY4))),this._origoPositionMatrix},S.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix=this._scaledOriMatrix||i.prod3x3SubOf4(this._visualModel._scalingMatrix,this._slot.orientationMatrix),this._scaledOriMatrix},S.prototype.isFixed=function(){return this._fixed},S.prototype.getBasePointPosVector=function(t){var s=this._class.getBasePoint(),n=e.mulVec3Mat4(i.translationVector3(this.getOrigoPositionMatrix()),t);return e.add3(n,this._spacecraft.getPhysicalPositionVector()),s=e.mulVec4Mat4(s,this._transformMatrix),s=e.mulVec3Mat4(s,i.prod3x3SubOf4(this.getScaledOriMatrix(),t)),e.add3(s,n),s},S.prototype.getProjectileOrientationMatrix=function(){var t=i.prod3x3SubOf4(this._slot.orientationMatrix,this._spacecraft.getPhysicalOrientationMatrix());return this._fixed||(t=i.prod3x3SubOf4(this._transformMatrix,t)),t},S.prototype.acquireResources=function(t){this._class.acquireResources(t)},S.prototype.addToScene=function(t,e,o,a,l){var _,p;this.acquireResources({omitShader:!!a.shaderName}),a.shaderName&&c.getShader(a.shaderName),r.executeWhenReady(function(){var r,d,g={};for(s.log_DEBUG("Adding weapon ("+this._class.getName()+") to scene...",2),d=this._class.getModel().getScale()/t._renderableObject._scalingMatrix[0],g[J]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(g[Y]=n.ShaderVariableType.FLOAT),r=new h.ParameterizedMesh(this._class.getModel(),a.shaderName?c.getManagedShader(a.shaderName):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._slot?this.getOrigoPositionMatrix():i.identity4(),a.orientationMatrix||(this._slot?this._slot.orientationMatrix:i.identity4()),i.scaling4(d),o===!0,e,g),t.addSubnode(new u.RenderableNode(r)),_=0,p=c.getMaxGroupTransforms();p>_;_++)r.setMat4Parameter(J,_,i.identity4());if(c.areLuminosityTexturesAvailable())for(_=0,p=c.getMaxLuminosityFactors();p>_;_++)r.setFloatParameter(Y,_,this._class.getDefaultGroupLuminosity(_));this._visualModel||(this._visualModel=r),l&&l(r)}.bind(this))},S.prototype._getMuzzleFlashForBarrel=function(t,e){var s=this._class.getBarrel(t).getProjectileClass(),n=i.translation4v(e),o=L.getObject();return h.initDynamicParticle(o,s.getMuzzleFlash().getModel(),s.getMuzzleFlash().getShader(),s.getMuzzleFlash().getTexturesOfTypes(s.getMuzzleFlash().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),s.getMuzzleFlash().getColor(),s.getMuzzleFlash().getSize(),n,s.getMuzzleFlash()._duration||g.getSetting(g.BATTLE_SETTINGS.DEFAULT_MUZZLE_FLASH_DURATION),s.getMuzzleFlash().getInstancedShader()),o},S.prototype.getResourceAdderFunction=function(t,e,i){return function(){var s;t.hasResourcesOfObject(i)||(s=this._getMuzzleFlashForBarrel(e,[0,0,0]),t.addResourcesOfObject(s))}.bind(this)},S.prototype.addProjectileResourcesToScene=function(t){var e,i,s,n=V+this._class.getName();for(s=this._class.getBarrels(),e=0;e<s.length;e++)i=new y(s[e].getProjectileClass()),i.addResourcesToScene(t),r.executeWhenReady(this.getResourceAdderFunction(t,e,n).bind(this));r.executeWhenReady(function(){t.addResourcesOfObject(null,n)})},S.prototype.simulate=function(t){var s,n;if(this._cooldown=Math.min(this._cooldown+t,this._class.getCooldown()),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),n=this._class.getRotators(),s=0;s<n.length;s++)i.rotateAroundPoint4(this._transformMatrix,e.mulVec3Mat4(n[s].center,this._transformMatrix),e.mulVec3Mat4(n[s].axis,this._transformMatrix),this._rotationAngles[s]),this._visualModel.setMat4Parameter(J,n[s].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},S.prototype.fire=function(t,s,n){var r,a,h,c,_,p,d,g,m,y,S,T,E,b,M=this._visualModel.getNode()._scene;if(s&&this._lastAimStatus!==F.FIXED&&this._lastAimStatus!==F.AIMED_IN_RANGE)return 0;if(this._cooldown>=this._class.getCooldown()){for(this._cooldown=0,c=e.mulVec3Mat4(i.translationVector3(this.getOrigoPositionMatrix()),t),_=i.translatedByVector(this._spacecraft.getPhysicalPositionMatrix(),c),d=this.getProjectileOrientationMatrix(),S=this._class.getBarrels(),T={},h=0,r=0;r<S.length;r++)g=S[r].getProjectileClass(),m=S[r].getPositionVector(),this._fixed||(m=e.mulVec4Mat4(m,this._transformMatrix)),y=this._getMuzzleFlashForBarrel(r,m),m=e.mulVec3Mat4(m,i.prod3x3SubOf4(this.getScaledOriMatrix(),t)),p=i.translatedByVector(_,m),this._visualModel.getNode().addSubnode(new u.RenderableNode(y),!1,z),a=D.getObject(),a.init(g,p,d,this._spacecraft,new o.Force("",S[r].getForceForDuration(W),[d[4],d[5],d[6]],W)),a.addToScene(M),T[g.getName()]?T[g.getName()].addEmittingObject(a._visualModel):T[g.getName()]=new l.PointLightSource(g.getLightColor(),g.getLightIntensity(),e.NULL3,[a._visualModel]),this._spacecraft._physicalModel.addForceAndTorque(e.diff3(i.translationVector3(p),i.translationVector3(this._spacecraft.getPhysicalPositionMatrix())),i.getRowB43Neg(d),S[r].getForceForDuration(W),W),h++;for(E in T)T.hasOwnProperty(E)&&M.addPointLightSource(T[E],f.PROJECTILE_LIGHT_PRIORITY);return n||(b=i.translationVector3(a._visualModel.getPositionMatrixInCameraSpace(M.getCamera()))),this._class.playFireSound(b,n,v,N),h}return 0},S.prototype.setRotation=function(t,e){this._fixed||(this._rotationAngles[0]=Math.radians(t),this._rotationAngles[1]=Math.radians(e),this._rotationChanged=!0)},S.prototype.rotateTo=function(t,e,i,n,o){var r,a,h,l;if(!this._fixed)for(this._lastAimStatus=F.AIMED_IN_RANGE,a=this._class.getRotators(),h=0;h<a.length;h++){switch(h){case 0:r=t-this._rotationAngles[0],this._class.getRotationStyle()===p.WeaponRotationStyle.ROLL_YAW&&Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,e=-e);break;case 1:r=e-this._rotationAngles[1];break;default:s.crash()}a[h].restricted||(r>Math.PI?r-=2*Math.PI:r<-Math.PI&&(r+=2*Math.PI)),l=0,Math.abs(r)>i&&(l=a[h].rotationRate*o/1e3,r>0?this._rotationAngles[h]+=Math.min(l,r):this._rotationAngles[h]-=Math.min(l,-r),this._rotationChanged=!0,Math.abs(r)-l>n&&(this._lastAimStatus=F.AIMING)),a[h].restricted?(this._rotationAngles[h]>a[h].range[1]&&(this._rotationAngles[h]=a[h].range[1],Math.abs(r)-l>n&&(this._lastAimStatus=F.AIMING_OUT_OF_REACH)),this._rotationAngles[h]<a[h].range[0]&&(this._rotationAngles[h]=a[h].range[0],Math.abs(r)-l>n&&(this._lastAimStatus=F.AIMING_OUT_OF_REACH))):(this._rotationAngles[h]>Math.PI&&(this._rotationAngles[h]-=2*Math.PI),this._rotationAngles[h]<-Math.PI&&(this._rotationAngles[h]+=2*Math.PI))}},S.prototype.aimTowards=function(t,i,n,o,r){var a,h,l,u,c;if(!this._fixed){switch(a=this.getBasePointPosVector(o),h=e.diff3(t,a),h=e.mulMat4Vec3(this._spacecraft.getPhysicalOrientationMatrix(),h),h=e.mulMat4Vec3(this._slot.orientationMatrix,h),c=e.length3(h)<=this.getRange(),e.normalize3(h),this._class.getRotationStyle()){case p.WeaponRotationStyle.YAW_PITCH:l=e.getYawAndPitch(h),this.rotateTo(-l.yaw,-l.pitch,i,n,r);break;case p.WeaponRotationStyle.ROLL_YAW:u=e.getRollAndYaw(h),this.rotateTo(u.roll,u.yaw,i,n,r);break;default:s.crash()}c||this._lastAimStatus!==F.AIMED_IN_RANGE||(this._lastAimStatus=F.AIMED_OUT_OF_RANGE)}},S.prototype.rotateToDefaultPosition=function(t,e){var i;this._fixed||(i=this._class.getRotators(),this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,t,0,e),this._lastAimStatus=F.NO_TARGET)},S.prototype.getScoreValue=function(){return this._class.getScoreValue()},S.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._slot=null,this._visualModel&&this._visualModel.markAsReusable(),this._visualModel=null},T.prototype.setTarget=function(t){var e,i,s,n;if(t!==this._target){if(this._target&&this._target.setBeingUntargeted(this._spacecraft),this._target=t,this._targetHitPosition=null,this._spacecraft._visualModel)for(s=this._spacecraft._visualModel.getNode(),n=s._scene.getCamera(),i=s.getCameraConfigurationsWithName(g.getSetting(g.BATTLE_SETTINGS.TARGET_VIEW_NAME)),e=0;e<i.length;e++)n.getConfiguration()===i[e]&&n.transitionToSameConfiguration(g.getSetting(g.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_DURATION),g.getSetting(g.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_STYLE)),i[e].setOrientationFollowedObjects(this._target?[this._target._visualModel]:[],!0);this._target&&this._target.setBeingTargeted(this._spacecraft)}},T.prototype._filterHostileTarget=function(t){return this._spacecraft.isHostile(t)},T.prototype._filterNonHostileTarget=function(t){return t!==this._spacecraft&&!this._spacecraft.isHostile(t)},T.prototype._mapTargetByBearing=function(t,s){return{index:s,value:e.angle3u(i.getRowB43(this._spacecraft.getPhysicalOrientationMatrix()),e.normal3(e.diff3(t.getPhysicalPositionVector(),this._spacecraft.getPhysicalPositionVector())))}},T.prototype._mapTargetToCombinedValue=function(t,s){var n=e.diff3(t.getPhysicalPositionVector(),this._spacecraft.getPhysicalPositionVector()),o=e.length3(n);return{index:s,value:(o+G*e.angle3u(i.getRowB43(this._spacecraft.getPhysicalOrientationMatrix()),e.scaled3(n,1/o)))*(this._spacecraft.isGoodAgainst(t)?k:this._spacecraft.isBadAgainst(t)?H:1)}},T._compareMappedTargets=function(t,e){return t.value-e.value},T.prototype._updateHostileOrder=function(t){var e,i,s;if(this._spacecraftArray){if(e=this._spacecraftArray.filter(this._filterHostileTarget,this),this._timeUntilHostileOrderReset<=0){for(i=e.map(t,this).sort(T._compareMappedTargets),this._orderedHostileTargets=[],s=0;s<i.length;s++)this._orderedHostileTargets.push(e[i[s].index]);return!0}for(s=0;s<e.length;s++)this._orderedHostileTargets.indexOf(e[s])<0&&this._orderedHostileTargets.push(e[s])}return!1},T.prototype._updateNonHostileOrder=function(){var t,e,i;if(this._spacecraftArray){if(t=this._spacecraftArray.filter(this._filterNonHostileTarget,this),this._timeUntilNonHostileOrderReset<=0){for(e=t.map(this._mapTargetByBearing,this).sort(T._compareMappedTargets),this._orderedNonHostileTargets=[],i=0;i<e.length;i++)this._orderedNonHostileTargets.push(t[e[i].index]);return!0}for(i=0;i<t.length;i++)this._orderedNonHostileTargets.indexOf(t[i])<0&&this._orderedNonHostileTargets.push(t[i])}return!1},T.prototype._isValidNewTarget=function(t){return t.isAlive()&&!t.isAway()&&t!==this._target},T.prototype._targetNextHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);return this._orderedHostileTargets&&this._orderedHostileTargets.length>0&&(s=this._orderedHostileTargets.length,e=n?0:(this._orderedHostileTargets.indexOf(this._target)+1)%s,i=0,s>i&&!this._isValidNewTarget(this._orderedHostileTargets[e])&&(e=(e+1)%s,i++),s>i)?(this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilHostileOrderReset=0,!1)},T.prototype._targetPreviousHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);return this._orderedHostileTargets&&this._orderedHostileTargets.length>0&&(s=this._orderedHostileTargets.length,e=n?s-1:(this._orderedHostileTargets.indexOf(this._target)+s-1)%s,i=0,s>i&&!this._isValidNewTarget(this._orderedHostileTargets[e])&&(e=(e+s-1)%s,i++),s>i)?(this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilHostileOrderReset=0,!1)},T.prototype.targetNextNearestHostile=function(){return this._targetNextHostile(this._mapTargetByBearing)},T.prototype.targetPreviousNearestHostile=function(){return this._targetPreviousHostile(this._mapTargetByBearing)},T.prototype.targetNextBestHostile=function(){return this._targetNextHostile(this._mapTargetToCombinedValue)},T.prototype.targetNextNearestNonHostile=function(){var t,e,i,s=this._updateNonHostileOrder();return this._orderedNonHostileTargets&&this._orderedNonHostileTargets.length>0&&(i=this._orderedNonHostileTargets.length,t=s?0:(this._orderedNonHostileTargets.indexOf(this._target)+1)%i,e=0,i>e&&!this._isValidNewTarget(this._orderedNonHostileTargets[t])&&(t=(t+1)%i,e++),i>e)?(this.setTarget(this._orderedNonHostileTargets[t]),this._timeUntilNonHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilNonHostileOrderReset=0,!1)},T.prototype.getTarget=function(){return this._target&&(this._target.canBeReused()||this._target.isAway())&&this.setTarget(null),this._target},T.prototype.getTargetHitPosition=function(){var s,n,o,r,a,h,l,u,c,_;if(!this._targetHitPosition){if(n=this._target.getPhysicalPositionVector(),r=this._spacecraft.getWeapons(),0===r.length)return n;for(s=this._spacecraft.getPhysicalPositionVector(),o=e.diff3(i.translationVector3(this._target.getVelocityMatrix()),i.translationVector3(this._spacecraft.getVelocityMatrix())),a=r[0].getProjectileVelocity(),h=a*a-(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),l=0,c=0;3>c;c++)l+=2*o[c]*(s[c]-n[c]);for(u=0,c=0;3>c;c++)u+=-n[c]*n[c]-s[c]*s[c]+2*n[c]*s[c];_=t.getGreaterSolutionOfQuadraticEquation(h,l,u),this._targetHitPosition=[n[0]+_*o[0],n[1]+_*o[1],n[2]+_*o[2]]}return this._targetHitPosition},T.prototype.simulate=function(t){this._target&&(this._target.canBeReused()||this._target.isAway())&&this.setTarget(null),this._targetHitPosition=null,this._timeUntilHostileOrderReset>0&&(this._timeUntilHostileOrderReset-=t),this._timeUntilNonHostileOrderReset>0&&(this._timeUntilNonHostileOrderReset-=t)},T.prototype.destroy=function(){this._spacecraft=null,this._spacecraftArray=null,this._target=null,this._targetHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null},E.prototype.addToScene=function(t){var e;this._propulsionClass.acquireResources(),r.executeWhenReady(function(){e=h.staticParticle(this._propulsionClass.getThrusterBurnParticle().getModel(),this._propulsionClass.getThrusterBurnParticle().getShader(),this._propulsionClass.getThrusterBurnParticle().getTexturesOfTypes(this._propulsionClass.getThrusterBurnParticle().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._propulsionClass.getThrusterBurnParticle().getColor(),this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass.getThrusterBurnParticle().getInstancedShader()),e.setRelativeSize(0),t.addSubnode(new u.RenderableNode(e,!1,g.getSetting(g.BATTLE_SETTINGS.MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING))),this._visualModel||(this._visualModel=e,this._shipModel=t._renderableObject)}.bind(this))},E.prototype._updateVisuals=function(){this._visualModel.setRelativeSize(this._burnLevel),c.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(Y,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},E.prototype.resetBurn=function(){this._burnLevel=0,this._updateVisuals()},E.prototype.addBurn=function(t){this._burnLevel+=t,this._updateVisuals()},E.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this._visualModel=null,this._shipModel=null},b.prototype.acquireResources=function(){this._class.acquireResources()},b.prototype.getThrust=function(){return this._class.getThrust()},b.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},b.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},b.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},b.prototype.addThrusters=function(t){var e,i,s;for(e=0;e<t.length;e++)for(s=new E(this._class,t[e]),i=0;i<t[e].uses.length;i++)this._thrusterUses[t[e].uses[i]].thrusters.push(s)},b.prototype.addToScene=function(t){var e,i;for(e in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(e))for(i=0;i<this._thrusterUses[e].thrusters.length;i++)this._thrusterUses[e].thrusters[i].addToScene(t)},b.prototype.getThrusterBurn=function(t){return this._thrusterUses[t].burn},b.prototype.addThrusterBurn=function(t,e){var i;for(this._thrusterUses[t].burn+=e,i=0;i<this._thrusterUses[t].thrusters.length;i++)this._thrusterUses[t].thrusters[i].addBurn(e)},b.prototype.resetThrusterBurn=function(){var t,e;for(t in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(t))for(this._thrusterUses[t].burn=0,e=0;e<this._thrusterUses[t].thrusters.length;e++)this._thrusterUses[t].thrusters[e].resetBurn()},b.prototype._getSoundVolume=function(){var t,e,i;return i=this._class.getMaxMoveBurnLevel(),t=i?Math.max(this._thrusterUses.forward.burn,this._thrusterUses.reverse.burn,this._thrusterUses.strafeRight.burn,this._thrusterUses.strafeLeft.burn,this._thrusterUses.raise.burn,this._thrusterUses.lower.burn)/i:0,i=this._class.getMaxTurnBurnLevel(),e=i?Math.max(this._thrusterUses.yawRight.burn,this._thrusterUses.yawLeft.burn,this._thrusterUses.pitchUp.burn,this._thrusterUses.pitchDown.burn,this._thrusterUses.rollRight.burn,this._thrusterUses.rollLeft.burn)/i:0,i=Math.round((t+e)*U)/U},b.prototype.simulate=function(t,e){var s,n,o;e!==!1&&(s=i.getRowB4(this._drivenPhysicalObject._orientationMatrix),n=i.getRowC4(this._drivenPhysicalObject._orientationMatrix),o=i.getRowA4(this._drivenPhysicalObject._orientationMatrix),this._thrusterUses.forward.burn>0&&this._drivenPhysicalObject.addOrRenewForce("forwardThrust",this._class.getThrust()*this._thrusterUses.forward.burn/this._class.getMaxMoveBurnLevel(),s),this._thrusterUses.reverse.burn>0&&this._drivenPhysicalObject.addOrRenewForce("reverseThrust",-this._class.getThrust()*this._thrusterUses.reverse.burn/this._class.getMaxMoveBurnLevel(),s),this._thrusterUses.strafeRight.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeRightThrust",this._class.getThrust()*this._thrusterUses.strafeRight.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.strafeLeft.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeLeftThrust",-this._class.getThrust()*this._thrusterUses.strafeLeft.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.raise.burn>0&&this._drivenPhysicalObject.addOrRenewForce("raiseThrust",this._class.getThrust()*this._thrusterUses.raise.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.lower.burn>0&&this._drivenPhysicalObject.addOrRenewForce("lowerThrust",-this._class.getThrust()*this._thrusterUses.lower.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.yawRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawRightThrust",this._class.getAngularThrust()*this._thrusterUses.yawRight.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.yawLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawLeftThrust",-this._class.getAngularThrust()*this._thrusterUses.yawLeft.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.pitchUp.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchUpThrust",-this._class.getAngularThrust()*this._thrusterUses.pitchUp.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.pitchDown.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchDownThrust",this._class.getAngularThrust()*this._thrusterUses.pitchDown.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.rollRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollRightThrust",-this._class.getAngularThrust()*this._thrusterUses.rollRight.burn/this._class.getMaxTurnBurnLevel(),s),this._thrusterUses.rollLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollLeftThrust",this._class.getAngularThrust()*this._thrusterUses.rollLeft.burn/this._class.getMaxTurnBurnLevel(),s)),this._thrusterSoundClip||(this._thrusterSoundClip=this._class.createThrusterSoundClip(t),this._thrusterSoundClip&&(this._thrusterSoundClip.setVolume(0),this._thrusterSoundClip.play())),this._thrusterSoundClip&&this._thrusterSoundClip.rampVolume(this._getSoundVolume()*this._class.getThrusterSoundVolume(),B,!0,!0)},b.prototype.getScoreValue=function(){return this._class.getScoreValue()},b.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusterUses=null,this._thrusterSoundClip&&(this._thrusterSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),setTimeout(function(){this._thrusterSoundClip.destroy(),this._thrusterSoundClip=null}.bind(this),_.SOUND_RAMP_DURATION))},M.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._spacecraft.getMaxAcceleration()||0},M.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},M.prototype.updateTurningLimit=function(){this._turningLimit=this._spacecraft.getMaxAngularAcceleration()*g.getSetting(g.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S},M.prototype.updateForNewPropulsion=function(){var t=this._spacecraft.getMaxAcceleration();this.updateSpeedIncrementPerSecond(),this._maxCombatForwardSpeed=A*t,this._maxCombatReverseSpeed=x*-t,this._maxCruiseForwardSpeed=R*t,this._maxCruiseReverseSpeed=C*-t,this.updateTurningLimit(),this._maxMoveBurnLevel=this._spacecraft.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._spacecraft.getMaxThrusterTurnBurnLevel()},M.prototype.getRestrictedTurningLimit=function(t){return Math.min(this._turningLimit,this._spacecraft.getMaxTurnRateAtSpeed(void 0===t?this._spacecraft.getRelativeVelocityMatrix()[13]:t)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S)},M.prototype.isLocked=function(){return this._locked},M.prototype.setLocked=function(t){this._locked=t,this._locked&&(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0)},M.prototype.getFlightMode=function(){return this._assisted?this._restricted?w.CRUISE:w.COMBAT:w.FREE},M.prototype.changeFlightMode=function(t){if(this._locked)return!1;switch(t||(t=this._assisted?this._restricted?w.FREE:w.CRUISE:w.COMBAT),t){case w.COMBAT:this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._assisted?this._speedTarget:this._spacecraft.getRelativeVelocityMatrix()[13]),this._maxCombatForwardSpeed),this._assisted=!0,this._restricted=!1;break;case w.CRUISE:this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._assisted?this._speedTarget:this._spacecraft.getRelativeVelocityMatrix()[13]),this._maxCruiseForwardSpeed),this._assisted=!0,this._restricted=!0;break;case w.FREE:this._assisted=!1,this._restricted=!1;break;default:return s.showError("Cannot switch to unknown flight mode: '"+t+"'!"),!1}return!0},M.prototype.toggleFlightAssist=function(){return this.changeFlightMode(this._assisted?w.FREE:w.COMBAT)},M.prototype.toggleCruise=function(){return this.changeFlightMode(this._restricted?w.COMBAT:w.CRUISE)},M.prototype.forward=function(t){this._locked||(this._speedTarget=this._assisted?Math.min(Math.max(this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget)+(t||this._speedIncrement),this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed):Number.MAX_VALUE)},M.prototype.stopForward=function(){if(!this._assisted){var t=this._spacecraft.getRelativeVelocityMatrix()[13];this._speedTarget>t&&(this._speedTarget=t)}},M.prototype.reverse=function(t){this._locked||(this._speedTarget=this._assisted?Math.max(Math.min(this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget)-(t||this._speedIncrement),this._restricted?this._maxCruiseReverseSpeed:this._maxCombatReverseSpeed):-Number.MAX_VALUE)},M.prototype.stopReverse=function(){var t;this._assisted||(t=this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t))},M.prototype.strafeLeft=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},M.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},M.prototype.strafeRight=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},M.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},M.prototype.lower=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},M.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},M.prototype.raise=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},M.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},M.prototype.resetSpeed=function(){this._locked||this._assisted&&(this._speedTarget=0)},M.prototype.setSpeedTarget=function(t){this._locked||this._assisted&&(this._speedTarget=t)},M.prototype.getSpeedTarget=function(){return this._speedTarget},M.prototype.hasSpeedTarget=function(){return this._assisted},M.prototype.getMaxSpeed=function(){return this._assisted?this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed:void 0},M.prototype.yawLeft=function(t){this._locked||(void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget<0&&(this._yawTarget=0))},M.prototype.yawRight=function(t){this._locked||(void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget>0&&(this._yawTarget=0))},M.prototype.pitchDown=function(t){this._locked||(void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0))},M.prototype.pitchUp=function(t){this._locked||(void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0))},M.prototype.rollLeft=function(t){this._locked||(void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-t*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0))},M.prototype.rollRight=function(t){this._locked||(void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=t*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0))},M.prototype.controlThrusters=function(t){var i,s,n,r,a=this._spacecraft.getRelativeVelocityMatrix(),h=a[13],l=o.VELOCITY_MATRIX_ERROR_THRESHOLD,u=this._spacecraft.getTurningMatrix(),c=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,_=this._yawTarget,p=this._pitchTarget;this._spacecraft.resetThrusterBurn(),this._restricted&&0!==h&&(i=this.getRestrictedTurningLimit(h),_=Math.min(Math.max(_,-i),i),p=Math.min(Math.max(p,-i),i)),s=Math.sign(u[4])*e.angle2u([0,1],e.normal2([u[4],u[5]])),_-s>c?this._spacecraft.addThrusterBurn("yawRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(_-s,t))):-c>_-s&&this._spacecraft.addThrusterBurn("yawLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(s-_,t))),n=Math.sign(u[6])*e.angle2u([1,0],e.normal2([u[5],u[6]])),p-n>c?this._spacecraft.addThrusterBurn("pitchUp",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(p-n,t))):-c>p-n&&this._spacecraft.addThrusterBurn("pitchDown",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(n-p,t))),r=Math.sign(-u[2])*e.angle2u([1,0],e.normal2([u[0],u[2]])),this._rollTarget-r>c?this._spacecraft.addThrusterBurn("rollRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(this._rollTarget-r,t))):this._rollTarget-r<-c&&this._spacecraft.addThrusterBurn("rollLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(r-this._rollTarget,t))),this._speedTarget-h>l?this._spacecraft.addThrusterBurn("forward",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._speedTarget-h,t))):this._speedTarget-h<-l&&this._spacecraft.addThrusterBurn("reverse",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(h-this._speedTarget,t))),(this._assisted||0!==this._strafeTarget)&&(h=a[12],
this._strafeTarget-h>l?this._spacecraft.addThrusterBurn("strafeRight",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._strafeTarget-h,t))):this._strafeTarget-h<-l&&this._spacecraft.addThrusterBurn("strafeLeft",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(h-this._strafeTarget,t)))),(this._assisted||0!==this._liftTarget)&&(h=a[14],this._liftTarget-h>l?this._spacecraft.addThrusterBurn("raise",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._liftTarget-h,t))):this._liftTarget-h<-l&&this._spacecraft.addThrusterBurn("lower",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(h-this._liftTarget,t)))),this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0},M.prototype.destroy=function(){this._spacecraft=null},O.VELOCITY_TOLERANCE=.01,O.JumpState={NONE:0,ALIGNING_VELOCITY:1,PREPARING:2,JUMPING_OUT:3,JUMPING_IN:4},Object.freeze(O.JumpOutState),O.prototype.acquireResources=function(){this._class.acquireResources()},O.prototype.jumpOut=function(){var t;switch(this._state){case O.JumpState.NONE:this._state=O.JumpState.ALIGNING_VELOCITY,this._originalFlightMode=this._spacecraft.getFlightMode(),this._spacecraft.changeFlightMode(w.CRUISE),this._spacecraft.setSpeedTarget(this._class.getPrepareVelocity()),this._spacecraft.lockManeuvering(),this._spacecraft.disableFiring(),this._spacecraft.handleEvent(d.JUMP_ENGAGED)&&(this._soundClip=this._class.createEngageSoundClip(),this._soundClip&&this._soundClip.play());break;case O.JumpState.ALIGNING_VELOCITY:case O.JumpState.PREPARING:t=this._state===O.JumpState.PREPARING,this._state=O.JumpState.NONE,this._spacecraft.unlockManeuvering(),this._spacecraft.changeFlightMode(this._originalFlightMode),this._spacecraft.enableFiring(),this._soundClip&&(this._soundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._soundClip=null),this._spacecraft.handleEvent(d.JUMP_CANCELLED)&&(this._soundClip=this._class.createDisengageSoundClip(),this._soundClip&&this._soundClip.play()),t&&(this._soundClip=this._class.createCancelSoundClip(),this._soundClip&&this._soundClip.play())}},O.prototype.jumpIn=function(){var t,s,n;this._state===O.JumpState.NONE&&(this._state=O.JumpState.JUMPING_IN,this._timeLeft=this._class.getJumpInDuration(),this._spacecraft.lockManeuvering(),this._spacecraft.disableFiring(),s=new m.Explosion(this._class.getJumpInExplosionClass(),i.matrix4(this._spacecraft.getPhysicalPositionMatrix()),i.matrix4(this._spacecraft.getPhysicalOrientationMatrix()),i.getRowC43(this._spacecraft.getPhysicalPositionMatrix()),!0,i.identity4()),s.addToScene(this._spacecraft._visualModel.getNode()._scene.getRootNode(),this._spacecraft.getSoundSource()),this._originalScalingMatrix=i.matrix4(this._spacecraft._visualModel._scalingMatrix),n=this._spacecraft._physicalModel,t=i.getRowB4(n._orientationMatrix),n.setVelocityMatrix(i.translation4v(e.scaled3(t,this._class.getJumpInVelocity()+this._class.getJumpInDeceleration()*this._class.getJumpInDuration()/1e3))),n.addForce(new o.Force(j,n.getMass()*this._class.getJumpInDeceleration(),e.scaled3(t,-1),this._class.getJumpInDuration())),this._soundClip=this._class.createJumpInSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play(),this._spacecraft.setAway(!1),this._spacecraft.handleEvent(d.JUMPED_IN))},O.prototype.simulate=function(t){var e,s,n,r;switch(this._state){case O.JumpState.ALIGNING_VELOCITY:e=this._spacecraft.getRelativeVelocityMatrix(),Math.abs(e[12])<O.VELOCITY_TOLERANCE&&Math.abs(e[14])<O.VELOCITY_TOLERANCE&&Math.abs(e[13]-this._class.getPrepareVelocity())<O.VELOCITY_TOLERANCE&&(this._state=O.JumpState.PREPARING,this._timeLeft=this._class.getPrepareDuration(),this._soundClip=this._class.createPrepareSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play());break;case O.JumpState.PREPARING:this._spacecraft.handleEvent(d.PREPARING_JUMP,{duration:this._class.getPrepareDuration(),timeLeft:this._timeLeft}),this._timeLeft<=0&&(this._state=O.JumpState.JUMPING_OUT,this._timeLeft=this._class.getJumpOutDuration(),this._soundClip=this._class.createJumpOutSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play(),r=this._spacecraft._physicalModel,s=i.getRowB4(r._orientationMatrix),r.addForce(new o.Force(j,r.getMass()*this._class.getJumpOutAcceleration(),s,this._class.getJumpOutDuration())),this._spacecraft.unlockManeuvering(),this._spacecraft.setSpeedTarget(Number.MAX_VALUE),this._spacecraft.lockManeuvering(),this._originalScalingMatrix=i.matrix4(this._spacecraft._visualModel._scalingMatrix),this._spacecraft.handleEvent(d.JUMP_OUT_STARTED)),this._timeLeft-=t;break;case O.JumpState.JUMPING_OUT:this._spacecraft._visualModel.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+(1-this._timeLeft/this._class.getJumpOutDuration())*(this._class.getJumpOutScaling()-1),1))),this._timeLeft<=0&&(this._state=O.JumpState.NONE,n=new m.Explosion(this._class.getJumpOutExplosionClass(),i.matrix4(this._spacecraft.getPhysicalPositionMatrix()),i.matrix4(this._spacecraft.getPhysicalOrientationMatrix()),i.getRowC43(this._spacecraft.getPhysicalPositionMatrix()),!0,i.identity4()),n.addToScene(this._spacecraft._visualModel.getNode()._scene.getRootNode(),this._spacecraft.getSoundSource()),this._spacecraft.setAway(!0),this._spacecraft.handleEvent(d.JUMPED_OUT)),this._timeLeft-=t;break;case O.JumpState.JUMPING_IN:this._timeLeft<0&&(this._timeLeft=0),this._spacecraft._visualModel.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+this._timeLeft/this._class.getJumpInDuration()*(this._class.getJumpInScaling()-1),1))),this._timeLeft<=0&&(this._state=O.JumpState.NONE,this._spacecraft.unlockManeuvering(),this._spacecraft.enableFiring(),this._spacecraft.handleEvent(d.ARRIVED)),this._timeLeft-=t}},O.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null),this._originalScalingMatrix=null},L=a.getPool(h.Particle),D=a.getPool(y),g.executeWhenReady(function(){q=g.getSetting(g.BATTLE_SETTINGS.SELF_FIRE),W=g.getSetting(g.BATTLE_SETTINGS.MOMENT_DURATION),z=g.getSetting(g.BATTLE_SETTINGS.MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING),X=g.getSetting(g.BATTLE_SETTINGS.MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING),A=g.getSetting(g.BATTLE_SETTINGS.MAX_COMBAT_FORWARD_SPEED_FACTOR),x=g.getSetting(g.BATTLE_SETTINGS.MAX_COMBAT_REVERSE_SPEED_FACTOR),R=g.getSetting(g.BATTLE_SETTINGS.MAX_CRUISE_FORWARD_SPEED_FACTOR),C=g.getSetting(g.BATTLE_SETTINGS.MAX_CRUISE_REVERSE_SPEED_FACTOR),I=g.getSetting(g.BATTLE_SETTINGS.SHOW_HITBOXES_FOR_HITCHECKS),Y=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),J=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),v=g.getSetting(g.BATTLE_SETTINGS.FIRE_SOUND_STACKING_TIME_THRESHOLD),N=g.getSetting(g.BATTLE_SETTINGS.FIRE_SOUND_STACKING_VOLUME_FACTOR)}),{FlightMode:w,Projectile:y,Weapon:S,TargetingComputer:T,Propulsion:b,JumpEngine:O,ManeuveringComputer:M}}),define("armada/logic/spacecraft",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/physics","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/strings","armada/logic/constants","armada/logic/SpacecraftEvents","armada/logic/equipment","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,h,l,u,c,_,p,d,g,f,m,y,S){"use strict";function T(t){this._descriptor=t,this._visualModel=null,this._lightSource=null}function E(t,e,i,s,n,o){this._class=null,this._id=null,this._name=null,this._displayName=null,this._alive=!0,this._away=!1,this._hitpoints=0,this._maxHitpoints=0,this._visualModel=null,this._hitbox=null,this._blinkers=null,this._physicalModel=null,this._relativeVelocityMatrix=null,this._turningMatrix=null,this._weapons=null,this._targetingComputer=null,this._firingDisabled=!1,this._propulsion=null,this._jumpEngine=null,this._maneuveringComputer=null,this._activeDamageIndicators=[],this._explosion=null,this._eventHandlers=null,this._targetedBy=null,this._team=null,this._squad=null,this._indexInSquad=0,this._humSoundClip=null,this._humSoundVolume=0,this._soundSource=null,this._kills=0,this._score=0,this._damageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._scoreValue=0,this._timeElapsedSinceDestruction=-1,t&&this._init(t,e,i,s,n,o)}var b,M,O,A="hitBox",x="originalFactionColor",R="replacementFactionColor",C=.02,I=null,v=null,N=null;return T.prototype.addToScene=function(t,e){this._visualModel=new h.Particle(this._descriptor.getParticle().getModel(),this._descriptor.getParticle().getShader(),this._descriptor.getParticle().getTexturesOfTypes(this._descriptor.getParticle().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),i.translation4v(this._descriptor.getPosition()),this._descriptor.getParticleStates(),!0,this._descriptor.getParticle().getInstancedShader(),0),t.addSubnode(new u.RenderableNode(this._visualModel,!1,d.getSetting(d.BATTLE_SETTINGS.MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING))),e===!0&&this._descriptor.getIntensity()>0&&(this._lightSource=new l.PointLightSource(this._descriptor.getLightColor(),0,this._descriptor.getPosition(),[t._renderableObject],this._descriptor.getLightStates(),!0),t._scene.addPointLightSource(this._lightSource,f.BLINKER_LIGHT_PRIORITY))},T.prototype.setTime=function(t){this._visualModel.setAnimationTime(t),this._lightSource&&this._lightSource.setAnimationTime(t)},T.prototype.setRandomTime=function(){var t=Math.round(Math.random()*this._descriptor.getPeriod());return this.setTime(t),t},E.prototype._init=function(t,e,s,n,o,h){var l,u;for(this._class=t,this._name=e||"",this._alive=!0,this._away=!1,this._hitpoints=this._class.getHitpoints(),this._maxHitpoints=this._class.getHitpoints(),this._physicalModel=new r.PhysicalObject(this._class.getMass(),s||i.identity4(),n||i.identity4(),i.identity4(),i.identity4(),this._class.getBodies()),this._class.acquireResources(),a.executeWhenReady(function(){this.isAlive()&&this._physicalModel.setScalingMatrix(i.scaling4(this._class.getModel().getScale()))}.bind(this)),this._weapons=[],this._targetingComputer=new y.TargetingComputer(this,h),this._firingDisabled=!1,this._maneuveringComputer=new y.ManeuveringComputer(this),this._blinkers=[],u=this._class.getBlinkerDescriptors(),l=0;l<u.length;l++)this._blinkers.push(new T(u[l]));o&&this.equipProfile(this._class.getEquipmentProfile(o)),this._targetedBy=[],this._eventHandlers={},this._team=null,this._kills=0,this._score=0,this._damageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._hitSounds={},this._hitSoundTimestamp=0,this._updateIDAndName(),this._updateScoreValue()},E.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:g.get(g.SQUAD.PREFIX,this._squad)+" "+this._indexInSquad.toString()},E.prototype.isAlive=function(){return this._alive},E.prototype.isAway=function(){return this._away},E.prototype.setAway=function(t){this._away!==t&&(this._away=t,this._away?(this.setTarget(null),this._visualModel&&this._visualModel.getNode().hide(),this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(this.getSoundSource(),!1))):this._visualModel&&this._visualModel.getNode().show())},E.prototype.setTeam=function(t){this._team=t},E.prototype.getTeam=function(){return this._team},E.prototype.setSquad=function(t,e){this._squad=t,this._indexInSquad=e,this._updateIDAndName()},E.prototype.getSquad=function(){return this._squad},E.prototype.isFriendly=function(t){return t.getTeam()===this._team},E.prototype.isHostile=function(t){return t.getTeam()!==this._team},E.prototype.getClass=function(){return this._class},E.prototype.isFighter=function(){return this._class.isFighterClass()},E.prototype.getID=function(){return this._id},E.prototype.getDisplayName=function(){return this._displayName},E.prototype.getHitpoints=function(){return this._hitpoints},E.prototype.getFullIntegrityHitpoints=function(){return this._maxHitpoints},E.prototype.getHullIntegrity=function(){return this._hitpoints/this._maxHitpoints},E.prototype.multiplyMaxHitpoints=function(t){this._hitpoints*=t,this._maxHitpoints*=t},E.prototype.getVisualModel=function(){return this._visualModel},E.prototype.getPhysicalModel=function(){return this._physicalModel},E.prototype.getExplosion=function(){return this._explosion},E.prototype.getClassName=function(){return this._class.getName()},E.prototype.getTypeName=function(){return this._class.getSpacecraftType().getName()},E.prototype.isGoodAgainst=function(t){return this._class.getSpacecraftType().isGoodAgainst(t.getClass().getSpacecraftType())},E.prototype.isBadAgainst=function(t){return this._class.getSpacecraftType().isBadAgainst(t.getClass().getSpacecraftType())},E.prototype.getView=function(t){return this._class.getView(t)},E.prototype.enableFiring=function(){this._firingDisabled=!1},E.prototype.disableFiring=function(){this._firingDisabled=!0},E.prototype.getWeapons=function(){return this._weapons},E.prototype.getFirepower=function(t){var e,i=0;for(e=0;e<this._weapons.length;e++)i+=this._weapons[e].getFirepower(t);return i},E.prototype.canBeReused=function(){return!this._alive},E.prototype.getHitRatio=function(){return this._shotsFired?this._hitsOnEnemies/this._shotsFired:0},E.prototype.getKills=function(){return this._kills},E.prototype.gainKill=function(){this._kills++},E.prototype.getScore=function(){return this._score},E.prototype.gainScore=function(t){this._score+=t},E.prototype.getDamageDealt=function(){return this._damageDealt},E.prototype.gainDamageDealt=function(t){this._damageDealt+=t},E.prototype.getScoreValue=function(){return this._scoreValue},E.prototype.setPhysicalPosition=function(t){this._physicalModel.setPositionMatrix(i.translation4v(t))},E.prototype.setPhysicalPositionMatrix=function(t){this._physicalModel.setPositionMatrix(t)},E.prototype.getPhysicalPositionMatrix=function(){return this._physicalModel._positionMatrix},E.prototype.getPhysicalPositionVector=function(){return i.translationVector3(this._physicalModel._positionMatrix)},E.prototype.setPhysicalOrientationMatrix=function(t){this._physicalModel.setOrientationMatrix(t)},E.prototype.getPhysicalOrientationMatrix=function(){return this._physicalModel._orientationMatrix},E.prototype.getPhysicalScalingMatrix=function(){return this._physicalModel._scalingMatrix},E.prototype.getScaledOriMatrix=function(){return i.prod3x3SubOf4(this.getPhysicalScalingMatrix(),this.getPhysicalOrientationMatrix())},E.prototype.getPositionMatrixInCameraSpace=function(){return this._visualModel.getPositionMatrixInCameraSpace(this._visualModel.getNode()._scene.getCamera())},E.prototype.getVelocityMatrix=function(){return this._physicalModel.getVelocityMatrix()},E.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrix||(this._relativeVelocityMatrix=i.prodTranslationRotation4(this._physicalModel.getVelocityMatrix(),i.rotation4m4(this._physicalModel.getRotationMatrixInverse()))),this._relativeVelocityMatrix},E.prototype.getTurningMatrix=function(){return this._turningMatrix||(this._turningMatrix=i.prod3x3SubOf4(i.prod3x3SubOf4(this._physicalModel._orientationMatrix,this._physicalModel.getAngularVelocityMatrix()),i.rotation4m4(this._physicalModel.getRotationMatrixInverse()))),this._turningMatrix},E.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this._physicalModel.getMass():null},E.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this._physicalModel.getMass():0},E.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},E.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},E.prototype.getMaxTurnRateAtSpeed=function(t){var e=Math.abs(this._propulsion.getThrust()/(this._physicalModel.getMass()*t));return 1>=e?Math.asin(e):Number.MAX_VALUE},E.prototype.getHitboxTextures=function(){var t=c.getManagedShader(d.getSetting(d.BATTLE_SETTINGS.HITBOX_SHADER_NAME)).getTextureTypes(),e=c.getTexture(d.getSetting(d.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME),{types:t});return e.getManagedTexturesOfTypes(t,c.getTextureQualityPreferenceList())},E.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._physicalModel.getMass()/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()/(e/1e3)},E.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t/r.ANGULAR_VELOCITY_MATRIX_DURATION_S*this._physicalModel.getMass()/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()/(e/1e3)},E.prototype.loadFromJSON=function(t,e){var n,o;this._init(p.getSpacecraftClass(t["class"]),t.name,t.position?i.translation4v(t.position):null,i.rotation4FromJSON(t.rotations),void 0,e),t.squad&&("string"==typeof t.squad?(o=t.squad.split(" "),this.setSquad(o[0],parseInt(o[1],10))):"object"==typeof t.squad?this.setSquad(t.squad.name,t.squad.index):s.showError("Invalid squad property specified for spacecraft "+this.getID()+"!")),t.equipment?"string"==typeof t.equipment?this.equipProfile(this._class.getEquipmentProfile(t.equipment)):"object"==typeof t.equipment?(n=new p.EquipmentProfile(t.equipment),this.equipProfile(n)):s.showError("Invalid equipment property specified for spacecraft "+this.getID()+"!"):void 0!==this._class.getEquipmentProfile(d.getSetting(d.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME))&&this.equipProfile(this._class.getEquipmentProfile(d.getSetting(d.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME))),t.away&&this.setAway(!0)},E.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},E.prototype.isManeuveringLocked=function(){return this._maneuveringComputer.isLocked()},E.prototype.lockManeuvering=function(){this._maneuveringComputer.setLocked(!0)},E.prototype.unlockManeuvering=function(){this._maneuveringComputer.setLocked(!1)},E.prototype.getFlightMode=function(){return this._maneuveringComputer.getFlightMode()},E.prototype.changeFlightMode=function(t){return this._maneuveringComputer.changeFlightMode(t)},E.prototype.toggleFlightAssist=function(){return this._maneuveringComputer.toggleFlightAssist()},E.prototype.toggleCruise=function(){return this._maneuveringComputer.toggleCruise()},E.prototype.forward=function(t){this._maneuveringComputer.forward(t)},E.prototype.stopForward=function(){this._maneuveringComputer.stopForward()},E.prototype.reverse=function(t){this._maneuveringComputer.reverse(t)},E.prototype.stopReverse=function(){this._maneuveringComputer.stopReverse()},E.prototype.strafeLeft=function(t){this._maneuveringComputer.strafeLeft(t)},E.prototype.stopLeftStrafe=function(){this._maneuveringComputer.stopLeftStrafe()},E.prototype.strafeRight=function(t){this._maneuveringComputer.strafeRight(t)},E.prototype.stopRightStrafe=function(){this._maneuveringComputer.stopRightStrafe()},E.prototype.raise=function(t){this._maneuveringComputer.raise(t)},E.prototype.stopRaise=function(){this._maneuveringComputer.stopRaise()},E.prototype.lower=function(t){this._maneuveringComputer.lower(t)},E.prototype.stopLower=function(){this._maneuveringComputer.stopLower()},E.prototype.resetSpeed=function(){this._maneuveringComputer.resetSpeed()},E.prototype.setSpeedTarget=function(t){this._maneuveringComputer.setSpeedTarget(t)},E.prototype.getSpeedTarget=function(){return this._maneuveringComputer.getSpeedTarget()},E.prototype.hasSpeedTarget=function(){return this._maneuveringComputer.hasSpeedTarget()},E.prototype.getMaxSpeed=function(){return this._maneuveringComputer.getMaxSpeed()},E.prototype.yawLeft=function(t){this._maneuveringComputer.yawLeft(t)},E.prototype.yawRight=function(t){this._maneuveringComputer.yawRight(t)},E.prototype.pitchUp=function(t){this._maneuveringComputer.pitchUp(t)},E.prototype.pitchDown=function(t){this._maneuveringComputer.pitchDown(t)},E.prototype.rollLeft=function(t){this._maneuveringComputer.rollLeft(t)},E.prototype.rollRight=function(t){this._maneuveringComputer.rollRight(t)},E.prototype._addHitboxModel=function(t){var e=a.getOrAddModel(o.cuboidModel(A,1,1,1,b)),s=new h.ShadedLODMesh(e.getEgomModel(),c.getManagedShader(d.getSetting(d.BATTLE_SETTINGS.HITBOX_SHADER_NAME)),this.getHitboxTextures(),i.translation4m4(this._class.getBodies()[t]._positionMatrix),this._class.getBodies()[t]._orientationMatrix,i.scaling4(this._class.getBodies()[t].getWidth(),this._class.getBodies()[t].getHeight(),this._class.getBodies()[t].getDepth()),!1);s.setUniformValueFunction(h.UNIFORM_COLOR_NAME,function(){return b}),s.setUniformValueFunction(v,function(){return N}),this._hitbox.addSubnode(new u.RenderableNode(s))},E.prototype.getHitbox=function(t){return void 0===t?this._hitbox:this._hitbox._subnodes[t]},E.prototype.acquireResources=function(t,e,i){s.log_DEBUG("Requesting resources for spacecraft ("+this._class.getName()+")...",2);var n=void 0===t?{maxLOD:c.getMaxLoadedLOD()}:{lod:t};e&&(c.getShader(d.getSetting(d.BATTLE_SETTINGS.HITBOX_SHADER_NAME)),c.getTexture(d.getSetting(d.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME))),n.omitShader=i,this._class.acquireResources(n)},E.prototype.addToScene=function(t,e,o,r,_,p,d){var g,m,y,T;if(r=r||{},_=_||{},this.acquireResources(e,r&&r.hitboxes===!0,!!_.shaderName),_.shaderName&&c.getShader(_.shaderName),r.weapons===!0)for(g=0;g<this._weapons.length;g++)this._weapons[g].acquireResources(e,r.projectileResources);if(r.thrusterParticles===!0&&this._propulsion&&(this._propulsion.addThrusters(this._class.getThrusterSlots()),this._propulsion.acquireResources()),r.jumpEngine===!0&&this._jumpEngine&&this._jumpEngine.acquireResources(),r.explosion===!0&&this._class.getExplosionClass().acquireResources(),r.blinkers===!0)for(m=this._class.getBlinkerDescriptors(),g=0;g<m.length;g++)m[g].acquireResources();a.executeWhenReady(function(){var a,m,E,b,M,O,A,C={};if(!this._class)return void s.log("WARNING! Cannot add spacecraft to scene because it has already been destroyed!");if(s.log_DEBUG("Adding spacecraft ("+this._class.getName()+") to scene...",2),r.self!==!1){for(C[v]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(C[I]=n.ShaderVariableType.FLOAT),y=new h.ParameterizedMesh(this._class.getModel(),_.shaderName?c.getManagedShader(_.shaderName):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),_.positionMatrix||this._physicalModel._positionMatrix,_.orientationMatrix||this._physicalModel._orientationMatrix,i.scaling4(this._class.getModel().getScale()),o===!0,e,C),(!this._visualModel||_.replaceVisualModel)&&(this._visualModel=y),this._name&&y.setName(this._name),O=this._class.getFactionColor(),A=_.factionColor||this._team&&this._team.getColor()||O,y.setUniformValueFunction(x,function(){return O}),y.setUniformValueFunction(R,function(){return A}),g=0,m=c.getMaxGroupTransforms();m>g;g++)y.setMat4Parameter(v,g,i.identity4());if(c.areLuminosityTexturesAvailable())for(a=0,m=c.getMaxLuminosityFactors();m>a;a++)y.setFloatParameter(I,a,this._class.getDefaultGroupLuminosity(a));E=t.addObject(y),_.visualModel&&s.showError("Attempting to specify a visual model for the Spacecraft.addToScene() operation while a new one is also created!",s.ErrorSeverity.MINOR)}else y=_.visualModel||this._visualModel,E=y.getNode();if(r.hitboxes===!0){for(this._hitbox=new u.RenderableNode(new h.RenderableObject3D(this._class.getShader(),!1,!1)),g=0;g<this._class.getBodies().length;g++)this._addHitboxModel(g);this._hitbox.hide(),E.addSubnode(this._hitbox)}if(r.weapons===!0)for(g=0;g<this._weapons.length;g++)this._weapons[g].addToScene(E,e,o,{shaderName:_.shaderName},d);if(r.thrusterParticles===!0&&this._propulsion&&this._propulsion.addToScene(E),r.projectileResources===!0)for(g=0;g<this._weapons.length;g++)this._weapons[g].addProjectileResourcesToScene(t);if(r.explosion===!0&&(b=new S.Explosion(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),b.addResourcesToScene(t)),r.cameraConfigurations===!0&&this._addCameraConfigurationsForViews(),r.lightSources===!0)for(M=this._class.getLightSources(),g=0;g<M.length;g++)M[g].spotDirection?t.addSpotLightSource(new l.SpotLightSource(M[g].color,M[g].intensity,M[g].position,M[g].spotDirection,M[g].spotCutoffAngle,M[g].spotFullIntensityAngle,[y])):t.addPointLightSource(new l.PointLightSource(M[g].color,M[g].intensity,M[g].position,[y]),f.SPACECRAFT_LIGHT_PRIORITY);if(r.blinkers===!0)for(g=0;g<this._blinkers.length;g++)this._blinkers[g].addToScene(E,r.lightSources),_.randomAnimationTime&&(0===g?T=this._blinkers[g].setRandomTime():this._blinkers[g].setTime(T));this._away&&E.hide(),p&&p(y)}.bind(this))},E.prototype.createCameraConfigurationForView=function(t){return t.createCameraConfiguration(this._visualModel,d.getDefaultCameraBaseOrientation(),d.getDefaultCameraPointToFallback(),d.getDefaultCameraFOV(),d.getDefaultCameraFOVRange(),d.getDefaultCameraSpan(),d.getDefaultCameraSpanRange())},E.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class.getViews().length;t++)this._visualModel.getNode().addCameraConfiguration(this.createCameraConfigurationForView(this._class.getViews()[t]))},E.prototype._updateScoreValue=function(){var t;for(this._scoreValue=this._class.getScoreValue(),t=0;t<this._weapons.length;t++)this._scoreValue+=this._weapons[t].getScoreValue();this._propulsion&&(this._scoreValue+=this._propulsion.getScoreValue())},E.prototype._addWeapon=function(t){var e,i=this._class.getWeaponSlots();this._weapons.length<i.length&&(e=i[this._weapons.length],this._weapons.push(new y.Weapon(t,this,e)))},E.prototype._addPropulsion=function(t){this._propulsion=new y.Propulsion(t,this._physicalModel),this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit()},E.prototype._addJumpEngine=function(t){this._jumpEngine=new y.JumpEngine(t,this)},E.prototype.unequip=function(){var t;for(t=0;t<this._weapons.length;t++)this._weapons[t].destroy();this._weapons=[],this._propulsion=null,this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit(),this._updateScoreValue()},E.prototype.equipProfile=function(t){var e;if(t){for(e=0;e<t.getWeaponDescriptors().length;e++)this._addWeapon(p.getWeaponClass(t.getWeaponDescriptors()[e].className));null!==t.getPropulsionDescriptor()&&this._addPropulsion(p.getPropulsionClass(t.getPropulsionDescriptor().className)),null!==t.getJumpEngineDescriptor()&&this._addJumpEngine(p.getJumpEngineClass(t.getJumpEngineDescriptor().className))}else s.log("WARNING: equipping empty profile on "+this._class.getName()+"!");this._updateScoreValue()},E.prototype.getEquipmentProfileNames=function(){return this._class.getEquipmentProfileNames()},E.prototype.fire=function(t){var e,s,n,o,r=!1;if(!this._firingDisabled){for(s=this.getScaledOriMatrix(),o=i.translationVector3(this.getPositionMatrixInCameraSpace()),Math.abs(o[0])<=M&&Math.abs(o[1])<=M&&Math.abs(o[2])<=M&&(o=null),e=0;e<this._weapons.length;e++)n=this._weapons[e].fire(s,t,o?this.getSoundSource():null),r=n>0||r,this._shotsFired+=n;if(r){for(e=0;e<this._targetedBy.length;e++)this._targetedBy[e].handleEvent(m.TARGET_FIRED);this.handleEvent(m.FIRED)}}},E.prototype.increaseHitsOnEnemies=function(){this._hitsOnEnemies++},E.prototype.setBeingTargeted=function(t){this._targetedBy&&(this._targetedBy.push(t),this.handleEvent(m.BEING_TARGETED,{spacecraft:t}))},E.prototype.setBeingUntargeted=function(t){this._targetedBy&&this._targetedBy.splice(this._targetedBy.indexOf(t),1)},E.prototype.getTargetingSpacecrafts=function(){return this._targetedBy},E.prototype.setTarget=function(t){this._targetingComputer.setTarget(t)},E.prototype.targetNextNearestHostile=function(){return this._targetingComputer.targetNextNearestHostile()},E.prototype.targetPreviousNearestHostile=function(){return this._targetingComputer.targetPreviousNearestHostile()},E.prototype.targetNextBestHostile=function(){return this._targetingComputer.targetNextBestHostile()},E.prototype.targetNextNearestNonHostile=function(){return this._targetingComputer.targetNextNearestNonHostile()},E.prototype.getTarget=function(){return this._targetingComputer.getTarget()},E.prototype.getTargetHitPosition=function(){return this._targetingComputer.getTargetHitPosition()},E.prototype.getPropulsion=function(){return this._propulsion},E.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},E.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},E.prototype.showHitbox=function(){this._hitbox.show()},E.prototype.hideHitbox=function(){this._hitbox.hide()},E.prototype.toggleHitboxVisibility=function(){this._hitbox.toggleVisibility()},E.prototype.resetViewCameras=function(){this._visualModel.getNode().resetCameraConfigurations()},E.prototype.damage=function(t,e,s,n){var o,r,a,h,l,u;if(t=Math.max(0,t-this._class.getArmor()),l=this._hitpoints>0,this._hitpoints-=t,this._hitpoints<=0)l&&n&&this.isHostile(n)&&(u=this.getScoreValue(),t+=this._hitpoints,n.gainDamageDealt(t),n.gainScore((1-O)*t/this._maxHitpoints*u),n.gainScore(O*u),n.gainKill()),this._hitpoints=0;else{for(o=0;o<this._class.getDamageIndicators().length;o++)r=this._class.getDamageIndicators()[o],a=r.hullIntegrity/100*this._maxHitpoints,this._hitpoints<=a&&this._hitpoints+t>a&&(h=new S.Explosion(r.explosionClass,i.translation4v(e),i.identity4(),s,!0),h.addToScene(this._visualModel.getNode(),this.getSoundSource()),this._activeDamageIndicators.push(h));l&&n&&n.isAlive()&&this.isHostile(n)&&(n.gainDamageDealt(t),n.gainScore((1-O)*t/this._maxHitpoints*this.getScoreValue()))}this.handleEvent(m.BEING_HIT,{spacecraft:n,hitPosition:e}),n.isAlive()&&!n.isAway()&&(n.getTarget()===this&&n.handleEvent(m.TARGET_HIT),n.handleEvent(m.ANY_SPACECRAFT_HIT,{spacecraft:this})),this.isHostile(n)&&n.increaseHitsOnEnemies()},E.prototype.aimWeapons=function(t,e,i){var s,n,o=this.getTarget();for(o&&this._weapons.length>0&&(s=this.getTargetHitPosition()),n=0;n<this._weapons.length;n++)o&&!this._firingDisabled?this._weapons[n].aimTowards(s,t,e,this.getScaledOriMatrix(),i):this._weapons[n].rotateToDefaultPosition(t,i)},E.prototype.jumpOut=function(){!this._away&&this._jumpEngine?this._jumpEngine.jumpOut():s.log("Warning! Spacecraft '"+this.getDisplayName()+"' cannot jump out because it is already away or has no jump engines!")},E.prototype.jumpIn=function(){this._away&&this._jumpEngine?this._jumpEngine.jumpIn():s.log("Warning! Spacecraft '"+this.getDisplayName()+"' cannot jump in because it is already present or has no jump engines!")},E.prototype._getSoundSourcePosition=function(){var t=this.getPositionMatrixInCameraSpace();return t=[parseFloat(t[12].toPrecision(1)),parseFloat(t[13].toPrecision(1)),parseFloat(t[14].toPrecision(1))]},E.prototype.getSoundSource=function(){return this._soundSource||(this._soundSource=_.createSoundSource([0,0,0])),this._soundSource},E.prototype._startHumSound=function(){this._humSoundClip.setVolume(0),this._humSoundClip.play(),this._humSoundClip.rampVolume(this._humSoundVolume,C,!0,!0)},E.prototype.respawn=function(t){var e;for(this._alive=!0,this._hitpoints=this._maxHitpoints,this._timeElapsedSinceDestruction=-1,this._humSoundClip&&this._startHumSound(),e=0;e<this._blinkers.length;e++)t?this._blinkers[e].setRandomTime():this._blinkers[e].setTime(0)},E.prototype.setHitpointsToZero=function(){this._hitpoints=0},E.DEFAULT_SIMULATE_PARAMS={controlThrusters:!0,applyThrusterForces:!0},E.prototype.simulate=function(t,e){
var s,n;if(this._alive&&!this._away){if(e=e||E.DEFAULT_SIMULATE_PARAMS,this._targetingComputer.simulate(t),n=this._getSoundSourcePosition(),this.getSoundSource().setPosition(n[0],n[1],n[2]),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0)for(this._timeElapsedSinceDestruction=0,this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(this.getSoundSource(),!1)),this._explosion=new S.Explosion(this._class.getExplosionClass(),i.matrix4(this._physicalModel._positionMatrix),i.matrix4(this._physicalModel._orientationMatrix),i.getRowC43(this._physicalModel._positionMatrix),!0,i.matrix4(this._physicalModel.getVelocityMatrix())),this._explosion.addToScene(this._visualModel.getNode()._scene.getRootNode(),this.getSoundSource()),s=0;s<this._activeDamageIndicators;s++)this._activeDamageIndicators[s].finish();else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class.getExplosionClass().getTotalDuration()*this._class.getShowTimeRatioDuringExplosion())return this._alive=!1,void(this.handleEvent(m.DESTRUCTED)!==!1&&this.destroy(!0))}else{for(s=0;s<this._weapons.length;s++)this._weapons[s].simulate(t);this._propulsion&&(e.controlThrusters&&this._maneuveringComputer.controlThrusters(t),this._propulsion.simulate(this._soundSource,e.applyThrusterForces)),this._jumpEngine&&this._jumpEngine.simulate(t),this._class.hasHumSound()&&(this._humSoundClip||(this._humSoundClip=this._class.createHumSoundClip(this._soundSource),this._humSoundVolume=this._humSoundClip.getVolume(),this._humSoundClip&&this._startHumSound()))}this._physicalModel.simulate(t),this._relativeVelocityMatrix=null,this._turningMatrix=null,this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),this._propulsion&&this._maneuveringComputer.updateSpeedIncrement(t)}},E.prototype.addEventHandler=function(t,e){this._eventHandlers[t]=this._eventHandlers[t]||[],this._eventHandlers[t].push(e)},E.prototype.handleEvent=function(t,e){var i,s;if(this._eventHandlers&&this._eventHandlers[t])for(s=!0,i=0;i<this._eventHandlers[t].length;i++)s=this._eventHandlers[t][i](e)&&s;return s},E.prototype.destroy=function(t){var e;if(t||(this._class=null),this._weapons)for(e=0;e<this._weapons.length;e++)this._weapons[e]&&(this._weapons[e].destroy(),this._weapons[e]=null);if(this._weapons=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._jumpEngine&&(this._jumpEngine.destroy(),this._jumpEngine=null),this._maneuveringComputer&&(this._maneuveringComputer.destroy(),this._maneuveringComputer=null),this._targetingComputer&&(this._targetingComputer.destroy(),this._targetingComputer=null),this._targetedBy=null,this._eventHandlers=null,this._explosion=null,this._hitbox&&this._hitbox.markAsReusable(),this._hitbox=null,this._visualModel&&this._visualModel.getNode()&&!this._visualModel.getNode().canBeReused()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null,this._activeDamageIndicators){for(e=0;e<this._activeDamageIndicators.length;e++)this._activeDamageIndicators[e].destroy(),this._activeDamageIndicators[e]=null;this._activeDamageIndicators=null}this._alive=!1,this._humSoundClip&&(this._humSoundClip.destroy(),this._humSoundClip=null),this._soundSource&&(this._soundSource=null)},d.executeWhenReady(function(){var t;for(I=d.getSetting(d.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),v=d.getSetting(d.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),N=new Float32Array(16*c.getMaxGroupTransforms()),t=0;t<N.length;t++)N[t]=i.IDENTITY4[t%16];b=d.getSetting(d.BATTLE_SETTINGS.HITBOX_COLOR),M=d.getSetting(d.BATTLE_SETTINGS.WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE),O=d.getSetting(d.BATTLE_SETTINGS.SCORE_FRACTION_FOR_KILL)}),{Spacecraft:E}}),define("armada/logic/ai",["utils/vectors","utils/matrices","modules/application","modules/physics","armada/configuration","armada/logic/SpacecraftEvents","armada/logic/classes","armada/logic/equipment","utils/polyfill"],function(t,e,i,s,n,o,r,a){"use strict";function h(t,e){this._spacecraft=t,this._mission=e,this._standingDown=!1,this._targetList=null,this._priorityTargets=!1,this._hitCountByNonTarget=0,this._weaponRange=this._spacecraft&&this._spacecraft.getWeapons().length>0?this._spacecraft.getWeapons()[0].getRange():0,this._attackingTarget=!1,this._spacecraft&&(this._spacecraft.addEventHandler(o.BEING_HIT,this._handleBeingHit.bind(this)),this._spacecraft.addEventHandler(o.COMMAND_RECEIVED,this._handleCommand.bind(this)))}function l(t,e){h.call(this,t,e),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=y.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=O,this._isBlockedBy=null,this._facingTarget=!1,this._targetDistance=0,this._targetOffset=[0,0,0],this._targetOffsetUpdateTimeLeft=0,this._maxAimError=0,this._aimError=[0,0],this._fireDelayLeft=0,this._spacecraft.addEventHandler(o.TARGET_HIT,this._handleTargetHit.bind(this)),this._spacecraft.addEventHandler(o.ANY_SPACECRAFT_HIT,this._handleAnySpacecraftHit.bind(this)),this._spacecraft.addEventHandler(o.TARGET_FIRED,this._handleTargetFired.bind(this))}function u(t,e){h.call(this,t,e)}function c(){this._ais=[]}var _,p,d,g={JUMP:"jump",TARGET:"target",STAND_DOWN:"standDown"},f={IN:"in",OUT:"out"},m={WEDGE:"wedge"},y={NONE:-1,APPROACH_ATTACK:0,EVADE:1},S="fighter",T="ship",E=.001,b=1e3/s.ANGULAR_VELOCITY_MATRIX_DURATION,M=Math.radians(45),O=.3,A=.125,x=.05,R=5,C=.06,I=.5,v=3,N=5,L=3,D=15,w=4,F=1,P=.25,V=3,U=Math.radians(45),B=1,j=1,G=1,k=1e3,H=1500,q=Math.radians(2),W=.5,z=625,X=350,Y=.9,J=0,Q=0;return h.prototype.turn=function(e,i,s){var n,o,r,a,h;n=this._spacecraft.getTurningMatrix(),r=this._spacecraft.getMaxAngularAcceleration(),h=Q/(r*s),o=Math.sign(n[4])*t.angle2u([0,1],t.normal2([n[4],n[5]]))*b,a=Math.max(o*o/(2*r),E),e>a?this._spacecraft.yawLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.yawRight(Math.min(Math.max(0,h*(-e-a)),1)),o=Math.sign(n[6])*t.angle2u([1,0],t.normal2([n[5],n[6]]))*b,a=Math.max(o*o/(2*r),E),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,h*(-i-a)),1))},h.prototype.rollAndYaw=function(e,i,s){var n,o,r,a,h;n=this._spacecraft.getTurningMatrix(),r=this._spacecraft.getMaxAngularAcceleration(),h=Q/(r*s),o=Math.sign(n[2])*t.angle2u([1,0],t.normal2([n[0],n[2]]))*b,a=Math.max(o*o/(2*r),E),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,h*(-e-a)),1)),o=Math.sign(n[4])*t.angle2u([0,1],t.normal2([n[4],n[5]]))*b,a=Math.max(o*o/(2*r),E),i>a?this._spacecraft.yawLeft(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.yawRight(Math.min(Math.max(0,h*(-i-a)),1))},h.prototype.rollAndPitch=function(e,i,s){var n,o,r,a,h;n=this._spacecraft.getTurningMatrix(),r=this._spacecraft.getMaxAngularAcceleration(),h=Q/(r*s),o=Math.sign(n[2])*t.angle2u([1,0],t.normal2([n[0],n[2]]))*b,a=Math.max(o*o/(2*r),E),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,h*(-e-a)),1)),o=Math.sign(n[6])*t.angle2u([1,0],t.normal2([n[5],n[6]]))*b,a=Math.max(o*o/(2*r),E),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,h*(-i-a)),1))},h.prototype.approach=function(t,e,i,s){var n,o;n=this._spacecraft.getRelativeVelocityMatrix()[13],o=n*n/(2*this._spacecraft.getMaxAcceleration()),0>n&&(o=-o),t-o>e?this._spacecraft.setSpeedTarget(s):i>=0&&i>t-o?this._spacecraft.setSpeedTarget(-s):this._spacecraft.resetSpeed()},h.prototype._handleTargetSwitch=function(){this._hitCountByNonTarget=0},h._targetListFilterFunction=function(t){return t.isAlive()},h.prototype._updateTarget=function(t){var e,i;if(this._standingDown)return void this._spacecraft.setTarget(null);if(i=this._spacecraft.getTarget(),this._targetList&&(this._targetList=this._targetList.filter(h._targetListFilterFunction)),this._targetList&&this._targetList.length>0){if(this._priorityTargets){if(t)this._targetList.indexOf(t)>=0&&this._spacecraft.setTarget(t);else if(!i||this._targetList.indexOf(i)<0){for(e=0;e<this._targetList.length;e++)if(!this._targetList[e].isAway()){this._spacecraft.setTarget(this._targetList[e]);break}!i&&e>=this._targetList.length&&this._spacecraft.targetNextBestHostile()}}else if(t)this._spacecraft.setTarget(t);else if(!i){for(e=0;e<this._targetList.length;e++)if(!this._targetList[e].isAway()){this._spacecraft.setTarget(this._targetList[e]);break}e>=this._targetList.length&&this._spacecraft.targetNextBestHostile()}}else t?this._spacecraft.setTarget(t):i||this._spacecraft.targetNextBestHostile();this._spacecraft.getTarget()!==i&&this._handleTargetSwitch()},h.prototype._handleBeingHit=function(t){var e=t.spacecraft;this._spacecraft&&!this._spacecraft.canBeReused()&&!e.canBeReused()&&!e.isAway()&&e.isHostile(this._spacecraft)&&this._spacecraft.getTarget()&&this._spacecraft.getTarget()!==e&&(this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._attackingTarget||this._updateTarget(e),this._hitCountByNonTarget++)},h.prototype._getPositionInFormation=function(t,e){var s=Math.ceil(e/2);switch(t.type){case m.WEDGE:return[(e%2===1?1:-1)*s*t.spacing[0],s*t.spacing[1],s*t.spacing[2]];default:return i.showError("Unknown formation type specified: '"+t.type+"!"),[0,0,0]}},h.prototype._handleCommand=function(s){var n,o,r,a;switch(s.command){case g.JUMP:o=s.jump&&s.jump.way?s.jump.way:this._spacecraft.isAway()?f.IN:f.OUT,o===f.IN?(s.jump&&(s.lead&&s.index>0&&s.jump.formation?(this._spacecraft.setPhysicalPosition(t.sum3(s.lead.getPhysicalPositionVector(),t.mulVec3Mat4(this._getPositionInFormation(s.jump.formation,s.index),s.lead.getPhysicalOrientationMatrix()))),this._spacecraft.setPhysicalOrientationMatrix(e.matrix4(s.lead.getPhysicalOrientationMatrix()))):s.jump.anchor&&(s.clearCache&&(s.jump.anchorSpacecraft=null,s.clearCache=!1),r=s.jump.anchorSpacecraft||this._mission.getSpacecraft(s.jump.anchor),r?(s.jump.anchorSpacecraft=r,s.jump.distance?(this._spacecraft.setPhysicalOrientationMatrix(e.prod3x3SubOf4(e.rotation4([1,0,0],(_()-.5)*Math.PI),e.rotation4([0,0,1],2*_()*Math.PI))),this._spacecraft.setPhysicalPosition(t.scaled3(e.getRowB4(this._spacecraft.getPhysicalOrientationMatrix()),-s.jump.distance))):(s.jump.position&&this._spacecraft.setPhysicalPosition(s.jump.position),s.jump.rotations&&this._spacecraft.setPhysicalOrientationMatrix(e.rotation4FromJSON(s.jump.rotations))),s.jump.relative&&(this._spacecraft.setPhysicalPositionMatrix(e.prodTranslationRotation4(this._spacecraft.getPhysicalPositionMatrix(),r.getPhysicalOrientationMatrix())),this._spacecraft.setPhysicalOrientationMatrix(e.prod4(this._spacecraft.getPhysicalOrientationMatrix(),r.getPhysicalOrientationMatrix()))),this._spacecraft.setPhysicalPosition(t.sum3(this._spacecraft.getPhysicalPositionVector(),r.getPhysicalPositionVector()))):i.showError("'"+this._spacecraft.getDisplayName()+"' has an invalid anchor for inward jump: '"+s.jump.anchor+"'!"))),this._spacecraft.jumpIn()):this._spacecraft.jumpOut();break;case g.TARGET:if(s.target){if(s.clearCache&&(s.target.targetSpacecrafts=null,s.clearCache=!1),s.target.targetSpacecrafts)this._targetList=s.target.targetSpacecrafts.slice();else{if(s.target.single)a=this._mission.getSpacecraft(s.target.single),a?this._targetList=[a]:i.log("Warning: '"+this._spacecraft.getDisplayName()+"' has an invalid target specified: '"+s.target.single+"'. Might be because the ship is already destroyed.");else if(s.target.list)for(this._targetList=[],n=0;n<s.target.list.length;n++)a=this._mission.getSpacecraft(s.target.list[n]),a?this._targetList.push(a):i.log("Warning: '"+this._spacecraft.getDisplayName()+"' has an invalid target specified: '"+s.target.list[n]+"'. Might be because the ship is already destroyed.");else if(s.target.squads)for(this._targetList=[],n=0;n<s.target.squads.length;n++)this._targetList=this._targetList.concat(this._mission.getSpacecraftsInSquad(s.target.squads[n]));else i.showError("'"+this._spacecraft.getDisplayName()+"' has no target specified for targeting command!");this._targetList&&(s.target.targetSpacecrafts=this._targetList.slice())}this._targetList&&this._targetList.length>0&&this._spacecraft.setTarget(this._targetList[0]),this._priorityTargets=s.target.priority===!0}break;case g.STAND_DOWN:this._standingDown=!0;break;default:i.showError("Unknown spacecraft command: '"+s.command+"'!")}},l.prototype=new h,l.prototype.constructor=l,l.prototype._updateAimError=function(){this._aimError[0]=2*(Math.random()-.5)*this._maxAimError,this._aimError[1]=2*(Math.random()-.5)*this._maxAimError},l.prototype._startNewAttackRun=function(){this._chargePhase=y.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=O,this._isBlockedBy=null,this._rollTime=-1,this._targetOffset=[0,0,0],this._targetOffsetUpdateTimeLeft=H,this._maxAimError=q,this._fireDelayLeft=X,this._updateAimError()},l.prototype._handleTargetSwitch=function(){h.prototype._handleTargetSwitch.call(this),this._startNewAttackRun()},l.prototype._handleBeingHit=function(e){!this._isBlockedBy&&this._evasiveManeuverTime<0&&(this._evasiveManeuverTime=0,this._evasiveVelocityVector[0]=-e.hitPosition[0],this._evasiveVelocityVector[1]=-e.hitPosition[2],t.normalize2(this._evasiveVelocityVector)),h.prototype._handleBeingHit.call(this,e)},l.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},l.prototype._handleAnySpacecraftHit=function(t){var e=t.spacecraft;!this._spacecraft||this._spacecraft.canBeReused()||e===this._spacecraft||this._chargePhase===y.EVADE||e===this._spacecraft.getTarget()||this._isBlockedBy&&!this._isBlockedBy.isHostile(this._spacecraft)||(this._isBlockedBy=e,this._evasiveManeuverTime=-1,this._chargePhase=y.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT))},l.prototype._handleTargetFired=function(){var e;!this._isBlockedBy&&this._evasiveManeuverTime<0&&this._facingTarget&&this._spacecraft&&this._spacecraft.getTarget()&&this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._targetDistance>this._weaponRange*I&&(this._evasiveManeuverTime=0,e=2*Math.random()*Math.PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,t.rotate2(this._evasiveVelocityVector,e))},l.prototype.handleSceneMoved=function(e){t.add3(this._chargeDestination,e)},l.prototype.control=function(i){var s,n,o,r,h,l,u,c,_,p,d,g,f,m,S,T,b,O,I,Y,Q,K,Z,$,tt,et,it,st,nt,ot;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);if(this._spacecraft.isAway())return;st=!1,this._updateTarget(),f=this._spacecraft.getMaxAcceleration(),p=this._spacecraft._visualModel.getScaledSize(),n=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),ot=e.inverseOfRotation4(this._spacecraft.getPhysicalOrientationMatrix()),T=this._spacecraft.getRelativeVelocityMatrix()[13],s=this._spacecraft.getTarget(),this._attackingTarget=!1,this._chargePhase===y.EVADE?(this._attackingTarget=!!s,r=t.diff3(this._chargeDestination,n),u=t.mulVec3Mat4(r,ot),this._targetDistance=t.length3(u),t.normalize3(u),et=t.getYawAndPitch(u),this.turn(et.yaw,et.pitch,i),this._spacecraft.setSpeedTarget(f*L),(this._targetDistance<=B||u[1]<0||0>T)&&this._startNewAttackRun()):s?(o=e.translationVector3(s.getPhysicalPositionMatrix()),this._targetOffsetUpdateTimeLeft<=0?(this._targetOffsetUpdateTimeLeft=H,h=t.diff3(this._spacecraft.getTargetHitPosition(),o),t.length3Squared(t.diff3(this._targetOffset,h))<z?this._maxAimError*=W:this._maxAimError=q,this._targetOffset=h,this._updateAimError()):this._targetOffsetUpdateTimeLeft-=i,t.add3(o,this._targetOffset),r=t.diff3(o,n),u=t.mulVec3Mat4(r,ot),this._targetDistance=t.length3(u),t.normalize3(u),et=t.getYawAndPitch(u),et.yaw+=this._aimError[0],et.pitch+=this._aimError[1],this._facingTarget=Math.abs(et.yaw)<M&&Math.abs(et.pitch)<M,this.turn(et.yaw,et.pitch,i),this._isBlockedBy&&(it=!1,!this._isBlockedBy.canBeReused()&&this._facingTarget&&this._isBlockedBy._physicalModel.checkHit(o,r,1e3,p/2)&&(c=t.mulVec3Mat4(t.diff3(e.translationVector3(this._isBlockedBy.getPhysicalPositionMatrix()),n),ot),b=f*F,c[0]<0?(this._spacecraft.strafeRight(b),it=!0):(this._spacecraft.strafeLeft(b),it=!0),c[2]>0?(this._spacecraft.lower(b),it=!0):(this._spacecraft.raise(b),it=!0)),it||(this._isBlockedBy=null,this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()),st=!0),nt=this._spacecraft.getWeapons(),nt&&nt.length>0?(d=s._visualModel.getScaledSize(),g=Math.atan(P*d/this._targetDistance),$=nt[0].getProjectileVelocity()+T,_=this._targetDistance/$*1e3,I=nt[0].getCooldown(),this._spacecraft.aimWeapons(E,g,i),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),t.length3(t.diff3(this._spacecraft.getTargetHitPosition(),n))<=nt[0].getRange(T)?(this._attackingTarget=!0,Math.abs(et.yaw)<g&&Math.abs(et.pitch)<g&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._spacecraft))?this._fireDelayLeft>0?this._fireDelayLeft-=i:(this._spacecraft.fire(),this._isBlockedBy||(this._timeSinceLastRoll+=i,this._timeSinceLastTargetHit+=i,this._timeSinceLastClosingIn+=i,Q=_+V*I,this._timeSinceLastRoll>Q&&this._timeSinceLastTargetHit>Q&&(this._rollTime=0),this._rollTime>=0&&(this._spacecraft.rollLeft(),this._timeSinceLastRoll=0,this._rollTime+=i,K=this._spacecraft.getMaxAngularAcceleration(),Z=K*J,Y=U>Z*J?J+(U-Z*J)/Z:Math.sqrt(4*U/K)/2,this._rollTime>1e3*Y&&(this._rollTime=-1)))):(this._timeSinceLastRoll=0,this._fireDelayLeft=X)):(this._timeSinceLastRoll=0,this._fireDelayLeft=X),this._chargePhase===y.NONE&&(this._hitCountByNonTarget>=w||this._timeSinceLastTargetHit>_+D*I)&&(this._chargePhase=y.APPROACH_ATTACK,this._spacecraft.changeFlightMode(a.FlightMode.CRUISE)),this._chargePhase===y.NONE?(tt=_+R*I,this._timeSinceLastClosingIn>tt&&this._timeSinceLastTargetHit>tt&&this._maxDistanceFactor>A&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-x,A),this._timeSinceLastClosingIn=0),O=.5*(p+d),S=O+this._maxDistanceFactor*this._weaponRange,m=O+C*this._weaponRange,this._facingTarget?this.approach(this._targetDistance,S,m,f*v):this._spacecraft.resetSpeed()):this._chargePhase===y.APPROACH_ATTACK&&(S=Math.sqrt(2*(d+.5*p)/f)*f*N,this._facingTarget?(this._spacecraft.setSpeedTarget(f*N),this._targetDistance<=S&&(this._chargePhase=y.EVADE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),l=t.normal3(r),this._chargeDestination=t.sum3(n,t.scaled3(t.diff3(t.sum3(o,t.scaled3(t.normal3(t.mulVec3Mat4(t.perpendicular3(l),e.rotation4(l,Math.random()*Math.PI*2))),S)),n),j)))):(this._chargePhase=y.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),this._spacecraft.resetSpeed()))):this._spacecraft.resetSpeed()):(this._facingTarget=!1,this._targetDistance=0,this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(E,0,i)),st||(this._evasiveManeuverTime>=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=f*G,this._evasiveVelocityVector[1]*=f*G,t.rotate2(this._evasiveVelocityVector,(Math.random()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._spacecraft.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._spacecraft.strafeLeft(-this._evasiveVelocityVector[0]):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._spacecraft.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._spacecraft.lower(-this._evasiveVelocityVector[1]):(this._spacecraft.stopLower(),this._spacecraft.stopRaise()),this._evasiveManeuverTime+=i,this._evasiveManeuverTime>k&&(this._evasiveManeuverTime=-1)):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()))}},u.prototype=new h,u.prototype.constructor=u,u.prototype.handleSceneMoved=function(){},u.prototype.control=function(i){var s,n,o,a,h,l,u,c,_,p,d,g,f,m,y,S,T,b,O,A;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);if(this._spacecraft.isAway())return;if(this._updateTarget(),g=this._spacecraft.getMaxAcceleration(),_=this._spacecraft._visualModel.getScaledSize(),n=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),A=e.inverseOfRotation4(this._spacecraft.getPhysicalOrientationMatrix()),s=this._spacecraft.getTarget(),this._attackingTarget=!1,s){if(o=e.translationVector3(s.getPhysicalPositionMatrix()),a=t.diff3(o,n),h=t.mulVec3Mat4(a,A),c=t.length3(h),t.normalize3(h),S=t.getYawAndPitch(h),b=Math.abs(S.yaw)<M&&Math.abs(S.pitch)<M,O=this._spacecraft.getWeapons(),O&&O.length>0){if(p=s._visualModel.getScaledSize(),m=.25*_,f=m+Y*this._weaponRange,d=Math.atan(P*p/c),this._spacecraft.aimWeapons(E,d,i),b?this.approach(c,f,0,g*v):this._spacecraft.resetSpeed(),c>f)this.turn(S.yaw,S.pitch,i);else switch(l=this._spacecraft.getClass().getAttackVectorAngles(),y=this._spacecraft.getClass().getAttackThresholdAngle(),this._spacecraft.getClass().getTurnStyle()){case r.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(S.yaw-l[0])>y||Math.abs(S.pitch-l[1])>y)&&this.turn(S.yaw-l[0],S.pitch-l[1],i);break;case r.SpacecraftTurnStyle.ROLL_YAW:T=t.getRollAndYaw(h,!0),u=[T.roll-l[0],T.yaw-l[1]],(Math.abs(u[0])>y||Math.abs(u[1])>y)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0])>Math.PI/2&&(u[1]=0),this.rollAndYaw(u[0],u[1],i));break;case r.SpacecraftTurnStyle.ROLL_PITCH:T=t.getRollAndPitch(h,!0),u=[T.roll-l[0],T.pitch-l[1]],(Math.abs(u[0])>y||Math.abs(u[1])>y)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0]-Math.sign(u[0])*Math.PI)<Math.abs(u[0])&&(u[0]-=Math.sign(u[0])*Math.PI,T.pitch=-T.pitch),this.rollAndPitch(u[0],T.pitch-l[1],i))}t.length3(t.diff3(this._spacecraft.getTargetHitPosition(),n))-m<=O[0].getRange(this._spacecraft.getRelativeVelocityMatrix()[13])&&(this._spacecraft.fire(!0),this._attackingTarget=!0)}}else this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(E,0,i)}},c.prototype.clearAIs=function(){this._ais=[]},c.prototype.addAI=function(t,e,i){this._ais.push(new p[t](e,i))},c.prototype.control=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].control(t)},c.prototype.handleSceneMoved=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].handleSceneMoved(t)},p={},p[S]=l,p[T]=u,d=new c(p),n.executeWhenReady(function(){J=n.getSetting(n.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S),Q=1e3/J,_=Math.seed(Math.random())}),{FIGHTER_AI_NAME:S,SHIP_AI_NAME:T,clearAIs:d.clearAIs.bind(d),addAI:d.addAI.bind(d),control:d.control.bind(d),handleSceneMoved:d.handleSceneMoved.bind(d)}}),define("armada/logic/missions",["utils/utils","utils/types","utils/matrices","modules/application","modules/game","modules/async-resource","modules/resource-manager","modules/media-resources","modules/pools","modules/scene/camera","modules/scene/renderable-objects","armada/constants","armada/graphics","armada/logic/classes","armada/configuration","armada/strings","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","armada/logic/equipment","armada/logic/ai","utils/polyfill"],function(t,e,i,s,n,o,r,a,h,l,u,c,_,p,d,g,f,m,y,S,T){"use strict";function E(){return at}function b(t){this._id=null,this._name=null,this._color=null,"string"==typeof t?(this._id=t,this._name=t):"object"==typeof t?(this._id=t.id||t.name||s.showError("Team defined without a name or id!"),this._name=t.name||t.id,this._color=t.color||null):s.showError("Invalid parameter specified for Team constructor!"),this._initialCount=0,this._squads=[]}function M(t,e,i,s){this._objects=t,this._center=null,this._boundaries=null,this._objects.length>0&&this._calculateCenter(s),this._subnodes=e>0&&this._objects.length>i?this._generateSubnodes(e-1,i):null}function O(t){this._descriptor=t||{},this._spacecrafts=null,this._shortString=null}function A(e){this._type=e?t.getSafeEnumValue(Q,e.type,null):null,this._subjects=e?new O(e.subjects):null,e&&this._checkParams(e.params)}function x(t){A.call(this,t)}function R(t){A.call(this,t)}function C(t){A.call(this,t),this._running=!this._params.start,this._trigger=null,this._timeElapsed=this._params.startOffset||0,this._count=0}function I(e){var i;if(this._conditions=null,e.conditions)for(this._conditions=[],i=0;i<e.conditions.length;i++)this._conditions.push(new(z[e.conditions[i].type]||A)(e.conditions[i]));this._conditionsRequired=t.getSafeEnumValue(Y,e.conditionsRequired,Y.ALL),this._fireWhen=t.getSafeEnumValue(J,e.fireWhen,J.CHANGE_TO_TRUE),this._oneShot=e.oneShot||!1,this._delay=e.delay||0,this._countDown=!1,this._onFireHandlers=[],this._previousConditionState=!1,this._fired=!1,this._conditions||(this._fireWhen!==J.MISSION_STARTS&&(s.showError("A trigger has no conditions, and so its fireWhen state must be '"+J.MISSION_STARTS+"'!"),this._fireWhen=J.MISSION_STARTS),this._oneShot||(s.showError("A trigger has no conditions, and so it must be set as oneShot!"),this._oneShot=!0)),!this._oneShot&&this._delay&&(s.showError("Only oneShot triggers can have delays!"),this._delay=0)}function v(e,i){this._type=e?t.getSafeEnumValue($,e.type,null):null,this._trigger=i,this._trigger&&this._trigger.addFireHandler(this._execute.bind(this)),this._subjects=e?new O(e.subjects):null,e&&this._checkParams(e.params)}function N(t,e){v.call(this,t,e)}function L(t,e){v.call(this,t,e)}function D(t,e){v.call(this,t,e)}function w(t,e){v.call(this,t,e)}function F(t,e){v.call(this,t,e)}function P(t){var e;for(this._name=t.name,this._trigger=new I(t.trigger),this._actions=[],e=0;e<t.actions.length;e++)this._actions.push(new(X[t.actions[e].type]||v)(t.actions[e],this._trigger))}function V(t){this._name=t,this._environment=null,this._ownsEnvironment=!1,this._combatTheme=null,this._views=null,this._teams=null,this._events=null,this._winActions=null,this._loseActions=null,this._spacecrafts=null,this._pilotedCraft=null,this._hitObjects=null,this._randomShips=null,this._randomShipsMapSize=0,this._randomShipsHeadingAngle=0,this._randomShipsRandomHeading=!1,this._randomShipsEquipmentProfileName=null,this._state=tt.NONE,this._referenceScore=0,this._escortedSpacecrafts=null}function U(t,e){r.JSONResource.call(this,t,e,!0),this._test=this._dataJSON.test===!0,this._localData=JSON.parse(localStorage[this._getLocalStorageID()]||"{}"),this._initLocalData()}function B(t){this._name=t.name,this._playerHitpointsFactor=t.playerHitpointsFactor}function j(t){this._name=t.name,this._referenceBaseScoreFactor=t.referenceBaseScoreFactor,this._referenceHitRatio=t.referenceHitRatio,this._referenceHullIntegrity=t.referenceHullIntegrity,this._referenceTeamSurvival=t.referenceTeamSurvival}function G(){o.AsyncResource.call(this),this._difficulty=null,this._difficultyLevels=null,this._missionPerformanceLevels=null,this._tipIDs=null,this._missionManager=new r.ResourceManager}var k,H,q,W,z,X,Y={ALL:"all",ANY:"any"},J={MISSION_STARTS:"missionStarts",TRUE:"true",FALSE:"false",CHANGE:"change",CHANGE_TO_TRUE:"changeToTrue",CHANGE_TO_FALSE:"changeToFalse"},Q={DESTROYED:"destroyed",COUNT:"count",TIME_ELAPSED:"timeElapsed"},K={BELOW:"below",ABOVE:"above",EQUALS:"equals"},Z={BEFORE:"before",AFTER:"after",ONCE:"once",REPEAT:"repeat"},$={WIN:"win",LOSE:"lose",MESSAGE:"message",CLEAR_MESSAGES:"clearMessages",COMMAND:"command"},tt={NONE:0,BATTLE:1,IN_PROGRESS:2,COMPLETED:3,FAILED:4,DEFEAT:5,ENDED:6},et={IN_PROGRESS:0,COMPLETED:1,FAILED:2},it="failed",st=c.LOCAL_STORAGE_PREFIX+"missions_",nt=st+"difficulty",ot="missions",rt="team",at="";return Object.freeze(Y),Object.freeze(J),Object.freeze(Q),Object.freeze(Z),Object.freeze($),Object.freeze(tt),b.prototype.getID=function(){return this._id},b.prototype.getDisplayName=function(){return t.formatString(g.get(g.TEAM.PREFIX,this._name),{id:this._id})},b.prototype.getColor=function(){return this._color},b.prototype.getInitialCount=function(){return this._initialCount},b.prototype.addSpacecraft=function(t){var e,i,n=t.getSquad();if(t.setTeam(this),n){for(e=0;e<this._squads.length;e++)if(n===this._squads[e].name){this._squads[e].crafts.push(t);break}e>=this._squads.length&&this._squads.push({name:n,crafts:[t]}),i=d.getHUDSetting(d.BATTLE_SETTINGS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,this._squads[e].crafts.length>i&&s.showError("Warning: squad '"+n+"' of team '"+this._name+"' has more than "+i+" members, and thus cannot be displayed correctly in the wingmen status panel!")}this._initialCount++},b.prototype.getSquads=function(){return this._squads},M.prototype._calculateCenter=function(t){var e,i,s,n,o=0,r=0,a=0;for(t&&(s=this._objects[0]._physicalModel._positionMatrix,n=this._objects[0]._physicalModel.getSize(),this._boundaries=[[s[0]-n,s[0]+n],[s[1]-n,s[1]+n],[s[2]-n,s[2]+n]]),e=0,i=this._objects.length;i>e;e++)s=this._objects[e]._physicalModel._positionMatrix,o+=s[12],r+=s[13],a+=s[14],t&&(n=this._objects[e]._physicalModel.getSize(),s[12]-n<this._boundaries[0][0]&&(this._boundaries[0][0]=s[12]-n),s[12]+n>this._boundaries[0][1]&&(this._boundaries[0][1]=s[12]+n),s[13]-n<this._boundaries[1][0]&&(this._boundaries[1][0]=s[13]-n),s[13]+n>this._boundaries[1][1]&&(this._boundaries[1][1]=s[13]+n),s[14]-n<this._boundaries[2][0]&&(this._boundaries[2][0]=s[14]-n),s[14]+n>this._boundaries[2][1]&&(this._boundaries[2][1]=s[14]+n));o/=i,r/=i,a/=i,this._center=[o,r,a]},M.prototype._generateSubnodes=function(e,i){var s,n,o,r,a,h,l,u,c,_,p,d,g,f;for(s=0,n=this._objects.length;n>s;s++)r=this._objects[s],a=r._physicalModel._positionMatrix,o=r._physicalModel.getSize(),a[12]-o<this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(h=h||[],h.push(r)),a[14]+o>=this._center[2]&&(l=l||[],l.push(r))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(u=u||[],u.push(r)),a[14]+o>=this._center[2]&&(c=c||[],c.push(r)))),a[12]+o>=this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(_=_||[],_.push(r)),a[14]+o>=this._center[2]&&(p=p||[],p.push(r))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(d=d||[],d.push(r)),a[14]+o>=this._center[2]&&(g=g||[],g.push(r))));return f=new Array(8),f[0]=new M(h||t.EMPTY_ARRAY,e,i,!1),f[1]=new M(l||t.EMPTY_ARRAY,e,i,!1),f[2]=new M(u||t.EMPTY_ARRAY,e,i,!1),f[3]=new M(c||t.EMPTY_ARRAY,e,i,!1),f[4]=new M(_||t.EMPTY_ARRAY,e,i,!1),f[5]=new M(p||t.EMPTY_ARRAY,e,i,!1),f[6]=new M(d||t.EMPTY_ARRAY,e,i,!1),f[7]=new M(g||t.EMPTY_ARRAY,e,i,!1),f},M.prototype.getObjects=function(e,i,s,n,o,r){var a;return this._subnodes?this._boundaries&&(i<this._boundaries[0][0]||e>this._boundaries[0][1]||n<this._boundaries[1][0]||s>this._boundaries[1][1]||r<this._boundaries[2][0]||o>this._boundaries[2][1])?t.EMPTY_ARRAY:(a=[],e<this._center[0]&&(s<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[0].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[1].getObjects(e,i,s,n,o,r)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[2].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[3].getObjects(e,i,s,n,o,r))))),i>=this._center[0]&&(s<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[4].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[5].getObjects(e,i,s,n,o,r)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[6].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[7].getObjects(e,i,s,n,o,r))))),a):this._objects},O.prototype.has=function(t){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.indexOf(t.getID())>=0||this._descriptor.squads&&this._descriptor.squads.indexOf(t.getSquad())>=0||this._descriptor.teams&&this._descriptor.teams.indexOf(t.getTeam().getID())>=0;
},O.prototype._cacheSpacecrafts=function(t){var e,i;for(this._spacecrafts=[],i=t.getSpacecrafts(),e=0;e<i.length;e++)this.has(i[e])&&this._spacecrafts.push(i[e])},O.prototype.getSpacecrafts=function(t){return!this._spacecrafts&&t&&this._cacheSpacecrafts(t),this._spacecrafts},O._mapSpacecraftID=function(t){return g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedSpacecraftIDs=function(t){return g.getList(t.map(O._mapSpacecraftID))},O._mapSquadID=function(t){return t=g.get(g.SQUAD.PREFIX,t),g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedSquadIDs=function(t){return g.getList(t.map(O._mapSquadID))},O._mapTeamID=function(t){return t=g.get(g.TEAM.PREFIX,t),g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedTeamIDs=function(t){return g.getList(t.map(O._mapTeamID))},O.prototype.toString=function(){var e="";return this._descriptor.spacecrafts&&(e+=O._getMappedSpacecraftIDs(this._descriptor.spacecrafts)),this._descriptor.squads&&(e.length>0&&(e+="; "),e+=t.formatString(g.get(this._descriptor.squads.length>1?g.MISSIONS.OBJECTIVE_SUBJECTS_SQUADS:g.MISSIONS.OBJECTIVE_SUBJECTS_SQUAD),{ids:O._getMappedSquadIDs(this._descriptor.squads)})),this._descriptor.teams&&(e.length>0&&(e+="; "),e+=t.formatString(g.get(this._descriptor.teams.length>1?g.MISSIONS.OBJECTIVE_SUBJECTS_TEAMS:g.MISSIONS.OBJECTIVE_SUBJECTS_TEAM),{ids:O._getMappedTeamIDs(this._descriptor.teams)})),e},O.prototype.getLiveSubjectCount=function(){var t,e=0;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].isAlive()&&e++;return e},O.prototype.getShortString=function(){return this._shortString||(!this._descriptor.spacecrafts||this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||!this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||this._descriptor.squads||!this._descriptor.teams?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._spacecrafts.length}):this._descriptor.teams.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_TEAMS),{count:this._descriptor.teams.length}):this._shortString=g.get(g.TEAM.PREFIX,this._descriptor.teams[0]):this._descriptor.squads.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SQUADS),{count:this._descriptor.squads.length}):this._shortString=g.get(g.SQUAD.PREFIX,this._descriptor.squads[0]):this._spacecrafts.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._spacecrafts.length}):this._shortString=this._spacecrafts[0].getDisplayName()),this._shortString},A.prototype._handleWrongParams=function(){s.showError("Wrong parameters specified for condition of type: '"+this._type+"'!")},A.prototype._checkParams=function(){return s.showError("Unrecognized condition type: '"+this._type+"'!"),!1},A.prototype.isSatisfied=function(){return s.showError("Unrecognized condition type: '"+this._type+"'!"),!1},A.prototype.getObjectiveString=function(){return s.showError("No mission objective string associated with condition type: '"+this._type+"'!"),null},A.prototype.getObjectiveStateString=function(){return s.showError("No mission objective string associated with condition type: '"+this._type+"'!"),null},A.prototype.getEscortedSpacecrafts=function(){return s.showError("No escorted spacecrafts associated with condition type: '"+this._type+"'!"),null},x.prototype=new A,x.prototype.constructor=x,x.prototype._checkParams=function(){return!0},x.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t);for(e=0;e<i.length;e++)if(i[e].isAlive())return!1;return!0},x.prototype.getObjectiveString=function(e){var i=t.formatString(g.get(e,g.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.toString()});return i=i.charAt(0).toUpperCase()+i.slice(1)},x.prototype.getObjectiveStateString=function(e){var i,s,n;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(),n=s>1?" ("+s+")":"",i=t.formatString(g.get(e,g.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.getShortString()})+n,i=i.charAt(0).toUpperCase()+i.slice(1)):""},x.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},R.prototype=new A,R.prototype.constructor=R,R.prototype._checkParams=function(e){return this._params=e,this._params&&"number"==typeof this._params.count&&t.getSafeEnumValue(K,this._params.relation)?!0:(this._handleWrongParams(),!1)},R.prototype.isSatisfied=function(t){var e,i,s=this._subjects.getSpacecrafts(t);for(i=0,e=0;e<s.length;e++)s[e].isAlive()&&i++;switch(this._params.relation){case K.BELOW:return i<this._params.count;case K.ABOVE:return i>this._params.count;case K.EQUALS:return i===this._params.count}return!1},R.prototype.getObjectiveString=function(e){var i;return this._params.relation!==K.BELOW?(s.showError("Count conditions for mission objectives must have relation set to '"+K.BELOW+"'!"),null):(i=t.formatString(g.get(e,g.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.toString(),count:this._params.count}),i=i.charAt(0).toUpperCase()+i.slice(1))},R.prototype.getObjectiveStateString=function(e){var i,n,o;return this._params.relation!==K.BELOW?(s.showError("Count conditions for mission objectives must have relation set to '"+K.BELOW+"'!"),null):this._subjects.getSpacecrafts()?(n=this._subjects.getLiveSubjectCount(),o=" ("+n+")",i=t.formatString(g.get(e,g.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.getShortString(),count:this._params.count})+o,i=i.charAt(0).toUpperCase()+i.slice(1)):""},R.prototype.getEscortedSpacecrafts=function(t){return this._params.relation!==K.BELOW?(s.showError("Count conditions for mission objectives must have relation set to '"+K.BELOW+"'!"),null):this._subjects.getSpacecrafts(t)},C.prototype=new A,C.prototype.constructor=C,C.prototype._checkParams=function(e){return this._params=e,!this._params||"number"!=typeof this._params.time||!t.getSafeEnumValue(Z,this._params.satisfiedWhen)||void 0!==this._params.start&&"string"!=typeof this._params.start||this._params.satisfiedWhen!==Z.REPEAT&&void 0!==this._params.maxCount||this._params.satisfiedWhen===Z.REPEAT&&void 0!==this._params.maxCount&&"number"!=typeof this._params.maxCount||void 0!==this._params.startOffset&&"number"!=typeof this._params.startOffset?(this._handleWrongParams(),!1):!0},C.prototype.isSatisfied=function(t,e){var i=!1;if(this._params.start&&!this._trigger&&(this._trigger=t.getEvent(this._params.start)&&t.getEvent(this._params.start).getTrigger(),this._trigger||(this._params.start=null)),!this._running&&this._trigger&&this._trigger.hasFired()&&(this._running=!0),this._running)switch(this._timeElapsed+=e,this._params.satisfiedWhen){case Z.BEFORE:if(this._timeElapsed<this._params.time)return!0;break;case Z.AFTER:if(this._timeElapsed>this._params.time)return!0;break;case Z.ONCE:if(this._timeElapsed>=this._params.time&&0===this._count)return this._running=!1,this._count=1,!0;break;case Z.REPEAT:if(!this._params.maxCount||this._count<this._params.maxCount){for(;this._timeElapsed>=this._params.time;)this._timeElapsed-=this._params.time,i=!0;if(i)return this._count++,!0}else this._running=!1}return!1},I.prototype.addFireHandler=function(t){this._onFireHandlers.push(t)},I.prototype.fire=function(t){var e;if(this._delay>0)return void(this._countDown=!0);for(e=0;e<this._onFireHandlers.length;e++)this._onFireHandlers[e](t);this._fired=!0},I.prototype.hasFired=function(){return this._fired},I.prototype.simulate=function(t,e){var i,n;if(this._oneShot){if(this._fired)return;if(this._countDown)return this._delay-=e,void(this._delay<=0&&this.fire(t))}if(this._fireWhen===J.MISSION_STARTS)return void this.fire(t);switch(this._conditionsRequired){case Y.ALL:for(i=!0,n=0;n<this._conditions.length;n++)if(!this._conditions[n].isSatisfied(t,e)){i=!1;break}break;case Y.ANY:for(i=!1,n=0;n<this._conditions.length;n++)if(this._conditions[n].isSatisfied(t,e)){i=!0;break}break;default:s.showError("Unrecognized trigger condition requirement: '"+this._conditionsRequired+"'!")}switch(this._fireWhen){case J.TRUE:i&&this.fire(t);break;case J.FALSE:i||this.fire(t);break;case J.CHANGE:i!==this._previousConditionState&&this.fire(t);break;case J.CHANGE_TO_TRUE:i&&!this._previousConditionState&&this.fire(t);break;case J.CHANGE_TO_FALSE:!i&&this._previousConditionState&&this.fire(t);break;default:s.showError("Unrecognized trigger firing requirement: '"+this._fireWhen+"'!")}this._previousConditionState=i},I.prototype.getObjectiveStrings=function(t){var e,i=[];if(this._conditionsRequired!==Y.ALL)return s.showError("Triggers for mission objectives must be set to conditionsRequired state of '"+Y.ALL+"'!"),null;if(this._fireWhen!==J.CHANGE_TO_TRUE)return s.showError("Triggers for mission objectives must be set to fireWhen state of '"+J.CHANGE_TO_TRUE+"'!"),null;for(e=0;e<this._conditions.length;e++)i.push(this._conditions[e].getObjectiveString(t));return i},I.prototype.getObjectivesState=function(t,e){var i,n=[];if(this._conditionsRequired!==Y.ALL)return s.showError("Triggers for mission objectives must be set to conditionsRequired state of '"+Y.ALL+"'!"),null;if(this._fireWhen!==J.CHANGE_TO_TRUE)return s.showError("Triggers for mission objectives must be set to fireWhen state of '"+J.CHANGE_TO_TRUE+"'!"),null;for(i=0;i<this._conditions.length;i++)n.push({text:this._conditions[i].getObjectiveStateString(t?g.BATTLE.OBJECTIVE_WIN_PREFIX:g.BATTLE.OBJECTIVE_LOSE_PREFIX),state:this._conditions[i].isSatisfied(e)?t?et.COMPLETED:et.FAILED:e.getState()===tt.COMPLETED?et.COMPLETED:et.IN_PROGRESS});return n},I.prototype.getEscortedSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getEscortedSpacecrafts(t));return i},v.prototype.getType=function(){return this._type},v.prototype._handleWrongParams=function(){s.showError("Wrong parameters specified for action of type: '"+this._type+"'!")},v.prototype._checkParams=function(){return s.showError("Unrecognized action type: '"+this._type+"'!"),!1},v.prototype._execute=function(){s.showError("Unrecognized action type: '"+this._type+"'!")},v.prototype.getObjectiveStrings=function(){return s.showError("Action of type '"+this._type+"' does no correspond to a mission objective!"),null},v.prototype.getObjectivesState=function(){return s.showError("Action of type '"+this._type+"' does no correspond to a mission objective!"),null},N.prototype=new v,N.prototype.constructor=N,N.prototype._checkParams=function(){return!0},N.prototype._execute=function(t){t.completeMission()},N.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(g.MISSIONS.OBJECTIVE_WIN_PREFIX)},N.prototype.getObjectivesState=function(t){return this._trigger.getObjectivesState(!0,t)},L.prototype=new v,L.prototype.constructor=L,L.prototype._checkParams=function(){return!0},L.prototype._execute=function(t){t.failMission()},L.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(g.MISSIONS.OBJECTIVE_LOSE_PREFIX)},L.prototype.getObjectivesState=function(t){return this._trigger.getObjectivesState(!1,t)},D.prototype=new v,D.prototype.constructor=D,D.prototype._checkParams=function(t){return this._params=t,!this._params||!this._params.text&&!this._params.textID||void 0!==this._params.text&&"string"!=typeof this._params.text&&"object"!=typeof this._params.text||void 0!==this._params.textID&&"string"!=typeof this._params.textID||void 0!==this._params.duration&&"number"!=typeof this._params.duration||void 0!==this._params.permanent&&"boolean"!=typeof this._params.permanent||void 0!==this._params.urgent&&"boolean"!=typeof this._params.urgent||void 0!==this._params.color&&("object"!=typeof this._params.color||!(this._params.color instanceof Array))?(this._handleWrongParams(),!1):!0},D.prototype._execute=function(e){n.getScreen().queueHUDMessage({text:g.get(g.MISSION.PREFIX,t.getFilenameWithoutExtension(e.getName())+g.MISSION.MESSAGES_SUFFIX.name+this._params.textID,"object"==typeof this._params.text?this._params.text[g.getLanguage()]:this._params.text),duration:this._params.duration,permanent:this._params.permanent,color:this._params.color},this._params.urgent)},w.prototype=new v,w.prototype.constructor=w,w.prototype._checkParams=function(){return!0},w.prototype._execute=function(){n.getScreen().clearHUDMessages()},F.prototype=new v,F.prototype.constructor=F,F.prototype._checkParams=function(t){return this._params=t,!this._params||void 0!==this._params.command&&"string"!=typeof this._params.command?(this._handleWrongParams(),!1):!0},F.prototype._execute=function(t){var e,i=this._subjects.getSpacecrafts(t);if(i.length>0)for(this._params.lead=i[0],this._params.clearCache=!0,e=0;e<i.length;e++)this._params.index=e,i[e].handleEvent(m.COMMAND_RECEIVED,this._params)},P.prototype.getName=function(){return this._name},P.prototype.getTrigger=function(){return this._trigger},P.prototype.getActions=function(){return this._actions},P.prototype.simulate=function(t,e){this._trigger.simulate(t,e)},V.prototype.getName=function(){return this._name},V.prototype.getCombatTheme=function(){return this._combatTheme},V.prototype.getPilotedSpacecraft=function(){return this._pilotedCraft},V.prototype.getSpacecraft=function(t){var e;for(e=0;e<this._spacecrafts.length;e++)if(this._spacecrafts[e].getID()===t)return this._spacecrafts[e];return null},V.prototype.getSpacecrafts=function(){return this._spacecrafts},V.prototype.getSpacecraftsInSquad=function(t){var e,i=[];for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e].getSquad()===t&&i.push(this._spacecrafts[e]);return i},V.prototype.applyToSpacecrafts=function(t){var e;for(e=0;e<this._spacecrafts.length;e++)t(this._spacecrafts[e])},V.prototype.getState=function(){return this._state},V.prototype.isFinished=function(){return this._state===tt.COMPLETED||this._state===tt.FAILED||this._state===tt.DEFEAT||this._state===tt.ENDED},V.prototype.getEscortedSpacecrafts=function(){return this._escortedSpacecrafts},V.prototype.completeMission=function(){this._state===tt.IN_PROGRESS&&(this._state=tt.COMPLETED)},V.prototype.failMission=function(){(this._state===tt.IN_PROGRESS||this._state===tt.COMPLETED)&&(this._state=tt.FAILED)},V.prototype._updateState=function(){var t;if(this._pilotedCraft){if(this._pilotedCraft.canBeReused())return void(this._state=tt.DEFEAT);if(this._state===tt.BATTLE||this._state===tt.IN_PROGRESS&&0===this._winActions.length){for(t=0;t<this._spacecrafts.length;t++)if(this._spacecrafts[t]&&!this._spacecrafts[t].canBeReused()&&this._pilotedCraft.isHostile(this._spacecrafts[t]))return;return void(this._state=tt.COMPLETED)}}else if(this._state===tt.BATTLE&&this.noHostilesPresent())return void(this._state=tt.ENDED)},V.prototype.noHostilesPresent=function(){var t,e,i=null;for(t=0;t<this._spacecrafts.length;t++)if(this._spacecrafts[t]&&!this._spacecrafts[t].canBeReused()){if(e=this._spacecrafts[t].getTeam(),e&&i&&e!==i)return!1;i=e}return!0},V.prototype.getSpacecraftCountForTeam=function(t){var e,i=0;for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e]&&!this._spacecrafts[e].canBeReused()&&this._spacecrafts[e].getTeam()===t&&i++;return i},V.prototype.getTotalHostileSpacecraftValue=function(t){var e,i=0;for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e]&&!this._spacecrafts[e].canBeReused()&&this._spacecrafts[e].isHostile(t)&&(i+=this._spacecrafts[e].getScoreValue());return i},V.prototype.getHostileSpacecraftCount=function(t,e){var i,s=0;for(i=0;i<this._spacecrafts.length;i++)!this._spacecrafts[i]||this._spacecrafts[i].canBeReused()||e&&this._spacecrafts[i].isAway()||this._spacecrafts[i].isHostile(t)&&s++;return s},V.prototype._spacecraftHasVisualModel=function(t,e){return e._visualModel===t},V.prototype.getFollowedSpacecraftForScene=function(t){return t.getCamera().getFollowedNode()?this._spacecrafts.find(this._spacecraftHasVisualModel.bind(this,t.getCamera().getFollowedNode()._renderableObject)):null},V.prototype.getEnvironment=function(){return this._environment},V.prototype.getTeam=function(t){var e;for(e=0;e<this._teams.length;e++)if(this._teams[e].getID()===t)return this._teams[e];return s.showError("No team exists with ID '"+t+"'!"),null},V.prototype.getEvent=function(t){var e;for(e=0;e<this._events.length;e++)if(this._events[e].getName()===t)return this._events[e];return s.showError("No mission event exists with name '"+t+"'!"),null},V.prototype.getObjectives=function(){var t,e=[];if(0===this._winActions.length)e.push(g.get(g.MISSIONS.OBJECTIVE_WIN_PREFIX,g.OBJECTIVE.DESTROY_ALL_SUFFIX.name));else for(t=0;t<this._winActions.length;t++)e=e.concat(this._winActions[t].getObjectiveStrings());for(t=0;t<this._loseActions.length;t++)e=e.concat(this._loseActions[t].getObjectiveStrings());return e},V.prototype.getObjectivesState=function(){var t,e,i,s,n=[];if(0===this._winActions.length)s=this.getPilotedSpacecraft(),e="",s&&(i=this.getHostileSpacecraftCount(s,!0),i>0&&(e=" ("+i+")")),n.push({text:g.get(g.BATTLE.OBJECTIVE_WIN_PREFIX,g.OBJECTIVE.DESTROY_ALL_SUFFIX.name)+e,state:s&&s.isAlive()?this.getHostileSpacecraftCount(s,!1)>0?et.IN_PROGRESS:et.COMPLETED:et.FAILED});else for(t=0;t<this._winActions.length;t++)n=n.concat(this._winActions[t].getObjectivesState(this));for(t=0;t<this._loseActions.length;t++)n=n.concat(this._loseActions[t].getObjectivesState(this));return n},V.prototype.loadEnvironment=function(t){"string"==typeof t.environment?(this._environment=f.getEnvironment(t.environment),this._environment||s.showError("Cannot load environment '"+t.environment+"' for mission: no such environment exists!"),this._ownsEnvironment=!1):"object"==typeof t.environment?(this._environment=new f.Environment(t.environment),this._ownsEnvironment=!0):s.showError("Invalid environment specified for mission!")},V.prototype.loadObjectives=function(t){var e,i,s,n;if(this._events=[],t.events)for(e=0;e<t.events.length;e++)this._events.push(new P(t.events[e],this));for(this._state=tt.NONE,this._winActions=[],this._loseActions=[],e=0;e<this._events.length;e++)for(s=this._events[e].getActions(),i=0;i<s.length;i++)n=s[i].getType(),n===$.WIN?this._winActions.push(s[i]):n===$.LOSE&&this._loseActions.push(s[i]);(this._winActions.length>0||this._loseActions.length>0)&&(this._state=tt.IN_PROGRESS)},V.prototype.getReferenceScore=function(){return this._referenceScore},V.prototype.loadFromJSON=function(t,e,i){var n,o,r,a,h,l,u,c;if(s.log("Loading mission from JSON file...",2),this.loadEnvironment(t),this._combatTheme=t.combatTheme,this._teams=[],t.teams)for(n=0;n<t.teams.length;n++)this._teams.push(new b(t.teams[n]));if(this.loadObjectives(t),this._views=[],t.views)for(n=0;n<t.views.length;n++)this._views.push(new p.SceneView(t.views[n]));for(this._spacecrafts=[],this._hitObjects=[],T.clearAIs(),n=0;n<t.spacecrafts.length;n++)r=new y.Spacecraft,r.loadFromJSON(t.spacecrafts[n],this._hitObjects),!i&&t.spacecrafts[n].piloted&&(this._pilotedCraft=r,r.multiplyMaxHitpoints(W.getDifficultyLevel(e).getPlayerHitpointsFactor())),l=t.spacecrafts[n].ai,!l&&i&&(l=r.isFighter()?d.getSetting(d.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE):d.getSetting(d.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE)),l&&T.addAI(l,r,this),a=t.spacecrafts[n].team,a?(h=this.getTeam(a),h?h.addSpacecraft(r):s.showError("Invalid team ID '"+a+"' specified for "+r.getClassName()+"!")):i&&(h=new b({name:rt,id:(this._teams.length+1).toString()}),this._teams.push(h),r.setTeam(h)),this._spacecrafts.push(r);for(this._referenceScore=0,h=this._pilotedCraft&&this._pilotedCraft.getTeam(),c=0,n=0;n<t.spacecrafts.length;n++)t.spacecrafts[n].initialTarget&&this._spacecrafts[n].setTarget(this.getSpacecraft(t.spacecrafts[n].initialTarget)),this._pilotedCraft&&!t.spacecrafts[n].excludeFromReferenceScore&&(this._pilotedCraft.isHostile(this._spacecrafts[n])?this._referenceScore+=this._spacecrafts[n].getScoreValue():this._spacecrafts[n].getTeam()===h&&c++);for(c>0&&(this._referenceScore/=c),this._randomShips=t.randomShips||{},this._randomShipsMapSize=t.randomShipsMapSize,this._randomShipsHeadingAngle=t.randomShipsHeadingAngle||0,this._randomShipsRandomHeading=t.randomShipsRandomHeading||!1,this._randomShipsEquipmentProfileName=t.randomShipsEquipmentProfileName||d.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME,this._escortedSpacecrafts=[],n=0;n<this._events.length;n++)for(u=this._events[n].getActions(),o=0;o<u.length;o++)u[o].getType()===$.LOSE&&(this._escortedSpacecrafts=this._escortedSpacecrafts.concat(this._events[n].getTrigger().getEscortedSpacecrafts(this)));this._pilotedCraft||(this._state=tt.NONE),this._state!==tt.NONE||this.noHostilesPresent()||(this._state=tt.BATTLE),s.log("Mission successfully loaded.",2)},V.prototype.addRandomShips=function(t,e){var s,n,o,r,a,h,l=i.rotation4([0,0,1],Math.radians(this._randomShipsHeadingAngle));t=t||d.getSetting(d.GENERAL_SETTINGS.DEFAULT_RANDOM_SEED),s=Math.seed(t);for(n in this._randomShips)if(this._randomShips.hasOwnProperty(n))for(a=0;a<this._randomShips[n];a++)h=l?i.matrix4(l):i.identity4(),this._randomShipsRandomHeading&&i.mul4(h,i.rotation4(i.getRowC4(h),s()*Math.PI*2)),o=new y.Spacecraft(p.getSpacecraftClass(n),"",i.translation4(s()*this._randomShipsMapSize-this._randomShipsMapSize/2,s()*this._randomShipsMapSize-this._randomShipsMapSize/2,s()*this._randomShipsMapSize-this._randomShipsMapSize/2),h,this._randomShipsEquipmentProfileName,this._hitObjects),e&&(o.isFighter()?T.addAI(d.getSetting(d.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE),o,this):T.addAI(d.getSetting(d.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE),o,this),r=new b({name:rt,id:(this._teams.length+1).toString()}),this._teams.push(r),o.setTeam(r)),this._spacecrafts.push(o)},V.prototype.isTeamMission=function(){return this.getPilotedSpacecraft()&&this.getPilotedSpacecraft().getTeam()&&this.getPilotedSpacecraft().getTeam().getInitialCount()>1},V.prototype.getScoreStatistics=function(t,e,i,s){var n,o,r,a,h=this.isTeamMission();return t=Math.round(t),n=Math.round((t||0)*e),o=Math.round(i*(h?d.getSetting(d.BATTLE_SETTINGS.SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM):d.getSetting(d.BATTLE_SETTINGS.SCORE_BONUS_FOR_HULL_INTEGRITY))),h&&(r=Math.round(s*d.getSetting(d.BATTLE_SETTINGS.SCORE_BONUS_FOR_TEAM_SURVIVAL))),a=t+n+o+(h?r:0),{baseScore:t,hitRatioBonus:n,hullIntegrityBonus:o,teamSurvivalBonus:r,score:a}},V.prototype.getPerformanceStatistics=function(){var t=this.getPilotedSpacecraft(),e=this.isTeamMission(),i=e?(this.getSpacecraftCountForTeam(t.getTeam())-(t.isAlive()?1:0))/(t.getTeam().getInitialCount()-1):0,s=this.getScoreStatistics(t.getScore(),t.getHitRatio(),t.getHullIntegrity(),i),n=W.getPerformanceInfo(this,s.score);return{baseScore:s.baseScore,hitRatioBonus:s.hitRatioBonus,hullIntegrityBonus:s.hullIntegrityBonus,teamSurvival:e?i:void 0,teamSurvivalBonus:s.teamSurvivalBonus,score:s.score,performance:n.performance,nextPerformance:n.nextPerformance,nextPerformanceScore:n.nextPerformanceScore}},V.prototype.createCameraConfigurationForSceneView=function(t,e){var s,n,o=i.getYawAndPitch(t._orientationMatrix);return s=new l.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),i.matrix4(t._positionMatrix),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new l.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),i.matrix4(t._orientationMatrix),Math.degrees(o.yaw),Math.degrees(o.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||d.getDefaultCameraBaseOrientation(),t.getPointToFallback()||d.getDefaultCameraPointToFallback()),new l.CameraConfiguration(t.getName(),s,n,t.getFOV()||d.getDefaultCameraFOV(),t.getFOVRange()||d.getDefaultCameraFOVRange(),t.getSpan()||d.getDefaultCameraSpan(),t.getSpanRange()||d.getDefaultCameraSpanRange(),t.resetsOnFocusChange())},V.prototype._handleSpacecraftJumpIn=function(t){this._hitObjects.indexOf(t)<=0&&this._hitObjects.push(t)},V.prototype.addToScene=function(t,e){var i;for(this._environment&&this._environment.addToScene(t),i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].addToScene(t,void 0,!1,{hitboxes:!0,weapons:!0,thrusterParticles:!0,projectileResources:!0,explosion:!0,cameraConfigurations:!0,lightSources:!0,blinkers:!0,jumpEngine:!0},{randomAnimationTime:!0}),e&&this._spacecrafts[i].addToScene(e,_.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:d.getHUDSetting(d.BATTLE_SETTINGS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER)}),this._spacecrafts[i].isAway()?this._spacecrafts[i].addEventHandler(m.JUMPED_IN,this._handleSpacecraftJumpIn.bind(this,this._spacecrafts[i])):this._hitObjects.push(this._spacecrafts[i]);a.executeWhenReady(function(){for(i=0;i<this._views.length;i++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[i],t)),0===i&&(t.getCamera().followNode(null,!0,0),t.getCamera().update(0))}.bind(this))},V.prototype.toggleHitboxVisibility=function(){var t;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].toggleHitboxVisibility()},V._handleProjectile=function(t,e,i,s){i.simulate(t,e),i.canBeReused()&&q.markAsFree(s)},V._handleParticle=function(t,e){t.canBeReused()&&H.markAsFree(e)},V.prototype.tick=function(t,e){var i,n,o,r;for(this._environment&&this._environment.simulate(),i=0;i<this._events.length;i++)this._events[i].simulate(this,t);for(i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].simulate(t),this._spacecrafts[i].canBeReused()||this._spacecrafts[i].isAway()?(r=this._hitObjects.indexOf(this._spacecrafts[i]),r>=0&&(this._hitObjects[r]=null,this._hitObjects.splice(r,1)),this._spacecrafts[i].canBeReused()&&(this._spacecrafts[i].destroy(!0),this._spacecrafts[i]=null,this._spacecrafts.splice(i,1),i--)):k&&this._spacecrafts[i].hideHitbox();q.hasLockedObjects()&&(o=new M(this._hitObjects,2,1,!0),q.executeForLockedObjects(V._handleProjectile.bind(this,t,o))),H.hasLockedObjects()&&H.executeForLockedObjects(V._handleParticle),e&&(n=e.moveCameraToOrigoIfNeeded(d.getSetting(d.BATTLE_SETTINGS.MOVE_TO_ORIGO_DISTANCE)),n&&T.handleSceneMoved(n)),this._updateState(),s.isDebugVersion()&&(at="Part: "+H._objects.length+"<br/>Proj: "+q._objects.length)},V.prototype.destroy=function(){var t;if(this._environment&&(this._ownsEnvironment?this._environment.destroy():this._environment.removeFromScene()),this._environment=null,this._views){for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._views=null}if(this._spacecrafts){for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t]&&(this._spacecrafts[t].destroy(),this._spacecrafts[t]=null);this._spacecrafts=null}this._pilotedCraft=null,this._hitObjects=null,H.clear(),q.clear()},U.prototype=new r.JSONResource,U.prototype.constructor=U,U.prototype._initLocalData=function(){var t,e,i=W.getDifficultyNames();for(t=0;t<i.length;t++)this._localData[i[t]]=this._localData[i[t]]||{},e=this._localData[i[t]],e.winCount=e.winCount||0,e.loseCount=e.loseCount||0},U.prototype._getLocalStorageID=function(){return st+this.getName()},U.prototype._saveLocalData=function(){localStorage[this._getLocalStorageID()]=JSON.stringify(this._localData)},U.prototype.isTest=function(){return this._test},U.prototype.getDescription=function(){return this._dataJSON.description||""},U.prototype.getDisplayDescription=function(){return g.get(g.MISSION.PREFIX,t.getFilenameWithoutExtension(this.getName())+g.MISSION.DESCRIPTION_SUFFIX.name,this.getDescription()?t.formatString(g.get(g.MISSIONS.NO_TRANSLATED_DESCRIPTION),{originalDescription:this.getDescription()}):g.get(g.MISSIONS.NO_DESCRIPTION))},U.prototype.getPilotedSpacecraftDescriptor=function(){var t;for(t=0;t<this._dataJSON.spacecrafts.length;t++)if(this._dataJSON.spacecrafts[t].piloted)return this._dataJSON.spacecrafts[t];return null},U.prototype.getEnvironment=function(){var t=null;return this.isReadyToUse()?(t=new V(this.getName()),t.loadEnvironment(this._dataJSON),t.getEnvironment()):(s.showError("Cannot get mission environment from mission descriptor that has not yet been initialized!"),null)},U.prototype.getMissionObjectives=function(){var t=null;return this.isReadyToUse()?(t=new V(this.getName()),t.loadObjectives(this._dataJSON),t.getObjectives()):(s.showError("Cannot get mission objectives from mission descriptor that has not yet been initialized!"),null)},U.prototype.getTipIDs=function(){return this._dataJSON.tips},U.prototype.createMission=function(t,e){var i=null;return this.isReadyToUse()?(i=new V(this.getName()),i.loadFromJSON(this._dataJSON,t,e)):s.showError("Cannot create mission from descriptor that has not yet been initialized!"),i},U.prototype.getBestScore=function(t){return t=t||W.getDifficulty(),this._localData[t].bestScore},U.prototype.getBestPerformance=function(t){return t=t||W.getDifficulty(),this._localData[t].bestPerformance},U.prototype.updateBestScore=function(t,e,i){i=i||W.getDifficulty();var s=this._localData[i];return void 0===s.bestScore||t>s.bestScore?(s.bestScore=t,s.bestPerformance=e,this._saveLocalData(),!0):!1},U.prototype.increasePlaythroughCount=function(t,e){e=e||W.getDifficulty(),t?this._localData[e].winCount++:this._localData[e].loseCount++,this._saveLocalData()},U.prototype.getWinCount=function(t){return t=t||W.getDifficulty(),this._localData[t].winCount},B.prototype.getName=function(){return this._name},B.prototype.getPlayerHitpointsFactor=function(){return this._playerHitpointsFactor},j.prototype.getName=function(){return this._name},j.prototype.getRequiredScore=function(t){return this._referenceBaseScoreFactor?t.getScoreStatistics(t.getReferenceScore()*(t.isTeamMission()?this._referenceBaseScoreFactor:1),this._referenceHitRatio,this._referenceHullIntegrity,this._referenceTeamSurvival).score:0},G.prototype=new o.AsyncResource,G.prototype.constructor=G,G.prototype.getPerformanceInfo=function(t,e){var i,s={},n=this._missionPerformanceLevels.length;for(i=0;n>i&&!(e<this._missionPerformanceLevels[i].getRequiredScore(t));i++);return s.performance=i>0?this._missionPerformanceLevels[i-1].getName():it,s.nextPerformance=n>i?this._missionPerformanceLevels[i].getName():null,s.nextPerformanceScore=s.nextPerformance?this._missionPerformanceLevels[i].getRequiredScore(t):0,s},G.prototype.loadConfigurationFromJSON=function(t){var e;for(this._difficultyLevels=[],e=0;e<t.difficultyLevels.length;e++)this._difficultyLevels.push(new B(t.difficultyLevels[e]));for(this._missionPerformanceLevels=[],e=0;e<t.missionPerformanceLevels.length;e++)this._missionPerformanceLevels.push(new j(t.missionPerformanceLevels[e]));this._tipIDs=t.tips},G.prototype.loadSettingsFromLocalStorage=function(){var t,i;this._difficulty=W.getDifficultyNames()[0],void 0!==localStorage[nt]&&(i={silentFallback:s.hasVersionChanged(),defaultValue:W.getDifficultyNames()[0]},t=e.getValueOfTypeFromLocalStorage({baseType:"enum",values:W.getDifficultyNames()},nt,i),(!i.error||s.hasVersionChanged())&&this.setDifficulty(t,!!i.error&&i.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))},G.prototype.requestLoad=function(){var t={};t[ot]=U,this._missionManager.requestConfigLoad(d.getConfigurationSetting(d.CONFIGURATION.MISSION_FILES).filename,d.getConfigurationSetting(d.CONFIGURATION.MISSION_FILES).folder,t,this.setToReady.bind(this))},G.prototype.getDifficulty=function(){return this._difficulty},G.prototype.setDifficulty=function(t,e){void 0===e&&(e=!0),this._difficulty!==t&&(this._difficulty=t,e&&(localStorage[nt]=t))},G.prototype.getDifficultyNames=function(){var t,e=[];for(t=0;t<this._difficultyLevels.length;t++)e.push(this._difficultyLevels[t].getName());return e},G.prototype.getDifficultyLevel=function(t){var e;for(e=0;e<this._difficultyLevels.length;e++)if(this._difficultyLevels[e].getName()===t)return this._difficultyLevels[e];return null},G.prototype.getTipIDs=function(){return this._tipIDs},G.prototype.getMissionNames=function(){var t=[];return this._missionManager.executeForAllResourcesOfType(ot,function(e){(s.isDebugVersion()||!e.isTest())&&t.push(e.getName());
}),t},G.prototype.getMissionDescriptors=function(){var t=[];return this._missionManager.executeForAllResourcesOfType(ot,function(e){(s.isDebugVersion()||!e.isTest())&&t.push(e)}),t},G.prototype.getMissionDescriptor=function(t){return this._missionManager.getResource(ot,t)},G.prototype.requestMissionDescriptor=function(t,e){var i=this._missionManager.getResource(ot,t);i?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){e(i)})):e(null)},G.prototype.requestMission=function(t,e,i,s){var n=this._missionManager.getResource(ot,t);n?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){s(n.createMission(e,i))})):s(null)},H=h.getPool(u.Particle),q=h.getPool(S.Projectile),W=new G,z={},z[Q.DESTROYED]=x,z[Q.COUNT]=R,z[Q.TIME_ELAPSED]=C,X={},X[$.WIN]=N,X[$.LOSE]=L,X[$.MESSAGE]=D,X[$.CLEAR_MESSAGES]=w,X[$.COMMAND]=F,d.executeWhenReady(function(){k=d.getSetting(d.BATTLE_SETTINGS.SHOW_HITBOXES_FOR_HITCHECKS)}),{MissionState:tt,ObjectiveState:et,FAILED_MISSION_PERFORMACE:it,loadConfigurationFromJSON:W.loadConfigurationFromJSON.bind(W),loadSettingsFromLocalStorage:W.loadSettingsFromLocalStorage.bind(W),requestLoad:W.requestLoad.bind(W),executeWhenReady:W.executeWhenReady.bind(W),getDebugInfo:E,getDifficulty:W.getDifficulty.bind(W),setDifficulty:W.setDifficulty.bind(W),getDifficultyNames:W.getDifficultyNames.bind(W),getTipIDs:W.getTipIDs.bind(W),getMissionNames:W.getMissionNames.bind(W),getMissionDescriptor:W.getMissionDescriptor.bind(W),getMissionDescriptors:W.getMissionDescriptors.bind(W),requestMissionDescriptor:W.requestMissionDescriptor.bind(W),requestMission:W.requestMission.bind(W)}}),define("modules/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,s){"use strict";function n(t){it=t}function o(t){this._actionName="string"==typeof t?t:null,"object"==typeof t&&this.loadFromJSON(t)}function r(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._bindings={},this._disabledActions={},void 0!==e&&this.loadFromJSON(e)}function a(i,s,n,r,a){this._key=s||null,this._keyCode=t.getKeyCodeOf(s),this._shiftState=void 0===n?!1:n||this._keyCode===y,this._ctrlState=void 0===r?!1:r||this._keyCode===S,this._altState=void 0===a?!1:a||this._keyCode===T,o.call(this,i),e.log_DEBUG("Created key binding: "+this._actionName+" - "+this.getControlString(),3)}function h(t){r.call(this,a,t),this._currentlyPressedKeys=new Array(256)}function l(t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,o.call(this,t)}function u(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._displacementFactor=1,this._displacementDeadzone=0,r.call(this,l,t)}function c(t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,o.call(this,t)}function _(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=t.staticSensitivity===!0,this._quadraticIntensity=t.quadraticSensitivity===!0,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function p(t){this._gamepad=null,this._sensitivityActionGroups=null,r.call(this,c,t)}function d(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,this._source=null,void 0!==t&&this.loadFromJSON(t)}function g(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function f(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={}}var m={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},y=16,S=17,T=18,E=" + ",b="_key",M="_shift",O="_ctrl",A="_alt",x=[m.NONE,m.LEFT,m.MIDDLE,m.RIGHT],R="left",C="right",I="up",v="down",N="_button",L="_moveX",D="_moveY",w="_measuredFromCenter",F="_scrollX",P="_scrollY",V="_gamepad_button",U="_gamepad_axisIndex",B="_gamepad_axisPositive",j={name:"key"+s.CATEGORY_SEPARATOR},G={name:"mouse"+s.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},k={name:"mouse"+s.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},H={name:"mouse"+s.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},q={name:"mouse"+s.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},W={name:"mouse"+s.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},z={name:"mouse"+s.CATEGORY_SEPARATOR+"move",defaultValue:"move"},X={name:"mouse"+s.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},Y={name:"mouse"+s.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},J={name:"mouse"+s.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},Q={name:"mouse"+s.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},K={name:"mouse"+s.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},Z={name:"joystick"+s.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},$={name:"joystick"+s.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},tt={name:"joystick"+s.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},et={name:"joystick"+s.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},it="";return o.prototype.getActionName=function(){return this._actionName},o.prototype.getControlString=function(){return e.showError("Cannot get control string of generic control binding!"),null},o.prototype.loadFromJSON=function(t){this._actionName=t.action},o.prototype.saveToLocalStorage=function(){e.showError("Cannot save generic control binding to local storage!")},o.prototype.loadFromLocalStorage=function(){e.showError("Cannot load generic control binding from local storage!")},o.prototype.removeFromLocalStorage=function(){e.showError("Cannot remove generic control binding from local storage!")},o.prototype.bindsTheSameControls=function(){return e.showError("Cannot check if generic control binds the same controls as another binding!"),!0},r.prototype.getDeviceName=function(){return"Generic"},r.prototype.resetState=function(){e.showError("Cannot reset the state of a generic input interpreter!")},r.prototype.isListening=function(){return this._listening},r.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},r.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},r.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},r.prototype.isEnabled=function(){return this._enabled},r.prototype.enable=function(){this._enabled=!0},r.prototype.disable=function(){this._enabled=!1},r.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},r.prototype.setBinding=function(t){this._bindings[t.getActionName()]=t},r.prototype.setAndStoreBinding=function(t){this.setBinding(t),t.saveToLocalStorage()},r.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e]))},r.prototype.loadFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].loadFromLocalStorage()},r.prototype.removeFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].removeFromLocalStorage()},r.prototype.getControlStringForAction=function(t){return void 0!==this._bindings[t]?this._bindings[t].getControlString():""},r.prototype._addActionByBinding=function(t,e,i){var s;if(e){for(s=0;s<t.length;s++)if(i.bindsTheSameControls(t[s].binding))return void t[s].actions.push(e);t.push({binding:i,actions:[e]})}},r.prototype.checkAction=function(t){e.showError("Cannot check if action '"+t+"' is triggered with a generic input interpreter!")},r.prototype.disableAction=function(t){this._disabledActions[t]=!0},r.prototype.enableAction=function(t){this._disabledActions[t]=!1},r.prototype.getTriggeredActions=function(t){var e,i,s=[],n=[];if(!this.isListening()||!this.isEnabled())return s;for(e in this._bindings)this._bindings.hasOwnProperty(e)&&(this._disabledActions[e]||t&&!t(e)||this._addActionByBinding(n,this.checkAction(e),this._bindings[e]));for(i=0;i<n.length;i++)s.push(n[i].actions);return s},a.prototype=new o,a.prototype.constructor=a,a.prototype.loadFromJSON=function(t){o.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=t.shift===!0||this._keyCode===y,this._ctrlState=t.ctrl===!0||this._keyCode===S,this._altState=t.alt===!0||this._keyCode===T},a.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+b]=this._key,localStorage[it+this._actionName+M]=this._shiftState,localStorage[it+this._actionName+O]=this._ctrlState,localStorage[it+this._actionName+A]=this._altState},a.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+b]&&(this.setKey(localStorage[it+this._actionName+b]),this._shiftState="true"===localStorage[it+this._actionName+M],this._ctrlState="true"===localStorage[it+this._actionName+O],this._altState="true"===localStorage[it+this._actionName+A])},a.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+b),localStorage.removeItem(it+this._actionName+M),localStorage.removeItem(it+this._actionName+O),localStorage.removeItem(it+this._actionName+A)},a.prototype.getKey=function(){return this._key},a.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},a.prototype.getShiftState=function(){return this._shiftState},a.prototype.getCtrlState=function(){return this._ctrlState},a.prototype.getAltState=function(){return this._altState},a.prototype.getControlString=function(){var e,i;return e=s.get(j,this._key,this._key),this._shiftState&&this._keyCode!==y&&(i=t.getKeyOfCode(y),i=s.get(j,i,i),e=i+E+e),this._ctrlState&&this._keyCode!==S&&(i=t.getKeyOfCode(S),i=s.get(j,i,i),e=i+E+e),this._altState&&this._keyCode!==T&&(i=t.getKeyOfCode(T),i=s.get(j,i,i),e=i+E+e),e},a.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[y]||!this._shiftState)&&(t[S]||!this._ctrlState)&&(t[T]||!this._altState)},a.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},h.prototype=new r,h.prototype.constructor=h,h.prototype.getDeviceName=function(){return"keyboard"},h.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},h.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},h.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.startListening=function(){r.prototype.startListening.call(this),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this)},h.prototype.stopListening=function(){r.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null},h.prototype.checkAction=function(t){return this._bindings[t].isTriggered(this._currentlyPressedKeys)?{name:t,source:this}:null},l.prototype=new o,l.prototype.constructor=l,l.prototype.loadFromJSON=function(t){switch(o.prototype.loadFromJSON.call(this,t),this._buttonIndex=x.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case R:this._moveX=-1;break;case C:this._moveX=1;break;case I:this._moveY=-1;break;case v:this._moveY=1}switch(this._measuredFromCenter=t.fromCenter===!0,this._scrollX=0,this._scrollY=0,t.scroll){case R:this._scrollX=-1;break;case C:this._scrollX=1;break;case I:this._scrollY=-1;break;case v:this._scrollY=1}},l.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+N]=this._buttonIndex,localStorage[it+this._actionName+L]=this._moveX,localStorage[it+this._actionName+D]=this._moveY,localStorage[it+this._actionName+w]=this._measuredFromCenter,localStorage[it+this._actionName+F]=this._scrollX,localStorage[it+this._actionName+P]=this._scrollY},l.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+N]&&(this._buttonIndex=parseInt(localStorage[it+this._actionName+N],10),this._moveX=parseInt(localStorage[it+this._actionName+L],10),this._moveY=parseInt(localStorage[it+this._actionName+D],10),this._measuredFromCenter="true"===localStorage[it+this._actionName+w],this._scrollX=parseInt(localStorage[it+this._actionName+F],10),this._scrollY=parseInt(localStorage[it+this._actionName+P],10))},l.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+N),localStorage.removeItem(it+this._actionName+L),localStorage.removeItem(it+this._actionName+D),localStorage.removeItem(it+this._actionName+w),localStorage.removeItem(it+this._actionName+F),localStorage.removeItem(it+this._actionName+P)},l.prototype.isMeasuredFromCenter=function(){return this._measuredFromCenter},l.prototype.getControlString=function(){var e="",i=null;switch(x[this._buttonIndex]){case m.LEFT:return s.get(G);case m.MIDDLE:return s.get(H);case m.RIGHT:return s.get(k)}return e=this._measuredFromCenter?s.get(q):s.get(W),this._moveX<0?i=s.get(X):this._moveX>0?i=s.get(Y):this._moveY<0?i=s.get(J):this._moveY>0&&(i=s.get(Q)),i?e=t.formatString(e,{move:s.get(z),toDirection:i}):(i=null,e=s.get(W),this._scrollX<0?i=s.get(X):this._scrollX>0?i=s.get(Y):this._scrollY<0?i=s.get(J):this._scrollY>0&&(i=s.get(Q)),i&&(e=t.formatString(e,{move:s.get(K),toDirection:i})),e)},l.prototype.getTriggeredIntensity=function(t,e,i,s,n){var o,r;return this._buttonIndex>0?t[this._buttonIndex]===!0?1:-1:e?(o=this._measuredFromCenter?e[0]>=0?e[0]-s[0]:0:i[0],0!==this._moveX?o*this._moveX:(r=this._measuredFromCenter?e[1]>=0?e[1]-s[1]:0:i[1],0!==this._moveY?r*this._moveY:0!==this._scrollX?n[0]*this._scrollX:0!==this._scrollY?n[1]*this._scrollY:void 0)):0},l.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!==0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!==0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!==0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!==0)},u.prototype=new r,u.prototype.constructor=u,u.prototype._updateDisplacementFactor=function(){this._displacementFactor=1/((this._screenSize||1)*this._displacementAreaRelativeSize)},u.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._screenSize=Math.min(t,e),this._updateDisplacementFactor(),this._mousePosition=[t,e],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.getDeviceName=function(){return"mouse"},u.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[it+"mouse_moveSensitivity"]=this._moveSensitivity},u.prototype.getDisplacementAreaRelativeSize=function(){return this._displacementAreaRelativeSize},u.prototype.setAndStoreDisplacementAreaRelativeSize=function(t){this._displacementAreaRelativeSize=t,this._updateDisplacementFactor(),localStorage[it+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},u.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[it+"mouse_displacementDeadzone"]=this._displacementDeadzone},u.prototype.loadFromJSON=function(t){r.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=t.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},u.prototype.loadFromLocalStorage=function(){r.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[it+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[it+"mouse_moveSensitivity"])),void 0!==localStorage[it+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[it+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[it+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[it+"mouse_displacementDeadzone"],10))},u.prototype.removeFromLocalStorage=function(){r.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(it+"mouse_moveSensitivity"),localStorage.removeItem(it+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(it+"mouse_displacementDeadzone")},u.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},u.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},u.prototype.handleMouseMove=function(t){this._mousePosition[0]>=0&&(this._mousePositionChange[0]+=t.clientX-this._mousePosition[0],this._mousePositionChange[1]+=t.clientY-this._mousePosition[1]),this._mousePosition=[t.clientX,t.clientY]},u.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},u.prototype.startListening=function(){r.prototype.startListening.call(this),document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1}},u.prototype.stopListening=function(){r.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null},u.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:this._bindings[t].isMeasuredFromCenter()===!0?Math.min(1,Math.max(0,e-this._displacementDeadzone)*this._displacementFactor):e*this._moveSensitivity,source:this}:null},u.prototype.getTriggeredActions=function(t){var e=r.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},u.prototype.getMousePosition=function(){return this._mousePosition},u.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},c.prototype=new o,c.prototype.constructor=c,c.prototype.BUTTON_NONE=-1,c.prototype.AXIS_NONE=-1,c.prototype.loadFromJSON=function(t){o.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},c.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+V]=this._button,localStorage[it+this._actionName+U]=this._axisIndex,localStorage[it+this._actionName+B]=this._axisPositive},c.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+V]&&(this._button=parseInt(localStorage[it+this._actionName+V],10),this._axisIndex=parseInt(localStorage[it+this._actionName+V],10),this._axisPositive="true"===localStorage[it+this._actionName+B])},c.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+V),localStorage.removeItem(it+this._actionName+U),localStorage.removeItem(it+this._actionName+B)},c.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?1===t.buttons[this._button]||"object"==typeof t.buttons[this._button]&&t.buttons[this._button].pressed?1:0:this._axisIndex!==this.AXIS_NONE?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},c.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(s.get(Z),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(s.get($),{index:this._axisIndex+1,direction:this._axisPositive?s.get(tt):s.get(et)}):""},c.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},_.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*(this._quadraticIntensity?t:1)*this._sensitivityFactor:-1},p.prototype=new r,p.prototype.constructor=p,p.prototype.getDeviceName=function(){return"joystick"},p.prototype.resetState=function(){this._gamepad=null},p.prototype.loadFromJSON=function(t){var e;if(r.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new _(t.sensitivityProfile.actionGroups[e]))},p.prototype.handleGamepadConnected=function(t){this._gamepad||(this._gamepad=t.gamepad)},p.prototype.startListening=function(){r.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},p.prototype.stopListening=function(){r.prototype.stopListening.call(this),window.ongamepadconnected=null},p.prototype.checkAction=function(t){var e,i,s;if(e=this._bindings[t].getTriggeredIntensity(this._gamepad),e>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(s=this._sensitivityActionGroups[i].getIntensityForAction(e,t),void 0===s||s>0)return{name:t,intensity:s,source:this};return{name:t,intensity:e,source:this}}return null},p.prototype.getTriggeredActions=function(t){var e;return this.isListening()?(e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e&&e.length>0?this._gamepad=e[0]:this._gamepad=null,this._gamepad?r.prototype.getTriggeredActions.call(this,t):[]):[]},d.prototype.INTENSITY_NOT_SPECIFIED=-3,d.prototype.INTENSITY_KEYPRESS=-2,d.prototype.getName=function(){return this._name},d.prototype.getDescription=function(){return this._description},d.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=t.continuous===!0,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},d.prototype.setTriggered=function(t,e,i){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS),this._source=i},d.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},d.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},d.prototype.execute=function(){this._continuous===!0?this._triggered===!0?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source):null!==this._executeNonTriggered&&this._executeNonTriggered():this._triggered===!0&&this._executed===!1?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source),this._executed=!0):(this._triggered===!1&&this._nonTriggeredExecuted===!1&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),this._triggered===!1?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},g.prototype.setContext=function(t){this._context=t},g.prototype.getType=function(){return e.showError("Attempting to get the type of a generic controller object!"),"none (generic)"},g.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},g.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.actions.length;e++)this._actions[t.actions[e].name]=new d(t.actions[e])},g.prototype.setActionFunction=function(t,i,s){this._actions[t]?i===!0?this._actions[t].setExecuteTriggered(s):this._actions[t].setExecuteNonTriggered(s):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},g.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},g.prototype.executeActions=function(t){var e,i,s,n,o;for(e=0;e<t.length;e++){for(s=null,n=-1,o=null,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==n&&t[e][i].intensity>n||void 0!==n&&void 0===t[e][i].intensity)&&(s=t[e][i].name,n=t[e][i].intensity,o=t[e][i].source);s&&((void 0===n||n>0)&&this._actions[s].setTriggered(!0,n,o),t[e]=[])}for(s in this._actions)this._actions.hasOwnProperty(s)&&this._actions[s].execute()},f.prototype=new i.AsyncResource,f.prototype.constructor=f,f.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},f.prototype.addInputInterpreter=function(i){var s=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);s?(this._inputInterpreters.push(i),this._inputInterpretersByType[s]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},f.prototype.getInputInterpreters=function(){return this._inputInterpreters},f.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},f.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},f.prototype.addController=function(i){var s=t.getKeyOfValue(this._controllerTypes,i.constructor);s?(this._controllers.push(i),this._controllersByType[s]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},f.prototype.getControllers=function(){return this._controllers},f.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},f.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},f.prototype.isControllerPriority=function(t){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(t)},f.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},f.prototype.disableAction=function(t){this._disabledActions[t]=!0},f.prototype.enableAction=function(t){this._disabledActions[t]=!1},f.prototype.control=function(t){var e,i,s=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(s));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},f.prototype.loadConfigurationFromJSON=function(t){var i,s;for(this._controllers=[],i=0,s=t.controllers.length;s>i;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},f.prototype.loadSettingsFromJSON=function(t,i){var s,n;if(i)for(s=0,n=t.inputDevices.length;n>s;s++)this._inputInterpreters[s].removeFromLocalStorage(),this._inputInterpreters[s].loadFromJSON(t.inputDevices[s]);else for(this._dataJSON=t,this._inputInterpreters=[],s=0,n=t.inputDevices.length;n>s;s++)this._inputInterpreterTypes[t.inputDevices[s].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[s].type](t.inputDevices[s])):e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[s].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},f.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},f.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},f.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},f.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},f.prototype.isListening=function(){return this._listening},f.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},{setModulePrefix:n,ControlBinding:o,KeyBinding:a,KeyboardInputInterpreter:h,MouseBinding:l,MouseInputInterpreter:u,GamepadBinding:c,GamepadInputInterpreter:p,Controller:g,ControlContext:f}}),define("modules/camera-controller",["utils/types","modules/application","modules/control","modules/scene/camera"],function(t,e,i,s){"use strict";function n(n){i.Controller.call(this,n),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=n.maxSpeed||0,this._acceleration=n.acceleration||0,this._deceleration=n.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=n.maxSpin||0,this._angularAcceleration=n.angularAcceleration||0,this._angularDeceleration=n.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=n.objectChangeTransitionDuration,this._viewChangeTransitionDuration=n.viewChangeTransitionDuration,this._viewResetTransitionDuration=n.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue(s.Camera.prototype.TransitionStyle,n.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){
this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(){this._velocityTargetVector[0]>-this._maxSpeed&&(this._velocityTargetVector[0]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(){this._velocityTargetVector[0]<this._maxSpeed&&(this._velocityTargetVector[0]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(){this._velocityTargetVector[1]<this._maxSpeed&&(this._velocityTargetVector[1]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(){this._velocityTargetVector[1]>-this._maxSpeed&&(this._velocityTargetVector[1]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(t){var e=(void 0!==t?t:1)*this._maxSpeed;(this._velocityTargetVector[2]>-e||void 0!==t)&&(this._velocityTargetVector[2]=-e)}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(){this._velocityTargetVector[2]<this._maxSpeed&&(this._velocityTargetVector[2]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return n.prototype=new i.Controller,n.prototype.constructor=n,n.prototype.getType=function(){return"camera"},n.prototype.setControlledCamera=function(t){this._controlledCamera=t},n.prototype.getMaxSpeed=function(){return this._maxSpeed},n.prototype.setCameraToFollowObject=function(t,e,i){this._controlledCamera.followObject(t,!1,e,i)},n.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},n.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},n.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},n.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:n}}),define("armada/screens/shared",["modules/game","modules/media-resources","modules/components","armada/configuration","armada/audio"],function(t,e,i,s,n){"use strict";var o,r,a={MENU_THEME:"menu",DEBRIEFING_VICTORY_THEME:"debriefing_victory",DEBRIEFING_DEFEAT_THEME:"debriefing_defeat",SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",SLIDER_SOURCE:"slider.html",SLIDER_CSS:"slider.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",LIST_COMPONENT_SOURCE:"listcomponent.html",LIST_COMPONENT_CSS:"listcomponent.css",MENU_CLASS_NAME:"menu",MENU_BUTTON_CLASS_NAME:"button",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",LIST_CLASS_NAME:"list",LIST_ELEMENT_CLASS_NAME:"listElement",LIST_ELEMENT_CONTAINER_CLASS_NAME:"transparentContainer",CAPTION_CLASS_NAME:"caption",SUBCAPTION_CLASS_NAME:"subcaption",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",MISSIONS_SCREEN_NAME:"missions",MISSIONS_SCREEN_SOURCE:"missions.html",MISSIONS_SCREEN_CSS:"missions.css",MISSIONS_LIST_CONTAINER_ID:"missionListContainer",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DEBRIEFING_SCREEN_NAME:"debriefing",DEBRIEFING_SCREEN_SOURCE:"debriefing.html",DEBRIEFING_SCREEN_CSS:"debriefing.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",GRAPHICS_SCREEN_CSS:"graphics.css",AUDIO_SCREEN_NAME:"audio",AUDIO_SCREEN_SOURCE:"audio.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",ABOUT_SCREEN_CSS:"about.css",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer",DIALOG_SCREEN_NAME:"dialog",DIALOG_SCREEN_SOURCE:"dialog.html",DIALOG_SCREEN_CSS:"dialog.css"};return a.initAudio=function(t){var i,h;i=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).name),h=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).name),n.initMusic(s.getSetting(s.GENERAL_SETTINGS.MENU_MUSIC),a.MENU_THEME,!0),(i&&!i.isLoaded()&&!i.hasError()||h&&!h.isLoaded()&&!h.hasError())&&e.executeWhenReady(function(){o=i&&i.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).volume),r=h&&h.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).volume)}),e.requestResourceLoad(),t&&e.executeWhenReady(t)},a.playButtonSelectSound=function(t){o&&t&&o.play()},a.playButtonClickSound=function(t){r&&t&&r.play()},a.openDialog=function(e){t.getScreen(a.DIALOG_SCREEN_NAME).setup(e),t.setScreen(a.DIALOG_SCREEN_NAME,!0,a.SUPERIMPOSE_BACKGROUND_COLOR)},a.getSubParagraph=function(t){return'<p class="sub fadedText">'+t+"</p>"},a.BUTTON_EVENT_HANDLERS={".button":{mouseenter:function(){a.playButtonSelectSound(!this.classList.contains(i.DISABLED_CLASS_NAME))},click:function(){a.playButtonClickSound(!this.classList.contains(i.DISABLED_CLASS_NAME))}}},a.MENU_EVENT_HANDLERS={optionselect:a.playButtonSelectSound,optionclick:a.playButtonClickSound},a.MENU_STYLE={menuClassName:a.MENU_CLASS_NAME,buttonClassName:a.MENU_BUTTON_CLASS_NAME,buttonContainerClassName:a.MENU_BUTTON_CONTAINER_CLASS_NAME,selectedButtonClassName:i.SELECTED_CLASS_NAME,disabledClassName:i.DISABLED_CLASS_NAME},a}),define("armada/control",["modules/control","modules/camera-controller","modules/game","modules/media-resources","armada/screens/shared","armada/strings","armada/configuration"],function(t,e,i,s,n,o,r){"use strict";function a(e){t.Controller.call(this,e),this._mission=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),i.setScreen(n.INGAME_MENU_SCREEN_NAME,!0,n.SUPERIMPOSE_BACKGROUND_COLOR)}.bind(this)),this.setActionFunction("pause",!0,function(){i.getScreen().showMessage(o.get(o.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("stopTime",!0,function(){this._battle.toggleTime()}.bind(this)),this.setActionFunction("switchToPilotMode",!0,function(){g.switchToPilotMode(this._mission.getPilotedSpacecraft())}.bind(this)),this.setActionFunction("switchToSpectatorMode",!0,function(){g.switchToSpectatorMode(!0,!0)}),this.setActionFunction("toggleHitboxVisibility",!0,function(){this._mission.toggleHitboxVisibility()}.bind(this)),this.setActionFunction("toggleDevInfoVisibility",!0,function(){i.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){g.getInputInterpreter(y).toggleEnabled(),g.isInPilotMode()&&(g.getInputInterpreter(y).isEnabled()?(document.body.style.cursor="none",g.enableMouseTurning()):document.body.style.cursor=i.getDefaultCursor())}),this.setActionFunction("toggleJoystickControls",!0,function(){g.getInputInterpreter(S).toggleEnabled()})}function h(e){t.Controller.call(this,e),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._weaponAimThreshold=e.weaponAimThreshold,this.setActionFunction("fire",!0,function(t,e){this._controlledSpacecraft.fire(!1,t),e===f&&g.enableMouseTurning()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()&&d&&d.play()}.bind(this)),this.setActionFunction("toggleCruise",!0,function(){this._controlledSpacecraft.toggleCruise()&&d&&d.play()}.bind(this)),this.setActionFunction("toggleFlightAssist",!0,function(){this._controlledSpacecraft.toggleFlightAssist()&&d&&d.play()}.bind(this)),this.setActionFunction("nextNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestHostile()?_.play():p.play()}.bind(this)),this.setActionFunction("previousNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetPreviousNearestHostile()?_.play():p.play()}.bind(this)),this.setActionFunction("nextNearestNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestNonHostile()?_.play():p.play()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){this._controlledSpacecraft.strafeLeft((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){this._controlledSpacecraft.strafeRight((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){this._controlledSpacecraft.raise((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){this._controlledSpacecraft.lower((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t,e){this._controlledSpacecraft.yawLeft(t),e!==f&&g.disableMouseTurning()}.bind(this)),this.setActionFunction("yawRight",!0,function(t,e){this._controlledSpacecraft.yawRight(t),e!==f&&g.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchUp",!0,function(t,e){this._controlledSpacecraft.pitchUp(t),e!==f&&g.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchDown",!0,function(t,e){this._controlledSpacecraft.pitchDown(t),e!==f&&g.disableMouseTurning()}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this)),this.setActionFunction("jumpOut",!0,function(){this._controlledSpacecraft.jumpOut()}.bind(this))}function l(t){return s.getSoundEffect(r.getHUDSetting(t).name).createSoundClip(s.SoundCategory.SOUND_EFFECT,r.getHUDSetting(t).volume)}function u(){t.ControlContext.call(this),this._pilotingMode=!1,this._mouseTurningDisabled=!1,this.registerInputInterpreterType(m,t.KeyboardInputInterpreter),this.registerInputInterpreterType(y,t.MouseInputInterpreter),this.registerInputInterpreterType(S,t.GamepadInputInterpreter),this.registerControllerType(E,a),this.registerControllerType(b,h),this.registerControllerType(M,e.CameraController)}var c,_,p,d,g,f,m="keyboard",y="mouse",S="joystick",T=S,E="general",b="fighter",M="camera";return t.setModulePrefix("interstellarArmada_control_"),a.prototype=new t.Controller,a.prototype.constructor=a,a.prototype.getType=function(){return"general"},a.prototype.setMission=function(t){this._mission=t},a.prototype.setBattle=function(t){this._battle=t},h.prototype=new t.Controller,h.prototype.constructor=h,h.prototype.getType=function(){return"fighter"},h.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t,this._controlledSpacecraft&&(this._strafeSpeed=c*this._controlledSpacecraft.getMaxAcceleration())},h.prototype.executeActions=function(e,i){this._controlledSpacecraft&&(this._controlledSpacecraft.canBeReused()?this._controlledSpacecraft=null:(t.Controller.prototype.executeActions.call(this,e),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextBestHostile()&&_.play(),this._controlledSpacecraft.aimWeapons(this._weaponAimThreshold,0,i)))},u.prototype=new t.ControlContext,u.prototype.constructor=u,u.prototype.isInPilotMode=function(){return this._pilotingMode},u.prototype.switchToPilotMode=function(t){t&&t.isAlive()&&!this._pilotingMode&&(this._pilotingMode=!0,_=l(r.BATTLE_SETTINGS.HUD.TARGET_SWITCH_SOUND),p=l(r.BATTLE_SETTINGS.HUD.TARGET_SWITCH_DENIED_SOUND),d=l(r.BATTLE_SETTINGS.HUD.FLIGHT_MODE_SWITCH_SOUND),this.getController(b).setControlledSpacecraft(t),this.getController(M).setCameraToFollowObject(t._visualModel,r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_DURATION),r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_STYLE)),this.disableAction("followNext"),this.disableAction("followPrevious"),i.getScreen().setHeaderContent(""),this.getInputInterpreter(y).isEnabled()&&(document.body.style.cursor="none"))},u.prototype.switchToSpectatorMode=function(t,e){(this._pilotingMode||e)&&(this._pilotingMode=!1,this.getController(b).setControlledSpacecraft(null),t&&this.getController(M).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),i.getScreen().setHeaderContent(o.get(o.BATTLE.SPECTATOR_MODE)),document.body.style.cursor=i.getDefaultCursor())},u.prototype.disableMouseTurning=function(){this._mouseTurningDisabled||(f.disableAction("yawLeft"),f.disableAction("yawRight"),f.disableAction("pitchUp"),f.disableAction("pitchDown"),f.disableAction("rollLeft"),f.disableAction("rollRight"),this._mouseTurningDisabled=!0)},u.prototype.enableMouseTurning=function(){this._mouseTurningDisabled&&(f.enableAction("yawLeft"),f.enableAction("yawRight"),f.enableAction("pitchUp"),f.enableAction("pitchDown"),f.enableAction("rollLeft"),f.enableAction("rollRight"),this._mouseTurningDisabled=!1)},u.prototype.isMouseTurningDisabled=function(){return this._mouseTurningDisabled},g=new u,g.executeWhenReady(function(){f=g.getInputInterpreter(y)}),r.executeWhenReady(function(){c=r.getSetting(r.BATTLE_SETTINGS.STRAFE_SPEED_FACTOR)}),{KEYBOARD_NAME:m,MOUSE_NAME:y,JOYSTICK_NAME:S,GAMEPAD_NAME:T,GENERAL_CONTROLLER_NAME:E,FIGHTER_CONTROLLER_NAME:b,CAMERA_CONTROLLER_NAME:M,KeyBinding:t.KeyBinding,loadConfigurationFromJSON:g.loadConfigurationFromJSON.bind(g),loadSettingsFromJSON:g.loadSettingsFromJSON.bind(g),loadSettingsFromLocalStorage:g.loadSettingsFromLocalStorage.bind(g),restoreDefaults:g.restoreDefaults.bind(g),getControllers:g.getControllers.bind(g),getController:g.getController.bind(g),isControllerPriority:g.isControllerPriority.bind(g),getInputInterpreters:g.getInputInterpreters.bind(g),getInputInterpreter:g.getInputInterpreter.bind(g),control:g.control.bind(g),startListening:g.startListening.bind(g),stopListening:g.stopListening.bind(g),isListening:g.isListening.bind(g),setScreenCenter:g.setScreenCenter.bind(g),executeWhenReady:g.executeWhenReady.bind(g),isInPilotMode:g.isInPilotMode.bind(g),switchToPilotMode:g.switchToPilotMode.bind(g),switchToSpectatorMode:g.switchToSpectatorMode.bind(g),isMouseTurningDisabled:g.isMouseTurningDisabled.bind(g)}}),define("armada/armada",["modules/game","modules/components","armada/constants","armada/graphics","armada/audio","armada/configuration","armada/logic/environments","armada/logic/missions","armada/control","armada/strings"],function(t,e,i,s,n,o,r,a,h,l){"use strict";var u=document.getElementById("splashProgress");return u.max=6,t.setGameName(i.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(0),t.setPreviouslyRunVersion(localStorage[i.VERSION_LOCAL_STORAGE_ID]),t._loadGameSettingsAndExecuteCallback=function(t,e){s.loadSettingsFromJSON(t.graphics),s.loadSettingsFromLocalStorage(),n.loadSettingsFromJSON(t.audio),n.loadSettingsFromLocalStorage(),o.loadSettingsFromJSON(t.logic),h.loadSettingsFromJSON(t.control),h.loadSettingsFromLocalStorage(),a.loadSettingsFromLocalStorage(),o.executeWhenReady(function(){r.requestLoad(),r.executeWhenReady(function(){u.value=2,a.requestLoad(),a.executeWhenReady(function(){u.value=3,e()})})})},t._loadGameConfigurationAndExecuteCallback=function(t,e){o.loadConfigurationFromJSON(t.dataFiles.logic),s.loadConfigurationFromJSON(t.graphics),n.loadConfigurationFromJSON(t.audio),a.loadConfigurationFromJSON(t.logic),h.loadConfigurationFromJSON(t.control),u.value=1,e()},t._buildScreensAndExecuteCallback=function(s){requirejs(["armada/screens/shared","armada/screens/menus","armada/screens/missions","armada/screens/battle","armada/screens/debriefing","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/audio-settings","armada/screens/control-settings","armada/screens/about","armada/screens/dialog"],function(n,o,r,a,h,c,_,p,d,g,f,m){t.addScreen(o.mainMenuScreen),t.addScreen(r.missionsScreen),t.addScreen(a.battleScreen),t.addScreen(h.debriefingScreen),t.addScreen(c.databaseScreen),t.addScreen(o.settingsMenuScreen),t.addScreen(_.generalSettingsScreen),t.addScreen(p.graphicsScreen),t.addScreen(d.audioScreen),t.addScreen(g.controlsScreen),t.addScreen(f.aboutScreen),t.addScreen(o.ingameMenuScreen),t.addScreen(m.dialogScreen),u.value=4,t.executeWhenAllScreensReady(function(){u.value=5,t.requestLanguageChange(localStorage.getItem(i.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),l,function(){u.value=6,e.clearStoredDOMModels(),localStorage[i.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),n.initAudio(s)})})})},t}),requirejs(["armada/armada"],function(t){"use strict";t.initialize()}),define("main",function(){});