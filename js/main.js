define("modules/application",[],function(){"use strict";function t(t,e){(!e||e<=a)&&console.log(t)}var e,i,s,n={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},o=null,r=!0,a=0,l="",h=!0,c="web",u=!1;return{ErrorSeverity:n,getFolder:function(t){return t.length>0&&"/"===t[t.length-1]?t:o?void 0!==o[t]?o[t]:(this.showError("Asked for folder for file type '"+t+"', and folder for such files is not registered!",n.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+t+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),t+"/")},setFolders:function(t){var e="",i=function(e,s,o){var r=-1,a=-1,l="",h="";for(o=o||[];e.indexOf("{{")>=0;){if(!(e.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+e+"'",n.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(r=e.indexOf("{{"),a=e.indexOf("}}"),h=e.substring(r+2,a),!(l=t[h]))return this.showError("Invalid folder name specified! Cannot find referenced folder '"+e.substring(r+2,a)+"' in "+e+"!",n.SEVERE),null;if(!(o.indexOf(h)<0))return this.showError("Circular reference detected among the following folders: "+o.concat(s).join(", "),n.SEVERE),null;e=e.replace(e.substring(r,Math.min(a+3,e.length)),i(l,h,o.concat(s)))}return e}.bind(this);o={};for(e in t)t.hasOwnProperty(e)&&(o[e]=i(t[e],e))},setFileCacheBypassEnabled:function(t){r=t},setLogVerbosity:function(t){a=t},getVersion:function(){return l},getPlatform:function(){return c},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(t){l=t,requirejs.config({urlArgs:this.getVersionURLArg()})},setPlatform:function(t){c=u?"web"!==t?t:"electron":"web"},setPreviouslyRunVersion:function(t){e=t,i=void 0===e},isFirstRun:function(){return i},hasVersionChanged:function(){if(void 0!==i)return e!==l;this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},setDebugVersion:function(t){h=t},setReleases:function(t){s=t},getNewReleases:function(t){var i,n=[];for(i=0;i<s.length;i++)(t&&!e||e&&s[i]>e.substr(0,5))&&n.push(s[i]);return n},usesElectron:function(){return u},useElectron:function(t){u=t},getFileURL:function(t,e){return this.getFolder(t)+(e+(r||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(t,e,i){var s="Error: "+t+(i?"\n\n"+i+"\n\n":"\n\n");switch(e){case n.CRITICAL:s+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case n.SEVERE:s+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case n.MINOR:s+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:s+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(s)},log:t,log_DEBUG:t,requestFile:function(t,e,i,s,o){this.log("Requesting file: '"+e+"' from "+(""!==this.getFolder(t)?"folder: '"+this.getFolder(t):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+e+"' successfully loaded.",2),i(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+e+"'.",n.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened."),i()}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+e+"' timed out.",n.SEVERE),i()}.bind(this),s&&r.overrideMimeType(s),o&&(r.responseType=o),r.open("GET",this.getFileURL(t,e),!0),r.send(null)},requestTextFile:function(t,e,i,s){this.requestFile(t,e,function(t){i(t?t.responseText:null)},s||"text/plain; charset=utf-8")},requestCSSFile:function(t,e,i){var s;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(s=document.createElement("link"),s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.onload=i,s.href=this.getFileURL(t,e),document.head.appendChild(s)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function t(){this._readyToUse=!1,this._onReadyQueue=[],this._triggeredOnreadyQueueLength=0}return t.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},t.prototype.resetReadyState=function(){this._readyToUse=!1},t.prototype.executeOnReadyQueue=function(){var t;for(this._triggeredOnreadyQueueLength=this._onReadyQueue.length,t=0;t<this._triggeredOnreadyQueueLength;t++)this._onReadyQueue[t]&&this._onReadyQueue[t].call(this),this._onReadyQueue[t]=null;this._onReadyQueue=this._onReadyQueue.length>this._triggeredOnreadyQueueLength?this._onReadyQueue.slice(this._triggeredOnreadyQueueLength):[]},t.prototype.setToReady=function(){!1===this._readyToUse&&(this._readyToUse=!0,this.executeOnReadyQueue())},t.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:t}}),define("modules/screen-manager",["modules/async-resource","modules/application"],function(t,e){"use strict";function i(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var s;return i.prototype=new t.AsyncResource,i.prototype.constructor=i,i.prototype.getScreen=function(t){return t?this._screens[t]:this._currentScreen},i.prototype.addScreen=function(t,e,i){var s=function(){++this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);this.resetReadyState(),this._screensToLoad++,this._screens[t._name]=t,t.addScreenToPage(s,e,i),this._currentScreen||(this._currentScreen=t,this._currentScreen.setActive(!0))},i.prototype.setCurrentScreen=function(t,i,s){var n,o=this.getScreen(t);if(!o)return void e.showError("Cannot switch to screen '"+t+"', because it does not exist!");if(!0!==i&&null!==this._currentScreen)for(this._currentScreen.hide(),n=0;n<this._coveredScreens.length;n++)this._coveredScreens[n].hide();!0===i?(this._coveredScreens.push(this._currentScreen),this._currentScreen.setActive(!1),this._currentScreen=o,o.superimposeOnPage(s)):(this._currentScreen=o,o.show()),this._currentScreen===o&&this._currentScreen.setActive(!0)},i.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop(),this._currentScreen.setActive(!0)},i.prototype.closeOrNavigateTo=function(t){this._currentScreen._superimposed?this.closeSuperimposedScreen():this.setCurrentScreen(t)},i.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},s=new i,{getScreen:s.getScreen.bind(s),addScreen:s.addScreen.bind(s),setCurrentScreen:s.setCurrentScreen.bind(s),closeSuperimposedScreen:s.closeSuperimposedScreen.bind(s),closeOrNavigateTo:s.closeOrNavigateTo.bind(s),updateAllScreens:s.updateAllScreens.bind(s),executeWhenReady:s.executeWhenReady.bind(s)}}),define("utils/utils",[],function(){"use strict";var t={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},e={LEFT:1,MIDDLE:2,RIGHT:3},i=[],s={},n=180/Math.PI,o=Math.PI/180,r=.5*Math.PI,a=2*Math.PI,l={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"numpad *":106,"numpad +":107,"numpad -":109,"numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},h={};return h.EMPTY_ARRAY=i,h.EMPTY_STRING="",h.EMPTY_OBJECT=s,h.DEG=n,h.RAD=o,h.HALF_PI=r,h.DOUBLE_PI=a,h.ScaleMode=t,h.MouseButton=e,h.scalesWithWidth=function(e,i,s){return e===t.WIDTH||e===t.MINIMUM&&i<s||e===t.MAXIMUM&&i>=s},h.xScalesWithWidth=function(e,i,s){return e===t.ASPECT||e===t.WIDTH||e===t.MINIMUM&&i<s||e===t.MAXIMUM&&i>=s},h.yScalesWithHeight=function(e,i,s){return e===t.ASPECT||e===t.HEIGHT||e===t.MINIMUM&&s<i||e===t.MAXIMUM&&s>=i},h.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):l[t]:-1},h.getKeyOfCode=function(t){var e;for(e in l)if(l[e]===t)return e;return"#"+t},h.arraysEqual=function(t,e){var i,s;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,s=t.length;i<s;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},h.objectsEqual=function(t,e){var i,s,n;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t).sort(),!e)return!1;if(s=Object.keys(e).sort(),i.length!==s.length)return!1;for(n=0;n<i.length;n++)if(i[n]!==s[n]||t[i[n]]!==e[s[n]])return!1;return!0},h.equivalent=function(t,e){var i,s,n,o;if("object"==typeof t&&"object"==typeof e){if(null===t||null===e)return t===e;if(t instanceof Array&&e instanceof Array){if(t.length!==e.length)return!1;for(i=0,s=t.length;i<s;i++)if(!h.equivalent(t[i],e[i]))return!1;return!0}if(n=Object.keys(t).sort(),o=Object.keys(e).sort(),n.length!==o.length)return!1;for(i=0,s=n.length;i<s;i++)if(n[i]!==o[i]||!h.equivalent(t[n[i]],e[o[i]]))return!1;return!0}return t===e},h.shallowCopy=function(t){var e,i,s;if("object"==typeof t){if(t instanceof Array)return t.slice();for(e={},s=Object.keys(t),i=0;i<s.length;i++)e[s[i]]=t[s[i]];return e}return t},h.deepCopy=function(t){var e,i,s;if("object"==typeof t){if(t instanceof Array){for(e=[],i=0;i<t.length;i++)e.push(h.deepCopy(t[i]));return e}for(e={},s=Object.keys(t),i=0;i<s.length;i++)e[s[i]]=h.deepCopy(t[s[i]]);return e}return t},h.removeFromArray=function(t,e){var i=t.indexOf(e);return i>=0&&(t.splice(i,1),!0)},h.getSafeEnumValue=function(t,e,i){var s;i=i?h.getSafeEnumValue(t,i):null;for(s in t)if(t.hasOwnProperty(s)&&e===t[s])return e;return i||null},h.getSafeEnumValueForKey=function(t,e,i){return i=void 0!==i?h.getSafeEnumValue(t,i):null,e&&(e=h.constantName(e),t.hasOwnProperty(e))?t[e]:void 0!==i?i:null},h.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},h.getEnumKeys=function(t){var e,i=Object.keys(t);for(e=0;e<i.length;e++)i[e]=h.camelCase(i[e]);return i},h.getEnumObject=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},h.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},h.getPaddedStringForNumber=function(t,e,i){var s,n=t.toString(i||10);for(s=n.length;s<e;s++)n="0"+n;return n},h.getDelimitedStringForNumber=function(t){return t>=1e3?h.getDelimitedStringForNumber(Math.floor(t/1e3))+" "+h.getPaddedStringForNumber(t%1e3,3):t.toString()},h.getLengthString=function(t,e){return t<2e3?t<100&&!e?t.toPrecision(3)+" m":Math.round(t)+" m":t<1e5?(t/1e3).toPrecision(3)+" km":h.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},h.getMassString=function(t){return t<2e3?t<100?t.toPrecision(3)+" kg":Math.round(t)+" kg":t<1e5?(t/1e3).toPrecision(3)+" t":h.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},h.getTimeString=function(t){return t<1e3?t+" ms":t<6e4?Math.round(t/10)/100+" s":h.formatTimeToMinutes(t)},h.getFileSizeString=function(t){return t<2048?t+" B":t<2097152?(t/1024).toFixed(1)+" KiB":(t/1024*1024).toFixed(1)+" MiB"},h.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]||"-"===t[e]?"_":t[e].toUpperCase();return i},h.camelCase=function(t){var e,i="",s=!1;for(e=0;e<t.length;e++)"_"===t[e]?s=!0:(i+=s?t[e]:t[e].toLowerCase(),s=!1);return i},h.formatString=function(t,e){var i,s=t.toString();for(i in e)e.hasOwnProperty(i)&&(s=s.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return s},h.formatTimeToMinutes=function(t){var e,i;return e=Math.floor(t/6e4),i=Math.floor(t/1e3)%60,h.getPaddedStringForNumber(e,2)+":"+h.getPaddedStringForNumber(i,2)},h.formatTimeToSeconds=function(t){var e,i;return e=Math.floor(t/1e3)%60,i=Math.floor(t%1e3/10),h.getPaddedStringForNumber(e,2)+"."+h.getPaddedStringForNumber(i,2)},h.executeAsync=function(t){setTimeout(t,0)},h.pointInRect=function(t,e,i,s,n,o){return t>=i&&t<=n&&e>=s&&e<=o},h.getFilenameWithoutExtension=function(t){var e=t.lastIndexOf("."),i=t.lastIndexOf("/");return t=e>0?t.substr(0,e):t,t=i>0?t.substr(i+1):t},h.getLinearMix=function(t,e,i){return t*(1-i)+e*i},h.getMixedColor=function(t,e,i){var s=1-i;return[t[0]*s+e[0]*i,t[1]*s+e[1]*i,t[2]*s+e[2]*i,t[3]*s+e[3]*i]},h.getLuminance=function(t){return.299*t[0]+.587*t[1]+.114*t[2]},h.filterColor=function(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t[3]*=e[3],t},h.gammaCorrect=function(t,e){return t[0]=Math.pow(t[0],1/e),t[1]=Math.pow(t[1],1/e),t[2]=Math.pow(t[2],1/e),t},h.getCSSColor=function(t){return"rgba("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+","+t[3]+")"},h.getHexColor=function(t){return"#"+h.getPaddedStringForNumber(Math.round(255*t[0]),2,16)+h.getPaddedStringForNumber(Math.round(255*t[1]),2,16)+h.getPaddedStringForNumber(Math.round(255*t[2]),2,16)},h.getColor3FromHex=function(t){var e=[0,0,0];return e[0]=parseInt(t.substr(1,2),16)/255,e[1]=parseInt(t.substr(3,2),16)/255,e[2]=parseInt(t.substr(5,2),16)/255,e},h.isHexString=function(t){var e;for(e=0;e<t.length;e++)if(isNaN(parseInt(t[e],16)))return!1;return!0},h.getGreaterSolutionOfQuadraticEquation=function(t,e,i){var s=e*e-4*t*i;return s>=0?(Math.sqrt(s)-e)/(2*t):NaN},h.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3=function(t,e,i,s){var n,o,r,a,l,h,c,u,_,p,d,g,m=e/t,f=i/t,S=s/t,T=-m*m/48-S/4,E=-m*m*m/864-f*f/64+m*S/24,y=E*E/4+T*T*T/27;return y>=0?0===f&&m>0&&S===m*m/4?NaN:(n=Math.sqrt(y),o=Math.cbrt(-E/2+n),r=Math.cbrt(-E/2-n),l=m/6+2*(o+r),a=Math.sqrt(-m/3-(o+r)+Math.sqrt(l*l-S)),l=(f>0?-1:1)*Math.sqrt(-m/6+o+r),h=l+a,c=l-a,h<0?c:c<0?h:Math.min(h,c)):(l=2*Math.sqrt(-T/3),a=1/3*Math.acos(-E/2/Math.sqrt(-Math.pow(T/3,3))),u=-m/6+l*Math.cos(a),_=-m/6+l*Math.cos(2*Math.PI/3+a),p=-m/6+l*Math.cos(4*Math.PI/3+a),S>m*m/4||m>0?NaN:(l=(f>0?-1:1)*Math.sqrt(u),_=Math.sqrt(_),p=Math.sqrt(p),a=_+p,h=l+a,c=l-a,a=_-p,d=-l+a,g=-l-a,h<0?c<0?d<0?g<0?NaN:g:g<0?d:Math.min(d,g):d<0?g<0?c:Math.min(c,g):g<0?Math.min(c,d):Math.min(c,d,g):c<0?d<0?g<0?h:Math.min(h,g):g<0?Math.min(h,d):Math.min(h,d,g):d<0?g<0?Math.min(h,c):Math.min(h,c,g):g<0?Math.min(h,c,d):Math.min(h,c,d,g)))},h.areTouchEventsSupported=function(){return"ontouchstart"in window},h}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function i(t,e,i,s){return"Invalid value for '"+t+"' ("+e+")"+(s?": "+s:".")+" Using default value "+i+" instead."}function s(t,s,n,o){e.showError(i(t,s,n,o))}function n(t,e,i,s){return"Invalid value for '"+e+"'. Expected "+t+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(s instanceof Array?"["+s.join(", ")+"]":"'"+s+"'")+" instead."}function o(t,i,s,o){e.showError(n(t,i,s,o))}function r(e,i,s,n){return"Unrecognized '"+e+"' value: '"+i+"'. Possible values are are: "+t.getEnumValues(s).join(", ")+". Default value '"+n+"' will be used instead."}function a(t,i,s,n){e.showError(r(t,i,s,n))}var l={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},h={Errors:l};return h.NUMBER="number",h.VECTOR2={baseType:"array",length:2,elementType:"number"},h.VECTOR3={baseType:"array",length:3,elementType:"number"},h.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},h.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},h.DURATION={baseType:"number",range:[0,void 0]},h.ANGLE_DEGREES={baseType:"number",range:[-360,360]},h.getBooleanValue=function(t,e){if(e=e||{},e.name=e.name||"unnamed boolean","boolean"==typeof t){if(!e.checkFunction||e.checkFunction(t,e.parentObject))return t;e.error=l.CHECK_FAIL_ERROR,e.silentFallback?(e.name,e.defaultValue,e.checkFailMessage):s(e.name,t,e.defaultValue,e.checkFailMessage)}else e.error=l.TYPE_ERROR,e.silentFallback?(e.name,e.defaultValue):o("a boolean",e.name,t,e.defaultValue);return null!==e.defaultValue?(t=e.defaultValue,e.defaultValue=null,h.getBooleanValue(t,e)):null},h.getNumberValue=function(t,e,i,n,r,a,l){return"number"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getNumberValue(t,i,null,n,r,a):null):e:("number"==typeof i&&l||o("a number",t,e,i),null!==i?h.getNumberValue(t,i,null,n,r,a):null)},h.getNumberValueInRange=function(t,i,n,r,a,l,c,u){return"number"==typeof i?((void 0!==n&&i<n||void 0!==r&&i>r)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==n?n:"...")+"-"+(void 0!==r?r:"...")+"). The setting will be changed to fit the valid range."),void 0!==n&&(i=Math.max(n,i)),void 0!==r&&(i=Math.min(i,r))),l&&!l(i,u)?(s(t,i,a,c),null!==a?h.getNumberValueInRange(t,a,n,r,null,l,c,u):null):i):(o("a number",t,i,a),null!==a?h.getNumberValueInRange(t,a,n,r,null,l,c,u):null)},h.getStringValue=function(t,e,i,n,r,a){return"string"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getStringValue(t,i,null,n,r,a):null):e:(o("a string",t,e,i),null!==i?h.getStringValue(t,i,null,n,r,a):null)},h.getEnumValue=function(i,n,o){var r=t.getSafeEnumValue(i,n);if(o=o||{},o.name=o.name||"unnamed enum "+i.constructor.name,null!==r){if(!o.checkFunction||o.checkFunction(r,o.parentObject))return r;o.error=l.CHECK_FAIL_ERROR,o.silentFallback?(o.name,o.defaultValue,o.checkFailMessage):s(o.name,r,o.defaultValue,o.checkFailMessage)}else{if("object"!=typeof i||0===Object.keys(i).length)return o.error=l.INVALID_ENUM_OBJECT_ERROR,e.showError("Invalid enum object specified for "+o.name+": "+i+", and thus its value ("+n+") cannot be verified!"),null;o.error=l.ENUM_VALUE_ERROR,o.silentFallback?(o.name,o.defaultValue):a(o.name,n,i,o.defaultValue)}return null!==o.defaultValue?(n=o.defaultValue,o.defaultValue=null,h.getEnumValue(i,n,o)):null},h.getObjectValue=function(t,e,i,n,r,a){return"object"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getObjectValue(t,i,null,n,r,a):null):e:(o("an object",t,e,i),null!==i?h.getObjectValue(t,i,null,n,r,a):null)},h.getValueOfType=function(t,i,s,n,o,r,a,l,c){if(r=r||{},void 0===s)return void 0!==n?null!==n?h.getValueOfType(t,i,n,null,o,r,a,l,c):null:void(o||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return i.baseType?h.getValueOfType(t,i.baseType,s,n,o,i,a,l,c):h.getVerifiedObject(t,s,i);switch(i){case"boolean":return h.getBooleanValue(s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:l,parentObject:c});case"number":return r.range?h.getNumberValueInRange(t,s,r.range[0],r.range[1],n,a,l,c):h.getNumberValue(t,s,n,a,l,c);case"string":return h.getStringValue(t,s,n,a,l,c);case"enum":return r.values?h.getEnumValue(r.values,s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:l,parentObject:c}):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return r.properties?h.getVerifiedObject(t,s,r.properties):h.getObjectValue(t,s,n,a,l,c);case"array":return h.getArrayValue(t,s,r.elementType,r.elementTypeParams,r,n,a,l,r.elementCheck,r.elementCheckFailMessage,c);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},h.getArrayValue=function(t,i,n,r,a,l,c,u,_,p,d){var g,m=[];if(i instanceof Array){if(void 0!==a){if(void 0!==a.length&&i.length!==a.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+a.length+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,c,u,_,p,d):null;if(void 0!==a.minLength&&i.length<a.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+a.minLength+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,c,u,_,p,d):null;if(void 0!==a.maxLength&&i.length>a.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+a.maxLength+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,c,u,_,p,d):null}return void 0!==n&&(i.forEach(function(e,i){null!==(g=h.getValueOfType(t+"["+i+"]",n,e,null,!1,r,_,p,d))&&m.push(g)}),i=m),c&&!c(i)?(s(t,i,"["+l.join(", ")+"]",u),null!==l?h.getArrayValue(t,l,n,r,a,null,c,u,_,p,d):null):i}return o("an array",t,i,l),null!==l?h.getArrayValue(t,l,n,r,a,null,c,u,_,p,d):null},h.getVerifiedObject=function(t,i,s,n,o,r,a){var l,c,u,_,p,d,g=n||{},m=[];if("object"==typeof i){for(c in s)if(s.hasOwnProperty(c)){if(u=s[c],g[u.name]&&e.showError("'"+t+"' already has a property named '"+u.name+"', which will be overridden by a new value!"),!u.type&&!a)for(_={},d=Object.keys(u),p=0;p<d.length;p++)"object"==typeof u[d[p]]&&(_[d[p]]=u[d[p]]);g[u.name]=h.getValueOfType(t+"."+u.name,u.type||_||a,i[u.name],u.defaultValue,u.optional,{range:u.range,values:u.values,elementType:u.elementType,elementEnumObject:u.elementEnum,length:u.length,minLength:u.minLength,maxLength:u.maxLength,elementCheck:u.elementCheck,elementCheckFailMessage:u.elementCheckFailMessage,properties:u.properties},u.check,u.checkFailMessage,i),m.push(u.name)}if(o)for(l in i)i.hasOwnProperty(l)&&m.indexOf(l)<0&&o&&(g[l]=a?h.getValueOfType(t+"."+l,a,i[l]):i[l]);return g}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},h.getBooleanValueFromLocalStorage=function(t,e){var i;return i=localStorage[t]===(!0).toString()||localStorage[t]!==(!1).toString()&&localStorage[t],e=e||{},e.name=e.name||"localStorage."+t,h.getBooleanValue(i,e)},h.getNumberValueFromLocalStorage=function(t,e){var i=parseFloat(localStorage[t]);return isNaN(i)&&(i=localStorage[t]),e=e||{},e.name=e.name||"localStorage."+t,h.getNumberValue(e.name,i,e.defaultValue,e.checkFunction,e.checkFailMessage,e.parentObject,e.silentFallback)},h.getEnumValueFromLocalStorage=function(t,e,i){return i=i||{},i.name=i.name||"localStorage."+e,h.getEnumValue(t,localStorage[e],i)},h.getStringValueFromLocalStorage=function(t,e){return e=e||{},e.name=e.name||"localStorage."+t,h.getStringValue(e.name,localStorage[t],e.defaultValue,e.checkFunction,e.checkFailMessage)},h.getValueOfTypeFromLocalStorage=function(t,e,i){if("object"==typeof t)return i.values=t.values,h.getValueOfTypeFromLocalStorage(t.baseType,e,i);switch(t){case"boolean":return h.getBooleanValueFromLocalStorage(e,i);case"number":return h.getNumberValueFromLocalStorage(e,i);case"enum":return h.getEnumValueFromLocalStorage(i.values,e,i);case"string":return h.getStringValueFromLocalStorage(e,i)}},h.getNameAndValueDefinitionObject=function(t){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:t,type:"number"}}}},h.getEnumObjectForArray=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},h}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function i(t){var e,n;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){i(t[e]);for(n in t[e])t[e].hasOwnProperty(n)&&(t[e+s+n]=t[e][n]);delete t[e]}}var s=".",n={},o=null,r={},a={};return n.getLanguage=function(){return o},n.setLanguage=function(t){a.hasOwnProperty(t)?o=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},n.languageIsLoaded=function(t){return a.hasOwnProperty(t)},n.loadStrings=function(e,s,l){var h;r[e]={},i(s);for(h in l)l.hasOwnProperty(h)&&"object"==typeof l[h]&&t.getVerifiedObject("strings."+h,s,l[h],r[e],!1,!0,"string");a[e]=t.getVerifiedObject("strings."+h,s,{},null,!0,!0,"string"),o||n.setLanguage(e)},n.get=function(t,e,i){return a[o]&&a[o][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},n.has=function(t,e){return a[o]&&void 0!==a[o][t.name+(e||"")]},n.getKeys=function(t){return Object.keys(a[o]).filter(function(e){return 0===e.indexOf(t)})},n.getLocale=function(){return a[o].locale},n.CATEGORY_SEPARATOR=s,n}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var s=!1,n=!1,o=!1,r=null,a=null,l=null,h=null,c=null,u=null,_=null,p=function(){s&&n&&o&&(t.log("Initialization of "+r+" completed."),document.body.firstElementChild.remove(),e.setCurrentScreen(a))},d=function(){t._buildScreensAndExecuteCallback(function(){o=!0,p()})},g=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),n=!0,d()})})},m=function(){t.requestTextFile(l,h,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setPlatform(i.platform),t.setDebugVersion(i.debugVersion),t.setReleases(i.releases),t.log("Game version is: "+t.getVersion(),1),t.log("Game platform is: "+t.getPlatform(),1),c=i.defaultLanguage,u=i.configFiles.strings,requirejs(["modules/media-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.media.resources,function(){t.log("Game configuration loaded."),s=!0}),g(i.configFiles.settings)})})})};return t.setGameName=function(t){r=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){l=t},t.setConfigFileName=function(t){h=t},t.getDefaultLanguage=function(){return c},t.getLanguage=function(){return i.getLanguage()||c},t.getLanguages=function(){return Object.keys(u)},t.getDefaultCursor=function(){return _},t.requestLanguageChange=function(s,n,o){return u&&u[s]?(i.languageIsLoaded(s)?(i.setLanguage(s),e.updateAllScreens(),o(!1)):t.requestTextFile(u[s].folder,u[s].filename,function(t){i.loadStrings(s,JSON.parse(t),n),i.setLanguage(s),e.updateAllScreens(),o(!0)}),!0):(t.showError("Cannot change application language to '"+s+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(e){if(t.log("Initializing "+r+"..."),t.useElectron(e.electron),!t.usesElectron()&&"file:"===location.protocol&&!e.local)return void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar.");_=document.body.style.cursor,m()},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavigateTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,s){"use strict";function n(t){return $[t]&&!!$[t].model}function o(t){return $[t]&&$[t].model}function r(t){return $[t]&&$[t].requested}function a(t,i){r(t)?n(t)?i&&i():$[t].onLoadQueue.push(i):($[t]={},$[t].requested=!0,$[t].onLoadQueue=[i],e.requestTextFile(E,t,function(e){var i,s;for($[t].model=document.createDocumentFragment(),s=document.createElement("div"),s.innerHTML=e,$[t].model.appendChild(s.firstElementChild),i=0;i<$[t].onLoadQueue.length;i++)$[t].onLoadQueue[i]()}))}function l(e){var i=e.getCaption?e.getCaption():e.caption||s.get({name:e.id});return e.replacements?t.formatString(i,e.replacements):i}function h(){$={}}function c(t,e){var i,s,n,o,r,a;for(i=e.split("[p]"),n=0;n<i.length;n++)if(i[n]){for(s=document.createElement("p"),r=i[n].split("["),o=0;o<r.length;o++)if(r[o])if(o%2==0)s.appendChild(document.createTextNode(r[o].substring(r[o].indexOf("]")+1)));else{switch(a=document.createElement("span"),r[o].substring(0,r[o].indexOf("]"))){case"b":a.className=V;break;case"s":a.className=F;break;case"s:h":a.className=U}a.textContent=r[o].substring(r[o].indexOf("]")+1),s.appendChild(a)}t.appendChild(s)}}function u(t,e,i){this._name=t,this._elementID=e||t,this._element=null,this._onShow=i?i[B]:null,this._onHide=i?i[H]:null,this._onEnable=i?i[G]:null,this._onDisable=i?i[k]:null,this._onSelect=i?i[j]:null,this._onUnselect=i?i[W]:null}function _(t,e,s){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=s||{},this._rootElement=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function p(t,e,i,s){_.call(this,t,e,i),this._progress=this.registerSimpleComponent(y),this._status=this.registerSimpleComponent(M),this._header=this.registerSimpleComponent(I),this._image=this.registerSimpleComponent(C),this._headerID=s}function d(t,e,i,s,n,o){_.call(this,t,e,i),this._onShow=o?o[B]:null,this._onHide=o?o[H]:null,this._onButtonSelect=o?o[Y]:null,this._onButtonClick=o?o[X]:null,this._message=this.registerSimpleComponent(A),this._okButton=this.registerSimpleComponent(v,this._onButtonSelect?{select:function(){this._onButtonSelect(this._okButton.isEnabled())}.bind(this)}:null),this._header=this.registerSimpleComponent(N),this._headerID=s,this._okButtonID=n,this._handleKeyUp=function(t){t.keyCode===D?this._okButton._element.onclick():t.keyCode!==w&&t.keyCode!==P||this._okButton.select()}.bind(this)}function g(t,e,i,s,n){var o;for(_.call(this,t,e,i),this._menuOptions=s,o=0;o<this._menuOptions.length;o++)void 0===this._menuOptions[o].enabled&&(this._menuOptions[o].enabled=!0);this._selectedIndex=-1,this._onOptionSelect=n?n[z]:null,this._onOptionClick=n?n[q]:null,this._validateStyle(i)}function m(t,e,i,s,n){_.call(this,t,e,i),this._options=s,this._onChange=n?n[Q]:null,this._onClick=n?n[J]:null,this._onSelect=n?n[j]:null}function f(t,e,i,s,n,o){var r;for(_.call(this,t,e,i),this._listElements=s,r=0;r<this._listElements.length;r++)void 0===this._listElements[r].enabled&&(this._listElements[r].enabled=!0);this._subcaptions=n,this._highlightedIndex=-1,this._selectedIndex=-1,this._onElementHighlight=o?o[K]:null,this._onElementSelect=o?o[Z]:null,this._ulElement=null,this._validateStyle(i)}function S(t,e,i,s,n){_.call(this,t,e,i),this._propertyLabelDescriptor=s,this._valueList=n,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(O),this._valueSelector=this.registerSimpleComponent(L),this.onChange=null}function T(t,e,i,s,n,o){_.call(this,t,e,i),this._propertyLabelDescriptor=s,n=n||{},this._min=n.valueList?0:n.min,this._max=n.valueList?n.valueList.length-1:n.max,this._default=n.default,this._step=n.valueList?1:void 0!==n.step?n.step:1,this._valueList=n.valueList||null,this._propertyLabel=this.registerSimpleComponent(R),this._slider=this.registerSimpleComponent(b),this._valueLabel=this.registerSimpleComponent(x),this.onChange=o||null}var E="component",y="progress",M="status",I="header",C="image",A="message",v="okButton",N="header",O="property",L="value",R="property",b="slider",x="valueLabel",D=13,w=38,P=40,V="bold",F="ship",U="ship-hostile",B="show",H="hide",G="enable",k="disable",j="select",W="unselect",Y="buttonselect",X="buttonclick",z="optionselect",q="optionclick",J="click",Q="change",K="elementhighlight",Z="elementselect",$={};return u.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},
u.prototype.getContent=function(){return this._element.innerHTML},u.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},u.prototype.setTextContent=function(e,i){this._element.textContent=i?t.formatString(e,i):e},u.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},u.prototype.getAttribute=function(t){return this._element[t]},u.prototype.setAttribute=function(t,e){this._element[t]=e},u.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element||e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},u.prototype.isVisible=function(){return!this._element.hidden},u.prototype.hide=function(){this.isVisible()&&(this._element.hidden=!0,this._onHide&&this._onHide())},u.prototype.show=function(){this.isVisible()||(this._element.hidden=!1,this._onShow&&this._onShow())},u.prototype.setVisible=function(t){t?this.show():this.hide()},u.prototype.isEnabled=function(){return!this._element.classList.contains("disabled")},u.prototype.disable=function(){this.isEnabled()&&(this._element.classList.add("disabled"),this._onDisable&&this._onDisable())},u.prototype.enable=function(){this.isEnabled()||(this._element.classList.remove("disabled"),this._onEnable&&this._onEnable())},u.prototype.isSelected=function(){return this._element.classList.contains("selected")},u.prototype.select=function(){this.isSelected()||(this._element.classList.add("selected"),this._onSelect&&this._onSelect())},u.prototype.unselect=function(){this.isSelected()&&(this._element.classList.remove("selected"),this._onUnselect&&this._onUnselect()),this._element.blur()},_.prototype=new i.AsyncResource,_.prototype.constructor=_,_.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i]._name))},_.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,n(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,a(this._htmlFilename,function(){!0===this._cssLoaded&&this.setToReady()}.bind(this))},_.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(o(this._htmlFilename).firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},_.prototype._getElementID=function(t){return this._rootElementID+"_"+t},_.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+"_".length)},_.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent()},_.prototype.updateComponents=function(){var t,e;if(this._rootElement&&this._rootElement.parentNode===document.body)for(e=this._rootElement.querySelectorAll("[data-translation-key]"),t=0;t<e.length;t++)e[t].innerHTML=s.get({name:e[t].getAttribute("data-translation-key"),defaultValue:e[t].innerHTML})},_.prototype.registerSimpleComponent=function(t,e){var i=new u(t,this._getElementID(t),e);return this._simpleComponents.push(i),i},_.prototype.isVisible=function(){return!this._rootElement.hidden},_.prototype.show=function(){return!(!this._rootElement||this.isVisible())&&(this._rootElement.hidden=!1,!0)},_.prototype.hide=function(){return!(!this._rootElement||!this.isVisible())&&(this._rootElement.hidden=!0,!0)},_.prototype.setVisible=function(t){t?this.show():this.hide()},p.prototype=new _,p.prototype.constructor=p,p.prototype._initializeComponents=function(){_.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},p.prototype.setMaxProgress=function(t){this._rootElement&&(this._progress._element.max=t)},p.prototype.updateProgress=function(t){this._rootElement&&(this._progress._element.value=t)},p.prototype.updateStatus=function(t,e,i){this._rootElement&&(this._status.setContent(t,e),void 0!==i&&this.updateProgress(i))},p.prototype.makeIndeterminate=function(){this._rootElement&&(this._progress.hide(),this._image.show())},d.prototype=new _,d.prototype.constructor=d,d.prototype._initializeComponents=function(){_.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton._element.onmouseenter=function(){this._okButton.select()}.bind(this),this._okButton._element.onmouseleave=function(){this._okButton.unselect()}.bind(this),this._okButton._element.onclick=function(){return this._onButtonClick&&this._onButtonClick(this._okButton.isEnabled()),this.hide(),!1}.bind(this),_.prototype.hide.call(this))},d.prototype.show=function(){return!!_.prototype.show.call(this)&&(this._okButton.unselect(),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow(),!0)},d.prototype.hide=function(){return!!_.prototype.hide.call(this)&&(document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide(),!0)},d.prototype.updateMessage=function(t,e,i){this._rootElement&&(i?this._message.setContent(t,e):this._message.setTextContent(t,e))},d.prototype.onButtonClick=function(t){this._onButtonClick=t},g.prototype=new _,g.prototype.constructor=g,g.prototype._validateStyle=function(t){if("object"!=typeof t)return void e.showError("Invalid menu style specified: not an object!");t.selectedButtonClassName||e.showError("Attempting to specify a menu style without specifying a class for selected menu buttons!"),t.disabledClassName||e.showError("Attempting to specify a menu style without specifying a class for disabled menu buttons!")},g.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&(this._menuOptions[this._selectedIndex].element.classList.remove(this._style.selectedButtonClassName),this._menuOptions[this._selectedIndex].element.blur()),this._selectedIndex=t,this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].enabled&&(this._menuOptions[this._selectedIndex].element.classList.add(this._style.selectedButtonClassName),this._onOptionSelect&&this._onOptionSelect(!0)))},g.prototype._getMenuClickHandler=function(t){return function(){return this._menuOptions[t].enabled&&(this._selectIndex(t),this._menuOptions[t].action()),this._onOptionClick&&this._onOptionClick(this._menuOptions[t].enabled),!1}.bind(this)},g.prototype._getMenuMouseMoveHandler=function(t){return function(){this._menuOptions[t].enabled&&this._selectIndex(t)}.bind(this)},g.prototype._initializeComponents=function(){var t,e,i;if(_.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.menuClassName),t=0;t<this._menuOptions.length;t++)e=document.createElement("button"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id)),e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||"")+(this._menuOptions[t].enabled?"":this._style.disabledClassName),e.innerHTML=l(this._menuOptions[t]),e.onclick=this._getMenuClickHandler(t),e.onmousemove=this._getMenuMouseMoveHandler(t),this._menuOptions[t].element=e,i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i);this._rootElement.onmouseout=this.unselect.bind(this),this.refresh()}},g.prototype.updateComponents=function(){var t;for(_.prototype.updateComponents.call(this),t=0;t<this._menuOptions.length;t++)this._menuOptions[t].element.innerHTML=l(this._menuOptions[t])},g.prototype.unselect=function(){this._selectIndex(-1)},g.prototype.selectNext=function(){var t=this._selectedIndex;-1===t&&(t=this._menuOptions.length-1);do{this._selectIndex((this._selectedIndex+1)%this._menuOptions.length)}while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},g.prototype.selectPrevious=function(){var t=this._selectedIndex;-1===t&&(t=0);do{this._selectedIndex>0?this._selectIndex(this._selectedIndex-1):this._selectIndex(this._menuOptions.length-1)}while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},g.prototype.activateSelected=function(){this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].element.onclick()},g.prototype.refresh=function(){var t;for(t=0;t<this._menuOptions.length;t++)this._menuOptions[t].element&&(this._menuOptions[t].enabled?this._menuOptions[t].element.classList.remove(this._style.disabledClassName):this._menuOptions[t].element.classList.add(this._style.disabledClassName),this._menuOptions[t].isVisible&&(this._menuOptions[t].element.hidden=!this._menuOptions[t].isVisible()))},m.prototype=new _,m.prototype.constructor=m,m.prototype._getItemChangeHandler=function(){return function(){this._onChange&&this._onChange()}.bind(this)},m.prototype._getItemSelectHandler=function(){return function(){this._onSelect&&this._onSelect(!0)}.bind(this)},m.prototype._getItemClickHandler=function(t){return function(e){var i=!0;this._onClick&&(i=this._onClick(e)),i&&(this._options[t].element.click(),e.stopPropagation())}.bind(this)},m.prototype._initializeComponents=function(){var t,e,i,s,n=function(t){return t.stopPropagation(),!0},o=this._getItemChangeHandler(),r=this._getItemSelectHandler();if(_.prototype._initializeComponents.call(this),this._rootElement)for(t=0;t<this._options.length;t++)i=document.createElement("input"),i.type="checkbox",this._options[t].id&&(i.id=this._getElementID(this._options[t].id)),i.onchange=o,i.onclick=n,i.onfocus=r,this._options[t].element=i,s=document.createElement("label"),s.innerHTML=l(this._options[t]),this._options[t].id&&(s.for=this._getElementID(this._options[t].id)),this._options[t].label=s,e=document.createElement("div"),e.appendChild(i),e.appendChild(s),e.onclick=this._getItemClickHandler(t),e.onmouseenter=r,this._rootElement.appendChild(e)},m.prototype.updateComponents=function(){var t;for(_.prototype.updateComponents.call(this),t=0;t<this._options.length;t++)this._options[t].label.innerHTML=l(this._options[t])},m.prototype.getValue=function(){var t,e=[];for(t=0;t<this._options.length;t++)this._options[t].element.checked&&e.push(this._options[t].value);return e},f.prototype=new _,f.prototype.constructor=f,f.prototype._validateStyle=function(t){if("object"!=typeof t)return void e.showError("Invalid menu style specified: not an object!");t.disabledElementClassName||e.showError("Attempting to specify a list style without specifying a class for disabled list elements!"),t.selectedElementClassName||e.showError("Attempting to specify a list style without specifying a class for selected list elements!"),t.highlightedElementClassName||e.showError("Attempting to specify a list style without specifying a class for highlighted list elements!")},f.prototype._scrollToIndex=function(t){var e;e=this._listElements[t].element,e.offsetTop<this._rootElement.scrollTop?this._rootElement.scrollTop=e.offsetTop:e.offsetTop+e.offsetHeight>this._rootElement.scrollTop+this._rootElement.clientHeight&&(this._rootElement.scrollTop=e.offsetTop+e.offsetHeight-this._rootElement.clientHeight)},f.prototype._highlightIndex=function(t,e){t!==this._highlightedIndex&&(this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.classList.remove(this._style.highlightedElementClassName),this._highlightedIndex=t,this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].enabled&&(this._listElements[this._highlightedIndex].element.classList.add(this._style.highlightedElementClassName),e&&this._scrollToIndex(t),this._onElementHighlight&&this._onElementHighlight(t,!0)))},f.prototype.selectIndex=function(t,e){e&&t>=0&&this._scrollToIndex(t),t!==this._selectedIndex&&((t<0||t>=0&&this._listElements[t].enabled)&&(this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.remove(this._style.selectedElementClassName),this._selectedIndex=t,this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.add(this._style.selectedElementClassName)),this._onElementSelect&&this._onElementSelect(t,t>=0&&this._listElements[t].enabled))},f.prototype.getHighlightedIndex=function(){return this._highlightedIndex},f.prototype.getSelectedIndex=function(){return this._selectedIndex},f.prototype._getElementClickHandler=function(t){return function(){return this._listElements[t].enabled&&this.selectIndex(t),!1}.bind(this)},f.prototype._getElementMouseMoveHandler=function(t){return function(){this._listElements[t].enabled?this._highlightIndex(t):this._highlightIndex(-1)}.bind(this)},f.prototype._addListElement=function(t,e){var i,n,o;o=document.createElement("li"),o.className=this._style.elementContainerClassName||"",n=document.createElement("a"),n.className=(this._style.elementClassName||"")+" "+(t.enabled?"":this._style.disabledElementClassName),t.element=n,n.onclick=this._getElementClickHandler(e),n.onmousemove=this._getElementMouseMoveHandler(e),o.appendChild(n),i=document.createElement("span"),t.captionID&&i.setAttribute("data-translation-key",t.captionID),i.className=this._style.captionClassName||"",i.innerHTML=t.caption||s.get({name:t.captionID}),n.appendChild(i),this._subcaptions&&(n.appendChild(document.createElement("br")),i=document.createElement("span"),t.subcaptionID&&i.setAttribute("data-translation-key",t.subcaptionID),i.className=this._style.subcaptionClassName||"",i.innerHTML=t.subcaption||s.get({name:t.subcaptionID}),n.appendChild(i)),this._ulElement.appendChild(o)},f.prototype.addListElement=function(t){void 0===t.enabled&&(t.enabled=!0),this._listElements.push(t),this._addListElement(t,this._listElements.length-1)},f.prototype.setListElements=function(t){var e;for(this.reset(),this._ulElement.innerHTML="",this._listElements=t,e=0;e<this._listElements.length;e++)void 0===this._listElements[e].enabled&&(this._listElements[e].enabled=!0),this._addListElement(this._listElements[e],e)},f.prototype._initializeComponents=function(){var t;if(_.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.listContainerClassName),this._ulElement=document.createElement("ul"),this._ulElement.classList.add(this._style.listClassName),t=0;t<this._listElements.length;t++)this._addListElement(this._listElements[t],t);this._rootElement.onmouseleave=this.unhighlight.bind(this),this._rootElement.appendChild(this._ulElement)}},f.prototype.unhighlight=function(){this._highlightIndex(-1)},f.prototype.unselect=function(){this.selectIndex(-1)},f.prototype.reset=function(){this.unselect(),this.unhighlight(),this._rootElement.scrollTop=0},f.prototype.highlightNext=function(){var t=this._highlightedIndex;-1===t&&(t=this._listElements.length-1);do{this._highlightIndex((this._highlightedIndex+1)%this._listElements.length,!0)}while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},f.prototype.highlightPrevious=function(){var t=this._highlightedIndex;-1===t&&(t=0);do{this._highlightedIndex>0?this._highlightIndex(this._highlightedIndex-1,!0):this._highlightIndex(this._listElements.length-1,!0)}while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},f.prototype.selectHighlighted=function(){this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.onclick()},f.prototype.executeForListElements=function(t){var e;for(e=0;e<this._listElements.length;e++)t(this._listElements[e].element)},f.prototype.setCaption=function(t,e){var i=this._listElements[t],s=i.element.querySelector("."+this._style.captionClassName);i.captionID&&(i.captionID="",s.removeAttribute("data-translation-key")),i.caption=e,s.innerHTML=e},S.prototype=new _,S.prototype.constructor=S,S.prototype._initializeComponents=function(){_.prototype._initializeComponents.call(this),this._rootElement&&(this._style.selectorClassName&&(this._rootElement.className=this._style.selectorClassName),this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(l(this._propertyLabelDescriptor)),this._style.propertyContainerClassName&&(this._propertyLabel._element.className=this._style.propertyContainerClassName),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector._element.onmouseup=function(t){switch(t.preventDefault(),t.stopPropagation(),t.which){case 1:this.selectNextValue();break;case 3:this.selectPreviousValue()}return!1}.bind(this),this._valueSelector._element.oncontextmenu=function(t){return t.preventDefault(),t.stopPropagation(),!1})},S.prototype.updateComponents=function(){_.prototype.updateComponents.call(this),this._propertyLabel.setContent(l(this._propertyLabelDescriptor))},S.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i,0):e.showError("Attempted to select value: '"+t+"' for '"+l(this._propertyLabelDescriptor)+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},S.prototype.selectValueWithIndex=function(t,i){var s=this._valueIndex;this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),s!==t&&this.onChange&&this.onChange(i||0)):e.showError("Attempted to select value with index '"+t+"' for '"+l(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},S.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},S.prototype.getSelectedIndex=function(){return this._valueIndex},S.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length,1)},S.prototype.selectPreviousValue=function(){this.selectValueWithIndex(this._valueIndex>0?this._valueIndex-1:this._valueList.length-1,-1)},S.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},S.prototype.refreshValue=function(){this.selectValueWithIndex(this._valueIndex)},T.prototype=new _,T.prototype.constructor=T,T.prototype._initializeComponents=function(){var t=function(){this._updateValueLabel(),this.onChange&&this.onChange(this.getValue())}.bind(this);_.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(l(this._propertyLabelDescriptor)),this._valueList?(this.setValueList(this._valueList),this._valueLabel.show()):(this._valueLabel.hide(),this._updateSlider()),this.setNumericValue(this._default),this._slider._element.onchange=t,this._slider._element.oninput=t)},T.prototype.updateComponents=function(){_.prototype.updateComponents.call(this),this._propertyLabel.setContent(l(this._propertyLabelDescriptor))},T.prototype._updateSlider=function(){this._slider.setAttribute("min",this._min),this._slider.setAttribute("max",this._max),this._slider.setAttribute("step",this._step)},T.prototype._updateValueLabel=function(){this._valueList&&this._valueLabel.setContent(this._valueList[this.getNumericValue()])},T.prototype.setNumericValue=function(t){this._slider.setAttribute("value",t),this._updateValueLabel()},T.prototype.setListedValue=function(t){var i;this._valueList?(i=this._valueIndex.indexOf(t),i>=0?this.setNumericValue(i):e.showError("Cannot set listed value '"+t+"' for slider '"+this._name+"', because it is not in the value list!")):e.showError("Cannot set listed value '"+t+"' for slider '"+this._name+"', because it has no value list!")},T.prototype.getNumericValue=function(){return parseFloat(this._slider.getAttribute("value"))},T.prototype.getListedValue=function(){return this._valueList[this.getNumericValue()]},T.prototype.getValue=function(){return this._valueList?this.getListedValue():this.getNumericValue()},T.prototype.setValueList=function(t){var e=this.getNumericValue();this._valueList=t,this._min=0,this._max=t.length-1,this._step=1,e>this._max&&(e=0),this._updateSlider(),this.setNumericValue(e)},{ELEMENT_ID_SEPARATOR:"_",DISABLED_CLASS_NAME:"disabled",SELECTED_CLASS_NAME:"selected",HIGHLIGHTED_CLASS_NAME:"highlighted",EYE_CROSSED_CLASS_NAME:"crossed",FOCUSING_CLASS_NAME:"focusing",SHOW_EVENT_NAME:B,HIDE_EVENT_NAME:H,BUTTON_SELECT_EVENT_NAME:Y,BUTTON_CLICK_EVENT_NAME:X,OPTION_SELECT_EVENT_NAME:z,OPTION_CLICK_EVENT_NAME:q,TRANSLATION_KEY_ATTRIBUTE:"data-translation-key",clearStoredDOMModels:h,appendFormattedContent:c,SimpleComponent:u,LoadingBox:p,InfoBox:d,MenuComponent:g,CheckGroup:m,ListComponent:f,Selector:S,Slider:T}}),define("modules/analytics",["modules/application"],function(t){"use strict";function e(t){c=t,l=localStorage.analytics_id,h=localStorage.analytics_user_id,u=!localStorage.analytics_enabled||localStorage.analytics_enabled===(!0).toString()}function i(){var e=!(l&&h),i=t.getPlatform();_||(_=!0,m("start"+(e?"":"/"+l+"/"+h)+"?version="+t.getVersion().split(" ")[0]+"&platform="+i+("web"===i?"&hostname="+encodeURIComponent(location.hostname)+"&referrer="+encodeURIComponent(document.referrer):""),1e3,!1,function(t){var e=JSON.parse(t.responseText);e.error||e.newlyCreated&&e.id&&e.userID&&(l=e.id,h=e.userID,localStorage.analytics_id=l,localStorage.analytics_user_id=h)}))}function s(e,i,s){var n,o,r;u&&g(function(){if(l&&h){if(n=e+"/"+l+"/"+h,i)for(o=0;o<i.length;o++)n+="/"+i[o];if(n+="?version="+t.getVersion().split(" ")[0],s)for(n+="&",r=Object.keys(s),o=0;o<r.length;o++)n+=r[o]+"="+s[r[o]]+"&";m(n,1e3,!1,function(){})}})}function n(){return u}function o(){u||(u=!0,localStorage.analytics_enabled=(!0).toString(),s("enable"))}function r(){u&&(s("disable"),u=!1,localStorage.analytics_enabled=(!1).toString())}function a(t){t?o():r()}var l,h,c=null,u=!1,_=!1,p=[],d=function(){var t;p.shift(),(t=p[0])&&(t.callback?(t.callback(),d()):t.request&&t.request.send(null))},g=function(t){0===p.length?t():p.push({callback:t})},m=function(t,e,i,s,n){var o=new XMLHttpRequest,r=function(r){n&&(n(o)||(e=0)),e>0?setTimeout(function(){m(t,Math.min(2*e,3e4),!0,function(t){s(t),i||d()},n)},e):i||d()};u&&(o.onload=function(){s(o),i||d()}.bind(this),o.onerror=function(){r(o.statusText)}.bind(this),o.ontimeout=function(){r(0)}.bind(this),o.overrideMimeType("text/plain; charset=utf-8"),o.open("POST",c+t,!0),i?o.send(null):(p.push({request:o}),1===p.length&&o.send(null)))};return{init:e,login:i,sendEvent:s,isEnabled:n,enable:o,disable:r,setEnabled:a}}),define("utils/vectors",[],function(){"use strict";var t={},e=[],i=0,s=new Float32Array([0,0,0]);return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.NULL4W1=[0,0,0,1],Object.freeze(t.NULL4W1),t.UNIT2_X=[1,0],Object.freeze(t.UNIT2_X),t.UNIT2_Y=[0,1],Object.freeze(t.UNIT2_Y),t.UNIT3_X=[1,0,0],Object.freeze(t.UNIT3_X),t.UNIT3_Y=[0,1,0],Object.freeze(t.UNIT3_Y),t.UNIT3_Z=[0,0,1],Object.freeze(t.UNIT3_Z),t.perpendicular3=function(t){return[t[1],-t[0],0]},t.floatVector3Aux=function(t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.getYawAndPitch=function(e,i){Math.abs(i[2])>.99999?(e.yaw=0,e.pitch=i[2]>0?-Math.PI/2:Math.PI/2):(e.yaw=t.angle2yCapped(i[0],i[1]),i[0]>0&&(e.yaw=-e.yaw),e.pitch=Math.asin(i[2]))},t.getRollAndYaw=function(e,i,s){return Math.abs(i[1])>.99999?(e.roll=0,e.yaw=i[1]>0?0:Math.PI):(e.roll=t.angle2xCapped(i[0],i[2]),i[2]<0&&(e.roll=-e.roll),e.yaw=t.angle2yCapped(i[0]*Math.cos(-e.roll)+i[2]*Math.sin(e.roll),i[1]),!s&&Math.abs(e.roll)>Math.PI/2&&(e.yaw=-e.yaw,e.roll-=Math.PI*(e.roll>0?1:-1))),e},t.getRollAndPitch=function(e,i,s){return Math.abs(i[1])>.99999?(e.roll=0,e.pitch=i[1]>0?0:Math.PI):(e.roll=t.angle2yCapped(i[0],i[2]),i[0]>0&&(e.roll=-e.roll),e.pitch=t.angle2xCapped(i[1],i[0]*Math.sin(-e.roll)+i[2]*Math.cos(-e.roll)),!s&&Math.abs(e.roll)>Math.PI/2&&(e.pitch=-e.pitch,e.roll-=Math.PI*(e.roll>0?1:-1))),e},t.x3Aux=function(){var t=e[i];return t[0]=1,t[1]=0,t[2]=0,i=(i+1)%20,t},t.y3Aux=function(){var t=e[i];return t[0]=0,t[1]=1,t[2]=0,i=(i+1)%20,t},t.z3Aux=function(){var t=e[i];return t[0]=0,t[1]=0,t[2]=1,i=(i+1)%20,t},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled3Aux=function(t,s){var n=e[i];return n[0]=t[0]*s,n[1]=t[1]*s,n[2]=t[2]*s,i=(i+1)%20,n},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.sum3Aux=function(t,s){var n=e[i];return n[0]=t[0]+s[0],n[1]=t[1]+s[1],n[2]=t[2]+s[2],i=(i+1)%20,n},t.sumVec3Mat4Aux=function(t,s){var n=e[i];return n[0]=t[0]+s[12],n[1]=t[1]+s[13],n[2]=t[2]+s[14],i=(i+1)%20,n},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.diff3Aux=function(t,s){var n=e[i];return n[0]=t[0]-s[0],n[1]=t[1]-s[1],n[2]=t[2]-s[2],i=(i+1)%20,n},t.diffVec3Mat4Aux=function(t,s){var n=e[i];return n[0]=t[0]-s[12],n[1]=t[1]-s[13],n[2]=t[2]-s[14],i=(i+1)%20,n},t.diffMat4Vec3Aux=function(t,s){var n=e[i];return n[0]=t[12]-s[0],n[1]=t[13]-s[1],n[2]=t[14]-s[2],i=(i+1)%20,n},t.diffTranslation3Aux=function(t,s){var n=e[i];return n[0]=t[12]-s[12],n[1]=t[13]-s[13],n[2]=t[14]-s[14],i=(i+1)%20,n},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.cross3Aux=function(t,s){var n=e[i];return n[0]=t[1]*s[2]-t[2]*s[1],n[1]=t[2]*s[0]-t[0]*s[2],n[2]=t[0]*s[1]-t[1]*s[0],i=(i+1)%20,n},t.angle2x=function(t,e){return Math.acos(t/Math.sqrt(t*t+e*e))},t.angle2y=function(t,e){return Math.acos(e/Math.sqrt(t*t+e*e))},t.angle2xCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t/Math.sqrt(t*t+e*e)),1))},t.angle2yCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,e/Math.sqrt(t*t+e*e)),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.prodVec3Mat3Aux=function(t,s){var n=e[i];return n[0]=s[0]*t[0]+s[3]*t[1]+s[6]*t[2],n[1]=s[1]*t[0]+s[4]*t[1]+s[7]*t[2],n[2]=s[2]*t[0]+s[5]*t[1]+s[8]*t[2],i=(i+1)%20,n},t.prodVec3Mat4Aux=function(s,n){var o=e[i];return t.setProdVec3Mat4(o,s,n),i=(i+1)%20,o},t.prodVec4Mat4Aux=function(s,n){var o=e[i];return t.setProdVec4Mat4(o,s,n),i=(i+1)%20,o},t.prodTranslationRotation3Aux=function(t,s){var n=e[i];return n[0]=s[0]*t[12]+s[4]*t[13]+s[8]*t[14],n[1]=s[1]*t[12]+s[5]*t[13]+s[9]*t[14],n[2]=s[2]*t[12]+s[6]*t[13]+s[10]*t[14],i=(i+1)%20,n},t.prodTranslationModel3Aux=function(s,n){var o=e[i];return t.setProdTranslationModel3(o,s,n),i=(i+1)%20,o},t.prodMat4Vec3=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]]},t.prodMat4Vec3Aux=function(s,n){var o=e[i];return t.setProdMat4Vec3(o,s,n),i=(i+1)%20,o},t.setNull3=function(t){t[0]=0,t[1]=0,t[2]=0},t.setVector3=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2]},t.setVector4=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t[2]*=i,t},t.normalize4D=function(t){t[3]=t[3]||1e-7,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.scale3=function(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t},t.setSum3=function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.addVec3Mat4=function(t,e){return t[0]+=e[12],t[1]+=e[13],t[2]+=e[14],t},t.setDiff3=function(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2]},t.setDiffTranslation3=function(t,e,i){t[0]=e[12]-i[12],t[1]=e[13]-i[13],t[2]=e[14]-i[14]},t.sub3=function(t,e){t[0]-=e[0],t[1]-=e[1],t[2]-=e[2]},t.setCross3=function(t,e,i){t[0]=e[1]*i[2]-e[2]*i[1],t[1]=e[2]*i[0]-e[0]*i[2],t[2]=e[0]*i[1]-e[1]*i[0]},t.mulCross3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=s*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-s*e[0]},t.rotate2=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=t[0];t[0]=t[0]*i+t[1]*-s,t[1]=n*s+t[1]*i},t.setTranslationVector3=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},t.mulVec3Mat3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=e[0]*i+e[3]*s+e[6]*n,t[1]=e[1]*i+e[4]*s+e[7]*n,t[2]=e[2]*i+e[5]*s+e[8]*n},t.mulVec3Mat4=function(t,e){var i=t[0],s=t[1],n=t[2];return t[0]=e[0]*i+e[4]*s+e[8]*n,t[1]=e[1]*i+e[5]*s+e[9]*n,t[2]=e[2]*i+e[6]*s+e[10]*n,t},t.mulMat4Vec3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=e[0]*i+e[1]*s+e[2]*n,t[1]=e[4]*i+e[5]*s+e[6]*n,t[2]=e[8]*i+e[9]*s+e[10]*n},t.mulVec3ModelMat4=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=e[0]*i+e[4]*s+e[8]*n+e[12],t[1]=e[1]*i+e[5]*s+e[9]*n+e[13],t[2]=e[2]*i+e[6]*s+e[10]*n+e[14]},t.mulVec3ViewProj=function(t,e,i){var s,n=t[0],o=t[1],r=t[2];t[0]=(n*e[0]+o*e[4]+r*e[8]+e[12])*i[0],t[1]=(n*e[1]+o*e[5]+r*e[9]+e[13])*i[5],s=n*e[2]+o*e[6]+r*e[10]+e[14],t[2]=s*i[10]+i[14],t[3]=s*i[11]+i[15]},t.setProdVec3Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]},t.mulVec4Mat4=function(t,e){var i=t[0],s=t[1],n=t[2],o=t[3];t[0]=e[0]*i+e[4]*s+e[8]*n+e[12]*o,t[1]=e[1]*i+e[5]*s+e[9]*n+e[13]*o,t[2]=e[2]*i+e[6]*s+e[10]*n+e[14]*o,t[3]=e[3]*i+e[7]*s+e[11]*n+e[15]*o},t.setProdVec4Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2]+i[12]*e[3],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2]+i[13]*e[3],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]+i[14]*e[3],t[3]=i[3]*e[0]+i[7]*e[1]+i[11]*e[2]+i[15]*e[3]},t.setProdMat4Vec3=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[1]+e[2]*i[2],t[1]=e[4]*i[0]+e[5]*i[1]+e[6]*i[2],t[2]=e[8]*i[0]+e[9]*i[1]+e[10]*i[2]},t.setProdTranslationModel3=function(t,e,i){t[0]=i[0]*e[12]+i[4]*e[13]+i[8]*e[14]+i[12],t[1]=i[1]*e[12]+i[5]*e[13]+i[9]*e[14]+i[13],t[2]=i[2]*e[12]+i[6]*e[13]+i[10]*e[14]+i[14]},t.setRowB43=function(t,e){t[0]=e[4],t[1]=e[5],t[2]=e[6]},t.extractLength2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,e},t.extractLength3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t[2]*=i,e},t.getRowA43Aux=function(t){var s=e[i];return s[0]=t[0],s[1]=t[1],s[2]=t[2],i=(i+1)%20,s},t.getRowB43Aux=function(t){var s=e[i];return s[0]=t[4],s[1]=t[5],s[2]=t[6],i=(i+1)%20,s},t.getRowB43ScaledAux=function(t,s){var n=e[i];return n[0]=t[4]*s,n[1]=t[5]*s,n[2]=t[6]*s,i=(i+1)%20,n},t.getRowC43Aux=function(t){var s=e[i];return s[0]=t[8],s[1]=t[9],s[2]=t[10],i=(i+1)%20,s},t.getRowC43ScaledAux=function(t,s){var n=e[i];return n[0]=t[8]*s,n[1]=t[9]*s,n[2]=t[10]*s,
i=(i+1)%20,n},function(){var t;for(t=0;t<20;t++)e.push([0,0,0,0])}(),t}),define("utils/matrices",["utils/utils","utils/vectors"],function(t,e){"use strict";function i(){var t;for(t=0;t<r.length;t++)if(!r[t].used)return t;return r.push({used:!1,matrix:o.identity4()}),r.length-1}function s(t){return r[t].used=!0,r[t].matrix}function n(t){r[t].used=!1}var o={},r=[],a=[],l=0,h=[],c=0;return o.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},o.identity3Aux=function(){var t=h[c];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,c=(c+1)%20,t},o.IDENTITY3=o.identity3(),o.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},o.identity4Aux=function(){var t=a[l];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,l=(l+1)%20,t},o.IDENTITY4=o.identity4(),o.copy=function(t){return new Float32Array(t)},o.matrix3Aux=function(t){var e=h[c];return e.set(t),c=(c+1)%20,e},o.matrix4Aux=function(t){var e=a[l];return e.set(t),l=(l+1)%20,e},o.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},o.translation4Aux=function(t,e,i){var s=a[l];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,l=(l+1)%20,s},o.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},o.translation4vAux=function(t){var e=a[l];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,l=(l+1)%20,e},o.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},o.translation4m4Aux=function(t){var e=a[l];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=1,l=(l+1)%20,e},o.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},o.rotation3Aux=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=h[c];return n[0]=i+(1-i)*t[0]*t[0],n[1]=(1-i)*t[0]*t[1]-s*t[2],n[2]=(1-i)*t[0]*t[2]+s*t[1],n[3]=(1-i)*t[0]*t[1]+s*t[2],n[4]=i+(1-i)*t[1]*t[1],n[5]=(1-i)*t[1]*t[2]-s*t[0],n[6]=(1-i)*t[0]*t[2]-s*t[1],n[7]=(1-i)*t[1]*t[2]+s*t[0],n[8]=i+(1-i)*t[2]*t[2],c=(c+1)%20,n},o.rotationX4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1])},o.ROTATION_X_90=o.rotationX4(.5*Math.PI),o.ROTATION_X_180=o.rotationX4(1*Math.PI),o.ROTATION_X_270=o.rotationX4(1.5*Math.PI),o.rotationY4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1])},o.ROTATION_Y_90=o.rotationY4(.5*Math.PI),o.ROTATION_Y_180=o.rotationY4(1*Math.PI),o.ROTATION_Y_270=o.rotationY4(1.5*Math.PI),o.rotationZ4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1])},o.ROTATION_Z_90=o.rotationZ4(.5*Math.PI),o.ROTATION_Z_180=o.rotationZ4(1*Math.PI),o.ROTATION_Z_270=o.rotationZ4(1.5*Math.PI),o.rotation4Aux=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=a[l];return n[0]=i+(1-i)*t[0]*t[0],n[1]=(1-i)*t[0]*t[1]-s*t[2],n[2]=(1-i)*t[0]*t[2]+s*t[1],n[3]=0,n[4]=(1-i)*t[0]*t[1]+s*t[2],n[5]=i+(1-i)*t[1]*t[1],n[6]=(1-i)*t[1]*t[2]-s*t[0],n[7]=0,n[8]=(1-i)*t[0]*t[2]-s*t[1],n[9]=(1-i)*t[1]*t[2]+s*t[0],n[10]=i+(1-i)*t[2]*t[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,l=(l+1)%20,n},o.rotationX4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),s=a[l];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=-i,s[7]=0,s[8]=0,s[9]=i,s[10]=e,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.rotationZ4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),s=a[l];return s[0]=e,s[1]=-i,s[2]=0,s[3]=0,s[4]=i,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.lookTowards4=function(t,e){var i;return i=o.identity4(),o.setLookTowards4(i,t,e),i},o.lookTowards4Aux=function(t,e){var i=a[l];return o.setLookTowards4(i,t,e),l=(l+1)%20,i},o.scaling4=function(t,e,i){return void 0===e&&(e=t),void 0===i&&(i=t),new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},o.scaling4Aux=function(t,e,i){var s=a[l];return void 0===e&&(e=t),void 0===i&&(i=t),s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.rotation4FromJSON=function(i){var s,n,r,a=o.identity4();if(i)for(s=0;s<i.length;s++){if(r="string"==typeof i[s]?{axis:i[s][0],degrees:parseFloat(i[s].substring(1))}:i[s],"string"==typeof r.axis)switch(r.axis){case"x":case"X":n=e.UNIT3_X;break;case"y":case"Y":n=e.UNIT3_Y;break;case"z":case"Z":n=e.UNIT3_Z}else r.axis instanceof Array&&(n=r.axis);o.mulRotationRotation4(a,o.rotation4Aux(n,r.degrees*t.RAD))}return a},o.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},o.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},o.translationVector3=function(t){return[t[12],t[13],t[14]]},o.translationLength=function(t){return Math.sqrt(t[12]*t[12]+t[13]*t[13]+t[14]*t[14])},o.getYawAndPitch=function(i){var s,n={};return Math.abs(i[6])>.99999?(n.yaw=0,n.pitch=i[6]>0?-t.HALF_PI:t.HALF_PI):(n.yaw=i[10]>0?e.angle2yCapped(i[4],i[5]):e.angle2yCapped(-i[4],-i[5]),i[4]*i[10]<0&&(n.yaw=-n.yaw),s=o.prod3x3SubOf4Aux(i,o.rotationZ4Aux(-n.yaw)),o.correctOrthogonal4(s),n.pitch=e.angle2xCapped(s[5],s[6]),s[6]>0&&(n.pitch=-n.pitch)),n},o.getRotations=function(i){var s,n,r={};return s=e.dot3(e.UNIT3_Y,e.getRowB43Aux(i)),Math.abs(s)>.99999?(r.alphaAxis=[0,0,1],r.alpha=s>0?0:Math.PI):(r.alphaAxis=e.normalize3(e.cross3(e.getRowB43Aux(i),e.UNIT3_Y)),r.alpha=e.angle3u(e.getRowB43Aux(i),e.UNIT3_Y)),r.alpha>Math.PI&&(r.alpha-=t.DOUBLE_PI),n=o.prod3x3SubOf43Aux(i,o.rotation3Aux(r.alphaAxis,-r.alpha)),o.correctOrthogonal4(n),s=e.dot3(e.UNIT3_X,e.getRowA43Aux(n)),Math.abs(s)>.99999?(r.gammaAxis=[0,1,0],r.gamma=s>0?0:Math.PI):(r.gammaAxis=e.normalize3(e.cross3(e.getRowA43Aux(n),e.UNIT3_X)),r.gamma=e.angle3u(e.getRowA43Aux(n),e.UNIT3_X)),r.gamma>Math.PI&&(r.gamma-=t.DOUBLE_PI),r},o.matrix3from4Aux=function(t){var e=h[c];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],c=(c+1)%20,e},o.transposed3Aux=function(t){var e=h[c];return o.setTransposed3(e,t),c=(c+1)%20,e},o.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},o.transposed4Aux=function(t){var e=a[l];return o.setTransposed4(e,t),l=(l+1)%20,e},o.transpose3=function(t){var e=t[1],i=t[2],s=t[5];t[1]=t[3],t[3]=e,t[2]=t[6],t[6]=i,t[5]=t[7],t[7]=s},o.inverse3Aux=function(t){var e=h[c];return o.setInverse3(e,t),c=(c+1)%20,e},o.inverse4Aux=function(t){var e=a[l];return o.setInverse4(e,t),l=(l+1)%20,e},o.inverseOfTranslation4Aux=function(t){var e=a[l];return o.setInverseOfTranslation4(e,t),l=(l+1)%20,e},o.inverseOfRotation4=o.transposed4,o.inverseOfRotation4Aux=o.transposed4Aux,o.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},o.prod4Aux=function(t,e){var i=a[l];return o.setProd4(i,t,e),l=(l+1)%20,i},o.prod3x3SubOf4Aux=function(t,e){var i=a[l];return i[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8],i[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9],i[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10],i[3]=0,i[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8],i[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9],i[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10],i[7]=0,i[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8],i[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9],i[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.scaledRotationAux=function(t,e){var i=a[l];return i[0]=t*e[0],i[1]=t*e[1],i[2]=t*e[2],i[3]=0,i[4]=t*e[4],i[5]=t*e[5],i[6]=t*e[6],i[7]=0,i[8]=t*e[8],i[9]=t*e[9],i[10]=t*e[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.prodScalingRotation3Aux=function(t,e){var i=h[c];return i[0]=t[0]*e[0],i[1]=t[0]*e[1],i[2]=t[0]*e[2],i[3]=t[5]*e[4],i[4]=t[5]*e[5],i[5]=t[5]*e[6],i[6]=t[10]*e[8],i[7]=t[10]*e[9],i[8]=t[10]*e[10],c=(c+1)%20,i},o.prod3x3SubOf43Aux=function(t,e){var i=a[l];return i[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],i[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],i[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],i[3]=0,i[4]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],i[5]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],i[6]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],i[7]=0,i[8]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],i[9]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],i[10]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.prodTranslationRotation4=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[0]*t[12]+e[4]*t[13]+e[8]*t[14],e[1]*t[12]+e[5]*t[13]+e[9]*t[14],e[2]*t[12]+e[6]*t[13]+e[10]*t[14],1])},o.prodTranslationRotation4Aux=function(t,e){var i=a[l];return o.setProdTranslationRotation4(i,t,e),l=(l+1)%20,i},o.prod34Aux=function(t,e,i){var s=o.prod4Aux(t,e);return o.mul4(s,i),s},o.translatedByM4Aux=function(t,e){var i=a[l];return o.setTranslatedByM4(i,t,e),l=(l+1)%20,i},o.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},o.setIdentity3=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},o.setIdentity4=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setMatrix3=function(t,e){var i;for(i=0;i<9;i++)t[i]=e[i]},o.setMatrix4=function(t,e){var i;for(i=0;i<16;i++)t[i]=e[i]},o.copyTranslation4=function(t,e){t[12]=e[12],t[13]=e[13],t[14]=e[14]},o.copyRotation4=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[8]=e[8],t[9]=e[9],t[10]=e[10]},o.copyScaling4=function(t,e){t[0]=e[0],t[5]=e[5],t[10]=e[10]},o.updateTranslation4v=function(t,e){t[12]=e[0],t[13]=e[1],t[14]=e[2]},o.setRotation2=function(t,e){var i=Math.cos(e),s=Math.sin(e);t[0]=i,t[1]=-s,t[2]=s,t[3]=i},o.setRotation3=function(t,e,i){var s=Math.cos(i),n=Math.sin(i);t[0]=s+(1-s)*e[0]*e[0],t[1]=(1-s)*e[0]*e[1]-n*e[2],t[2]=(1-s)*e[0]*e[2]+n*e[1],t[3]=(1-s)*e[0]*e[1]+n*e[2],t[4]=s+(1-s)*e[1]*e[1],t[5]=(1-s)*e[1]*e[2]-n*e[0],t[6]=(1-s)*e[0]*e[2]-n*e[1],t[7]=(1-s)*e[1]*e[2]+n*e[0],t[8]=s+(1-s)*e[2]*e[2]},o.setRotation4=function(t,e,i){var s=Math.cos(i),n=Math.sin(i);t[0]=s+(1-s)*e[0]*e[0],t[1]=(1-s)*e[0]*e[1]-n*e[2],t[2]=(1-s)*e[0]*e[2]+n*e[1],t[3]=0,t[4]=(1-s)*e[0]*e[1]+n*e[2],t[5]=s+(1-s)*e[1]*e[1],t[6]=(1-s)*e[1]*e[2]-n*e[0],t[7]=0,t[8]=(1-s)*e[0]*e[2]-n*e[1],t[9]=(1-s)*e[1]*e[2]+n*e[0],t[10]=s+(1-s)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setRotationAroundPoint4=function(t,i,s,n){var r;o.setRotation4(t,s,n),r=e.prodVec3Mat4Aux(i,t),t[12]=i[0]-r[0],t[13]=i[1]-r[1],t[14]=i[2]-r[2]},o.setLookTowards4=function(t,i,s){var n;s=s||[0,1,0],Math.abs(e.dot3(s,i))>.99999&&(s=e.perpendicular3(i)),n=e.cross3Aux(s,i),t[0]=n[0],t[1]=n[1],t[2]=n[2],s=e.cross3Aux(i,n),t[4]=s[0],t[5]=s[1],t[6]=s[2],o.correctOrthogonal4(t)},o.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},o.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},o.translateByMatrixMul=function(t,e,i){t[12]+=e[12]*i,t[13]+=e[13]*i,t[14]+=e[14]*i},o.rotate4=function(t,e,r){var a=i(),l=s(a);o.setRotation3(l,e,r),o.mul43(t,l),n(a)},o.rotateAroundPoint4=function(t,e,r,a){var l=i(),h=s(l);o.setRotationAroundPoint4(h,e,r,a),o.mul4(t,h),n(l)},o.setInverse3=function(t,e){var r,a,l,h,c,u,_,p=i();if(u=s(p),o.setMatrix3(u,e),o.setIdentity3(t),0!==o.determinant3(u)){for(r=0;r<3;r++){if(Math.abs(u[4*r])<=1e-4){for(a=r+1;Math.abs(u[3*a+r])<=1e-4;)a++;for(l=0;l<3;l++)_=u[3*r+l],u[3*r+l]=u[3*a+l],u[3*a+l]=_,_=t[3*r+l],t[3*r+l]=t[3*a+l],t[3*a+l]=_}for(h=u[4*r],a=0;a<3;a++)u[3*r+a]=u[3*r+a]/h,t[3*r+a]=t[3*r+a]/h;for(a=r+1;a<3;a++)for(c=u[3*a+r]/u[4*r],l=0;l<3;l++)u[3*a+l]=u[3*a+l]-c*u[3*r+l],t[3*a+l]=t[3*a+l]-c*t[3*r+l]}for(r=2;r>=1;r--)for(a=r-1;a>=0;a--)for(l=0;l<3;l++)t[3*a+l]=t[3*a+l]-u[3*a+r]*t[3*r+l];n(p)}},o.setInverse4=function(t,e){var r,a,l,h,c,u,_,p=i();for(u=s(p),o.setMatrix4(u,e),o.setIdentity4(t),r=0;r<4;r++){if(Math.abs(u[5*r])<=1e-4){for(a=r+1;Math.abs(u[4*a+r])<=1e-4;)a++;for(l=0;l<4;l++)_=u[4*r+l],u[4*r+l]=u[4*a+l],u[4*a+l]=_,_=t[4*r+l],t[4*r+l]=t[4*a+l],t[4*a+l]=_}for(h=u[5*r],a=0;a<4;a++)u[4*r+a]=u[4*r+a]/h,t[4*r+a]=t[4*r+a]/h;for(a=r+1;a<4;a++)for(c=u[4*a+r]/u[5*r],l=0;l<4;l++)u[4*a+l]=u[4*a+l]-c*u[4*r+l],t[4*a+l]=t[4*a+l]-c*t[4*r+l]}for(r=3;r>=1;r--)for(a=r-1;a>=0;a--)for(l=0;l<4;l++)t[4*a+l]=t[4*a+l]-u[4*a+r]*t[4*r+l];n(p)},o.setInverseOfTranslation4=function(t,e){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=1},o.setTransposed3=function(t,e){t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]},o.setTransposed4=function(t,e){t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]},o.setInverseOfRotation4=o.setTransposed4,o.mul3=function(t,e){var r=i(),a=s(r);o.setMatrix3(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[3]=a[3]*e[0]+a[4]*e[3]+a[5]*e[6],t[4]=a[3]*e[1]+a[4]*e[4]+a[5]*e[7],t[5]=a[3]*e[2]+a[4]*e[5]+a[5]*e[8],t[6]=a[6]*e[0]+a[7]*e[3]+a[8]*e[6],t[7]=a[6]*e[1]+a[7]*e[4]+a[8]*e[7],t[8]=a[6]*e[2]+a[7]*e[5]+a[8]*e[8],n(r)},o.mul3multi=function(t,e,r){var a,l=i(),h=s(l);for(a=0;a<r;a++)o.setMatrix3(h,t),t[0]=h[0]*e[0]+h[1]*e[3]+h[2]*e[6],t[1]=h[0]*e[1]+h[1]*e[4]+h[2]*e[7],t[2]=h[0]*e[2]+h[1]*e[5]+h[2]*e[8],t[3]=h[3]*e[0]+h[4]*e[3]+h[5]*e[6],t[4]=h[3]*e[1]+h[4]*e[4]+h[5]*e[7],t[5]=h[3]*e[2]+h[4]*e[5]+h[5]*e[8],t[6]=h[6]*e[0]+h[7]*e[3]+h[8]*e[6],t[7]=h[6]*e[1]+h[7]*e[4]+h[8]*e[7],t[8]=h[6]*e[2]+h[7]*e[5]+h[8]*e[8];n(l)},o.mul4=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[4]+a[2]*e[8]+a[3]*e[12],t[1]=a[0]*e[1]+a[1]*e[5]+a[2]*e[9]+a[3]*e[13],t[2]=a[0]*e[2]+a[1]*e[6]+a[2]*e[10]+a[3]*e[14],t[3]=a[0]*e[3]+a[1]*e[7]+a[2]*e[11]+a[3]*e[15],t[4]=a[4]*e[0]+a[5]*e[4]+a[6]*e[8]+a[7]*e[12],t[5]=a[4]*e[1]+a[5]*e[5]+a[6]*e[9]+a[7]*e[13],t[6]=a[4]*e[2]+a[5]*e[6]+a[6]*e[10]+a[7]*e[14],t[7]=a[4]*e[3]+a[5]*e[7]+a[6]*e[11]+a[7]*e[15],t[8]=a[8]*e[0]+a[9]*e[4]+a[10]*e[8]+a[11]*e[12],t[9]=a[8]*e[1]+a[9]*e[5]+a[10]*e[9]+a[11]*e[13],t[10]=a[8]*e[2]+a[9]*e[6]+a[10]*e[10]+a[11]*e[14],t[11]=a[8]*e[3]+a[9]*e[7]+a[10]*e[11]+a[11]*e[15],t[12]=a[12]*e[0]+a[13]*e[4]+a[14]*e[8]+a[15]*e[12],t[13]=a[12]*e[1]+a[13]*e[5]+a[14]*e[9]+a[15]*e[13],t[14]=a[12]*e[2]+a[13]*e[6]+a[14]*e[10]+a[15]*e[14],t[15]=a[12]*e[3]+a[13]*e[7]+a[14]*e[11]+a[15]*e[15],n(r)},o.mul43=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[4]=a[4]*e[0]+a[5]*e[3]+a[6]*e[6],t[5]=a[4]*e[1]+a[5]*e[4]+a[6]*e[7],t[6]=a[4]*e[2]+a[5]*e[5]+a[6]*e[8],t[8]=a[8]*e[0]+a[9]*e[3]+a[10]*e[6],t[9]=a[8]*e[1]+a[9]*e[4]+a[10]*e[7],t[10]=a[8]*e[2]+a[9]*e[5]+a[10]*e[8],t[12]=a[12]*e[0]+a[13]*e[3]+a[14]*e[6],t[13]=a[12]*e[1]+a[13]*e[4]+a[14]*e[7],t[14]=a[12]*e[2]+a[13]*e[5]+a[14]*e[8],n(r)},o.mulRotation43=function(t,e){var r=i(),a=s(r);o.copyRotation4(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[4]=a[4]*e[0]+a[5]*e[3]+a[6]*e[6],t[5]=a[4]*e[1]+a[5]*e[4]+a[6]*e[7],t[6]=a[4]*e[2]+a[5]*e[5]+a[6]*e[8],t[8]=a[8]*e[0]+a[9]*e[3]+a[10]*e[6],t[9]=a[8]*e[1]+a[9]*e[4]+a[10]*e[7],t[10]=a[8]*e[2]+a[9]*e[5]+a[10]*e[8],n(r)},o.mulRotation43Multi=function(t,e,r){var a,l=i(),h=s(l);for(a=0;a<r;a++)o.copyRotation4(h,t),t[0]=h[0]*e[0]+h[1]*e[3]+h[2]*e[6],t[1]=h[0]*e[1]+h[1]*e[4]+h[2]*e[7],t[2]=h[0]*e[2]+h[1]*e[5]+h[2]*e[8],t[4]=h[4]*e[0]+h[5]*e[3]+h[6]*e[6],t[5]=h[4]*e[1]+h[5]*e[4]+h[6]*e[7],t[6]=h[4]*e[2]+h[5]*e[5]+h[6]*e[8],t[8]=h[8]*e[0]+h[9]*e[3]+h[10]*e[6],t[9]=h[8]*e[1]+h[9]*e[4]+h[10]*e[7],t[10]=h[8]*e[2]+h[9]*e[5]+h[10]*e[8];n(l)},o.mulRotationRotation4=function(t,e){var r=i(),a=s(r);o.copyRotation4(a,t),t[0]=a[0]*e[0]+a[1]*e[4]+a[2]*e[8],t[1]=a[0]*e[1]+a[1]*e[5]+a[2]*e[9],t[2]=a[0]*e[2]+a[1]*e[6]+a[2]*e[10],t[4]=a[4]*e[0]+a[5]*e[4]+a[6]*e[8],t[5]=a[4]*e[1]+a[5]*e[5]+a[6]*e[9],t[6]=a[4]*e[2]+a[5]*e[6]+a[6]*e[10],t[8]=a[8]*e[0]+a[9]*e[4]+a[10]*e[8],t[9]=a[8]*e[1]+a[9]*e[5]+a[10]*e[9],t[10]=a[8]*e[2]+a[9]*e[6]+a[10]*e[10],n(r)},o.setProd4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8]+e[3]*i[12],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9]+e[3]*i[13],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10]+e[3]*i[14],t[3]=e[0]*i[3]+e[1]*i[7]+e[2]*i[11]+e[3]*i[15],t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8]+e[7]*i[12],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9]+e[7]*i[13],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10]+e[7]*i[14],t[7]=e[4]*i[3]+e[5]*i[7]+e[6]*i[11]+e[7]*i[15],t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8]+e[11]*i[12],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9]+e[11]*i[13],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10]+e[11]*i[14],t[11]=e[8]*i[3]+e[9]*i[7]+e[10]*i[11]+e[11]*i[15],t[12]=e[12]*i[0]+e[13]*i[4]+e[14]*i[8]+e[15]*i[12],t[13]=e[12]*i[1]+e[13]*i[5]+e[14]*i[9]+e[15]*i[13],t[14]=e[12]*i[2]+e[13]*i[6]+e[14]*i[10]+e[15]*i[14],t[15]=e[12]*i[3]+e[13]*i[7]+e[14]*i[11]+e[15]*i[15]},o.setProd4NoProj=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10],t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10],t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10],t[12]=e[12]*i[0]+e[13]*i[4]+e[14]*i[8]+i[12],t[13]=e[12]*i[1]+e[13]*i[5]+e[14]*i[9]+i[13],t[14]=e[12]*i[2]+e[13]*i[6]+e[14]*i[10]+i[14]},o.setProd3x3SubOf4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10],t[3]=0,t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10],t[7]=0,t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.updateProdRotationRotationInverse4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[1]+e[2]*i[2],t[1]=e[0]*i[4]+e[1]*i[5]+e[2]*i[6],t[2]=e[0]*i[8]+e[1]*i[9]+e[2]*i[10],t[4]=e[4]*i[0]+e[5]*i[1]+e[6]*i[2],t[5]=e[4]*i[4]+e[5]*i[5]+e[6]*i[6],t[6]=e[4]*i[8]+e[5]*i[9]+e[6]*i[10],t[8]=e[8]*i[0]+e[9]*i[1]+e[10]*i[2],t[9]=e[8]*i[4]+e[9]*i[5]+e[10]*i[6],t[10]=e[8]*i[8]+e[9]*i[9]+e[10]*i[10]},o.setProdRotationRotationInverse43=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[1]+e[2]*i[2],t[1]=e[0]*i[4]+e[1]*i[5]+e[2]*i[6],t[2]=e[0]*i[8]+e[1]*i[9]+e[2]*i[10],t[3]=e[4]*i[0]+e[5]*i[1]+e[6]*i[2],t[4]=e[4]*i[4]+e[5]*i[5]+e[6]*i[6],t[5]=e[4]*i[8]+e[5]*i[9]+e[6]*i[10],t[6]=e[8]*i[0]+e[9]*i[1]+e[10]*i[2],t[7]=e[8]*i[4]+e[9]*i[5]+e[10]*i[6],t[8]=e[8]*i[8]+e[9]*i[9]+e[10]*i[10]},o.setScalingToProdScalingScaling4=function(t,e,i){t[0]=e[0]*i[0],t[5]=e[5]*i[5],t[10]=e[10]*i[10]},o.setProdTranslationRotation4=function(t,e,i){t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=0,t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=0,t[12]=i[0]*e[12]+i[4]*e[13]+i[8]*e[14],t[13]=i[1]*e[12]+i[5]*e[13]+i[9]*e[14],t[14]=i[2]*e[12]+i[6]*e[13]+i[10]*e[14],t[15]=1},o.updateProdTranslationRotationInverse4=function(t,e,i){t[0]=i[0],t[1]=i[4],t[2]=i[8],t[4]=i[1],t[5]=i[5],t[6]=i[9],t[8]=i[2],t[9]=i[6],t[10]=i[10],t[12]=i[0]*e[12]+i[1]*e[13]+i[2]*e[14],t[13]=i[4]*e[12]+i[5]*e[13]+i[6]*e[14],t[14]=i[8]*e[12]+i[9]*e[13]+i[10]*e[14]},o.setProdScalingRotation=function(t,e,i){t[0]=e[0]*i[0],t[1]=e[0]*i[1],t[2]=e[0]*i[2],t[3]=0,t[4]=e[5]*i[4],t[5]=e[5]*i[5],t[6]=e[5]*i[6],t[7]=0,t[8]=e[10]*i[8],t[9]=e[10]*i[9],t[10]=e[10]*i[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setModelMatrix=function(t,e,i,s){t[0]=s[0]*i[0],t[1]=s[0]*i[1],t[2]=s[0]*i[2],t[4]=s[5]*i[4],t[5]=s[5]*i[5],t[6]=s[5]*i[6],t[8]=s[10]*i[8],t[9]=s[10]*i[9],t[10]=s[10]*i[10],t[12]=e[12],t[13]=e[13],t[14]=e[14]},o.updateModelMatrixInverse=function(t,e,i,s){t[0]=i[0]*s,t[1]=i[4]*s,t[2]=i[8]*s,t[4]=i[1]*s,t[5]=i[5]*s,t[6]=i[9]*s,t[8]=i[2]*s,t[9]=i[6]*s,t[10]=i[10]*s,t[12]=-t[0]*e[12]-t[4]*e[13]-t[8]*e[14],t[13]=-t[1]*e[12]-t[5]*e[13]-t[9]*e[14],t[14]=-t[2]*e[12]-t[6]*e[13]-t[10]*e[14]},o.setTranslatedByVector=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[0],t[13]=e[13]+i[1],t[14]=e[14]+i[2],t[15]=e[15]},o.setTranslatedByM4=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]},o.setPerspective4=function(t,e,i,s,n){t[0]=s/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(s+n)/(s-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=2*s*n/(s-n),t[15]=0},o.setOrthographic4=function(t,e,i,s,n){t[0]=1/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-2/(n-s),t[11]=0,t[12]=0,t[13]=0,t[14]=-(s+n)/2,t[15]=1},o.correctOrthogonal4=function(t){var i=e.normalize3([t[0],t[1],t[2]]),s=e.normalize3([t[4],t[5],t[6]]),n=e.cross3Aux(i,s);e.setCross3(s,n,i),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=s[0],t[5]=s[1],t[6]=s[2],t[7]=0,t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=0},o.straightenTranslation=function(t,e){t[12]=Math.abs(t[12])<e?0:Math.abs(1-t[12])<e?1:Math.abs(-1-t[12])<e?-1:t[12],t[13]=Math.abs(t[13])<e?0:Math.abs(1-t[13])<e?1:Math.abs(-1-t[13])<e?-1:t[13],t[14]=Math.abs(t[14])<e?0:Math.abs(1-t[14])<e?1:Math.abs(-1-t[14])<e?-1:t[14]},o.straightenRotation4=function(t,e){var i;for(i=0;i<11;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},function(){var t;for(t=0;t<20;t++)a.push(o.identity4());for(t=0;t<20;t++)h.push(o.identity3())}(),o}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,s){"use strict";function n(t){switch(t){case f.NONE:return 0;case f.FLOAT:return 1;case f.VEC2:return 2;case f.VEC3:return 3;case f.VEC4:case f.MAT2:return 4;case f.MAT3:return 9;case f.MAT4:return 16;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:case f.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function o(t){switch(t){case f.NONE:return 0;case f.FLOAT:case f.VEC2:case f.VEC3:case f.VEC4:return 1;case f.MAT2:return 2;case f.MAT3:return 3;case f.MAT4:return 4;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:case f.BOOL:return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+t+"'!"),0}}function r(t){return t===f.SAMPLER2D||t===f.SAMPLER_CUBE}function a(t){return t?1:0}function l(t,e,i){this._name=t,this._image=e,this._mipmap=void 0===i||i,this._ids={},this._locations={}}function h(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function c(t,e,i){this.name=t,this.size=e,this.role=i}function u(t,s,n,o){var a;if(this._name=t,this._type=e.getEnumValue(f,s,{name:"uniform "+this._name+".type",defaultValue:f.NONE}),this._arraySize=n||0,this._unpacked=o,this._unpacked&&(!r(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===f.STRUCT?[]:null,this._locations={},this._numericValues={},this._prefixes=null,this._type===f.STRUCT)if(this._prefixes=[],this._arraySize>0)for(a=0;a<this._arraySize;a++)this._prefixes.push(this._name+"["+a+"].");else this._prefixes.push(this._name+".");switch(this._setConstantValue=null,this._type){case f.FLOAT:this._arraySize>0?this._setConstantValue=this._setFloatArrayValue:this._setConstantValue=this._setFloatValue;break;case f.VEC2:this._setConstantValue=this._setVec2Value;break;case f.VEC3:this._setConstantValue=this._setVec3Value;break;case f.VEC4:this._setConstantValue=this._setVec4Value;break;case f.MAT2:this._setConstantValue=this._setMat2Value;break;case f.MAT3:this._setConstantValue=this._setMat3Value;break;case f.MAT4:this._setConstantValue=this._setMat4Value;break;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:this._arraySize>0?this._unpacked?this._setConstantValue=this._setUnpackedIntArrayValue:this._setConstantValue=this._setIntArrayValue:this._setConstantValue=this._setIntValue;break;case f.BOOL:this._arraySize>0?this._setConstantValue=this._setBoolArrayValue:this._setConstantValue=this._setBoolValue;break;case f.STRUCT:this._arraySize>0?this._setConstantValue=this._setStructArrayValue:this._setConstantValue=this._setStructValue}}function _(t,e,i,s){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(s*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0,this._dirty=!1}function p(t,e,i,s){this._name=t,this._id=null,this._width=e,this._height=i,this._depthOnly=!!s,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function d(t,e,s,n,o,r,a,l){this._name=t,this._blendMode=n,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=s,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._instanceAttributeNames=Object.keys(r),this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._vertexShaderSource?this._fragmentShaderSource?this._parseShaderSources(o,a,l):i.showError("Cannot initialize shader '"+this._name+"': no fragment shader source specified!"):i.showError("Cannot initialize shader '"+this._name+"': no vertex shader source specified!")}function g(t,e,i,n,o,r){s.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=!0===i,this._alpha=void 0===n||n,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._vertexBuffersEnabled=[],this._vertexBuffersUsed=[],this._vertexBuffersInstanced=[],this._frameBuffers={},this._hasBoundFrameBuffer=!1,this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._fragmentShaderHighPrecisionSupport=!1,this._createContext(r),this.setFiltering(o)}var m={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},f={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},S={NONE:"none",MIX:"mix",ADD:"add"},T=null;return Object.freeze(m),Object.freeze(f),l.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},l.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},l.prototype.setMinFiltering=function(t,e,i){if(!1===this._mipmap)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case m.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case m.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case m.ANISOTROPIC:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},l.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},l.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},l.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},l.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},h.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},h.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},h.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},h.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},h.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;i<6;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},h.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},u.prototype.addMember=function(t){this._type===f.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},u.prototype.saveLocation=function(t,e,i,s){s=s||this._name,this._locations[t]||(this._locations[t]={}),this._locations[t][s]=e.getUniformLocation(i.getIDForContext(t),s)},u.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._numericValues={},this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},u.prototype.getLocation=function(t,e,i,s,n){var o=(s||"")+this._name+(n||"");return!s&&!n||this._locations[t]&&void 0!==this._locations[t][o]||this.saveLocation(t,e,i,o),this._locations[t][o]},u.prototype.getArraySize=function(){return this._arraySize},u.prototype.getRawName=function(){var t,e=this._name;return"u_".length>0&&(t=e.split("u_"),e=t[t.length-1]),"".length>0&&(e=e.split("")[0]),e},u.prototype.getTextureType=function(){var t,e;if(this._type!==f.SAMPLER2D)return null;if(t=this.getRawName(),"".length>0){if(e=t.split(""),e.length<2)return null;t=e[e.length-1]}if("Texture".length>0){if(e=t.split("Texture"),e.length<2)return null;t=e[0]}return t},u.prototype.getCubemapName=function(){var t,e;if(this._type!==f.SAMPLER_CUBE)return null;if(t=this.getRawName(),"".length>0){if(e=t.split(""),e.length<2)return null;t=e[e.length-1]}if("Cubemap".length>0){if(e=t.split("Cubemap"),e.length<2)return null;t=e[0]}return t},u.prototype.getUniformName=function(t){return"u_"+t},u.prototype.getTextureUniformRawName=function(t){return t+"Texture"},u.prototype.getCubemapUniformRawName=function(t){return t+"Cubemap"},u.prototype._setFloatArrayValue=function(t,e,i,s,n){e.uniform1fv(this.getLocation(t,e,i,n),s)},u.prototype._setFloatValue=function(t,e,i,s,n){(n||this._numericValues[t]!==s)&&(e.uniform1f(this.getLocation(t,e,i,n),s),this._numericValues[t]=s)},u.prototype._setVec2Value=function(t,e,i,s,n){e.uniform2fv(this.getLocation(t,e,i,n),s)},u.prototype._setVec3Value=function(t,e,i,s,n){e.uniform3fv(this.getLocation(t,e,i,n),s)},u.prototype._setVec4Value=function(t,e,i,s,n){e.uniform4fv(this.getLocation(t,e,i,n),s)},u.prototype._setMat2Value=function(t,e,i,s,n){e.uniformMatrix2fv(this.getLocation(t,e,i,n),!1,s)},
u.prototype._setMat3Value=function(t,e,i,s,n){e.uniformMatrix3fv(this.getLocation(t,e,i,n),!1,s)},u.prototype._setMat4Value=function(t,e,i,s,n){e.uniformMatrix4fv(this.getLocation(t,e,i,n),!1,s)},u.prototype._setUnpackedIntArrayValue=function(t,e,i,s,n){var o;for(o=0;o<s.length;o++)e.uniform1i(this.getLocation(t,e,i,n,o.toString()),s[o])},u.prototype._setIntArrayValue=function(t,e,i,s,n){e.uniform1iv(this.getLocation(t,e,i,n),s)},u.prototype._setIntValue=function(t,e,i,s,n){(n||this._numericValues[t]!==s)&&(e.uniform1i(this.getLocation(t,e,i,n),s),this._numericValues[t]=s)},u.prototype._setBoolArrayValue=function(t,e,i,s,n){e.uniform1iv(this.getLocation(t,e,i,n),s.map(a))},u.prototype._setBoolValue=function(t,e,i,s,n){var o=s?1:0;(n||this._numericValues[t]!==o)&&(e.uniform1i(this.getLocation(t,e,i,n),o),this._numericValues[t]=o)},u.prototype._setStructArrayValue=function(t,e,i,s){var n,o,r,a=this._members.length;for(n=0;n<s.length&&null!==s[n];n++)for(o=0;o<a;o++)void 0!==s[n][this._members[o]._name]&&(r=this._members[o]._name,this._members[o]._setConstantValue(t,e,i,s[n][r],this._prefixes[n]))},u.prototype._setStructValue=function(t,e,i,s){var n,o,r=this._members.length;for(n=0;n<r;n++)void 0!==s[this._members[n]._name]&&(o=this._members[n]._name,this._members[n]._setConstantValue(t,e,i,s[o],this._prefixes[0]))},u.prototype.setValue=function(t,e,i,s,n){this._setConstantValue(t,e,i,s(t),n)},u.prototype.getVectorCount=function(){var t,e;if(this._type===f.STRUCT){for(t=0,e=0;e<this._members.length;e++)t+=this._members[e].getVectorCount();return t*(this._arraySize||1)}return o(this._type)*(this._arraySize||1)},u.prototype.isSamplerType=function(){return r(this._type)},_.prototype.getRole=function(){return this._role},_.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},_.prototype.getSize=function(){return this._data.length/this._vectorSize},_.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},_.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},_.prototype.resetFilledVectors=function(){this._filledVectors=0},_.prototype.freeData=function(){this._data=null},_.prototype.markDirty=function(){this._dirty=!0},_.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},_.prototype.bind=function(t,e,i){void 0!==this._locations[e._name]&&-1!==this._locations[e._name]||(this._locations[e._name]=t.gl.getAttribLocation(e.getIDForContext(t._name),this._name));var s=this._locations[e._name];s>=0&&((t.getBoundVertexBuffer(s)!==this||this._dirty)&&(i?this.loadToGPUMemory(t._name,t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t._name]),t.gl.vertexAttribPointer(s,this._vectorSize,t.gl.FLOAT,!1,0,0),this._dirty=!1),t.setBoundVertexBuffer(s,this,!!i))},_.prototype.delete=function(t){var e,i;t.gl.deleteBuffer(this._ids[t._name]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&t.setBoundVertexBuffer(i,null,!1));delete this._ids[t._name],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},p.prototype.TEXTURE_LOCATION_NOT_SET=-1,p.prototype.getWidth=function(){return this._width},p.prototype.getLastTextureBindLocation=function(){return this._textureLocation},p.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},p.prototype.setup=function(t){var e;if(!this._id)switch(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),this._depthOnly&&t.areDepthTexturesAvailable()?(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.DEPTH_COMPONENT,this._width,this._height,0,t.gl.DEPTH_COMPONENT,t.gl.UNSIGNED_SHORT,null),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.TEXTURE_2D,this._textureID,0)):(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID)),e=t.gl.checkFramebufferStatus(t.gl.FRAMEBUFFER)){case t.gl.FRAMEBUFFER_COMPLETE:break;case t.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case t.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"' ("+e+")!")}},p.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},p.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},p.prototype.delete=function(t){t.gl.deleteTexture(this._textureID),this._depthOnly&&t.areDepthTexturesAvailable()||t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},d.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return!0;return!1},d.prototype._getUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return this._uniforms[e];return null},d.prototype._parseShaderSources=function(e,s,a){var l,h,_,p,d,g,m,S,T,E,y,M,I,C,A,v,N,O,L,R,b={},x={},D=function(t,e){return T.indexOf(e)<0},w=function(t){return""!==t},P=function(t){return"highp"===t||"mediump"===t||"lowp"===t},V=function(e){return t.getSafeEnumValue(f,e,f.NONE)!==f.NONE};for(p=0;p<2;p++){switch(p){case 0:d=this._vertexShaderSource.split("\n");break;case 1:d=this._fragmentShaderSource.split("\n")}for(L=!1,T=[],l=0;l<d.length;l++)if(d[l].length>0)if(g=d[l].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),m=d[l].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===g[0])s&&void 0!==s[g[1]]?(b[g[1]]=s[g[1]],g[2]!==s[g[1]]&&(d[l]=d[l].replace(g[2],s[g[1]]),L=!0)):b[g[1]]=g[2];else if(0===p&&"attribute"===g[0])if(S=P(g[1])?3:2,E=g[S],A=g[S-1],y=n(A),M=e[E],this._numAttributeVectors+=o(A),void 0===M){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(E))return void i.showError("Role for attribute named '"+E+"' not found for shader '"+this._name+"'!");M=this._uniformNamesForInstanceAttributeNames[E],this._instanceAttributes.push(new c(E,y,M))}else this._vertexAttributes.push(new c(E,y,M));else if("uniform"===g[0]){if(S=P(g[1])?3:2,C=g[S],A=g[S-1],!1===this._hasUniform(C)){if("["===m[S]){if(O=!1,N=g[S+1],b[N]&&(N=b[N]),v=parseInt(N,10),r(A)&&a){for(d[l]="",h=0;h<v;h++){for(_=0;_<S;_++)d[l]+=g[_],d[l]+=m[_];d[l]+=C+h.toString()+";\n"}L=!0,O=!0}}else v=0;V(A)?this._uniforms.push(new u(C,A,v,O)):(I=new u(C,"struct",v),function(t,e){var i,s,n,o;for(i=!1,n=0;n<d.length;n++)if(s=d[n].split(" "),i){if(s=s.filter(w),s.length>0&&"}"===s[s.length-1].split(";")[0])break;s.length>=2&&(o=P(s[0])?1:0,t.addMember(new u(s[o+1].split(";")[0],s[o],0)))}else"struct"===s[0]&&s[1].split("{")[0]===e&&(i=!0)}(I,A),this._uniforms.push(I))}switch(p){case 0:this._numVertexUniformVectors+=this._getUniform(C).getVectorCount();break;case 1:this._numFragmentUniformVectors+=this._getUniform(C).getVectorCount(),r(A)&&(this._numTextureUnits+=this._getUniform(C).getVectorCount())}}else if("varying"===g[0])S=P(g[1])?3:2,A=g[S-1],1===p&&("["===m[S]?(N=g[S+1],b[N]&&(N=b[N]),v=parseInt(N,10)):v=1,this._numVaryingVectors+=o(A)*v);else{for(S=0;""===g[S];)S++;if(V(g[S])||P(g[S]))S=P(g[S])?S+2:S+1,"["===m[S]&&(N=g[S+1],b[N]&&(N=b[N]),x[g[S]]=parseInt(N,10));else{for(h=0;h<this._uniforms.length;h++)if((S=g.indexOf(this._uniforms[h]._name))>=0&&this._uniforms[h].getArraySize()>0&&"["===m[S]){if(parseInt(g[S+1],10).toString()===g[S+1]&&parseInt(g[S+1],10)>=this._uniforms[h].getArraySize()){d[l]="",T.push(l),L=!0;break}if(this._uniforms[h].isSamplerType()&&a){for(d[l]="",_=0;_<S;_++)d[l]+=g[_],d[l]+=m[_];for(d[l]+=g[S]+g[S+1],_=S+2;_<m.length;_++)d[l]+=g[_],d[l]+=m[_];d[l]+=g[g.length-1],L=!0;break}}for(R=Object.keys(x),h=0;h<R.length;h++)if((S=g.indexOf(R[h]))>=0&&"["===m[S]&&parseInt(g[S+1],10).toString()===g[S+1]&&parseInt(g[S+1],10)>=x[g[S]]){d[l]="",T.push(l),L=!0;break}}}if(L)switch(d=d.filter(D),p){case 0:this._vertexShaderSource=d.join("\n");break;case 1:this._fragmentShaderSource=d.join("\n")}}},d.prototype.getIDForContext=function(t){return this._ids[t]},d.prototype.getVertexAttributes=function(){return this._vertexAttributes},d.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},d.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},d.prototype.setupGLProgram=function(t,e){var s,n,o,r,a;if(!this._vertexShaderSource||!this._fragmentShaderSource)return void(this._ids[t]=null);if(s=e.createShader(e.VERTEX_SHADER),e.shaderSource(s,this._vertexShaderSource),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))return n=e.getShaderInfoLog(s),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(o=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(o,this._fragmentShaderSource),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return n=e.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),r=this._ids[t],e.attachShader(r,s),e.attachShader(r,o),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))return n=e.getProgramInfoLog(r),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+n,e),e.deleteProgram(r),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},d.prototype.assignUniforms=function(t,e){var i;if(e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i]._name]&&this._uniforms[i].setValue(t._name,t.gl,this,e[this._uniforms[i]._name])},d.prototype.bindVertexBuffers=function(t){var e;for(t.clearVertexBufferUsage(),e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this);t.disableUnusedVertexBuffers()},d.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return this._uniforms[e].getArraySize();return 0},d.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)(e=this._uniforms[t].getTextureType())&&i.push(e);return i},d.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)(e=this._uniforms[t].getCubemapName())&&i.push(e);return i},d.prototype.createInstanceBuffers=function(t,e){var i,s;for(this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1))),i=0;i<this._instanceAttributeNames.length;i++)s=this._instanceAttributeNames[i],this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][s]?(this._instanceAttributeBuffers[t][s].resize(e),this._instanceAttributeBuffers[t][s].resetFilledVectors(),this._instanceAttributeBuffers[t][s].markDirty()):this._instanceAttributeBuffers[t][s]=new _(s,this._uniformNamesForInstanceAttributeNames[s],this.getInstanceAttribute(s).size,e)},d.prototype.addDataToInstanceBuffers=function(e,i){var s,n,o;for(s=0;s<this._instanceAttributeNames.length;s++)n=this._instanceAttributeNames[s],o=this._instanceAttributeBuffers[e][n].getRole(),this._instanceAttributeBuffers[e][n].addVector(i[o](t.EMPTY_STRING))},d.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]].bind(t,this,!0)},d.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]].delete(t);this._instanceAttributeBuffers=[]},d.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},d.prototype.isAllowedByRequirements=function(t){return this._numAttributeVectors<=t.requiredAttributeVectors&&this._numVertexUniformVectors<=t.requiredVertexUniformVectors&&this._numVaryingVectors<=t.requiredVaryingVectors&&this._numTextureUnits<=t.requiredTextureUnits&&this._numFragmentUniformVectors<=t.requiredFragmentUniformVectors},g.prototype=new s.AsyncResource,g.prototype.constructor=g,g.prototype._createContext=function(t){var e,s;s={alpha:this._alpha,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",s)}catch(t){}if(!this.gl){s.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",s)}catch(t){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}e=this.gl,this._antialiasing&&!e.getContextAttributes().antialias&&(t||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",e),this._antialiasing=!1),this._maxBoundTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),this._fragmentShaderHighPrecisionSupport=!!e.getShaderPrecisionFormat&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0,i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=e.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=e.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=e.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),e.clearDepth(1),e.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],e.depthMask(!0),this._currentDepthMask=!0,e.enable(e.BLEND),this._blendingEnabled=!0,e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW)},g.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize+"\nFragment shader high precision float support: "+(this._fragmentShaderHighPrecisionSupport?"yes":"no"):"N/A"},g.prototype.isAntialiased=function(){return this._antialiasing},g.prototype.getFiltering=function(){return this._filtering},g.prototype.setFiltering=function(e){var i;if((e=t.getSafeEnumValue(m,e,this._filtering))!==this._filtering)for(this._filtering=e,this._filtering===m.ANISOTROPIC&&(this.anisotropicFilterExt||(this._filtering=m.TRILINEAR)),i=0;i<this._textures.length;i++)this._textures[i].setMinFiltering&&(this.bindTexture(this._textures[i],void 0,void 0,!0),this._textures[i].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},g.prototype.isInstancingAvailable=function(){return!!this.instancingExt},g.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},g.prototype.setColorMask=function(t){this._currentColorMask[0]===t[0]&&this._currentColorMask[1]===t[1]&&this._currentColorMask[2]===t[2]&&this._currentColorMask[3]===t[3]||(this.gl.colorMask(t[0],t[1],t[2],t[3]),this._currentColorMask=t)},g.prototype.setDepthMask=function(t){this._currentDepthMask!==t&&(this.gl.depthMask(t),this._currentDepthMask=t)},g.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},g.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},g.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},g.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},g.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},g.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t._name]&&(this._vertexBuffers[t._name]=t)},g.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},g.prototype.setBoundVertexBuffer=function(t,e,i){this._boundVertexBuffers[t]=e,this._vertexBuffersUsed[t]=!!e,e?(this._vertexBuffersEnabled[t]||(this.gl.enableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!0),this.instancingExt&&i!==this._vertexBuffersInstanced[t]&&(this.instancingExt.vertexAttribDivisorANGLE(t,i?1:0),this._vertexBuffersInstanced[t]=i)):this._vertexBuffersEnabled[t]&&(this.gl.disableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!1)},g.prototype.clearVertexBufferUsage=function(){var t;for(t=0;t<this._vertexBuffersUsed.length;t++)this._vertexBuffersUsed[t]=!1},g.prototype.disableUnusedVertexBuffers=function(){var t;for(t=0;t<this._vertexBuffersEnabled.length;t++)this._vertexBuffersEnabled[t]&&!this._vertexBuffersUsed[t]&&(this.gl.disableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!1)},g.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},g.prototype.setupVertexBuffers=function(){var t,e,i,s,n,o;if(!0!==this._readyToUse){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].delete(this);for(s=0,t=0;t<this._models.length;t++)s+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(n=this._shaders[t].getVertexAttributes(),e=0;e<n.length;e++)this.addVertexBuffer(new _(n[e].name,n[e].role,n[e].size,s));for(o=0,t=0;t<this._models.length;t++)for(e=this._models[t]._minLOD;e<=this._models[t].getMaxLOD();e++)o+=this._models[t].loadToVertexBuffers(this,o,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},g.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},g.prototype.addFrameBuffer=function(t,e){(void 0===this._frameBuffers[t._name]||e)&&(this._frameBuffers[t._name]=t,this._readyToUse&&this._frameBuffers[t._name].setup(this))},g.prototype.setupFrameBuffers=function(){var t;if(!this._readyToUse)for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},g.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].delete(this);this._frameBuffers={}},g.prototype.setup=function(){this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},g.prototype.clear=function(){var t;for(this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBuffers.length=0,this._vertexBuffersUsed.length=0,this._vertexBuffersEnabled.length=0,this._vertexBuffersInstanced.length=0},g.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},g.prototype.setCurrentFrameBuffer=function(t){t?(this._frameBuffers[t].bind(this),this._hasBoundFrameBuffer=!0):this._hasBoundFrameBuffer&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this._hasBoundFrameBuffer=!1)},g.prototype.getCurrentShader=function(){return this._currentShader},g.prototype.setCurrentShader=function(t){var e,i;if(this._currentShader!==t){if(i=t.getIDForContext(this._name)){switch(this.gl.useProgram(i),e=t._blendMode){case S.MIX:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=e);break;case S.ADD:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=e)}return t.bindVertexBuffers(this),this._currentShader=t,!0}this._currentShader=null}return!1},g.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.bindTexture=function(t,e,s,n){var o=void 0!==e||s;if(void 0===e&&(void 0===(e=t.getLastTextureBindLocation(this._name))||e===p.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[e]&&this._boundTextures[e].texture===t&&!n||(t instanceof l?t.bindGLTexture(this._name,this.gl,e):t instanceof h?t.bindGLTexture(this._name,this.gl,e):t instanceof p?t.bindGLTexture(this.gl,e):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:o}),this._boundTextures[e].reserved!==o&&(this._boundTextures[e].reserved=o),e},g.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},g.prototype.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},g.prototype.satisfiesRequirements=function(t){return this._maxVertexAttributes>=t.requiredAttributeVectors&&this._maxVertexShaderUniforms>=t.requiredVertexUniformVectors&&this._maxVaryings>=t.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=t.requiredFragmentUniformVectors&&this._maxBoundTextures>=t.requiredTextureUnits&&(!t.fragmentShaderHighPrecision||this._fragmentShaderHighPrecisionSupport)},g.prototype.getMaxTextureSize=function(){return this._maxTextureSize},g.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},g.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(t,e,s){i.showError(t,e,(s?s+"\n\n":"")+"This is a graphics related error.\nInformation about your graphics support:\n"+T.getInfoString())},T=new g("",document.createElement("canvas"),!0,!0,m.BILINEAR,!0),{TextureFiltering:m,ShaderVariableType:f,ShaderBlendMode:S,getUniformName:u.prototype.getUniformName,getTextureUniformRawName:u.prototype.getTextureUniformRawName,getCubemapUniformRawName:u.prototype.getCubemapUniformRawName,ManagedTexture:l,ManagedCubemap:h,ManagedShader:d,FrameBuffer:p,ManagedGLContext:g,requirementsAreSatisfied:T.satisfiesRequirements.bind(T),getMaxTextureSize:T.getMaxTextureSize.bind(T),getMaxCubemapSize:T.getMaxCubemapSize.bind(T),getMaxRenderbufferSize:T.getMaxRenderbufferSize.bind(T),isAntialiasingAvailable:T.isAntialiased.bind(T),isAnisotropicFilteringAvailable:T.isAnisotropicFilteringAvailable.bind(T),isInstancingAvailable:T.isInstancingAvailable.bind(T),areDepthTexturesAvailable:T.areDepthTexturesAvailable.bind(T)}}),define("modules/scene/lights",["utils/vectors","utils/matrices","modules/managed-gl"],function(t,e,i){"use strict";function s(t,e){h=t,c=e}function n(s,n){this._color=s,this._direction=t.normal3(n),this.oM=e.inverseOfRotation4(e.lookTowards4Aux(this._direction)),this._baseMatrix=e.identity4(),this._baseMatrixValid=!1,this._near=0,this._far=0,this._lispMatrix=e.copy([1,0,0,0,0,1,0,-1,0,0,1,0,0,0,0,0]),this._shadowMapBufferNamePrefix=null,this._uniformValueFunctions={},this._uniformData={color:this._color,direction:[this._direction[0],this._direction[1],this._direction[2],1],matrix:this._baseMatrix},this._shadowMapParams=[0,0,1],this._uniformValueFunctions[i.getUniformName(a)]=function(){return this._baseMatrix}.bind(this),this._uniformValueFunctions[i.getUniformName(l)]=function(){return this._shadowMapParams}.bind(this)}function o(t,e,i,s,n,o){this._objectIntensity=e,this._relativePositionVector=i,this._hasRelativePosition=i&&(0!==i[0]||0!==i[1]||0!==i[2]),this._emittingObjects=s,this._singleEmittingObject=!!s&&1===s.length,this._positionVector=[0,0,0],this._states=n,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=o,this._uniformColor=[t[0],t[1],t[2],e*(s?s.length:1)],this._uniformData={color:this._uniformColor,position:this._positionVector}}function r(t,e,i,s,n,o,r){this._visible=!0,this._uniformColor=[t[0],t[1],t[2],e],this._relativePositionVector=i,this._positionVector=[0,0,0,o<n?Math.cos(Math.radians(o)):0],this._relativeSpotDirection=s,this._emittingObject=r,this._uniformData={color:this._uniformColor,position:this._positionVector,spot:[0,0,0,Math.cos(Math.radians(n))]}}var a="lightMatrix",l="shadowMapParams",h=10,c=100;return n.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},n.prototype.addToContext=function(t,e,s,n,o){var r,a,l;if(this._shadowMapBufferNamePrefix=s,e)for(r=0;r<n;r++)a=this.getShadowMapBufferName(r),l=t.getFrameBuffer(a),t.addFrameBuffer(new i.FrameBuffer(a,o,o,!0),l&&l.getWidth()!==o)},n.prototype.reset=function(){this._baseMatrixValid=!1},n.prototype._updateLiSPMatrix=function(){var t=this._shadowMapParams[0],e=this._shadowMapParams[1];this._near=(c+t)*this._shadowMapParams[2]+h,this._far=2*t+this._near,this._lispMatrix[0]=this._far/t,this._lispMatrix[5]=(this._far+this._near)/(this._far-this._near),this._lispMatrix[10]=this._far/e,this._lispMatrix[13]=2*this._far*this._near/(this._far-this._near)},n.prototype.isInsideCurrentMap=function(e,i){var s,n,o,r,a,l,h,c=this._shadowMapParams[0],u=this._shadowMapParams[2];return i*=.5,s=t.prodTranslationModel3Aux(e,this._baseMatrix),s[1]-=u*c+this._near,s[2]=-s[2]+u*c,n=s[0]*this._lispMatrix[0],o=(s[1]+i)*this._lispMatrix[5]+this._lispMatrix[13],r=(s[1]-i)*this._lispMatrix[5]+this._lispMatrix[13],a=s[2]*this._lispMatrix[10],l=-s[1],h=Math.max(l,0),Math.abs(n)-i*this._lispMatrix[0]<h&&(o>0||o>-(l-i))&&(r<0||r<l+i)&&Math.abs(a)-i*this._lispMatrix[10]<h},n.prototype.startShadowMap=function(i,s,n,o,r){var a,l;i.setCurrentFrameBuffer(this.getShadowMapBufferName(n)),a=t.getRowC43Aux(s.getCameraOrientationMatrix()),l=Math.abs(t.dot3(a,this._direction)),this._shadowMapParams[0]=o,this._shadowMapParams[1]=r,this._shadowMapParams[2]=l,this._baseMatrixValid||(e.setInverseOfRotation4(this.oM,e.lookTowards4Aux(this._direction,a)),e.setProdTranslationRotation4(this._baseMatrix,s.getInversePositionMatrix(),this.oM),this._baseMatrixValid=!0),this._uniformData.direction[3]=l,this._updateLiSPMatrix(),i.getCurrentShader().assignUniforms(i,this._uniformValueFunctions)},o.prototype.isVisible=function(){var t;if(this._singleEmittingObject)return this._emittingObjects[0].isVisible();for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused()&&this._emittingObjects[t].isVisible())return!0;return!1},o.prototype.updateState=function(e){var i,s;if(this._states&&e>0){for(this._timeSinceLastTransition+=e,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping){i=this._states.length-1,
this._timeSinceLastTransition=this._states[i].timeToReach;break}this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,this._objectIntensity=this._states[this._currentStateIndex].intensity*(1-s)+this._states[i].intensity*s,this.setColor(t.sum3Aux(t.scaled3Aux(this._states[this._currentStateIndex].color,1-s),t.scaled3Aux(this._states[i].color,s)))}},o.prototype.update=function(i){var s,n;if(this.updateState(i),this._singleEmittingObject)this._uniformColor[3]=this._objectIntensity,this._emittingObjects[0].copyPositionToVector(this._positionVector),this._hasRelativePosition&&t.add3(this._positionVector,t.prodVec3Mat4Aux(this._relativePositionVector,e.prod3x3SubOf4Aux(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0].oM)));else{for(t.setNull3(this._positionVector),n=0,s=0;s<this._emittingObjects.length;s++)this._emittingObjects[s]&&!this._emittingObjects[s].canBeReused()&&this._emittingObjects[s].isVisible()&&(this._emittingObjects[s].addPositionToVector(this._positionVector),n++);n>1&&(this._positionVector[0]/=n,this._positionVector[1]/=n,this._positionVector[2]/=n),this._uniformColor[3]=this._objectIntensity*n}},o.prototype.canBeReused=function(){var t;if(this._singleEmittingObject)return this._emittingObjects[0].canBeReused();for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},o.prototype.setColor=function(t){this._uniformColor[0]=t[0],this._uniformColor[1]=t[1],this._uniformColor[2]=t[2]},o.prototype.addEmittingObject=function(t){this._emittingObjects.push(t),this._singleEmittingObject=1===this._emittingObjects.length},o.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._uniformColor[3]>0&&this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._uniformColor[3]},o.prototype.setAnimationTime=function(t){this._timeSinceLastTransition=0,this._currentStateIndex=0,this.updateState(t)},r.prototype.isVisible=function(){return this._visible&&this._emittingObject.isVisible()},r.prototype.update=function(){this._emittingObject.copyPositionToVector(this._positionVector),t.add3(this._positionVector,t.prodVec3Mat4Aux(this._relativePositionVector,e.prod3x3SubOf4Aux(this._emittingObject.getCascadeScalingMatrix(),this._emittingObject.oM))),t.setProdVec3Mat4(this._uniformData.spot,this._relativeSpotDirection,this._emittingObject.oM)},r.prototype.canBeReused=function(){return this._emittingObject.canBeReused()},r.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._uniformColor[3]},r.prototype.hide=function(){this._visible=!1},r.prototype.show=function(){this._visible=!0},{setupLiSPSM:s,DirectionalLightSource:n,PointLightSource:o,SpotLightSource:r}}),define("armada/constants",[],function(){"use strict";return{GAME_NAME:"Interstellar Armada",LOCAL_STORAGE_PREFIX:"armada_",LANGUAGE_LOCAL_STORAGE_ID:"armada_language",VERSION_LOCAL_STORAGE_ID:"armada_version"}}),define("modules/resource-manager",["utils/utils","modules/application","modules/async-resource"],function(t,e,i){"use strict";function s(t){i.AsyncResource.call(this),this._name=t,this._requested=!1,this._loading=!1,this._hasError=!1,this._requestParams={}}function n(t,i,n){s.call(this,t?t.name||n&&(t&&t.source||a)||e.showError("Cannot initialize instance of "+this.constructor.name+": a name is required!"):null),this._source=t?t.source||null:null,this._sourceFolder=i,this._dataJSON=t,t&&(this._source||(this._loadData(t),this.setToReady()))}function o(t){i.AsyncResource.call(this),this._resourceType=t,this._resources={},this._resourceNames=[],this._numLoadedResources=0,this._numRequestedResources=0}function r(){i.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._resourceClasses=null,this._sourceFolder=null}var a="unnamed";return s.prototype=new i.AsyncResource,s.prototype.constructor=s,s.prototype.isRequested=function(e){if(!this._requested)return!1;if(e){if(!this._requestParams)return!1;if(!t.equivalent(this._requestParams,e))return!1}return!0},s.prototype.request=function(i){this._loading&&!t.equivalent(this._requestParams||null,i||null)?e.showError("Attempting to request resource '"+this._name+"' with different parameters while it is being loaded!"):(this._requested=!0,this._requestParams=i)},s.prototype.requiresReload=function(){e.showError("Resource class does not implement requiresReload!")},s.prototype.isLoaded=function(){return this._readyToUse},s.prototype.hasError=function(){return this._hasError},s.prototype._requestFiles=function(){e.showError("Attempting to request files for a resource type that has no file request function implemented!")},s.prototype._loadData=function(){return e.showError("Attempting to load data for a resource type that has no data loading function implemented!"),!1},s.prototype.onFinalLoad=function(){this._requested=!1,this._loading=!1,this.setToReady()},s.prototype._onFilesLoad=function(t,e){this._hasError=this._hasError||!this._loadData(e),!0===t&&this.onFinalLoad()},s.prototype.requestLoadFromFile=function(){!1===this._readyToUse&&!0===this._requested&&!1===this._loading&&(this._loading=!0,this._requestFiles(this._requestParams))},s.prototype.getData=function(){return null},n.prototype=new s,n.prototype.constructor=n,n.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},n.prototype._requestFiles=function(){e.requestTextFile(this._sourceFolder,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},n.prototype._loadData=function(t){return this._source=this._source||"",this._dataJSON=t,!0},n.prototype.getData=function(){return this._dataJSON},n.prototype.reloadData=function(){this._loadData(this._dataJSON)},o.prototype=new i.AsyncResource,o.prototype.constructor=o,o.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},o.prototype.addResource=function(t,i){var s=t._name;return this._resources[s]?e.showError("Attempting to add a resource named '"+s+"' that already exists! Data will be overwritten."):i||this._resourceNames.push(s),this._resources[s]=t,this._resources[s]},o.prototype.getResource=function(t,i){var s;return this._resources[t]?(s=this._resources[t],i&&i.doNotLoad||s.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),s.resetReadyState(),s.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),s):(i&&!0===i.allowNullResult||e.showError("Requested a resource named '"+t+"' from "+this._resourceType+", which does not exist."),null)},o.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},o.prototype.getResourceNames=function(t){return t?Object.keys(this._resources):this._resourceNames},o.prototype.renameResource=function(t,e){t!==e&&(this._resources[e]=this._resources[t],delete this._resources[t],this._resourceNames[this._resourceNames.indexOf(t)]=e)},o.prototype.moveResourceAfter=function(t,e){this._resourceNames.splice(this._resourceNames.indexOf(t),1),this._resourceNames.splice(this._resourceNames.indexOf(e)+1,0,t)},r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.setToReady=function(){this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0,i.AsyncResource.prototype.setToReady.call(this)},r.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},r.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},r.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},r.prototype.addResource=function(t,e,i){return this._resourceHolders[t]=this._resourceHolders[t]||new o(t),this._resourceHolders[t].addResource(e,i)},r.prototype.createResource=function(t,i){return this._resourceClasses?this._resourceClasses[t]?void this.addResource(t,new this._resourceClasses[t](i,this._sourceFolder)):void e.showError("Cannot create resource of type '"+t+"': no resource constructor was assigned for this resource type!"):void e.showError("Cannot create resource of type '"+t+"': no resource constructors were assigned!")},r.prototype._onResourceLoad=function(t,e){var i,s;for(s=this._onResourceLoadFunctionQueue,i=0;i<s.length;i++)s[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(s=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<s.length;i++)s[i]();this.allResourcesAreLoaded()&&this.setToReady()},r.prototype.getResource=function(t,i,s){var n;return(n=this._resourceHolders[t]?this._resourceHolders[t].getResource(i,s):null)?(s&&s.doNotLoad||n.requiresReload(s)&&(this._numRequestedResources++,this.resetReadyState(),n.request(s),n.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(t,i)}.bind(this))),n):(s&&!0===s.allowNullResult||e.showError("Requested a resource named '"+i+"' of type '"+t+"', which does not exist."),null)},r.prototype.requestAllResources=function(t){var e,i,s;for(e in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(e))for(i=this._resourceHolders[e].getResourceNames(t),s=0;s<i.length;s++)this.getResource(e,i[s])},r.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t]._readyToUse},r.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},r.prototype.requestConfigLoad=function(t,i,s,n){e.requestTextFile(i,t,function(t){this._loadConfigFromJSON(JSON.parse(t),s),n&&n()}.bind(this))},r.prototype._loadConfigFromJSON=function(t,e){var i,s,n;this._resourceClasses=e,this._sourceFolder=t.config?t.config.sourceFolder:null;for(i in e)if(e.hasOwnProperty(i))for(s=t[i],n=0;n<s.length;n++)this.addResource(i,new e[i](s[n],this._sourceFolder))},r.prototype.requestResourceLoad=function(){var t;if(!0===this.allResourcesAreLoaded())this.executeOnReadyQueue();else for(t in this._resourceHolders)this._resourceHolders.hasOwnProperty(t)&&this._resourceHolders[t].requestResourceLoad()},r.prototype.getResourceTypes=function(){return Object.keys(this._resourceHolders)},r.prototype.getResourceNames=function(t){return this._resourceHolders[t]?this._resourceHolders[t].getResourceNames():(e.showError("Asked for the names of resources of type: '"+t+"', but no such resource type exists!"),null)},r.prototype.renameResource=function(t,e,i){this._resourceHolders[t].renameResource(e,i)},r.prototype.moveResourceAfter=function(t,e,i){this._resourceHolders[t].moveResourceAfter(e,i)},r.prototype.executeForAllResourcesOfType=function(t,e,i,s){var n,o;for(o=this._resourceHolders[t].getResourceNames(i),n=0;n<o.length;n++)e(this._resourceHolders[t].getResource(o[n],{doNotLoad:s}),t)},r.prototype.executeForAllResources=function(t,e){var i,s=Object.keys(this._resourceHolders);for(i=0;i<s.length;i++)this.executeForAllResourcesOfType(s[i],t,e)},{GenericResource:s,JSONResource:n,ResourceManager:r}}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function i(t,e,i){this.x=t,this.y=e,this.z=i}function s(t,e,i){this.a=t,this.b=e,this.transformGroupIndex=i||0}function n(e,i,s,n,o,r,a,l){this._mesh=e,this.a=i,this.b=s,this.c=n,this.color=o,this.texCoords=r,this.normals=a||t.normalize3(t.cross3(this._mesh.getVector(i,s),this._mesh.getVector(i,n))),this.groupIndices=l||[0,0]}function o(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function r(){this._vertices=[],this._lines=[],this._linesByVertices=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new i(0,0,0)}function a(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function l(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={},this._position4=!1}var h={POSITION:"position",POSITION4:"position4",TEXTURE_COORDINATES:"texCoord",NORMAL:"normal",COLOR:"color",GROUP_INDICES:"groupIndices",TRIANGLE_INDEX:"triangleIndex"},c=[[0,0],[1,1]],u=["3.6"];return Object.freeze(h),n.prototype.getNormal=function(t){return this.normals[t]||this.normals[0]},r.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},r.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},r.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},r.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},r.prototype.setVertex=function(e,i){var s,n;if(this._vertices.length<e)for(s=this._vertices.length;s<e;s++)this._vertices[s]=this._nullVertex;this._vertices[e]=i,n=t.length3([this._vertices[e].x,this._vertices[e].y,this._vertices[e].z]),2*n>this._size&&(this._size=2*n),this._vertices[e].x>this._maxX&&(this._maxX=this._vertices[e].x),this._vertices[e].x<this._minX&&(this._minX=this._vertices[e].x),this._vertices[e].y>this._maxY&&(this._maxY=this._vertices[e].y),this._vertices[e].y<this._minY&&(this._minY=this._vertices[e].y),this._vertices[e].z>this._maxZ&&(this._maxZ=this._vertices[e].z),this._vertices[e].z<this._minZ&&(this._minZ=this._vertices[e].z)},r.prototype.appendVertex=function(t){this.setVertex(this._vertices.length,new i(t[0],t[1],t[2]))},r.prototype.setupLinesByVertices=function(){var t,e=this._vertices.length-1;for(this._linesByVertices.length=e,t=0;t<e;t++)this._linesByVertices[t]=[]},r.prototype.markLineByVertex=function(t,e,i){var s=Math.min(t,e),n=Math.max(t,e);this._linesByVertices[s].indexOf(n)%2&&this._linesByVertices[s].push(n,i)},r.prototype.addLinesByVertices=function(){var t,e,i,n=this._linesByVertices.length;for(t=0;t<n;t++)for(i=this._linesByVertices[t],e=0;e<i.length;e+=2)this.addLine(new s(t,i[e],i[e+1]));this._linesByVertices=null},r.prototype.resetLines=function(){this._lines=[]},r.prototype.addLine=function(t){this._lines.push(t)},r.prototype.setLine=function(t,e){this._lines[t]=e},r.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},r.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},r.prototype.addTriangle=function(t){this._triangles.push(t),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},r.prototype.addTriangleWithParams=function(t,e,i,s){var o,r,a,l,h;return o=s.color||[1,1,1,1],r=s.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],a=s.normals,l=s.groupIndices||this._currentGroupIndices,h=new n(this,t,e,i,o,r,a,l),this.addTriangle(h),h},r.prototype.addQuad=function(t,e,i,s,n){var o,r;n=n||{},o=Object.create(n),o.texCoords=n.texCoords?[n.texCoords[0],n.texCoords[1],n.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],o.normals=n.normals?4===n.normals.length?[n.normals[0],n.normals[1],n.normals[2]]:n.normals:null,this.addTriangleWithParams(t,e,i,o),r=Object.create(n),r.texCoords=n.texCoords?[n.texCoords[2],n.texCoords[3],n.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],r.normals=n.normals?4===n.normals.length?[n.normals[2],n.normals[3],n.normals[0]]:n.normals:null,this.addTriangleWithParams(i,s,t,r)},r.prototype.getSize=function(){return this._size},r.prototype.getMaxX=function(){return this._maxX},r.prototype.getMinX=function(){return this._minX},r.prototype.getMaxY=function(){return this._maxY},r.prototype.getMinY=function(){return this._minY},r.prototype.getMaxZ=function(){return this._maxZ},r.prototype.getMinZ=function(){return this._minZ},r.prototype.getWidth=function(){return this._maxX-this._minX},r.prototype.getHeight=function(){return this._maxY-this._minY},r.prototype.getDepth=function(){return this._maxZ-this._minZ},r.prototype.getBufferData=function(t,e,i){var s,n,o,r,a,l,c,u,_,p,d,g,m;if(e=e||0,!0===t){if(o=this._lines.length,i)for(c=new Float32Array(8*o),s=0;s<o;s++)c[8*s]=this._vertices[this._lines[s].a].x,c[8*s+1]=this._vertices[this._lines[s].a].y,c[8*s+2]=this._vertices[this._lines[s].a].z,c[8*s+3]=0,c[8*s+4]=this._vertices[this._lines[s].b].x,c[8*s+5]=this._vertices[this._lines[s].b].y,c[8*s+6]=this._vertices[this._lines[s].b].z,c[8*s+7]=1;else for(c=new Float32Array(6*o),s=0;s<o;s++)c[6*s]=this._vertices[this._lines[s].a].x,c[6*s+1]=this._vertices[this._lines[s].a].y,c[6*s+2]=this._vertices[this._lines[s].a].z,c[6*s+3]=this._vertices[this._lines[s].b].x,c[6*s+4]=this._vertices[this._lines[s].b].y,c[6*s+5]=this._vertices[this._lines[s].b].z;for(u=new Float32Array(4*o),s=0;s<o;s++)u[4*s]=0,u[4*s+1]=1,u[4*s+2]=1,u[4*s+3]=1;for(_=new Float32Array(6*o),s=0;s<o;s++)_[6*s]=0,_[6*s+1]=0,_[6*s+2]=1,_[6*s+3]=0,_[6*s+4]=0,_[6*s+5]=1;for(p=new Float32Array(8*o),s=0;s<o;s++)p[8*s]=1,p[8*s+1]=1,p[8*s+2]=1,p[8*s+3]=1,p[8*s+4]=1,p[8*s+5]=1,p[8*s+6]=1,p[8*s+7]=1;for(d=new Float32Array(4*o),s=0;s<o;s++)d[4*s]=this._lines[s].transformGroupIndex,d[4*s+1]=0,d[4*s+2]=this._lines[s].transformGroupIndex,d[4*s+3]=0;for(r=this._triangles.length,g=new Float32Array(3*r),s=0;s<r;s++)g[12*s]=0,g[12*s+1]=0,g[12*s+2]=0,g[12*s+3]=0,g[12*s+4]=0,g[12*s+5]=0,g[12*s+6]=0,g[12*s+7]=0,g[12*s+8]=0,g[12*s+9]=0,g[12*s+10]=0,g[12*s+11]=0}else{if(r=this._triangles.length,i)for(c=new Float32Array(12*r),s=0;s<r;s++)c[12*s]=this._vertices[this._triangles[s].a].x,c[12*s+1]=this._vertices[this._triangles[s].a].y,c[12*s+2]=this._vertices[this._triangles[s].a].z,c[12*s+3]=0,c[12*s+4]=this._vertices[this._triangles[s].b].x,c[12*s+5]=this._vertices[this._triangles[s].b].y,c[12*s+6]=this._vertices[this._triangles[s].b].z,c[12*s+7]=1,c[12*s+8]=this._vertices[this._triangles[s].c].x,c[12*s+9]=this._vertices[this._triangles[s].c].y,c[12*s+10]=this._vertices[this._triangles[s].c].z,c[12*s+11]=2;else for(c=new Float32Array(9*r),s=0;s<r;s++)c[9*s]=this._vertices[this._triangles[s].a].x,c[9*s+1]=this._vertices[this._triangles[s].a].y,c[9*s+2]=this._vertices[this._triangles[s].a].z,c[9*s+3]=this._vertices[this._triangles[s].b].x,c[9*s+4]=this._vertices[this._triangles[s].b].y,c[9*s+5]=this._vertices[this._triangles[s].b].z,c[9*s+6]=this._vertices[this._triangles[s].c].x,c[9*s+7]=this._vertices[this._triangles[s].c].y,c[9*s+8]=this._vertices[this._triangles[s].c].z;for(u=new Float32Array(6*r),s=0;s<r;s++)u[6*s]=this._triangles[s].texCoords[0][0],u[6*s+1]=this._triangles[s].texCoords[0][1],u[6*s+2]=this._triangles[s].texCoords[1][0],u[6*s+3]=this._triangles[s].texCoords[1][1],u[6*s+4]=this._triangles[s].texCoords[2][0],u[6*s+5]=this._triangles[s].texCoords[2][1];for(_=new Float32Array(9*r),s=0;s<r;s++)_[9*s]=this._triangles[s].getNormal(0)[0],_[9*s+1]=this._triangles[s].getNormal(0)[1],_[9*s+2]=this._triangles[s].getNormal(0)[2],_[9*s+3]=this._triangles[s].getNormal(1)[0],_[9*s+4]=this._triangles[s].getNormal(1)[1],_[9*s+5]=this._triangles[s].getNormal(1)[2],_[9*s+6]=this._triangles[s].getNormal(2)[0],_[9*s+7]=this._triangles[s].getNormal(2)[1],_[9*s+8]=this._triangles[s].getNormal(2)[2];for(p=new Float32Array(12*r),s=0;s<r;s++)p[12*s]=this._triangles[s].color[0],p[12*s+1]=this._triangles[s].color[1],p[12*s+2]=this._triangles[s].color[2],p[12*s+3]=this._triangles[s].color[3],p[12*s+4]=this._triangles[s].color[0],p[12*s+5]=this._triangles[s].color[1],p[12*s+6]=this._triangles[s].color[2],p[12*s+7]=this._triangles[s].color[3],p[12*s+8]=this._triangles[s].color[0],p[12*s+9]=this._triangles[s].color[1],p[12*s+10]=this._triangles[s].color[2],p[12*s+11]=this._triangles[s].color[3];for(d=new Float32Array(6*r),s=0;s<r;s++)d[6*s]=this._triangles[s].groupIndices[0],d[6*s+1]=this._triangles[s].groupIndices[1],d[6*s+2]=this._triangles[s].groupIndices[0],d[6*s+3]=this._triangles[s].groupIndices[1],d[6*s+4]=this._triangles[s].groupIndices[0],d[6*s+5]=this._triangles[s].groupIndices[1];for(g=new Float32Array(12*r),s=0;s<r;s++){for(a=e+s,l=[],n=0;n<4;n++)l[n]=a%256/255,a=Math.floor(a/256);g[12*s]=l[0],g[12*s+1]=l[1],g[12*s+2]=l[2],g[12*s+3]=l[3],g[12*s+4]=l[0],g[12*s+5]=l[1],g[12*s+6]=l[2],g[12*s+7]=l[3],g[12*s+8]=l[0],g[12*s+9]=l[1],g[12*s+10]=l[2],g[12*s+11]=l[3]}}return m={},m[i?h.POSITION4:h.POSITION]=c,m[h.TEXTURE_COORDINATES]=u,m[h.NORMAL]=_,m[h.COLOR]=p,m[h.GROUP_INDICES]=d,m[h.TRIANGLE_INDEX]=g,m.dataSize=t?2*this._lines.length:3*this._triangles.length,m},r.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},r.prototype.loadToVertexBuffers=function(t,e,i,s,n){var r=null,a=0,l=this._contextProperties[t._name]||new o;return i&&(r=this.getBufferData(!0,e,n),l.bufferStartWireframe=e,t.setVertexBufferData(r,e),a+=r.dataSize,e+=r.dataSize),s&&(r=this.getBufferData(!1,e,n),l.bufferStartSolid=e,l.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(r,e),a+=r.dataSize,e+=r.dataSize),this._contextProperties[t._name]=l,a},r.prototype.render=function(t,e,i){var s=this._contextProperties[t._name];if(!0===e)t.gl.drawArrays(t.gl.LINES,s.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._triangles.length)}},r.prototype.renderInstances=function(t,e,i,s){var n=this._contextProperties[t._name];if(!0===e)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,n.bufferStartWireframe,2*this._lines.length,s);else switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles,s);break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles,s);break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length,s)}},l.prototype.LOD_NOT_SET=-1,l.prototype.getMaxLOD=function(){return this._maxLOD},l.prototype.includeVertexIndicesInPosition=function(t){this._position4=t},l.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this._minLOD,t),this.getMaxLOD())},l.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},l.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;e<=t;e++)this._meshes.push(new r),this._maxLOD=e;return this._meshes[t]},l.prototype.setVertex=function(t,e,i,s){var n;for(n=t;n<=e;n++)this._meshes[n].setVertex(i,s)},l.prototype.addLineDirect=function(t,e,i){var s;for(s=t;s<=e;s++)this._meshes[s].addLine(i)},l.prototype.setupLinesByVertices=function(t,e){var i;for(i=t;i<=e;i++)this._meshes[i].setupLinesByVertices()},l.prototype.markLineByVertex=function(t,e,i,s,n){var o;for(o=t;o<=e;o++)this._meshes[o].markLineByVertex(i,s,n)},l.prototype.addLinesByVertices=function(t,e){var i;for(i=t;i<=e;i++)this._meshes[i].addLinesByVertices()},l.prototype.addTriangleDirect=function(t,e,i,s,n,o){var r,a=this._meshes[t].addTriangleWithParams(i,s,n,o);for(r=t+1;r<=e;r++)this._meshes[r].addTriangle(a);return a},l.prototype.loadFromJSON=function(t,s,n){var o,r,a,l,h,c,_,p,d,g,m,f,S,T,E,y,M,I,C,A=null,v=null,N=null,O=null,L=function(t,e){var i;if(null===A){for(i=t;i<=e;i++)this.getMeshWithLOD(i).resetMesh();A=t,v=e}else{for(i=t;i<A;i++)this.getMeshWithLOD(i).resetMesh();for(i=v+1;i<=e;i++)this.getMeshWithLOD(i).resetMesh();A=t<A?t:A,v=e>v?e:v}}.bind(this);if(n=n||0,"object"!=typeof s)return e.showError("'"+t+"' does not appear to be a JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel JSON format are accepted."),!1;if(!(h=s.version))return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(u.indexOf(h)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+h+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+u.join(", ")+"."),!1;for(c=null,this._infoProperties=s.info||{},this._name=s.info.name||null,this._scale=s.info.scale||1,N=null===s.info.LOD[0]?n:s.info.LOD[0],O=null===s.info.LOD[1]?n:s.info.LOD[1],this.updateLODInfo(N,O),L(N,O),c=s.info.colorPalette,f=s.vertices.length,a=N,l=O,o=0;o<f;o++)C=s.vertices[o].length,s.vertices[o].length>=5&&(a=s.vertices[o][3],l=s.vertices[o][4]),I=new i(s.vertices[o][0],s.vertices[o][1],s.vertices[o][2]),this.setVertex(a,l,o,I);for(S=s.polygons.length,a=N,l=O,this.setupLinesByVertices(a,l),m={color:c[0],groupIndices:[0,0]},E=3,o=0;o<S;o++){for(y=s.polygons[o][0],C=y.length,T=y[0]<0?1:0,1===T&&(E=-y[0]),_=(C-T-E)%2,p=C-T-E-_>2?2*E:0,C-T-E-_-p>=2&&(a=y[C-2],l=y[C-1]),m.color=_?c[y[T+E]]:m.color,p&&(d=y.slice(T+E+_,T+E+_+p)),C=s.polygons[o].length,C>1&&s.polygons[o][1].length>2&&(g=s.polygons[o][1]),m.groupIndices=C>1&&s.polygons[o][1].length%3==2?s.polygons[o][1].slice(-2):m.groupIndices,r=0;r<E-2;r++)m.texCoords=[[d[0],d[1]],[d[2*r+2],d[2*r+3]],[d[2*r+4],d[2*r+5]]],m.normals=g.length>=3*E?[g.slice(0,3),g.slice(3*r+3,3*r+6),g.slice(3*r+6,3*r+9)]:[g.slice(0,3)],M=y[T],this.addTriangleDirect(a,l,M,M+y[T+r+1],M+y[T+r+2],m),this.markLineByVertex(a,l,M+y[T+r+1],M+y[T+r+2],m.groupIndices[0]);this.markLineByVertex(a,l,M,M+y[T+E-1],m.groupIndices[0]),this.markLineByVertex(a,l,M,M+y[T+1],m.groupIndices[0])}return this.addLinesByVertices(N,O),!0},l.prototype._getLargestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||s>i)&&(i=s);return i},l.prototype._getLowestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||s<i)&&(i=s);return i},l.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getSize():0})},l.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxX():0})},l.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinX():0})},l.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxY():0})},l.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinY():0})},l.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxZ():0})},l.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinZ():0})},l.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getWidth():0})},l.prototype.getHeight=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getHeight():0})},l.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getDepth():0})},l.prototype.getWidthInMeters=function(t){return this.getWidth(t)*this._scale},l.prototype.getHeightInMeters=function(t){return this.getHeight(t)*this._scale},l.prototype.getDepthInMeters=function(t){return this.getDepth(t)*this._scale},l.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},l.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},l.prototype.addToContext=function(t,e){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var i=this._contextProperties[t._name];i?(!i.wireframe&&e&&(i.wireframe=!0,t.resetReadyState()),i.solid||e||(i.solid=!0,t.resetReadyState()),i.minLOD>this._minLOD&&(i.minLOD=this._minLOD,t.resetReadyState()),i.maxLOD<this._maxLOD&&(i.maxLOD=this._maxLOD,t.resetReadyState())):(i=new a,i.wireframe=e,i.solid=!e,i.minLOD=this._minLOD,i.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t._name]=i},l.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},l.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this._meshes[i].getBufferData(t,e,this._position4)},l.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t._name],s=0;for(e=i.minLOD;e<=i.maxLOD;e++)s+=this._meshes[e].getBufferSize(i.wireframe,i.solid);return s},l.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var s=this._contextProperties[t._name];return this._meshes[i].loadToVertexBuffers(t,e,s.wireframe,s.solid,this._position4)},l.prototype.render=function(t,e,i,s){s=void 0!==s?s:this._minLOD,this._meshes[s].render(t,e,i)},l.prototype.renderInstances=function(t,e,i,s,n){s=void 0!==s?s:this._minLOD,this._meshes[s].renderInstances(t,e,i,n)},l.prototype.appendVertex=function(t){this.getMeshWithLOD(0).appendVertex(t)},l.prototype.addLine=function(t){this.getMeshWithLOD(0).addLine(t)},l.prototype.addQuad=function(t,e,i,s,n){this.getMeshWithLOD(0).addQuad(t,e,i,s,n)},{VertexAttributeRole:h,Model:l,fvqModel:function(t){var e=new l;return t&&(e._name=t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t,e){var i,s=new l;return t&&(s._name=t),i=e||c,s.appendVertex([-1,-1,0]),s.appendVertex([1,-1,0]),s.appendVertex([1,1,0]),s.appendVertex([-1,1,0]),s.addQuad(0,1,2,3,{texCoords:[[i[0][0],i[1][1]],[i[1][0],i[1][1]],[i[1][0],i[0][1]],[i[0][0],i[0][1]]]}),s},turningBillboardModel:function(t,e,i,s){var n,o,r,a,h,c=new l;if(s=s||i,o=.5-.5*i,r=.5+.5*i,a=.75-.25*s,h=.75+.25*s,t&&(c._name=t),c.appendVertex([-i,-1,0]),c.appendVertex([i,-1,0]),c.appendVertex([i,1,0]),c.appendVertex([-i,1,0]),c.addQuad(0,1,2,3,{texCoords:[[o,.5],[r,.5],[r,0],[o,0]]}),e)for(n=0;n<e.length;n++)c.appendVertex([i,e[n],-s]),c.appendVertex([-i,e[n],-s]),c.appendVertex([-i,e[n],s]),c.appendVertex([i,e[n],s]),c.addQuad(4*(n+1),4*(n+1)+1,4*(n+1)+2,4*(n+1)+3,{texCoords:[[r,a],[o,a],[o,h],[r,h]]}),c.addQuad(4*(n+1)+3,4*(n+1)+2,4*(n+1)+1,4*(n+1),{texCoords:[[r,a],[o,a],[o,h],[r,h]]});return c},lineModel:function(t,e){var i=new l;return t&&(i._name=t),i.appendVertex([0,0,0]),i.appendVertex(e),i.addLine(new s(0,1)),i}}}),define("modules/audio",["modules/application"],function(t){"use strict";function e(t,e,i,s){var n=M.currentTime;t.gain.cancelScheduledValues(n),t.gain.setValueAtTime(t.gain.value,n),s?t.gain.setTargetAtTime(e,n,i||A):t.gain.linearRampToValueAtTime(e,n+(i||A))}function i(t,e,i,s,n){var o;this._x=t,this._y=e,this._z=i,this._positionChangeTime=0,this._pannerNode=s?M.createPanner():null,this._clips={},this._pannerNode&&(this._pannerNode.panningModel=s,this._pannerNode.refDistance=1,this._pannerNode.rolloffFactor=n||v,o=M.currentTime,this._pannerNode.positionX.setValueAtTime(this._x,o),this._pannerNode.positionY.setValueAtTime(this._y,o),
this._pannerNode.positionZ.setValueAtTime(this._z,o),this._positionChangeTime=o,this._pannerNode.connect(p))}function s(t,e,i,s,n,o,r,a){this._soundCategory=t,this._sampleName=e,this._volume=i,this._loop=s,this._shouldStack=n||!1,this._stackTimeThreshold=o||0,this._stackVolumeFactor=r||1,this._sourceNode=null,this._gainNode=null,this._playbackStartTime=0,this._playing=!1,this._stopping=!1,this._onFinish=null,this._onEnded=null,this._soundSource=null,a&&this.setSource(a)}function n(e,i,s,n){M.decodeAudioData(i.response,function(t){O[e]=t,s&&s()},function(){t.showError("Decoding audio sample '"+e+"' failed!"),n&&n()})}function o(t,e,n,o,r,a){var l=a?E:T;s.call(l,e||I.SOUND_EFFECT,t,n,!1),o&&(i.call(y,o[0],o[1],o[2],N,r),l.setSource(y)),l.play()}function r(){T.stopPlaying(A),E.stopPlaying(A)}function a(t,i){e(p,t,i)}function l(t,i){e(d,t,i)}function h(t,i){e(g,t,i)}function c(t,i){e(m,t,i)}function u(t,i){e(f,t,i)}function _(){M.resume()}var p,d,g,m,f,S,T,E,y,M,I={NONE:0,SOUND_EFFECT:1,MUSIC:2,UI:3,VOICE:4},C={EQUAL_POWER:"equalpower",HRTF:"HRTF"},A=.01,v=.01,N=C.EQUAL_POWER,O={};return i.prototype.updatePosition=function(t,e,i){var s=M.currentTime;s-this._positionChangeTime>=.15&&(t!==this._x||e!==this._y||i!==this._z)&&(this._x=t,this._y=e,this._z=i,this._positionChangeTime=s,this._pannerNode.positionX.value!==t&&(this._pannerNode.positionX.setValueAtTime(this._pannerNode.positionX.value,s),this._pannerNode.positionX.linearRampToValueAtTime(t,s+A)),this._pannerNode.positionY.value!==e&&(this._pannerNode.positionY.setValueAtTime(this._pannerNode.positionY.value,s),this._pannerNode.positionY.linearRampToValueAtTime(e,s+A)),this._pannerNode.positionZ.value!==i&&(this._pannerNode.positionZ.setValueAtTime(this._pannerNode.positionZ.value,s),this._pannerNode.positionZ.linearRampToValueAtTime(i,s+A)))},i.prototype.setPositionImmediate=function(t,e,i){var s=M.currentTime;this._x=t,this._y=e,this._z=i,this._positionChangeTime=s,this._pannerNode.positionX.value!==t&&this._pannerNode.positionX.setValueAtTime(t,s),this._pannerNode.positionY.value!==e&&this._pannerNode.positionY.setValueAtTime(e,s),this._pannerNode.positionZ.value!==i&&this._pannerNode.positionZ.setValueAtTime(i,s)},i.prototype.setClip=function(t,e){this._clips[t]=e},i.prototype.getClip=function(t){return this._clips[t]},i.prototype.destroy=function(){this._pannerNode&&this._pannerNode.disconnect(),this._pannerNode=null},s.prototype.setSource=function(e){this._soundCategory!==I.SOUND_EFFECT?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because its sound category is not sound effect!"):this._soundSource?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it already has a source!"):this._playing?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it is already playing!"):this._soundSource=e},s.prototype.getVolume=function(){return void 0!==this._volume?this._volume:1},s.prototype.setVolume=function(t){this._volume=t,this._gainNode&&(this._gainNode.gain.value=t)},s.prototype.increaseVolume=function(t){this._volume+=t,this._gainNode&&(this._gainNode.gain.value=this._volume)},s.prototype.rampVolume=function(t,i,s,n){!this._gainNode||s&&this._volume===t||e(this._gainNode,t,i,n),this._volume=t},s.prototype.getPlaybackPosition=function(){var t=M.currentTime-this._playbackStartTime;return this._loop?t%O[this._sampleName].duration:Math.min(t,O[this._sampleName].duration)},s.prototype._handleEnded=function(){this._playing=!1},s.prototype._startPlayingSample=function(e,i){var s;if(this._sourceNode=M.createBufferSource(),this._sourceNode.buffer=O[this._sampleName],i?this._sourceNode.onended=function(){this._playing=!1,i()}.bind(this):(this._onEnded=this._onEnded||this._handleEnded.bind(this),this._sourceNode.onended=this._onEnded),this._onFinish=i,s=this._sourceNode,void 0!==this._volume&&(this._gainNode=M.createGain(),this._gainNode.gain.value=this._volume,s.connect(this._gainNode),s=this._gainNode),this._loop&&(this._sourceNode.loop=!0),this._soundSource)s.connect(this._soundSource._pannerNode);else switch(this._soundCategory){case I.SOUND_EFFECT:s.connect(p);break;case I.MUSIC:s.connect(d);break;case I.UI:s.connect(m);break;case I.VOICE:s.connect(g);break;default:t.showError("Cannot play sound '"+this._sampleName+"', because it has an unkown category: "+this._soundCategory)}this._playing=!0,this._stopping=!1,this._sourceNode.start(M.currentTime,e),this._playbackStartTime=M.currentTime-e},s.prototype.play=function(e,i){var s;if(O[this._sampleName]){if(this._playing)if(e)this.stopPlaying();else if(this._loop)return;this._soundSource&&this._shouldStack?(s=this._soundSource.getClip(this._sampleName),s&&s._playing&&s.getPlaybackPosition()<=this._stackTimeThreshold?s.increaseVolume(this._volume*this._stackVolumeFactor):(this._startPlayingSample(0,i),this._soundSource&&this._soundSource.setClip(this._sampleName,this))):this._startPlayingSample(0,i)}else this._sampleName&&t.showError("Attempting to play back '"+this._sampleName+"', which is not loaded!")},s.prototype.stopPlaying=function(t){this._sourceNode&&this._playing&&!this._stopping&&(t?(this.rampVolume(0,t),setTimeout(this._sourceNode.stop.bind(this._sourceNode),1e3*t),this._stopping=!0):this._sourceNode.stop())},s.prototype.stopLoop=function(){this._sourceNode&&this._playing&&!this._stopping&&(this._sourceNode.loop=!1,this._stopping=!0)},s.prototype.destroy=function(){this.stopPlaying(),this._sourceNode=null,this._gainNode=null,this._position=null},M=new AudioContext,f=M.createGain(),f.connect(M.destination),S=M.createDynamicsCompressor(),S.connect(f),p=M.createGain(),p.connect(S),d=M.createGain(),d.connect(S),g=M.createGain(),g.connect(S),m=M.createGain(),m.connect(f),T=new s,E=new s,y=new i(0,0,0),M.createPanner().positionX||t.showError("3D audio is not properly supported by your browser!",t.ErrorSeverity.SEVERE,"This game requires 3D positional audio to work properly. Please upgrade to a browser that supports it to play!"),{SoundCategory:I,PanningModel:C,SoundClip:s,SoundSource:i,loadSample:n,playSound:o,stopLastClips:r,setEffectVolume:a,setMusicVolume:l,setVoiceVolume:h,setUIVolume:c,setMasterVolume:u,resume:_}}),define("modules/media-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model","modules/audio"],function(t,e,i,s,n,o,r){"use strict";function a(t){s.GenericResource.call(this,t?t.name:""),this._dataJSON=t,t&&this._loadConfig(t)}function l(t){a.call(this,t)}function h(t){a.call(this,t)}function c(t){a.call(this,t)}function u(t){a.call(this,t)}function _(t){a.call(this,t)}function p(t){a.call(this,t)}function d(){s.ResourceManager.call(this)}function g(t,e){var i={};i[S]=l,i[T]=h,i[E]=c,i[y]=u,i[M]=_,i[I]=p,m.requestConfigLoad(t.filename,t.folder,i,e)}var m,f={VERTEX:"vertex",FRAGMENT:"fragment"},S="textures",T="cubemaps",E="shaders",y="models",M="soundEffects",I="music",C={},A={},v={},N={allowNullResult:!1};return Object.freeze(f),a.prototype=new s.GenericResource,a.prototype.constructor=a,a.prototype._loadConfig=function(t){this._dataJSON=t},a.prototype.getData=function(){return this._dataJSON},a.prototype.reloadData=function(){this._loadConfig(this._dataJSON),this.resetReadyState()},l.prototype=new a,l.prototype.constructor=l,l.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._useMipmap=!0===t.useMipmap,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]},l.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},l.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},l.prototype._handleError=function(t){i.showError("Could not load texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},l.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)(s=t.indexOf(o[e]))>=0&&(-1===r||s<r)&&(r=s,n=t[s]);return-1===r?(i.showError("Texture '"+this._name+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},l.prototype._getProcessedParams=function(t){return t=t||{},t.types=t.types||Object.keys(this._typeSuffixes),t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},l.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e=0;e<t.types.length;e++)if(this._typeSuffixes.hasOwnProperty(t.types[e])){if(!this._images[t.types[e]])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[t.types[e]][t.qualities[i]])return!0}return!1},l.prototype._requestFiles=function(t){var e,s,n,o,r;for(t=this._getProcessedParams(t),e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(this._images[n]=this._images[n]||{},s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o]||(r=this._getPath(n,o),A[r]?this._images[n][o]=A[r]:(A[r]=new Image,this._imagesToLoad++,this._images[n][o]=A[r],this._images[n][o].onload=this._getOnLoadImageFunction(n,o).bind(this),this._images[n][o].onerror=this._handleError.bind(this,r))));for(e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o].src||(this._images[n][o].src=i.getFileURL("texture",this._getPath(n,o))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},l.prototype._loadData=function(t){return!t.error},l.prototype.getTypes=function(){return Object.keys(this._images)},l.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},l.prototype.getPathForType=function(t,e){return this._getPath(t,this._getMostFittingQuality(e))},l.prototype.getManagedTexture=function(t,e){return!1===this._readyToUse?(i.showError("Cannot get managed GL texture for '"+this._name+"', as it has not been loaded from file yet!"),null):(this._images[t]||(i.showError("The requested texture '"+this._name+"' has no type '"+t+"' available!"),t=Object.keys(this._images)[0]),this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new n.ManagedTexture(this._name,this._images[t][e],this._useMipmap),this._managedTextures[t][e])},l.prototype.getManagedTexturesOfTypes=function(e,i){var s,n,o,r=e.slice().sort();for(s=0;s<this._cachedManagedTexturesOfTypes.length;s++)if(t.arraysEqual(r,this._cachedManagedTexturesOfTypes[s].types)&&t.arraysEqual(i,this._cachedManagedTexturesOfTypes[s].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[s].textures;for(n={},o=this._getMostFittingQuality(i),s=0;s<e.length;s++)n[e[s]]=this.getManagedTexture(e[s],o);return this._cachedManagedTexturesOfTypes.push({types:r,qualityPreferenceList:i,textures:n}),n},h.prototype=new a,h.prototype.constructor=h,h.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._imageNames=t.imageNames,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]},h.prototype._getPath=function(t,e){return this._basepath+this._imageNames[t]+this._qualitySuffixes[e]+"."+this._format},h.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},h.prototype._handleError=function(t){i.showError("Could not load cube mapped texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},h.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)(s=t.indexOf(o[e]))>=0&&(-1===r||s<r)&&(r=s,n=t[s]);return-1===r?(i.showError("Cubemap '"+this._name+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},h.prototype._getProcessedParams=function(t){return t=t||{},t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},h.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){if(!this._images[e])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[e][t.qualities[i]])return!0}return!1},h.prototype._requestFiles=function(t){var e,s,n,o;t=this._getProcessedParams(t);for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(this._images[e]=this._images[e]||{},s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n]||(o=this._getPath(e,n),v[o]?this._images[e][n]=v[o]:(v[o]=new Image,this._imagesToLoad++,this._images[e][n]=v[o],this._images[e][n].onload=this._getOnLoadImageFunction(e,n).bind(this),this._images[e][n].onerror=this._handleError.bind(this,o))));for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n].src||(this._images[e][n].src=i.getFileURL("texture",this._getPath(e,n))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},h.prototype._loadData=function(t){return!t.error},h.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},h.prototype.getManagedCubemap=function(e){var s,o,r;if(!1===this._readyToUse)return i.showError("Cannot get managed GL cubemap for '"+this._name+"', as it has not been loaded from file yet!"),null;for(s=0;s<this._cachedManagedCubemaps.length;s++)if(t.arraysEqual(e,this._cachedManagedCubemaps[s].qualityPreferenceList))return this._cachedManagedCubemaps[s].cubemap;return r=this._getMostFittingQuality(e),o=new n.ManagedCubemap(this._name,[this._images.posX[r],this._images.negX[r],this._images.posY[r],this._images.negY[r],this._images.posZ[r],this._images.negZ[r]]),this._cachedManagedCubemaps.push({qualityPreferenceList:e,cubemap:o}),o},c.prototype=new a,c.prototype.constructor=c,c.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue(n.ShaderBlendMode,t.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0},c.prototype._checkAllSourcesLoaded=function(){this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad&&("-"===this._vertexShaderSource&&(this._vertexShaderSource=null),"-"===this._fragmentShaderSource&&(this._fragmentShaderSource=null),this.onFinalLoad())},c.prototype._loadIncludeSource=function(t,e,i){var s;for(C[e].source=i,this._resolveInclude(t,e),s=0;s<C[e].onLoad.length;s++)C[e].onLoad[s]()},c.prototype._getIncludeFileName=function(t){return t.substr('#include "'.length,t.length-('#include "'.length+'"'.length))},c.prototype._resolveInclude=function(t,e){var i,s,n=C[e].source;switch(t){case f.VERTEX:s=this._vertexShaderSource.split("\n");break;case f.FRAGMENT:s=this._fragmentShaderSource.split("\n")}for(i=0;i<s.length;i++)if('#include "'===s[i].substr(0,'#include "'.length)&&e===this._getIncludeFileName(s[i])){switch(s[i]=n,t){case f.VERTEX:this._vertexShaderSource=s.join("\n");break;case f.FRAGMENT:this._fragmentShaderSource=s.join("\n")}this._resolveSource(t,n);break}this._shaderIncludesLoaded++,this._checkAllSourcesLoaded()},c.prototype._resolveSource=function(t,e){var s,n=e.split("\n"),o=[];for(s=0;s<n.length;s++)'#include "'===n[s].substr(0,'#include "'.length)&&(o.push(this._getIncludeFileName(n[s])),this._shaderIncludesToLoad++);for(s=0;s<o.length;s++)C[o[s]]?C[o[s]].source?this._resolveInclude(t,o[s]):C[o[s]].onLoad.push(this._resolveInclude.bind(this,t,o[s])):(C[o[s]]={onLoad:[]},i.requestTextFile("shader",o[s],this._loadIncludeSource.bind(this,t,o[s])))},c.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},c.prototype._requestFiles=function(){i.requestTextFile("shader",this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:f.VERTEX,text:t})}.bind(this)),i.requestTextFile("shader",this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:f.FRAGMENT,text:t})}.bind(this))},c.prototype._loadData=function(t){switch(e.getEnumValue(f,t.shaderType,{name:"shaderType",defaultValue:null})){case f.VERTEX:this._vertexShaderSource=t.text||"-";break;case f.FRAGMENT:this._fragmentShaderSource=t.text||"-"}return t.text&&this._resolveSource(t.shaderType,t.text),this._checkAllSourcesLoaded(),!!t.text},c.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},c.prototype.getManagedShader=function(e,s){var o;if(!1===this._readyToUse)return i.showError("Cannot get managed GL shader for '"+this._name+"', as it has not been loaded from file yet!"),null;for(e=e||null,o=0;o<this._managedShaderBindings.length;o++)if(t.objectsEqual(this._managedShaderBindings[o].replacedDefines,e))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new n.ManagedShader(this._name,this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e,s),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},u.prototype=new a,u.prototype.constructor=u,u.prototype._loadConfig=function(t){if(a.prototype._loadConfig.call(this,t),t.model)return this._model=t.model,this._files=[],this._dataJSON=null,void this.setToReady();this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,this._maxLoadedLOD=-1},u.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},u.prototype.requiresReload=function(t){return!this.isRequested(t)&&(0!==this._files.length&&(t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()&&this.requiresReload({maxLOD:this.getMaxLOD()})))},u.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},u.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile("model",this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},u.prototype._requestFiles=function(t){var e,s;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(e<0&&this._files.length>0)for(s=this.getMaxLOD(),e=t.maxLOD+1;e<=s;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},u.prototype._loadData=function(t){return this._model=new o.Model,t.text?("{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):i.showError("Cannot load Egom Model from file '"+this._getPath(t.maxLOD)+"' - the file needs to start with '{'!"),this._maxLoadedLOD=t.maxLOD,!0):(i.showError("Model file of max LOD level "+t.maxLOD+" could not be loaded for model '"+this._name+"'!"),!1)},u.prototype.getEgomModel=function(){return!1===this._readyToUse?(i.showError("Cannot get model object for '"+this._name+"', as it has not been loaded from file yet!"),null):this._model},_.prototype=new a,_.prototype.constructor=_,_.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._samples=t.samples,this._loadedSamples=0,this._samplesToLoad=0},_.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},_.prototype._requestFile=function(t){this._samplesToLoad++,i.requestFile("soundEffect",this._samples[t],function(e){e?r.loadSample(this._samples[t],e,function(){this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t]})}.bind(this)):(i.showError("Could not load sound sample '"+this._name+"'!"),this._samples[t]=null,this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t],error:!0}))}.bind(this),void 0,"arraybuffer")},_.prototype._requestFiles=function(){var t;for(t=0;t<this._samples.length;t++)this._requestFile(t)},_.prototype._loadData=function(t){return!t.error},_.prototype.getRandomSampleIndex=function(){return Math.floor(Math.random()*this._samples.length)},_.prototype.play=function(t,e,s,n,o){var a,l;return!1===this._readyToUse?(i.showError("Cannot play sound effect '"+this._name+"', as it has not been loaded from file yet!"),-1):(l=this.getRandomSampleIndex(),a=this._samples[l],a?(r.playSound(a,t,e,s,n,o),l):-1)},_.prototype.createSoundClip=function(t,e,s,n,o,a,l){var h;return!1===this._readyToUse?(i.showError("Cannot create sound source for sound effect '"+this._name+"', as it has not been loaded from file yet!"),null):(h=this._samples[Math.floor(Math.random()*this._samples.length)],h?new r.SoundClip(t,h,e,s,n,o,a,l):null)},p.prototype=new a,p.prototype.constructor=p,p.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._sample=t.sample},p.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},p.prototype._requestFiles=function(){i.requestFile("music",this._sample,function(t){t?r.loadSample(this._sample,t,function(){this._onFilesLoad(!0,{path:this._sample})}.bind(this)):(i.showError("Could not load music track '"+this._name+"'!"),this._sample=null,this._onFilesLoad(!0,{path:this._sample,error:!0}))}.bind(this),void 0,"arraybuffer")},p.prototype._loadData=function(t){return!t.error},p.prototype.createSoundClip=function(t,e){return!1===this._readyToUse?(i.showError("Cannot create sound source for music '"+this._name+"', as it has not been loaded from file yet!"),null):this._sample?new r.SoundClip(r.SoundCategory.MUSIC,this._sample,t,e):null},d.prototype=new s.ResourceManager,d.prototype.constructor=d,d.prototype.getTexture=function(t,e){return this.getResource(S,t,e)},d.prototype.getCubemap=function(t,e){return this.getResource(T,t,e)},d.prototype.getShader=function(t){return this.getResource(E,t)},d.prototype.getVariantShader=function(t,e){return N.allowNullResult=!0,this.getResource(E,this.getResource(E,t,{doNotLoad:!0}).getVariantShaderName(e),N)||this.getShader(t)},d.prototype.getModel=function(t,e){return this.getResource(y,t,e)},d.prototype.getOrAddModel=function(t){var e;return N.allowNullResult=!0,e=this.getResource(y,t._name,N),e||(e=this.addResource(y,new u({name:t._name,model:t}),!0)),e},d.prototype.getSoundEffect=function(t,e){return N.allowNullResult=e||!1,this.getResource(M,t,N)},d.prototype.getMusic=function(t){return this.getResource(I,t)},m=new d,{SoundCategory:r.SoundCategory,requestConfigLoad:g,requestResourceLoad:m.requestResourceLoad.bind(m),getTexture:m.getTexture.bind(m),getCubemap:m.getCubemap.bind(m),getShader:m.getShader.bind(m),getVariantShader:m.getVariantShader.bind(m),getModel:m.getModel.bind(m),getOrAddModel:m.getOrAddModel.bind(m),getSoundEffect:m.getSoundEffect.bind(m),getMusic:m.getMusic.bind(m),getResourceTypes:m.getResourceTypes.bind(m),getResourceNames:m.getResourceNames.bind(m),getResource:m.getResource.bind(m),addResource:m.addResource.bind(m),createResource:m.createResource.bind(m),executeWhenReady:m.executeWhenReady.bind(m),executeOnResourceLoad:m.executeOnResourceLoad.bind(m),executeForAllResources:m.executeForAllResources.bind(m),renameResource:m.renameResource.bind(m),moveResourceAfter:m.moveResourceAfter.bind(m)}}),define("modules/containers",[],function(){"use strict";function t(){this._first=null,this._last=null,this._length=0}return t.prototype.add=function(t){this._first?(this._last.next=t,t.previous=this._last):(this._first=t,t.previous=null),t.next=null,t.list=this,this._last=t,this._length++},t.prototype.remove=function(t){t.list===this&&(t.previous?t.previous.next=t.next:this._first=t.next,t.next?t.next.previous=t.previous:this._last=t.previous,t.list=null,this._length--)},t.prototype.clear=function(t){var e;if(t)for(e=this._first;e;e=e.next)e.list=null;this._first=null,this._last=null,this._length=0},t.prototype.getNext=function(t){return t&&t.list===this?t.next||this._first:this._first},t.prototype.getPrevious=function(t){return t&&t.list===this?t.previous||this._last:this._last},t.prototype.appendToArray=function(t){var e,i;for(i=t.length,t.length=i+this._length,e=this._first;e;e=e.next,i++)t[i]=e},{DirectDoubleLinkedList:t}}),define("modules/scene/object-3d",["utils/vectors","utils/matrices"],function(t,e){"use strict";function i(t,i,s,n,o,r){this._parent=null,this.pM=t||e.identity4(),this.oM=i||e.identity4(),this.sM=s||e.identity4(),this.csM=e.identity4(),this.csMValid=!1,this._largestScalingFactor=1,this.mM=e.identity4(),this.mMValid=!1,this._cascadedModelMatrix=e.identity4(),this.mMForFrame=this.mM,this.mMForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMC=e.identity4(),this.pMCV=!1,this._ignoreTransform=r||!1}var s,n;return s=function(){function i(t,i,s,n,o,r){this._parent=null,e.copyTranslation4(this.pM,t||e.IDENTITY4),e.copyRotation4(this.oM,i||e.IDENTITY4),e.copyScaling4(this.sM,s||e.IDENTITY4),this.mMForFrame=this.mM,this.csMValid=!1,this.mMValid=!1,this.mMForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._ignoreTransform=r||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMCV=!1}function s(){this.pMCV=!1,this.mMForFrameValid=!1}function n(t){this._parent=t,this.mMForFrame=t&&!t._ignoreTransform?this._cascadedModelMatrix:this.mM}function o(t){this.pM=t,this.mM[12]=this.pM[12],this.mM[13]=this.pM[13],this.mM[14]=this.pM[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function r(){return[this.pM[12],this.pM[13],this.pM[14]]}function a(t){t[0]=this.pM[12],t[1]=this.pM[13],t[2]=this.pM[14]}function l(t){t[0]+=this.pM[12],t[1]+=this.pM[13],t[2]+=this.pM[14]}function h(t){this.pM[12]=t[0],this.pM[13]=t[1],this.pM[14]=t[2],this.mM[12]=t[0],this.mM[13]=t[1],this.mM[14]=t[2],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function c(t){this.pM[12]=t[12],this.pM[13]=t[13],this.pM[14]=t[14],this.mM[12]=t[12],this.mM[13]=t[13],this.mM[14]=t[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function u(t,e,i){this.pM[12]+=t,this.pM[13]+=e,this.pM[14]+=i,this.mM[12]+=t,this.mM[13]+=e,this.mM[14]+=i,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function _(t){this.pM[12]+=t[0],this.pM[13]+=t[1],this.pM[14]+=t[2],this.mM[12]+=t[0],this.mM[13]+=t[1],this.mM[14]+=t[2],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function p(t){this.pM[12]+=t[12],this.pM[13]+=t[13],this.pM[14]+=t[14],this.mM[12]+=t[12],this.mM[13]+=t[13],this.mM[14]+=t[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function d(t,e){this.pM[12]+=t[12]*e,this.pM[13]+=t[13]*e,this.pM[14]+=t[14]*e,this.mM[12]+=t[12]*e,this.mM[13]+=t[13]*e,this.mM[14]+=t[14]*e,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function g(t,e){var i=e*t[12]+(1-e)*this.pM[12]-this.pM[12];this.pM[12]+=i,this.mM[12]+=i,i=e*t[13]+(1-e)*this.pM[13]-this.pM[13],this.pM[13]+=i,this.mM[13]+=i,i=e*t[14]+(1-e)*this.pM[14]-this.pM[14],this.pM[14]+=i,this.mM[14]+=i,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function m(t){t&&(this.oM=t),this.mMValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function f(t){e.copyRotation4(this.oM,t),this.mMValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function S(){return[this.oM[0],this.oM[1],this.oM[2]]}function T(){return[this.oM[4],this.oM[5],this.oM[6]]}function E(){return[this.oM[8],this.oM[9],this.oM[10]]}function y(t,i){0!==i&&(e.rotate4(this.oM,t,i),this.setOrientationMatrix())}function M(t){e.mulRotationRotation4(this.oM,t),this.setOrientationMatrix()}function I(t,e,i){this.sM[0]=t,this.sM[5]=e,this.sM[10]=i,this.mMValid=!1,this.csMValid=!1}function C(t){this.sM[0]=t,this.sM[5]=t,this.sM[10]=t,this.mMValid=!1,this.csMValid=!1}function A(){return this.csMValid||(this._parent&&!this._parent._ignoreTransform?e.setScalingToProdScalingScaling4(this.csM,this._parent.getCascadeScalingMatrix(),this.sM):e.copyScaling4(this.csM,this.sM),this._largestScalingFactor=Math.max(Math.abs(this.csM[0]),Math.abs(this.csM[5]),Math.abs(this.csM[10])),this.csMValid=!0),this.csM}function v(){
return this.mMForFrameValid||(this.mMValid||(e.setModelMatrix(this.mM,this.pM,this.oM,this.sM),this.mMValid=!0),this._parent&&!this._parent._ignoreTransform&&e.setProd4NoProj(this._cascadedModelMatrix,this.mM,this._parent.getModelMatrix()),this.mMForFrameValid=!0),this.mMForFrame}function N(){return this._size}function O(t){this._size=t}function L(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function R(){return null===this._insideParent&&(this._insideParent=!!this._parent&&(this._parent._childrenAlwaysInside||Math.abs(this.pM[12])<this._parent.getSize()&&Math.abs(this.pM[13])<this._parent.getSize()&&Math.abs(this.pM[14])<this._parent.getSize())),this._insideParent}function b(i){return this.pMCV||(e.updateTranslation4v(this.pMC,t.prodTranslationModel3Aux(this.getModelMatrix(),i.getViewMatrix())),this.pMCV=!0),this.pMC}function x(t,e){var i,s,n,o,r,a,l,h;if(s=this.getPositionMatrixInCameraSpace(t),0!==s[14]){if(this.getCascadeScalingMatrix(),e&&(i=this.getSize()*this._largestScalingFactor,s[14]-i>=-t._near||s[14]+i<-t._viewDistance))return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum;if(n=t.getProjectionMatrix(),i=this.getSize(),h=-1/s[14],o=s[12]*n[0]*h,r=s[13]*n[5]*h,a=Math.abs(this._largestScalingFactor*n[0]*i*h),l=Math.abs(this._largestScalingFactor*n[5]*i*h),!(o+a<-1||o-a>1||r+l<-1||r-l>1))return this._lastSizeInsideViewFrustum.width=a,this._lastSizeInsideViewFrustum.height=l,this._lastSizeInsideViewFrustum}return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum}function D(t){return t.isInsideCurrentMap(this.getModelMatrix(),this.getScaledSize())}return function(){this.prototype.init=i,this.prototype.resetCachedValues=s,this.prototype.setParent=n,this.prototype.setPositionMatrix=o,this.prototype.setPositionv=h,this.prototype.setPositionM4=c,this.prototype.setOrientationMatrix=m,this.prototype.setOrientationM4=f,this.prototype.setScaling=I,this.prototype.setScale=C,this.prototype.getPositionVector=r,this.prototype.copyPositionToVector=a,this.prototype.addPositionToVector=l,this.prototype.translate=u,this.prototype.translatev=_,this.prototype.translateByMatrix=p,this.prototype.translateByMatrixMul=d,this.prototype.translateTowardsM4=g,this.prototype.getXDirectionVector=S,this.prototype.getYDirectionVector=T,this.prototype.getZDirectionVector=E,this.prototype.rotate=y,this.prototype.rotateByMatrix=M,this.prototype.getCascadeScalingMatrix=A,this.prototype.getModelMatrix=v,this.prototype.getSize=N,this.prototype.setSize=O,this.prototype.getScaledSize=L,this.prototype.isInsideParent=R,this.prototype.getPositionMatrixInCameraSpace=b,this.prototype.getSizeInsideViewFrustum=x,this.prototype.isInsideShadowRegion=D}},n=s(),n.call(i),{Object3D:i,makeObject3DMixinClass:n}}),define("modules/scene/camera",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/scene/object-3d"],function(t,e,i,s,n){"use strict";function o(t,e,s,n,o,r,a,l,h,c){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=s,this._followedObjects=n||[],this._startsWithRelativePosition=o,this._defaultRelativePositionMatrix=i.copy(r),this._relativePositionMatrix=r,this._worldPositionMatrix=i.identity4(),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=c,this._isStarting=!0,this._camera=null}function r(t,e,s,n,o,r,a,l,h,d,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=s,this._followedObjects=n||[],this._defaultRelativeOrientationMatrix=i.copy(o),this._relativeOrientationMatrix=o,this._worldOrientationMatrix=i.identity4(),this._worldOrientationMatrixValid=!1,this._defaultAlpha=r||0,this._alpha=r||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=l&&void 0!==l[0]?l[0]:c,this._maxAlpha=l&&void 0!==l[1]?l[1]:u,this._minBeta=h&&void 0!==h[0]?h[0]:_,this._maxBeta=h&&void 0!==h[1]?h[1]:p,this._baseOrientation=d,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null}function a(t,e,i,s,o,r,a,l){n.Object3D.call(this,e.pM,i.oM),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=s,this._fov=s,this._minFOV=o?o[0]:s,this._maxFOV=o?o[1]:s,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null}function l(e,s,n,l,h,c,u){var _=i.getYawAndPitch(n);return new a(t.EMPTY_STRING,new o(!1,!1,!1,[],!1,i.copy(s),null,null,!1),new r(!1,!1,e,[],i.copy(n),Math.degrees(_.yaw),Math.degrees(_.pitch),void 0,void 0,r.BaseOrientation.WORLD,r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),l,[h,c],u)}function h(t,e,s,o,r,a,l){this._object3D=new n.Object3D(i.identity4(),i.identity4(),i.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=s,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=h.TransitionStyle.NONE,this._defaultTransitionStyle=l||h.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=a||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=i.identity4(),this._projectionMatrixValid=!1,this._followedNode=null,this._viewMatrix=i.identity4(),this._viewMatrixValid=!1,this._inversePositionMatrix=i.identity4(),this._inversePositionMatrixValid=!1,this._inverseOrientationMatrix=i.identity4(),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._posMatrix=i.identity4(),this._oriMatrix=i.identity4(),this._updateFOV(),this._updateSpan()}var c=-360,u=360,_=-90,p=90;return o.prototype.init=function(t,e,s,n,o,r,a,l,h,c){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=s,this._followedObjects=n||[],this._startsWithRelativePosition=o,i.copyTranslation4(this._defaultRelativePositionMatrix,r),i.copyTranslation4(this._relativePositionMatrix,r),i.setIdentity4(this._worldPositionMatrix),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=c,this._isStarting=!0,this._camera=null},o.prototype.copy=function(t){var e=new o(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,i.copy(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=i.copy(this._relativePositionMatrix),e._worldPositionMatrix=i.copy(this._worldPositionMatrix),e._isStarting=this._isStarting,e},o.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},o.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),i.copyTranslation4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrixValid=!1,this._isStarting=!0},o.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},o.prototype.moveByVector=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),i.translateByVector(this._relativePositionMatrix,t)},o.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},o.prototype.getFollowedPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)this._followedObjects[t].addPositionToVector(e);e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},o.prototype.getFollowedPositionMatrix=function(){var t,e=i.identity4Aux();if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)i.translateByMatrix(e,this._followedObjects[t].pM);e=i.translation4Aux(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},o.prototype.getFollowedObjectOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},o.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||!0===this._followedObjects[e].canBeReused());)e++,s++;s>0&&(this._followedObjects.splice(t,s),0===this._followedObjects.length&&i.copyTranslation4(this._relativePositionMatrix,this._worldPositionMatrixValid&&this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},o.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t&&i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_90,t))),this.getFollowedPositionMatrix()):i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&i.copyTranslation4(this._relativePositionMatrix,this._worldPositionMatrix)):i.copyTranslation4(this._worldPositionMatrix,this._relativePositionMatrix),this._worldPositionMatrixValid=!0},o.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrixValid||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},o.prototype._checkConfines=function(t){var s,n,o;if(o=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.translation4m4Aux(i.prodTranslationRotation4Aux(i.translatedByM4Aux(this._relativePositionMatrix,i.inverseOfTranslation4Aux(this.getFollowedPositionMatrix())),i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(s=i.translationVector3(o),(n=e.extractLength3(s))<this._minimumDistance||n>this._maximumDistance){if(n>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n=Math.min(Math.max(n,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(e.scale3(s,n))}}else if(t&&(s=e.diffVec3Mat4Aux(t,o),(n=e.extractLength3(s))<this._minimumDistance||n>this._maximumDistance)){if(n>this._maximumDistance&&this._resetsWhenLeavingConfines)return!1;n=Math.min(Math.max(n,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(e.sum3Aux(t,e.scale3(s,-n)))}if(this._xIsConfined&&(o[12]<this._minimumX||o[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[12]=Math.min(Math.max(o[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(o[13]<this._minimumY||o[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[13]=Math.min(Math.max(o[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(o[14]<this._minimumZ||o[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[14]=Math.min(Math.max(o[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.setTranslatedByM4(this._relativePositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(o,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):i.copyTranslation4(this._relativePositionMatrix,o),!0},o.prototype.update=function(t,s,n,o){var r,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)i.translateByVector(this._relativePositionMatrix,e.scale3(e.prodVec3Mat4Aux(n,t),o/1e3));else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(r=i.translationVector3(this._relativePositionMatrix),(a=e.extractLength3(r)+n[2]*o/1e3)<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}i.updateTranslation4v(this._relativePositionMatrix,e.scale3(r,a))}}else this._movesRelativeToObject?i.translateByVector(this._relativePositionMatrix,e.scaled3Aux(e.prodVec3Mat4Aux(n,i.ROTATION_X_270),.001*o)):i.translateByVector(this._relativePositionMatrix,e.scaled3Aux(e.prodVec3Mat4Aux(n,i.prod3x3SubOf4Aux(t,i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))),.001*o));if(!this._isTransitionConfiguration){if(!this._checkConfines(s))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrixValid=!1,!0},r.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(r.BaseOrientation),r.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(r.PointToFallback),r.prototype.init=function(t,e,s,n,o,r,a,l,h,d,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=s,this._followedObjects=n||[],i.copyRotation4(this._defaultRelativeOrientationMatrix,o),i.copyRotation4(this._relativeOrientationMatrix,o),i.setIdentity4(this._worldOrientationMatrix),this._worldOrientationMatrixValid=!1,this._defaultAlpha=r||0,this._alpha=r||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=l&&void 0!==l[0]?l[0]:c,this._maxAlpha=l&&void 0!==l[1]?l[1]:u,this._minBeta=h&&void 0!==h[0]?h[0]:_,this._maxBeta=h&&void 0!==h[1]?h[1]:p,this._baseOrientation=d,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null},r.prototype.copy=function(t){var e=new r(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),i.copy(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=i.copy(this._relativeOrientationMatrix),e._worldOrientationMatrix=i.copy(this._worldOrientationMatrix),e},r.prototype.setCamera=function(t){this._camera=t},r.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),i.copyRotation4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrixValid=!1},r.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},r.prototype.isFPS=function(){return this._fps},r.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},r.prototype.setFollowedObjects=function(t,e){0===this._followedObjects.length&&0===t.length||(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},r.prototype.setFollowedObject=function(t,e){1===this._followedObjects.length&&this._followedObjects[0]===t||this.setFollowedObjects([t],e)},r.prototype.getFollowedObjectsPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)this._followedObjects[t].addPositionToVector(e);e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},r.prototype.getFollowedOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},r.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||!0===this._followedObjects[e].canBeReused());)e++,s++;if(s>0){if(this._followedObjects.length===s)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(i.copyRotation4(this._relativeOrientationMatrix,this._worldOrientationMatrixValid&&this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,s),!1;this._followedObjects.splice(t,s)}}return!0},r.prototype._calculateWorldOrientationMatrix=function(t,s){var n,o,a,l=function(t){i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,this._relativeOrientationMatrix),t)}.bind(this),h=function(){this._fps?i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,this._relativeOrientationMatrix):i.copyRotation4(this._worldOrientationMatrix,this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(o=e.normalize3(e.diffVec3Mat4Aux(this.getFollowedObjectsPositionVector(),t)),this._fps){switch(this._baseOrientation){case r.BaseOrientation.WORLD:n=null;break;case r.BaseOrientation.POSITION_FOLLOWED_OBJECTS:n=s||null;break;case r.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:n=this.followsObjects()?this.getFollowedOrientationMatrix():null}n?o=e.prodMat4Vec3Aux(n,o):n=i.IDENTITY4,this._alpha=0!==o[0]||0!==o[1]?e.angle2yCapped(o[0],o[1]):0,o[0]<0&&(this._alpha=-this._alpha),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,i.rotationZ4Aux(this._alpha)),this._beta=e.angle3uCapped(e.getRowC43ScaledAux(this._worldOrientationMatrix,-1),o),o[2]>0&&(this._beta=-this._beta),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,i.rotationX4Aux(this._beta)),i.rotationZ4Aux(this._alpha)),i.mulRotationRotation4(this._worldOrientationMatrix,n)}else this._worldOrientationMatrix[8]=o[0],this._worldOrientationMatrix[9]=o[1],this._worldOrientationMatrix[10]=o[2],this._worldOrientationMatrix[11]=0,a=e.cross3Aux(e.UNIT3_X,o),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],this._worldOrientationMatrix[7]=0,a=e.cross3Aux(o,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix[3]=0,this._worldOrientationMatrix[12]=0,this._worldOrientationMatrix[13]=0,this._worldOrientationMatrix[14]=0,this._worldOrientationMatrix[15]=1,i.correctOrthogonal4(this._worldOrientationMatrix);else;else l(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case r.PointToFallback.WORLD:h();break;case r.PointToFallback.STATIONARY:i.setIdentity4(this._worldOrientationMatrix);break;case r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:s?l(s):h()}else h();this._worldOrientationMatrixValid=!0},r.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrixValid||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},r.prototype.update=function(s,n){var o;if(!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==r.PointToFallback.STATIONARY)return this._fixed||(this._fps?(this._alpha+=s[1]*n/1e3,this._beta+=s[0]*n/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),i.setProd3x3SubOf4(this._relativeOrientationMatrix,i.rotationX4Aux(this._beta*t.RAD),i.rotationZ4Aux(this._alpha*t.RAD))):(o=t.RAD*n/1e3,this._followedObjects.length>0?i.mulRotationRotation4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normalize3(e.getRowB43Aux(this._relativeOrientationMatrix)),s[2]*o),i.rotation4Aux(e.normalize3(e.getRowA43Aux(this._relativeOrientationMatrix)),s[0]*o),i.rotation4Aux(e.normalize3(e.getRowC43Aux(this._relativeOrientationMatrix)),s[1]*o))):i.mulRotationRotation4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normalize3(e.getRowC43Aux(this._relativeOrientationMatrix)),s[2]*o),i.rotation4Aux(e.normalize3(e.getRowA43Aux(this._relativeOrientationMatrix)),s[0]*o),i.rotation4Aux(e.normalize3(e.getRowB43Aux(this._relativeOrientationMatrix)),s[1]*o))))),!(!this._isTransitionConfiguration&&!this._cleanupFollowedObjects())&&(this._worldOrientationMatrixValid=!1,!0)},n.makeObject3DMixinClass.call(a),a.prototype.init=function(t,e,i,s,o,r,a,l){n.Object3D.prototype.init.call(this,e.pM,i.oM),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=s,this._fov=s,this._minFOV=o?o[0]:s,this._maxFOV=o?o[1]:s,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null},a.prototype.copy=function(e,s){var n=new a(e||t.EMPTY_STRING,this._positionConfiguration.copy(s),this._orientationConfiguration.copy(s),this._fov,[this._minFOV,this._maxFOV],this._span);return n.setPositionMatrix(i.copy(this.pM)),n.setOrientationMatrix(i.copy(this.oM)),n},a.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._resetsOnFocusChange&&!e&&this.resetToDefaults(!0)},a.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},a.prototype.moveByVector=function(t,e){this._positionConfiguration.moveByVector(t,e)},a.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},a.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},a.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},a.prototype.getFOV=function(){return this._fov},a.prototype.decreaseFOV=function(){return this.setFOV(.95*this._fov,!0),this._fov},a.prototype.increaseFOV=function(){return this.setFOV(1.05*this._fov,!0),this._fov},a.prototype.getSpan=function(){return this._span},a.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},a.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},a.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},a.prototype.update=function(t,e,i){var s=!0;return s=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this.pM,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),s=this._positionConfiguration.update(this.oM,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&s,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this.oM)),s},a.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},a.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},a.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},a.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},a.prototype.setToFree=function(e,s,n,o,a,l,h){var c=i.getYawAndPitch(n);this._positionConfiguration.init(!1,!1,!1,[],!1,s,null,null,!1),this._orientationConfiguration.init(!1,!1,e,[],n,Math.degrees(c.yaw),Math.degrees(c.pitch),void 0,void 0,r.BaseOrientation.WORLD,r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),this.init(t.EMPTY_STRING,this._positionConfiguration,this._orientationConfiguration,o,[a,l],h)},a.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},h.Stereoscopy={NONE:0,LEFT:1,RIGHT:2},h.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(h.TransitionStyle),h.prototype.init=function(t,e,s,n,o,r,a){this._object3D.init(i.IDENTITY4,i.IDENTITY4,i.IDENTITY4),this._scene=t,this._aspect=e,this._usesVerticalValues=s,this._viewDistance=n,this._previousConfiguration=null,this._currentConfiguration=o,this._currentConfiguration.setCamera(this),this._transitionStyle=h.TransitionStyle.NONE,this._defaultTransitionStyle=a||h.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=r||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,i.setIdentity4(this._projectionMatrix),this._projectionMatrixValid=!1,this._followedNode=null,i.setIdentity4(this._viewMatrix),this._viewMatrixValid=!1,i.setIdentity4(this._inversePositionMatrix),this._inversePositionMatrixValid=!1,i.setIdentity4(this._inverseOrientationMatrix),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._updateFOV(),this._updateSpan()},h.prototype.setViewDistance=function(t){this._viewDistance=t,this._updateProjectionMatrix(this._fov,this._span)},h.prototype.getCameraPositionMatrix=function(){return i.copyTranslation4(this._posMatrix,this._object3D.pM),this._posMatrix},h.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},h.prototype.getCameraOrientationMatrix=function(){return i.copyRotation4(this._oriMatrix,this._object3D.oM),this._oriMatrix},h.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setPositionv=function(t){this._object3D.setPositionv(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setPositionM4=function(t){this._object3D.setPositionM4(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},h.prototype._setOrientationM4=function(t){this._object3D.setOrientationM4(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},h.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix()},h.prototype.moveToPosition=function(t,e,s){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,s),this._currentConfiguration.setRelativePositionMatrix(i.translation4v(t),!0)},h.prototype.getViewMatrix=function(){return this._viewMatrixValid||(i.setProdTranslationRotation4(this._viewMatrix,this.getInversePositionMatrix(),this.getInverseOrientationMatrix()),this._viewMatrixValid=!0),this._viewMatrix},h.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrixValid||(i.setInverseOfTranslation4(this._inversePositionMatrix,this.getCameraPositionMatrix()),this._inversePositionMatrixValid=!0),this._inversePositionMatrix},h.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrixValid||(i.setInverseOfRotation4(this._inverseOrientationMatrix,this.getCameraOrientationMatrix()),this._inverseOrientationMatrixValid=!0),this._inverseOrientationMatrix},h.prototype.getConfiguration=function(){return this._currentConfiguration},h.prototype.getProjectionMatrix=function(){return this._projectionMatrixValid||this._updateProjectionMatrix(this.getFOV(),this.getSpan()),this._projectionMatrix},h.prototype._updateProjectionMatrix=function(e,s){this._near=.5*s/Math.tan(e*t.RAD*.5),this._usesVerticalValues?i.setPerspective4(this._projectionMatrix,s*this._aspect*.5,.5*s,this._near,this._viewDistance):i.setPerspective4(this._projectionMatrix,.5*s,s/this._aspect*.5,this._near,this._viewDistance),this._projectionMatrixValid=!0},h.prototype.setAspect=function(t){this._aspect!==t&&(this._aspect=t,this._projectionMatrixValid=!1)},h.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},h.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrixValid=!1},h.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrixValid=!1},h.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrixValid=!1},h.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},h.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},h.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},h.prototype._getFreeCameraConfiguration=function(t,e,s){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),s=s||this.getCameraOrientationMatrix(),t&&(s=i.prod3x3SubOf4Aux(i.ROTATION_X_90,s)),l(t,e,s,this.getFOV(),this._currentConfiguration._minFOV,this._currentConfiguration._maxFOV,this.getSpan())},h.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._previousConfiguration=null,this._updateFOV(),this._updateSpan(),this._updateProjectionMatrix(this._fov,this._span),this._currentConfiguration.setCamera(this,e)},h.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},h.prototype.transitionToFreeCamera=function(t,e,i,s,n){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),s,n)},h.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},
h.prototype.transitionToSameConfiguration=function(e,i){var s=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy(t.EMPTY_STRING,!0),!0),this.startTransitionToConfiguration(s,e,i)},h.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},h.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.getFollowedNode=function(){return this._followedNode},h.prototype.moveToOrigoIfNeeded=function(t){var e=this.getCameraPositionMatrix(),s=null;return(e[12]>t||e[12]<-t||e[13]>t||e[13]<-t||e[14]>t||e[14]<-t)&&(s=[-e[12],-e[13],-e[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(i.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(s,!0)),s},h.prototype.followNode=function(t,e,i,s,n){var o,r;return!e&&this._followedNode===t||(this._followedNode=t,this._followedNode?(n&&(o=this._followedNode.getCameraConfigurationsWithName(n),o.length>0&&(r=o[0])),!!(r=r||this._followedNode.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,s),!0)):(n&&(o=this._scene.getCameraConfigurationsWithName(n),o.length>0&&(r=o[0])),!!(r=r||this._scene.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,s),!0)))},h.prototype.followObject=function(t,e,i,s,n){return this.followNode(t._node,e,i,s,n)},h.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},h.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},h.prototype.followNextNode=function(t,e,i){for(var s=this._scene.getNextNode(this._followedNode),n=this._followedNode;s!==n&&s&&(!s.getNextCameraConfiguration()||!s.isVisible());)if(n||(n=s),s=this._scene.getNextNode(s),t&&this._followedNode&&s===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))return!0;return!!(s&&s.getNextCameraConfiguration()&&s.isVisible())&&this.followNode(s,!0,e,i)},h.prototype.followPreviousNode=function(t,e,i){for(var s=this._scene.getFirstNode(),n=this._scene.getPreviousNode(this._followedNode),o=this._followedNode;n!==o&&n&&(!n.getNextCameraConfiguration()||!n.isVisible());){if(o||(o=n),t&&n===s&&this.followNode(null,!0,e,i))return;n=this._scene.getPreviousNode(n)}n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)},h.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},h.prototype._getTransitionProgress=function(){var t;if(0===this._transitionDuration)return 0;switch(this._transitionStyle){case h.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case h.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t}return-1},h.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV()},h.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},h.prototype.update=function(t){var s,n,o,r,a,l,h;if(this._extendedCameraValid=!1,this._combinedExtendedCameraValid=!1,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),l=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);s=this._previousConfiguration.getPositionVector(),n=this._currentConfiguration.getPositionVector(),o=this.getCameraPositionVector(),this._setPositionv(e.sum3Aux(e.scaled3Aux(s,1-l),e.scaled3Aux(n,l))),t>0?(e.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),e.diff3Aux(this.getCameraPositionVector(),o)),e.scale3(this._velocityVector,1e3/t)):(this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0),r=i.prod3x3SubOf4Aux(i.inverseOfRotation4Aux(this._previousConfiguration.oM),this._currentConfiguration.oM),a=i.getRotations(r),this._setOrientationM4(i.IDENTITY4),this._rotate(a.gammaAxis,a.gamma*l),this._rotate(a.alphaAxis,a.alpha*l),h=i.prod3x3SubOf4Aux(this._previousConfiguration.oM,this.getCameraOrientationMatrix()),i.correctOrthogonal4(h),this._setOrientationM4(h),this._updateFOV(l),this._updateSpan(l),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);o=this.getCameraPositionVector(),this._setPositionM4(this._currentConfiguration.pM),this._setOrientationM4(this._currentConfiguration.oM),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector&&t>0?(e.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),e.diff3Aux(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),e.scale3(this._velocityVector,1e3/t)):(this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0),this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):t>0?(e.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),e.diff3Aux(this.getCameraPositionVector(),o)),e.scale3(this._velocityVector,1e3/t)):(this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0)}},h.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCameraValid?i=this._extendedCamera:t&&this._combinedExtendedCameraValid?i=this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=t?this._combinedExtendedCamera:this._extendedCamera,i?(i.getConfiguration().setToFree(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,e,e,e),i.init(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,i.getConfiguration())):i=new h(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,l(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,e)),i.update(0),t?(this._combinedExtendedCameraValid=!0,this._combinedExtendedCamera=i):(this._extendedCameraValid=!0,this._extendedCamera=i)),i},{CAMERA_EXTENSION_FACTOR:5,CameraPositionConfiguration:o,CameraOrientationConfiguration:r,CameraConfiguration:a,Camera:h,getFreeCameraConfiguration:l}}),define("modules/scene/renderable-objects",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/scene/object-3d"],function(t,e,i,s,n,o){"use strict";function r(e){switch(e){case t.ScaleMode.WIDTH:return 0;case t.ScaleMode.HEIGHT:return 1;case t.ScaleMode.ASPECT:return 2;case t.ScaleMode.MINIMUM:return 3;case t.ScaleMode.MAXIMUM:return 4}}function a(t,e,i,s,n){this._node=null,this._shader=t,this._textures={},this._textureRoles=[],this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e||e,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=s||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===n||n,this._wasRenderedToShadowMap=!1,this._name=null}function l(t,e,i,s,n,r,l,h,c,u){a.call(this,t,e,i,l),o.Object3D.call(this,s,n,r,h,c,u),this._visibleSize={width:-1,height:-1},this._visibleSizeUpdated=!1,this._smallestSizeWhenDrawn=0}function h(t){l.call(this,t)}function c(t,e,s,n,o){a.call(this,e,!1,!0),this._model=t,this._samplerName=s,this._camera=o,this.setTexture(s,n),this.setUniformValueFunction(C,function(){return i.inverse4Aux(i.prod4Aux(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function u(t,e,s,n,o,r,a,h,c){l.call(this),this._model=null,this._wireframe=!1,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors=null,this._staticLOD=this.LOD_NOT_SET,t&&this.init(t,e,s,n,o,r,a,h,c),this.setUniformValueFunction(A,function(){return this.getModelMatrix()}),this.setUniformValueFunction(v,function(){return i.transposed3Aux(i.inverse3Aux(i.matrix3from4Aux(this.getModelMatrix())))})}function _(t,e,i,s,n,o,r,a,l,h,c){u.call(this),this._parameterArrays=null,t&&this.init(t,e,i,s,n,o,r,a,l,h,c)}function p(t,e,i,s,n,o,r,a){l.call(this),this._model=null,this._wireframe=!1,this._renderPosition=[0,0,0,0],this._renderDirection=[0,0,0,0],t&&this.init(t,e,i,s,n,o,r,a),this.setUniformValueFunction(D,function(){return this.copyPositionToVector(this._renderPosition),this._renderPosition}),this.setUniformValueFunction(w,function(){return this._renderDirection})}function d(t){l.call(this),this._detached=!1,t&&this.init(t),this.setUniformValueFunction(A,function(){return this.getModelMatrix()})}function g(t,e,i,s,n,o,r,a,h,c,u,_,p,d,g){l.call(this),this._model=null,this._wireframe=!1,this._sizeVector=[0,0,0],this._startPosition=[0,0,0],this._endPosition=[0,0,0],this._startDirection=[0,0,0],this._endDirection=[0,0,0],this._direction=[0,0,0],this._startColor=[0,0,0,0],this._endColor=[0,0,0,0],this._duration=0,this._startTimeLeft=0,this._endTimeLeft=0,t&&this.init(t,e,i,s,n,o,r,a,h,c,u,_,p,d,g),this.setUniformValueFunction(V,function(){return this._startPosition}),this.setUniformValueFunction(F,function(){return this._endPosition}),this.setUniformValueFunction(U,function(){return this._startDirection}),this.setUniformValueFunction(B,function(){return this._endDirection}),this.setUniformValueFunction(P,function(){return this._sizeVector}),this.setUniformValueFunction(L,function(){return this._startColor}),this.setUniformValueFunction(R,function(){return this._endColor})}function m(t,e,i){this.color=t||Y,this.size=void 0!==e?e:1,this.timeToReach=i||0}function f(t,i,s,n,o,r,a,h){l.call(this),this._smallestSizeWhenDrawn=.1,this._model=t,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._positionVector=[0,0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._worldVelocityDirectionVector=[0,0,0],this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._duration=0,t&&this.init(t,i,s,n,o,r,a,h),this.setUniformValueFunction(D,function(){var t;return t=this.getModelMatrix(),this._positionVector[0]=t[12],this._positionVector[1]=t[13],this._positionVector[2]=t[14],this._positionVector}),this.setUniformValueFunction(O,function(){return this._color}),this.setUniformValueFunction(w,function(){return e.floatVector3Aux(this.getWorldVelocityDirectionVector())})}function S(t,e,i,s,n,o,r,a,l){t.init(e,i,s,r,[new m(n,o,0),new m(n,0,a)],!1,l)}function T(t,e,i,s,n,o,r,a){var l=new f;return S(l,t,e,i,s,n,o,r,a),l}function E(t,e,i,s,n,o,r){return new f(t,e,i,o,[new m(s,n,0)],!1,r)}function y(s,n,o,r,a,l,h){var c,u,_,p={yaw:0,pitch:0,roll:0};f.call(this,s,n,o,l,[new m(r,a,0)],!1),_=[0,1],e.rotate2(_,h),c=[_[0],0,_[1]],u=e.normalize3(i.translationVector3(l)),e.getYawAndPitch(p,u),_=[0,_[1]],e.rotate2(_,p.pitch),c=[c[0],_[0],_[1]],_=[c[0],_[0]],e.rotate2(_,p.yaw),c=[_[0],_[1],c[2]],this.setOrientationMatrix(i.lookTowards4(e.scaled3Aux(u,-1),c)),this._positionVector.length=3,this._calculatedSize=[a],this.setUniformValueFunction(N,function(e){return e===t.EMPTY_STRING?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(A,function(){return this.getModelMatrix()})}function M(t,e,i,s,n,o){a.call(this,e,!1,!0,i),this._positionVector=s,this._model=t,this._color=n,this._range=o,this._shift=null,this.setUniformValueFunction(D,function(){return this._positionVector}),this._color&&(this._shift=[0,0,0],this.setUniformValueFunction(O,function(){return this._color}),this.setUniformValueFunction(b,function(){return this._shift}),this.setUniformValueFunction(x,function(){return this._range}))}function I(t,e,s,n,o,l,h,c,u,_){a.call(this,e,!1,!0),this.setTextures(s),this._model=t,this._position=n,this._color=h,this._size=o,this._scaleMode=r(l),this._rotationMatrix=i.rotation2(Math.radians(c||0)),this._clipCoordinates=u||W.slice(),this._clipColor=_||[0,0,0,0],this.setUniformValueFunction(D,function(){return this._position}),this.setUniformValueFunction(P,function(){return this._size}),this.setUniformValueFunction(H,function(){return this._scaleMode}),this.setUniformValueFunction(O,function(){return this._color}),this.setUniformValueFunction(G,function(){return this._rotationMatrix}),this.setUniformValueFunction(k,function(){return this._clipCoordinates}),this.setUniformValueFunction(j,function(){return this._clipColor})}var C="viewDirectionProjectionInverse",A="modelMatrix",v="normalMatrix",N="billboardSize",O="color",L="startColor",R="endColor",b="shift",x="farthestZ",D="position",w="direction",P="size",V="startPosition",F="endPosition",U="startDirection",B="endDirection",H="scaleMode",G="rotationMatrix",k="clipCoords",j="clipColor",W=[0,1,0,1],Y=[1,1,1,1];return a.prototype.init=function(t,e,i,s,n){this._shader=t,this._textures={},this._textureRoles.length=0,this._isRenderedWithDepthMask=void 0===e||e,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=s||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===n||n,this._name=null},a.prototype.getShader=function(){return this._shader},a.prototype.setShader=function(t){this._shader=t},a.prototype._updateTextures=function(){var t,e,i;for(this._textureRoles=Object.keys(this._textures),t=0;t<this._textureRoles.length;t++){if(e=this._textureRoles[t],this._textures[e]instanceof n.ManagedTexture)i=n.getUniformName(n.getTextureUniformRawName(e));else{if(!(this._textures[e]instanceof n.ManagedCubemap)){s.showError("Attempting to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context.");continue}i=n.getUniformName(n.getCubemapUniformRawName(e))}this._uniformValueFunctions[i]=this._uniformValueFunctions[i]||this._getTextureLocation.bind(this,e)}},a.prototype.setTexture=function(t,e){this._textures[t]=e,this._updateTextures()},a.prototype.setTextures=function(t){this._textures=t,t&&this._updateTextures()},a.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[n.getUniformName(t)]=e.bind(i||this)},a.prototype._getTextureLocation=function(t,e){return this._textures[t].getLastTextureBindLocation(e)},a.prototype.addToContext=function(t){var e,i;for(this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader),i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.addTexture(this._textures[e])},a.prototype.bindTextures=function(t){var e,i;for(i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.bindTexture(this._textures[e])},a.prototype.markAsReusable=function(t){this._canBeReused=!0,this._node&&this._node.handleObjectBecameReusable(t)},a.prototype.canBeReused=function(){return this._canBeReused},a.prototype.isVisible=function(){return this._visible&&(!this._node||this._node.isVisible())},a.prototype.getRenderQueueBits=function(){return this._visible?1:0},a.prototype.prepareForInstancedRender=function(t,e,i,s){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),t.getCurrentShader()===this._instancedShader&&(this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,s))},a.prototype.mightBeRendered=function(){return!0!==this._canBeReused&&this._visible},a.prototype.shouldBeRendered=function(t){return t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask},a.prototype.prepareForRender=function(t){t.useInstancing&&t.context.getCurrentShader()===this._instancedShader?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),t.context.getCurrentShader()===this._shader&&(this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions)))},a.prototype.performRender=function(){return!0},a.prototype.render=function(t){return!!this.shouldBeRendered(t)&&(this.prepareForRender(t),t.useInstancing||this.performRender(t),!0)},a.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},a.prototype.mightBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},a.prototype.shouldBeRenderedToShadowMap=function(){return!0},a.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},a.prototype.prepareForRenderToShadowMap=function(){return!0},a.prototype.performRenderToShadowMap=function(){return!0},a.prototype.renderToShadowMap=function(t){return this.shouldBeRenderedToShadowMap(t)?(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},a.prototype.shouldAnimate=function(t){return t>0},a.prototype.performAnimate=function(){return!0},a.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},a.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},a.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},l.prototype=new a,o.makeObject3DMixinClass.call(l),l.prototype.constructor=a,l.prototype.init=function(t,e,i,s,n,r,l,h,c,u){a.prototype.init.call(this,t,e,i,l),o.Object3D.prototype.init.call(this,s,n,r,h,c,u),this._visibleSize={width:-1,height:-1},this._smallestSizeWhenDrawn=0},l.prototype.updateVisibleSize=function(t,e){return this._visibleSizeUpdated||(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSizeUpdated=e,this._visibleSize},l.prototype.getSizeInPixels=function(t){return Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},l.prototype.resetForNewFrame=function(){l.prototype.resetCachedValues.call(this)},l.prototype.getRenderQueueBits=function(t,e){var i,s,n=0;return this.isInsideParent()?e:(i=this.getPositionMatrixInCameraSpace(t),this.getCascadeScalingMatrix(),s=this.getSize()*this._largestScalingFactor,i[14]-s<=-t._near&&i[14]+s>-t._viewDistance&&(n|=1),i[14]-s<=-t._viewDistance&&i[14]+s>-t.getExtendedCamera()._viewDistance&&(n|=2),n)},l.prototype.shouldBeRendered=function(t){var e,i;return a.prototype.shouldBeRendered.call(this,t)?!0===this.isInsideParent()?(e=t.parent._visibleSize,e.width>0?(i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)):(e=this.updateVisibleSize(t,!1),e.width>0&&this.getSizeInPixels(t)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)},l.prototype.shouldBeRenderedToShadowMap=function(t){return!0===this.isInsideParent()?t.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(t.light)},h.prototype=new l,h.prototype.constructor=h,h.prototype.shouldBeRendered=function(t){return this._visibleSize=t.parent._visibleSize,!1},c.prototype=new a,c.prototype.constructor=c,c.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},c.prototype.performRender=function(t){this._model.render(t.context,!1)},u.prototype=new l,u.prototype.constructor=u,u.prototype.LOD_NOT_SET=-1,u.prototype.init=function(t,e,i,s,n,o,r,a,h){l.prototype.init.call(this,e,!0,!0,s,n,o),this._smallestSizeWhenDrawn=h||5,this.setTextures(i),this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==a?a:this.LOD_NOT_SET;for(var c=this._model._minLOD;c<=this._model.getMaxLOD();c++)this._model.getSize(c)>this._modelSize&&(this._modelSize=this._model.getSize(c))},u.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},u.prototype.getModel=function(){return this._model},u.prototype.getSize=function(){return this._modelSize},u.prototype.setModelSize=function(t){this._modelSize=t},u.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},u.prototype.getHeight=function(){return this._model.getHeight()},u.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},u.prototype.getDepthInMeters=function(){return this._model.getDepthInMeters()},u.prototype.getMaxY=function(){return this._model.getMaxY()},u.prototype.getCurrentLOD=function(t){var e,i,s;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else{if(!t)return this.LOD_NOT_SET;if(this.updateVisibleSize(t,!0),e=this.getSizeInPixels(t),(i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e)>0)for(s=Math.min(this._model.getMaxLOD(),t.lodContext.maxEnabledLOD);s>=this._model._minLOD;s--)if(t.lodContext.thresholds[s]<=i){this._currentLOD=s;break}}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:0},u.prototype.setStaticLOD=function(t){this._staticLOD=t,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET},u.prototype.resetForNewFrame=function(){l.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},u.prototype.shouldBeRendered=function(t){if(l.prototype.shouldBeRendered.call(this,t)){if(!0===this._wireframe)return!0;if(!0===t.depthMask){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(!1===t.depthMask&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},u.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},u.prototype.shouldBeRenderedToShadowMap=function(t){if(l.prototype.shouldBeRenderedToShadowMap.call(this,t))return this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0},u.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},u.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t))},_.prototype=new u,_.prototype.constructor=_,_.prototype.init=function(t,e,i,o,r,a,l,h,c,_,p){var d,g,m,f;for(u.prototype.init.call(this,t,e,i,o,r,a,l,h,c),this._parameterArrays={},f=Object.keys(_),d=0;d<f.length;d++)if(g=n.getUniformName(f[d]),(m=e.getUniformArrayLength(g))>0){if(p)this._parameterArrays[f[d]]=p._parameterArrays[f[d]];else{switch(_[f[d]]){case n.ShaderVariableType.FLOAT:break;case n.ShaderVariableType.MAT4:m*=16;break;default:s.showError("Cannot create uniform parameter array with elements of type: '"+_[f[d]]+"'!")}this._parameterArrays[f[d]]=new Float32Array(m),this._parameterArrays[f[d]].fill(0)}this.setUniformValueFunction(f[d],this.createGetParameterArrayFunction(this._parameterArrays[f[d]]))}else this._parameterArrays[f[d]]=new Float32Array},_.prototype.createGetParameterArrayFunction=function(t){return function(){return t}},_.prototype.hasParameterArray=function(t){return!!this._parameterArrays[t]&&this._parameterArrays[t].length>0},_.prototype.setFloatParameter=function(t,e,i){this._parameterArrays[t][e]=i},_.prototype.setMat4Parameter=function(t,e,i){this._parameterArrays[t].set(i,16*e)},_.prototype.setParameterArray=function(t,e){this._parameterArrays[t].set(e,0)},p.prototype=new l,p.prototype.constructor=p,p.prototype.init=function(t,s,n,o,r,a,h,c){l.prototype.init.call(this,s,!1,!0,a,h,i.scaling4Aux(o),c),this.setTextures(n),e.setRowB43(this._renderDirection,this.oM),this._renderDirection[3]=1,this._renderPosition[3]=o,this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},p.prototype.getModel=function(){return this._model},p.prototype.getCurrentLOD=function(){return 0},p.prototype.updateDirection=function(){e.setRowB43(this._renderDirection,this.oM)},p.prototype.setDirectionW=function(t){this._renderDirection[3]=t},p.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},p.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},p.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},p.prototype.mightBeRenderedToShadowMap=function(){return!1},p.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},d.prototype=new l,d.prototype.constructor=d,d.prototype.init=function(t){l.prototype.init.call(this,null,!1,!1,null,null,null,null,t,!0,!0),this._detached=!1},d.prototype.detach=function(){this._detached=!0},d.prototype.performAnimate=function(){this._detached&&0===this._node._subnodes._length&&this.markAsReusable(!0)},d.prototype.translatev=function(t){var e;for(o.Object3D.prototype.translatev.call(this,t),e=this._node._subnodes._first;e;e=e.next)e._renderableObject.translatev(t)},g.prototype=new l,g.prototype.constructor=g,g.prototype.init=function(t,s,n,o,r,a,h,c,u,_,p,d,g,m,f){l.prototype.init.call(this,s,!1,!0,i.translation4vAux(a),i.IDENTITY4,i.scaling4Aux(o),f),this.setTextures(n),e.setVector3(this._startPosition,a),e.setVector3(this._endPosition,c),e.setVector3(this._startDirection,h),e.setVector3(this._endDirection,u),e.setVector4(this._startColor,_),e.setVector4(this._endColor,p),this._duration=d,this._startTimeLeft=g,this._endTimeLeft=m,this._sizeVector[0]=o,this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},g.prototype.shouldBeRendered=function(t){return a.prototype.shouldBeRendered.call(this,t)},g.prototype.translatev=function(t){e.add3(this._startPosition,t),e.add3(this._endPosition,t)},g.prototype.getModel=function(){return this._model},g.prototype.getCurrentLOD=function(){return 0},g.prototype.getEndDirection=function(){return this._endDirection},g.prototype.getEndTimeLeft=function(){return this._endTimeLeft},g.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},g.prototype.performAnimate=function(t){var i;if(this._startTimeLeft-=t,this._endTimeLeft-=t,this._endTimeLeft<=0)return this._startTimeLeft=0,this._endTimeLeft=0,void this.markAsReusable(!0);this._startTimeLeft<0&&(e.setDiff3(this._direction,this._endPosition,this._startPosition),i=e.extractLength3(this._direction),e.add3(this._startPosition,e.scaled3Aux(this._direction,i*(1-this._endTimeLeft/(this._endTimeLeft-this._startTimeLeft)))),this._startTimeLeft=0),this._sizeVector[1]=this._startTimeLeft/this._duration,this._sizeVector[2]=this._endTimeLeft/this._duration},g.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},g.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},g.prototype.mightBeRenderedToShadowMap=function(){return!1},g.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},f.prototype=new l,f.prototype.constructor=f,f.prototype.init=function(e,s,n,o,r,a,h,c){l.prototype.init.call(this,s,!1,!0,o,i.IDENTITY4,i.IDENTITY4,h),this.setTextures(n),this._model=e,r?(this._color[0]=r[0].color[0],this._color[1]=r[0].color[1],this._color[2]=r[0].color[2],this._color[3]=r[0].color[3],this._states=r):this._states=t.EMPTY_ARRAY,this._size=void 0!==c?c:r?r[0].size:0,this._relativeSize=1,this._calculateSize(),this._calculateDuration(),this._currentStateIndex=0,this._looping=!0===a,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._worldVelocityDirectionVector[0]=0,this._worldVelocityDirectionVector[1]=0,this._worldVelocityDirectionVector[2]=0,this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._updateShouldAnimate()},f.prototype._calculateDuration=function(){var t;for(this._duration=0,t=1;t<this._states.length;t++)this._duration+=this._states[t].timeToReach},f.prototype._calculateSize=function(){this._positionVector[3]=this._size*this._relativeSize,this._visible=this._positionVector[3]>=.01},f.prototype.getSize=function(){return this._positionVector[3]},f.prototype.getFinalSize=function(){return 0===this._states.length?this._size:this._states[this._states.length-1].size},f.prototype.getMaxSize=function(){var t,e;if(0===this._states.length)return this._size;for(t=0,e=0;e<this._states.length;e++)this._states[e].size>t&&(t=this._states[e].size);return t},f.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},f.prototype.rotateByMatrix=function(t){this._velocityVector?(e.mulVec3Mat4(this._velocityVector,t),this._updateVelocity()):l.prototype.rotateByMatrix.call(this,t)},f.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},f.prototype._updateVelocity=function(){this._worldVelocityDirectionVectorValid=!1,this._updateShouldAnimate()},f.prototype.setRelativeSize=function(t){this._relativeSize=t,this._calculateSize()},f.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateVelocity()},f.prototype.setVelocity=function(t,e,i){this._velocityVector[0]=t,this._velocityVector[1]=e,this._velocityVector[2]=i,this._updateVelocity()},f.prototype.setVelocityM=function(t){this._velocityVector[0]=t[12],this._velocityVector[1]=t[13],this._velocityVector[2]=t[14],this._updateVelocity()},f.prototype.getWorldVelocityDirectionVector=function(){return this._worldVelocityDirectionVectorValid||(e.setProdVec3Mat4(this._worldVelocityDirectionVector,this._velocityVector,this.getModelMatrix()),e.normalize3(this._worldVelocityDirectionVector),
this._worldVelocityDirectionVectorValid=!0),this._worldVelocityDirectionVector},f.prototype.invalidateWorldVelocityDirectionVector=function(){this._worldVelocityDirectionVectorValid=!1},f.prototype.setAnimationTime=function(t){this._currentStateIndex=0,this._timeSinceLastTransition=0,this.performAnimate(t)},f.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},f.prototype.getRenderQueueBits=function(t,e){return this._visible?l.prototype.getRenderQueueBits.call(this,t,e):0},f.prototype.performRender=function(t){this._model.render(t.context,!1)},f.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},f.prototype.mightBeRenderedToShadowMap=function(){return!1},f.prototype.shouldAnimate=function(t){return!!l.prototype.shouldAnimate.call(this,t)&&this._shouldAnimate},f.prototype.performAnimate=function(t){var i,s,n;if(this._states.length>1){for(this._timeSinceLastTransition+=t,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping)return this._size=0,void this.markAsReusable(!0);this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}for(this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,n=0;n<4;n++)this._color[n]=this._states[this._currentStateIndex].color[n]*(1-s)+this._states[i].color[n]*s;this._size=this._states[this._currentStateIndex].size*(1-s)+this._states[i].size*s,this._calculateSize()}this._hasVelocity()&&this.translatev(e.scaled3Aux(this._velocityVector,.001*t))},f.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},y.prototype=new f,y.prototype.constructor=y,y.prototype._calculateSize=function(){return!0},y.prototype.shouldBeRendered=function(t){return a.prototype.shouldBeRendered.call(this,t)},M.prototype=new a,M.prototype.constructor=M,M.prototype.addToContext=function(t){this._color&&(a.prototype.addToContext.call(this,t),this._model.addToContext(t,!0))},M.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},M.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;i<3;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},M.prototype.performRender=function(t){this._model.render(t.context,!0)},M.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},M.prototype.mightBeRenderedToShadowMap=function(){return!1},M.prototype.shouldAnimate=function(){return!1},M.prototype.shouldGoInSameRenderQueueInstanced=function(t){return a.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},I.prototype=new a,I.prototype.constructor=I,I.prototype.init=function(t,e,s,n,o,l,h,c,u,_){a.prototype.init.call(this,e,!1,!0),this.setTextures(s),this._model=t,this._position=n,this._color=h,this._size=o,this._scaleMode=r(l),i.setRotation2(this._rotationMatrix,Math.radians(c||0)),this._clipCoordinates=u||W.slice(),this._clipColor=_||[0,0,0,0]},I.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},I.prototype.performRender=function(t){this._model.render(t.context)},I.prototype.setPosition=function(t){this._position=t},I.prototype.setPosition2=function(t,e){this._position[0]=t,this._position[1]=e},I.prototype.setSize=function(t){this._size=t},I.prototype.setColor=function(t){this._color=t},I.prototype.setAngle=function(t){i.setRotation2(this._rotationMatrix,t)},I.prototype.setClipCoordinates=function(t){this._clipCoordinates=t},I.prototype.clipX=function(t,e){this._clipCoordinates[0]=t,this._clipCoordinates[1]=e},I.prototype.clipY=function(t,e){this._clipCoordinates[2]=1-e,this._clipCoordinates[3]=1-t},I.prototype.setClipColor=function(t){this._clipColor=t},I.prototype.setModel=function(t){this._model=t},I.prototype.setScaleMode=function(t){this._scaleMode=r(t)},{RENDER_QUEUE_FRONT_BIT:1,RENDER_QUEUE_DISTANCE_BIT:2,UNIFORM_COLOR_NAME:O,CLIP_COORDINATES_NO_CLIP:W,RenderableObject:a,RenderableObject3D:l,ContainerObject:h,CubemapSampledFVQ:c,ShadedLODMesh:u,ParameterizedMesh:_,Billboard:p,Trail:d,TrailSegment:g,ParticleState:m,Particle:f,staticParticle:E,initDynamicParticle:S,dynamicParticle:T,BackgroundBillboard:y,PointParticle:M,UIElement:I}}),define("modules/scene/scene-graph",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/containers","modules/scene/camera","modules/scene/renderable-objects"],function(t,e,i,s,n,o,r,a,l,h){"use strict";function c(t,e,i,s,n){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=!0===i,this.referenceSize=s||m,this.minimumRelativeSize=n||f}function u(t,e,i,s,n,o,r,a,l,h,c,u){this.context=t,this.depthMask=e,this.scene=i,this.parent=s,this.camera=n,this.viewportWidth=o,this.viewportHeight=r,this.lodContext=a,this.dt=l||0,this.useInstancing=h||!1,this.instanceQueueIndex=c,this.light=u}function _(t,e,i,s){this._renderableObject=t,t._node=this,this._scene=null,this._parent=null,this._subnodes=new a.DirectDoubleLinkedList,this._visible=!0,this._renderParameters=new u,this._cameraConfigurations=null,this._isRenderedToShadowMap=!1!==e,this._hasInstancedSubnodes=i,this._instancing=!!s,this._canBeReused=!1,this.next=null,this.previous=null,this.list=null}function p(t,e,i,n,r,a,h,c,u,_,p,d,g,m){this._left=t,this._bottom=e,this._width=i,this._height=n,this._shouldClearColorOnRender=r,this._clearColorMask=a,this._clearColor=h,this._shouldClearDepthOnRender=c,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._objectsToMove=null,this._ambientColor=[0,0,0],this._directionalLights=[],this._maxRenderedDirectionalLights=_||0,this._renderedDirectionalLights=0,this._directionalLightUniformData=new Array(this._maxRenderedDirectionalLights),this._pointLightPriorityArrays=null,this._maxRenderedPointLights=p||0,this._renderedPointLights=0,this._pointLightUniformData=new Array(this._maxRenderedPointLights),this._spotLights=[],this._maxRenderedSpotLights=d||0,this._renderedSpotLights=0,this._spotLightUniformData=new Array(this._maxRenderedSpotLights),this._rootResourceNode=null,this._resourceObjectIDs=null,this._camera=new l.Camera(this,this._width/this._height,g.useVerticalValues,g.viewDistance,g.configuration||l.getFreeCameraConfiguration(g.fps,g.positionMatrix||s.IDENTITY4,g.orientationMatrix||s.IDENTITY4,g.fov,g.fovRange&&g.fovRange[0]||g.fov,g.fovRange&&g.fovRange[1]||g.fov,g.span),g.transitionDuration,g.transitionStyle),this._lodContext=u,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._cameraUniformValueFunctions={},this._constantUniformValueFunctions={},this._shadowMapDebugUniformValueFunctions={},this._shadowMapTextureUnit=0,this._shadowMapDebugUniformValueFunctions[o.getUniformName(E)]=function(){return this._shadowMapTextureUnit}.bind(this),this._contextUniformValueFunctions=[],this._contextConstantUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._contexts=[],this._distanceRendering=void 0===m||m,this._renderQueues=this._distanceRendering?[[],[],[],[]]:[[],[]],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=new Set,this._cameraUniformsUpdated=new Set,this._constantUniformsUpdated=new Set,this._initNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var d=h.RENDER_QUEUE_FRONT_BIT,g=h.RENDER_QUEUE_DISTANCE_BIT,m=100,f=.05,S=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],T=[!0,!0,!0,!0],E="shadowMapDebug";return _.prototype.canBeReused=function(){var t;if(this._canBeReused)return!0;if(this._renderableObject.canBeReused()){for(t=this._subnodes._first;t;t=t.next)if(!1===t.canBeReused())return!1;return this._canBeReused=!0,!0}return!1},_.prototype.setScene=function(t,e){var i;for(this._scene=t,t&&e&&t.addObjectToContexts(this._renderableObject),i=this._subnodes._first;i;i=i.next)i.setScene(t,e)},_.prototype.addToRenderQueue=function(t){var e;if(this._instancing){for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0]._instancing&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&!t[e][0]._instancing&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e;return t.push([this]),t.length-1},_.prototype.animateAndAddToRenderQueues=function(t,e,i,s,n){var o,r,a,l,h,c,u;if(this._visible&&(this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._scene.shouldAnimate()&&this._renderableObject.animate(s),!this._renderableObject.canBeReused()&&(h=this._renderableObject._isRenderedWithoutDepthMask,c=this._renderableObject._isRenderedWithDepthMask,(h||c)&&(e?(o=this._renderableObject.getRenderQueueBits(i,n),o&d&&(h&&this.addToRenderQueue(t[1]),c&&this.addToRenderQueue(t[0])),o&g&&(h&&this.addToRenderQueue(t[3]),c&&this.addToRenderQueue(t[2]))):(h&&this.addToRenderQueue(t[1]),c&&this.addToRenderQueue(t[0]))),this._subnodes._length>0)))if(void 0===o&&(o=e?this._renderableObject.getRenderQueueBits(i,n):d),this._hasInstancedSubnodes&&this._subnodes._first._instancing){if(this._scene.shouldAnimate())for(r=this._subnodes._first;r;r=a)a=r.next,u=r._renderableObject,u.animate(s),u.resetForNewFrame&&u.resetForNewFrame();else for(r=this._subnodes._first;r;r=a)a=r.next,u=r._renderableObject,u.resetForNewFrame&&u.resetForNewFrame();r=this._subnodes._first,r&&(h=r._renderableObject._isRenderedWithoutDepthMask,c=r._renderableObject._isRenderedWithDepthMask,(h||c)&&(o=r._renderableObject.getRenderQueueBits(i,o),o&d&&(h&&(l=r.addToRenderQueue(t[1]),t[1][l].pop(),this._subnodes.appendToArray(t[1][l])),c&&(l=r.addToRenderQueue(t[0]),t[0][l].pop(),this._subnodes.appendToArray(t[0][l]))),o&g&&(h&&(l=r.addToRenderQueue(t[3]),t[3][l].pop(),this._subnodes.appendToArray(t[3][l])),c&&(l=r.addToRenderQueue(t[2]),t[2][l].pop(),this._subnodes.appendToArray(t[2][l])))))}else for(r=this._subnodes._first;r;r=a)a=r.next,r.animateAndAddToRenderQueues(t,e,i,s,o)},_.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},_.prototype.isVisible=function(){return this._visible&&(!this._parent||this._parent.isVisible())},_.prototype.show=function(){this._visible=!0},_.prototype.hide=function(){this._visible=!1},_.prototype.toggleVisibility=function(){this._visible=!this._visible},_.prototype.addSubnode=function(t,e){return this._subnodes.add(t),t.setParent(this),this._scene&&t.setScene(this._scene,e),t},_.prototype.getFirstSubnode=function(){return this._subnodes._first},_.prototype.getNextSubnode=function(t){return this._subnodes.getNext(t)},_.prototype.getPreviousSubnode=function(t){return this._subnodes.getPrevious(t)},_.prototype.addCameraConfiguration=function(t){this._cameraConfigurations||(this._cameraConfigurations=[]),this._cameraConfigurations.push(t)},_.prototype.hasCameraConfiguration=function(t){var e;if(!this._cameraConfigurations)return!1;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},_.prototype.getNextCameraConfiguration=function(t){var e,i,s;if(!this._cameraConfigurations)return null;if((s=this._cameraConfigurations.length)<=0)return null;if(t){for(e=0;e<s;e++)if(this._cameraConfigurations[e]===t){i=e;break}if(e>=s)return}else i=-1;for(e=(i+1)%s;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+1)%s;return this._cameraConfigurations[e]},_.prototype.getPreviousCameraConfiguration=function(t){var e,i,s;if(!this._cameraConfigurations)return null;if((s=this._cameraConfigurations.length)<=0)return null;if(t){for(e=s-1;e>=0;e--)if(this._cameraConfigurations[e]===t){i=e;break}if(e<0)return}else i=s;for(e=(i+s-1)%s;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+s-1)%s;return this._cameraConfigurations[e]},_.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];if(this._cameraConfigurations)for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e]._name===t&&i.push(this._cameraConfigurations[e]);return i},_.prototype.resetCameraConfigurations=function(){var t;if(this._cameraConfigurations)for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},_.prototype.setRenderParameters=function(t,e,i,s,n,o,r){var a=this._renderParameters;a.context=t,a.depthMask=s,a.scene=this._scene,a.parent=this._parent?this._parent._renderableObject:null,a.camera=this._scene._camera,a.viewportWidth=e,a.viewportHeight=i,a.lodContext=this._scene._lodContext,a.useInstancing=n,a.instanceQueueIndex=o,a.light=r},_.prototype.render=function(t,e,i,s,n,o,r,a){var l,h;if(this._visible){if(!a&&this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._renderableObject.mightBeRendered()?(this.setRenderParameters(t,e,i,s,o,r),h=this._renderableObject.render(this._renderParameters)):h=!1,!n)for(l=this._subnodes._first;l;l=l.next)l.render(t,e,i,s,n,o,r,a);return h}return!1},_.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},_.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},_.prototype.renderToShadowMap=function(t,e,i,s){var n,o;if(this._visible&&this._isRenderedToShadowMap){for(this._renderableObject.mightBeRenderedToShadowMap()?(this.setRenderParameters(t,e,i,!0,void 0,void 0,s),o=this._renderableObject.renderToShadowMap(this._renderParameters)):o=!1,n=this._subnodes._first;n;n=n.next)n.renderToShadowMap(t,e,i,s);return o}return!1},_.prototype.execute=function(t){var e;for(t(this._renderableObject),e=this._subnodes._first;e;e=e.next)e.execute(t)},_.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=this._subnodes._first;e;e=e.next)e.addToContext(t)},_.prototype.getShader=function(){return this._renderableObject.getShader()},_.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=this._subnodes._first;e;e=e.next)e.setShader(t)},_.prototype.markAsReusable=function(t){var e,i;for(this._renderableObject.markAsReusable(t),e=this._subnodes._first;e;e=i)i=e.next,e.markAsReusable(t);this._canBeReused=!0,t&&this._parent&&this._parent.removeSubnode(this,!0)},_.prototype.handleObjectBecameReusable=function(t){t&&this._parent&&0===this._subnodes._length&&this._parent.removeSubnode(this,!0)},_.prototype.cleanUp=function(){var t,e;for(t=this._subnodes._first;t;)e=t.next,t.canBeReused()&&this._subnodes.remove(t),t=e;for(t=this._subnodes._first;t;t=t.next)t.cleanUp()},_.prototype.removeSubnode=function(t,e){this._subnodes.remove(t),e&&0===this._subnodes._length&&this._renderableObject.canBeReused()&&this._parent&&this._parent.removeSubnode(this,!0)},_.prototype.removeSubnodes=function(t){this._subnodes.clear(t)},_.prototype.destroy=function(){var t,e;if(this._renderableObject._node=null,this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=this._subnodes._first;t;t=e)e=t.next,t.destroy(),t=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null,this.next=null,this.previous=null,this.list=null},p.StereoscopicMode={NONE:"none",ANAGLYPH:"anaglyph",SIDE_BY_SIDE:"sideBySide"},p.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction("ambientColor",function(){return this._ambientColor}),this.setUniformValueFunction("numDirLights",function(){return this._renderedDirectionalLights}),this.setUniformValueFunction("dirLights",function(){return this._directionalLightUniformData}),this.setUniformValueFunction("numPointLights",function(){return this._renderedPointLights}),this.setUniformValueFunction("pointLights",function(){return this._pointLightUniformData}),this.setUniformValueFunction("numSpotLights",function(){return this._renderedSpotLights}),this.setUniformValueFunction("spotLights",function(){return this._spotLightUniformData}),this.setCameraUniformValueFunction("cameraMatrix",function(){return this._camera.getViewMatrix()}),this.setCameraUniformValueFunction("cameraOrientationMatrix",function(){return this._camera.getInverseOrientationMatrix()}),this.setCameraUniformValueFunction("aspect",function(){return this._camera._aspect}),this.setCameraUniformValueFunction("projMatrix",function(){return this._camera.getProjectionMatrix()}),this.setCameraUniformValueFunction("viewProjMatrix",function(){return s.prod4Aux(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setCameraUniformValueFunction("eyePos",function(){return i.floatVector3Aux(this._camera.getCameraPositionVector())})},p.prototype._setContextUniformValueFunctions=function(t){var e=this._contexts[t].gl,i=[0,0];this.setContextUniformValueFunction(t,"viewportSize",function(){return i[0]=e.drawingBufferWidth*this._width,i[1]=e.drawingBufferHeight*this._height,i})},p.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setConstantUniformValueFunction("shadowMapRanges",function(){return this._shadowMapRanges}),this.setConstantUniformValueFunction("shadowMapSampleOffsets",function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextConstantUniformValueFunction(t,"shadowMaps",function(){var e,i,s=[];for(e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)for(i=0;i<this._shadowMapRanges.length;i++)s.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t]._name));return new Int32Array(s)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},p.prototype._updateStaticLightUniformData=function(){var t;for(this._renderedDirectionalLights=Math.min(this._directionalLights.length,this._maxRenderedDirectionalLights),t=0;t<this._renderedDirectionalLights;t++)this._directionalLightUniformData[t]=this._directionalLights[t]._uniformData;t<this._maxRenderedDirectionalLights&&(this._directionalLightUniformData[t]=null)},p.prototype._clearDynamicLightUniformData=function(){this._renderedPointLights=0,this._pointLightUniformData[0]=null,this._renderedSpotLights=0,this._spotLightUniformData[0]=null},p.prototype._updateDynamicLightUniformData=function(t){var e,i,s,n;for(e=0,s=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&s<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].isVisible()&&(this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData[s]=this._pointLightPriorityArrays[e][i]._uniformData,s++));for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].isVisible()&&this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._renderedPointLights=s,s<this._maxRenderedPointLights&&(this._pointLightUniformData[s]=null),s=0,e=0,n=Math.min(this._spotLights.length,this._maxRenderedSpotLights);e<this._spotLights.length&&s<n;e++)this._spotLights[e].isVisible()&&(this._spotLights[e].update(t),this._spotLights[e].shouldBeRendered(this._camera)&&(this._spotLightUniformData[s]=this._spotLights[e]._uniformData,s++));this._renderedSpotLights=s,s<this._maxRenderedSpotLights&&(this._spotLightUniformData[s]=null)},p.prototype._getShadowMapBufferNamePrefix=function(t){return"shadow-map-buffer-"+t+"-"},p.prototype._getWidthInPixels=function(t){return t.gl.drawingBufferWidth*this._width},p.prototype._getHeightInPixels=function(t){return t.gl.drawingBufferHeight*this._height},p.prototype._setupContext=function(t){var e,i;if(this._constantUniformsUpdated.clear(),void 0!==t)for(i=this._contexts[t],this._setContextUniformValueFunctions(t),this._shadowMappingEnabled&&(i.addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},p.prototype.setRelativeViewport=function(t,e,i,s){this._left=t,this._bottom=e,this._width=i,this._height=s},p.prototype.addToContext=function(t){var e=this._contexts.findIndex(function(e){return e._name===t._name});e<0&&(this._contexts.push(t),e=this._contexts.length-1),this._setupContext(e),this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t)},p.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):n.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},p.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},p.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},p.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},p.prototype.setShadowMapping=function(t){t?(this._shadowMappingEnabled=void 0!==t.enable?t.enable:this._shadowMappingEnabled,this._shadowMappingShader=t.shader||this._shadowMappingShader,this._shadowMapTextureSize=t.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=t.ranges?new Float32Array(t.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=t.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=t.numSamples?e.getNumberValueInRange("shadowMappingParams.numSamples",t.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?S.length/2:0,this._shadowMappingEnabled?1:0):t.numSamples,this._shadowMapSampleOffsets=S.slice(0,2*this._numShadowMapSamples),t.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[]),this._constantUniformsUpdated.clear()},p.prototype.shouldAnimate=function(){return this._shouldAnimate},p.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},p.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},p.prototype.addBackgroundObject=function(t){var e=new _(t,!1);return this._rootBackgroundNode.addSubnode(e),e},p.prototype.addObject=function(t,e,i){return this._rootNode.addSubnode(new _(t,e,!1,i))},p.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},p.prototype.addUIObject=function(t){var e=new _(t,!1);return this._rootUINode.addSubnode(e),e},p.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},p.prototype.addObjectToMove=function(t){this._objectsToMove.push(t)},p.prototype.clear=function(t){this.clearNodes(t),this.clearDirectionalLights(),this.clearPointLights(),this.clearSpotLights()},p.prototype._initNodes=function(){this._rootBackgroundNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0),!1),this._rootBackgroundNode.setScene(this),this._rootNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0)),this._rootNode.setScene(this),this._rootResourceNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,1,!1,!0),!1),this._rootResourceNode.setScene(this),this._resourceObjectIDs={},this._rootUINode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0),!1),this._rootUINode.setScene(this),this._objectsToMove=[]},p.prototype.clearNodes=function(t){this._rootBackgroundNode&&this._rootBackgroundNode.removeSubnodes(t),this._rootNode&&this._rootNode.removeSubnodes(t),this._rootResourceNode&&this._rootResourceNode.removeSubnodes(t),this._resourceObjectIDs={},this._rootUINode&&this._rootUINode.removeSubnodes(t),this._objectsToMove.length=0},p.prototype.clearDirectionalLights=function(){this._directionalLights=[]},p.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(5),t=0;t<5;t++)this._pointLightPriorityArrays[t]=[]},p.prototype.clearSpotLights=function(){this._spotLights=[]},p.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=i._first;t;t=t.next)e.push(t._renderableObject);return e},p.prototype.getAll3DObjects=function(){var t,e,i=[],s=this._rootNode._subnodes;for(e=s._first;e;e=e.next)t=e._renderableObject,t.getPositionMatrix&&t.getOrientationMatrix&&i.push(t);return i},p.prototype.moveAllObjectsByVector=function(t){var e,i,s,n=this._rootNode._subnodes;for(s=n._first;s;s=s.next)i=s._renderableObject,i.translatev&&i.translatev(t);for(e=0;e<this._objectsToMove.length;e++)this._objectsToMove[e].translatev(t)},p.prototype.moveCameraToOrigoIfNeeded=function(t){var e=this._camera.moveToOrigoIfNeeded(t);return e&&this.moveAllObjectsByVector(e),e},p.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},p.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},p.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},p.prototype.hasResourcesOfObject=function(t){return!!this._resourceObjectIDs[t]},p.prototype.addResourcesOfObject=function(t,e){var i;e&&this._resourceObjectIDs[e]||(t&&(i=new _(t,!1),this._rootResourceNode.addSubnode(i,!0),i.markAsReusable(!1)),e&&(this._resourceObjectIDs[e]=!0))},p.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},p.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,4),this._pointLightPriorityArrays[e].push(t)},p.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},p.prototype.getLODContext=function(){return this._lodContext},p.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[o.getUniformName(t)]=e.bind(this)},p.prototype.setCameraUniformValueFunction=function(t,e){this._cameraUniformValueFunctions[o.getUniformName(t)]=e.bind(this)},p.prototype.setConstantUniformValueFunction=function(t,e){this._constantUniformValueFunctions[o.getUniformName(t)]=e.bind(this)},p.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][o.getUniformName(e)]=i.bind(this)},p.prototype.setContextConstantUniformValueFunction=function(t,e,i){this._contextConstantUniformValueFunctions[t]||(this._contextConstantUniformValueFunctions[t]={}),this._contextConstantUniformValueFunctions[t][o.getUniformName(e)]=i.bind(this)},p.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},p.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},p.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},p.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},p.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},p.prototype.hideUI=function(){this._rootUINode.hide()},p.prototype.showUI=function(){this._rootUINode.show()},p.prototype.assignUniforms=function(t,e){this._uniformsUpdated.has(e)||(e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdated.add(e),this._uniformsUpdatedForFrame=!0),this._cameraUniformsUpdated.has(e)||(e.assignUniforms(t,this._cameraUniformValueFunctions),this._cameraUniformsUpdated.add(e)),this._constantUniformsUpdated.has(e)||(e.assignUniforms(t,this._constantUniformValueFunctions),e.assignUniforms(t,this._contextConstantUniformValueFunctions[this._contexts.indexOf(t)]),this._constantUniformsUpdated.add(e))},p.prototype.cleanUpLights=function(){var t,e,i,s;for(s=0;s<this._pointLightPriorityArrays.length;s++)for(t=0;t<this._pointLightPriorityArrays[s].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[s].length&&(!this._pointLightPriorityArrays[s][e]||!0===this._pointLightPriorityArrays[s][e].canBeReused());)e++,i++;this._pointLightPriorityArrays[s].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||!0===this._spotLights[e].canBeReused());)e++,i++;this._spotLights.splice(t,i)}},p.prototype._renderShadowMap=function(t,e,i,s){var n,r,a=t.gl;if(this._shadowQueue.length>0){for(o.areDepthTexturesAvailable()?a.clear(a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),r=[],n=0;n<this._shadowQueue.length;n++)this._shadowQueue[n].renderToShadowMap(t,e,i,s)&&r.push(this._shadowQueue[n]);this._shadowQueue=r}},p.prototype._renderShadowMaps=function(t,e,i){var s,n,o,r=t.gl;if(this._shadowMappingEnabled){for(r.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),r.clearColor(0,0,0,0),t.setColorMask(T),t.disableBlending(),t.setDepthMask(!0),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),s=0;s<this._directionalLights.length&&s<this._maxRenderedDirectionalLights;s++){for(this._directionalLights[s].reset(),this._shadowQueue=new Array(this._rootNode._subnodes._length),n=0,o=this._rootNode._subnodes._first;o;o=o.next,n++)this._shadowQueue[n]=o;for(n=this._shadowMapRanges.length-1;n>=0;n--)this._directionalLights[s].startShadowMap(t,this._camera,n,this._shadowMapRanges[n],this._shadowMapRanges[n]*this._shadowMapDepthRatio),this._renderShadowMap(t,e,i,this._directionalLights[s])}for(s=0;s<this._directionalLights.length&&s<this._maxRenderedDirectionalLights;s++)for(n=0;n<this._shadowMapRanges.length;n++)t.bindTexture(t.getFrameBuffer(this._directionalLights[s].getShadowMapBufferName(n)),void 0,!0)}t.setCurrentFrameBuffer(null)},p.prototype._renderBackgroundObjects=function(t,e,i){t.enableBlending(),t.setDepthMask(!1),this._rootBackgroundNode.render(t,e,i,!1)},p.prototype._renderQueue=function(t,e,i,s,n,o){var r,a,l=s.length;if(l>0)if(s[0]._instancing&&t.instancingExt){for(a=0,s[0].prepareForInstancedRender(t,n,l),r=0;r<l;r++)s[r].render(t,e,i,o,!0,!0,n,!0)&&a++;a>0&&s[0].renderInstances(t,n,a)}else for(r=0;r<l;r++)s[r].render(t,e,i,o,!0,void 0,void 0,!0)},p.prototype._renderMainObjects=function(t,e,i,s,n,o){var r;if(s.length>0)for(t.setDepthMask(!0),t.disableBlending(),r=0;r<s.length;r++)this._renderQueue(t,e,i,s[r],r,!0);if(o&&this._renderBackgroundObjects(t,e,i),n.length>0)for(t.setDepthMask(!1),t.enableBlending(),r=0;r<n.length;r++)this._renderQueue(t,e,i,n[r],r,!1)},p.prototype._renderUIObjects=function(t,e,i){var s,n=t.gl;this._rootUINode.isVisible()&&this._rootUINode._subnodes._length>0&&(s=this._camera,this._distanceRendering&&(this._camera=this._camera.getExtendedCamera(!0)),t.enableBlending(),n.disable(n.DEPTH_TEST),t.setDepthMask(!1),this._rootUINode.render(t,e,i,!1),n.enable(n.DEPTH_TEST),this._camera=s)},p.prototype._render=function(t,e,i,s,n,o){var r,a,l=t.gl;this._shouldClearColorOnRender&&(t.setColorMask(this._clearColorMask),l.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),t.setDepthMask(!0),
r=this._shouldClearColorOnRender?l.COLOR_BUFFER_BIT:0,r=this._shouldClearDepthOnRender?r|l.DEPTH_BUFFER_BIT:r,l.clear(r),e&&(a=this._camera,this._camera=this._camera.getExtendedCamera(),this._cameraUniformsUpdated.clear(),this._clearDynamicLightUniformData(),this._renderMainObjects(t,s,n,this._renderQueues[2],this._renderQueues[3],!0),this._camera=a,t.setDepthMask(!0),l.clear(l.DEPTH_BUFFER_BIT),this._cameraUniformsUpdated.clear()),!i&&e||(this._updateDynamicLightUniformData(this._shouldAnimate?o:0),t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._renderMainObjects(t,s,n,this._renderQueues[0],this._renderQueues[1],!e)),this._renderUIObjects(t,s,n)},p.prototype.render=function(t,e){var i,s,n,o=t.gl,r=o.drawingBufferWidth,a=o.drawingBufferHeight,l=r*this._width,h=a*this._height;this._camera.setAspect(l/h),this._shouldUpdateCamera&&this._camera.update(e),this._uniformsUpdated.clear(),this._cameraUniformsUpdated.clear(),n=!1,!1===this._uniformsUpdatedForFrame&&t.getCurrentShader()&&(this._updateStaticLightUniformData(),this.assignUniforms(t,t.getCurrentShader()),n=!0),this._uniformsUpdatedForFrame=!1,this._renderQueues[0].length=0,this._renderQueues[1].length=0,this._distanceRendering&&(this._renderQueues[2].length=0,this._renderQueues[3].length=0),this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._distanceRendering,this._camera,e),this.cleanUpLights(),i=this._renderQueues[0].length>0||this._renderQueues[1].length>0,s=this._distanceRendering&&(this._renderQueues[2].length>0||this._renderQueues[3].length>0),i&&(this._renderShadowMaps(t,l,h),this._shadowMappingEnabled&&(n=!1)),n||this._updateStaticLightUniformData(),o.viewport(this._left*r,this._bottom*a,l,h),this._render(t,s,i,l,h,e)},{LODContext:c,RenderableNode:_,Scene:p}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2},Math.seed=function(t){return function(){return(t=1e4*Math.sin(t))-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/matrices","utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/media-resources","modules/scene/scene-graph","armada/constants","utils/polyfill"],function(t,e,i,s,n,o,r,a){"use strict";function l(t,e){var i,s,n=0;for(i in v)v.hasOwnProperty(i)&&(s=v[i],e.hasOwnProperty(s.name)&&(n+=t[s.name]*e[s.name]));return n}function h(t,e){return{requiredVertexUniformVectors:t[N]+l(t[O],e),requiredAttributeVectors:t[L]+l(t[R],e),requiredVaryingVectors:t[b]+l(t[x],e),requiredTextureUnits:t[D]+l(t[w],e),requiredFragmentUniformVectors:t[P]+l(t[V],e),fragmentShaderHighPrecision:t[F]}}function c(t,e){return{requiredVertexUniformVectors:t.requiredVertexUniformVectors+e.requiredVertexUniformVectors,requiredAttributeVectors:t.requiredAttributeVectors+e.requiredAttributeVectors,requiredVaryingVectors:t.requiredVaryingVectors+e.requiredVaryingVectors,requiredTextureUnits:t.requiredTextureUnits+e.requiredTextureUnits,requiredFragmentUniformVectors:t.requiredFragmentUniformVectors+e.requiredFragmentUniformVectors,fragmentShaderHighPrecision:t.fragmentShaderHighPrecision||e.fragmentShaderHighPrecision}}function u(t,i,s,n){this._list=t?e.getArrayValue(s||"OrderedNamedNumericOptions.list",t,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(t,e){return t[this._optionValuePropertyName]-e[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,n&&this.applyLimit(n)}function _(t,e,i){u.call(this,t,I,e,i),this._preferenceList=null,this._preferenceNameList=null,this._updatePreferenceList()}function p(){s.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._msInLaunchers=!1,this._thrusterLightSources=!1,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1,this._groupTransformIdentityArray=null,this._generalLevels=null,this._currentGeneralLevel=null}function d(){return y.isShadowMappingEnabled()&&y.isShadowMappingAvailable()}function g(){return y.getShader(y.getShadowMappingShaderName())}function m(){return d()?{enable:!0,shader:y.getManagedShader(y.getShadowMappingShaderName()),textureSize:y.getShadowMapTextureSize(),ranges:y.getShadowRanges(),depthRatio:y.getShadowDepthRatio(),numSamples:y.getNumShadowMapSamples()}:null}function f(){return parseFloat(y.getShaderConfig(G.LISPSM_MINIMUM_NEAR))}function S(){return parseFloat(y.getShaderConfig(G.LISPSM_NEAR_FACTOR))}function T(t){lt.push(t)}function E(){var t;for(t=0;t<lt.length;t++)lt[t]()}var y,M=a.LOCAL_STORAGE_PREFIX+"graphics_",I=e.getNameAndValueDefinitionObject("maximumResolution"),C=e.getNameAndValueDefinitionObject("lod"),A={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},v=A.properties,N="requiredVertexUniformVectors",O="requiredVertexUniformVectorsPer",L="requiredAttributeVectors",R="requiredAttributeVectorsPer",b="requiredVaryingVectors",x="requiredVaryingVectorsPer",D="requiredTextureUnits",w="requiredTextureUnitsPer",P="requiredFragmentUniformVectors",V="requiredFragmentUniformVectorsPer",F="fragmentShaderHighPrecision",U={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:N,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:O,type:A,defaultValue:{}},ATTRIBUTE_VECTORS:{name:L,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:R,type:A,defaultValue:{}},VARYING_VECTORS:{name:b,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:x,type:A,defaultValue:{}},TEXTURE_UNITS:{name:D,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:w,type:A,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:P,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:V,type:A,defaultValue:{}},FRAGMENT_SHADER_HIGH_PRECISION:{name:F,type:"boolean",defaultValue:!1}}},B={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:U}}},H=B.properties,G={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:U},DYNAMIC_LIGHTS:{name:"dynamicLights",type:U},REVEAL:{name:"reveal",type:U}}},COMPLEXITIES:{name:"complexities",type:"array",elementType:B,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},SHADOW_MAP_TEXTURE_SIZE_DEFINE_NAME:{name:"shadowMapTextureSizeDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},SHADOW_MAP_DEPTH_RATIO_DEFINE_NAME:{name:"shadowMapDepthRatioDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"},LISPSM_MINIMUM_NEAR:{name:"lispsmMinimumNear",type:"string"},LISPSM_MINIMUM_NEAR_DEFINE_NAME:{name:"lispsmMinimumNearDefineName",type:"string"},LISPSM_NEAR_FACTOR:{name:"lispsmNearFactor",type:"string"},LISPSM_NEAR_FACTOR_DEFINE_NAME:{name:"lispsmNearFactorDefineName",type:"string"}},k=G.FEATURE_REQUIREMENTS.properties,j=e.getNameAndValueDefinitionObject("numRanges"),W=e.getNameAndValueDefinitionObject("maxLights"),Y=e.getNameAndValueDefinitionObject("particleCountFactor"),X=M+"generalLevel",z=M+"antialiasing",q=M+"filtering",J=n.TextureFiltering.TRILINEAR,Q=M+"textureQuality",K=M+"cubemapQuality",Z=M+"maxLOD",$=M+"missilesInLaunchers",tt=M+"thrusterLightSources",et=M+"shaderComplexity",it=M+"shadowMapping",st=M+"shadowQuality",nt=M+"shadowDistance",ot=M+"pointLightAmount",rt=M+"particleAmount",at=M+"dustParticleAmount",lt=[];return u.prototype._getNameFunction=function(t){return t[this._optionNamePropertyName]},u.prototype._checkNameFunction=function(t,e){return e[this._optionNamePropertyName]===t},u.prototype._isWithinLimitFunction=function(t,e){return e[this._optionValuePropertyName]<=t},u.prototype._valueFilterFunction=function(t,e){return t(e[this._optionValuePropertyName])},u.prototype._getInvalidOptionAccessErrorMessage=function(t){return"Invalid option ("+this._optionValuePropertyName+") '"+t+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},u.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},u.prototype.getFilteredNameList=function(t){return this._list.filter(this._valueFilterFunction.bind(this,t)).map(this._getNameFunction.bind(this))},u.prototype.setCurrent=function(t,e){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,t)),this._currentIndex<0&&e&&(this._currentIndex=this._list.length-1),!(this._currentIndex<0)||(i.showError(this._getInvalidOptionAccessErrorMessage(t)),!1)},u.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},u.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},u.prototype.getValueForName=function(t){var e=this._list.findIndex(this._checkNameFunction.bind(this,t));return e>=0?this._list[e][this._optionValuePropertyName]:(i.showError(this._getInvalidOptionAccessErrorMessage(t)),0)},u.prototype.applyLimit=function(t){this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,t)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1)},u.prototype.decrease=function(){return this._currentIndex>0&&(this._currentIndex--,!0)},u.prototype.setLowest=function(){this._currentIndex=0},u.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},_.prototype=new u,_.prototype.constructor=_,_.prototype._updatePreferenceList=function(){var t;for(this._preferenceList=[],t=this._currentIndex;t>=0;t--)this._preferenceList.push(this._list[t]);for(t=this._currentIndex+1;t<this._list.length;t++)this._preferenceList.push(this._list[t]);this._preferenceNameList=this._preferenceList.map(this._getNameFunction.bind(this))},_.prototype.setCurrent=function(t,e){var i;return i=u.prototype.setCurrent.call(this,t,e),this._updatePreferenceList(),i},_.prototype.getPreferenceNameList=function(){return this._preferenceNameList},_.prototype.applyLimit=function(t){u.prototype.applyLimit.call(this,t),this._updatePreferenceList()},p.prototype=new s.AsyncResource,p.prototype.constructor=p,p.prototype._getShaderRequirements=function(t){t=t||{};var e,i=this._getShaderComplexityDescriptor(t.complexityLevelIndex),s=this.getShaderConfig(G.FEATURE_REQUIREMENTS),n=i[H.MAX_DIR_LIGHTS.name],o=void 0===t.numPointLights?this.getMaxPointLights():t.numPointLights,r=o>0?i[H.MAX_SPOT_LIGHTS.name]:0,a=void 0===t.numShadowRanges?this.getNumShadowMapRanges():t.numShadowRanges,l=n*a,u=i[H.NUM_SHADOW_MAP_SAMPLES.name],_={};return _[v.DIR_LIGHT.name]=n,_[v.POINT_LIGHT.name]=o,_[v.SPOT_LIGHT.name]=r,_[v.SHADOW_MAP.name]=l,_[v.SHADOW_MAP_RANGE.name]=a,_[v.SHADOW_MAP_SAMPLE.name]=u,_[v.LUMINOSITY_FACTOR.name]=this.getShaderConfig(G.MAX_LUMINOSITY_FACTORS),_[v.GROUP_TRANSFORM.name]=this.getShaderConfig(G.MAX_GROUP_TRANSFORMS),e=h(i[H.REQUIREMENTS.name],_),i[H.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(e=c(e,h(s[k.SHADOWS.name],_))),i[H.DYNAMIC_LIGHTS_AVAILABLE.name]&&o>0&&(e=c(e,h(s[k.DYNAMIC_LIGHTS.name],_))),i[H.REVEAL_AVAILABLE.name]&&(e=c(e,h(s[k.REVEAL.name],_))),e},p.prototype._shaderRequirementsAreSatisfied=function(t){return n.requirementsAreSatisfied(this._getShaderRequirements(t))},p.prototype._limitShaderComplexities=function(){var t,e=[],i=this.getShaderConfig(G.COMPLEXITIES);for(t=0;t<i.length;t++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:t})&&e.push(i[t]);this.setShaderConfig(G.COMPLEXITIES,e)},p.prototype._setFallbackShaderComplexity=function(t){var e;for(t&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),e=this.getShaderComplexities().indexOf(this.getShaderComplexity());e>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:e});)e--;this.setShaderComplexity(this.getShaderComplexities()[e],!1)},p.prototype.loadConfigurationFromJSON=function(i){var s,o,a,l;for(this._shaderConfig=e.getVerifiedObject("config.graphics.shaders",i.shaders,G),this._limitShaderComplexities(),this._textureQuality=new _(i.context.textureQualities,"config.graphics.context.textureQualities",n.getMaxTextureSize()),this._cubemapQuality=new _(i.context.cubemapQualities,"config.graphics.context.cubemapQualities",n.getMaxCubemapSize()),this._shadowMapQuality=new _(i.context.shadows.qualities,"config.graphics.context.shadows.qualities",n.getMaxRenderbufferSize()),this._shadowRanges=e.getArrayValue("config.graphics.context.shadows.ranges",i.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new u(i.context.shadows.distances,j,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=e.getNumberValue("config.graphics.context.shadows.depthRatio",i.context.shadows.depthRatio),this._pointLightAmount=new u(i.context.pointLightAmounts,W,"config.graphics.context.pointLightAmounts"),this._particleAmount=new u(i.context.particleAmounts,Y,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new u(i.context.dustParticleAmounts,Y,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new u(i.levelOfDetailSettings.lodLevels,C,"config.graphics.levelOfDetailSettings.lodLevels"),l=new Array(i.levelOfDetailSettings.lodDisplayProfile.limits.length+1),l[0]=0,s=0,o=i.levelOfDetailSettings.lodDisplayProfile.limits.length;s<o;s++)a=i.levelOfDetailSettings.lodDisplayProfile.limits[s],l[this._lodLevel.getValueForName(a.level)+1]=a.objectSizeLessThan;for(this._lodContext=new r.LODContext(this._lodLevel.getFirstValue(),l,i.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,i.levelOfDetailSettings.lodDisplayProfile.referenceSize,i.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize),this._generalLevels=i.generalLevels,this._groupTransformIdentityArray=new Float32Array(16*this.getShaderConfig(G.MAX_GROUP_TRANSFORMS)),s=0;s<this._groupTransformIdentityArray.length;s++)this._groupTransformIdentityArray[s]=t.IDENTITY4[s%16]},p.prototype._limitSettingByScreenSize=function(t,e,i,s,n){var o,r,a,l;if(!0===t.autoLimitByScreenSize)for(o=Math.max(screen.width,screen.height),r=0,a=t.limits.length;r<a;r++)l=t.limits[r],o<l.screenSizeLessThan&&i()>e.getValueForName(l[n])&&s(l[n],!1)},p.prototype.loadSettingsFromJSON=function(t,s){s=s||!1,s||(this._dataJSON=t),"object"==typeof t.shaders?this.setShaderComplexity(t.shaders.complexity,!1,!0):i.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof t.context?(this.setAntialiasing(e.getBooleanValue(t.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(e.getEnumValue(n.TextureFiltering,t.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(t.context.textureQuality,!1,!0),this.setCubemapQuality(t.context.cubemapQuality.level,!1,!0),this._limitSettingByScreenSize(t.context.cubemapQuality,this._cubemapQuality,this.getCubemapMaxResolution.bind(this),this.setCubemapQuality.bind(this),"level"),this.setShadowMapping(e.getBooleanValue(t.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof t.context.shadows&&(this.setShadowMapQuality(t.context.shadows.quality,!1,!0),this.setShadowDistance(t.context.shadows.distance,!1,!0)),this.setPointLightAmount(t.context.pointLightAmount,!1,!0)):i.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(t.levelOfDetail.maxLevel,!1),this._limitSettingByScreenSize(t.levelOfDetail,this._lodLevel,this.getMaxLoadedLOD.bind(this),this.setLODLevel.bind(this),"level"),this.setMissilesInLaunchersVisible(e.getBooleanValue(t.showMissilesInLaunchers,{name:"settings.graphics.showMissilesInLaunchers"}),!1),this.setLightSourcesForThrusters(e.getBooleanValue(t.createLightSourcesForThrusters,{name:"settings.graphics.createLightSourcesForThrusters"}),!1),this.setParticleAmount(t.particleAmount.amount,!1),this._limitSettingByScreenSize(t.particleAmount,this._particleAmount,this.getParticleCountFactor.bind(this),this.setParticleAmount.bind(this),"amount"),!0===t.particleAmount.autoDecreaseIfInstancingNotAvailable&&(n.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(t.dustParticleAmount.amount,!1),this._limitSettingByScreenSize(t.dustParticleAmount,this._dustParticleAmount,this.getDustParticleCountFactor.bind(this),this.setDustParticleAmount.bind(this),"amount"),!0===t.dustParticleAmount.autoDecreaseIfInstancingNotAvailable&&(n.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},p.prototype.loadFromLocalStorage=function(){var t,s,o=function(n,o,r,a){void 0!==localStorage[n]&&(s={silentFallback:i.hasVersionChanged(),defaultValue:r},t=e.getValueOfTypeFromLocalStorage(o,n,s),s.error&&!i.hasVersionChanged()||a(t,!!s.error&&s.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))};o(X,{baseType:"enum",values:e.getEnumObjectForArray(this.getGeneralLevelNames())},this.getGeneralLevel(),function(t){this._currentGeneralLevel=t}.bind(this)),o(z,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),o(q,{baseType:"enum",values:n.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),o(Q,{baseType:"enum",values:e.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),o(K,{baseType:"enum",values:e.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),o(Z,{baseType:"enum",values:e.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),o($,"boolean",this.areMissilesInLaunchersVisible(),this.setMissilesInLaunchersVisible.bind(this)),o(tt,"boolean",this.shouldCreateLightSourcesForThrusters(),this.setLightSourcesForThrusters.bind(this)),o(et,{baseType:"enum",values:e.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),o(it,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),o(st,{baseType:"enum",values:e.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&o(nt,{baseType:"enum",values:e.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),o(ot,{baseType:"enum",values:e.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),o(rt,{baseType:"enum",values:e.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),o(at,{baseType:"enum",values:e.getEnumObjectForArray(this.getDustParticleAmounts())},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},p.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(X),localStorage.removeItem(z),localStorage.removeItem(q),localStorage.removeItem(Q),localStorage.removeItem(K),localStorage.removeItem(Z),localStorage.removeItem($),localStorage.removeItem(et),localStorage.removeItem(it),localStorage.removeItem(st),localStorage.removeItem(nt),localStorage.removeItem(ot),localStorage.removeItem(rt),localStorage.removeItem(at)},p.prototype.getAntialiasing=function(){return this._antialiasing},p.prototype.setAntialiasing=function(t,e){return void 0===e&&(e=!0),n.isAntialiasingAvailable()?this._antialiasing=t:this._antialiasing=!1,e&&(localStorage[z]=t.toString()),this._antialiasing===t},p.prototype.getFiltering=function(){return this._filtering},p.prototype.setFiltering=function(t,i){void 0===i&&(i=!0),t=e.getEnumValue(n.TextureFiltering,t,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=t,n.isAnisotropicFilteringAvailable()||t!==n.TextureFiltering.ANISOTROPIC||(this._filtering=J),i&&(localStorage[q]=t.toString())},p.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},p.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},p.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},p.prototype.setTextureQuality=function(t,e,i){void 0===e&&(e=!0),this._textureQuality.setCurrent(t,i)&&e&&(localStorage[Q]=t)},p.prototype.getCubemapMaxResolution=function(){return this._cubemapQuality.getCurrentValue()},p.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},p.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},p.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},p.prototype.setCubemapQuality=function(t,e,i){void 0===e&&(e=!0),this._cubemapQuality.setCurrent(t,i)&&e&&(localStorage[K]=t)},p.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},p.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},p.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},p.prototype.getLOD=function(t){return this._lodLevel.getValueForName(t)},p.prototype.setLODLevel=function(t,e){void 0===e&&(e=!0),this._lodLevel.setCurrent(t)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),e&&(localStorage[Z]=t))},p.prototype.getLODContext=function(){return this._lodContext},p.prototype.setMissilesInLaunchersVisible=function(t,e){void 0===e&&(e=!0),this._msInLaunchers=t,e&&(localStorage[$]=t.toString())},p.prototype.areMissilesInLaunchersVisible=function(){return this._msInLaunchers},p.prototype.setLightSourcesForThrusters=function(t,e){void 0===e&&(e=!0),this._thrusterLightSources=t,e&&(localStorage[tt]=t.toString())},p.prototype.shouldCreateLightSourcesForThrusters=function(){return this._thrusterLightSources},p.prototype.getShaderComplexity=function(){return this._shaderComplexity},p.prototype._limitShaderFeatures=function(){var t=this.isShadowMappingEnabled();for(this.getNumShadowMapRanges(),this.getMaxPointLights();!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void i.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==t||this.getNumShadowMapRanges(),this.getMaxPointLights()},p.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},p.prototype.setShaderComplexity=function(t,e,s){var n=this.getShaderComplexities();void 0===e&&(e=!0),n.indexOf(t)>=0?(this._shaderComplexity!==t&&(this._shaderComplexity=t,this._limitShaderFeatures()),e&&(localStorage[et]=t)):s?this._shaderComplexity=n[n.length-1]:i.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",i.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[H.LUMINOSITY_TEXTURES_AVAILABLE.name]},p.prototype.getShaderComplexities=function(){return this.getShaderConfig(G.COMPLEXITIES).map(function(t){return t[H.NAME.name]})},p.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(G.SHADOW_MAPPING_SHADER_NAME)},p.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},p.prototype.setShadowMapping=function(t,i,s){return void 0===t&&(t=void 0!==localStorage[it]?"true"===localStorage[it]:e.getBooleanValue(this._dataJSON.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),i=!1,s=!1),void 0===i&&(i=!0),s||!t||this.canEnableShadowMapping()?this._shadowMappingEnabled!==t&&(this._shadowMappingEnabled=t,!s&&t&&this._limitShaderFeatures()):this._shadowMappingEnabled=!1,i&&(localStorage[it]=t.toString()),this._shadowMappingEnabled===t},p.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},p.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},p.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},p.prototype.setShadowMapQuality=function(t,e,i){void 0===e&&(e=!0),this._shadowMapQuality.setCurrent(t,i)&&e&&(localStorage[st]=t)},p.prototype.getShadowRanges=function(){var t,e=[],i=this.getNumShadowMapRanges();for(t=0;t<i;t++)e.push(this._shadowRanges[t]);return e},p.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numShadowRanges:t})}.bind(this))},p.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},p.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},p.prototype.setShadowDistance=function(t,e,i){void 0===e&&(e=!0),this._shadowDistances.setCurrent(t,i)&&e&&(localStorage[nt]=t)},p.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},p.prototype._getShaderComplexityDescriptor=function(t){return void 0===t?this.getShaderConfig(G.COMPLEXITIES).find(function(t){return t[H.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(G.COMPLEXITIES)[t]},p.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[H.MAX_DIR_LIGHTS.name]},p.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numPointLights:t})}.bind(this))},p.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},p.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},p.prototype.setPointLightAmount=function(t,e,i){void 0===e&&(e=!0),this._pointLightAmount.setCurrent(t,i)&&e&&(localStorage[ot]=t)},p.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[H.MAX_SPOT_LIGHTS.name]},p.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},p.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},p.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},p.prototype.setParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._particleAmount.setCurrent(t,i)&&e&&(localStorage[rt]=t)},p.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},p.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},p.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},p.prototype.setDustParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._dustParticleAmount.setCurrent(t,i)&&e&&(localStorage[at]=t)},p.prototype.getShaderConfig=function(t){return this._shaderConfig[t.name]},p.prototype.setShaderConfig=function(t,e){this._shaderConfig[t.name]=e},p.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[H.NUM_SHADOW_MAP_SAMPLES.name]},p.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[H.SHADOW_MAPPING_AVAILABLE.name]},p.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},p.prototype.getGroupTransformIdentityArray=function(){return this._groupTransformIdentityArray},p.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[H.REVEAL_AVAILABLE.name]},p.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[H.DYNAMIC_LIGHTS_AVAILABLE.name]},p.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},p.prototype.getTexture=function(t,e){return e=e||{},e.qualityPreferenceList=this.getTextureQualityPreferenceList(),o.getTexture(t,e)},p.prototype.getCubemap=function(t,e){return e=e||{},e.qualityPreferenceList=this.getCubemapQualityPreferenceList(),o.getCubemap(t,e)},p.prototype.getShader=function(t){return t=o.getVariantShader(t,this.getShaderComplexity())._name,this._shadowMappingEnabled||(t=o.getVariantShader(t,"withoutShadows")._name),0===this._pointLightAmount.getCurrentValue()&&(t=o.getVariantShader(t,"withoutDynamicLights")._name),o.getShader(t)},p.prototype.getManagedShader=function(t){var e,s={};return s[this.getShaderConfig(G.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),s[this.getShaderConfig(G.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),s[this.getShaderConfig(G.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),s[this.getShaderConfig(G.SHADOW_MAP_TEXTURE_SIZE_DEFINE_NAME)]=this.getShadowMapTextureSize()+".0",s[this.getShaderConfig(G.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),
s[this.getShaderConfig(G.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),s[this.getShaderConfig(G.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),s[this.getShaderConfig(G.SHADOW_MAP_DEPTH_RATIO_DEFINE_NAME)]=this.getShadowDepthRatio()+".0",s[this.getShaderConfig(G.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(G.DUST_LENGTH_DIVISOR),s[this.getShaderConfig(G.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(G.MAX_LUMINOSITY_FACTORS),s[this.getShaderConfig(G.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(G.MAX_GROUP_TRANSFORMS),s[this.getShaderConfig(G.DEPTH_TEXTURES_DEFINE_NAME)]=n.areDepthTexturesAvailable()?"1":"0",s[this.getShaderConfig(G.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(G.MAX_SHININESS),s[this.getShaderConfig(G.LISPSM_MINIMUM_NEAR_DEFINE_NAME)]=this.getShaderConfig(G.LISPSM_MINIMUM_NEAR),s[this.getShaderConfig(G.LISPSM_NEAR_FACTOR_DEFINE_NAME)]=this.getShaderConfig(G.LISPSM_NEAR_FACTOR),e=this.getShader(t).getManagedShader(s,!0),e.isAllowedByRequirements(this._getShaderRequirements())||i.showError("Shader '"+t+"' has too high requirements!"),e},p.prototype.getModel=function(t){return o.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},p.prototype.getGeneralLevelNames=function(){return Object.keys(this._generalLevels)},p.prototype.setGeneralLevel=function(t,e){void 0===e&&(e=!0),t?(this.loadSettingsFromJSON(this._generalLevels[t],!0),e&&(localStorage[X]=t)):e&&localStorage.removeItem(X),this._currentGeneralLevel=t},p.prototype.getGeneralLevel=function(){return this._currentGeneralLevel},y=new p,{SHADER_VARIANT_WITHOUT_SHADOWS_NAME:"withoutShadows",SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME:"withoutDynamicLights",loadConfigurationFromJSON:y.loadConfigurationFromJSON.bind(y),loadSettingsFromJSON:y.loadSettingsFromJSON.bind(y),loadSettingsFromLocalStorage:y.loadFromLocalStorage.bind(y),restoreDefaults:y.restoreDefaults.bind(y),getAntialiasing:y.getAntialiasing.bind(y),setAntialiasing:y.setAntialiasing.bind(y),getFiltering:y.getFiltering.bind(y),setFiltering:y.setFiltering.bind(y),getTextureQualities:y.getTextureQualities.bind(y),getTextureQuality:y.getTextureQuality.bind(y),setTextureQuality:y.setTextureQuality.bind(y),getTextureQualityPreferenceList:y.getTextureQualityPreferenceList.bind(y),getCubemapQualities:y.getCubemapQualities.bind(y),getCubemapQuality:y.getCubemapQuality.bind(y),setCubemapQuality:y.setCubemapQuality.bind(y),getCubemapQualityPreferenceList:y.getCubemapQualityPreferenceList.bind(y),getLODLevels:y.getLODLevels.bind(y),getLODLevel:y.getLODLevel.bind(y),getLOD:y.getLOD.bind(y),setLODLevel:y.setLODLevel.bind(y),getMaxLoadedLOD:y.getMaxLoadedLOD.bind(y),getLODContext:y.getLODContext.bind(y),setMissilesInLaunchersVisible:y.setMissilesInLaunchersVisible.bind(y),areMissilesInLaunchersVisible:y.areMissilesInLaunchersVisible.bind(y),setLightSourcesForThrusters:y.setLightSourcesForThrusters.bind(y),shouldCreateLightSourcesForThrusters:y.shouldCreateLightSourcesForThrusters.bind(y),getShaderComplexity:y.getShaderComplexity.bind(y),setShaderComplexity:y.setShaderComplexity.bind(y),getShaderComplexities:y.getShaderComplexities.bind(y),getMaxLuminosityFactors:y.getShaderConfig.bind(y,G.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:y.getShaderConfig.bind(y,G.MAX_GROUP_TRANSFORMS),getLispsmMinimumNear:f,getLispsmNearFactor:S,getShadowMappingShaderName:y.getShadowMappingShaderName.bind(y),isShadowMappingEnabled:y.isShadowMappingEnabled.bind(y),setShadowMapping:y.setShadowMapping.bind(y),getShadowMapQualities:y.getShadowMapQualities.bind(y),getShadowMapQuality:y.getShadowMapQuality.bind(y),getShadowMapTextureSize:y.getShadowMapTextureSize.bind(y),setShadowMapQuality:y.setShadowMapQuality.bind(y),getShadowDistances:y.getShadowDistances.bind(y),getShadowDistance:y.getShadowDistance.bind(y),setShadowDistance:y.setShadowDistance.bind(y),getNumShadowMapRanges:y.getNumShadowMapRanges.bind(y),getNumShadowMapSamples:y.getNumShadowMapSamples.bind(y),getMaxDirLights:y.getMaxDirLights.bind(y),getPointLightAmounts:y.getPointLightAmounts.bind(y),getPointLightAmount:y.getPointLightAmount.bind(y),getMaxPointLights:y.getMaxPointLights.bind(y),setPointLightAmount:y.setPointLightAmount.bind(y),getParticleAmounts:y.getParticleAmounts.bind(y),getParticleAmount:y.getParticleAmount.bind(y),getParticleCountFactor:y.getParticleCountFactor.bind(y),setParticleAmount:y.setParticleAmount.bind(y),getDustParticleAmounts:y.getDustParticleAmounts.bind(y),getDustParticleAmount:y.getDustParticleAmount.bind(y),getDustParticleCountFactor:y.getDustParticleCountFactor.bind(y),setDustParticleAmount:y.setDustParticleAmount.bind(y),getMaxSpotLights:y.getMaxSpotLights.bind(y),isShadowMappingAvailable:y.isShadowMappingAvailable.bind(y),areLuminosityTexturesAvailable:y.areLuminosityTexturesAvailable.bind(y),getGroupTransformIdentityArray:y.getGroupTransformIdentityArray.bind(y),isRevealAvailable:y.isRevealAvailable.bind(y),areDynamicLightsAvailable:y.areDynamicLightsAvailable.bind(y),canEnableShadowMapping:y.canEnableShadowMapping.bind(y),getTexture:y.getTexture.bind(y),getCubemap:y.getCubemap.bind(y),getShader:y.getShader.bind(y),getManagedShader:y.getManagedShader.bind(y),getModel:y.getModel.bind(y),getGeneralLevelNames:y.getGeneralLevelNames.bind(y),setGeneralLevel:y.setGeneralLevel.bind(y),getGeneralLevel:y.getGeneralLevel.bind(y),shouldUseShadowMapping:d,getShadowMappingShader:g,getShadowMappingSettings:m,onSettingsChange:T,handleSettingsChanged:E,executeWhenReady:y.executeWhenReady.bind(y)}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices"],function(t,e,i){"use strict";function s(){return h}function n(t,e){h=t,c=e}function o(t,e,i){var s,n;(s=t[12]*t[12]+t[13]*t[13]+t[14]*t[14])>l&&(n=h*i*s,s=1/Math.sqrt(s),n=-s*n*e*.001,t[12]+=n*t[12],t[13]+=n*t[13],t[14]+=n*t[14])}function r(t,s,n){this.pM=t,this._positionVector=i.translationVector3(t),this.oM=s,this._rotated=!i.equal4(s,i.IDENTITY4),this.mMI=i.prodTranslationRotation4(i.inverseOfTranslation4Aux(this.pM),i.inverseOfRotation4Aux(this.oM)),this._halfWidth=.5*n[0],this._halfHeight=.5*n[1],this._halfDepth=.5*n[2],this._modelTransformResult=[0,0,0,1],this._points=new Float32Array(24),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([-this._halfWidth,-this._halfHeight,-this._halfDepth],this.oM),this.pM),0),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([this._halfWidth,-this._halfHeight,-this._halfDepth],this.oM),this.pM),3),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([-this._halfWidth,this._halfHeight,-this._halfDepth],this.oM),this.pM),6),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([this._halfWidth,this._halfHeight,-this._halfDepth],this.oM),this.pM),9),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([-this._halfWidth,-this._halfHeight,this._halfDepth],this.oM),this.pM),12),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([this._halfWidth,-this._halfHeight,this._halfDepth],this.oM),this.pM),15),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([-this._halfWidth,this._halfHeight,this._halfDepth],this.oM),this.pM),18),this._points.set(e.addVec3Mat4(e.mulVec3Mat4([this._halfWidth,this._halfHeight,this._halfDepth],this.oM),this.pM),21),this._hitDistance=0}function a(t,e,s,n,o,r,a){this._mass=0,this.pM=i.identity4(),this.oM=i.identity4(),this.sM=i.identity4(),this.mM=i.identity4(),this.mMValid=!1,this.mMI=i.identity4(),this.mMIV=!1,this._velocityMatrix=i.identity4(),this._acceleration=[0,0,0],this._offset=[0,0,0],this._angularAccelerationMatrix=i.identity3(),this._orientationOffset=i.identity3(),this._hasAngularAcceleration=!1,this._bodies=null,this._bodySize=-1,this._dragFactor=0,this._inverseScalingFactor=1,this._inverseMass=0,this._collision={position:[0,0,0,1],direction:[0,0,0],magnitude:0,reverse:!1},e&&this.init(t,e,s,n,o,r,a)}var l=.1,h=0,c=0,u=[0,0,0,1],_=[0,0,0,1],p=i.identity4(),d=i.identity4();return r.prototype.getWidth=function(){return 2*this._halfWidth},r.prototype.getHeight=function(){return 2*this._halfHeight},r.prototype.getDepth=function(){return 2*this._halfDepth},r.prototype._modelTransform=function(t){return this._rotated?e.setSum3(this._modelTransformResult,e.prodVec3Mat4Aux(t,this.oM),this._positionVector):e.setSum3(this._modelTransformResult,t,this._positionVector),this._modelTransformResult},r.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},r.prototype.checkHit=function(i,s,n,o){var r,a,l,h=this._halfWidth+o,c=this._halfHeight+o,u=this._halfDepth+o;if(this._rotated?(i=e.prodVec4Mat4Aux(i,this.mMI),s=e.prodMat4Vec3Aux(this.oM,s)):i=e.diff3Aux(i,this._positionVector),0!==s[0])if(s[0]>0){if(r=(-h-i[0])/s[0],a=i[1]+s[1]*r,l=i[2]+s[2]*r,t.pointInRect(a,l,-c,-u,c,u))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([-h,a,l])):null}else if(r=(h-i[0])/s[0],a=i[1]+s[1]*r,l=i[2]+s[2]*r,t.pointInRect(a,l,-c,-u,c,u))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([h,a,l])):null;if(0!==s[1])if(s[1]>0){if(r=(-c-i[1])/s[1],a=i[0]+s[0]*r,l=i[2]+s[2]*r,t.pointInRect(a,l,-h,-u,h,u))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([a,-c,l])):null}else if(r=(c-i[1])/s[1],a=i[0]+s[0]*r,l=i[2]+s[2]*r,t.pointInRect(a,l,-h,-u,h,u))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([a,c,l])):null;if(0!==s[2])if(s[2]>0){if(r=(-u-i[2])/s[2],a=i[0]+s[0]*r,l=i[1]+s[1]*r,t.pointInRect(a,l,-h,-c,h,c))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([a,l,-u])):null}else if(r=(u-i[2])/s[2],a=i[0]+s[0]*r,l=i[1]+s[1]*r,t.pointInRect(a,l,-h,-c,h,c))return r<=0&&r>=-n?(this._hitDistance=r,this._modelTransform([a,l,u])):null;return null},a.prototype.init=function(s,n,o,r,a,l,h){this._mass=s,this._inverseMass=1/s,i.copyTranslation4(this.pM,n),i.copyRotation4(this.oM,o),this.sM[0]=r,this.sM[5]=r,this.sM[10]=r,this.mMValid=!1,this.mMIV=!1,i.setIdentity4(this._velocityMatrix),i.copyTranslation4(this._velocityMatrix,a),e.setNull3(this._acceleration),e.setNull3(this._offset),i.setIdentity3(this._angularAccelerationMatrix),i.setIdentity3(this._orientationOffset),this._hasAngularAcceleration=!1,this._inverseScalingFactor=1/this.sM[0],this._bodies=l||t.EMPTY_ARRAY,this._bodySize=-1,this._calculateBodySize(),this._dragFactor=void 0!==h?h:1},a.prototype.reset=function(){i.setIdentity4(this._velocityMatrix),e.setNull3(this._acceleration),e.setNull3(this._offset),i.setIdentity3(this._orientationOffset),i.setIdentity3(this._angularAccelerationMatrix),this._hasAngularAcceleration=!1},a.prototype.copyPositionToVector=function(t){t[0]=this.pM[12],t[1]=this.pM[13],t[2]=this.pM[14]},a.prototype.getBodySize=function(){return this._bodySize},a.prototype.getSize=function(){return this._bodySize*this.sM[0]},a.prototype.setVelocity=function(t,e,i){this._velocityMatrix[12]=t,this._velocityMatrix[13]=e,this._velocityMatrix[14]=i},a.prototype.setVelocityv=function(t){this._velocityMatrix[12]=t[0],this._velocityMatrix[13]=t[1],this._velocityMatrix[14]=t[2]},a.prototype.setAngularVelocity=function(t,e,i,s,n,o,r,a,l){this._velocityMatrix[0]=t,this._velocityMatrix[1]=e,this._velocityMatrix[2]=i,this._velocityMatrix[4]=s,this._velocityMatrix[5]=n,this._velocityMatrix[6]=o,this._velocityMatrix[8]=r,this._velocityMatrix[9]=a,this._velocityMatrix[10]=l},a.prototype.applyForce=function(t,e,i,s,n){var o=.001*n,r=t*this._inverseMass*.5*o*o;this._offset[0]+=e*r,this._offset[1]+=i*r,this._offset[2]+=s*r,r=t*this._inverseMass*o,this._acceleration[0]+=e*r,this._acceleration[1]+=i*r,this._acceleration[2]+=s*r},a.prototype.applyTorque=function(t,e,s){var n=.001*s,o=t*this._inverseMass*n;this._hasAngularAcceleration=!0,i.mul3(this._orientationOffset,i.rotation3Aux(e,.5*o*n)),i.mul3(this._angularAccelerationMatrix,i.rotation3Aux(e,5*o*.001))},a.prototype.setPosition=function(t,e,i){this.pM[12]=t,this.pM[13]=e,this.pM[14]=i,this.mMValid=!1,this.mMIV=!1},a.prototype.translate=function(t,e,i){this.pM[12]+=t,this.pM[13]+=e,this.pM[14]+=i,this.mMValid=!1,this.mMIV=!1},a.prototype.updateOrientationMatrix=function(t){this.oM[0]=t[0],this.oM[1]=t[1],this.oM[2]=t[2],this.oM[4]=t[4],this.oM[5]=t[5],this.oM[6]=t[6],this.oM[8]=t[8],this.oM[9]=t[9],this.oM[10]=t[10],this.mMValid=!1,this.mMIV=!1},a.prototype.setOrientation=function(t,e,i,s,n,o){this.oM[0]=e*o-i*n,this.oM[1]=i*s-t*o,this.oM[2]=t*n-e*s,this.oM[4]=t,this.oM[5]=e,this.oM[6]=i,this.oM[8]=s,this.oM[9]=n,this.oM[10]=o,this.mMValid=!1,this.mMIV=!1},a.prototype.setScaling=function(t){this.sM[0]=t,this.sM[5]=t,this.sM[10]=t,this.mMValid=!1,this.mMIV=!1,this._inverseScalingFactor=1/t},a.prototype.getModelMatrix=function(){return this.mMValid||(i.setModelMatrix(this.mM,this.pM,this.oM,this.sM),this.mMValid=!0),this.mM},a.prototype.getModelMatrixInverse=function(){return this.mMIV||(i.updateModelMatrixInverse(this.mMI,this.pM,this.oM,this._inverseScalingFactor),this.mMIV=!0),this.mMI},a.prototype.applyForceAndTorque=function(t,s,n,o,r){var a,l,h=e.length3(t),c=e.scaled3Aux(t,1/h),u=e.scaled3Aux(c,e.dot3(s,c)),_=e.diff3Aux(s,u),p=.001*r,d=n*this._inverseMass*.5*p*p;this._offset[0]+=s[0]*d,this._offset[1]+=s[1]*d,this._offset[2]+=s[2]*d,d=n*this._inverseMass*p,this._velocityMatrix[12]+=s[0]*d,this._velocityMatrix[13]+=s[1]*d,this._velocityMatrix[14]+=s[2]*d,a=1!==o?n>0?Math.min(o*n*e.length3(_)*h,n/h):Math.max(o*n*e.length3(_)*h,n/h):n*e.length3(_)*h,l=e.normalize3(e.cross3Aux(_,c)),d=a*this._inverseMass*p,i.mul3(this._orientationOffset,i.rotation3Aux(l,.5*d*p)),i.mulRotation43(this._velocityMatrix,i.rotation3Aux(l,5*d*.001)),i.straightenRotation4(this._velocityMatrix,1e-5)},a.prototype._calculateBodySize=function(){var t,s,n=[0,0,0];for(this._bodySize=0,t=0;t<this._bodies.length;t++)e.setTranslationVector3(n,this._bodies[t].pM),s=e.prodVec3Mat3Aux(this._bodies[t].getHalfDimensions(),i.prod3x3SubOf43Aux(this.oM,this._bodies[t].oM)),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,s))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[s[0],s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[s[0],-s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[s[0],-s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[-s[0],s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[-s[0],s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[-s[0],-s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3Aux(n,[-s[0],-s[1],-s[2]])))},a.prototype.checkHit=function(t,i,s,n){var o,r,a=null;if(n*=this._inverseScalingFactor,e.setProdTranslationModel3(u,t,this.getModelMatrixInverse()),_[0]=i[12]-this._velocityMatrix[12],_[1]=i[13]-this._velocityMatrix[13],_[2]=i[14]-this._velocityMatrix[14],o=e.extractLength3(_),r=o*s*.001*this._inverseScalingFactor,Math.abs(u[0])-r<this._bodySize+n&&Math.abs(u[1])-r<this._bodySize+n&&Math.abs(u[2])-r<this._bodySize+n)for(u[3]=1,e.mulMat4Vec3(_,this.oM),o=0;null===a&&o<this._bodies.length;o++)a=this._bodies[o].checkHit(u,_,r,n);return a},a.prototype.checkHitRelative=function(t,e,i,s){var n,o=null;for(n=0;null===o&&n<this._bodies.length;n++)o=this._bodies[n].checkHit(t,e,i,s);return o},a.prototype._checkCollision=function(t,s,n,o){var r,a,l,h,c,g,m,f,S,T,E;for(f=this.getModelMatrixInverse(),i.setProd4(p,t.getModelMatrix(),f),i.setProdScalingRotation(d,t.sM,t.oM),o&&i.mulRotation43Multi(d,i.matrix3from4Aux(t._velocityMatrix),Math.round(.2*s)),i.translateByMatrix(d,t.pM),i.mul4(d,f),E=e.prodMat4Vec3Aux(this.oM,e.diffTranslation3Aux(t._velocityMatrix,this._velocityMatrix)),e.scale3(E,.001*s*this._inverseScalingFactor),d[12]+=E[0],d[13]+=E[1],d[14]+=E[2],n&&(S=i.matrix3from4Aux(this._velocityMatrix),i.mul3multi(S,i.matrix3Aux(S),Math.round(.2*s)),i.setProdRotationRotationInverse43(S,i.prod3x3SubOf43Aux(this.oM,S),this.oM),i.transpose3(S),i.mul43(d,S)),m=0,l=0;l<t._bodies.length;l++)for(h=0;h<8;h++)for(u[0]=t._bodies[l]._points[3*h],u[1]=t._bodies[l]._points[3*h+1],u[2]=t._bodies[l]._points[3*h+2],u[3]=1,e.setProdVec4Mat4(_,u,d),e.mulVec4Mat4(u,p),_[0]=(_[0]-u[0])*this.sM[0],_[1]=(_[1]-u[1])*this.sM[0],_[2]=(_[2]-u[2])*this.sM[0],r=e.extractLength3(_),T=1e3*r/s,r*=this._inverseScalingFactor,a=0;a<this._bodies.length;a++)(c=this._bodies[a].checkHit(u,_,r,0))&&this._bodies[a]._hitDistance<m&&(g=c,m=this._bodies[a]._hitDistance,this._collision.direction[0]=_[0],this._collision.direction[1]=_[1],this._collision.direction[2]=_[2],this._collision.magnitude=T);return g?(this._collision.reverse=!1,this._collision.position[0]=g[0],this._collision.position[1]=g[1],this._collision.position[2]=g[2],this._collision.position[3]=1,e.setProdVec3Mat4(_,this._collision.direction,this.oM),m-=.25*this._inverseScalingFactor,t._mass<=this._mass?(t.translate(_[0]*m*this.sM[0],_[1]*m*this.sM[0],_[2]*m*this.sM[0]),T=this._collision.magnitude*t._mass*1200):(this.translate(-_[0]*m*this.sM[0],-_[1]*m*this.sM[0],-_[2]*m*this.sM[0]),T=this._collision.magnitude*this._mass*1200),e.setProdVec4Mat4(u,this._collision.position,this.getModelMatrix()),this.applyForceAndTorque(e.diffVec3Mat4Aux(u,this.pM),_,T,.005,1),t.applyForceAndTorque(e.diffVec3Mat4Aux(u,t.pM),_,-T,.005,1),this._collision):null},a.prototype.checkCollision=function(t,s){var n,o,r,a,l;return n=this._bodySize*this.sM[0]+t.getBodySize()*t.sM[0],r=e.length3(e.diffTranslation3Aux(t._velocityMatrix,this._velocityMatrix))*s*.001,i.distanceSquared(t.pM,this.pM)>n*n+r*r+2*n*r?null:(a=0!==this._velocityMatrix[1]||0!==this._velocityMatrix[2]||0!==this._velocityMatrix[4]||0!==this._velocityMatrix[6]||0!==this._velocityMatrix[8]||0!==this._velocityMatrix[9],l=0!==t._velocityMatrix[1]||0!==t._velocityMatrix[2]||0!==t._velocityMatrix[4]||0!==t._velocityMatrix[6]||0!==t._velocityMatrix[8]||0!==t._velocityMatrix[9],r<1e-4&&!a&&!l?null:(o=this._checkCollision(t,s,a,l),o||(o=t._checkCollision(this,s,l,a))&&(o.reverse=!0),o))},a.prototype.simulate=function(t){var s,n,r;if(t>0){for(h>0&&this._dragFactor>0&&o(this._velocityMatrix,t,this._dragFactor),i.translateByMatrixMul(this.pM,this._velocityMatrix,.001*t),i.translateByVector(this.pM,this._offset),this.mMIV=!1,i.translateByVector(this._velocityMatrix,this._acceleration),e.setNull3(this._acceleration),e.setNull3(this._offset),i.straightenTranslation(this._velocityMatrix,1e-4),h>0&&this._dragFactor>0&&(r=i.identity3Aux(),n=c*this._dragFactor*t*.001,e.angle2y(this._velocityMatrix[4],this._velocityMatrix[5])>.001&&i.mul3(r,i.rotation3Aux(e.UNIT3_Z,this._velocityMatrix[4]>0?-n:n)),e.angle2x(this._velocityMatrix[5],this._velocityMatrix[6])>.001&&i.mul3(r,i.rotation3Aux(e.UNIT3_X,this._velocityMatrix[6]>0?n:-n)),e.angle2x(this._velocityMatrix[0],this._velocityMatrix[2])>.001&&i.mul3(r,i.rotation3Aux(e.UNIT3_Y,this._velocityMatrix[2]>0?-n:n)),i.mulRotation43(this._velocityMatrix,r)),s=0;s+2.5<t;s+=5)i.mulRotationRotation4(this.oM,this._velocityMatrix);this._hasAngularAcceleration&&(i.mulRotation43(this.oM,this._orientationOffset),i.setIdentity3(this._orientationOffset),i.mulRotation43(this._velocityMatrix,this._angularAccelerationMatrix),i.setIdentity3(this._angularAccelerationMatrix),this._hasAngularAcceleration=!1,i.straightenRotation4(this._velocityMatrix,1e-5)),i.correctOrthogonal4(this.oM),i.correctOrthogonal4(this._velocityMatrix),this.mMValid=!1,this.mMIV=!1}},{getDrag:s,setDrag:n,applyDrag:o,Body:r,PhysicalObject:a,ANGULAR_VELOCITY_MATRIX_DURATION:5,ANGULAR_VELOCITY_MATRIX_DURATION_S:.005,VELOCITY_MATRIX_ERROR_THRESHOLD:1e-4,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:1e-5}}),define("armada/strings",["modules/strings"],function(t){"use strict";function e(t){var e=t[0].toLowerCase();return"a"===e||"e"===e||"u"===e||"i"===e||"o"===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e}return t.GRAMMAR={DEFINITE_ARTICLE_BEFORE_VOWEL:{name:"grammar.definiteArticle.beforeVowel"},DEFINITE_ARTICLE_BEFORE_CONSONANT:{name:"grammar.definiteArticle.beforeConsonant"},AND:{name:"grammar.and"}},t.FIRST_RUN_NOTE={HEADER:{name:"firstRunNote.header"},MESSAGE:{name:"firstRunNote.message"},MESSAGE_WEB:{name:"firstRunNote.messageWeb"},BUTTON:{name:"firstRunNote.button"}},t.RELEASE_NOTES={PREFIX:{name:"releaseNotes.",optional:!0},HEADER:{name:"releaseNotes.header"},GENERAL:{name:"releaseNotes.general"},NO_NEWS:{name:"releaseNotes.noNews"},BUTTON:{name:"releaseNotes.button"}},t.FIRST_MULTI_RUN_NOTE={HEADER:{name:"firstMultiRunNote.header"},MESSAGE:{name:"firstMultiRunNote.message"},OK_BUTTON:{name:"firstMultiRunNote.okButton"},DO_NOT_SHOW_AGAIN_BUTTON:{name:"firstMultiRunNote.doNotShowAgainButton"},CANCEL_BUTTON:{name:"firstMultiRunNote.cancelButton"}},t.ANNOUNCEMENTS={HEADER:{name:"announcements.header"},BUTTON:{name:"announcements.button"}},t.SCREEN={BACK:{name:"screen.back"},CANCEL:{name:"screen.cancel"}},t.MAIN_MENU={SINGLE_PLAYER:{name:"mainMenu.singlePlayer"},MULTIPLAYER:{name:"mainMenu.multiplayer"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"},QUIT:{name:"mainMenu.quit"}},t.SINGLE_PLAYER_MENU={CAMPAIGN:{name:"singlePlayer.campaign"},MY_MISSIONS:{name:"singlePlayer.myMissions"},COMMUNITY_MISSIONS:{name:"singlePlayer.communityMissions"}},t.MISSIONS={BACK:{name:"missions.backButton"},CAMPAIGN_TITLE:{name:"missions.campaignTitle"},MY_MISSIONS_TITLE:{name:"missions.myMissionsTitle"},COMMUNITY_MISSIONS_TITLE:{name:"missions.communityMissionsTitle"},DIFFICULTY:{name:"missions.difficulty"},LAUNCH_BUTTON:{name:"missions.launchButton"},DEMO_BUTTON:{name:"missions.demoButton"},FILE_BUTTON:{name:"missions.fileButton"},CUSTOM_MISSION_CAPTION:{name:"missions.customMissionCaption"},CUSTOM_MISSION_SUBCAPTION:{name:"missions.customMissionSubcaption"},COMMUNITY_MISSION_SUBCAPTION:{name:"missions.communityMissionSubcaption"},NOT_COMPLETED:{name:"missions.notCompleted"},BEST_SCORE:{name:"missions.bestScore"},SANDBOX_COMPLETED:{name:"missions.sandboxCompleted"},NO_SELECTED_NAME:{name:"missions.noSelectedName"},NO_SELECTED_DESCRIPTION:{name:"missions.noSelectedDescription"},CUSTOM_DESCRIPTION:{name:"missions.customDescription"},MISSION_HUB_CONNECTING_DESCRIPTION:{name:"missions.missionHubConnectingDescription"},MISSION_HUB_DESCRIPTION:{name:"missions.missionHubDescription"},LOCATION:{name:"missions.location"},CREATED_BY:{name:"missions.createdBy"},LOADING_DESCRIPTION:{name:"missions.loadingDescription"},NO_TRANSLATED_DESCRIPTION:{name:"missions.noTranslatedDescription"},NO_DESCRIPTION:{name:"missions.noDescription"},OBJECTIVES_TITLE:{name:"missions.missionObjectivesTitle"},SPACECRAFT_TITLE:{name:"missions.playerSpacecraftTitle"},SPACECRAFT_DATA:{name:"missions.playerSpacecraftData"},SPACECRAFT_WEAPONS:{name:"missions.playerSpacecraftWeapons"},SPACECRAFT_MISSILES:{name:"missions.playerSpacecraftMissiles"},SPACECRAFT_SHIELD:{name:"missions.playerSpacecraftShield"},SPACECRAFT_PROPULSION:{name:"missions.playerSpacecraftPropulsion"},OBJECTIVE_SUBJECTS_SQUAD:{name:"missions.objectiveSubjects.squad"},OBJECTIVE_SUBJECTS_SQUADS:{name:"missions.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAM:{name:"missions.objectiveSubjects.team"},OBJECTIVE_SUBJECTS_TEAMS:{name:"missions.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"missions.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"missions.loseObjective.",optional:!0},SUBMIT_FILE_BUTTON:{name:"missions.submitFileButton"},SUBMIT_MISSION_ACCEPT_TERMS:{name:"missions.submitMissionAcceptTerms"},SUBMIT_MISSION_SUCCESS:{name:"missions.submitMissionSuccess"},SUBMIT_MISSION_HELP:{name:"missions.submitMissionHelp"},DELETE_SUBMISSION_BUTTON:{name:"missions.deleteSubmissionButton"},REVOKE_SUBMISSION_BUTTON:{name:"missions.revokeSubmissionButton"},DELETE_SUBMISSION_SUCCESS:{name:"missions.deleteSubmissionSuccess"},SUBMISSION_STATUS_PENDING:{name:"missions.submissionStatus.pending"},SUBMISSION_STATUS_APPROVED:{name:"missions.submissionStatus.approved"},SUBMISSION_STATUS_REJECTED:{name:"missions.submissionStatus.rejected"},SUBMISSION_STATS_STARTED:{name:"missions.submissionStats.started"},SUBMISSION_STATS_WON:{name:"missions.submissionStats.won"},SUBMISSION_STATS_LOST:{name:"missions.submissionStats.lost"}},t.SERVER_REGION={PREFIX:{name:"serverRegion.",optional:!0},UNKNOWN:{name:"serverRegion.unknown"},EU:{name:"serverRegion.EU"},US:{name:"serverRegion.US"}},t.MULTI_GAME_MODE={PREFIX:{name:"multiGames.gameMode.",optional:!0}},t.MULTI_GAMES={BACK:{name:"multiGames.backButton"},TITLE:{name:"multiGames.title"},STARTED_YES:{name:"multiGames.started.yes"},STARTED_NO:{name:"multiGames.started.no"},JOIN_BUTTON:{name:"multiGames.joinButton"},GAME_MODE:{name:"multiGames.mode"},MAX_PLAYERS:{name:"multiGames.maxPlayers"},DISCONNECT_MESSAGE:{name:"multiGames.disconnectMessage"},CANNOT_CONNECT_MESSAGE:{name:"multiGames.cannotConnectMessage"},GAME_NOT_FOUND_ERROR:{name:"multiGames.gameNotFoundError"},GAME_IS_FULL_ERROR:{name:"multiGames.gameIsFullError"},GAME_ALREADY_STARTED_ERROR:{name:"multiGames.gameAlreadyStartedError"},PLAYER_NAME_ALREADY_EXISTS_ERROR:{name:"multiGames.playerNameAlreadyExistsError"},GAME_NAME_ALREADY_EXISTS_ERROR:{name:"multiGames.gameNameAlreadyExistsError"},INVALID_GAME_SETTINGS_ERROR:{name:"multiGames.invalidGameSettingsError"},INVALID_PLAYER_NAME_ERROR:{name:"multiGames.invalidPlayerNameError"},INVALID_TEXT_ERROR:{name:"multiGames.invalidTextError"},SERVER_IS_FULL_ERROR:{name:"multiGames.serverIsFullError"},INCOMPATIBLE_API_VERSION_ERROR:{name:"multiGames.incompatibleApiVersionError"},NO_WELCOME_ERROR:{name:"multiGames.noWelcomeError"}},t.MULTI_LOBBY={GAME_TITLE:{name:"multiLobby.gameTitle"},CONNECTION_SERVER:{name:"multiLobby.connection.server"},CONNECTION_DIRECT:{name:"multiLobby.connection.direct"},READY_YES:{name:"multiLobby.ready.yes"},READY_NO:{name:"multiLobby.ready.no"},KICK_BUTTON:{name:"multiLobby.kickButton"},CHAT_MESSAGE_PLACEHOLDER:{name:"multiLobby.chatMessagePlaceholder"},LOCATION_LABEL:{name:"multiLobby.locationLabel"},LOADOUT_LABEL:{name:"multiLobby.loadoutLabel"},LOADOUT_PREFIX:{name:"multiLobby.loadout.",optional:!0},DIFFICULTY_LABEL:{name:"multiLobby.difficultyLabel"},ENEMIES_PER_WAVE_LABEL:{name:"multiLobby.enemiesPerWaveLabel"},HOST_LEFT_MESSAGE:{name:"multiLobby.hostLeftMessage"},KICKED_MESSAGE:{name:"multiLobby.kickedMessage"},GAME_CREATED_MESSAGE:{name:"multiLobby.gameCreatedMessage"},JOINED_MESSAGE:{name:"multiLobby.joinedMessage"},READY_MESSAGE:{name:"multiLobby.readyMessage"},PLAYER_JOINED_MESSAGE:{name:"multiLobby.playerJoinedMessage"},PLAYER_LEFT_MESSAGE:{name:"multiLobby.playerLeftMessage"},PLAYER_READY_MESSAGE:{name:"multiLobby.playerReadyMessage"},PLAYER_KICKED_MESSAGE:{name:"multiLobby.playerKickedMessage"}},t.OBJECTIVE={DESTROY_ALL_SUFFIX:{name:"destroyAll",optional:!0},DESTROY_SUFFIX:{name:"destroy",optional:!0},DESTROY_ONE_SUFFIX:{name:"destroyOne",optional:!0},DESTROY_ANY_SUFFIX:{name:"destroyAny",optional:!0},COUNT_BELOW_SUFFIX:{name:"countBelow",optional:!0},TIME_SUFFIX:{name:"time",optional:!0},TIME_MULTI_SUFFIX:{name:"timeMulti",optional:!0},MAX_HULL_INTEGRITY_SUFFIX:{name:"maxHullIntegrity",optional:!0},MAX_HULL_INTEGRITY_ANY_SUFFIX:{name:"maxHullIntegrityAny",optional:!0},MAX_HULL_INTEGRITY_ONE_SUFFIX:{name:"maxHullIntegrityOne",optional:!0},MAX_HULL_INTEGRITY_SELF_SUFFIX:{name:"maxHullIntegritySelf",optional:!0},DISTANCE_MIN_SUFFIX:{name:"distanceMin",optional:!0},DISTANCE_MAX_SUFFIX:{name:"distanceMax",optional:!0}},t.MISSION_HUB_ERROR={PREFIX:{name:"missionHubError.",optional:!0},DEFAULT_SUFFIX:{name:"default",optional:!0},GENERAL:{name:"missionHubError.general"}},t.MISSION_HUB_CLIENT_ERROR={PREFIX:{name:"missionHubClientError.",optional:!0},GENERAL:{name:"missionHubClientError.general"}},t.LOCATION={UNKNOWN:{name:"location.unknown"},SYSTEM:{name:"location.system"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},AUDIO:{name:"settings.audio"},GAMEPLAY:{name:"settings.gameplay"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},RESTART_HEADER:{name:"ingameMenu.restartDialog.header"},RESTART_MESSAGE:{name:"ingameMenu.restartDialog.message"},RESTART_RESTART:{name:"ingameMenu.restartDialog.restartButton"},QUIT:{name:"ingameMenu.quit"},QUIT_HEADER:{name:"ingameMenu.quitDialog.header"},QUIT_MESSAGE:{name:"ingameMenu.quitDialog.message"},QUIT_TO_MISSIONS:{name:"ingameMenu.quitDialog.quitToMissionsButton"},QUIT_TO_MAIN_MENU:{name:"ingameMenu.quitDialog.quitToMainMenuButton"},QUIT_MULTI:{name:"ingameMenu.quitMulti"},QUIT_MULTI_HEADER:{name:"ingameMenu.quitMultiDialog.header"},QUIT_MULTI_MESSAGE:{name:"ingameMenu.quitMultiDialog.message"},QUIT_TO_SCORE:{name:"ingameMenu.quitMultiDialog.quitToScoreButton"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},t.MISSION={PREFIX:{name:"mission.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0},MESSAGES_SUFFIX:{name:".messages.",optional:!0}},t.FACTION={PREFIX:{name:"faction.",optional:!0}},t.SQUAD={PREFIX:{name:"squad.",optional:!0}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},SCORE:{name:"battle.score"},HUD_FIREPOWER:{name:"battle.hud.firepower"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_WINGMEN_HEADER:{name:"battle.hud.wingmenHeader"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_MISSILES:{name:"battle.hud.missiles"},HUD_OBJECTIVES:{name:"battle.hud.objectives"},HUD_ESCORTED_SHIPS_HEADER:{name:"battle.hud.escortedShipsHeader"},OBJECTIVE_SUBJECTS_SPACECRAFTS:{name:"battle.objectiveSubjects.spacecrafts"},OBJECTIVE_SUBJECTS_SQUADS:{name:"battle.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAMS:{
name:"battle.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"battle.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"battle.loseObjective.",optional:!0},LOADING_BOX_LOADING_MISSION:{name:"battle.loadingBox.loadingMission"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_FAIL:{name:"battle.message.fail"},MESSAGE_DEFEAT_HEADER:{name:"battle.message.defeat.header"},MESSAGE_DEFEAT_MESSAGE:{name:"battle.message.defeat.message"},MESSAGE_DEFEAT_DEBRIEFING:{name:"battle.message.defeat.debriefingButton"},MESSAGE_DEFEAT_RESTART:{name:"battle.message.defeat.restartButton"},MESSAGE_DEFEAT_SPECTATE:{name:"battle.message.defeat.spectateButton"},MESSAGE_JUMP_ENGAGED:{name:"battle.message.jump.engaged"},MESSAGE_JUMP_PREPARING:{name:"battle.message.jump.preparing"},MESSAGE_NEW_HOSTILES:{name:"battle.message.newHostiles"}},t.MULTI_BATTLE={WAITING_FOR_OTHER_PLAYERS:{name:"battle.multi.waitingForOtherPlayers"},HOST_LEFT_MESSAGE:{name:"battle.multi.hostLeftMessage"},PLAYER_LEFT_MESSAGE:{name:"battle.multi.playerLeftMessage"},ALL_PLAYERS_LEFT_MESSAGE:{name:"battle.multi.allPlayersLeftMessage"},SLOW_CONNECTION:{name:"battle.multi.slowConnection"},CONNECTION_LOST:{name:"battle.multi.connectionLost"},CONNECTION_TIMEOUT:{name:"battle.multi.connectionTimeout"}},t.PERFORMANCE_LEVEL={PREFIX:{name:"performanceLevel.",optional:!0}},t.DEBRIEFING={BACK:{name:"debriefing.backButton"},VICTORY_TITLE:{name:"debriefing.victoryTitle"},DEFEAT_TITLE:{name:"debriefing.defeatTitle"},GENERIC_TITLE:{name:"debriefing.genericTitle"},SCORE:{name:"debriefing.score"},NEW_RECORD:{name:"debriefing.newRecord"},DESCRIPTION_VICTORY:{name:"debriefing.description.victory"},DESCRIPTION_NEXT_PERFORMANCE:{name:"debriefing.description.nextPerformance"},DESCRIPTION_FAIL:{name:"debriefing.description.fail"},DESCRIPTION_DEFEAT:{name:"debriefing.description.defeat"},DESCRIPTION_LEFT_EARLY:{name:"debriefing.description.leftEarly"},DESCRIPTION_GENERIC:{name:"debriefing.description.generic"},OBJECTIVES_HEADER:{name:"debriefing.objectivesHeader"},COMPLETED:{name:"debriefing.completed"},FAILED:{name:"debriefing.failed"},STATISTICS_HEADER:{name:"debriefing.statisticsHeader"},TIME_LABEL_CELL:{name:"debriefing.timeLabelCell"},KILLS_LABEL_CELL:{name:"debriefing.killsLabelCell"},DAMAGE_LABEL_CELL:{name:"debriefing.damageLabelCell"},HIT_RATIO_LABEL_CELL:{name:"debriefing.hitRatioLabelCell"},HULL_INTEGRITY_LABEL_CELL:{name:"debriefing.hullIntegrityLabelCell"},TEAM_SURVIVAL_LABEL_CELL:{name:"debriefing.teamSurvivalLabelCell"},BASE_SCORE_LABEL_CELL:{name:"debriefing.baseScoreLabelCell"},HIT_RATIO_BONUS_LABEL_CELL:{name:"debriefing.hitRatioBonusLabelCell"},HULL_INTEGRITY_BONUS_LABEL_CELL:{name:"debriefing.hullIntegrityBonusLabelCell"},TEAM_SURVIVAL_BONUS_LABEL_CELL:{name:"debriefing.teamSurvivalBonusLabelCell"},SCORE_BREAKDOWN_HEADER:{name:"debriefing.scoreBreakdownHeader"},RESTART_BUTTON:{name:"debriefing.restartButton"}},t.MULTI_SCORE={TITLE:{name:"multiScore.title"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},HEIGHT:{name:"database.height"},WEAPON_SLOTS:{name:"database.weaponSlots"},MISSILE_LAUNCHERS:{name:"database.missileLaunchers"},LOCK_RESIST:{name:"database.lockResist"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_GAME_DEV_PARAGRAPH:{name:"about.aboutGameDevParagraph"},LICENSE_NOTE:{name:"about.licenseNote"},CREDITS_HEADER:{name:"about.creditsHeader"},CREDITS_GAME_DESIGN:{name:"about.creditsGameDesign"},CREDITS_PROGRAMMING:{name:"about.creditsProgramming"},CREDITS_REQUIREJS_NOTE:{name:"about.creditsRequireJSNote"},CREDITS_FONTS:{name:"about.creditsFonts"},CREDITS_MODELS_TEXTURES_MUSIC:{name:"about.credits3DModelsTexturesMusic"},CREDITS_SFX:{name:"about.creditsSoundEffects"},CREDITS_FREESOUND_NOTE:{name:"about.creditsFreesoundNote"},CREDITS_OTHER_SOUNDS_NOTE:{name:"about.creditsOtherSoundsNote"},CREDITS_SOUND_LICENSE_NOTE:{name:"about.creditsSoundLicenseNote"},CREDITS_TESTING:{name:"about.creditsTesting"},USED_SOFTWARE_HEADER:{name:"about.usedSoftwareHeader"},USED_SOFTWARE_PARAGRAPH:{name:"about.usedSoftwareParagraph"},LICENSE_HEADER:{name:"about.licenseHeader"},LICENSE_PARAGRAPH:{name:"about.licenseParagraph"},REQUIRE_JS_LICENSE:{name:"about.requireJSLicense"},ELECTRON_LICENSE:{name:"about.electronLicense"},ELEVENLABS_TERMS:{name:"about.elevenlabsTerms"},HERE:{name:"about.here"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"},EASY:{name:"setting.easy"},HARD:{name:"setting.hard"},CUSTOM:{name:"setting.custom"},MISSION_ONLY:{name:"setting.missionOnly"},ALL:{name:"setting.all"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"},ANALYTICS:{name:"generalSettings.analytics"},ANALYTICS_NOTE:{name:"generalSettings.analyticsNote"},SHOW_DEMO_BUTTON:{name:"generalSettings.showDemoButton"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.backButton"},TITLE:{name:"graphics.title"},GENERAL_LEVEL:{name:"graphics.generalLevel"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},MISSILES_IN_LAUNCHERS:{name:"graphics.missilesInLaunchers"},THRUSTER_LIGHT_SOURCES:{name:"graphics.thrusterLightSources"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},t.GAMEPLAY_SETTINGS={PREFIX:{name:"gameplaySettings.",optional:!0},BACK:{name:"gameplaySettings.backButton"},TITLE:{name:"gameplaySettings.title"},HUD_TITLE:{name:"gameplaySettings.hudTitle"},CAMERA_TITLE:{name:"gameplaySettings.cameraTitle"},CONTROLS_TITLE:{name:"gameplaySettings.controlsTitle"},OTHER_TITLE:{name:"gameplaySettings.otherTitle"},TARGET_HEALTH_AT_CENTER:{name:"gameplaySettings.targetHealthAtCenter"},OFFSET_IMPACT_INDICATORS:{name:"gameplaySettings.offsetImpactIndicators"},RELATIVE_TARGET_ORIENTATION:{name:"gameplaySettings.relativeTargetOrientation"},SHOW_VERSION_INFO:{name:"gameplaySettings.showVersionInfo"},SHOW_FPS_COUNTER:{name:"gameplaySettings.showFpsCounter"},PREFERRED_FIGHTER_VIEW:{name:"gameplaySettings.preferredFighterView"},PREFERRED_SHIP_VIEW:{name:"gameplaySettings.preferredShipView"},DEMO_VIEW_SWITCHING:{name:"gameplaySettings.demoViewSwitching"},DEFAULT_SALVO_MODE:{name:"gameplaySettings.defaultSalvoMode"},SHOW_GENERIC_RADIO_MESSAGES:{name:"gameplaySettings.showGenericRadioMessages"},PLAY_RADIO_MESSAGES:{name:"gameplaySettings.playRadioMessages"},SHOW_READY_MESSAGE:{name:"gameplaySettings.showReadyMessage"}},t.AUDIO={PREFIX:{name:"audio.",optional:!0},BACK:{name:"audio.backButton"},TITLE:{name:"audio.title"},MASTER_VOLUME:{name:"audio.masterVolume"},MUSIC_VOLUME:{name:"audio.musicVolume"},SFX_VOLUME:{name:"audio.sfxVolume"},VOICE_VOLUME:{name:"audio.voiceVolume"},UI_VOLUME:{name:"audio.uiVolume"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.TOUCH_AREA={PREFIX:{name:"touchArea.",optional:!0},DEFAULT:{name:"touchArea.default"}},t.CONTROLLER_PROFILE={PREFIX:{name:"controllerProfile.",optional:!0},NONE:{name:"controllerProfile.none"}},t.CONTROLS={BACK:{name:"controls.backButton"},SETTINGS_TITLE:{name:"controls.settingsTitle"},TITLE:{name:"controls.title"},MOUSE_TURN_SENSITIVITY:{name:"controls.mouseTurnSensitivity"},POINTER_LOCK:{name:"controls.pointerLock"},CONTROLLER:{name:"controls.controller"},CONTROLLER_DISABLED:{name:"controls.controllerDisabled"},CONTROLLER_PROFILE:{name:"controls.controllerProfile"},VIBRATION_ENABLED:{name:"controls.vibrationEnabled"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.WEAPON_CLASS={PREFIX:{name:"weaponClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.MISSILE_CLASS={PREFIX:{name:"missileClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.PROPULSION_CLASS={PREFIX:{name:"propulsionClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SENSORS_CLASS={PREFIX:{name:"sensorsClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SHIELD_CLASS={PREFIX:{name:"shieldClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.MISSILE_SIZE={PREFIX:{name:"missileSize.",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t.TIP={PREFIX:{name:"tip.",optional:!0}},t.RADIO={PREFIX:{name:"radio.",optional:!0}},t.getDefiniteArticleForWord=function(i){return t.get(e(i)?t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_VOWEL:t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_CONSONANT)},t.getList=function(e){var i,s;for(i=e[0],s=1;s<e.length-1;s++)i+=", "+e[s];return e.length>1&&(i+=" "+t.get(t.GRAMMAR.AND)+" "+e[e.length-1]),i},t.getOnOffSettingValues=function(){return[t.get(t.SETTING.OFF),t.get(t.SETTING.ON)]},t.getOffSettingValue=function(){return[t.get(t.SETTING.OFF)]},t}),define("armada/logic/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","armada/graphics","armada/strings"],function(t,e,i,s,n,o,r,a,l,h,c,u,_){"use strict";function p(t){return Nt.getResource(Vt,t)}function d(t){return Nt.getResource(Ft,t)}function g(t){return Nt.getResource(Ut,t)}function m(t){return Nt.getResource(Bt,t)}function f(t){return Nt.getResource(Ht,t)}function S(t){return Nt.getResource(Gt,t)}function T(t){return Nt.getResource(kt,t)}function E(t){return Nt.getResource(jt,t)}function y(t){return Nt.getResource(Wt,t)}function M(t){return Nt.getResource(Yt,t)}function I(t){return Nt.getResource(Xt,t)}function C(t){return Nt.getResource(zt,t)}function A(t,e){return Nt.getResource(qt,t,{allowNullResult:e})}function v(t){var e,i=[],s=Nt.getResourceNames(qt);for(e=0;e<s.length;e++)t&&!A(s[e]).shouldShowInDatabase()||i.push(A(s[e]));return i}function N(){return Nt.getResourceTypes()}function O(t){return Nt.getResourceNames(t)}function L(t,e,i){return Nt.getResource(t,e,i)}function R(t,e){n.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",n.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function b(t,e){return R(t,e),0}function x(t,e){return R(t,e),""}function D(t,e){return R(t,e),[0,0]}function w(t,e){return R(t,e),[0,0,0]}function P(t,e){return R(t,e),[]}function V(t,e){return R(t,e),null}function F(t){t.resource=l.getSoundEffect(t.name)}function U(t,e){t.resource.play(l.SoundCategory.SOUND_EFFECT,t.volume,e)}function B(t,e,i,s,n,o){return t.resource?t.resource.createSoundClip(l.SoundCategory.SOUND_EFFECT,t.volume,e,s,n,o,i):null}function H(t,e,s){var n,o,r,a,l,h,c,u,_,p;for(n=0;n<t.thrusterSlots.length;n++){if(r=t.thrusterSlots[n].group,a=t.thrusterSlots[n].uses,t.thrusterSlots[n].count>0)for(l=t.thrusterSlots[n].position||w(e,"thrusterSlot array position"),h=t.thrusterSlots[n].vector||w(e,"thrusterSlot array vector"),c=t.thrusterSlots[n].size||b(e,"thrusterSlot array size"),u=t.thrusterSlots[n].count,_=t.thrusterSlots[n].lightFactor,o=0;o<u;o++)s.push(new ut({position:i.sum3(l,i.scaled3Aux(h,o)),size:c,lightFactor:_,groupIndex:r,uses:a}));if(t.thrusterSlots[n].thrusters)for(o=0;o<t.thrusterSlots[n].thrusters.length;o++)p=Object.assign({},t.thrusterSlots[n].thrusters[o]),p.groupIndex=r,p.uses=a,s.push(new ut(p))}}function G(t,e,i){var s,n;for(s=0,n=t[i];void 0===n&&s<e.length;s++)n=e[s][i];return n||null}function k(t,e){o.JSONResource.call(this,t,Ot,e)}function j(t,e){k.call(this,t,e)}function W(t,e){j.call(this,t,e)}function Y(t){W.call(this,t)}function X(t,e){W.call(this,t,e)}function z(t){X.call(this,t,!0)}function q(t){X.call(this,t,!0)}function J(t){k.call(this,t)}function Q(t){W.call(this,t)}function K(t){X.call(this,t,!0)}function Z(t){k.call(this,t)}function $(t){X.call(this,t)}function tt(t){X.call(this,t)}function et(t){this._positionVector=t?t.position?t.position.slice():w(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function it(t){this.axis=e.getValueOfType("WeaponRotator.axis",e.VECTOR3,t.axis),this.center=e.getValueOfType("WeaponRotator.center",e.VECTOR3,t.center),this.range=e.getValueOfType("WeaponRotator.range",e.VECTOR2,t.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(e.getValueOfType("WeaponRotator.defaultAngle",e.NUMBER,t.defaultAngle,0,!0)),this.restricted=!!this.range,this.rotationRate=Math.radians(e.getValueOfType("WeaponRotator.rotationRate",e.NUMBER,t.rotationRate)),this.transformGroupIndex=e.getValueOfType("WeaponRotator.transformGroupIndex",e.NUMBER,t.transformGroupIndex)}function st(t){X.call(this,t)}function nt(t){k.call(this,t)}function ot(t){k.call(this,t)}function rt(t){k.call(this,t)}function at(t){k.call(this,t)}function lt(t){k.call(this,t)}function ht(t){this.positionMatrix=t?s.translation4v(t.position||w(this,"position")):null,this.orientationMatrix=t?s.rotation4FromJSON(t.rotations||[]):null,this.clear=!!t&&(t.clear||!1)}function ct(e){var n,o,r;if(this.tubePositions=e?e.tubes?[]:P(this,"tubes"):null,this.tubePositions)for(n=0;n<e.tubes.length;n++)if(r=e.tubes[n],r.count>1)for(o=0;o<r.count;o++)this.tubePositions.push(i.sum3(r.position,i.scaled3Aux(r.vector,o)));else this.tubePositions.push(r.position);this.orientationMatrix=e?s.rotation4FromJSON(e.rotations||[]):null,this.size=e?t.getSafeEnumValue(xt,e.size,null)||x(this,"size"):null,this.capacity=e?e.capacity||b(this,"capacity"):0,this.salvo=e?e.salvo||1:0}function ut(t){this.positionVector=t?t.position.slice()||w(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||P(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:b(this,"groupIndex"):0,this.lightFactor=t?void 0!==t.lightFactor?t.lightFactor:1:0}function _t(t){this.className=t?t.class||x(this,"class"):null,this.slotIndex=t?t.slotIndex:-1}function pt(t){this.className=t?t.class||x(this,"class"):null,this.launcherIndex=t?t.launcherIndex:-1,this.amount=t?t.amount||b(this,"amount"):0}function dt(t){this.className=t?t.class||x(this,"class"):null}function gt(t){this.className=t?t.class||x(this,"class"):null}function mt(t){this.className=t?t.class||x(this,"class"):null}function ft(t){this.className=t?t.class||x(this,"class"):null}function St(t,e,i){var s,o,r,a,l,h,c,u,_,p,d=[];if(e)for(r=!1,o=t.basedOn;o;){for(a=!1,s=0;s<e.length;s++)if(e[s].name===o){d.indexOf(e[s])<0?(a=!0,d.push(e[s]),o=e[s].basedOn):(r=!0,o=null);break}r?n.showError("Circular reference detected in loadout '"+t.name+"'!"):a||(n.showError("Could not find referenced loadout '"+o+"'!"),o=null)}if(this._name=t.name||"custom",this._wDescriptors=[],l=G(t,d,"weapons"))for(s=0;s<l.length;s++)this._wDescriptors.push(new _t(l[s]));else i&&(this._wDescriptors=i._wDescriptors);if(this._mDescriptors=[],h=G(t,d,"missiles"))for(s=0;s<h.length;s++)this._mDescriptors.push(new pt(h[s]));else i&&(this._mDescriptors=i._mDescriptors);c=G(t,d,"propulsion"),this._propulsionDescriptor=c?new dt(c):i?i._propulsionDescriptor:null,u=G(t,d,"sensors"),this._sensorsDescriptor=u?new gt(u):i?i._sensorsDescriptor:null,_=G(t,d,"jumpEngine"),this._jumpEngineDescriptor=_?new mt(_):i?i._jumpEngineDescriptor:null,p=G(t,d,"shield"),this._shieldDescriptor=p?new ft(p):i?i._shieldDescriptor:null}function Tt(e){this._name=e?e.name||x(this,"name"):null,this._fps=!!e&&("boolean"==typeof e.fps&&e.fps),this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=!!e&&!0===e.movable,this._turnable=!!e&&!0===e.turnable,this.pM=e?s.translation4v(e.position||w(this,"position")):null,this.oM=e?s.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=!!e&&("boolean"==typeof e.resetsWhenLeavingConfines&&e.resetsWhenLeavingConfines),this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(h.CameraOrientationConfiguration.BaseOrientation,e.baseOrientation)||n.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(h.CameraOrientationConfiguration.PointToFallback,e.pointToFallback)||n.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.PointToFallback).join(", ")+"."):null,this._excludeFromCycle=!!e&&("boolean"==typeof e.excludeFromCycle&&e.excludeFromCycle)}function Et(e){var i;Tt.call(this,e),i=t.getSafeEnumValue(Rt,e.lookAt,Rt.NONE),this._isAimingView=!0===e.aimingView,this._followsPosition=void 0!==e.followsPosition?e.followsPosition:i!==Rt.SELF,this._followsOrientation=void 0!==e.followsOrientation?e.followsOrientation:i===Rt.NONE,this._lookAtSelf=i===Rt.SELF&&(!(this._followsPosition||this._followsOrientation||this._turnable)||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!")),this._lookAtTarget=i===Rt.TARGET&&(!this._followsOrientation&&!this._turnable||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!")),this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject&&(!!e.rotationCenterIsObject&&(!(this._lookAtSelf||!this._followsPosition)||n.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"))),this._startsWithRelativePosition=!0===e.startsWithRelativePosition&&(!this._followsPosition&&!this._rotationCenterIsObject||n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!")),this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||D(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=!0===e.movesRelativeToObject&&(!(this._rotationCenterIsObject||!this._followsPosition||!this._followsOrientation)||n.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!")),this._resetsOnFocusChange="boolean"==typeof e.resetsOnFocusChange&&e.resetsOnFocusChange,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function yt(e){Tt.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll&&e.turnAroundAll,this._lookAtAll=t.getSafeEnumValue(bt,e.lookAt,bt.NONE)===bt.ALL&&(!this._turnAroundAll&&!this._turnable||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!")),this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||D(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=!0===e.startsWithRelativePosition&&(!this._turnAroundAll||n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!")),!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function Mt(t){this.hullIntegrity=t?t.hullIntegrity||b(this,"hullIntegrity"):0,this.explosionClass=t?m(t.class||x(this,"class")):null}function It(t){this.position=t?t.position||w(this,"position"):null,this.color=t?t.color||[1,1,1]:null,this.intensity=t?t.intensity||b(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function Ct(t){this._particle=null,t.particle?this._particle=new z(t.particle):R(this,"particle"),this._position=t?t.position||w(this,"position"):null,this._period=t?t.period||b(this,"period"):0,this._blinks=t?t.blinks||P(this,"blinks"):null,this._intensity=t?t.intensity||b(this,"intensity"):0,this._lightColor=this._particle?[this._particle._color[0],this._particle._color[1],this._particle._color[2]]:null}function At(t){X.call(this,t)}function vt(t,e){var i={};i[Vt]=Y,i[Ft]=J,i[Ut]=Q,i[Bt]=Z,i[Ht]=$,i[kt]=st,i[jt]=nt,i[Wt]=ot,i[Gt]=tt,i[Yt]=rt,i[Xt]=at,i[zt]=lt,i[qt]=At,Nt.requestConfigLoad(t.filename,t.folder,i,function(){Nt.requestAllResources(),Nt.requestResourceLoad(),e&&e()}),Ot=t.folder}var Nt,Ot,Lt={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},Rt={NONE:"none",SELF:"self",TARGET:"target"},bt={NONE:"none",ALL:"all"},xt={SMALL:"small",MEDIUM:"medium",LARGE:"large"},Dt={NONE:0,INITIAL:1,CONTINUOUS:2},wt={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},Pt={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},Vt="skyboxClasses",Ft="backgroundObjectClasses",Ut="dustCloudClasses",Bt="explosionClasses",Ht="projectileClasses",Gt="missileClasses",kt="weaponClasses",jt="propulsionClasses",Wt="sensorsClasses",Yt="jumpEngineClasses",Xt="shieldClasses",zt="spacecraftTypes",qt="spacecraftClasses",Jt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,10],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}},Qt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,50],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}};return Object.freeze(Lt),Object.freeze(Rt),Object.freeze(bt),Object.freeze(Dt),Object.freeze(wt),Object.freeze(Pt),k.prototype=new o.JSONResource,k.prototype.constructor=k,k.prototype.showResourceAccessError=function(t,e){n.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},k.prototype.handleGraphicsSettingsChanged=function(){},j.prototype=new k,j.prototype.constructor=j,j.prototype._overrideData=function(t,e){k.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||x(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},j.prototype._loadData=function(t){return this._overrideData(null,t),!0},j.prototype.acquireResources=function(e){var i;e=e||t.EMPTY_OBJECT,i=e.overrideShaderName||this._shaderName,this._shader=u.getShader(i),this._instancedShaderName=l.getShader(i).getVariantShaderName("instanced"),this._instancedShaderName&&(this._instancedShader=u.getShader(this._instancedShaderName))},j.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=u.getManagedShader(this._shaderName)),this._managedShader)},j.prototype.getInstancedShader=function(){return null===this._instancedShader?(n.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=u.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},j.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},W.prototype=new j,W.prototype.constructor=W,W.prototype._overrideData=function(t,e){j.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},W.prototype._loadData=function(t){return this._overrideData(null,t),!0},W.prototype.acquireResources=function(t){j.prototype.acquireResources.call(this,t),t&&t.model?(this._model=l.getOrAddModel(t.model),this._modelName=this._model._name):this._model=u.getModel(this._modelName)},W.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},Y.prototype=new W,Y.prototype.constructor=Y,Y.prototype._loadData=function(t){return W.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||x(this,"cubemap"):null,this._cubemap=null,!0},Y.prototype.acquireResources=function(){W.prototype.acquireResources.call(this,{model:r.fvqModel("fvqModel")}),null===this._cubemap&&(this._cubemap=u.getCubemap(this._cubemapName))},Y.prototype.getCubemap=function(t){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(t)},Y.prototype.handleGraphicsSettingsChanged=function(){W.prototype.handleGraphicsSettingsChanged.call(this),this._cubemap=null},X.prototype=new W,X.prototype.constructor=X,X.prototype._overrideData=function(t,e){var i,s,o;for(W.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||x(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,o=u.getMaxLuminosityFactors();i<o;i++)this._defaultLuminosityFactors.push(0);if(e.defaultLuminosityFactors)for(i=0;i<e.defaultLuminosityFactors.length;i++)s=e.defaultLuminosityFactors[i][0],s<u.getMaxLuminosityFactors()?this._defaultLuminosityFactors[s]=e.defaultLuminosityFactors[i][1]:n.showError("Attempting to set luminosity of group with index "+s+", while there are only "+u.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",n.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this._name+"'.");else t&&(this._defaultLuminosityFactors=t._defaultLuminosityFactors.slice())},X.prototype._loadData=function(t){return this._overrideData(null,t),!0},X.prototype.acquireResources=function(t){W.prototype.acquireResources.call(this,t),null!==this._texture||t&&t.omitTextures||(this._texture=u.getTexture(this._textureName))},X.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},X.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},X.prototype.getDefaultGroupLuminosity=function(t){return this._defaultLuminosityFactors[t]},X.prototype.getDefaultGroupLuminosityFactors=function(){return this._defaultLuminosityFactors},X.prototype.handleGraphicsSettingsChanged=function(){W.prototype.handleGraphicsSettingsChanged.call(this),this._texture=null},z.prototype=new X,z.prototype.constructor=z,z.prototype._loadData=function(t){return X.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null,!0},z.prototype.acquireResources=function(){X.prototype.acquireResources.call(this,{model:r.squareModel("squareModel")})},z.prototype.getSize=function(){return this._size},q.prototype=new X,q.prototype.constructor=q,q.prototype._loadData=function(t){return X.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._startColor=t?t.startColor||[1,1,1,1]:null,this._endColor=t?t.endColor||this._startColor:null,this._duration=t?t.duration||b(this,"duration"):null,this._growthRate=t?t.growthRate||b(this,"growthRate"):null,!0},q.prototype.acquireResources=function(){X.prototype.acquireResources.call(this,{model:r.turningBillboardModel("squareModel",t.EMPTY_ARRAY,1)})},q.prototype.getSize=function(){return this._size},J.prototype=new k,J.prototype.constructor=J,J.prototype._loadData=function(t){var e;if(k.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor:null,this._layers=[],t)if(t.layers&&t.layers.length>0)for(e=0;e<t.layers.length;e++)this._layers.push(new z(t.layers[e]));else R(this,"layers");return!0},J.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},J.prototype.handleGraphicsSettingsChanged=function(){var t;for(k.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._layers.length;t++)this._layers[t].handleGraphicsSettingsChanged()},Q.prototype=new W,
Q.prototype.constructor=Q,Q.prototype._loadData=function(t){return W.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||b(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||b(this,"range"):0,!0},Q.prototype.acquireResources=function(){W.prototype.acquireResources.call(this,{model:r.lineModel("dust",[1,1,1])})},Q.prototype.getNumberOfParticles=function(){return this._numberOfParticles*u.getDustParticleCountFactor()},Q.prototype.getRange=function(){return this._range},K.prototype=new X,K.prototype.constructor=K,K.prototype._loadData=function(e){var i;if(X.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(Lt,e.type,Lt.OMNIDIRECTIONAL):null,this._hasProjectileModel=!!e&&(e.hasProjectileModel||!1),this._pModelWidth=e?e.projectileModelWidth||1:0,this._pModelIntersection=e?e.projectileModelIntersection||0:0,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==Lt.UNIDIRECTIONAL&&this._type!==Lt.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?e.duration||0:0,this._delay=e?e.delay||0:0,this._particleStates=null,e)if(this._particleStates=[],e.particleStates&&e.particleStates.length>0)for(i=0;i<e.particleStates.length;i++)this._particleStates.push(new c.ParticleState(e.particleStates[i].color,e.particleStates[i].size,e.particleStates[i].timeToReach));else R(this,"particleStates");return!0},K.prototype.acquireResources=function(){X.prototype.acquireResources.call(this,{model:this._hasProjectileModel?r.turningBillboardModel("projectileModel-"+this._pModelIntersection+"-width-"+this._pModelWidth+"-thickness-"+this._pModelWidth,[this._pModelIntersection],this._pModelWidth):r.squareModel("squareModel")})},K.prototype.getType=function(){return this._type},K.prototype.isContinuous=function(){return this._spawnNumber>0&&0===this._duration},K.prototype.getParticleStates=function(){return this._particleStates},K.prototype.getParticleDuration=function(){var t,e=0;for(t=1;t<this._particleStates.length;t++)e+=this._particleStates[t].timeToReach;return e},K.prototype.getTotalDuration=function(){var t=this._delay;return this._spawnNumber&&this._spawnTime&&(t+=Math.floor(this._duration/this._spawnTime)*this._spawnTime),t+=this.getParticleDuration()},K.prototype.getMaxParticleCount=function(){var t,e,i,s=this.getParticleDuration();return i=Math.floor(this._duration/this._spawnTime)+1,e=Math.ceil(s/this._spawnTime),t=this._spawnNumber*(this._duration?Math.min(i,e):e),this._initialNumber>this._spawnNumber?t+=this._initialNumber-this._spawnNumber:this._initialNumber<this._spawnNumber&&this._duration&&i<=e&&(t-=this._spawnNumber-this._initialNumber),t},Z.prototype=new k,Z.prototype.constructor=Z,Z.prototype._loadData=function(t){var i;if(k.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],i=0;i<t.particleEmitters.length;i++)this._particleEmitterDescriptors.push(new K(t.particleEmitters[i]));return this._lightStates=t?t.lightStates:null,this._soundEffect=t&&t.soundEffect?e.getVerifiedObject("explosionClasses['"+this._name+"'].soundEffect",t.soundEffect,Qt):null,!0},Z.prototype.acquireResources=function(t){var e;for(e=0;e<this._particleEmitterDescriptors.length;e++)this._particleEmitterDescriptors[e].acquireResources();t.sound&&this._soundEffect&&F(this._soundEffect)},Z.prototype.getLightStates=function(){return this._lightStates},Z.prototype.getTotalDuration=function(){var t,e,i=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)(e=this._particleEmitterDescriptors[t].getTotalDuration())>i&&(i=e);return i},Z.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)e+=this._particleEmitterDescriptors[t].getMaxParticleCount();return e},Z.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(this._particleEmitterDescriptors[t].isContinuous())return!0;return!1},Z.prototype.playSound=function(t,e,i,s){var n;this._soundEffect&&(n=B(this._soundEffect,!1,t,e,i,s))&&n.play()},Z.prototype.handleGraphicsSettingsChanged=function(){var t;for(k.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].handleGraphicsSettingsChanged()},$.prototype=new X,$.prototype.constructor=$,$.prototype._loadData=function(t){return X.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._width=t?t.width||1:0,this._thickness=t?t.thickness||this._width:0,this._mass=t?t.mass||b(this,"mass"):0,this._dragFactor=t?t.dragFactor||0:0,this._duration=t?t.duration||b(this,"duration"):0,this._dissipationDuration=t?t.dissipationDuration||b(this,"dissipationDuration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?this._muzzleFlash=new z(t.muzzleFlash):R(this,"muzzleFlash")),this._lightColor=t?t.lightColor||null:null,this._lightIntensity=t&&t.lightColor?t.lightIntensity||b(this,"lightIntensity"):0,this._explosionClass=t?m(t.explosion||x(this,"explosion")):null,this._shieldExplosionClass=t?m(t.shieldExplosion||x(this,"shieldExplosion")):null,!0},$.prototype.acquireResources=function(t){X.prototype.acquireResources.call(this,{model:r.turningBillboardModel("projectileModel-"+this._intersectionPositions.join("-")+"-width-"+this._width+"-thickness-"+this._thickness,this._intersectionPositions,this._width,this._thickness)}),t.projectileOnly||(this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources({sound:t.sound}),this._shieldExplosionClass.acquireResources({sound:t.sound}))},$.prototype.getDamage=function(){return this._damage},$.prototype.getSize=function(){return this._size},$.prototype.handleGraphicsSettingsChanged=function(){X.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},tt.prototype=new X,tt.prototype.constructor=tt,tt.prototype._loadData=function(i){var s;return X.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._shortName=i?i.shortName||this._fullName&&this._fullName.split(" ")[0].substring(0,5):null,this._antiFighter=!!i&&(i.antiFighter||!1),this._antiShip=!!i&&(i.antiShip||!1),this._damage=i?i.damage||0:0,this._modelScale=i?i.modelScale||1:0,this._size=i?t.getSafeEnumValue(xt,i.size,null)||x(this,"size"):null,this._capacity=i?i.capacity||1:0,this._length=i?i.length||b(this,"length"):0,this._homingMode=i?t.getSafeEnumValueForKey(Dt,i.homingMode,Dt.NONE):null,this._mass=i?i.mass||b(this,"mass"):0,this._dragFactor=i?void 0!==i.dragFactor?i.dragFactor:1:0,this._launchVelocity=i?i.launchVelocity||0:0,this._ignitionTime=i?i.ignitionTime||0:0,this._acceleration=i?i.acceleration||b(this,"acceleration"):0,this._thrust=i?this._mass*i.acceleration||b(this,"acceleration"):0,this._angularAcceleration=this._homingMode!==Dt.NONE&&i?Math.radians(i.angularAcceleration)||b(this,"angularAcceleration"):0,this._angularThrust=i?this._mass*this._angularAcceleration:0,this._mainBurnAngleThreshold=this._homingMode!==Dt.NONE&&i?Math.radians(i.mainBurnAngleThreshold)||b(this,"mainBurnAngleThreshold"):0,this._duration=i?i.duration||b(this,"duration"):0,this._lockingTime=this._homingMode!==Dt.NONE&&i?i.lockingTime||0:0,this._lockingAngle=this._lockingTime>0&&i?Math.radians(i.lockingAngle||0):0,this._cooldown=i?i.cooldown||b(this,"cooldown"):0,this._salvoCooldown=i?i.salvoCooldown||this._cooldown:0,this._proximityRange=i?i.proximityRange||0:0,this._kineticFactor=i?i.kineticFactor||1:0,this._lightColor=i?i.lightColor||null:null,this._lightIntensity=i&&i.lightColor?i.lightIntensity||b(this,"lightIntensity"):0,this._trailDescriptor=i?i.trail?new q(i.trail):V(this,"trail"):null,this._explosionClass=i?m(i.explosion||x(this,"explosion")):null,this._shieldExplosionClass=i?m(i.shieldExplosion||x(this,"shieldExplosion")):null,this._scoreValue=i?i.scoreValue||0:0,this._launchSound=i?e.getVerifiedObject("missileClasses['"+this._name+"'].launchSound",i.launchSound,Qt):null,this._startSound=i?e.getVerifiedObject("missileClasses['"+this._name+"'].startSound",i.startSound,Qt):null,this._propulsionClass=i?E(i.propulsion||x(this,"propulsion")):null,this._thrusterSlots=i?[]:null,i&&i.thrusterSlots?H(i,this,this._thrusterSlots):i&&R(this,"thrusterSlots"),this._enginePosition=this._thrusterSlots&&this._thrusterSlots.length>0?this._thrusterSlots[0].positionVector:[0,0,0],s=.001*(this._duration-this._ignitionTime),this._nominalRange=.001*this._duration*this._launchVelocity+.5*this._acceleration*s*s,!0},tt.prototype.acquireResources=function(t){X.prototype.acquireResources.call(this,t),t.missileOnly||(this._explosionClass.acquireResources({sound:t.sound}),this._shieldExplosionClass.acquireResources({sound:t.sound}),this._propulsionClass.acquireResources({sound:!1}),t.sound&&(F(this._launchSound),F(this._startSound)),t.trail&&this._trailDescriptor.acquireResources())},tt.prototype.getDisplayName=function(){return _.get(_.MISSILE_CLASS.PREFIX,this._name+_.MISSILE_CLASS.NAME_SUFFIX.name,this._fullName)},tt.prototype.getDamage=function(t){return Math.max(0,this._damage-t)},tt.prototype.getNominalRange=function(){return this._nominalRange},tt.prototype.getFireRate=function(){return 1e3/this._cooldown},tt.prototype.getLockingTime=function(){return this._lockingTime},tt.prototype.getSize=function(){return this._size},tt.prototype.getThrust=function(){return this._thrust},tt.prototype.getAngularThrust=function(){return this._angularThrust},tt.prototype.getLaunchForce=function(){return this._launchVelocity*this._mass*1e3},tt.prototype.getCooldown=function(){return this._cooldown},tt.prototype.getPropulsionClass=function(){return this._propulsionClass},tt.prototype.getMaxCount=function(){return Math.ceil(this._duration/this._cooldown)},tt.prototype.getParticleCount=function(){return this._thrusterSlots.length},tt.prototype.getScoreValue=function(){return this._scoreValue},tt.prototype.playLaunchSound=function(t,e,i,s){t?U(this._launchSound,t):B(this._launchSound,!1,e,!0,i,s).play()},tt.prototype.playStartSound=function(t){var e=B(this._startSound,!1,t);return e.play(),e},tt.prototype.getEnginePosition=function(){return this._enginePosition},tt.prototype.getTargetHitTime=function(e,i,s){var n,o,r,a;return n=this._acceleration*this._acceleration*.25,o=-(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),r=2*s[0]*(e[12]-i[0])+2*s[1]*(e[13]-i[1])+2*s[2]*(e[14]-i[2]),a=-i[0]*i[0]-e[12]*e[12]+2*i[0]*e[12]-i[1]*i[1]-e[13]*e[13]+2*i[1]*e[13]-i[2]*i[2]-e[14]*e[14]+2*i[2]*e[14],t.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3(n,o,r,a)},tt.prototype.handleGraphicsSettingsChanged=function(){X.prototype.handleGraphicsSettingsChanged.call(this),this._trailDescriptor.handleGraphicsSettingsChanged()},et.prototype.getPositionVector=function(){return this._positionVector},st.prototype=new X,st.prototype.constructor=st,st.prototype._loadData=function(i){var s;if(X.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._pClass=i?f(i.projectile||x(this,"projectile")):null,this._pVelocity=i?i.projectileVelocity||b(this,"projectileVelocity"):0,this._cooldown=i?i.cooldown||b(this,"cooldown"):0,this._barrels=[],i)if(i.barrels)for(s=0;s<i.barrels.length;s++)this._barrels.push(new et(i.barrels[s]));else R(this,"barrels");if(this._attachmentPoint=i?i.attachmentPoint||[0,0,0]:null,this._rotationStyle=i?t.getSafeEnumValue(wt,i.rotationStyle,wt.NONE):null,this._fixed=this._rotationStyle===wt.NONE,this._basePoint=i&&!this._fixed?i.basePoint&&i.basePoint.slice()||[0,0,0]:null,this._basePoint&&this._basePoint.push(1),this._rotators=[],i&&!this._fixed)if(i.rotators)for(s=0;s<i.rotators.length;s++)this._rotators.push(new it(i.rotators[s]));else R(this,"rotators");return this._fireSound=i?e.getVerifiedObject("weaponClasses['"+this._name+"'].fireSound",i.fireSound,Qt):null,this._scoreValue=i?i.scoreValue||0:0,!0},st.prototype.acquireResources=function(t){X.prototype.acquireResources.call(this,t),t.projectileResources&&this._pClass.acquireResources({projectileOnly:!1,sound:t.sound}),t.sound&&F(this._fireSound),t.barrelMarkers&&(l.getOrAddModel(r.positionMarkerModel("marker",8)),t.barrelMarkerShaderName&&u.getShader(t.barrelMarkerShaderName))},st.prototype.getDisplayName=function(){return _.get(_.WEAPON_CLASS.PREFIX,this._name+_.WEAPON_CLASS.NAME_SUFFIX.name,this._fullName)},st.prototype.getCooldown=function(){return this._cooldown},st.prototype.getProjectileClass=function(){return this._pClass},st.prototype.getProjectileVelocity=function(){return this._pVelocity},st.prototype.getFireForce=function(){return this._pVelocity*this._pClass._mass*1e3},st.prototype.getDamage=function(t){return this._barrels.length*Math.max(0,this.getProjectileClass().getDamage()-(t||0))},st.prototype.getFirepower=function(t){return 1e3*this.getDamage(t)/this._cooldown},st.prototype.getFireRate=function(){return 1e3/this._cooldown},st.prototype.playFireSound=function(t,e,i,s){t?U(this._fireSound,t):B(this._fireSound,!1,e,!0,i,s).play()},st.prototype.getScoreValue=function(){return this._scoreValue},st.prototype.getMaxProjectileCount=function(){return this._barrels.length*Math.ceil(this._pClass._duration/this._cooldown)},st.prototype.getMaxExplosionCount=function(){return this._barrels.length*Math.ceil(Math.max(this._pClass._explosionClass.getTotalDuration(),this._pClass._shieldExplosionClass.getTotalDuration())/this._cooldown)},st.prototype.getMaxParticleCount=function(){return this._barrels.length*(1+this.getMaxExplosionCount(this._cooldown)*Math.max(this._pClass._explosionClass.getMaxParticleCount(),this._pClass._shieldExplosionClass.getMaxParticleCount()))},nt.prototype=new k,nt.prototype.constructor=nt,nt.prototype._loadData=function(t){var i;return k.prototype._loadData.call(this,t),i=t?t.referenceMass||1:null,this._fullName=t?t.fullName||this._name:null,this._thrusterBurnParticle=new z(t),this._thrust=t?i*t.thrust||b(this,"thrust"):0,this._angularThrust=t?i*Math.radians(t.angularThrust)||b(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||b(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||b(this,"maxTurnBurnLevel"):0,this._thrusterSound=t?e.getVerifiedObject("propulsionClasses['"+this._name+"'].thrusterSound",t.thrusterSound,Qt):null,this._scoreValue=t?t.scoreValue||0:0,!0},nt.prototype.acquireResources=function(t){this._thrusterBurnParticle.acquireResources(),t.sound&&F(this._thrusterSound)},nt.prototype.getDisplayName=function(){return _.get(_.PROPULSION_CLASS.PREFIX,this._name+_.PROPULSION_CLASS.NAME_SUFFIX.name,this._fullName)},nt.prototype.getThrust=function(){return this._thrust},nt.prototype.getAngularThrust=function(){return this._angularThrust},nt.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},nt.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},nt.prototype.handleGraphicsSettingsChanged=function(){k.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},nt.prototype.createThrusterSoundClip=function(t){return B(this._thrusterSound,!0,t)},nt.prototype.getThrusterSoundVolume=function(){return this._thrusterSound.volume},nt.prototype.getScoreValue=function(){return this._scoreValue},ot.prototype=new k,ot.prototype.constructor=ot,ot.prototype._loadData=function(t){return k.prototype._loadData.call(this,t),this._fullName=t?t.fullName||this._name:null,this._range=t?t.range||b(this,"range"):0,this._scoreValue=t?t.scoreValue||0:0,!0},ot.prototype.acquireResources=function(){return!0},ot.prototype.getDisplayName=function(){return _.get(_.SENSORS_CLASS.PREFIX,this._name+_.SENSORS_CLASS.NAME_SUFFIX.name,this._fullName)},ot.prototype.getRange=function(){return this._range},ot.prototype.getScoreValue=function(){return this._scoreValue},rt.prototype=new k,rt.prototype.constructor=rt,rt.prototype._loadData=function(t){return k.prototype._loadData.call(this,t),this._engageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].engageSound",t.engageSound,Jt):null,this._disengageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].disengageSound",t.disengageSound,Jt):null,this._prepareVelocity=t?void 0!==t.prepareVelocity?t.prepareVelocity:b(this,"prepareVelocity"):0,this._prepareDuration=t?void 0!==t.prepareDuration?t.prepareDuration:b(this,"prepareDuration"):0,this._prepareSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].prepareSound",t.prepareSound,Qt):null,this._cancelSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].cancelSound",t.cancelSound,Qt):null,this._jumpOutAcceleration=t?t.jumpOutAcceleration||b(this,"jumpOutAcceleration"):0,this._jumpOutScaling=t?t.jumpOutScaling||1:0,this._jumpOutDuration=t?t.jumpOutDuration||b(this,"jumpOutDuration"):0,this._jumpOutSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpOutSound",t.jumpOutSound,Qt):null,this._jumpOutExplosionClass=t?m(t.jumpOutExplosion||x(this,"jumpOutExplosion")):null,this._jumpInDeceleration=t?t.jumpInDeceleration||this._jumpOutAcceleration:0,this._jumpInVelocity=t?void 0!==t.jumpInVelocity?t.jumpInVelocity:this._prepareVelocity:0,this._jumpInScaling=t?t.jumpInScaling||this._jumpOutScaling:0,this._jumpInDuration=t?t.jumpInDuration||this._jumpOutDuration:0,this._jumpInSound=t?t.jumpInSound?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpInSound",t.jumpInSound,Qt):this._jumpOutSound:null,this._jumpInExplosionClass=t?t.jumpInExplosion?m(t.jumpInExplosion):this._jumpOutExplosionClass:null,!0},rt.prototype.acquireResources=function(t){t.sound&&(F(this._engageSound),F(this._disengageSound),F(this._prepareSound),F(this._cancelSound),F(this._jumpOutSound),F(this._jumpInSound)),this._jumpOutExplosionClass.acquireResources({sound:t.sound}),this._jumpInExplosionClass.acquireResources({sound:t.sound})},rt.prototype.createEngageSoundClip=function(){return B(this._engageSound,!1)},rt.prototype.createDisengageSoundClip=function(){return B(this._disengageSound,!1)},rt.prototype.createPrepareSoundClip=function(t){return B(this._prepareSound,!1,t)},rt.prototype.createCancelSoundClip=function(t){return B(this._cancelSound,!1,t)},rt.prototype.createJumpOutSoundClip=function(t){return B(this._jumpOutSound,!1,t)},rt.prototype.createJumpInSoundClip=function(t){return B(this._jumpInSound,!1,t)},at.prototype=new k,at.prototype.constructor=at,at.prototype._loadData=function(t){return k.prototype._loadData.call(this,t),this._fullName=t?t.fullName||this._name:null,this._capacity=t?t.capacity||b(this,"capacity"):0,this._rechargeDelay=t?void 0!==t.rechargeDelay?t.rechargeDelay:b(this,"rechargeDelay"):0,this._rechargeRate=t?t.rechargeRate||b(this,"rechargeRate"):0,this._rechargeColor=t?t.rechargeColor||[1,1,1]:null,this._rechargeAnimationDuration=t?t.rechargeAnimationDuration||b(this,"rechargeAnimationDuration"):0,this._rechargeStartSound=t?e.getVerifiedObject("ShieldClasses['"+this._name+"'].rechargeStartSound",t.rechargeStartSound,Qt):null,this._scoreValue=t?t.scoreValue||0:0,!0},at.prototype.acquireResources=function(t){t.sound&&F(this._rechargeStartSound)},at.prototype.getDisplayName=function(){return _.get(_.SHIELD_CLASS.PREFIX,this._name+_.SHIELD_CLASS.NAME_SUFFIX.name,this._fullName)},at.prototype.getRechargeDelay=function(){return this._rechargeDelay},at.prototype.getRechargeRate=function(){return this._rechargeRate},at.prototype.createRechargeStartSoundClip=function(t){return B(this._rechargeStartSound,!1,t)},at.prototype.getScoreValue=function(){return this._scoreValue},lt.prototype=new k,lt.prototype.constructor=lt,lt.prototype._loadData=function(t){return k.prototype._loadData.call(this,t),this._isFighterType=!!t&&!0===t.isFighterType,this._fullName=t?t.fullName||this._name:null,this._description=t?"string"==typeof t.description?t.description:x(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null,!0},lt.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this._name+_.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},lt.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this._name+_.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},lt.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(C(this._goodAgainstTypeNames[t]))},lt.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(C(this._badAgainstTypeNames[t]))},lt.prototype.isGoodAgainst=function(t){return this._goodAgainstTypeNames.indexOf(t._name)>=0},lt.prototype.isBadAgainst=function(t){return this._badAgainstTypeNames.indexOf(t._name)>=0},Tt.prototype.isFPS=function(){return this._fps},Tt.prototype.getFOV=function(){return this._fov},Tt.prototype.getFOVRange=function(){return this._fovRange},Tt.prototype.getSpan=function(){return this._span},Tt.prototype.isMovable=function(){return this._movable},Tt.prototype.isTurnable=function(){return this._turnable},Tt.prototype.getAlphaRange=function(){return this._alphaRange},Tt.prototype.getBetaRange=function(){return this._betaRange},Tt.prototype.getConfines=function(){return this._confines},Tt.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},Tt.prototype.getBaseOrientation=function(){return this._baseOrientation},Tt.prototype.getPointToFallback=function(){return this._pointToFallback},Tt.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},Tt.prototype.destroy=function(){this._fovRange=null,this.pM=null,this.oM=null,this._alphaRange=null,this._betaRange=null,this._confines=null},Et.prototype=new Tt,Et.prototype.constructor=Et,Et.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},Et.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},Et.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},Et.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},Et.prototype.getDistanceRange=function(){return this._distanceRange},Et.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},Et.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},Et.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},Et.prototype.createCameraConfiguration=function(t,e,i,n,o){var r,a,l=s.getYawAndPitch(this.oM);return r=new h.CameraPositionConfiguration(!this.isMovable(),this.turnsAroundObjects(),this.movesRelativeToObject(),this.getPositionFollowedObjectsForObject(t),this.startsWithRelativePosition(),s.copy(this.pM),this.getDistanceRange(),this.getConfines(),this.resetsWhenLeavingConfines()),a=new h.CameraOrientationConfiguration(!this.isTurnable(),this.pointsTowardsObjects(),this.isFPS(),this.getOrientationFollowedObjectsForObject(t),s.copy(this.oM),Math.degrees(l.yaw),Math.degrees(l.pitch),this.getAlphaRange(),this.getBetaRange(),this.getBaseOrientation()||e,this.getPointToFallback()||i),new h.CameraConfiguration(this._name,r,a,this.getFOV()||n,this.getFOVRange(),this.getSpan()||o,this.resetsOnFocusChange(),this.shouldExcludeFromCycle())},Et.prototype.destroy=function(){Tt.prototype.destroy.call(this),this._distanceRange=null},yt.prototype=new Tt,yt.prototype.constructor=yt,yt.prototype.turnsAroundObjects=function(){return this._turnAroundAll},yt.prototype.movesRelativeToObject=function(){return!1},yt.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},yt.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},yt.prototype.getDistanceRange=function(){return this._distanceRange},yt.prototype.pointsTowardsObjects=function(){return this._lookAtAll},yt.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},yt.prototype.resetsOnFocusChange=function(){return!1},yt.prototype.destroy=function(){Tt.prototype.destroy.call(this),this._distanceRange=null},Ct.prototype.acquireResources=function(){this._particle.acquireResources()},Ct.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new c.ParticleState(this._particle._color,0,0)),i.push(new c.ParticleState(this._particle._color,0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new c.ParticleState(this._particle._color,this._particle.getSize(),0)),i.push(new c.ParticleState(this._particle._color,0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new c.ParticleState(this._particle._color,0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));else i.push(new c.ParticleState(this._particle._color,this._particle.getSize(),0));return i},Ct.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this._lightColor,intensity:0,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this._lightColor,intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});else i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0});return i},Ct.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},At.prototype=new X,At.prototype.constructor=At,At.prototype._overrideData=function(o,r){var l,h,c,u,_,p,d,g;switch(X.prototype._overrideData.call(this,o,r),this._scType=o?r.type?C(r.type):o._scType:C(r.type||x(this,"type")),this._fullName=o?r.fullName||o._fullName:r.fullName||this._name,this._showInDatabase=o?"boolean"==typeof r.showInDatabase?r.showInDatabase:o._showInDatabase:"boolean"!=typeof r.showInDatabase||r.showInDatabase,this._description=o?r.description||o._description:r.description||(this._showInDatabase?x(this,"description"):""),this._hitpoints=o?r.hitpoints||o._hitpoints:r.hitpoints||b(this,"hitpoints"),this._armor="number"==typeof r.armor?r.armor:o?o._armor:0,this._factionColor=o?r.factionColor||o._factionColor:r.factionColor||null,this._turnStyle=r.turnStyle?t.getSafeEnumValue(Pt,r.turnStyle,Pt.YAW_PITCH):o?o._turnStyle:Pt.YAW_PITCH,this._attackVector=r.attackVector?i.normal3(r.attackVector):o?o._attackVector:[0,1,0],this._attackVectorAngles=[0,0],g={yaw:0,pitch:0,roll:0},this._turnStyle){case Pt.YAW_PITCH:i.getYawAndPitch(g,this._attackVector),this._attackVectorAngles[0]=g.yaw,this._attackVectorAngles[1]=g.pitch;break;case Pt.ROLL_YAW:i.getRollAndYaw(g,this._attackVector,!1),this._attackVectorAngles[0]=g.roll,this._attackVectorAngles[1]=g.yaw;break;case Pt.ROLL_PITCH:i.getRollAndPitch(g,this._attackVector,!1),this._attackVectorAngles[0]=g.roll,this._attackVectorAngles[1]=g.pitch}if(this._attackThresholdAngle=Math.radians(r.attackThresholdAngle)||(o?o._attackThresholdAngle:0),this._mass=o?r.mass||o._mass:r.mass||b(this,"mass"),this._dragFactor=o?void 0!==r.dragFactor?r.dragFactor:o._dragFactor:void 0!==r.dragFactor?r.dragFactor:1,this._bodies=o&&!r.bodies?o._bodies:[],r.bodies)for(l=0;l<r.bodies.length;l++)this._bodies.push(new a.Body(s.translation4v(r.bodies[l].position||w(this,"bodies[i].position")),s.rotation4FromJSON(r.bodies[l].rotations),r.bodies[l].size));else o||R(this,"bodies");if(this._wSlots=o&&!r.weaponSlots?o._wSlots:[],r.weaponSlots)for(l=0;l<r.weaponSlots.length;l++)if(r.weaponSlots[l].count>1)for(c=r.weaponSlots[l].position||w(this,"weaponSlot array position"),u=r.weaponSlots[l].vector||w(this,"weaponSlot array vector"),_=r.weaponSlots[l].rotations,p=r.weaponSlots[l].count,d=r.weaponSlots[l].clear,h=0;h<p;h++)this._wSlots.push(new ht({position:i.sum3(c,i.scaled3Aux(u,h)),rotations:_,clear:d}));else this._wSlots.push(new ht(r.weaponSlots[l]));if(this._mLs=o&&!r.missileLaunchers?o._mLs:[],r.missileLaunchers)for(l=0;l<r.missileLaunchers.length;l++)this._mLs.push(new ct(r.missileLaunchers[l]));if(this._thrusterSlots=o&&!r.thrusterSlots?o._thrusterSlots:[],r.thrusterSlots&&H(r,this,this._thrusterSlots),this._views=o&&!r.views?o._views:[],r.views)for(l=0;l<r.views.length;l++)this._views.push(new Et(r.views[l]));else o||R(this,"views");if(this._loadouts=o&&!r.loadouts?o._loadouts:{},r.loadouts)for(l=0;l<r.loadouts.length;l++)this._loadouts[r.loadouts[l].name]=new St(r.loadouts[l],r.loadouts);if(this._defaultLoadout=o?r.defaultLoadout||o._defaultLoadout:r.defaultLoadout||null,this._defaultLoadout&&!this._loadouts[this._defaultLoadout]&&(n.showError("Non-existing default loadout '"+this._defaultLoadout+"' specified for spacecraft class "+this._name+"!",n.ErrorSeverity.MINOR),this._defaultLoadout=null),this._humSound=r.humSound?e.getVerifiedObject("spacecraftClasses['"+this._name+"'].humSound",r.humSound,Qt):o?o._humSound:null,this._collisionSound=r.collisionSound?e.getVerifiedObject("spacecraftClasses['"+this._name+"'].collisionSound",r.collisionSound,Qt):o?o._collisionSound:null,this._explosionClass=o?r.explosion?m(r.explosion):o._explosionClass:m(r.explosion||x(this,"explosion")),this._showTimeRatioDuringExplosion=void 0!==r.showTimeRatioDuringExplosion?r.showTimeRatioDuringExplosion:o?o._showTimeRatioDuringExplosion:b(this,"showTimeRatioDuringExplosion"),this._damageIndicators=o&&!r.damageIndicators?o._damageIndicators:[],r.damageIndicators)for(l=0;l<r.damageIndicators.length;l++)this._damageIndicators.push(new Mt(r.damageIndicators[l]));if(this._lightSources=o&&!r.lights?o._lightSources:[],r.lights)for(l=0;l<r.lights.length;l++)this._lightSources.push(new It(r.lights[l]));if(this._blinkerDescriptors=o&&!r.blinkers?o._blinkerDescriptors:[],r.blinkers)for(l=0;l<r.blinkers.length;l++)this._blinkerDescriptors.push(new Ct(r.blinkers[l]));this._lockingTimeFactor=void 0!==r.lockingTimeFactor?r.lockingTimeFactor:o?o._lockingTimeFactor:1,this._scoreValue=o?r.scoreValue||o._scoreValue:r.scoreValue||0},At.prototype._loadData=function(t){var e;return t.basedOn?(e=A(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t),!0},At.prototype.isFighterClass=function(){return this._scType._isFighterType},At.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this._name+_.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},At.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this._name+_.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},At.prototype.shouldShowInDatabase=function(){return this._showInDatabase},At.prototype.getMissileLaunchersBySize=function(){var t,e={};for(t=0;t<this._mLs.length;t++)e[this._mLs[t].size]?e[this._mLs[t].size].push(this._mLs[t]):e[this._mLs[t].size]=[this._mLs[t]];return e},
At.prototype.getLoadout=function(t){return this._loadouts[t]},At.prototype.getLoadoutNames=function(){return Object.keys(this._loadouts)},At.prototype.getView=function(t){var e;for(e=0;e<this._views.length;e++)if(this._views[e]._name===t)return this._views[e];return null},At.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},At.prototype.acquireResources=function(t){var e;if(X.prototype.acquireResources.call(this,t),t.explosion&&this._explosionClass.acquireResources({sound:t.sound}),t.damageIndicators)for(e=0;e<this._damageIndicators.length;e++)this._damageIndicators[e].explosionClass.acquireResources({sound:t.sound});if(t.blinkers)for(e=0;e<this._blinkerDescriptors.length;e++)this._blinkerDescriptors[e].acquireResources();t.sound&&(this._humSound&&F(this._humSound),this._collisionSound&&F(this._collisionSound))},At.prototype.handleGraphicsSettingsChanged=function(){var t;if(X.prototype.handleGraphicsSettingsChanged.call(this),this._blinkerDescriptors)for(t=0;t<this._blinkerDescriptors.length;t++)this._blinkerDescriptors[t].handleGraphicsSettingsChanged()},At.prototype.hasHumSound=function(){return!!this._humSound},At.prototype.createHumSoundClip=function(t){return this._humSound?B(this._humSound,!0,t):null},At.prototype.playCollisionSound=function(t){return this._collisionSound&&U(this._collisionSound,t),null},At.prototype.getScoreValue=function(){return this._scoreValue},Nt=new o.ResourceManager,u.onSettingsChange(function(){Nt.executeForAllResources(function(t){t.handleGraphicsSettingsChanged()})}),{MARKER_MODEL_NAME:"marker",SHADER_VARIANT_INSTANCED_NAME:"instanced",SOUND_EFFECT:Jt,ParticleEmitterType:Lt,ObjectViewLookAtMode:Rt,SceneViewLookAtMode:bt,MissileSize:xt,MissileHomingMode:Dt,WeaponRotationStyle:wt,SpacecraftTurnStyle:Pt,TexturedModelClass:X,getSkyboxClass:p,getBackgroundObjectClass:d,getDustCloudClass:g,getExplosionClass:m,getMissileClass:S,getWeaponClass:T,getPropulsionClass:E,getSensorsClass:y,getJumpEngineClass:M,getShieldClass:I,getSpacecraftType:C,getSpacecraftClass:A,getSpacecraftClassesInArray:v,getClassCategories:N,getClassNames:O,getClass:L,createClass:Nt.createResource.bind(Nt),Loadout:St,ObjectView:Et,SceneView:yt,requestLoad:vt,executeWhenReady:Nt.executeWhenReady.bind(Nt),executeForAllClasses:Nt.executeForAllResources.bind(Nt),renameClass:Nt.renameResource.bind(Nt),moveClassAfter:Nt.moveResourceAfter.bind(Nt)}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/scene/camera","armada/logic/classes","armada/constants"],function(t,e,i,s,n,o){"use strict";function r(){i.AsyncResource.call(this),this._configuration=null,this._settings=null,this._hudSettings={}}var a,l,h,c,u,_,p,d,g,m=o.LOCAL_STORAGE_PREFIX+"settings_",f={};return f.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},f.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR3},DIRECTION:{name:"direction",type:e.VECTOR3}}},f.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:t.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:t.ScaleMode,optional:!0}}},f.TEXTURE_MAPPING={baseType:"array",elementType:e.VECTOR2,length:2},f.UI_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:f.TEXTURE_MAPPING,optional:!0},SIZE:{name:"size",type:e.VECTOR2},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},COLOR:{name:"color",type:e.COLOR4}}},f.UI_LAID_OUT_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:f.TEXTURE_MAPPING},LAYOUT:{name:"layout",type:f.LAYOUT_DESCRIPTOR},COLOR:{name:"color",type:e.COLOR4}}},f.TEXT_DESCRIPTOR={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR4},FONT_SIZE:{name:"fontSize",type:"number"},FONT_NAME:{name:"fontName",type:"string"},POSITION:{name:"position",type:e.VECTOR2},LAYOUT:{name:"layout",type:f.LAYOUT_DESCRIPTOR,optional:!0}}},f.AI_PRESET={baseType:"object",properties:{NAME:{name:"name",type:"string"},EVASION_DELAY_FACTOR:{name:"evasionDelayFactor",type:"number",optional:!0},FIRE_DELAY_FACTOR:{name:"fireDelayFactor",type:"number",optional:!0},AIM_UPDATE_INTERVAL:{name:"aimUpdateInterval",type:"number",optional:!0},MAX_AIM_ERROR:{name:"maxAimError",type:"number",optional:!0},AIM_ERROR_RESET_DISTANCE:{name:"aimErrorResetDistance",type:"number",optional:!0}}},f.CRAFT_INDICATOR_POSITIONS={baseType:"array",elementType:{baseType:"array",elementType:e.VECTOR2}},f.NUMBER_ARRAY={baseType:"array",elementType:"number"},f.STRING_ARRAY={baseType:"array",elementType:"string"},f.getCustomDescriptor=function(e,i,s){var n,o,r,a,l=t.deepCopy(e);for(r=Object.keys(i),n=0;n<r.length;n++){for(a=l.properties[r[n]],l.properties[r[n]+"S"]={name:a.name+"s",type:{baseType:"object",properties:{}}},o=0;o<i[r[n]].length;o++)l.properties[r[n]+"S"].type.properties[i[r[n]][o].toUpperCase()]={name:i[r[n]][o],type:a.type};delete l.properties[r[n]]}if(s)for(n=0;n<s.length;n++)delete l.properties[s[n]];return l},a={CLASSES_SOURCE_FILE:{name:"classes",type:f.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:f.FILE_DESCRIPTOR},MISSION_FILES:{name:"missions",type:{baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}}}},l={UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},BUTTON_SELECT_SOUND:{name:"buttonSelectSound",type:n.SOUND_EFFECT},BUTTON_CLICK_SOUND:{name:"buttonClickSound",type:n.SOUND_EFFECT},SHOW_DEMO_BUTTON:{name:"showDemoButton",type:"boolean"}},h={MAX_PLAYER_OPTIONS:{name:"maxPlayerOptions",type:f.NUMBER_ARRAY},SPACECRAFTS:{name:"spacecrafts",type:f.STRING_ARRAY},LOADOUTS:{name:"loadouts",type:f.STRING_ARRAY}},c={},u={SHOW_GENERIC_RADIO_MESSAGES:{name:"showGenericRadioMessages",type:"boolean"},PLAY_GENERIC_RADIO_MESSAGES:{name:"playGenericRadioMessages",type:"boolean"},PLAY_MISSION_RADIO_MESSAGES:{name:"playMissionRadioMessages",type:"boolean"},SHOW_READY_MESSAGE:{name:"showReadyMessage",type:"boolean"},HITBOX_COLOR:{name:"hitboxColor",type:e.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},DEFAULT_FIGHTER_VIEW_NAME:{name:"defaultFighterViewName",type:"string"},DEFAULT_FIGHTER_VIEW_NAME_OPTIONS:{name:"defaultFighterViewNameOptions",type:f.STRING_ARRAY},DEFAULT_SHIP_VIEW_NAME:{name:"defaultShipViewName",type:"string"},DEFAULT_SHIP_VIEW_NAME_OPTIONS:{name:"defaultShipViewNameOptions",type:f.STRING_ARRAY},HUD:{name:"hud",ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER:{name:"alwaysShowTargetHullBarAtCenter",type:"boolean"},AIM_ASSIST_CROSSHAIRS:{name:"aimAssistCrosshairs",type:"boolean"},RELATIVE_TARGET_ORIENTATION:{name:"relativeTargetOrientation",type:"boolean"},SHOW_VERSION_INFO:{name:"showVersionInfo",type:"boolean"},SHOW_FPS_COUNTER:{name:"showFpsCounter",type:"boolean"},CENTER_CROSSHAIR:{name:"centerCrosshair",type:f.UI_IMAGE_DESCRIPTOR},CURSOR:{name:"cursor",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{MAPPING:["still","turn"]})},SHIP_ARROW:{name:"shipArrow",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["default","target"]})},SHIP_INDICATOR:{name:"shipIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["minimum","targetMinimum","maximum"]})},MISSILE_LOCK_INDICATOR:{name:"missileLockIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["hostileTarget","friendlyTarget"]},["SIZE"])},DISTANCE_TEXT_LAYER_LAYOUT:{name:"distanceTextLayerLayout",type:f.LAYOUT_DESCRIPTOR},DISTANCE_TEXT:{name:"distanceText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"]})},SHIP_STATUS_INDICATOR:{name:"shipStatusIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{MAPPING:["protect","destroy","transmission"],COLOR:["protect","destroy","transmission"],SIZE:["reticle","arrow"]})},AIM_ASSIST_INDICATOR:{name:"aimAssistIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","appear","hit"]})},WEAPON_IMPACT_INDICATOR:{name:"weaponImpactIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["normal","outOfRange"]})},TARGET_VIEW_LAYOUT:{name:"targetViewLayout",type:f.LAYOUT_DESCRIPTOR},TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"targetViewTargetItemFullIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"targetViewTargetItemHalfIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"targetViewTargetItemZeroIntegrityColor",type:e.COLOR4},TARGET_INFO_BACKGROUND:{name:"targetInfoBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},TARGET_HULL_INTEGRITY_BAR:{name:"targetHullIntegrityBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_SHIELD_BAR:{name:"targetShieldBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"targetInfoTextLayerLayout",type:f.LAYOUT_DESCRIPTOR},TARGET_INFO_TEXT:{name:"targetInfoText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"],FONT_SIZE:["name","others"],POSITION:["name","class","team","firepower","distance","velocity"]})},WINGMEN_STATUS_BACKGROUND:{name:"wingmenStatusBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},WINGMEN_STATUS_HEADER_TEXT:{name:"wingmenStatusHeaderText",type:f.TEXT_DESCRIPTOR},WINGMEN_STATUS_CRAFT_INDICATOR:{name:"wingmenStatusCraftIndicator",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{MAPPING:["player","shield","general","interceptor","bomber","heavyFighter"],COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed","away","fullShieldIntegrity","halfShieldIntegrity","zeroShieldIntegrity"]})},WINGMEN_STATUS_CRAFT_POSITIONS:{name:"wigmenStatusCraftPositions",type:f.CRAFT_INDICATOR_POSITIONS},WINGMEN_STATUS_SQUAD_LAYOUT:{name:"wigmenStatusSquadLayout",type:f.LAYOUT_DESCRIPTOR},WINGMEN_STATUS_SQUAD_TEXT:{name:"wingmenStatusSquadText",type:f.TEXT_DESCRIPTOR},SPEED_BAR:{name:"speedBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["combatFilled","combatEmpty","combatReverseFilled","combatReverseEmpty","cruiseFilled","cruiseEmpty","cruiseReverseFilled","cruiseReverseEmpty","freeFilled","freeEmpty","freeReverseFilled","freeReverseEmpty"]})},SPEED_TEXT_LAYER_LAYOUT:{name:"speedTextLayerLayout",type:f.LAYOUT_DESCRIPTOR},SPEED_TEXT:{name:"speedText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["combatForward","combatReverse","cruiseForward","cruiseReverse","freeForward","freeReverse"],POSITION:["maxForward","maxReverse"]})},SPEED_TARGET_INDICATOR:{name:"speedTargetIndicator",type:f.UI_IMAGE_DESCRIPTOR},MISSILE_INDICATOR:{name:"missileIndicator",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{MAPPING:["single","salvo"],COLOR:["ready","locking","loading"]})},MISSILE_INDICATOR_TEXT_LAYOUT:{name:"missileIndicatorTextLayout",type:f.LAYOUT_DESCRIPTOR},MISSILE_INDICATOR_TEXT:{name:"missileIndicatorText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["ready","locking","loading"]})},HULL_INTEGRITY_BAR:{name:"hullIntegrityBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},SHIELD_BAR:{name:"shieldBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},FLIGHT_MODE_INDICATOR_BACKGROUND:{name:"flightModeIndicatorBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},FLIGHT_MODE_HEADER_TEXT:{name:"flightModeHeaderText",type:f.TEXT_DESCRIPTOR},FLIGHT_MODE_TEXT:{name:"flightModeText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["free","combat","cruise"]})},MISSILE_INFO_BACKGROUND:{name:"missileInfoBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},MISSILE_INFO_HEADER_TEXT:{name:"missileInfoHeaderText",type:f.TEXT_DESCRIPTOR},MISSILE_INFO_TEXT:{name:"missileInfoText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["readySelected","lockingSelected","loadingSelected","notSelected","empty"],POSITION:["name","count"]})},DRIFT_ARROW:{name:"driftArrow",type:f.getCustomDescriptor(f.UI_IMAGE_DESCRIPTOR,{COLOR:["minSpeed","maxSpeed"]})},TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR:{name:"targetHullIntegrityQuickViewBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["hostileFilled","hostileEmpty","friendlyFilled","friendlyEmpty","filledWhenDecreasing"]})},TARGET_SHIELD_QUICK_VIEW_BAR:{name:"targetShieldQuickViewBar",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing"]})},HEADER_TEXT_LAYER_LAYOUT:{name:"headerTextLayerLayout",type:f.LAYOUT_DESCRIPTOR},SMALL_HEADER_TEXT:{name:"smallHeaderText",type:f.TEXT_DESCRIPTOR},BIG_HEADER_TEXT:{name:"bigHeaderText",type:f.TEXT_DESCRIPTOR},SUBHEADER_TEXT:{name:"subheaderText",type:f.TEXT_DESCRIPTOR},MESSAGE_BACKGROUND:{name:"messageBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},MESSAGE_TEXT:{name:"messageText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["default","jump","alert","controlString","friendlySpacecraft","hostileSpacecraft","slowConnection","connectionLost"]})},TOP_LEFT_TEXT_LAYER_LAYOUT:{name:"topLeftTextLayerLayout",type:f.LAYOUT_DESCRIPTOR},SCORE_TEXT:{name:"scoreText",type:f.TEXT_DESCRIPTOR},OBJECTIVES_BACKGROUND:{name:"objectivesBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},OBJECTIVES_HEADER_TEXT:{name:"objectivesHeaderText",type:f.TEXT_DESCRIPTOR},OBJECTIVES_TEXT:{name:"objectivesText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["inProgress","completed","failed"]})},ESCORTS_BACKGROUND:{name:"escortsBackground",type:f.UI_LAID_OUT_IMAGE_DESCRIPTOR},ESCORTS_HEADER_TEXT:{name:"escortsHeaderText",type:f.TEXT_DESCRIPTOR},ESCORTS_TEXT:{name:"escortsText",type:f.getCustomDescriptor(f.TEXT_DESCRIPTOR,{COLOR:["alive","away","destroyed"]})},ESCORTS_INTEGRITY_BARS:{name:"escortsIntegrityBars",type:f.getCustomDescriptor(f.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["fullHull","halfHull","zeroHull","awayHull","destroyed","shield","lostShield"],LAYOUT:["hull","shield"]})},TARGET_SWITCH_SOUND:{name:"targetSwitchSound",type:n.SOUND_EFFECT},TARGET_SWITCH_DENIED_SOUND:{name:"targetSwitchDeniedSound",type:n.SOUND_EFFECT},FLIGHT_MODE_SWITCH_SOUND:{name:"flightModeSwitchSound",type:n.SOUND_EFFECT},MISSILE_CHANGE_SOUND:{name:"missileChangeSound",type:n.SOUND_EFFECT},MISSILE_CHANGE_DENIED_SOUND:{name:"missileChangeDeniedSound",type:n.SOUND_EFFECT},MISSILE_SALVO_SOUND:{name:"missileSalvoSound",type:n.SOUND_EFFECT},MISSILE_LOADED_SOUND:{name:"missileLoadedSound",type:n.SOUND_EFFECT},MISSILE_LOCKING_SOUND:{name:"missileLockingSound",type:n.SOUND_EFFECT},MISSILE_LOCKED_SOUND:{name:"missileLockedSound",type:n.SOUND_EFFECT},MESSAGE_SOUND:{name:"messageSound",type:n.SOUND_EFFECT},MESSAGE_TYPE_SOUND:{name:"messageTypeSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_SOUND:{name:"newHostilesAlertSound",type:n.SOUND_EFFECT},CONNECTION_WARNING_SOUND:{name:"connectionWarningSound",type:n.SOUND_EFFECT}},PILOT_VOICES:{name:"pilotVoices",type:f.STRING_ARRAY},VOICE_MESSAGES:{name:"voiceMessages",type:f.STRING_ARRAY},AI_PRESETS:{name:"aiPresets",type:"array",elementType:f.AI_PRESET},DEMO_VIEW_SWITCHING:{name:"demoViewSwitching",type:"boolean"},ANTICIPATION_MUSIC:{name:"anticipationMusic",type:f.STRING_ARRAY},COMBAT_MUSIC:{name:"combatMusic",type:f.STRING_ARRAY},DEFAULT_SALVO_MODE:{name:"defaultSalvoMode",type:"boolean"}},_={},p=m+u.HUD.name+"_",d=m+"battle_",Object.freeze(f),r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.loadConfigurationFromJSON=function(t){this._configuration=e.getVerifiedObject("configuration",t,a)},r.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},r.prototype.getSetting=function(t){return this._settings[t.name]},r.prototype.getGeneralSetting=function(t){var i;return void 0!==localStorage[m+t.name]&&(i=e.getValueOfTypeFromLocalStorage(t.type,m+t.name)),void 0!==i?i:this._settings[t.name]},r.prototype.setGeneralSetting=function(t,e){localStorage[m+t.name]=e},r.prototype.getBattleSetting=function(t){var i;return void 0!==localStorage[d+t.name]&&(i=e.getValueOfTypeFromLocalStorage(t.type,d+t.name)),void 0!==i?i:this._settings[t.name]},r.prototype.setBattleSetting=function(t,e){localStorage[d+t.name]=e},r.prototype.gHS=function(t){var i;return void 0===this._hudSettings[t.name]&&(void 0!==localStorage[p+t.name]&&(i=e.getValueOfTypeFromLocalStorage(t.type,p+t.name)),this._hudSettings[t.name]=void 0!==i?i:this._settings[u.HUD.name][t.name]),this._hudSettings[t.name]},r.prototype.setHUDSetting=function(t,e){localStorage[p+t.name]=e,this._hudSettings[t.name]=e},r.prototype.resetGeneralSettings=function(){var t,e,i=Object.keys(l);for(t=0;t<i.length;t++)"object"==typeof l[i[t]]&&(e=l[i[t]].name,localStorage.removeItem(m+e))},r.prototype.resetHUDSettings=function(){var t,e,i=Object.keys(u.HUD);for(t=0;t<i.length;t++)"object"==typeof u.HUD[i[t]]&&(e=u.HUD[i[t]].name,localStorage.removeItem(p+e),this._hudSettings[e]=this._settings[u.HUD.name][e])},r.prototype.resetBattleSettings=function(){var t,e=Object.keys(u);for(t=0;t<e.length;t++)"object"==typeof u[e[t]]&&localStorage.removeItem(d+u[e[t]].name)},r.prototype.getDefaultCameraFOV=function(){return 40},r.prototype.getDefaultCameraSpan=function(){return.2},r.prototype.getDefaultCameraBaseOrientation=function(){return"orientationFollowedObject"},r.prototype.getDefaultCameraPointToFallback=function(){return"positionFollowedObjectOrWorld"},r.prototype.getDefaultCameraConfigurationName=function(t){return t.isFighter()?this.getBattleSetting(u.DEFAULT_FIGHTER_VIEW_NAME):this.getBattleSetting(u.DEFAULT_SHIP_VIEW_NAME)},r.prototype.loadSettingsFromJSON=function(t){this._settings=e.getVerifiedObject("general",t.general,l),e.getVerifiedObject("multi",t.multi,h,this._settings),e.getVerifiedObject("database",t.database,c,this._settings),e.getVerifiedObject("battle",t.battle,u,this._settings),e.getVerifiedObject("camera",t.camera,_,this._settings),n.requestLoad(this.getConfigurationSetting(a.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},g=new r,{CONFIGURATION:a,GENERAL_SETTINGS:l,MULTI_SETTINGS:h,BS:u,DATABASE_SETTINGS:c,CAMERA_SETTINGS:_,loadConfigurationFromJSON:g.loadConfigurationFromJSON.bind(g),loadSettingsFromJSON:g.loadSettingsFromJSON.bind(g),getConfigurationSetting:g.getConfigurationSetting.bind(g),getSetting:g.getSetting.bind(g),getGeneralSetting:g.getGeneralSetting.bind(g),setGeneralSetting:g.setGeneralSetting.bind(g),gHS:g.gHS.bind(g),setHUDSetting:g.setHUDSetting.bind(g),getBattleSetting:g.getBattleSetting.bind(g),setBattleSetting:g.setBattleSetting.bind(g),resetGeneralSettings:g.resetGeneralSettings.bind(g),resetHUDSettings:g.resetHUDSettings.bind(g),resetBattleSettings:g.resetBattleSettings.bind(g),getDefaultCameraFOV:g.getDefaultCameraFOV.bind(g),getDefaultCameraSpan:g.getDefaultCameraSpan.bind(g),getDefaultCameraBaseOrientation:g.getDefaultCameraBaseOrientation.bind(g),getDefaultCameraPointToFallback:g.getDefaultCameraPointToFallback.bind(g),getDefaultCameraConfigurationName:g.getDefaultCameraConfigurationName.bind(g),executeWhenReady:g.executeWhenReady.bind(g)}}),define("armada/audio",["utils/types","modules/application","modules/async-resource","modules/audio","modules/media-resources","armada/constants","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){i.AsyncResource.call(this),this._dataJSON=null,this._masterVolume=1,this._musicVolume=1,this._sfxVolume=1,this._voiceVolume=1,this._uiVolume=1,this._rolloffFactor=0,this._panningModel=I}function l(t,e,i){var s;A[e]&&A[e].name===t||(s=n.getMusic(t))&&!s.hasError()&&n.executeWhenReady(function(){A[e]={name:t,clip:s.createSoundClip(1,i)}})}function h(t,e,i,s){var n,o,r;t!==C&&(o=C?void 0===i?t&&!1!==s?d:g:i:0,r=t?void 0===i?C&&!1!==s?d:p:i:0,C&&A[C]&&(o>0?A[C].clip.rampVolume(0,o):A[C].clip.stopPlaying()),t&&A[t]&&(n=e?function(){C===t&&h(e,null,i,s)}:null,r>0?!1!==s?(A[t].clip.play(!0,n),A[t].clip.setVolume(0),A[t].clip.rampVolume(1,r)):setTimeout(function(){C===t&&(A[t].clip.play(!0,n),A[t].clip.setVolume(0),A[t].clip.rampVolume(1,r))},1e3*o):(A[t].clip.play(!0,n),A[t].clip.setVolume(1))),C=t)}function c(){var t,e=Object.keys(A);for(t=0;t<e.length;t++)A[e[t]]&&A[e[t]].clip.stopPlaying();C=null}function u(){s.resume()}function _(){s.stopLastClips()}var p,d,g,m,f=o.LOCAL_STORAGE_PREFIX+"audio_",S=f+"masterVolume",T=f+"musicVolume",E=f+"sfxVolume",y=f+"voiceVolume",M=f+"uiVolume",I=s.PanningModel.EQUAL_POWER,C=null,A={};return a.prototype=new i.AsyncResource,a.prototype.constructor=a,a.prototype.loadConfigurationFromJSON=function(e){e.rolloffFactor&&(this._rolloffFactor=t.getNumberValue("configuration.audio.rolloffFactor",e.rolloffFactor,0)),e.panningModel&&(this._panningModel=t.getEnumValue(s.PanningModel,e.panningModel,{name:"configuration.audio.panningModel"}))},a.prototype.loadSettingsFromJSON=function(i,s){if("object"!=typeof i)return void e.showError("Cannot initialize audio settings from JSON: audio section missing or has wrong type ('"+typeof i+"')!");s=s||!1,s||(this._dataJSON=i),this.setMasterVolume(t.getNumberValue("settings.audio.masterVolume",i.masterVolume,1),!1),this.setMusicVolume(t.getNumberValue("settings.audio.musicVolume",i.musicVolume,1),!1),this.setSFXVolume(t.getNumberValue("settings.audio.sfxVolume",i.sfxVolume,1),!1),this.setUIVolume(t.getNumberValue("settings.audio.uiVolume",i.uiVolume,1),!1)},a.prototype.loadFromLocalStorage=function(){var i,s,n=function(n,o,r,a){void 0!==localStorage[n]&&(s={silentFallback:e.hasVersionChanged(),defaultValue:r},i=t.getValueOfTypeFromLocalStorage(o,n,s),s.error&&!e.hasVersionChanged()||a(i,!!s.error&&s.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};n(S,"number",this.getMasterVolume(),this.setMasterVolume.bind(this)),n(T,"number",this.getMusicVolume(),this.setMusicVolume.bind(this)),n(E,"number",this.getSFXVolume(),this.setSFXVolume.bind(this)),n(M,"number",this.getUIVolume(),this.setUIVolume.bind(this)),this.setToReady()},a.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(S),localStorage.removeItem(T),localStorage.removeItem(E),localStorage.removeItem(M)},a.prototype.getMasterVolume=function(){return this._masterVolume},a.prototype.setMasterVolume=function(t,e){return void 0===e&&(e=!0),this._masterVolume=t,s.setMasterVolume(this._masterVolume),e&&(localStorage[S]=t.toString()),this._masterVolume===t},a.prototype.resetMasterVolume=function(){this.setMasterVolume(void 0!==localStorage[S]?localStorage[S]:this._dataJSON.masterVolume)},a.prototype.getMusicVolume=function(){return this._musicVolume},a.prototype.setMusicVolume=function(t,e){return void 0===e&&(e=!0),this._musicVolume=t,s.setMusicVolume(this._musicVolume),e&&(localStorage[T]=t.toString()),this._musicVolume===t},a.prototype.resetMusicVolume=function(){this.setMusicVolume(void 0!==localStorage[T]?localStorage[T]:this._dataJSON.musicVolume)},a.prototype.getSFXVolume=function(){return this._sfxVolume},a.prototype.setSFXVolume=function(t,e){return void 0===e&&(e=!0),this._sfxVolume=t,s.setEffectVolume(this._sfxVolume),e&&(localStorage[E]=t.toString()),this._sfxVolume===t},a.prototype.resetSFXVolume=function(){this.setSFXVolume(void 0!==localStorage[E]?localStorage[E]:this._dataJSON.sfxVolume)},a.prototype.getVoiceVolume=function(){return this._voiceVolume},a.prototype.setVoiceVolume=function(t,e){return void 0===e&&(e=!0),this._voiceVolume=t,s.setVoiceVolume(this._voiceVolume),e&&(localStorage[y]=t.toString()),this._voiceVolume===t},a.prototype.resetVoiceVolume=function(){this.setVoiceVolume(void 0!==localStorage[y]?localStorage[y]:this._dataJSON.voiceVolume)},a.prototype.getUIVolume=function(){return this._uiVolume},a.prototype.setUIVolume=function(t,e){return void 0===e&&(e=!0),this._uiVolume=t,s.setUIVolume(this._uiVolume),e&&(localStorage[M]=t.toString()),this._uiVolume===t},a.prototype.resetUIVolume=function(){this.setUIVolume(void 0!==localStorage[M]?localStorage[M]:this._dataJSON.uiVolume)},a.prototype.createSoundSource=function(t,e,i){return new s.SoundSource(t,e,i,this._panningModel,this._rolloffFactor)},m=new a,r.executeWhenReady(function(){p=.1,d=1.5,g=.1}),{SOUND_RAMP_DURATION:.1,SoundCategory:s.SoundCategory,loadConfigurationFromJSON:m.loadConfigurationFromJSON.bind(m),loadSettingsFromJSON:m.loadSettingsFromJSON.bind(m),loadSettingsFromLocalStorage:m.loadFromLocalStorage.bind(m),restoreDefaults:m.restoreDefaults.bind(m),getMasterVolume:m.getMasterVolume.bind(m),setMasterVolume:m.setMasterVolume.bind(m),resetMasterVolume:m.resetMasterVolume.bind(m),getMusicVolume:m.getMusicVolume.bind(m),setMusicVolume:m.setMusicVolume.bind(m),resetMusicVolume:m.resetMusicVolume.bind(m),getSFXVolume:m.getSFXVolume.bind(m),setSFXVolume:m.setSFXVolume.bind(m),resetSFXVolume:m.resetSFXVolume.bind(m),getVoiceVolume:m.getVoiceVolume.bind(m),setVoiceVolume:m.setVoiceVolume.bind(m),resetVoiceVolume:m.resetVoiceVolume.bind(m),getUIVolume:m.getUIVolume.bind(m),setUIVolume:m.setUIVolume.bind(m),resetUIVolume:m.resetUIVolume.bind(m),createSoundSource:m.createSoundSource.bind(m),executeWhenReady:m.executeWhenReady.bind(m),initMusic:l,playMusic:h,stopMusic:c,resume:u,stopLastClips:_}}),define("modules/pools",[],function(){"use strict";function t(t){this._objectConstructor=t,this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function e(e,s){var n=i[e]||new t(s);return i[e]=n,n}var i={};return t.prototype.markAsFree=function(t){this._objectsFree[t]||(this._freeIndices[this._firstLockedIndex]=t,this._objectsFree[t]=!0,++this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},t.prototype.getFreeObject=function(){var t;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,t=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),t):null},t.prototype.addObject=function(t){this._objects.push(t),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),++this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},t.prototype.getObjects=function(){return this._objects},t.prototype.getObject=function(){var t=this.getFreeObject();return t||(t=new this._objectConstructor,this.addObject(t)),t},t.prototype.hasLockedObjects=function(){return this._firstFreeIndex!==this._firstLockedIndex||!this._objectsFree[this._freeIndices[this._firstFreeIndex]]},t.prototype.getLockedObjectCount=function(){return this._firstFreeIndex===this._firstLockedIndex?this._objectsFree[this._freeIndices[this._firstFreeIndex]]?0:this._objects.length:this._firstFreeIndex<this._firstLockedIndex?this._objects.length-(this._firstLockedIndex-this._firstFreeIndex):this._firstFreeIndex-this._firstLockedIndex},t.prototype.executeForLockedObjects=function(t){var e,i=this._freeIndices.length;if(i>0)for(e=0;e<i;e++)this._objectsFree[e]||t(this._objects[e],e)},t.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},t.prototype.prefill=function(t,e){var i;for(this._objects.length>0&&this.clear(),this._objects=new Array(t),this._objectsFree=new Array(t),this._freeIndices=new Array(t),i=0;i<t;i++)this._objects[i]=new this._objectConstructor,this._objectsFree[i]=!0,this._freeIndices[i]=i;if(e)for(i=0;i<t;i++)e(this._objects[i],i);this._firstFreeIndex=0,this._firstLockedIndex=0},{Pool:t,getPool:e}}),define("modules/scene/particle-system",["utils/utils","utils/vectors","utils/matrices","modules/scene/renderable-objects","modules/scene/scene-graph"],function(t,e,i,s,n){"use strict";function o(t,e,i,s,n,o,r,a,l,h,c){this.pM=t,this.oM=e,this._dimensions=i,this._velocity=s,this._velocitySpread=n,this._initialNumber=o,this._spawnNumber=r,this._spawnTime=a,this._age=0,this._duration=l,this._delay=h||0,this._lastSpawn=0,this._createParticleFunction=c,this._particleDuration=-1,this._size=0,t&&this._calculateSize()}function r(t,e,i,s,n,r,a,l,h,c,u){o.call(this,t,e,i,s,n,r,a,l,h,c,u),this._calculateSize()}function a(e,i,s,n,r,a,l,h,c,u,_,p,d){o.call(this,e,i,s,a,l,h,c,u,_,p,d),this._direction=n,this._directionSpread=r*t.RAD}function l(e,i,s,n,r,a,l,h,c,u,_,p,d){o.call(this,e,i,s,a,l,h,c,u,_,p,d),this._planeNormal=n,this._directionSpread=r*t.RAD}function h(t,e,i,n,o,r,a,l,h,c){s.RenderableObject3D.call(this,null,!1,!0,t,e,i,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===h,this._particleCountFactor=void 0!==c?c:1,this._calculateSize()}return o.prototype._calculateSize=function(){var t=this._createParticleFunction();this._size=i.translationLength(this.pM)+e.length3(this._dimensions)+Math.max((this._velocity+.5*this._velocitySpread)*t._duration*.001+t.getFinalSize(),t.getMaxSize()),t.markAsReusable(!0)},o.prototype.getSize=function(){return this._size},o.prototype.getParticleDuration=function(){var t;return-1===this._particleDuration&&(this._particleDuration=0,t=this._createParticleFunction(),this._particleDuration=t._duration,t.markAsReusable(!0)),this._particleDuration},o.prototype._emitParticle=function(){var t,i;return t=this._createParticleFunction(),i=[this.pM[12]+(Math.random()-.5)*this._dimensions[0],this.pM[13]+(Math.random()-.5)*this._dimensions[1],this.pM[14]+(Math.random()-.5)*this._dimensions[2]],t.setPositionv(e.prodVec3Mat4Aux(i,this.oM)),t},o.prototype.emitParticles=function(t,e){var i,s,n;if(i=[],void 0===e&&(e=1),this._delay>0&&(this._delay-=t,this._delay<=0&&(t=-this._delay,this._delay=0)),0===this._delay){if(0===this._age)for(n=Math.round(this._initialNumber*e),this._initialNumber>0&&n<1&&(n=1),s=0;s<n;s++)i.push(this._emitParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<this._duration||0===this._duration);){for(n=Math.round(this._spawnNumber*e),this._spawnNumber>0&&n<1&&(n=1),s=0;s<n;s++)i.push(this._emitParticle());this._lastSpawn+=this._spawnTime}}return i},o.prototype.addToContext=function(t){var e=this._createParticleFunction();e.addToContext(t),e.markAsReusable(!0)},r.prototype=new o,r.prototype.constructor=r,r.prototype._emitParticle=function(){var e,i,s,n,r,a,l,h=o.prototype._emitParticle.call(this);return e=this._velocity+(Math.random()-.5)*this._velocitySpread,i=Math.random()*t.DOUBLE_PI,s=Math.random()*t.DOUBLE_PI,n=Math.sin(i),r=Math.cos(i),a=Math.sin(s),l=Math.cos(s),h.setVelocity(e*r*l,e*r*a,e*n),h},a.prototype=new o,a.prototype.constructor=a,
a.prototype._emitParticle=function(){var s,n,r,a=o.prototype._emitParticle.call(this);return s=this._velocity+(Math.random()-.5)*this._velocitySpread,n=e.scaled3Aux(this._direction,s),r=Math.abs(this._direction[0])<.75?e.x3Aux():Math.abs(this._direction[1])<.75?e.y3Aux():e.z3Aux(),e.mulCross3(r,this._direction),e.normalize3(r),e.mulVec3Mat3(n,i.rotation3Aux(r,Math.random()*this._directionSpread)),e.mulVec3Mat3(n,i.rotation3Aux(this._direction,Math.random()*t.DOUBLE_PI)),a.setVelocity(n[0],n[1],n[2]),a},l.prototype=new o,l.prototype.constructor=a,l.prototype._emitParticle=function(){var s,n,r,a=o.prototype._emitParticle.call(this);return n=this._velocity+(Math.random()-.5)*this._velocitySpread,s=Math.abs(this._planeNormal[0])<.75?e.x3Aux():Math.abs(this._planeNormal[1])<.75?e.y3Aux():e.z3Aux(),e.mulCross3(s,this._planeNormal),e.normalize3(s),r=e.scaled3Aux(s,n),e.mulVec3Mat3(r,i.rotation3Aux(e.cross3Aux(s,this._planeNormal),(Math.random()-.5)*this._directionSpread)),e.mulVec3Mat3(r,i.rotation3Aux(this._planeNormal,Math.random()*t.DOUBLE_PI)),a.setVelocity(r[0],r[1],r[2]),a},h.prototype=new s.RenderableObject3D,h.prototype.constructor=h,h.prototype.init=function(t,e,i,n,o,r,a,l,h,c){s.RenderableObject3D.prototype.init.call(this,null,!1,!0,t,e,i,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===h,this._particleCountFactor=void 0!==c?c:1,this._calculateSize()},h.prototype._calculateSize=function(){var t,e=0;for(t=0;t<this._emitters.length;t++)e=Math.max(e,this._emitters[t].getSize());this.setSize(e)},h.prototype._handleOrientationChanged=function(){var t;if(this._carriesParticles&&this._node)for(t=this._node._subnodes._first;t;t=t.next)t._renderableObject.invalidateWorldVelocityDirectionVector()},h.prototype.shouldBeRendered=function(t){return this.updateVisibleSize(t,!1),!1},h.prototype.performAnimate=function(t){var e,i,s,o;if(!this._keepAlive&&this._age>this._duration)return void this._node.markAsReusable(!0);if(this._age+=t,this._emitters)for(e=0;e<this._emitters.length;e++)if(s=this._emitters[e].emitParticles(t,this._particleCountFactor),this._carriesParticles)for(i=0;i<s.length;i++)this._node.addSubnode(s[i]._node||new n.RenderableNode(s[i],!1,!1,!0));else if(this._hasRelativeOrientation)for(o=this.getModelMatrix(),i=0;i<s.length;i++)s[i].translateByMatrix(o),s[i].rotateByMatrix(o),this._node._scene.addNode(s[i]._node||new n.RenderableNode(s[i],!1,!1,!0));else for(o=this.getModelMatrix(),i=0;i<s.length;i++)s[i].translateByMatrix(o),this._node._scene.addNode(s[i]._node||new n.RenderableNode(s[i],!1,!1,!0));this.translateByMatrixMul(this._velocityMatrix,.001*t)},h.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._carriesParticles){if(this._emitters){for(this._age=0,t=0;t<this._emitters.length;t++)(e=this._emitters[t].getParticleDuration())>i&&(i=e);this._emitters=null,this._duration=i}}else this._duration=0,this._node.markAsReusable(!0)},h.prototype.addToContext=function(t){var e;for(e=0;e<this._emitters.length;e++)this._emitters[e].addToContext(t)},{ParticleEmitter:o,OmnidirectionalParticleEmitter:r,UnidirectionalParticleEmitter:a,PlanarParticleEmitter:l,ParticleSystem:h}}),define("armada/logic/constants",[],function(){"use strict";return{SPACECRAFT_LIGHT_PRIORITY:0,EXPLOSION_LIGHT_PRIORITY:1,PROJECTILE_LIGHT_PRIORITY:2,MISSILE_LIGHT_PRIORITY:3,BLINKER_LIGHT_PRIORITY:4,THRUSTER_LIGHT_PRIORITY:4,PARTICLE_POOL_NAME:"Particle",PROJECTILE_POOL_NAME:"Projectile",MISSILE_POOL_NAME:"Missile",TRAIL_POOL_NAME:"Trail",TRAIL_SEGMENT_POOL_NAME:"TrailSegment",EXPLOSION_POOL_NAME:"Explosion",MULTI_HOST_DATA_LENGTH:30,MULTI_GUEST_DATA_LENGTH:8}}),define("armada/logic/explosion",["utils/vectors","utils/matrices","modules/application","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","modules/scene/particle-system","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/constants","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_){"use strict";function p(){E=h.areDynamicLightsAvailable()&&h.getMaxPointLights()>0}function d(){return T.getObject()}function g(t,i,s,n,o,r,a,l){this._class=t,this.pM=i||e.identity4(),this.oM=s||e.identity4(),this._direction=n||[0,0,0],this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._velocityMatrix=a||e.identity4(),this._ignoreParticleCountFactor=!0===l,this.vMo=null}var m,f,S,T,E=!1;return g.prototype.init=function(t,i,s,n,o,r,a,l){this._class=t,e.copyTranslation4(this.pM,i),e.copyRotation4(this.oM,s),this._direction[0]=n[0],this._direction[1]=n[1],this._direction[2]=n[2],this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._ignoreParticleCountFactor=!0===l,e.copyTranslation4(this._velocityMatrix,a||e.IDENTITY4)},g.prototype.createVisualModel=function(t,i){this.vMo=new l.ParticleSystem(this.pM,this.oM,t?e.scaling4(t):e.identity4(),this._velocityMatrix,i||[],this._class?this._class.getTotalDuration():0,!!this._class&&this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,this._ignoreParticleCountFactor?1:h.getParticleCountFactor())},g.prototype.canBeReused=function(){return this.vMo&&this.vMo.canBeReused()},g.prototype.getEmitterParticleConstructor=function(t){var i=this._class._particleEmitterDescriptors[t],s=i.getModel(),n=i.getShader(),o=i.getTexturesOfTypes(i.getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),r=i.getParticleStates(),a=i.getInstancedShader();return function(){var t=S.getObject();return t.init(s,n,o,e.IDENTITY4,r,!1,a),t}.bind(this)},g.prototype._initVisualModel=function(t){var i,s,n,o;for(s=[],o=this._class._particleEmitterDescriptors,i=0;i<o.length;i++){switch(o[i].getType()){case c.ParticleEmitterType.OMNIDIRECTIONAL:n=new l.OmnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case c.ParticleEmitterType.UNIDIRECTIONAL:n=new l.UnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case c.ParticleEmitterType.PLANAR:n=new l.PlanarParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i))}s.push(n)}this.vMo?this.vMo.init(this.pM,this.oM,t?e.scaling4Aux(t):e.IDENTITY4,this._velocityMatrix,s,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,this._ignoreParticleCountFactor?1:h.getParticleCountFactor()):this.createVisualModel(t,s)},g.prototype.addToSceneNow=function(e,i,s,n){var o,l=e._scene;this._initVisualModel(1/e._renderableObject.getCascadeScalingMatrix()[0]),e.addSubnode(this.vMo._node||new a.RenderableNode(this.vMo,!1)),E&&(o=this._class.getLightStates())&&l.addPointLightSource(new r.PointLightSource(o[0].color,o[0].intensity,t.NULL3,[this.vMo],o),_.EXPLOSION_LIGHT_PRIORITY),this._class.playSound(i,s,m,f),n&&n(this.vMo)},g.prototype.addToScene=function(t,e,i,n){s.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,n))},g.prototype.addResourcesToScene=function(t){var e="explosion/"+this._class._name;this._class.acquireResources({sound:!0}),s.executeWhenReady(function(){t.hasResourcesOfObject(e)||(this._initVisualModel(),t.addResourcesOfObject(this.vMo,e))}.bind(this))},g.prototype.finish=function(){this.vMo.finishEmitting()},g.prototype.destroy=function(){this._class=null,this.pM=null,this.oM=null,this._direction=null,this.vMo&&this.vMo._node.markAsReusable(!0),this.vMo=null},S=n.getPool(_.PARTICLE_POOL_NAME,o.Particle),T=n.getPool(_.EXPLOSION_POOL_NAME,g),u.executeWhenReady(function(){m=.1,f=.5,h.executeWhenReady(p),h.onSettingsChange(p)}),{getExplosion:d,Explosion:g}}),define("armada/logic/environments",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/logic/classes","armada/logic/explosion","armada/configuration","armada/strings","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p){"use strict";function d(t){this._class=t,this._node=null}function g(t,e,i,s,n){this._class=t,this._size=e,this._direction=[Math.cos(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(s))],this._angle=Math.radians(n)||0,this._nodes=null}function m(t,e){this._positionVector=e,this.vMo=null,this._cloud=t,this._range=t.getRange()}function f(t){this._class=t,this._particles=null,this.vMo=null}function S(t){this._origin=t.position?t.position.slice():[0,0,0],this._origin.push(1),this._position=[0,0,0,1],this._relativeToCamera=!1!==t.relativeToCamera,this._effect=new u.Explosion(c.getExplosionClass(t.class),this._relativeToCamera?void 0:i.translation4v(this._origin),void 0,t.direction||[0,0,1],!1,!0===t.relativeDirection,void 0,!0)}function T(t){this._name=null,this._location=null,this._color=null,this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._particleEffects=null,this._shadows=!1,this._ambientColor=null,this._lights=null,this._drag=0,this._angularDrag=0,this._sensorRangeFactor=0,this._lockingTimeFactor=0,this._camera=null,this._scene=null,this._dataJSON=null,void 0!==t&&this.loadFromJSON(t)}function E(){n.AsyncResource.call(this),this._environments=null}var y;return d.prototype.addToScene=function(t){this._class.acquireResources(),o.executeWhenReady(function(){this._node=t.addBackgroundObject(new r.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(h.getCubemapQualityPreferenceList()),t._camera))}.bind(this))},d.prototype.destroy=function(){this._node&&(this._node.destroy(),this._node=null),this._class=null},g.prototype.addToScene=function(t,s){!s&&this._class._lightColor&&t.addDirectionalLightSource(new a.DirectionalLightSource(this._class._lightColor,this._direction)),this._class.acquireResources(),o.executeWhenReady(function(){var s,n,o;for(n=this._class._layers,this._nodes=[],s=0;s<n.length;s++)o=new r.BackgroundBillboard(n[s].getModel(),n[s].getShader(),n[s].getTexturesOfTypes(n[s].getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),n[s]._color,n[s].getSize()*this._size,i.translation4v(e.scaled3Aux(this._direction,4500)),this._angle),o.setRelativeSize(1),this._nodes.push(t.addBackgroundObject(o))}.bind(this))},g.prototype.destroy=function(){var t;if(this._class=null,this._direction=null,this._nodes){for(t=0;t<this._nodes.length;t++)this._nodes[t].destroy();this._nodes=null}},m.prototype.addToScene=function(t,e){this.vMo=new r.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass()._color:null,e?this._range:0),t.addSubnode(new l.RenderableNode(this.vMo,!1,!1,!0))},m.prototype.simulate=function(t){this.vMo.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},m.prototype.destroy=function(){this._positionVector=null,this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null),this._cloud=null},f.prototype.getClass=function(){return this._class},f.prototype.getRange=function(){return this._class.getRange()},f.prototype.addToScene=function(t){var e,i,s;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;e<i;e++)s=new m(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(s);o.executeWhenReady(function(){var e,s;for(this.vMo=new r.RenderableObject(null,!1,!1,void 0,!1),s=t.addNode(new l.RenderableNode(this.vMo,!1,!0)),e=0;e<i;e++)this._particles[e].addToScene(s,0===e)}.bind(this))},f.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0].vMo.setShift(t._velocityVector[0],t._velocityVector[1],t._velocityVector[2]),e=0;e<i;e++)this._particles[e].simulate(t)},f.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;t<e;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null)},S.prototype.addResourcesToScene=function(t){this._effect.addResourcesToScene(t)},S.prototype.addToScene=function(t){this._effect.addToScene(t._rootNode)},S.prototype.simulate=function(t){var i;this._relativeToCamera&&(e.setVector4(this._position,this._origin),i=t.getCameraOrientationMatrix(),e.mulVec4Mat4(this._position,i),e.add3(this._position,t.getCameraPositionVector()),this._effect.vMo.setPositionv(this._position),this._effect.vMo.setOrientationM4(i))},S.prototype.destroy=function(){this._origin=null,this._position=null,this._effect&&this._effect.destroy(),this._effect=null},T.prototype.loadFromJSON=function(t){var e,i;if(this._dataJSON=t,this._name=t.name,this._location=t.location,this._color=t.color||[0,0,0,0],this._skyboxes=[],t.skyboxes)for(e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new d(c.getSkyboxClass(t.skyboxes[e].class)));if(this._backgroundObjects=[],t.backgroundObjects)for(e=0;e<t.backgroundObjects.length;e++)i=c.getBackgroundObjectClass(t.backgroundObjects[e].class),t.backgroundObjects[e].position||s.showError("No position specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR),this._backgroundObjects.push(new g(i,t.backgroundObjects[e].size||s.showError("No size specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR)||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleAlpha||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleBeta||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleGamma||0));if(this._dustClouds=[],t.dustClouds)for(e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new f(c.getDustCloudClass(t.dustClouds[e].class)));if(this._particleEffects=[],t.particleEffects)for(e=0;e<t.particleEffects.length;e++)this._particleEffects.push(new S(t.particleEffects[e]));if(this._shadows=!1!==t.shadows,this._ambientColor=t.ambientColor||[0,0,0],this._lights=[],t.lights)for(e=0;e<t.lights.length;e++)this._lights.push(new a.DirectionalLightSource(t.lights[e].color,t.lights[e].direction));this._drag=t.drag||0,this._angularDrag=t.angularDrag||0,this._sensorRangeFactor=void 0!==t.sensorRangeFactor?t.sensorRangeFactor:1,this._lockingTimeFactor=void 0!==t.lockingTimeFactor?t.lockingTimeFactor:1,this._scene=null,this._camera=null},T.prototype.getDisplayName=function(){return this._location?t.formatString(p.get(p.LOCATION.SYSTEM),{systemName:this._location}):p.get(p.LOCATION.UNKNOWN)},T.prototype.hasShadows=function(){return this._shadows},T.prototype.getDrag=function(){return this._drag},T.prototype.getSensorRangeFactor=function(){return this._sensorRangeFactor},T.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},T.prototype.getData=function(){return this._dataJSON},T.prototype.reloadData=function(){this.loadFromJSON(this._dataJSON)},T.prototype.addToScene=function(t){var e;for(t._clearColor=this._color,e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t,!1);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].addResourcesToScene(t);for(this._camera=t._camera,t._ambientColor=this._ambientColor,e=0;e<this._lights.length;e++)t.addDirectionalLightSource(this._lights[e]);this._scene=t},T.prototype.addParticleEffectsToScene=function(t){var e;for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].addToScene(t);return this._particleEffects.length>0},T.prototype.simulate=function(){var t;if(this._camera){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera);for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].simulate(this._camera)}},T.prototype.removeFromScene=function(){this._camera=null,this._scene=null},T.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}if(this._particleEffects){for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].destroy(),this._particleEffects[t]=null;this._particleEffects=null}this._lights&&(this._lights=null),this._camera=null,this._scene=null},E.prototype=new n.AsyncResource,E.prototype.constructor=E,E.prototype.getEnvironment=function(t){return this._environments[t]||null},E.prototype.getEnvironmentNames=function(){return Object.keys(this._environments)},E.prototype.createEnvironment=function(t){this._environments[t.name]=new T(t)},E.prototype.executeForAllEnvironments=function(t){var e,i=this.getEnvironmentNames();for(e=0;e<i.length;e++)t(this._environments[i[e]],"environments")},E.prototype.requestLoad=function(){s.requestTextFile(_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},E.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new T(t.environments[e]),this._environments[t.environments[e].name]=i},y=new E,{requestLoad:y.requestLoad.bind(y),executeWhenReady:y.executeWhenReady.bind(y),getEnvironment:y.getEnvironment.bind(y),getEnvironmentNames:y.getEnvironmentNames.bind(y),createEnvironment:y.createEnvironment.bind(y),executeForAllEnvironments:y.executeForAllEnvironments.bind(y),Skybox:d,BackgroundObject:g,Environment:T}}),define("modules/control/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i){"use strict";function s(t){d=t}function n(){return d}function o(){return m}function r(){m&&(S=!0,document.exitPointerLock())}function a(t){g=t}function l(){return f}function h(t,e){this._actionName=null,this._profileName=e,this.loadFromJSON(t)}function c(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._profiles={},this._profileKeywords={},this._currentProfile=null,this._currentProfileName=null,this._defaultProfileName=null,this._disabledActions={},void 0!==e&&this.loadFromJSON(e)}function u(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,this._source=null,void 0!==t&&this.loadFromJSON(t)}function _(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function p(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={},s(this)}var d,g,m="function"==typeof document.body.requestPointerLock&&"function"==typeof document.exitPointerLock,f=!1,S=!1;return h.prototype.getActionName=function(){return this._actionName},h.prototype.loadFromJSON=function(t){this._actionName=t?t.action:null},c.prototype.getDeviceName=function(){return"Generic"},c.prototype.isListening=function(){return this._listening},c.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},c.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},c.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},c.prototype.isEnabled=function(){return this._enabled},c.prototype.enable=function(){this._enabled=!0},c.prototype.disable=function(){this._enabled=!1},c.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},c.prototype.setProfile=function(t){this._profiles.hasOwnProperty(t)&&(this._currentProfile=this._profiles[t],this._currentProfileName=t)},c.prototype.getProfile=function(){return this._currentProfileName},c.prototype.getProfiles=function(){return Object.keys(this._profiles)},c.prototype.setBinding=function(t){this._currentProfile[t.getActionName()]=t},c.prototype.setAndStoreBinding=function(t){var e=new this._bindingClass(t,this._currentProfileName);this.setBinding(e),e.saveToLocalStorage()},c.prototype.loadFromJSON=function(t){var e,i,s,n,o;if(t.profiles){for(s in t.profiles)if(t.profiles.hasOwnProperty(s)){for(n=t.profiles[s],o=[t.profiles[s].bindings];n.basedOn&&t.profiles.hasOwnProperty(n.basedOn);)o.unshift(t.profiles[n.basedOn].bindings),n=t.profiles[n.basedOn];for(this._profiles[s]={},this._currentProfile=this._profiles[s],e=0;e<o.length;e++)for(i=0;i<o[e].length;i++)this.setBinding(new this._bindingClass(o[e][i],s));this._profileKeywords[s]=n.keywords}this._defaultProfileName=t.defaultProfile,this._currentProfile=this._profiles[t.defaultProfile],this._currentProfileName=t.defaultProfile}else for(this._profiles.default={},this._currentProfile=this._profiles.default,this._currentProfileName="default",e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e],"default"))},c.prototype.loadFromLocalStorage=function(){var t;for(t in this._currentProfile)this._currentProfile.hasOwnProperty(t)&&this._currentProfile[t].loadFromLocalStorage()},c.prototype.removeFromLocalStorage=function(){var t;for(t in this._currentProfile)this._currentProfile.hasOwnProperty(t)&&this._currentProfile[t].removeFromLocalStorage()},c.prototype.getControlStringForAction=function(t){return void 0!==this._currentProfile[t]?this._currentProfile[t].getControlString():""},c.prototype._addActionByBinding=function(t,e,i){var s;if(e){for(s=0;s<t.length;s++)if(i.bindsTheSameControls(t[s].binding))return void t[s].actions.push(e);t.push({binding:i,actions:[e]})}},c.prototype.disableAction=function(t){this._disabledActions[t]=!0},c.prototype.enableAction=function(t){this._disabledActions[t]=!1},c.prototype.getTriggeredActions=function(t){var e,i,s=[],n=[];if(!this.isListening()||!this.isEnabled())return s;for(e in this._currentProfile)this._currentProfile.hasOwnProperty(e)&&(this._disabledActions[e]||t&&!t(e)||this._addActionByBinding(n,this.checkAction(e),this._currentProfile[e]));for(i=0;i<n.length;i++)s.push(n[i].actions);return s},u.prototype.INTENSITY_NOT_SPECIFIED=-3,u.prototype.INTENSITY_KEYPRESS=-2,u.prototype.getDescription=function(){return this._description},u.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=!0===t.continuous,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},u.prototype.setTriggered=function(t,e,i){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS),this._source=i},u.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},u.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},u.prototype.execute=function(){!0===this._continuous?!0===this._triggered?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source):null!==this._executeNonTriggered&&this._executeNonTriggered():!0===this._triggered&&!1===this._executed?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source),this._executed=!0):(!1===this._triggered&&!1===this._nonTriggeredExecuted&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),!1===this._triggered?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},_.prototype.setContext=function(t){this._context=t},_.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},_.prototype.loadFromJSON=function(t){var e,i;for(e=0;e<t.actions.length;e++)i=t.actions[e],i.debug||(this._actions[i.name]=new u(i))},_.prototype.setActionFunction=function(t,i,s){this._actions[t]?!0===i?this._actions[t].setExecuteTriggered(s):this._actions[t].setExecuteNonTriggered(s):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},_.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},_.prototype.executeActions=function(t){var e,i,s,n,o;for(e=0;e<t.length;e++){for(s=null,n=-1,o=null,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==n&&t[e][i].intensity>n||void 0!==n&&void 0===t[e][i].intensity)&&(s=t[e][i].name,n=t[e][i].intensity,o=t[e][i].source);s&&((void 0===n||n>0)&&this._actions[s].setTriggered(!0,n,o),t[e]=[])}for(s in this._actions)this._actions.hasOwnProperty(s)&&this._actions[s].execute()},_.prototype.executeAction=function(t,e,i){this._actions.hasOwnProperty(t)&&(this._actions[t].setTriggered(!0,e,i),this._actions[t].execute())},p.prototype=new i.AsyncResource,p.prototype.constructor=p,p.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},p.prototype.addInputInterpreter=function(i){var s=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);s?(this._inputInterpreters.push(i),this._inputInterpretersByType[s]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},p.prototype.getInputInterpreters=function(){return this._inputInterpreters},p.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},p.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},p.prototype.addController=function(i){var s=t.getKeyOfValue(this._controllerTypes,i.constructor);s?(this._controllers.push(i),this._controllersByType[s]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},p.prototype.getControllers=function(){return this._controllers},p.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},p.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},p.prototype.isControllerPriority=function(t){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(t)},p.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},p.prototype.disableAction=function(t){this._disabledActions[t]=!0},p.prototype.enableAction=function(t){this._disabledActions[t]=!1},p.prototype.control=function(t){var e,i,s=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(s));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},p.prototype.loadConfigurationFromJSON=function(t){var i,s;for(this._controllers=[],i=0,s=t.controllers.length;i<s;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},p.prototype.loadSettingsFromJSON=function(t,i){var s,n;if(i)for(s=0,n=t.inputDevices.length;s<n;s++)this._inputInterpreterTypes[t.inputDevices[s].type]&&(this._inputInterpreters[s].removeFromLocalStorage(),this._inputInterpreters[s].loadFromJSON(t.inputDevices[s]));else for(this._dataJSON=t,this._inputInterpreters=[],s=0,n=t.inputDevices.length;s<n;s++)this._inputInterpreterTypes[t.inputDevices[s].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[s].type](t.inputDevices[s])):t.inputDevices[s].optional||e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[s].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},p.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},p.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},p.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},p.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},p.prototype.isListening=function(){return this._listening},p.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},p.prototype.executeAction=function(t,e,i){var s
;for(s=0;s<this._controllersPriorityQueue.length;s++)this._controllersPriorityQueue[s].executeAction(t,e,i)},m&&document.addEventListener("pointerlockchange",function(){var t=f;f=!!document.pointerLockElement,t&&!f?g&&g(S):S=!1}),{ControlBinding:h,InputInterpreter:c,Controller:_,ControlContext:p,getContext:n,isPointerLockSupported:o,exitPointerLock:r,onPointerLockExit:a,isPointerLocked:l}}),define("modules/control/keyboard",["utils/utils","modules/application","modules/strings","modules/control/control"],function(t,e,i,s){"use strict";function n(t){l=t}function o(t,e){this._key=null,this._keyCode=0,this._shiftState=!1,this._ctrlState=!1,this._altState=!1,s.ControlBinding.call(this,t,e)}function r(t){s.InputInterpreter.call(this,o,t),this._currentlyPressedKeys=new Array(256)}var a={name:"key"+i.CATEGORY_SEPARATOR},l="";return o.prototype=new s.ControlBinding,o.prototype.constructor=o,o.prototype.loadFromJSON=function(t){s.ControlBinding.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=!0===t.shift||16===this._keyCode,this._ctrlState=!0===t.ctrl||17===this._keyCode,this._altState=!0===t.alt||18===this._keyCode},o.prototype.saveToLocalStorage=function(){localStorage[l+this._actionName+"_key"]=this._key,localStorage[l+this._actionName+"_shift"]=this._shiftState,localStorage[l+this._actionName+"_ctrl"]=this._ctrlState,localStorage[l+this._actionName+"_alt"]=this._altState},o.prototype.loadFromLocalStorage=function(){void 0!==localStorage[l+this._actionName+"_key"]&&(this.setKey(localStorage[l+this._actionName+"_key"]),this._shiftState="true"===localStorage[l+this._actionName+"_shift"],this._ctrlState="true"===localStorage[l+this._actionName+"_ctrl"],this._altState="true"===localStorage[l+this._actionName+"_alt"])},o.prototype.removeFromLocalStorage=function(){localStorage.removeItem(l+this._actionName+"_key"),localStorage.removeItem(l+this._actionName+"_shift"),localStorage.removeItem(l+this._actionName+"_ctrl"),localStorage.removeItem(l+this._actionName+"_alt")},o.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},o.prototype.getShiftState=function(){return this._shiftState},o.prototype.getCtrlState=function(){return this._ctrlState},o.prototype.getAltState=function(){return this._altState},o.prototype.getControlString=function(){var e,s;return e=i.get(a,this._key,this._key),this._shiftState&&16!==this._keyCode&&(s=t.getKeyOfCode(16),s=i.get(a,s,s),e=s+" + "+e),this._ctrlState&&17!==this._keyCode&&(s=t.getKeyOfCode(17),s=i.get(a,s,s),e=s+" + "+e),this._altState&&18!==this._keyCode&&(s=t.getKeyOfCode(18),s=i.get(a,s,s),e=s+" + "+e),e},o.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[16]||!this._shiftState)&&(t[17]||!this._ctrlState)&&(t[18]||!this._altState)},o.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},r.prototype=new s.InputInterpreter,r.prototype.constructor=r,r.prototype.getDeviceName=function(){return"keyboard"},r.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},r.prototype.setEscapeToPressed=function(){this._currentlyPressedKeys[27]=!0},r.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},r.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},r.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},r.prototype.startListening=function(){s.InputInterpreter.prototype.startListening.call(this),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this),s.onPointerLockExit(function(t){var e,i;if(!t){for(this._currentlyPressedKeys[27]=!0,e=this.getTriggeredActions(),i=0;i<e.length;i++)s.getContext().executeAction(e[i][0].name,void 0,this);this._currentlyPressedKeys[27]=!1}}.bind(this))},r.prototype.stopListening=function(){s.InputInterpreter.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null,document.onkeypress=null,s.onPointerLockExit(null)},r.prototype.checkAction=function(t){return this._currentProfile[t].isTriggered(this._currentlyPressedKeys)?{name:t,source:this}:null},{setModulePrefix:n,KeyboardInputInterpreter:r}}),define("modules/control/mouse",["utils/utils","modules/strings","modules/control/control"],function(t,e,i){"use strict";function s(t){T=t}function n(t,e){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,i.ControlBinding.call(this,t,e)}function o(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._maxDisplacement=0,this._displacementFactor=1,this._displacementDeadzone=0,this._pointerLock=!1,this.handlePointerLockChange=this.handlePointerLockChange.bind(this),i.InputInterpreter.call(this,n,t)}var r={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},a=[r.NONE,r.LEFT,r.MIDDLE,r.RIGHT],l={name:"mouse"+e.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},h={name:"mouse"+e.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},c={name:"mouse"+e.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},u={name:"mouse"+e.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},_={name:"mouse"+e.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},p={name:"mouse"+e.CATEGORY_SEPARATOR+"move",defaultValue:"move"},d={name:"mouse"+e.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},g={name:"mouse"+e.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},m={name:"mouse"+e.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},f={name:"mouse"+e.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},S={name:"mouse"+e.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},T="";return n.prototype=new i.ControlBinding,n.prototype.constructor=n,n.prototype.loadFromJSON=function(t){switch(i.ControlBinding.prototype.loadFromJSON.call(this,t),this._buttonIndex=a.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}switch(this._measuredFromCenter=!0===t.fromCenter,this._scrollX=0,this._scrollY=0,t.scroll){case"left":this._scrollX=-1;break;case"right":this._scrollX=1;break;case"up":this._scrollY=-1;break;case"down":this._scrollY=1}},n.prototype.saveToLocalStorage=function(){localStorage[T+this._actionName+"_button"]=this._buttonIndex,localStorage[T+this._actionName+"_moveX"]=this._moveX,localStorage[T+this._actionName+"_moveY"]=this._moveY,localStorage[T+this._actionName+"_measuredFromCenter"]=this._measuredFromCenter,localStorage[T+this._actionName+"_scrollX"]=this._scrollX,localStorage[T+this._actionName+"_scrollY"]=this._scrollY},n.prototype.loadFromLocalStorage=function(){void 0!==localStorage[T+this._actionName+"_button"]&&(this._buttonIndex=parseInt(localStorage[T+this._actionName+"_button"],10),this._moveX=parseInt(localStorage[T+this._actionName+"_moveX"],10),this._moveY=parseInt(localStorage[T+this._actionName+"_moveY"],10),this._measuredFromCenter="true"===localStorage[T+this._actionName+"_measuredFromCenter"],this._scrollX=parseInt(localStorage[T+this._actionName+"_scrollX"],10),this._scrollY=parseInt(localStorage[T+this._actionName+"_scrollY"],10))},n.prototype.removeFromLocalStorage=function(){localStorage.removeItem(T+this._actionName+"_button"),localStorage.removeItem(T+this._actionName+"_moveX"),localStorage.removeItem(T+this._actionName+"_moveY"),localStorage.removeItem(T+this._actionName+"_measuredFromCenter"),localStorage.removeItem(T+this._actionName+"_scrollX"),localStorage.removeItem(T+this._actionName+"_scrollY")},n.prototype.getControlString=function(){var i="",s=null;switch(a[this._buttonIndex]){case r.LEFT:return e.get(l);case r.MIDDLE:return e.get(c);case r.RIGHT:return e.get(h)}return i=this._measuredFromCenter?e.get(u):e.get(_),this._moveX<0?s=e.get(d):this._moveX>0?s=e.get(g):this._moveY<0?s=e.get(m):this._moveY>0&&(s=e.get(f)),s?i=t.formatString(i,{move:e.get(p),toDirection:s}):(s=null,i=e.get(_),this._scrollX<0?s=e.get(d):this._scrollX>0?s=e.get(g):this._scrollY<0?s=e.get(m):this._scrollY>0&&(s=e.get(f)),s&&(i=t.formatString(i,{move:e.get(S),toDirection:s})),i)},n.prototype.getTriggeredIntensity=function(t,e,i,s,n){var o,r;return this._buttonIndex>0?!0===t[this._buttonIndex]?1:-1:e?(o=this._measuredFromCenter?e[0]>=0?e[0]-s[0]:0:i[0],0!==this._moveX?o*this._moveX:(r=this._measuredFromCenter?e[1]>=0?e[1]-s[1]:0:i[1],0!==this._moveY?r*this._moveY:0!==this._scrollX?n[0]*this._scrollX:0!==this._scrollY?n[1]*this._scrollY:void 0)):0},n.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!=0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!=0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!=0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!=0)},o.prototype=new i.InputInterpreter,o.prototype.constructor=o,o.prototype._updateDisplacementFactor=function(){this._maxDisplacement=(this._screenSize||1)*this._displacementAreaRelativeSize,this._displacementFactor=1/this._maxDisplacement,this._maxDisplacement+=this._displacementDeadzone},o.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._screenSize=Math.min(t,e),this._updateDisplacementFactor(),this._mousePosition=[t,e],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},o.prototype.getDeviceName=function(){return"mouse"},o.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},o.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[T+"mouse_moveSensitivity"]=this._moveSensitivity},o.prototype.getDisplacementAreaRelativeSize=function(){return this._displacementAreaRelativeSize},o.prototype.setAndStoreDisplacementAreaRelativeSize=function(t){this._displacementAreaRelativeSize=t,this._updateDisplacementFactor(),localStorage[T+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},o.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[T+"mouse_displacementDeadzone"]=this._displacementDeadzone},o.prototype.loadFromJSON=function(t){i.InputInterpreter.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=t.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},o.prototype.loadFromLocalStorage=function(){i.InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[T+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[T+"mouse_moveSensitivity"])),void 0!==localStorage[T+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[T+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[T+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[T+"mouse_displacementDeadzone"],10))},o.prototype.removeFromLocalStorage=function(){i.InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(T+"mouse_moveSensitivity"),localStorage.removeItem(T+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(T+"mouse_displacementDeadzone")},o.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},o.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},o.prototype.handleMouseMove=function(t){this._mousePosition[0]>=0&&(this._pointerLock?(this._mousePositionChange[0]+=t.movementX,this._mousePositionChange[1]+=t.movementY):(this._mousePositionChange[0]+=t.clientX-this._mousePosition[0],this._mousePositionChange[1]+=t.clientY-this._mousePosition[1])),this._pointerLock?(this._mousePosition[0]=Math.min(Math.max(this._screenCenter[0]-this._maxDisplacement,this._mousePosition[0]+t.movementX),this._screenCenter[0]+this._maxDisplacement),this._mousePosition[1]=Math.min(Math.max(this._screenCenter[1]-this._maxDisplacement,this._mousePosition[1]+t.movementY),this._screenCenter[1]+this._maxDisplacement)):this._mousePosition=[t.clientX,t.clientY]},o.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},o.prototype.handlePointerLockChange=function(){this._pointerLock=!!document.pointerLockElement,this._pointerLock&&this._mousePosition[0]<0&&(this._mousePosition[0]=this._screenCenter[0],this._mousePosition[1]=this._screenCenter[1])},o.prototype.startListening=function(){i.InputInterpreter.prototype.startListening.call(this),document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1},i.isPointerLockSupported()&&(this.handlePointerLockChange(),document.addEventListener("pointerlockchange",this.handlePointerLockChange))},o.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null,i.isPointerLockSupported()&&document.removeEventListener("pointerlockchange",this.handlePointerLockChange)},o.prototype.checkAction=function(t){var e=this._currentProfile[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:!0===this._currentProfile[t]._measuredFromCenter?Math.min(1,Math.max(0,e-this._displacementDeadzone)*this._displacementFactor):e*this._moveSensitivity,source:this}:null},o.prototype.getTriggeredActions=function(t){var e=i.InputInterpreter.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},o.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},{setModulePrefix:s,MouseInputInterpreter:o}}),define("modules/control/gamepad",["utils/utils","modules/application","modules/strings","modules/control/control"],function(t,e,i,s){"use strict";function n(t){f=t}function o(t,e){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,s.ControlBinding.call(this,t,e)}function r(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=!0===t.staticSensitivity,this._quadraticIntensity=!0===t.quadraticSensitivity,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function a(t){this._gamepad=null,this._gamepadSetIndex=localStorage[f+l]===h?_:u,this._detectingPreference=!!localStorage[f+l],this._preferredGamepadId=localStorage[f+l],this._vibrationEnabled=!1,this._vibrationEffects=null,this._sensitivityActionGroups=null,s.InputInterpreter.call(this,o,t)}var l="preferredGamepad",h="null",c=[],u=-2,_=-1,p={name:"joystick"+i.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},d={name:"joystick"+i.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},g={name:"joystick"+i.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},m={name:"joystick"+i.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},f="",S=!!navigator.getGamepads,T=S?function(){return navigator.getGamepads()}:function(){return c};return o.prototype=new s.ControlBinding,o.prototype.constructor=o,o.prototype.BUTTON_NONE=-1,o.prototype.AXIS_NONE=-1,o.prototype.loadFromJSON=function(t){s.ControlBinding.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},o.prototype._getLocalStoragePrefix=function(){return f+this._profileName+"_"+this._actionName},o.prototype.saveToLocalStorage=function(){var t=this._getLocalStoragePrefix();localStorage[t+"_gamepad_button"]=this._button,localStorage[t+"_gamepad_axisIndex"]=this._axisIndex,localStorage[t+"_gamepad_axisPositive"]=this._axisPositive},o.prototype.loadFromLocalStorage=function(){var t=this._getLocalStoragePrefix();void 0!==localStorage[t+"_gamepad_button"]&&(this._button=parseInt(localStorage[t+"_gamepad_button"],10),this._axisIndex=parseInt(localStorage[t+"_gamepad_button"],10),this._axisPositive="true"===localStorage[t+"_gamepad_axisPositive"])},o.prototype.removeFromLocalStorage=function(){var t=this._getLocalStoragePrefix();localStorage.removeItem(t+"_gamepad_button"),localStorage.removeItem(t+"_gamepad_axisIndex"),localStorage.removeItem(t+"_gamepad_axisPositive")},o.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?t.buttons[this._button]?t.buttons[this._button].value:0:this._axisIndex!==this.AXIS_NONE&&t.axes.length>this._axisIndex?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},o.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(i.get(p),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(i.get(d),{index:this._axisIndex+1,direction:this._axisPositive?i.get(g):i.get(m)}):""},o.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},r.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*(this._quadraticIntensity?t:1)*this._sensitivityFactor:-1},a.prototype=new s.InputInterpreter,a.prototype.constructor=a,a.prototype.getDeviceName=function(){return"joystick"},a.prototype.resetState=function(){this._gamepad=null},a.prototype.loadFromJSON=function(t){var e;if(s.InputInterpreter.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new r(t.sensitivityProfile.actionGroups[e]));this._vibrationEnabled=!!t.vibrationEnabled||!1,this._vibrationEffects=t.vibrationEffects||{}},a.prototype.loadFromLocalStorage=function(){s.InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[f+"vibrationEnabled"]&&(this._vibrationEnabled=localStorage[f+"vibrationEnabled"]===(!0).toString())},a.prototype.handleGamepadConnected=function(t){this._gamepad||this._gamepadSetIndex!==u||(this._gamepad=t.gamepad,this.setProfile(this._getProfile(t.gamepad),!1))},a.prototype.startListening=function(){s.InputInterpreter.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},a.prototype.stopListening=function(){s.InputInterpreter.prototype.stopListening.call(this),window.ongamepadconnected=null},a.prototype.checkAction=function(t){var e,i,s;if((e=this._currentProfile[t].getTriggeredIntensity(this._gamepad))>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(void 0===(s=this._sensitivityActionGroups[i].getIntensityForAction(e,t))||s>0)return{name:t,intensity:s,source:this};return{name:t,intensity:e,source:this}}return null},a.prototype.updateGamepad=function(){var t,e,i;if(t=T(),this._gamepadSetIndex>=0&&(t[this._gamepadSetIndex]?this._gamepad=t[this._gamepadSetIndex]:this._gamepadSetIndex=u),this._gamepadSetIndex===u)if(i=null!==this._gamepad?this._gamepad.index:-1,this._gamepad=null,this._detectingPreference){for(e=0;e<t.length;e++)if(t[e]){if(this._detectingPreference=!1,t[e].id===this._preferredGamepadId){this._setGamepad(t[e]);break}null===this._gamepad&&(this._gamepad=t[e],this.setProfile(this._getProfile(t[e]),!1))}}else for(e=0;e<t.length;e++)if(t[e]){this._gamepad=t[e],t[e].index!==i&&this.setProfile(this._getProfile(t[e]),!1);break}return this._gamepad},a.prototype.getTriggeredActions=function(t){return this.isListening()&&this._gamepadSetIndex!==_?(this.updateGamepad(),null!==this._gamepad?s.InputInterpreter.prototype.getTriggeredActions.call(this,t):c):c},a.prototype._getProfile=function(t){var e,i,s,n,o,r;if(e=this._getProfilePreferences(),e[t.id])return e[t.id];for(o=Object.keys(this._profileKeywords),r=t.id.toLowerCase(),i=0;i<o.length;i++)if(n=this._profileKeywords[o[i]])for(s=0;s<n.length;s++)if(r.indexOf(n[s])>=0)return o[i];return this._defaultProfileName},a.prototype._setGamepad=function(t){this._gamepad=t,this._gamepadSetIndex=t.index,this._preferredGamepadId=t.id,localStorage[f+l]=t.id,this.setProfile(this._getProfile(t),!1)},a.prototype.setGamepad=function(t){var e,i=T();if(!t)return this._gamepad=null,this._gamepadSetIndex=_,this._preferredGamepadId=h,localStorage[f+l]=h,!0;for(e=0;e<i.length;e++)if(i[e]===t)return this._setGamepad(t),!0;return!1},a.prototype.removeFromLocalStorage=function(){s.InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(f+l),localStorage.removeItem(f+"preferredProfiles"),localStorage.removeItem(f+"vibrationEnabled"),this._gamepadSetIndex=u,this._preferredGamepadId=""},a.prototype._getProfilePreferences=function(){var t,e=localStorage[f+"preferredProfiles"];if(!e)return{};try{t=JSON.parse(e)}catch(t){return{}}return t&&"object"==typeof t?t:{}},a.prototype.setProfile=function(t,e){var i;s.InputInterpreter.prototype.setProfile.call(this,t),null!==this._gamepad&&!1!==e&&(i=this._getProfilePreferences(),i[this._gamepad.id]=this._currentProfileName,localStorage[f+"preferredProfiles"]=JSON.stringify(i))},a.prototype.isVibrationSupported=function(){return null!==this._gamepad&&this._gamepad.vibrationActuator&&"dual-rumble"===this._gamepad.vibrationActuator.type&&"function"==typeof this._gamepad.vibrationActuator.playEffect},a.prototype.setVibrationEnabled=function(t,e){void 0===e&&(e=!0),this._vibrationEnabled=t,e&&(localStorage[f+"vibrationEnabled"]=t.toString())},a.prototype.vibrate=function(t){this._vibrationEnabled&&this._gamepad&&this._gamepad.vibrationActuator&&this._vibrationEffects.hasOwnProperty(t)&&this._gamepad.vibrationActuator.playEffect("dual-rumble",this._vibrationEffects[t])},{setModulePrefix:n,getDevices:T,GamepadInputInterpreter:a}}),define("modules/control/touch",["utils/utils","modules/strings","modules/control/control"],function(t,e,i){"use strict";function s(t){E=t}function n(t,e){this._area=a.NONE,this._type=null,this._timeout=0,this._count=1,this._range=0,this._moveX=0,this._moveY=0,this._currentX=0,this._currentY=0,this._touches=[],this._areaPx=null,this._rangePx=0,this._rangeFactor=0,i.ControlBinding.call(this,t,e)}function o(t){this._touches=[],this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),i.InputInterpreter.call(this,n,t)}var r={TAP:0,LONG_TAP:1,TWO_POINT_TAP:2,THREE_POINT_TAP:3,HOLD:4,SLIDE:5,SWIPE:6},a={NONE:{x:[0,0],y:[0,0]},FULL:{x:[0,1],y:[0,1]},"top-left":{x:[0,.5],y:[0,.5]},"top-right":{x:[.5,1],y:[0,.5]},"bottom-left":{x:[0,.5],y:[.5,1]},"bottom-right":{x:[.5,1],y:[.5,1]},left:{x:[0,.5],y:[0,1]},right:{x:[.5,1],y:[0,1]}},l={name:"touch"+e.CATEGORY_SEPARATOR+"tap",defaultValue:"tap {area} of the screen"},h={name:"touch"+e.CATEGORY_SEPARATOR+"longTap",defaultValue:"long tap {area} of the screen"},c={name:"touch"+e.CATEGORY_SEPARATOR+"twoPointTap",defaultValue:"tap {area} of the screen with two fingers"},u={name:"touch"+e.CATEGORY_SEPARATOR+"threePointTap",defaultValue:"tap {area} of the screen with three fingers"},_={name:"touch"+e.CATEGORY_SEPARATOR+"swipe",defaultValue:"swipe {direction} on {area} of the screen"},p={name:"touch"+e.CATEGORY_SEPARATOR+"hold",defaultValue:"tap and hold on {area} of the screen"},d={name:"touch"+e.CATEGORY_SEPARATOR+"holdDirection",defaultValue:"swipe {direction} and hold on {area} of the screen"},g={name:"touch"+e.CATEGORY_SEPARATOR+"slide",defaultValue:"slide {direction} on {area} of the screen"},m={name:"touch"+e.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},f={name:"touch"+e.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},S={name:"touch"+e.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},T={name:"touch"+e.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},E="";return n.prototype=new i.ControlBinding,n.prototype.constructor=n,n.prototype._initDerivedProperties=function(){switch(this._areaPx=t.deepCopy(this._area),this._type){case r.TWO_POINT_TAP:this._count=2;break;case r.THREE_POINT_TAP:this._count=3;break;default:this._count=1}this._timeout=this._type===r.LONG_TAP?2e3:300,this._rangePx=0,this._rangeFactor=0,this._currentX=0,this._currentY=0},n.prototype.loadFromJSON=function(e){if(i.ControlBinding.prototype.loadFromJSON.call(this,e),"string"==typeof e.area?this._area=a[e.area]:this._area=a.FULL,"string"==typeof e.type&&(this._type=t.getSafeEnumValueForKey(r,e.type)),this._range=e.range||.5,this._moveX=0,this._moveY=0,"string"==typeof e.direction)switch(e.direction){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}this._initDerivedProperties()},n.prototype.saveToLocalStorage=function(){localStorage[E+this._actionName+"_touch_area"]=JSON.stringify(this._area),localStorage[E+this._actionName+"_touch_type"]=this._type,localStorage[E+this._actionName+"_touch_moveX"]=this._moveX,localStorage[E+this._actionName+"_touch_moveY"]=this._moveY,localStorage[E+this._actionName+"_touch_range"]=this._range},n.prototype.loadFromLocalStorage=function(){void 0!==localStorage[E+this._actionName+"_touch_type"]&&(this._area=JSON.parse(localStorage[E+this._actionName+"_touch_area"]),this._type=localStorage[E+this._actionName+"_touch_type"],this._moveX=parseInt(localStorage[E+this._actionName+"_touch_moveX"],10),this._moveY=parseInt(localStorage[E+this._actionName+"_touch_moveY"],10),this._range=parseInt(localStorage[E+this._actionName+"_touch_range"],10),this._initDerivedProperties())},n.prototype.removeFromLocalStorage=function(){localStorage.removeItem(E+this._actionName+"_touch_area"),localStorage.removeItem(E+this._actionName+"_touch_type"),localStorage.removeItem(E+this._actionName+"_touch_moveX"),localStorage.removeItem(E+this._actionName+"_touch_moveY"),localStorage.removeItem(E+this._actionName+"_touch_range")},n.prototype.setScreenSize=function(t,e){this._areaPx.x[0]=this._area.x[0]*t,this._areaPx.x[1]=this._area.x[1]*t,this._areaPx.y[0]=this._area.y[0]*e,this._areaPx.y[1]=this._area.y[1]*e,this._rangePx=this._range*Math.min(t,e),this._rangeFactor=1/(this._rangePx||1)},n.prototype._touchStartedInArea=function(t){return t.startX>=this._areaPx.x[0]&&t.startX<=this._areaPx.x[1]&&t.startY>=this._areaPx.y[0]&&t.startY<=this._areaPx.y[1]},n.prototype.getTriggeredIntensity=function(t){var e,i,s;switch(this._type){case r.TAP:case r.LONG_TAP:for(e=t.length-1;e>=0;e--){if(i=t[e],i.age>this._timeout)return 0;if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20&&!0===i.finished)return i.capturedBy=this,1}return 0;case r.TWO_POINT_TAP:case r.THREE_POINT_TAP:if(this._touches.length>0){for(s=0,e=0;e<this._count;e++){if(i=this._touches[e],i.age>this._timeout||null!==i.capturedBy&&i.capturedBy!==this)return this._touches.length=0,0;!0===i.finished&&s++}for(e=0;e<this._count;e++)this._touches[e].capturedBy=this;if(s===this._count)return this._touches.length=0,1}else{for(e=t.length-1;e>=0&&(i=t[e],!(i.age>this._timeout));e--)if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20){if(!(this._touches.length<this._count))return this._touches.length=0,0;this._touches.push(i)}if(this._touches.length!==this._count)return this._touches.length=0,0;for(e=0;e<this._count;e++)this._touches[e].capturedBy=this}return 0;case r.SWIPE:for(e=0;e<t.length;e++)if(i=t[e],!0===i.finished&&!(i.age>=1e3)&&this._touchStartedInArea(i)&&(i.currentX-i.startX>20&&this._moveX>0||i.currentX-i.startX<-20&&this._moveX<0||i.currentY-i.startY>20&&this._moveY>0||i.currentY-i.startY<-20&&this._moveY<0))return 1;return 0;case r.HOLD:for(e=0;e<t.length;e++)if(i=t[e],!1===i.finished&&this._touchStartedInArea(i))return this._moveX>0?Math.min(Math.max(0,(i.currentX-i.startX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(i.startX-i.currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(i.currentY-i.startY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(i.startY-i.currentY-5)*this._rangeFactor),1):1;break;case r.SLIDE:for(e=0;e<t.length;e++)if(i=t[e],!0===i.finished&&!(i.age>=300)&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=5&&Math.abs(i.currentY-i.startY)<=5)return this._currentX=0,this._currentY=0,0;for(e=0;e<t.length;e++)i=t[e],!1===i.finished&&this._touchStartedInArea(i)&&(this._currentX+=i.currentX-i.previousX,this._currentY+=i.currentY-i.previousY,this._currentX>this._rangePx+5?this._currentX=this._rangePx+5:this._currentX<-this._rangePx-5&&(this._currentX=-this._rangePx-5),this._currentY>this._rangePx+5?this._currentY=this._rangePx+5:this._currentY<-this._rangePx-5&&(this._currentY=-this._rangePx-5));return this._moveX>0?Math.min(Math.max(0,(this._currentX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(-this._currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(this._currentY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(-this._currentY-5)*this._rangeFactor),1):0}return 0},n.prototype.getControlString=function(){var i="",s="";switch(this._moveX<0?i=e.get(m):this._moveX>0?i=e.get(f):this._moveY<0?i=e.get(S):this._moveY>0&&(i=e.get(T)),s=e.get(e.TOUCH_AREA.PREFIX,t.getKeyOfValue(a,this._area)),this._type){case r.TAP:return t.formatString(e.get(l),{area:s});case r.LONG_TAP:return t.formatString(e.get(h),{area:s});case r.TWO_POINT_TAP:return t.formatString(e.get(c),{area:s});case r.THREE_POINT_TAP:return t.formatString(e.get(u),{area:s});case r.SWIPE:return t.formatString(e.get(_),{area:s,direction:i});case r.HOLD:return 0!==this._moveX||0!==this._moveY?t.formatString(e.get(d),{area:s,direction:i}):t.formatString(e.get(p),{area:s});case r.SLIDE:return t.formatString(e.get(g),{area:s,direction:i})}return""},n.prototype.bindsTheSameControls=function(e){return this._type===e._type&&this._moveX===e._moveX&&this._moveY===e._moveY&&t.objectsEqual(this._area,e._area)},o.prototype=new i.InputInterpreter,o.prototype.constructor=o,o.prototype.getDeviceName=function(){return"touch"},o.prototype.resetState=function(){this._touches=[]},o.prototype.setScreenCenter=function(t,e){var i,s;for(s=Object.keys(this._currentProfile),i=0;i<s.length;i++)this._currentProfile[s[i]].setScreenSize(2*t,2*e)},o.prototype._addTouch=function(t,e){this._touches.push({identifier:t.identifier,startTime:e,startX:t.clientX,startY:t.clientY,previousX:t.clientX,previousY:t.clientY,currentX:t.clientX,currentY:t.clientY,finished:!1,capturedBy:null,age:0})},o.prototype._updateTouch=function(t){
var e;for(e=0;e<this._touches.length;e++)if(this._touches[e].identifier===t.identifier&&!1===this._touches[e].finished)return this._touches[e].currentX=t.clientX,void(this._touches[e].currentY=t.clientY)},o.prototype._removeTouch=function(t){var e;for(e=0;e<this._touches.length;e++)if(this._touches[e].identifier===t.identifier)return void(this._touches[e].finished=!0)},o.prototype._handleTouchStart=function(t){var e,i=performance.now();for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._addTouch(t.changedTouches[e],i);return!1},o.prototype._handleTouchMove=function(t){var e;for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._updateTouch(t.changedTouches[e]);return!1},o.prototype._handleTouchEnd=function(t){var e;for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._removeTouch(t.changedTouches[e]);return!1},o.prototype.startListening=function(){var t={passive:!1};i.InputInterpreter.prototype.startListening.call(this),document.addEventListener("touchstart",this._handleTouchStart,t),document.addEventListener("touchmove",this._handleTouchMove,t),document.addEventListener("touchend",this._handleTouchEnd,t),document.addEventListener("touchcancel",this._handleTouchEnd,t)},o.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.removeEventListener("touchstart",this._handleTouchStart),document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd),document.removeEventListener("touchcancel",this._handleTouchEnd)},o.prototype.checkAction=function(t){var e=this._currentProfile[t].getTriggeredIntensity(this._touches);return e>0?{name:t,intensity:e,source:this}:null},o.prototype.getTriggeredActions=function(t){var e,s,n,o=performance.now();for(s=i.InputInterpreter.prototype.getTriggeredActions.call(this,t),e=0;e<this._touches.length;e++)n=this._touches[e],n.finished?(this._touches.splice(e,1),e--):(n.previousX=n.currentX,n.previousY=n.currentY,n.age=o-n.startTime,n.capturedBy=null);return s},{setModulePrefix:s,TouchInputInterpreter:o}}),define("modules/camera-controller",["utils/types","modules/application","modules/control/control","modules/scene/camera"],function(t,e,i,s){"use strict";function n(n){i.Controller.call(this,n),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=n.maxSpeed||0,this._acceleration=n.acceleration||0,this._deceleration=n.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=n.maxSpin||0,this._angularAcceleration=n.angularAcceleration||0,this._angularDeceleration=n.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=n.objectChangeTransitionDuration,this._viewChangeTransitionDuration=n.viewChangeTransitionDuration,this._viewResetTransitionDuration=n.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue(s.Camera.TransitionStyle,n.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(t){this._velocityTargetVector[0]=-(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(t){this._velocityTargetVector[0]=(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(t){this._velocityTargetVector[1]=(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(t){this._velocityTargetVector[1]=-(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(t){this._velocityTargetVector[2]=-(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(t){this._velocityTargetVector[2]=(void 0!==t?t:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return n.prototype=new i.Controller,n.prototype.constructor=n,n.prototype.getType=function(){return"camera"},n.prototype.getMaxSpeed=function(){return this._maxSpeed},n.prototype.setCameraToFollowObject=function(t,e,i,s){this._controlledCamera.followObject(t,!1,e,i,s)},n.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},n.prototype.stop=function(){this._controlledVelocityVector[0]=0,this._controlledVelocityVector[1]=0,this._controlledVelocityVector[2]=0,this._velocityTargetVector[0]=0,this._velocityTargetVector[1]=0,this._velocityTargetVector[2]=0,this._angularVelocityVector[0]=0,this._angularVelocityVector[1]=0,this._angularVelocityVector[2]=0,this._angularVelocityTargetVector[0]=0,this._angularVelocityTargetVector[1]=0,this._angularVelocityTargetVector[2]=0},n.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},n.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},n.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:n}}),define("armada/screens/shared",["modules/game","modules/media-resources","modules/components","armada/configuration","armada/audio"],function(t,e,i,s,n){"use strict";function o(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozExitFullScreen?document.mozExitFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.msRequestFullscreen&&document.documentElement.msRequestFullscreen()}var r,a,l={GAME_VERSION_LABEL_ID:"gameVersion",MENU_THEME:"menu",BRIEFING_THEME:"briefing",DEBRIEFING_VICTORY_THEME:"debriefing_victory",DEBRIEFING_DEFEAT_THEME:"debriefing_defeat",SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",SLIDER_SOURCE:"slider.html",SLIDER_CSS:"slider.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",MENU_COMPONENT_CSS:"menucomponent.css",CHECK_GROUP_SOURCE:"checkgroup.html",CHECK_GROUP_CSS:"checkgroup.css",LIST_COMPONENT_SOURCE:"listcomponent.html",LIST_COMPONENT_CSS:"listcomponent.css",MENU_CLASS_NAME:"menu",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",LIST_CLASS_NAME:"list",LIST_ELEMENT_CLASS_NAME:"listElement",LIST_ELEMENT_CONTAINER_CLASS_NAME:"transparentContainer",CAPTION_CLASS_NAME:"caption",SUBCAPTION_CLASS_NAME:"subcaption",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",RELEASE_NOTES_CLASS_NAME:"releaseNotes",ANNOUNCEMENTS_CLASS_NAME:"announcements",ANNOUNCEMENT_CLASS_NAME:"announcement",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",SINGLE_PLAYER_SCREEN_NAME:"singlePlayer",SINGLE_PLAYER_SCREEN_SOURCE:"menu.html",SINGLE_PLAYER_MENU_CONTAINER_ID:"menuContainer",MISSIONS_SCREEN_NAME:"missions",MISSIONS_SCREEN_SOURCE:"missions.html",MISSIONS_SCREEN_CSS:"missions.css",MISSIONS_LIST_CONTAINER_ID:"missionListContainer",MULTI_GAMES_SCREEN_NAME:"multiGames",MULTI_GAMES_SCREEN_SOURCE:"multi-games.html",MULTI_GAMES_SCREEN_CSS:"multi-games.css",MULTI_LOBBY_SCREEN_NAME:"multiLobby",MULTI_LOBBY_SCREEN_SOURCE:"multi-lobby.html",MULTI_LOBBY_SCREEN_CSS:"multi-lobby.css",MULTI_SCORE_SCREEN_NAME:"multiScore",MULTI_SCORE_SCREEN_SOURCE:"multi-score.html",MULTI_SCORE_SCREEN_CSS:"multi-score.css",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DEBRIEFING_SCREEN_NAME:"debriefing",DEBRIEFING_SCREEN_SOURCE:"debriefing.html",DEBRIEFING_SCREEN_CSS:"debriefing.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GENERAL_SETTINGS_SCREEN_CSS:"general-settings.css",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",GRAPHICS_SCREEN_CSS:"graphics.css",AUDIO_SCREEN_NAME:"audio",AUDIO_SCREEN_SOURCE:"audio.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",CONTROLS_SCREEN_CSS:"controls.css",GAMEPLAY_SETTINGS_SCREEN_NAME:"gameplaySettings",GAMEPLAY_SETTINGS_SCREEN_SOURCE:"gameplay-settings.html",GAMEPLAY_SETTINGS_SCREEN_CSS:"gameplay-settings.css",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",ABOUT_SCREEN_CSS:"about.css",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer",DIALOG_SCREEN_NAME:"dialog",DIALOG_SCREEN_SOURCE:"dialog.html",DIALOG_SCREEN_CSS:"dialog.css"};return l.initAudio=function(t){var i,o;i=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).name),o=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).name),n.initMusic("menu",l.MENU_THEME,!0),n.initMusic("briefing",l.BRIEFING_THEME,!0),(i&&!i.isLoaded()&&!i.hasError()||o&&!o.isLoaded()&&!o.hasError())&&e.executeWhenReady(function(){r=i&&i.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).volume),a=o&&o.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).volume)}),e.requestResourceLoad(),t&&e.executeWhenReady(t)},l.playButtonSelectSound=function(t){r&&t&&r.play()},l.playButtonClickSound=function(t){a&&t&&a.play()},l.openDialog=function(e){t.getScreen(l.DIALOG_SCREEN_NAME).setup(e),t.setScreen(l.DIALOG_SCREEN_NAME,!0,l.SUPERIMPOSE_BACKGROUND_COLOR)},l.getSubParagraph=function(t){return'<p class="sub fadedText">'+t+"</p>"},l.setupFullscreenButton=function(){t.usesElectron()?this.getElement("fullscreenButton").hidden=!0:this.getElement("fullscreenButton").onclick=o},l.BUTTON_EVENT_HANDLERS={button:{mouseenter:function(){l.playButtonSelectSound(!this.classList.contains(i.DISABLED_CLASS_NAME))},mouseup:function(){l.playButtonClickSound(!this.classList.contains(i.DISABLED_CLASS_NAME))}}},l.MENU_EVENT_HANDLERS={show:function(){l.setupFullscreenButton.call(this),this._superimposed||n.playMusic(l.MENU_THEME)},optionselect:l.playButtonSelectSound,optionclick:l.playButtonClickSound},l.MENU_STYLE={cssFilename:l.MENU_COMPONENT_CSS,menuClassName:l.MENU_CLASS_NAME,buttonContainerClassName:l.MENU_BUTTON_CONTAINER_CLASS_NAME,selectedButtonClassName:i.SELECTED_CLASS_NAME,disabledClassName:i.DISABLED_CLASS_NAME},l}),define("armada/logic/SpacecraftEvents",[],function(){"use strict";return{BEING_TARGETED:"beingTargeted",BEING_HIT:"beingHit",TARGET_HIT:"targetHit",ANY_SPACECRAFT_HIT:"anySpacecraftHit",TARGET_FIRED:"targetFired",FIRED:"fired",COLLIDED:"collided",DESTRUCTED:"destructed",JUMP_ENGAGED:"jumpEngaged",PREPARING_JUMP:"preparingJump",JUMP_OUT_STARTED:"jumpOutStarted",JUMPED_OUT:"jumpedOut",JUMPED_IN:"jumpedIn",ARRIVED:"arrived",JUMP_CANCELLED:"jumpCancelled",COMMAND_RECEIVED:"commandReceived",HUD:"hud",RADIO:"radio",GAIN_KILL:"gainKill"}}),define("armada/logic/equipment",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/physics","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/logic/SpacecraftEvents","armada/configuration","armada/logic/constants","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f){"use strict";function S(){ct={},ct[ht]=n.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(ct[lt]=n.ShaderVariableType.FLOAT),ut=u.areDynamicLightsAvailable()&&u.getMaxPointLights()>0}function T(t){ot=t._playerSelfDamage,rt=t._playerFriendlyFireDamage,at=t._hitboxOffset}function E(t){rt=t}function y(t,e){var i;for(t.burn+=e,i=0;i<t.thrusters.length;i++)t.thrusters[i].addBurn(e)}function M(t,e){return e?at:0}function I(t){var i,s,n,o,r,a,l,h;return n=t.pMo,l=q.isHostile(t),!!(n&&(t!==q&&(rt||!t._piloted||l)||t===q&&dt)&&(h=gt(t,pt&&l),o=n.checkHit(J,Q,K,h)))&&(e.setDiffTranslation3(ft,Q,n._velocityMatrix),s=e.extractLength3(ft),i=e.prodMat4Vec3Aux(t.vMo.oM,ft),r=e.prodVec4Mat4Aux(o,t.vMo.getModelMatrix()),a=e.diffVec3Mat4Aux(r,n.pM),mt(t,n,o,r,a,i,ft,s,h),!0)}function C(t,e,i,s,n,o,r){J=t,Q=e,K=s,q=n,gt=o,mt=r,pt=n._piloted,dt=nt&&(ot||!pt),i.executeForObjects(Math.min(t[12],t[12]-e[12]*s*.001),Math.max(t[12],t[12]-e[12]*s*.001),Math.min(t[13],t[13]-e[13]*s*.001),Math.max(t[13],t[13]-e[13]*s*.001),Math.min(t[14],t[14]-e[14]*s*.001),Math.max(t[14],t[14]-e[14]*s*.001),I)}function A(t,e){this._class=null,this.vMo=null,this._velocityMatrix=i.identity4(),this._timeLeft=0,this._origin=null,this._lightSource=null,this._hitCallback=A.prototype._hitCallback.bind(this),t&&this.init(t,e)}function v(t){this._descriptor=t,this._firstPoint=[0,0,0],this._lastPoint=[0,0,0],this._emitting=!1,this._lastSegment=null,this.vMo=null,this._lastScene=null}function N(t,e,s,n,r,a){this._class=null,this.vMo=null,this._trailEmitter=null,this.pMo=new o.PhysicalObject,this._timeLeft=0,this._origin=null,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._yawTarget=0,this._pitchTarget=0,this._turningLimit=0,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._burnForAngularVelocityChangeFactor=0,this._mainBurn=!1,this._started=!1,this._homing=!1,this._stopHoming=!1,this._t=null,this._tHitPosition=[0,0,0],this._tHitPositionValid=!1,this._lightSource=null,this._soundSource=_.createSoundSource(0,0,0),this._startSound=null,this._hitCallback=N.prototype._hitCallback.bind(this),this._getHitOffset=N.prototype._getHitOffset.bind(this),t&&this.init(t,e||i.IDENTITY4,s||i.IDENTITY4,n,r,a)}function O(t,e,s){this._class=t,this._sc=e,this._slot=s,this._cooldown=0,this.vMo=null,this._origoPositionMatrix=i.identity4(),this._scaledOriMatrix=i.identity4(),this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class._fixed,this._lastAimStatus=this._fixed?it:st,this._tDistance=0,this._clear=!this._slot||this._slot.clear,this._aimBlockCalculated=this._fixed||this._clear,this._aimBlocked=new Array(this._class._barrels.length),this._aimBlocked.fill(!1),this._barrelMarkers=null}function L(t,e,i,s){this._class=t,this._sc=e,this._descriptor=i,this._mCount=s,this._cooldown=0,this._activeTubeIndex=0,this._salvo=!1,this._salvoLeft=0,this._salvoTarget=null,this._tHitTime=0,this.vMos=null}function R(t,e,i){this._sc=t,this._rangeSquared=0,this._t=null,this._scArray=e||null,this._tHitPosition=[0,0,0],this._tHitPositionValid=!1,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._timeUntilHostileOrderReset=0,this._timeUntilNonHostileOrderReset=0,this._mL=null,this._lockTime=1,this._lockTimeLeft=1,this._isInLockingRange=!1,this._rangeFactor=i?i.getSensorRangeFactor():1,this._lockingTimeFactor=i?i.getLockingTimeFactor():1}function b(t,e){this._propulsionClass=t,this._slot=e,this.vMo=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel(),this._lightSource=null}function x(t,e){this._class=t,this._drivenPhysicalObject=e,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._reverse={burn:0,thrusters:[]},this._strafeLeft={burn:0,thrusters:[]},this._strafeRight={burn:0,thrusters:[]},this._raise={burn:0,thrusters:[]},this._lower={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._rollLeft={burn:0,thrusters:[]},this._rollRight={burn:0,thrusters:[]},this._thrusterSoundClip=null,this._thrustFactor=this._class.getThrust()/this._class.getMaxMoveBurnLevel(),this._angularThrustFactor=this._class.getAngularThrust()/this._class.getMaxTurnBurnLevel()}function D(t){this._sc=t,this._assisted=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._holdSpeed=!1,this._speedThrottled=!1,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._locked=!1,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCombatForwardSpeed=0,this._maxCombatReverseSpeed=0,this._maxCruiseForwardSpeed=0,this._maxCruiseReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this._lastYawTarget=0,this._lastPitchTarget=0,this._lastRollTarget=0,this._lastStrafeTarget=0,this._lastLiftTarget=0,this.updateForNewPropulsion()}function w(t,e){this._class=t,this._sc=e,this._state=w.JumpState.NONE,this._timeLeft=0,this._soundClip=null,this._originalFlightMode=null,this._originalScalingMatrix=null}function P(t,e){var i;this._class=t,this._sc=e,this._capacity=t._capacity,this._timeSinceHit=0,this._timeSinceRecharge=t?t._rechargeAnimationDuration:0,this._state=[0,0,0,0],t&&(i=t._rechargeColor,this._state[0]=i[0],this._state[1]=i[1],this._state[2]=i[2]),this._soundClip=null}var V,F,U,B,H,G,k,j,W,Y,X,z,q,J,Q,K,Z={FREE:"free",COMBAT:"combat",CRUISE:"cruise"},$={FORWARD:"forward",REVERSE:"reverse",STRAFE_LEFT:"strafeLeft",STRAFE_RIGHT:"strafeRight",RAISE:"raise",LOWER:"lower",YAW_LEFT:"yawLeft",YAW_RIGHT:"yawRight",PITCH_UP:"pitchUp",PITCH_DOWN:"pitchDown",ROLL_LEFT:"rollLeft",ROLL_RIGHT:"rollRight"},tt=Math.radians(.05),et=1e3/o.ANGULAR_VELOCITY_MATRIX_DURATION,it=0,st=1,nt=!1,ot=!1,rt=!1,at=0,lt=null,ht=null,ct=null,ut=!1,_t={yaw:0,pitch:0,roll:0},pt=!1,dt=!1,gt=null,mt=null,ft=[0,0,0];return Object.freeze(Z),Object.freeze($),A.prototype.init=function(t,e){this._class=t,this._timeLeft=t._duration,this._origin=e},A.prototype.canBeReused=function(){return this._timeLeft<=0},A.prototype.createVisualModel=function(){this.vMo=new l.Billboard},A.prototype._initVisualModel=function(t,e,s,n){this.vMo||this.createVisualModel(),i.setIdentity4(this._velocityMatrix),this._origin&&i.copyTranslation4(this._velocityMatrix,this._origin.pMo._velocityMatrix),n&&(this._velocityMatrix[12]+=s[4]*n,this._velocityMatrix[13]+=s[5]*n,this._velocityMatrix[14]+=s[6]*n),this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._class.getSize(),t,e||i.IDENTITY4,s||i.IDENTITY4,this._class.getInstancedShader())},A.prototype.addToSceneNow=function(t,e,i,s,n,o){this._initVisualModel(e,i,s,n),t.addObject(this.vMo,!1,!0),o&&o(this.vMo)},A.prototype.addToScene=function(t,e,i,s,n,o){r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n,o))},A.prototype.addResourcesToScene=function(t,e){var s,n="projectile/"+this._class._name;this._class.acquireResources({projectileOnly:!1,sound:!0}),r.executeWhenReady(function(){t.hasResourcesOfObject(n)||(this._initVisualModel(e),t.addResourcesOfObject(this.vMo,n),s=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),s.addResourcesToScene(t),s=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),s.addResourcesToScene(t))}.bind(this))},A.prototype._hitCallback=function(t,s,n,o,r,a,l,h,c){var u,_;_=Math.min(this._timeLeft/this._class._dissipationDuration,1),s.applyForceAndTorque(r,l,_*h*this._class._mass*1e3,1,1),u=f.getExplosion(),u.init(t.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),i.IDENTITY4,e.scaled3Aux(l,-1),!0,!0,s._velocityMatrix),u.addToSceneNow(this.vMo._node._scene._rootNode,t._soundSource,!0),t.damage(_*this._class.getDamage(),n,e.scaled3(a,-1),this._origin,!1,c),this._timeLeft=0,this.vMo.markAsReusable(!0)},A.prototype.simulate=function(t,e){var i,s;this.canBeReused()||(i=Math.min(t,this._timeLeft),o.getDrag()>0&&this._class._dragFactor>0&&o.applyDrag(this._velocityMatrix,i,this._class._dragFactor),this.vMo.translateByMatrixMul(this._velocityMatrix,.001*i),this._timeLeft<this._class._dissipationDuration&&(s=this._timeLeft/this._class._dissipationDuration,this.vMo.setDirectionW(s),this._lightSource&&(this._lightSource._objectIntensity=s*this._class._lightIntensity)),C(this.vMo.pM,this._velocityMatrix,e,i,this._origin,M,this._hitCallback),this._timeLeft-=t,this._timeLeft<=0&&this.vMo.markAsReusable(!0))},A.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this.vMo&&this.vMo._node&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._velocityMatrix=null},v.prototype.getDescriptor=function(){return this._descriptor},v.prototype.addResourcesToScene=function(t){this._descriptor.acquireResources(),r.executeWhenReady(function(){t.addResourcesOfObject(new l.TrailSegment(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,e.NULL3,e.NULL3,e.NULL3,e.NULL3,e.NULL4,e.NULL4,0,0,0,this._descriptor.getInstancedShader()))}.bind(this))},v.prototype.startNew=function(t,i){e.setVector3(this._firstPoint,i),e.setVector3(this._lastPoint,i),this._emitting=!0,this._lastSegment=null,this.vMo=X.getObject(),this.vMo.init(this._descriptor.getSize()),t.addNode(this.vMo._node||new c.RenderableNode(this.vMo,!1,!0)),this._lastScene!==t&&(t.addObjectToMove(this),this._lastScene=t)},v.prototype.addPoint=function(t,i){var s,n,o;this.vMo.setPositionv(t),o=e.normalize3(e.diff3Aux(t,this._lastPoint)),n=this._lastSegment?this._lastSegment.getEndTimeLeft():0,s=z.getObject(),s.init(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,this._lastPoint,this._lastSegment?this._lastSegment.getEndDirection():o,t,o,this._descriptor._startColor,this._descriptor._endColor,this._descriptor._duration,n,Math.min(this._descriptor._duration,n+this._descriptor._growthRate*i),this._descriptor.getInstancedShader()),this.vMo._node.addSubnode(s._node||new c.RenderableNode(s,!1,!1,!0)),this.vMo.setSize(e.length3(e.diff3Aux(this._firstPoint,t))),e.setVector3(this._lastPoint,t),this._lastSegment=s},v.prototype.translatev=function(t){e.add3(this._lastPoint,t)},v.prototype.detach=function(){this._emitting=!1,this._lastSegment=null,this.vMo&&this.vMo.detach(),this.vMo=null},v.prototype.destroy=function(){this._descriptor=null,this._emitting=!1,this._firstPoint=null,this._lastPoint=null,this._lastSegment=null,this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null)},N.prototype.init=function(e,s,n,r,a,l){var h,c=i.identity4Aux();for(r&&i.copyTranslation4(c,r.pMo._velocityMatrix),a&&(c[12]+=n[4]*a,c[13]+=n[5]*a,c[14]+=n[6]*a),this._class=e,this.pMo.init(e._mass,s,n,e._modelScale,c,t.EMPTY_ARRAY,e._dragFactor),this._timeLeft=e._duration,this._timeLeftForIgnition=e._ignitionTime,this._origin=r,this._turningLimit=.2*e._angularAcceleration*o.ANGULAR_VELOCITY_MATRIX_DURATION_S,h=0;h<this._thrusters.length;h++)this._thrusters[h].destroy();this._thrusters.length=0,this._forward.thrusters.length=0,this._yawLeft.thrusters.length=0,this._yawRight.thrusters.length=0,this._pitchUp.thrusters.length=0,this._pitchDown.thrusters.length=0,this.addThrusters(e._thrusterSlots),this._homing=e._homingMode!==p.MissileHomingMode.NONE,this._burnForAngularVelocityChangeFactor=this._homing?1/o.ANGULAR_VELOCITY_MATRIX_DURATION_S*e._mass/e.getAngularThrust()*1e3:0,this._t=l||null,this._tHitPositionValid=!1,this._mainBurn=!1,this._started=!1,this._stopHoming=!1,this._startSound=null},N.prototype.canBeReused=function(){return this._timeLeft<=0},N.prototype.createVisualModel=function(){this.vMo=new l.ParameterizedMesh},N.prototype._initVisualModel=function(t,e,i,s){var n=i?u.getManagedShader(i):this._class.getShader();this.vMo||this.createVisualModel(),
this.vMo.init(this._class.getModel(),n,this._class.getTexturesOfTypes(n.getTextureTypes(),u.getTextureQualityPreferenceList()),this.pMo.pM,this.pMo.oM,this.pMo.sM,t,e,void 0,ct),this.vMo.hasParameterArray(ht)&&this.vMo.setParameterArray(ht,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&this.vMo.hasParameterArray(lt)&&this.vMo.setParameterArray(lt,this._class._defaultLuminosityFactors),s&&(this._trailEmitter=new v(this._class._trailDescriptor))},N.prototype.getTarget=function(){return this._t},N.prototype.getClass=function(){return this._class},N.prototype.addToSceneNow=function(t,i,s,n,o,r){var a;for(this._initVisualModel(i,s,n,o),t.addObject(this.vMo,!0),a=0;a<this._thrusters.length;a++)this._thrusters[a].addToScene(this.vMo._node,!0,!1);ut&&this._class._lightColor&&(this._lightSource||(this._lightSource=new h.PointLightSource(this._class._lightColor,0,e.NULL3,[this.vMo])),t.addPointLightSource(this._lightSource,m.MISSILE_LIGHT_PRIORITY)),r&&r(this.vMo)},N.prototype.addToScene=function(t,e,i,s,n,o){r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n,o))},N.prototype.addResourcesToScene=function(t,e,s,n,o){var a,l="missile/"+this._class._name;this._class.acquireResources({missileOnly:!1,sound:!0,trail:o}),r.executeWhenReady(function(){t.hasResourcesOfObject(l)||(this._initVisualModel(e,s,n,o),t.addResourcesOfObject(this.vMo,l),o&&this._trailEmitter.addResourcesToScene(t),a=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(t),a=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(t))}.bind(this))},N.prototype.getThrusterUse=function(t){switch(t){case $.FORWARD:return this._forward;case $.YAW_LEFT:return this._yawLeft;case $.YAW_RIGHT:return this._yawRight;case $.PITCH_UP:return this._pitchUp;case $.PITCH_DOWN:return this._pitchDown;default:return s.showError("Invalid thruster use specified for missile: '"+t+"'!",s.ErrorSeverity.SEVERE),null}},N.prototype.addThrusters=function(t){var e,i,s,n;for(e=0;e<t.length;e++)for(s=new b(this._class.getPropulsionClass(),t[e]),this._thrusters.push(s),i=0;i<t[e].uses.length;i++)(n=this.getThrusterUse(t[e].uses[i]))&&n.thrusters.push(s)},N.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.updateProdRotationRotationInverse4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo._velocityMatrix),this.pMo.oM),this._turningMatrixValid=!0),this._turningMatrix},N.prototype.yawLeft=function(t){this._yawTarget=-t*this._turningLimit},N.prototype.yawRight=function(t){this._yawTarget=t*this._turningLimit},N.prototype.pitchDown=function(t){this._pitchTarget=-t*this._turningLimit},N.prototype.pitchUp=function(t){this._pitchTarget=t*this._turningLimit},N.prototype.resetThrusterBurn=function(){var t;for(this._forward.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,t=0;t<this._thrusters.length;t++)this._thrusters[t].resetBurn()},N.prototype.addThrusterBurnForward=function(t){y(this._forward,t)},N.prototype.addThrusterBurnYawLeft=function(t){y(this._yawLeft,t)},N.prototype.addThrusterBurnYawRight=function(t){y(this._yawRight,t)},N.prototype.addThrusterBurnPitchUp=function(t){y(this._pitchUp,t)},N.prototype.addThrusterBurnPitchDown=function(t){y(this._pitchDown,t)},N.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t*this._burnForAngularVelocityChangeFactor/e},N.prototype._controlTurnThrusters=function(t,e,i){var s;this._yawTarget-t>1e-5?this.addThrusterBurnYawRight(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._yawTarget-t,i))):this._yawTarget-t<-1e-5?this.addThrusterBurnYawLeft(Math.min(1,this.getNeededBurnForAngularVelocityChange(t-this._yawTarget,i))):s=!0,this._pitchTarget-e>1e-5?this.addThrusterBurnPitchUp(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._pitchTarget-e,i))):this._pitchTarget-e<-1e-5?this.addThrusterBurnPitchDown(Math.min(1,this.getNeededBurnForAngularVelocityChange(e-this._pitchTarget,i))):s&&this._stopHoming&&(this._homing=!1),this._yawTarget=0,this._pitchTarget=0},N.prototype._applyTurnThrust=function(t){var i,s;i=e.getRowC43Aux(this.pMo.oM),s=e.getRowA43Aux(this.pMo.oM),this._yawRight.burn>0?this.pMo.applyTorque(this._class.getAngularThrust()*this._yawRight.burn,i,t):this._yawLeft.burn>0&&this.pMo.applyTorque(-this._class.getAngularThrust()*this._yawLeft.burn,i,t),this._pitchUp.burn>0?this.pMo.applyTorque(-this._class.getAngularThrust()*this._pitchUp.burn,s,t):this._pitchDown.burn>0&&this.pMo.applyTorque(this._class.getAngularThrust()*this._pitchDown.burn,s,t)},N.prototype._getTargetHitPosition=function(){var t,i,s;return this._tHitPositionValid||(t=this._t.getPhysicalPositionVector(),i=e.diffTranslation3Aux(this._t.pMo._velocityMatrix,this.pMo._velocityMatrix),s=this._class.getTargetHitTime(this.pMo.pM,t,i),this._tHitPosition[0]=t[0]+s*i[0],this._tHitPosition[1]=t[1]+s*i[1],this._tHitPosition[2]=t[2]+s*i[2],this._tHitPositionValid=!0),this._tHitPosition},N.prototype._turn=function(t,e,i,s,n){var o,r,a,l;r=this._class._angularAcceleration,l=5e3/(r*n),o=i*et,a=Math.max(o*o/(2*r),tt),t>a?this.yawLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this.yawRight(Math.min(Math.max(0,l*(-t-a)),1)),o=s*et,a=Math.max(o*o/(2*r),tt),e>a?this.pitchUp(Math.min(Math.max(0,l*(e-a)),1)):e<-a&&this.pitchDown(Math.min(Math.max(0,l*(-e-a)),1))},N.prototype._destruct=function(t,e,s,n,o,r,a){var l;this._t=null,l=f.getExplosion(),l.init(t,e,i.IDENTITY4,s,!0,!0,n),l.addToSceneNow(this.vMo._node._scene._rootNode,o,r),this._startSound&&(this._startSound.stopPlaying(_.SOUND_RAMP_DURATION),this._startSound=null),a?this.vMo._node.hide():(this.vMo.markAsReusable(!0),this._trailEmitter&&this._trailEmitter.detach())},N.prototype._getHitOffset=function(t){return this._origin.isHostile(t)?this._class._proximityRange:0},N.prototype._hitCallback=function(t,s,n,o,r,a,l,h,c){this._timeLeftForIgnition<=0?(s.applyForceAndTorque(r,l,h*this._class._kineticFactor*this.pMo._mass*1e3,1,1),this._destruct(t.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),e.scaled3Aux(l,-1),s._velocityMatrix,t._soundSource,!0,!1),t.damage(this._class.getDamage(0),n,e.scaled3(a,-1),this._origin,!0,c),this._timeLeft=0):(s.applyForceAndTorque(r,l,h*this.pMo._mass*1200,1,1),this.pMo.applyForce(h*this.pMo._mass*1200,-l[0],-l[1],-l[2],1))},N.prototype.destruct=function(t){var s=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node._scene._camera);this._destruct(this._class._explosionClass,this.pMo.pM,e.scaled3Aux(e.normalize3(i.translationVector3(this.pMo._velocityMatrix)),-1),this.pMo._velocityMatrix,_.createSoundSource(s[12],s[13],s[14]),!1,t)},N.prototype.playStartSound=function(){this._startSound=this._class.playStartSound(this._soundSource)},N.prototype.simulate=function(t,s){var n,o,r,a,l,h,c,u;if(!this.canBeReused()){if(a=Math.min(t,this._timeLeft),this._t&&this._homing&&!this._t._alive)this._t=null,this._timeLeftForIgnition<=0&&(this._timeLeft=0);else{if(this._mainBurn=!1,this._timeLeftForIgnition<=0&&this._t)for(o=this.pMo.oM,this.resetThrusterBurn(),this._homing&&!this._stopHoming&&(e.getYawAndPitch(_t,e.normalize3(e.prodMat4Vec3Aux(o,e.diffVec3Mat4Aux(this._getTargetHitPosition(),this.pMo.pM)))),r=this._class._mainBurnAngleThreshold),(!this._homing||this._stopHoming||Math.abs(_t.yaw)<r&&Math.abs(_t.pitch)<r)&&(this.pMo.applyForce(this._class.getThrust(),o[4],o[5],o[6],a),this._mainBurn=!0,this.addThrusterBurnForward(1),this._started||(this._started=!0,this._class._homingMode===p.MissileHomingMode.INITIAL&&(this._stopHoming=!0),o=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node._scene._camera),this._soundSource.setPositionImmediate(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14])),this.playStartSound())),this._homing&&(h=this.getTurningMatrix(),c=Math.sign(h[4])*e.angle2y(h[4],h[5]),u=Math.sign(h[6])*e.angle2x(h[5],h[6]),this._stopHoming||this._turn(_t.yaw,_t.pitch,c,u,a),this._controlTurnThrusters(c,u,a),this._applyTurnThrust(a)),n=0;n<this._thrusters.length;n++)this._thrusters[n].updateVisuals();this._started&&(o=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node._scene._camera),this._soundSource.updatePosition(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14]))),this._lightSource&&(this._lightSource._objectIntensity=this._mainBurn?this._class._lightIntensity:0),this.pMo.simulate(a),this._turningMatrixValid=!1,this._tHitPositionValid=!1,this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._trailEmitter&&(this._mainBurn?(l=this.vMo.getPositionVector(),e.add3(l,e.prodVec3Mat3Aux(this._class.getEnginePosition(),i.prodScalingRotation3Aux(this.vMo.sM,this.vMo.oM))),this._trailEmitter._emitting?this._trailEmitter.addPoint(l,a):this._trailEmitter.startNew(this.vMo._node._scene,l)):this._trailEmitter._emitting&&this._trailEmitter.detach()),a>0&&C(this.pMo.pM,this.pMo._velocityMatrix,s,a,this._origin,this._getHitOffset,this._hitCallback)}this._timeLeft-=t,this._timeLeftForIgnition-=t,this._timeLeft<=0&&(this._timeLeft=0,this.vMo.canBeReused()||this.destruct(!1))}},N.prototype.updateThrusterVisuals=function(){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].updateVisuals()},N.prototype.destroy=function(){var t;for(this._timeLeft=0,this._class=null,this._origin=null,this._turningMatrix=null,this._t=null,this._tHitPosition=null,t=0;t<this._thrusters.length;t++)this._thrusters[t].destroy();this._thrusters=null,this._forward=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this.vMo&&this.vMo._node&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._trailEmitter&&(this._trailEmitter.destroy(),this._trailEmitter=null),this.pMo=null,this._startSound&&(this._startSound.stopPlaying(_.SOUND_RAMP_DURATION),this._startSound=null),this._soundSource=null,this._lightSource=null,this._hitCallback=null,this._getHitOffset=null},O.prototype.getDisplayName=function(){return this._class.getDisplayName()},O.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},O.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},O.prototype.getDamage=function(t){return this._class.getDamage(t)},O.prototype.getFirepower=function(t){return this._class.getFirepower(t)},O.prototype.getFireRate=function(){return this._class.getFireRate()},O.prototype.getRange=function(t){return(this._class.getProjectileVelocity()+t)*this._class.getProjectileClass()._duration*.001},O.prototype.getCooldown=function(){return this._class.getCooldown()},O.prototype.getBasePointPosVector=function(t){var i,s=e.prodTranslationRotation3Aux(this._origoPositionMatrix,t);return e.addVec3Mat4(s,this._sc.pMo.pM),i=e.prodVec4Mat4Aux(this._class._basePoint,this._transformMatrix),e.mulVec3Mat4(i,this._scaledOriMatrix),e.mulVec3Mat4(i,t),e.add3(i,s),i},O.prototype.getProjectileOrientationMatrix=function(){return i.setProd3x3SubOf4(O._pOriMatrix,this._slot.orientationMatrix,this._sc.pMo.oM),this._fixed||i.setProd3x3SubOf4(O._pOriMatrix,this._transformMatrix,i.matrix4Aux(O._pOriMatrix)),O._pOriMatrix},O.prototype.acquireResources=function(t){this._class.acquireResources(t)},O.prototype.addToSceneNow=function(t,s,n,o,a){var h,_,d,g,m,f,S;if(d=o.shaderName?u.getManagedShader(o.shaderName):this._class.getShader(),_=this._class.getModel()._scale/t._renderableObject.sM[0],i.setTranslatedByVector(this._origoPositionMatrix,this._slot?this._slot.positionMatrix:i.IDENTITY4,e.prodVec3Mat4Aux(e.scaled3Aux(this._class._attachmentPoint,-1),i.scaledRotationAux(_,this._slot?this._slot.orientationMatrix:i.IDENTITY4))),h=new l.ParameterizedMesh(this._class.getModel(),d,o.skipTextures?{}:this._class.getTexturesOfTypes(d.getTextureTypes(),u.getTextureQualityPreferenceList()),this._slot?this._origoPositionMatrix:i.identity4(),o.orientationMatrix||(this._slot?this._slot.orientationMatrix:i.identity4()),i.scaling4(_),!0===n,s,void 0,ct,this.vMo),t.addSubnode(new c.RenderableNode(h)),o.barrelMarkers){for(m=this._class._barrels,this._barrelMarkers=new c.RenderableNode(new l.ContainerObject(d),!1),g=0;g<m.length;g++)S=(o.barrelMarkerSize||1)/_*this.getProjectileClass()._muzzleFlash.getSize(),f=new l.ShadedLODMesh(r.getModel(p.MARKER_MODEL_NAME).getEgomModel(),u.getManagedShader(o.barrelMarkerShaderName),{},i.translation4v(m[g].getPositionVector()),i.rotationX4(.5*Math.PI),i.scaling4(S),!0,0,0),this._barrelMarkers.addSubnode(new c.RenderableNode(f));h._node.addSubnode(this._barrelMarkers),this._barrelMarkers.hide()}this.vMo||(h.hasParameterArray(ht)&&h.setParameterArray(ht,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&h.hasParameterArray(lt)&&h.setParameterArray(lt,this._class._defaultLuminosityFactors),this.vMo=h),i.setProdScalingRotation(this._scaledOriMatrix,this.vMo.sM,this._slot?this._slot.orientationMatrix:i.IDENTITY4),a&&a(h)},O.prototype.addToScene=function(t,e,i,s,n){s.skipResources||this.acquireResources({overrideShaderName:s.shaderName,omitTextures:s.skipTextures,projectileResources:s.projectileResources,sound:s.sound,barrelMarkers:s.barrelMarkers,barrelMarkerShaderName:s.barrelMarkerShaderName}),r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n))},O.prototype._getMuzzleFlashForBarrel=function(t){var e=this._class.getProjectileClass()._muzzleFlash,s=j.getObject();return l.initDynamicParticle(s,e.getModel(),e.getShader(),e.getTexturesOfTypes(e.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),e._color,e.getSize(),i.translation4vAux(t),e._duration||500,e.getInstancedShader()),s},O.prototype.addProjectileResourcesToScene=function(t){var e,i="weapon/"+this._class._name;e=new A(this.getProjectileClass()),e.addResourcesToScene(t),r.executeWhenReady(function(){var e;t.hasResourcesOfObject(i)||(e=this._getMuzzleFlashForBarrel([0,0,0]),t.addResourcesOfObject(e,i))}.bind(this))},O.prototype.simulate=function(t){var s,n;if(this._cooldown=Math.max(this._cooldown-t,0),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),n=this._class._rotators,s=0;s<n.length;s++)i.rotateAroundPoint4(this._transformMatrix,e.prodVec3Mat4Aux(n[s].center,this._transformMatrix),e.prodVec3Mat4Aux(n[s].axis,this._transformMatrix),this._rotationAngles[s]),this.vMo.setMat4Parameter(ht,n[s].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},O._wSlotPosMatrix=i.identity4(),O._pPosMatrix=i.identity4(),O._pOriMatrix=i.identity4(),O._pTargetMatrix=i.identity4(),O._pDirection=[0,0,0],O._barrelPosVector=[0,0,0,1],O._muzzleFlashPosVector=[0,0,0,1],O.prototype.fire=function(t,s,n){var o,r,a,l,u,_,p,d,g,f,S=this.vMo._node._scene;if(this._cooldown<=0&&(!s||this._lastAimStatus===it||5===this._lastAimStatus)){for(l=e.prodTranslationRotation3Aux(this._origoPositionMatrix,t),i.setTranslatedByVector(O._wSlotPosMatrix,this._sc.pMo.pM,l),u=this.getProjectileOrientationMatrix(),e.setRowB43(O._pDirection,u),_=this.getProjectileClass(),d=this._class._barrels,a=0,o=0;o<d.length;o++)e.setVector4(O._barrelPosVector,d[o].getPositionVector()),this._fixed||e.mulVec4Mat4(O._barrelPosVector,this._transformMatrix),e.setVector4(O._muzzleFlashPosVector,O._barrelPosVector),e.mulVec3Mat4(O._barrelPosVector,i.prod3x3SubOf4Aux(this._scaledOriMatrix,t)),i.setTranslatedByVector(O._pPosMatrix,O._wSlotPosMatrix,O._barrelPosVector),this._aimBlockCalculated||(i.setTranslatedByVector(O._pTargetMatrix,O._pPosMatrix,e.scaled3Aux(O._pDirection,this._tDistance)),this._sc.pMo.checkHit(O._pTargetMatrix,i.translation4vAux(O._pDirection),1e3*this._tDistance,0)?this._aimBlocked[o]=!0:this._aimBlocked[o]=!1),this._aimBlocked[o]||(p=this._getMuzzleFlashForBarrel(O._muzzleFlashPosVector),this.vMo._node.addSubnode(p._node||new c.RenderableNode(p,!1,!1,!0)),r=W.getObject(),r.init(_,this._sc),r.addToSceneNow(S,!1,O._pPosMatrix,u,this.getProjectileVelocity()),ut&&_._lightColor&&(f?f.addEmittingObject(r.vMo):(f=new h.PointLightSource(_._lightColor,_._lightIntensity,e.NULL3,[r.vMo]),r._lightSource=f)),this._sc.pMo.applyForceAndTorque(e.diffTranslation3Aux(O._pPosMatrix,this._sc.pMo.pM),e.getRowB43ScaledAux(u,-1),this._class.getFireForce(),1,1),a++);return this._aimBlockCalculated=!0,a>0&&(this._cooldown=this._class.getCooldown(),f&&S.addPointLightSource(f,m.PROJECTILE_LIGHT_PRIORITY),n||(g=i.translationVector3(r.vMo.getPositionMatrixInCameraSpace(S._camera))),this._class.playFireSound(g,n,G,k)),a}return 0},O.prototype.setRotation=function(e,i){this._fixed||(this._rotationAngles[0]=e*t.RAD,this._rotationAngles[1]=i*t.RAD,this._rotationChanged=!0,this._aimBlockCalculated=this._clear)},O.prototype.rotateTo=function(e,i,s,n,o){var r,a,l,h,c;for(a=this._class._rotators,this._lastAimStatus=5,l=0;l<a.length;l++){switch(l){case 0:r=e-this._rotationAngles[0],this._class._rotationStyle===p.WeaponRotationStyle.ROLL_YAW&&Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,i=-i);break;case 1:r=i-this._rotationAngles[1]}a[l].restricted||(r>Math.PI?r-=t.DOUBLE_PI:r<-Math.PI&&(r+=t.DOUBLE_PI)),c=this._rotationAngles[l],h=0,Math.abs(r)>s&&(h=a[l].rotationRate*o/1e3,r>0?this._rotationAngles[l]+=Math.min(h,r):this._rotationAngles[l]-=Math.min(h,-r),Math.abs(r)-h>n&&(this._lastAimStatus=3)),a[l].restricted?(this._rotationAngles[l]>a[l].range[1]&&(this._rotationAngles[l]=a[l].range[1],Math.abs(r)-h>n&&(this._lastAimStatus=2)),this._rotationAngles[l]<a[l].range[0]&&(this._rotationAngles[l]=a[l].range[0],Math.abs(r)-h>n&&(this._lastAimStatus=2))):(this._rotationAngles[l]>Math.PI&&(this._rotationAngles[l]-=t.DOUBLE_PI),this._rotationAngles[l]<-Math.PI&&(this._rotationAngles[l]+=t.DOUBLE_PI)),this._rotationAngles[l]!==c&&(this._rotationChanged=!0,this._aimBlockCalculated=this._clear)}},O.prototype.aimTowards=function(t,i,s,n,o){var r,a,l,h;if(!this._fixed){switch(r=this.getBasePointPosVector(n),a=e.diff3Aux(t,r),l=e.prodMat4Vec3Aux(this._sc.pMo.oM,a),l=e.prodMat4Vec3Aux(this._slot.orientationMatrix,l),this._tDistance=e.extractLength3(l),h=this._tDistance<=this.getRange(0),this._class._rotationStyle){case p.WeaponRotationStyle.YAW_PITCH:e.getYawAndPitch(_t,l),this.rotateTo(-_t.yaw,-_t.pitch,i,s,o);break;case p.WeaponRotationStyle.ROLL_YAW:e.getRollAndYaw(_t,l,!1),this.rotateTo(_t.roll,_t.yaw,i,s,o)}h||5!==this._lastAimStatus||(this._lastAimStatus=4)}},O.prototype.rotateToDefaultPosition=function(t,e){var i;this._fixed||(i=this._class._rotators,this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,t,0,e),this._lastAimStatus=st)},O.prototype.getScoreValue=function(){return this._class.getScoreValue()},O.prototype.getMaxProjectileCount=function(){return this._class.getMaxProjectileCount()},O.prototype.getMaxExplosionCount=function(){return this._class.getMaxExplosionCount()},O.prototype.getMaxParticleCount=function(){return this._class.getMaxParticleCount()},O.prototype.destroy=function(){this._class=null,this._sc=null,this._slot=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._barrelMarkers&&this._barrelMarkers.markAsReusable(!0),this._barrelMarkers=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null},L.prototype.getDisplayName=function(){return this._class.getDisplayName()},L.prototype.getDamage=function(t){return this._class.getDamage(t)},L.prototype.getFirepower=function(t){return this._mCount*this._class.getDamage(t)},L.prototype.getNominalRange=function(){return this._class.getNominalRange()},L.prototype.getFireRate=function(){return this._class.getFireRate()},L.prototype.getLockingTime=function(){return this._class.getLockingTime()},L.prototype.getCooldown=function(){return this._class.getCooldown()},L.prototype.getLoadRatio=function(){return this._mCount>this._salvoLeft?this._salvo?1-(this._salvoLeft+this._cooldown/this._class.getCooldown())/this._descriptor.salvo:1-this._cooldown/this._class.getCooldown():0},L.prototype.setSalvoMode=function(t){this._salvo=t&&this._descriptor.salvo>1},L.prototype.toggleSalvoMode=function(){return this._descriptor.salvo>1&&(this._salvo=!this._salvo,!0)},L.prototype.getSalvo=function(){return this._descriptor.salvo},L.prototype.setMinimumCooldown=function(t){this._cooldown<t&&(this._cooldown=t)},L.prototype.getMissileOrientationMatrix=function(){return i.setProd3x3SubOf4(L._mOriMatrix,this._descriptor.orientationMatrix,this._sc.pMo.oM),L._mOriMatrix},L.prototype.acquireResources=function(t){this._class.acquireResources(t)},L.prototype.addMissileResourcesToScene=function(t){var e,i="missileLauncher/"+this._class._name;e=new N(this._class),e.addResourcesToScene(t,!1,void 0,void 0,!0),r.executeWhenReady(function(){t.addResourcesOfObject(null,i)})},L.prototype.addToSceneNow=function(t,s,n,o,r){var a,h,_,p,d,g,m,f=!1;for(h=this._class.getModel()._scale/t._renderableObject.sM[0],_=o.shaderName?u.getManagedShader(o.shaderName):this._class.getShader(),p=o.skipTextures?{}:this._class.getTexturesOfTypes(_.getTextureTypes(),u.getTextureQualityPreferenceList()),this.vMos||(this.vMos=[],f=!0),d=0;d<this._descriptor.tubePositions.length;d++)for(m=o.allMissiles?Math.floor(this._mCount/this._descriptor.tubePositions.length)+(this._mCount%this._descriptor.tubePositions.length>d?1:0):1,g=0;g<m;g++)a=new l.ParameterizedMesh(this._class.getModel(),_,p,i.translation4v(e.sum3Aux(this._descriptor.tubePositions[d],[0,-g*h*this._class._length,0])),i.identity4(),i.scaling4(h),!0===n,s,void 0,ct),t.addSubnode(new c.RenderableNode(a)),a.hasParameterArray(ht)&&a.setParameterArray(ht,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&a.hasParameterArray(lt)&&a.setParameterArray(lt,this._class._defaultLuminosityFactors),f&&this.vMos.push(a),r&&r(a)},L.prototype.simulate=function(t){if(this._cooldown=Math.max(this._cooldown-t,0),this._salvoLeft>0&&this._cooldown<=0&&(this._mCount>0&&this._salvoTarget&&this._salvoTarget._alive?this.launch(this._sc.getScaledOriMatrix(),this._sc.getSoundSourceForFireSound(),!0)&&this._sc.handleSalvoMissileLaunched():(this._salvoLeft=0,this._salvoTarget=null)),null!==this.vMos)for(;this.vMos.length>this._mCount;)this.vMos.shift().markAsReusable(!0)},L._tubePosMatrix=i.identity4(),L._mOriMatrix=i.identity4(),L.prototype.launch=function(t,s,n){var o,r,a,l,h=this._sc.vMo._node._scene;return this._mCount>0&&this._cooldown<=0&&(n||this._salvoLeft<=0)?(n||(this._salvo&&this._sc.getTarget()?(this._salvoLeft=this._descriptor.salvo,this._salvoTarget=this._sc.getTarget()):this._salvoLeft=1),this._mCount--,this._salvoLeft--,this._cooldown=this._salvoLeft>0?this._class._salvoCooldown:this._class.getCooldown(),r=e.prodVec3Mat4Aux(this._descriptor.tubePositions[this._activeTubeIndex],t),i.setTranslatedByVector(L._tubePosMatrix,this._sc.pMo.pM,r),a=this.getMissileOrientationMatrix(),o=Y.getObject(),o.init(this._class,L._tubePosMatrix,a,this._sc,this._class._launchVelocity,n?this._salvoTarget:this._sc.getTarget()),o.addToSceneNow(h,!1,void 0,void 0,!0),this._sc.pMo.applyForceAndTorque(r,e.getRowB43ScaledAux(a,-1),this._class.getLaunchForce(),1,1),s||(l=i.translationVector3(o.vMo.getPositionMatrixInCameraSpace(h._camera))),this._class.playLaunchSound(l,s,G,k),this._activeTubeIndex=(this._activeTubeIndex+1)%this._descriptor.tubePositions.length,o):null},L.prototype.isReady=function(){return this._cooldown<=0&&this._salvoLeft<=0},L.prototype.isInLockingRange=function(t){var i,s,n,o,r,a,l,h,c;if(o=this._sc.pMo.oM,l=e.sumVec3Mat4Aux(e.getRowB43ScaledAux(o,this._class._launchVelocity),this._sc.pMo._velocityMatrix),h=e.diffMat4Vec3Aux(t.pMo._velocityMatrix,l),i=.001*this._class._ignitionTime,n=e.sum3Aux(t.getPhysicalPositionVector(),e.scaled3Aux(h,i)),this._class._homingMode===p.MissileHomingMode.NONE)a=0;else{if(e.getYawAndPitch(_t,e.normalize3(e.prodMat4Vec3Aux(o,e.diffVec3Mat4Aux(n,this._sc.pMo.pM)))),_t.yaw=Math.abs(_t.yaw),_t.pitch=Math.abs(_t.pitch),this._class._lockingAngle>0&&Math.max(_t.yaw,_t.pitch)>this._class._lockingAngle)return!1;r=Math.max(0,Math.max(_t.yaw,_t.pitch)-this._class._mainBurnAngleThreshold),c=this._class._angularAcceleration,a=(.2*c*.2+r)/(.2*c),a<.4&&(a=Math.sqrt(4*r/c)),e.add3(n,e.scaled3Aux(h,a))}return s=.001*this._class._duration-i-a,this._tHitTime=this._class.getTargetHitTime(this._sc.pMo.pM,n,h),this._tHitTime<s},L.prototype.getTargetHitTime=function(){return this._tHitTime},L.prototype.getScoreValue=function(){return this._class.getScoreValue()*this._mCount},L.prototype.getMissileCount=function(){return this._mCount},L.prototype.hasMissilesLeftToLaunch=function(){return this._mCount>this._salvoLeft},L.prototype.getMaxMissileCount=function(){return Math.min(this._mCount,this._class.getMaxCount())},L.prototype.getMaxExplosionCount=function(){return this.getMaxMissileCount()},L.prototype.getMaxParticleCount=function(){return this.getMaxMissileCount()*this._class.getParticleCount()},L.prototype.destroy=function(){var t;if(this._class=null,this._sc=null,this._descriptor=null,this._salvoTarget=null,null!==this.vMos){for(t=0;t<this.vMos.length;t++)this.vMos[t].markAsReusable(!0);this.vMos=null}},R.prototype.updateSensors=function(t){var e=t?t.getRange():0;this._rangeSquared=e*e*this._rangeFactor*this._rangeFactor},R.prototype.isInRange=function(t){return i.distanceSquared(this._sc.pMo.pM,t.pMo.pM)<=this._rangeSquared},R.prototype._resetMissileLock=function(){this._lockTime=this._t&&this._mL?this._t.getLockingTimeFactor()*this._lockingTimeFactor*this._mL.getLockingTime():1,this._lockTimeLeft=this._lockTime},R.prototype.isMissileLocked=function(){return this._lockTimeLeft<=0},R.prototype.getMissileLockRatio=function(){return 1-this._lockTimeLeft/this._lockTime},R.prototype.setMissileLauncher=function(t){this._mL&&t&&t._class===this._mL._class?this._mL=t:(this._mL=t,this._resetMissileLock())},R.prototype.setTarget=function(t){var e,i,s,n;if(t!==this._t){if(this._t&&this._t.setBeingUntargeted(this._sc),this._t=t,this._tHitPositionValid=!1,this._sc.vMo)for(s=this._sc.vMo._node,n=s._scene._camera,i=s.getCameraConfigurationsWithName("target"),e=0;e<i.length;e++)n.getConfiguration()===i[e]&&n.transitionToSameConfiguration(300,"smooth"),i[e].setOrientationFollowedObjects(this._t?[this._t.vMo]:[],!0);this._t&&this._t.setBeingTargeted(this._sc),this._resetMissileLock()}},R.prototype._filterHostileTarget=function(t){return this._sc.isHostile(t)&&i.distanceSquared(this._sc.pMo.pM,t.pMo.pM)<=this._rangeSquared},R.prototype._filterNonHostileTarget=function(t){return t!==this._sc&&!this._sc.isHostile(t)&&i.distanceSquared(this._sc.pMo.pM,t.pMo.pM)<=this._rangeSquared},R.prototype._mapTargetByBearing=function(t,i){return{index:i,value:e.angle3u(e.getRowB43Aux(this._sc.pMo.oM),e.normalize3(e.diffTranslation3Aux(t.pMo.pM,this._sc.pMo.pM)))}},R.prototype._mapTargetToCombinedValue=function(t,i){var s=e.diffTranslation3Aux(t.pMo.pM,this._sc.pMo.pM);return{index:i,value:(e.extractLength3(s)+200*e.angle3u(e.getRowB43Aux(this._sc.pMo.oM),s))*(this._sc.isGoodAgainst(t)?.5:this._sc.isBadAgainst(t)?2:1)}},R._compareMappedTargets=function(t,e){return t.value-e.value},R.prototype._updateHostileOrder=function(t){var e,i,s;if(this._scArray){if(e=this._scArray.filter(this._filterHostileTarget,this),this._timeUntilHostileOrderReset<=0){for(i=e.map(t,this).sort(R._compareMappedTargets),this._orderedHostileTargets=[],s=0;s<i.length;s++)this._orderedHostileTargets.push(e[i[s].index]);return!0}for(s=0;s<e.length;s++)this._orderedHostileTargets.indexOf(e[s])<0&&this._orderedHostileTargets.push(e[s])}return!1},R.prototype._updateNonHostileOrder=function(){var t,e,i;if(this._scArray){if(t=this._scArray.filter(this._filterNonHostileTarget,this),this._timeUntilNonHostileOrderReset<=0){for(e=t.map(this._mapTargetByBearing,this).sort(R._compareMappedTargets),this._orderedNonHostileTargets=[],i=0;i<e.length;i++)this._orderedNonHostileTargets.push(t[e[i].index]);return!0}for(i=0;i<t.length;i++)this._orderedNonHostileTargets.indexOf(t[i])<0&&this._orderedNonHostileTargets.push(t[i])}return!1},R.prototype._isValidNewTarget=function(t){return t._alive&&!t._away&&t!==this._t},R.prototype._tNextHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(s=this._orderedHostileTargets.length,e=n?0:(this._orderedHostileTargets.indexOf(this._t)+1)%s,i=0;i<s&&!this._isValidNewTarget(this._orderedHostileTargets[e]);)e=(e+1)%s,i++;if(i<s)return this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=750,!0}return this._timeUntilHostileOrderReset=0,!1},R.prototype._tPreviousHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(s=this._orderedHostileTargets.length,e=n?s-1:(this._orderedHostileTargets.indexOf(this._t)+s-1)%s,i=0;i<s&&!this._isValidNewTarget(this._orderedHostileTargets[e]);)e=(e+s-1)%s,i++;if(i<s)return this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=750,!0}return this._timeUntilHostileOrderReset=0,!1},R.prototype.targetNextNearestHostile=function(){return this._tNextHostile(this._mapTargetByBearing)},R.prototype.targetPreviousNearestHostile=function(){return this._tPreviousHostile(this._mapTargetByBearing)},R.prototype.targetNextBestHostile=function(){return this._tNextHostile(this._mapTargetToCombinedValue)},R.prototype.targetNextNearestNonHostile=function(){
var t,e,i,s=this._updateNonHostileOrder();if(this._orderedNonHostileTargets&&this._orderedNonHostileTargets.length>0){for(i=this._orderedNonHostileTargets.length,t=s?0:(this._orderedNonHostileTargets.indexOf(this._t)+1)%i,e=0;e<i&&!this._isValidNewTarget(this._orderedNonHostileTargets[t]);)t=(t+1)%i,e++;if(e<i)return this.setTarget(this._orderedNonHostileTargets[t]),this._timeUntilNonHostileOrderReset=750,!0}return this._timeUntilNonHostileOrderReset=0,!1},R.prototype.getTarget=function(){return!this._t||this._t._alive&&!this._t._away||this.setTarget(null),this._t},R.prototype.getTargetHitPosition=function(){var i,s,n,o,r,a,l,h,c;if(!this._tHitPositionValid){if(this._tHitPositionValid=!0,s=this._t.pMo.pM,o=this._sc._ws,0===o.length)return this._tHitPosition[0]=s[12],this._tHitPosition[1]=s[13],this._tHitPosition[2]=s[14],s;i=this._sc.pMo.pM,n=e.diffTranslation3Aux(this._t.pMo._velocityMatrix,this._sc.pMo._velocityMatrix),r=o[0].getProjectileVelocity(),a=r*r-(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),l=2*(n[0]*(i[12]-s[12])+n[1]*(i[13]-s[13])+n[2]*(i[14]-s[14])),h=-s[12]*s[12]-i[12]*i[12]+2*s[12]*i[12]-s[13]*s[13]-i[13]*i[13]+2*s[13]*i[13]-s[14]*s[14]-i[14]*i[14]+2*s[14]*i[14],c=t.getGreaterSolutionOfQuadraticEquation(a,l,h),this._tHitPosition[0]=s[12]+c*n[0],this._tHitPosition[1]=s[13]+c*n[1],this._tHitPosition[2]=s[14]+c*n[2]}return this._tHitPosition},R.prototype.isInLockingRange=function(){return this._isInLockingRange},R.prototype.simulate=function(t){0!==this._rangeSquared&&(!this._t||this._t._alive&&!this._t._away&&this.isInRange(this._t)||this.setTarget(null),this._tHitPositionValid=!1,this._timeUntilHostileOrderReset>0&&(this._timeUntilHostileOrderReset-=t),this._timeUntilNonHostileOrderReset>0&&(this._timeUntilNonHostileOrderReset-=t),this._t&&this._mL&&this._mL.hasMissilesLeftToLaunch()?(this._isInLockingRange=this._mL.isInLockingRange(this._t),this._isInLockingRange?this._lockTimeLeft=Math.max(0,this._lockTimeLeft-t):this._resetMissileLock()):(this._isInLockingRange=!1,this._resetMissileLock()))},R.prototype.destroy=function(){this._sc=null,this._scArray=null,this._t=null,this._tHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._mL=null},b.PROPULSION_RESOURCE_PARAMS={sound:!0},b.prototype.addToScene=function(t,e,s){var n;this._propulsionClass.acquireResources(b.PROPULSION_RESOURCE_PARAMS),r.executeWhenReady(function(){n=l.staticParticle(this._propulsionClass._thrusterBurnParticle.getModel(),this._propulsionClass._thrusterBurnParticle.getShader(),this._propulsionClass._thrusterBurnParticle.getTexturesOfTypes(this._propulsionClass._thrusterBurnParticle.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._propulsionClass._thrusterBurnParticle._color,this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass._thrusterBurnParticle.getInstancedShader()),n.setRelativeSize(0),t.addSubnode(new c.RenderableNode(n,!1,!1,!0)),ut&&!1!==s&&this._slot.lightFactor>0&&(this._lightSource=new h.PointLightSource(this._propulsionClass._thrusterBurnParticle._color,0,this._slot.positionVector,[t._renderableObject]),t._scene.addPointLightSource(this._lightSource,m.THRUSTER_LIGHT_PRIORITY)),this.vMo&&!e||(this.vMo&&this.vMo.markAsReusable(!0),this.vMo=n,this._shipModel=t._renderableObject)}.bind(this))},b.prototype.updateVisuals=function(){this.vMo.setRelativeSize(this._burnLevel),u.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(lt,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel)),this._lightSource&&(this._lightSource._objectIntensity=.35*this._burnLevel*this._slot.size*this._slot.size*this._slot.lightFactor)},b.prototype.resetBurn=function(){this._burnLevel=0},b.prototype.addBurn=function(t){this._burnLevel+=t},b.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null,this._shipModel=null,this._lightSource=null},x.prototype.acquireResources=function(t){this._class.acquireResources(t)},x.prototype.getDisplayName=function(){return this._class.getDisplayName()},x.prototype.getThrust=function(){return this._class.getThrust()},x.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},x.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},x.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},x.prototype.getThrusterUse=function(t){switch(t){case $.FORWARD:return this._forward;case $.REVERSE:return this._reverse;case $.STRAFE_LEFT:return this._strafeLeft;case $.STRAFE_RIGHT:return this._strafeRight;case $.RAISE:return this._raise;case $.LOWER:return this._lower;case $.YAW_LEFT:return this._yawLeft;case $.YAW_RIGHT:return this._yawRight;case $.PITCH_UP:return this._pitchUp;case $.PITCH_DOWN:return this._pitchDown;case $.ROLL_LEFT:return this._rollLeft;case $.ROLL_RIGHT:return this._rollRight;default:return s.showError("Invalid thruster use specified: '"+t+"'!",s.ErrorSeverity.SEVERE),null}},x.prototype.addThrusters=function(t){var e,i,s,n;for(e=0;e<t.length;e++)for(s=new b(this._class,t[e]),this._thrusters.push(s),i=0;i<t[e].uses.length;i++)(n=this.getThrusterUse(t[e].uses[i]))&&n.thrusters.push(s)},x.prototype.addToScene=function(t,e){var i;for(i=0;i<this._thrusters.length;i++)this._thrusters[i].addToScene(t,!1,e)},x.prototype.addThrusterBurn=function(t,e){y(this.getThrusterUse(t),e)},x.prototype.addThrusterBurnForward=function(t){y(this._forward,t)},x.prototype.addThrusterBurnReverse=function(t){y(this._reverse,t)},x.prototype.addThrusterBurnLeft=function(t){y(this._strafeLeft,t)},x.prototype.addThrusterBurnRight=function(t){y(this._strafeRight,t)},x.prototype.addThrusterBurnUp=function(t){y(this._raise,t)},x.prototype.addThrusterBurnDown=function(t){y(this._lower,t)},x.prototype.addThrusterBurnYawLeft=function(t){y(this._yawLeft,t)},x.prototype.addThrusterBurnYawRight=function(t){y(this._yawRight,t)},x.prototype.addThrusterBurnPitchUp=function(t){y(this._pitchUp,t)},x.prototype.addThrusterBurnPitchDown=function(t){y(this._pitchDown,t)},x.prototype.addThrusterBurnRollLeft=function(t){y(this._rollLeft,t)},x.prototype.addThrusterBurnRollRight=function(t){y(this._rollRight,t)},x.prototype.resetThrusterBurn=function(){var t;for(this._forward.burn=0,this._reverse.burn=0,this._strafeLeft.burn=0,this._strafeRight.burn=0,this._raise.burn=0,this._lower.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,this._rollLeft.burn=0,this._rollRight.burn=0,t=0;t<this._thrusters.length;t++)this._thrusters[t].resetBurn()},x.prototype.updateVisuals=function(){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].updateVisuals()},x.prototype._getSoundVolume=function(){var t,e,i;return i=this._class.getMaxMoveBurnLevel(),t=i?Math.max(this._forward.burn,this._reverse.burn,this._strafeRight.burn,this._strafeLeft.burn,this._raise.burn,this._lower.burn)/i:0,i=this._class.getMaxTurnBurnLevel(),e=i?Math.max(this._yawRight.burn,this._yawLeft.burn,this._pitchUp.burn,this._pitchDown.burn,this._rollRight.burn,this._rollLeft.burn)/i:0,i=Math.round(3*(t+e))/3},x.prototype.simulate=function(t,i,s){var n,o,r;!1!==s&&(n=e.getRowB43Aux(this._drivenPhysicalObject.oM),o=e.getRowC43Aux(this._drivenPhysicalObject.oM),r=e.getRowA43Aux(this._drivenPhysicalObject.oM),this._forward.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._forward.burn,n[0],n[1],n[2],t):this._reverse.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._reverse.burn,n[0],n[1],n[2],t),this._strafeRight.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._strafeRight.burn,r[0],r[1],r[2],t):this._strafeLeft.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._strafeLeft.burn,r[0],r[1],r[2],t),this._raise.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._raise.burn,o[0],o[1],o[2],t):this._lower.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._lower.burn,o[0],o[1],o[2],t),this._yawRight.burn>0?this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._yawRight.burn,o,t):this._yawLeft.burn>0&&this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._yawLeft.burn,o,t),this._pitchUp.burn>0?this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._pitchUp.burn,r,t):this._pitchDown.burn>0&&this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._pitchDown.burn,r,t),this._rollRight.burn>0?this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._rollRight.burn,n,t):this._rollLeft.burn>0&&this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._rollLeft.burn,n,t)),this._thrusterSoundClip||(this._thrusterSoundClip=this._class.createThrusterSoundClip(i),this._thrusterSoundClip&&(this._thrusterSoundClip.setVolume(0),this._thrusterSoundClip.play())),this._thrusterSoundClip&&this._thrusterSoundClip.rampVolume(this._getSoundVolume()*this._class.getThrusterSoundVolume(),.02,!0,!0)},x.prototype.getScoreValue=function(){return this._class.getScoreValue()},x.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusters=null,this._forward=null,this._reverse=null,this._strafeLeft=null,this._strafeRight=null,this._raise=null,this._lower=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this._rollLeft=null,this._rollRight=null,this._thrusterSoundClip&&(this._thrusterSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),setTimeout(function(){this._thrusterSoundClip.destroy(),this._thrusterSoundClip=null}.bind(this),_.SOUND_RAMP_DURATION))},D.prototype.prepareForControl=function(){this._speedThrottled=!1},D.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._sc.getMaxAcceleration()||0},D.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},D.prototype.updateTurningLimit=function(){this._turningLimit=.2*this._sc.getMaxAngularAcceleration()*o.ANGULAR_VELOCITY_MATRIX_DURATION_S},D.prototype.updateForNewPropulsion=function(){var t=this._sc.getMaxAcceleration();this.updateSpeedIncrementPerSecond(),this._maxCombatForwardSpeed=V*t,this._maxCombatReverseSpeed=F*-t,this._maxCruiseForwardSpeed=U*t,this._maxCruiseReverseSpeed=B*-t,this.updateTurningLimit(),this._maxMoveBurnLevel=this._sc.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._sc.getMaxThrusterTurnBurnLevel()},D.prototype.getRestrictedTurningLimit=function(t){return Math.min(this._turningLimit,this._sc.getMaxTurnRateAtSpeed(void 0===t?this._sc.getRelativeVelocityMatrix()[13]:t)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S)},D.prototype.setLocked=function(t){this._locked=t,this._locked&&(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0)},D.prototype.getFlightMode=function(){return this._assisted?this._restricted?Z.CRUISE:Z.COMBAT:Z.FREE},D.prototype.changeFlightMode=function(t){if(this._locked)return!1;switch(t||(t=this._assisted?this._restricted?Z.FREE:Z.CRUISE:Z.COMBAT),t){case Z.COMBAT:this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCombatForwardSpeed),this._assisted=!0,this._restricted=!1;break;case Z.CRUISE:this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCruiseForwardSpeed),this._assisted=!0,this._restricted=!0;break;case Z.FREE:this._assisted=!1,this._restricted=!1;break;default:return s.showError("Cannot switch to unknown flight mode: '"+t+"'!"),!1}return!0},D.prototype.toggleFlightAssist=function(){return this.changeFlightMode(this._assisted?Z.FREE:Z.COMBAT)},D.prototype.toggleCruise=function(){return this.changeFlightMode(this._restricted?Z.COMBAT:Z.CRUISE)},D.prototype.forward=function(t){var e;this._locked||(this._assisted?(e=this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed,this._speedThrottled=void 0!==t,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.min(Math.max(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)+this._speedIncrement,e):(t||1)*e):this._speedTarget=Number.MAX_VALUE)},D.prototype.stopForward=function(){var t;this._locked||(this._assisted?this._holdSpeed||this._speedTarget>0&&(this._speedTarget=0):(t=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget>t&&(this._speedTarget=t)))},D.prototype.reverse=function(t){var e;this._locked||(this._assisted?(e=this._restricted?this._maxCruiseReverseSpeed:this._maxCombatReverseSpeed,this._speedThrottled=void 0!==t,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.max(Math.min(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)-this._speedIncrement,e):(t||1)*e):this._speedTarget=-Number.MAX_VALUE)},D.prototype.stopReverse=function(){var t;this._locked||(this._assisted?this._holdSpeed||this._speedTarget<0&&(this._speedTarget=0):(t=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t)))},D.prototype.strafeLeft=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},D.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},D.prototype.strafeRight=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},D.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},D.prototype.lower=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},D.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},D.prototype.raise=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},D.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},D.prototype.toggleSpeedHolding=function(){return!(this._locked||!this._assisted)&&(this._holdSpeed=!this._holdSpeed,this._holdSpeed&&(this._speedTarget=this._sc.getRelativeVelocityMatrix()[13],this._restricted?this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._speedTarget),this._maxCruiseForwardSpeed):this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._speedTarget),this._maxCombatForwardSpeed)),!0)},D.prototype.setSpeedHolding=function(t){this._holdSpeed=t},D.prototype.resetSpeed=function(){this._locked||this._assisted&&this._holdSpeed&&(this._speedTarget=0)},D.prototype.setSpeedTarget=function(t){this._locked||this._assisted&&(this._speedTarget=t)},D.prototype.getSpeedTarget=function(){return this._speedTarget},D.prototype.hasSpeedTarget=function(){return this._assisted&&(this._holdSpeed||this._speedThrottled)},D.prototype.getMaxSpeed=function(){return this._assisted?this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed:void 0},D.prototype.yawLeft=function(t){this._locked||(void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget<0&&(this._yawTarget=0))},D.prototype.yawRight=function(t){this._locked||(void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget>0&&(this._yawTarget=0))},D.prototype.pitchDown=function(t){this._locked||(void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0))},D.prototype.pitchUp=function(t){this._locked||(void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0))},D.prototype.rollLeft=function(t){this._locked||(void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-t*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0))},D.prototype.rollRight=function(t){this._locked||(void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=t*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0))},D.prototype.controlThrusters=function(t,i){var s,n,r,a,l=this._sc.getRelativeVelocityMatrix(),h=l[13],c=o.VELOCITY_MATRIX_ERROR_THRESHOLD,u=this._sc.getTurningMatrix(),_=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,p=this._yawTarget,d=this._pitchTarget,g=this._sc._propulsion;g.resetThrusterBurn(),this._restricted&&0!==h&&(s=this.getRestrictedTurningLimit(h),p=Math.min(Math.max(p,-s),s),d=Math.min(Math.max(d,-s),s)),n=Math.sign(u[4])*e.angle2y(u[4],u[5]),p-n>_?g.addThrusterBurnYawRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(p-n,t))):p-n<-_&&g.addThrusterBurnYawLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(n-p,t))),r=Math.sign(u[6])*e.angle2x(u[5],u[6]),d-r>_?g.addThrusterBurnPitchUp(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(d-r,t))):d-r<-_&&g.addThrusterBurnPitchDown(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(r-d,t))),a=Math.sign(-u[2])*e.angle2x(u[0],u[2]),this._rollTarget-a>_?g.addThrusterBurnRollRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(this._rollTarget-a,t))):this._rollTarget-a<-_&&g.addThrusterBurnRollLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(a-this._rollTarget,t))),this._speedTarget-h>c?g.addThrusterBurnForward(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._speedTarget-h,t))):this._speedTarget-h<-c&&g.addThrusterBurnReverse(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(h-this._speedTarget,t))),(this._assisted||0!==this._strafeTarget)&&(h=l[12],this._strafeTarget-h>c?g.addThrusterBurnRight(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._strafeTarget-h,t))):this._strafeTarget-h<-c&&g.addThrusterBurnLeft(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(h-this._strafeTarget,t)))),(this._assisted||0!==this._liftTarget)&&(h=l[14],this._liftTarget-h>c?g.addThrusterBurnUp(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._liftTarget-h,t))):this._liftTarget-h<-c&&g.addThrusterBurnDown(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(h-this._liftTarget,t)))),g.updateVisuals(),this._lastYawTarget=this._yawTarget,this._lastPitchTarget=this._pitchTarget,this._lastRollTarget=this._rollTarget,this._lastStrafeTarget=this._strafeTarget,this._lastLiftTarget=this._liftTarget,i||(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0)},D.prototype.destroy=function(){this._sc=null},w.VELOCITY_TOLERANCE=1,w.JumpState={NONE:0,ALIGNING_VELOCITY:1,PREPARING:2,JUMPING_OUT:3,JUMPING_IN:4},Object.freeze(w.JumpOutState),w.prototype.acquireResources=function(t){this._class.acquireResources(t)},w.prototype.jumpOut=function(t){var e;switch(this._state){case w.JumpState.NONE:return this._state=w.JumpState.ALIGNING_VELOCITY,this._originalFlightMode=this._sc.getFlightMode(),this._sc.changeFlightMode(Z.CRUISE),this._sc.setSpeedTarget(this._class._prepareVelocity),this._sc.lockManeuvering(),this._sc._isJumping=!0,this._sc.handleEvent(d.JUMP_ENGAGED)&&(this._soundClip=this._class.createEngageSoundClip(),this._soundClip&&this._soundClip.play()),!0;case w.JumpState.ALIGNING_VELOCITY:case w.JumpState.PREPARING:if(t)return e=this._state===w.JumpState.PREPARING,this._state=w.JumpState.NONE,this._sc.unlockManeuvering(),this._sc.changeFlightMode(this._originalFlightMode),this._sc._isJumping=!1,this._soundClip&&(this._soundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._soundClip=null),this._sc.handleEvent(d.JUMP_CANCELLED)&&(this._soundClip=this._class.createDisengageSoundClip(),this._soundClip&&this._soundClip.play()),e&&(this._soundClip=this._class.createCancelSoundClip(),this._soundClip&&this._soundClip.play()),!0}return!1},w.prototype.jumpIn=function(){var t,s,n;this._state===w.JumpState.NONE&&(this._state=w.JumpState.JUMPING_IN,this._timeLeft=this._class._jumpInDuration,this._sc.unlockManeuvering(),this._sc.setSpeedTarget(0),this._sc.lockManeuvering(),this._sc._isJumping=!0,t=f.getExplosion(),t.init(this._class._jumpInExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,e.getRowC43Aux(this._sc.pMo.pM),!0,!0,i.IDENTITY4),t.addToSceneNow(this._sc.vMo._node._scene._rootNode,this._sc._soundSource),this._originalScalingMatrix=i.copy(this._sc.vMo.sM),s=this._sc.pMo,s.setVelocityv(e.getRowB43ScaledAux(s.oM,this._class._jumpInVelocity+this._class._jumpInDeceleration*this._class._jumpInDuration*.001)),s._dragFactor=0,this._sc.vMo.setPositionM4(s.pM),n=this._sc.getPositionMatrixInCameraSpace(),this._sc._soundSource.setPositionImmediate(.1*Math.round(10*n[12]),.1*Math.round(10*n[13]),.1*Math.round(10*n[14])),this._soundClip=this._class.createJumpInSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._sc.setAway(!1),this._sc.handleEvent(d.JUMPED_IN))},w.prototype.simulate=function(t){var s,n,o,r;switch(this._state){case w.JumpState.ALIGNING_VELOCITY:s=this._sc.getRelativeVelocityMatrix(),r=this._sc.getTopSpeed()?Math.min(this._sc.getTopSpeed(),this._class._prepareVelocity):this._class._prepareVelocity,Math.abs(s[12])<w.VELOCITY_TOLERANCE&&Math.abs(s[14])<w.VELOCITY_TOLERANCE&&Math.abs(s[13]-r)<w.VELOCITY_TOLERANCE&&(this._state=w.JumpState.PREPARING,this._timeLeft=this._class._prepareDuration,this._soundClip=this._class.createPrepareSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play());break;case w.JumpState.PREPARING:this._sc.handleEvent(d.PREPARING_JUMP,{duration:this._class._prepareDuration,timeLeft:this._timeLeft}),this._timeLeft<=0&&(this._state=w.JumpState.JUMPING_OUT,this._timeLeft=this._class._jumpOutDuration,this._soundClip=this._class.createJumpOutSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._sc.pMo._dragFactor=0,this._sc.unlockManeuvering(),this._sc.setSpeedTarget(Number.MAX_VALUE),this._sc.lockManeuvering(),this._originalScalingMatrix=i.copy(this._sc.vMo.sM),this._sc.handleEvent(d.JUMP_OUT_STARTED)),this._timeLeft-=t;break;case w.JumpState.JUMPING_OUT:this._sc.vMo.setScaling(this._originalScalingMatrix[0],this._originalScalingMatrix[5]*(1+(1-this._timeLeft/this._class._jumpOutDuration)*(this._class._jumpOutScaling-1)),this._originalScalingMatrix[10]),this._timeLeft<=0?(this._state=w.JumpState.NONE,n=f.getExplosion(),n.init(this._class._jumpOutExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,e.getRowC43Aux(this._sc.pMo.pM),!0,!0,i.IDENTITY4),n.addToSceneNow(this._sc.vMo._node._scene._rootNode,this._sc._soundSource),this._sc.vMo.setScale(this._originalScalingMatrix[0]),this._sc.setAway(!0),this._sc.handleEvent(d.JUMPED_OUT)):(o=this._sc.pMo,s=o.oM,o.applyForce(o._mass*this._class._jumpOutAcceleration,s[4],s[5],s[6],Math.min(t,this._timeLeft))),this._timeLeft-=t;break;case w.JumpState.JUMPING_IN:this._timeLeft<0?this._timeLeft=0:(o=this._sc.pMo,s=o.oM,o.applyForce(o._mass*this._class._jumpInDeceleration,-s[4],-s[5],-s[6],Math.min(t,this._timeLeft))),this._sc.vMo.setScaling(this._originalScalingMatrix[0],this._originalScalingMatrix[5]*(1+this._timeLeft/this._class._jumpInDuration*(this._class._jumpInScaling-1)),this._originalScalingMatrix[10]),this._timeLeft<=0&&(this._state=w.JumpState.NONE,this._sc.unlockManeuvering(),this._sc._isJumping=!1,this._sc.handleEvent(d.ARRIVED),this._sc.resetDrag()),this._timeLeft-=t}},w.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null),this._originalScalingMatrix=null},P.prototype.acquireResources=function(t){this._class.acquireResources(t)},P.prototype.getDisplayName=function(){return this._class.getDisplayName()},P.prototype.getIntegrity=function(){return this._capacity/this._class._capacity},P.prototype.setIntegrity=function(t){var e=t*this._class._capacity;e<this._capacity&&(this._timeSinceHit=0),this._capacity=e},P.prototype.getRechargeRate=function(){return this._class.getRechargeRate()},P.prototype.damage=function(t,e){var i=Math.min(this._capacity,t);return this._timeSinceHit=0,e||(this._capacity-=i),t-i},P.prototype.startRecharge=function(){this._soundClip=this._class.createRechargeStartSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._timeSinceRecharge=0},P.prototype.simulate=function(t,e){var i=this._class._rechargeAnimationDuration;this._capacity<this._class._capacity&&(this._timeSinceHit<this._class.getRechargeDelay()?(this._timeSinceHit+=t,this._timeSinceHit>=this._class.getRechargeDelay()&&this.startRecharge()):e||(this._capacity=Math.min(this._class._capacity,this._capacity+this._class.getRechargeRate()*t*.001))),this._timeSinceRecharge=Math.min(i,this._timeSinceRecharge+t),this._state[3]=this._timeSinceRecharge/i},P.prototype.getScoreValue=function(){return this._class.getScoreValue()},P.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null)},j=a.getPool(m.PARTICLE_POOL_NAME,l.Particle),W=a.getPool(m.PROJECTILE_POOL_NAME,A),Y=a.getPool(m.MISSILE_POOL_NAME,N),X=a.getPool(m.TRAIL_POOL_NAME,l.Trail),z=a.getPool(m.TRAIL_SEGMENT_POOL_NAME,l.TrailSegment),g.executeWhenReady(function(){nt=!0,V=2,F=1,U=4,B=2,H=!1,lt="luminosityFactors",ht=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),G=.05,k=.5,u.executeWhenReady(S),u.onSettingsChange(S)}),{FlightMode:Z,ThrusterUse:$,handleDifficultySet:T,setFriendlyFire:E,Projectile:A,Missile:N,Weapon:O,MissileLauncher:L,TargetingComputer:R,Propulsion:x,JumpEngine:w,Shield:P,ManeuveringComputer:D}}),define("armada/control",["utils/utils","utils/types","modules/application","modules/control/control","modules/control/keyboard","modules/control/mouse","modules/control/gamepad","modules/control/touch","modules/camera-controller","modules/game","modules/media-resources","armada/screens/shared","armada/strings","armada/configuration","armada/logic/equipment"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d){"use strict";function g(t){s.Controller.call(this,t),this._mission=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),h.setScreen(u.INGAME_MENU_SCREEN_NAME,!0,u.SUPERIMPOSE_BACKGROUND_COLOR),s.exitPointerLock()}.bind(this)),this.setActionFunction("pause",!0,function(){h.getScreen().showMessage(_.get(_.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("toggleDevInfoVisibility",!0,function(){h.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){v.getInputInterpreter(L).toggleEnabled(),v.isInPilotMode()&&(v.getInputInterpreter(L).isEnabled()?(document.body.style.cursor="none",v.enableMouseTurning()):(document.body.style.cursor=h.getDefaultCursor(),s.exitPointerLock()))}),this.setActionFunction("toggleJoystickControls",!0,function(){v.getInputInterpreter(R).toggleEnabled()})}function m(t){s.Controller.call(this,t),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._wAimThreshold=t.weaponAimThreshold,this.setActionFunction("fire",!0,function(t,e){this._controlledSpacecraft.requestFire(!1,t),e===N&&v.enableMouseTurning()}.bind(this)),this.setActionFunction("launchMissile",!0,function(t,e){this._controlledSpacecraft.launchMissile(t)||C&&C.play(),e===N&&v.enableMouseTurning()}.bind(this)),this.setActionFunction("changeMissile",!0,function(t){this._controlledSpacecraft.changeMissile(t)?I&&I.play():C&&C.play()}.bind(this)),this.setActionFunction("toggleSalvo",!0,function(t){this._controlledSpacecraft.toggleSalvo(t)?A&&A.play():C&&C.play()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()&&M&&M.play()}.bind(this)),this.setActionFunction("toggleCruise",!0,function(){this._controlledSpacecraft.toggleCruise()&&M&&M.play()}.bind(this)),this.setActionFunction("toggleFlightAssist",!0,function(){this._controlledSpacecraft.toggleFlightAssist()&&M&&M.play()}.bind(this)),this.setActionFunction("nextNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestHostile()?E.play():y.play()}.bind(this)),this.setActionFunction("previousNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetPreviousNearestHostile()?E.play():y.play()}.bind(this)),this.setActionFunction("nextNearestNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestNonHostile()?E.play():y.play()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){(void 0===t||t>=V)&&this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&M&&M.play(),this._controlledSpacecraft.strafeLeft((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){(void 0===t||t>=V)&&this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&M&&M.play(),this._controlledSpacecraft.strafeRight((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){(void 0===t||t>=V)&&this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&M&&M.play(),this._controlledSpacecraft.raise((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){(void 0===t||t>=V)&&this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&M&&M.play(),this._controlledSpacecraft.lower((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),
this.setActionFunction("toggleSpeedHolding",!0,function(){this._controlledSpacecraft.toggleSpeedHolding()&&M&&M.play()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t,e){this._controlledSpacecraft.yawLeft(t),e!==N&&v.disableMouseTurning()}.bind(this)),this.setActionFunction("yawRight",!0,function(t,e){this._controlledSpacecraft.yawRight(t),e!==N&&v.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchUp",!0,function(t,e){this._controlledSpacecraft.pitchUp(t),e!==N&&v.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchDown",!0,function(t,e){this._controlledSpacecraft.pitchDown(t),e!==N&&v.disableMouseTurning()}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this)),this.setActionFunction("jumpOut",!0,function(){this._controlledSpacecraft.jumpOut(!0)}.bind(this)),this.setActionFunction("toggleSpotlights",!0,function(){this._controlledSpacecraft.toggleSpotLights()}.bind(this))}function f(t){return c.getSoundEffect(p.gHS(t).name).createSoundClip(c.SoundCategory.SOUND_EFFECT,p.gHS(t).volume)}function S(){s.ControlContext.call(this),this._pilotingMode=!1,this._mouseTurningDisabled=!1,this._pointerLockEnabled=!1,this.registerInputInterpreterType(O,n.KeyboardInputInterpreter),this.registerInputInterpreterType(L,o.MouseInputInterpreter),this.registerInputInterpreterType(R,r.GamepadInputInterpreter),t.areTouchEventsSupported()&&this.registerInputInterpreterType(x,a.TouchInputInterpreter),this.registerControllerType(D,g),this.registerControllerType(w,m),this.registerControllerType(P,l.CameraController)}var T,E,y,M,I,C,A,v,N,O="keyboard",L="mouse",R="joystick",b=R,x="touch",D="general",w="fighter",P="camera",V=.1,F=function(){I&&I.play()};return n.setModulePrefix("armada_control_"),o.setModulePrefix("armada_control_"),r.setModulePrefix("armada_control_"),a.setModulePrefix("armada_control_"),g.prototype=new s.Controller,g.prototype.constructor=g,g.prototype.getType=function(){return"general"},g.prototype.setMission=function(t){this._mission=t},g.prototype.setBattle=function(t){this._battle=t},m.prototype=new s.Controller,m.prototype.constructor=m,m.prototype.getType=function(){return"fighter"},m.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t,this._controlledSpacecraft&&(this._strafeSpeed=T*this._controlledSpacecraft.getMaxAcceleration())},m.prototype.executeActions=function(t,e){this._controlledSpacecraft&&(this._controlledSpacecraft._alive?(this._controlledSpacecraft.prepareForControl(),s.Controller.prototype.executeActions.call(this,t),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextBestHostile()&&E.play(),this._controlledSpacecraft.aimWeapons(this._wAimThreshold,0,e)):this._controlledSpacecraft=null)},S.prototype=new s.ControlContext,S.prototype.constructor=S,S.prototype.loadSettingsFromJSON=function(t,e){s.ControlContext.prototype.loadSettingsFromJSON.call(this,t,e),s.isPointerLockSupported()&&(this._pointerLockEnabled=t.pointerLockEnabled),e&&localStorage.removeItem("armada_control_pointerLockEnabled")},S.prototype.loadSettingsFromLocalStorage=function(){s.isPointerLockSupported()&&void 0!==localStorage.armada_control_pointerLockEnabled&&(this._pointerLockEnabled=e.getBooleanValueFromLocalStorage("armada_control_pointerLockEnabled",{defaultValue:this._pointerLockEnabled})),s.ControlContext.prototype.loadSettingsFromLocalStorage.call(this)},S.prototype.isInPilotMode=function(){return this._pilotingMode},S.prototype.switchToPilotMode=function(t,e){t&&t._alive&&!this._pilotingMode&&(this._pilotingMode=!0,E=f(p.BS.HUD.TARGET_SWITCH_SOUND),y=f(p.BS.HUD.TARGET_SWITCH_DENIED_SOUND),M=f(p.BS.HUD.FLIGHT_MODE_SWITCH_SOUND),I=f(p.BS.HUD.MISSILE_CHANGE_SOUND),C=f(p.BS.HUD.MISSILE_CHANGE_DENIED_SOUND),A=f(p.BS.HUD.MISSILE_SALVO_SOUND),this.getController(w).setControlledSpacecraft(t),this.getController(P).setCameraToFollowObject(t.vMo,e?0:800,"smooth",p.getDefaultCameraConfigurationName(t)),this.disableAction("followNext"),this.disableAction("followPrevious"),h.getScreen(u.BATTLE_SCREEN_NAME).setHeaderContent(""),this.getInputInterpreter(L).isEnabled()&&(document.body.style.cursor="none"))},S.prototype.switchToSpectatorMode=function(t,e){(this._pilotingMode||e)&&(this._pilotingMode=!1,this.getController(w).setControlledSpacecraft(null),t&&this.getController(P).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),h.getScreen(u.BATTLE_SCREEN_NAME).setHeaderContent(_.get(_.BATTLE.SPECTATOR_MODE)),document.body.style.cursor=h.getDefaultCursor())},S.prototype.disableMouseTurning=function(){this._mouseTurningDisabled||(N.disableAction("yawLeft"),N.disableAction("yawRight"),N.disableAction("pitchUp"),N.disableAction("pitchDown"),N.disableAction("rollLeft"),N.disableAction("rollRight"),this._mouseTurningDisabled=!0)},S.prototype.enableMouseTurning=function(){this._mouseTurningDisabled&&(N.enableAction("yawLeft"),N.enableAction("yawRight"),N.enableAction("pitchUp"),N.enableAction("pitchDown"),N.enableAction("rollLeft"),N.enableAction("rollRight"),this._mouseTurningDisabled=!1),s.isPointerLocked()||h.getScreen()!==h.getScreen(u.BATTLE_SCREEN_NAME)||h.getScreen().requestPointerLock(!1)},S.prototype.isMouseTurningDisabled=function(){return this._mouseTurningDisabled},S.prototype.isPointerLockEnabled=function(){return this._pointerLockEnabled},S.prototype.setPointerLockEnabled=function(t,e){s.isPointerLockSupported()&&(void 0===e&&(e=!0),this._pointerLockEnabled=t,e&&(localStorage.armada_control_pointerLockEnabled=t.toString()))},v=new S,v.executeWhenReady(function(){N=v.getInputInterpreter(L)}),p.executeWhenReady(function(){T=1}),{KEYBOARD_NAME:O,MOUSE_NAME:L,JOYSTICK_NAME:R,GAMEPAD_NAME:b,GENERAL_CONTROLLER_NAME:D,FIGHTER_CONTROLLER_NAME:w,CAMERA_CONTROLLER_NAME:P,loadConfigurationFromJSON:v.loadConfigurationFromJSON.bind(v),loadSettingsFromJSON:v.loadSettingsFromJSON.bind(v),loadSettingsFromLocalStorage:v.loadSettingsFromLocalStorage.bind(v),restoreDefaults:v.restoreDefaults.bind(v),getControllers:v.getControllers.bind(v),getController:v.getController.bind(v),isControllerPriority:v.isControllerPriority.bind(v),getInputInterpreters:v.getInputInterpreters.bind(v),getInputInterpreter:v.getInputInterpreter.bind(v),control:v.control.bind(v),startListening:v.startListening.bind(v),stopListening:v.stopListening.bind(v),isListening:v.isListening.bind(v),setScreenCenter:v.setScreenCenter.bind(v),executeWhenReady:v.executeWhenReady.bind(v),isInPilotMode:v.isInPilotMode.bind(v),switchToPilotMode:v.switchToPilotMode.bind(v),switchToSpectatorMode:v.switchToSpectatorMode.bind(v),isMouseTurningDisabled:v.isMouseTurningDisabled.bind(v),isPointerLockSupported:s.isPointerLockSupported,isPointerLockEnabled:v.isPointerLockEnabled.bind(v),setPointerLockEnabled:v.setPointerLockEnabled.bind(v),exitPointerLock:s.exitPointerLock,playMissileChangeSound:F}}),define("armada/logic/formations",["utils/vectors","modules/application","armada/configuration"],function(t,e,i){"use strict";function s(){o=Math.seed(4718)}function n(i,s,n,a){var l,h,c;switch(i.type){case r.WEDGE:h=Math.ceil(s/2),l=[(s%2==1?1:-1)*h*i.spacing[0],h*i.spacing[1],h*i.spacing[2]];break;case r.LINE:l=[s*i.spacing[0],s*i.spacing[1],s*i.spacing[2]];break;case r.DIAMOND:c=s%3,h=2*Math.floor(s/3)+(c>0?1:0),l=[(0===c?0:1===c?1:-1)*i.spacing[0],h*i.spacing[1],h*i.spacing[2]];break;case r.RANDOM:l=[o()*i.spacing[0]-i.spacing[0]/2,o()*i.spacing[1]-i.spacing[1]/2,o()*i.spacing[2]-i.spacing[2]/2];break;default:return e.showError("Unknown formation type specified: '"+i.type+"!"),[0,0,0]}return a&&t.mulVec3Mat4(l,a),n&&t.add3(l,n),l}var o,r={WEDGE:"wedge",LINE:"line",DIAMOND:"diamond",RANDOM:"random"};return i.executeWhenReady(function(){s()}),{FormationType:r,resetRandomSeed:s,getPositionInFormation:n}}),define("armada/networking",["modules/application","armada/logic/constants","armada/logic/formations"],function(t,e,i){"use strict";function s(t,e,i){Ft[t]=i?[]:Ft[t]||[],Ft[t].push(e)}function n(t,e,i){var n=JSON.stringify(t);Dt?(e&&s(t.type,e,i),xt.send(n)):Vt.push([t,e,i])}function o(t){return t.name===Ut}function r(t){return!0===t.peer}function a(t){return!0!==t.left}function l(){return Gt?Gt.players.find(o):null}function h(){return Gt?Gt.players.findIndex(o):-1}function c(t){return Gt?Gt.players.find(function(e){return e.name===t}):null}function u(){var t,e=[];if(Gt)for(t=0;t<Gt.players.length;t++)o(Gt.players[t])||e.push(t);return e}function _(){-1!==Ge&&(clearInterval(Ge),Ge=-1)}function p(){-1===Ge&&(Ge=setInterval(function(){Dt?xt.send(JSON.stringify({type:Ne})):_()},ce))}function d(t){var e=new Float32Array(t.data);0===e.length?(xt.binaryType="blob",xt.onmessage=ae):ie&&ie(e)}function g(t){var e,i;if(Gt)for(e=0;e<t.players.length;e++)(i=c(t.players[e].name))&&Object.assign(i.stats,t.players[e].stats)}function m(t){r(t)&&(t.messageChannel&&("open"===t.messageChannel.readyState&&t.messageChannel.close(),t.messageChannel=null),t.updateChannel&&("open"===t.updateChannel.readyState&&t.updateChannel.close(),t.updateChannel=null),t.connection&&(t.connection.close(),t.connection=null))}function f(){Gt&&Gt.players.forEach(function(t){o(t)||m(t)}),Gt=null,Bt=!1,kt=!1,Xt=null,zt=null,qt=null,Jt=null,Qt=null,Kt=null,Zt=null,$t=null,te=null,ee=null,ie=null,se=null,ne=null,_()}function S(t){g(t),se&&se(),f(),n({type:be})}function T(){Gt&&(n({type:Ee}),f())}function E(t){var e;t.playerName===Ut?(ne&&ne(),T()):(e=c(t.playerName))&&!e.left&&(e.left=!0,m(e),zt&&zt(e))}function y(t,e){t.onopen=function(){e.peer=!0,Bt||(Ht=!0),Dt&&xt.send(JSON.stringify({type:Ae,playerName:e.name})),Qt&&Qt(e)},t.onclose=function(){e.peer=!1,Bt||(Ht=!1),Dt&&xt.send(JSON.stringify({type:ve,playerName:e.name})),Qt&&Qt(e)},t.onmessage=function(i){var s;switch(s=JSON.parse(i.data),s.type){case Se:t.send(JSON.stringify({type:Te}));break;case Te:e.ping=performance.now()-re,e.waitPong=!1,Qt&&Qt(e);break;case Re:g(s);break;case be:S(s);break;case xe:E(s)}}}function M(t){t.onopen=function(){},t.onclose=function(){},t.onmessage=d}function I(t,e){var i,s,o;o=new RTCPeerConnection({iceServers:[{urls:he}]}),t.connection=o,o.onicegatheringstatechange=function(){"complete"===o.iceGatheringState&&n(Bt?{type:ge,offer:o.localDescription,playerName:t.name}:{type:me,answer:o.localDescription})},o.ondatachannel=function(e){switch(e.channel.label){case"messageChannel":t.messageChannel=e.channel,y(t.messageChannel,t);break;case"updateChannel":t.updateChannel=e.channel,M(t.updateChannel)}},Bt?(i=o.createDataChannel("messageChannel"),t.messageChannel=i,y(i,t),s=o.createDataChannel("updateChannel"),t.updateChannel=s,M(s),o.createOffer().then(function(t){o.setLocalDescription(t)},function(){})):(o.setRemoteDescription(new RTCSessionDescription(e)),o.createAnswer(function(t){o.setLocalDescription(t)},function(){}))}function C(t,e){var i=[];Gt.players.forEach(function(e,s){0===s||e.left||(r(e)?e.messageChannel.send(JSON.stringify(t)):i.push(s))}),(i.length>0||e)&&(t.recipients=i,xt.send(JSON.stringify(t)))}function A(t,e){var i,s=[];for(r(Gt.players[0])?Gt.players[0].messageChannel.send(JSON.stringify(t)):s.push(0),i=1;i<Gt.players.length;i++)o(Gt.players[i])||s.push(i);(s.length>0||e)&&(t.recipients=s,xt.send(JSON.stringify(t)))}function v(t){var e=parseInt(le.split(".")[0],10),i=parseInt(t.split(".")[0],10);return!isNaN(i)&&!isNaN(e)&&e===i}function N(){wt=!1,Pt=!1,-1!==Nt&&(clearTimeout(Nt),Nt=-1),Vt.length=0,xt&&Dt&&(Gt&&f(),Dt=!1,xt.close())}function O(t,e){Ht?Gt.players[0].updateChannel.send(e):xt.send(e),je.set(e),ke=t}function L(t){Ot=t,xt=null,Dt=!1,Nt=-1,Pt=!1,Vt=[],Ft={},Gt=null,Bt=!1}function R(){return le}function b(){return xt&&Dt}function x(){wt=!0,xt||(Dt=!1,Pt=!1,xt=new WebSocket(Ot),xt.binaryType="blob",xt.onopen=function(){if(Dt=!0,!wt)return void N();-1!==Nt&&clearTimeout(Nt),Nt=setTimeout(function(){wt&&Dt&&!Pt&&(Yt&&Yt(De),N()),Nt=-1},ue)},xt.onclose=function(){Wt&&Wt(Dt),f(),Dt=!1,xt=null},xt.onmessage=ae)}function D(){return Lt}function w(){return Rt}function P(){return bt}function V(){return Ut}function F(t){Ut=t}function U(){return l().settings}function B(t){l().ready||(Object.assign(l().settings,t),n({type:Le,settings:t}))}function H(){return!!Gt}function G(){return Bt}function k(){return Gt?Gt.name:""}function j(){return Gt?Gt.mode:null}function W(){return Gt?Gt.settings:null}function Y(){return Gt?Gt.players[0].name:""}function X(t){oe||(oe=performance.now()),n({type:_e},t,!0)}function z(t,e){n({type:pe,playerName:Ut,gameName:t.gameName,gameMode:t.gameMode,settings:Object.assign({},Ue,t.settings),maxPlayers:t.maxPlayers},function(t){var i=t.game;i&&(Gt={host:i.host,name:i.name,mode:i.mode,players:[{name:Ut,ping:0,peer:!1,ready:!1,me:!0,settings:i.players[0].settings,stats:i.players[0].stats}],maxPlayers:i.maxPlayers,settings:i.settings,started:!1},Bt=!0,e())},!0)}function q(t){Bt&&(Object.assign(Gt.settings,t),n({type:Oe,settings:t}))}function J(t){jt=t}function Q(t){Wt=t}function K(t){Yt=t}function Z(t){Xt=t}function $(t){zt=t}function tt(t){qt=t}function et(t){Jt=t}function it(t){Qt=t}function st(t){Kt=t}function nt(t){Zt=t}function ot(t){$t=t}function rt(t){te=t}function at(t){ee=t}function lt(t){ie=t}function ht(t){se=t}function ct(t){ne=t}function ut(t,e){n({type:de,playerName:Ut,gameName:t.gameName},function(t){var i;for(Gt={name:t.gameName,mode:t.gameMode,players:t.players,settings:t.settings,started:!1},i=0;i<Gt.players.length;i++)Gt.players[i].me=o(Gt.players[i]);Bt=!1,e()},!0)}function _t(t){Bt&&n({type:ye,playerName:t})}function pt(){return Gt?Gt.players:[]}function dt(){return Gt?Gt.players.filter(a):[]}function gt(){var t;if(Gt&&!Gt.started)if(Bt){for(t=1;t<Gt.players.length;t++){if(Gt.players[t].waitPong)return;Gt.players[t].waitPong=!0}re=performance.now(),C(Be,!0)}else{for(t=0;t<Gt.players.length;t++)if(!o(Gt.players[t])){if(Gt.players[t].waitPong)return;Gt.players[t].waitPong=!0}re=performance.now(),A(Be,!0)}}function mt(t,e){n({type:fe,text:t,recipients:e||u()})}function ft(){var t=l();t.ready||(n({type:Me}),t.ready=!0,Qt&&Qt(t))}function St(){var t;if(!Gt||Gt.players.length<2)return!1;for(t=1;t<Gt.players.length;t++)if(!Gt.players[t].ready)return!1;return!0}function Tt(){Bt&&St()&&n({type:Ie})}function Et(){n({type:Ce})}function yt(t,e){var i,s,n=[];Bt&&(i=c(t),i&&(i.stats.kills++,n.push({name:t,stats:i.stats})),s=c(e),s&&(s.stats.deaths++,n.push({name:e,stats:s.stats})),n.length>0&&C({type:Re,players:n}))}function Mt(){Bt&&(C({type:be,players:Gt.players.map(function(t){return{name:t.name,stats:t.stats}})},!0),f())}function It(t){var e;Bt&&(e=c(t))&&!e.left&&(C({type:xe,playerName:t},!0),e.left=!0,m(e),zt&&zt(e))}function Ct(){var e,s,n,o,r=Gt.players.length,a=function(t){return t/r*Math.PI*2},l=h();switch(Gt.mode){case He.FFA:e=Gt.players.map(function(t,e){return{name:"Team "+(e+1),color:t.settings.color.concat(1)}}),s=Gt.players.map(function(t,e){var i=a(e);return{name:t.name,team:"Team "+(e+1),class:t.settings.spacecraft,piloted:e===l,multi:!(Bt&&0===e),multiPiloted:!0,position:[500*Math.sin(i),500*-Math.cos(i),0],rotations:["z-"+Math.round(Math.degrees(i))],loadout:Gt.settings.loadout}});break;case He.COOP:e=[{faction:"empire",color:Gt.players[0].settings.color.concat(1)},{faction:"pirates"}],o={type:i.FormationType.WEDGE,spacing:[40,-10,0]},s=Gt.players.map(function(t,e){return{name:t.name,squad:"alpha "+(e+1),team:"empire",class:t.settings.spacecraft,piloted:e===l,multi:!(Bt&&0===e),multiPiloted:!0,position:i.getPositionInFormation(o,e),loadout:Gt.settings.loadout}}),o={type:i.FormationType.WEDGE,spacing:[75,10,-10]},s.push({squad:"raider",team:"pirates",class:"wolf",loadout:"pirate-weak",ai:"fighter",multi:!Bt,position:[0,2500,0],rotations:[{axis:"Z",degrees:180}],count:Gt.settings.enemiesPerWave,formation:o}),s.push({squad:"marauder",team:"pirates",class:"wolf",loadout:"pirate-shielded",ai:"fighter",multi:!Bt,position:[0,3e3,0],rotations:[{axis:"Z",degrees:180}],formation:o,count:Gt.settings.enemiesPerWave,away:!0}),s.push({squad:"bandit",team:"pirates",class:"piranha",loadout:"pirate-shielded",ai:"fighter",multi:!Bt,position:[3e3,0,0],rotations:[{axis:"Z",degrees:270}],formation:o,count:Gt.settings.enemiesPerWave,away:!0}),s.push({squad:"brigand",team:"pirates",class:"stingray",loadout:"pirate-tier2",ai:"fighter",multi:!Bt,position:[-3e3,0,0],rotations:[{axis:"Z",degrees:90}],formation:o,count:Gt.settings.enemiesPerWave,away:!0}),n=[{trigger:{conditions:[{type:"destroyed",subjects:{squads:["raider"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["marauder"]},params:{command:"jump"}}]},{trigger:{conditions:[{type:"destroyed",subjects:{squads:["marauder"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["bandit"]},params:{command:"jump"}}]},{trigger:{conditions:[{type:"destroyed",subjects:{squads:["bandit"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["brigand"]},params:{command:"jump"}}]}];break;default:return t.showError("Cannot create game! Unsupported game mode: "+Gt.mode+"!"),null}return{title:Gt.name,environment:Gt.settings.environment,teams:e,spacecrafts:s,events:n}}function At(t){var e,i=new Float32Array(t.length*we),s=!1;for(e=0;e<t.length;e++)i.set(t[e].getMultiHostData(),e*we);for(e=1;e<Gt.players.length;e++)Gt.players[e].left||(r(Gt.players[e])?Gt.players[e].updateChannel.send(i):s=!0);s&&xt.send(i)}function vt(t){var e,i=performance.now(),s=t.getMultiGuestData();if(t._alive){if(i-ke>Ve)return void O(i,s);for(e=0;e<Pe;e++)if(s[e]!==je[e])return void O(i,s)}else if(i-ke>Fe)return void O(i,s)}var Nt,Ot,Lt,Rt,bt,xt,Dt,wt,Pt,Vt,Ft,Ut,Bt,Ht,Gt,kt,jt,Wt,Yt,Xt,zt,qt,Jt,Qt,Kt,Zt,$t,te,ee,ie,se,ne,oe,re,ae,le="2.0",he="stun:stun.l.google.com:19302",ce=15e3,ue=1e4,_e=0,pe=1,de=2,ge=3,me=4,fe=5,Se=6,Te=7,Ee=8,ye=10,Me=11,Ie=12,Ce=13,Ae=14,ve=15,Ne=16,Oe=17,Le=18,Re=19,be=20,xe=21,De=1001,we=e.MULTI_HOST_DATA_LENGTH,Pe=e.MULTI_GUEST_DATA_LENGTH,Ve=100,Fe=1e3,Ue={difficulty:"hard",friendlyFire:!1,environment:"blovell",loadout:"multi-tier1",enemiesPerWave:3},Be={type:Se},He={FFA:"ffa",COOP:"coop"},Ge=-1,ke=0,je=new Float32Array(Pe).fill(0);return ae=function(t){var e,i,n,o,a,l;if("string"==typeof t.data){if(o=JSON.parse(t.data),!Pt){if(!wt)return void N();if(22===o.type){if(Pt=!0,bt=o.apiVersion,v(o.apiVersion)){for(Rt=o.region,e=0;e<Vt.length;e++)a=Vt[e][0],Vt[e][1]&&s(a.type,Vt[e][1],Vt[e][2]),xt.send(JSON.stringify(a));Vt.length=0,jt&&jt()}else Yt&&Yt(1e3),N();return}if(9!==o.type)return}switch(o.type){case _e:Lt=performance.now()-oe,oe=0;break;case de:Gt&&(i={name:o.player.name,peer:!1,ready:!1,me:!1,settings:o.player.settings,stats:o.player.stats},Gt.players.push(i),Xt&&Xt(o.player.name),Bt&&I(i));break;case Ee:Gt&&(n=Gt.players.findIndex(function(t){return t.name===o.playerName}),0===n?(te&&te(),f()):n>0&&(i=Gt.players[n],m(i),Gt.started?Gt.players[n].left=!0:Gt.players.splice(n,1),zt&&zt(i)));break;case 9:Yt&&Yt(o.errorCode);break;case ge:Gt&&I(Gt.players[0],o.offer);break;case me:i=c(o.playerName),i&&i.connection.setRemoteDescription(new RTCSessionDescription(o.answer));break;case fe:$t&&$t(o);break;case Se:xt.send(JSON.stringify({type:Te,recipient:o.sender}));break;case Te:Gt&&(i=Gt.players[o.sender])&&(i.ping=performance.now()-re,i.waitPong=!1,Qt&&Qt(i));break;case ye:Gt&&(o.playerName===Ut?(Zt&&Zt(),f()):(n=Gt.players.findIndex(function(t){return t.name===o.playerName}),i=Gt.players[n],m(i),Gt.players.splice(n,1),Jt&&Jt(i),Qt&&Qt(i)));break;case Me:Gt&&(i=c(o.playerName))&&(i.ready=!0,qt&&qt(i),Qt&&Qt(i));break;case Ie:if(Gt){if(Gt.started){if(Bt){for(l=!1,e=1;e<Gt.players.length;e++)if(!r(Gt.players[e])){l=!0;break}}else l=!Ht;l?kt=!0:p()}else Gt.started=!0;ee&&ee()}break;case Oe:Gt&&!Gt.started&&(Object.assign(Gt.settings,o.settings),Kt&&Kt());break;case Le:Gt&&(i=c(o.playerName))&&(Object.assign(i.settings,o.settings),Qt&&Qt(i));break;case Re:g(o);break;case be:S(o);break;case xe:E(o)}if(Ft[o.type]){for(e=0;e<Ft[o.type].length;e++)Ft[o.type][e](o);Ft[o.type].length=0}kt&&(xt.binaryType="arraybuffer",xt.onmessage=d)}},{ERROR_CODE_GAME_NOT_FOUND:0,ERROR_CODE_GAME_IS_FULL:1,ERROR_CODE_GAME_ALREADY_STARTED:2,ERROR_CODE_PLAYER_NAME_ALREADY_EXISTS:3,ERROR_CODE_GAME_NAME_ALREADY_EXISTS:4,ERROR_CODE_INVALID_GAME_SETTINGS:5,ERROR_CODE_INVALID_PLAYER_NAME:6,ERROR_CODE_INVALID_TEXT:7,ERROR_CODE_SERVER_IS_FULL:8,ERROR_CODE_INCOMPATIBLE_API_VERSION:1e3,ERROR_CODE_NO_WELCOME:De,GameMode:He,init:L,getClientApiVersion:R,isConnected:b,connect:x,disconnect:N,getServerPing:D,getServerRegion:w,getServerApiVersion:P,getPlayerName:V,setPlayerName:F,getPlayerSettings:U,updatePlayerSettings:B,isInGame:H,isHost:G,getGameName:k,getGameMode:j,getGameSettings:W,getHostName:Y,listGames:X,createGame:z,updateGameSettings:q,joinGame:ut,onConnect:J,onDisconnect:Q,onError:K,onPlayerJoin:Z,onPlayerLeave:$,onPlayerReady:tt,onPlayerKicked:et,onPlayerUpdate:it,onGameSettingsChanged:st,onKicked:nt,onText:ot,onHostLeft:rt,onGameStart:at,leaveGame:T,kickPlayer:_t,getPlayers:pt,getActivePlayers:dt,ping:gt,sendText:mt,markReady:ft,allPlayersReady:St,startGame:Tt,markLoaded:Et,registerPlayerKill:yt,concludeMatch:Mt,guestTimeout:It,getMissionData:Ct,sendHostUpdate:At,sendGuestUpdate:vt,onGameUpdate:lt,onMatchConcluded:ht,onGuestTimeout:ct}}),define("armada/logic/spacecraft",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/physics","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/strings","armada/control","armada/networking","armada/logic/constants","armada/logic/SpacecraftEvents","armada/logic/equipment","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T,E,y){"use strict";function M(){P={},P[w]=n.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(P[D]=n.ShaderVariableType.FLOAT),V=u.areDynamicLightsAvailable()&&u.getMaxPointLights()>0}function I(t){F=t}function C(t){var e,i;return(e=t.lastIndexOf(" "))<0?t:(i=t.substring(e+1),isNaN(i)?t:t.substring(0,e))}function A(t){var e,i;return(e=t.lastIndexOf(" "))<0?0:(i=parseInt(t.substring(e+1),10),isNaN(i)?0:i)}function v(t){this._descriptor=t,this.vMo=null,this._lightSource=null}function N(t,e,s,n,o,r,a){this._class=null,this._id=null,this._name=null,this._displayName=null,this._alive=!0,this._away=!1,this._hitpoints=0,this._maxHitpoints=0,this.vMo=null,this._blinkers=null,this._spotLights=null,this._initialBlinkTime=-1,this.pMo=null,this._physicalPositionVector=[0,0,0],this._relativeVelocityMatrix=i.identity4(),this._relativeVelocityMatrixValid=!1,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._scaledOriMatrix=i.identity4(),this._ws=null,this._mLs=[],this._activeMissileLauncherIndex=-1,this._mClasses=[],this._tC=null,this._propulsion=null,this._jumpEngine=null,this._shield=null,this._mC=null,this._firingDisabled=!1,this._isJumping=!1,this._activeDamageIndicators=[],this._explosion=null,this._eventHandlers=null,this._tedBy=null,this._hitData={spacecraft:null,hitPosition:null,hullDamage:0,missile:!1},this._anySpacecraftHitData={spacecraft:this},this._team=null,this._squad=null,this._indexInSquad=0,this._piloted=!1,this._humSoundClip=null,this._humSoundVolume=0,this._collisionSoundClip=null,this._timeSinceCollisionSoundPlayed=0,this._soundSource=_.createSoundSource(0,0,0),this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._sensorsScoreValue=0,this._scoreValue=0,this._timeElapsedSinceDestruction=-1,this._burnForSpeedChangeFactor=0,this._burnForAngularVelocityChangeFactor=0,this._topSpeed=0,this._fired=!1,this._guestPiloted=!1,this._multiControlled=!1,this._multiHostData=new Float32Array(b),this._multiGuestData=new Float32Array(x),t&&this._init(t,e,s,n,o,r,a)}var O,L,R=[-1,-1,-1,-1],b=S.MULTI_HOST_DATA_LENGTH,x=S.MULTI_GUEST_DATA_LENGTH,D=null,w=null,P=null,V=!1,F=!1;return v.prototype.addToScene=function(t,e){this.vMo=new l.Particle(this._descriptor._particle.getModel(),this._descriptor._particle.getShader(),this._descriptor._particle.getTexturesOfTypes(this._descriptor._particle.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),i.translation4v(this._descriptor._position),this._descriptor.getParticleStates(),!0,this._descriptor._particle.getInstancedShader(),0),t.addSubnode(new c.RenderableNode(this.vMo,!1,!1,!0)),V&&!0===e&&this._descriptor._intensity>0&&(this._lightSource=new h.PointLightSource(this._descriptor._lightColor,0,this._descriptor._position,[t._renderableObject],this._descriptor.getLightStates(),!0),t._scene.addPointLightSource(this._lightSource,S.BLINKER_LIGHT_PRIORITY))},v.prototype.setTime=function(t){this.vMo.setAnimationTime(t),this._lightSource&&this._lightSource.setAnimationTime(t)},v.prototype.setRandomTime=function(){var t=Math.round(Math.random()*this._descriptor._period);return this.setTime(t),t},N.prototype._init=function(t,e,s,n,o,a,l){var h,c;for(this._class=t,this._name=e||"",this._alive=!0,this._away=!1,this._hitpoints=this._class._hitpoints,this._maxHitpoints=this._class._hitpoints,this.pMo=new r.PhysicalObject(this._class._mass,s||i.IDENTITY4,n||i.IDENTITY4,1,i.IDENTITY4,this._class._bodies,this._class._dragFactor),this._ws=[],this._mLs=[],this._mClasses=[],this._activeMissileLauncherIndex=-1,this._tC=new E.TargetingComputer(this,a,l),this._firingDisabled=!1,this._isJumping=!1,this._mC=new E.ManeuveringComputer(this),this._blinkers=[],c=this._class._blinkerDescriptors,h=0;h<c.length;h++)this._blinkers.push(new v(c[h]));this._spotLights=[],o&&this.equipLoadout(this._class.getLoadout(o)),this._tedBy=[],this._eventHandlers={},this._team=null,this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._hitSounds={},this._hitSoundTimestamp=0,this._updateIDAndName(),this._updateScoreValue(),this._updateBurnNeedFactors()},N.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:g.get(g.SQUAD.PREFIX,this._squad,this._squad)+" "+this._indexInSquad.toString()},N.prototype._updateBurnNeedFactors=function(){this._burnForSpeedChangeFactor=this._propulsion?this.pMo._mass/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()*1e3:0,this._burnForAngularVelocityChangeFactor=this._propulsion?1/r.ANGULAR_VELOCITY_MATRIX_DURATION_S*this.pMo._mass/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()*1e3:0},N.prototype.setAway=function(t){var e;this._away!==t&&(this._away=t,this._away?(this.setTarget(null),e=this.pMo.pM,this.vMo&&(!this.vMo._wireframe||0===e[12]&&0===e[13]&&0===e[14])&&this.vMo._node.hide(),this.pMo&&this.pMo.reset(),this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this._soundSource,!1))):this.vMo&&this.vMo._node.show())},N.prototype.setSquad=function(t,e){this._squad=t,this._indexInSquad=e,this._updateIDAndName()},N.prototype.isFriendly=function(t){return t._team===this._team},N.prototype.isHostile=function(t){return t._team!==this._team},N.prototype.setAsMultiControlled=function(t,e){this._guestPiloted=t,this._multiControlled=!t,this._multiGuestData[0]=e},N.prototype.getClass=function(){return this._class},N.prototype.isFighter=function(){return this._class.isFighterClass()},N.prototype.getID=function(){return this._id},N.prototype.getDisplayName=function(){return this._displayName},N.prototype.getHullIntegrity=function(){return this._hitpoints/this._maxHitpoints},N.prototype.setHullIntegrity=function(t){var e=Math.min(Math.max(0,t),1)*this._maxHitpoints,i=e>this._hitpoints;this._hitpoints=e,i&&this._updateDamageIndicators()},N.prototype.hasShield=function(){return!!this._shield},N.prototype.getShieldDisplayName=function(){return this._shield.getDisplayName()},N.prototype.getShieldIntegrity=function(){return this._shield?this._shield.getIntegrity():0},N.prototype.setShieldIntegrity=function(t){this._shield&&this._shield.setIntegrity(Math.min(Math.max(0,t),1))},N.prototype.getShieldCapacity=function(){return this._shield?this._shield._capacity:0},N.prototype.getShieldRechargeRate=function(){return this._shield?this._shield.getRechargeRate():0},N.prototype.getShieldState=function(){return this._shield?this._shield._state:e.NULL4},N.prototype.rechargeShield=function(){this._shield.startRecharge()},N.prototype.multiplyMaxHitpoints=function(t){this._hitpoints*=t,this._maxHitpoints*=t},N.prototype.getExplosion=function(){return this._explosion},N.prototype.getClassName=function(){return this._class._name},N.prototype.getTypeName=function(){return this._class._scType._name},N.prototype.isGoodAgainst=function(t){return this._class._scType.isGoodAgainst(t.getClass()._scType)},N.prototype.isBadAgainst=function(t){return this._class._scType.isBadAgainst(t.getClass()._scType)},N.prototype.resetDrag=function(){return this.pMo._dragFactor=this._class._dragFactor},N.prototype.getView=function(t){return this._class.getView(t)},N.prototype.enableFiring=function(){this._firingDisabled=!1},N.prototype.disableFiring=function(){this._firingDisabled=!0},N.prototype.hasWeapons=function(){return this._ws&&this._ws.length>0},N.prototype.getWeaponsDisplayText=function(t){var e,i,s,n="",o={};for(t=t||", ",e=0;e<this._ws.length;e++)i=this._ws[e].getDisplayName(),o[i]?o[i]+=1:o[i]=1;for(s=Object.keys(o),e=0;e<s.length;e++)n+=(e>0?t:"")+o[s[e]]+"  "+s[e];return n},N.prototype.getWeaponRangesDisplayText=function(t){t=t||"/";var e,i,s=[];for(e=0;e<this._ws.length;e++)i=this._ws[e].getRange(0),s.indexOf(i)<0&&s.push(i);return s.join(t)},N.prototype.getFirepower=function(t){var e,i=0;for(e=0;e<this._ws.length;e++)i+=this._ws[e].getFirepower(t);return i},N.prototype.hasMissiles=function(){var t;if(this._mLs)for(t=0;t<this._mLs.length;t++)if(this._mLs[t].getMissileCount()>0)return!0;return!1},N.prototype.getMissilesDisplayText=function(t){var e,i,s,n="",o={};for(t=t||", ",e=0;e<this._mLs.length;e++)i=this._mLs[e].getDisplayName(),o[i]?o[i]+=this._mLs[e].getMissileCount():o[i]=this._mLs[e].getMissileCount();for(s=Object.keys(o),e=0;e<s.length;e++)n+=(e>0?t:"")+o[s[e]]+"  "+s[e];return n},N.prototype.getMissileRangesDisplayText=function(t){t=t||"/";var e,i,s=[];for(e=0;e<this._mLs.length;e++)i=this._mLs[e].getNominalRange().toFixed(0),s.indexOf(i)<0&&s.push(i);return s.join(t)},N.prototype.getMissileFirepower=function(t){var e,i=0;for(e=0;e<this._mLs.length;e++)i+=this._mLs[e].getFirepower(t||0);return i},N.prototype.canBeReused=function(){return!this._alive},N.prototype.getHitRatio=function(){return this._shotsFired?this._hitsOnEnemies/this._shotsFired:0},N.prototype.getKills=function(){return this._kills},N.prototype.gainKill=function(){this._kills++},N.prototype.getScore=function(){return this._score
},N.prototype.gainScore=function(t){this._score+=t},N.prototype.getDamageDealt=function(){return this._damageDealt},N.prototype.getMissileDamageDealt=function(){return this._mDamageDealt},N.prototype.gainDamageDealt=function(t,e){this._damageDealt+=t,e&&(this._mDamageDealt+=t)},N.prototype.getMissilesLaunched=function(){return this._msLaunched},N.prototype.getMissileHitsOnEnemies=function(){return this._mHitsOnEnemies},N.prototype.getMissileHitRatio=function(){return this._mHitsOnEnemies/this._msLaunched},N.prototype.getScoreValue=function(){return this._scoreValue},N.prototype.setPhysicalPosition=function(t){this.pMo.setPosition(t[0],t[1],t[2])},N.prototype.getPhysicalPositionVector=function(){return this.pMo.copyPositionToVector(this._physicalPositionVector),this._physicalPositionVector},N.prototype.updatePhysicalOrientationMatrix=function(t){this.pMo.updateOrientationMatrix(t)},N.prototype.updateScaledOriMatrix=function(){i.setProd3x3SubOf4(this._scaledOriMatrix,this.pMo.sM,this.pMo.oM)},N.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix},N.prototype.getPositionMatrixInCameraSpace=function(){return this.vMo.getPositionMatrixInCameraSpace(this.vMo._node._scene._camera)},N.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrixValid||(i.updateProdTranslationRotationInverse4(this._relativeVelocityMatrix,this.pMo._velocityMatrix,this.pMo.oM),this._relativeVelocityMatrixValid=!0),this._relativeVelocityMatrix},N.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.updateProdRotationRotationInverse4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo._velocityMatrix),this.pMo.oM),this._turningMatrixValid=!0),this._turningMatrix},N.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this.pMo._mass:null},N.prototype.getMaxCombatSpeed=function(){return 2*this.getMaxAcceleration()||0},N.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this.pMo._mass:0},N.prototype.getMaxCombatTurnRate=function(){return this.getMaxAngularAcceleration()*t.DEG*.2||0},N.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},N.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},N.prototype.getMaxTurnRateAtSpeed=function(t){var e=Math.abs(this._propulsion.getThrust()/(this.pMo._mass*t));return e<=1?Math.asin(e):Number.MAX_VALUE},N.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._burnForSpeedChangeFactor/e},N.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t*this._burnForAngularVelocityChangeFactor/e},N.prototype.getTopSpeed=function(){return this._topSpeed},N.prototype.loadFromJSON=function(t,e,s){var n;this._init(p.getSpacecraftClass(t.class),t.name,t.position?i.translation4v(t.position):null,i.rotation4FromJSON(t.rotations),void 0,e,s),t.squad&&this.setSquad(C(t.squad),A(t.squad)),t.loadout?this.equipLoadout(this._class.getLoadout(t.loadout)):t.equipment?(n=new p.Loadout(t.equipment,null,t.equipment.basedOn?this._class.getLoadout(t.equipment.basedOn):null),this.equipLoadout(n)):this._class._defaultLoadout&&this.equipLoadout(this._class.getLoadout(this._class._defaultLoadout)),t.away&&this.setAway(!0),this._initialBlinkTime=void 0!==t.initialBlinkTime?t.initialBlinkTime:-1},N.prototype.prepareForControl=function(){this._mC.prepareForControl()},N.prototype.isManeuveringLocked=function(){return this._mC._locked},N.prototype.lockManeuvering=function(){this._mC.setLocked(!0)},N.prototype.unlockManeuvering=function(){this._mC.setLocked(!1)},N.prototype.getFlightMode=function(){return this._mC.getFlightMode()},N.prototype.changeFlightMode=function(t){return this._mC.changeFlightMode(t)},N.prototype.toggleFlightAssist=function(){return this._mC.toggleFlightAssist()},N.prototype.toggleCruise=function(){return this._mC.toggleCruise()},N.prototype.forward=function(t){this._mC.forward(t)},N.prototype.stopForward=function(){this._mC.stopForward()},N.prototype.reverse=function(t){this._mC.reverse(t)},N.prototype.stopReverse=function(){this._mC.stopReverse()},N.prototype.strafeLeft=function(t){this._mC.strafeLeft(t)},N.prototype.stopLeftStrafe=function(){this._mC.stopLeftStrafe()},N.prototype.strafeRight=function(t){this._mC.strafeRight(t)},N.prototype.stopRightStrafe=function(){this._mC.stopRightStrafe()},N.prototype.raise=function(t){this._mC.raise(t)},N.prototype.stopRaise=function(){this._mC.stopRaise()},N.prototype.lower=function(t){this._mC.lower(t)},N.prototype.stopLower=function(){this._mC.stopLower()},N.prototype.toggleSpeedHolding=function(){return this._mC.toggleSpeedHolding()},N.prototype.setSpeedHolding=function(t){this._mC.setSpeedHolding(t)},N.prototype.resetSpeed=function(){this._mC.resetSpeed()},N.prototype.setSpeedTarget=function(t){this._mC.setSpeedTarget(t)},N.prototype.getSpeedTarget=function(){return this._mC.getSpeedTarget()},N.prototype.hasSpeedTarget=function(){return this._mC.hasSpeedTarget()},N.prototype.getMaxSpeed=function(){return this._mC.getMaxSpeed()},N.prototype.yawLeft=function(t){this._mC.yawLeft(t)},N.prototype.yawRight=function(t){this._mC.yawRight(t)},N.prototype.pitchUp=function(t){this._mC.pitchUp(t)},N.prototype.pitchDown=function(t){this._mC.pitchDown(t)},N.prototype.rollLeft=function(t){this._mC.rollLeft(t)},N.prototype.rollRight=function(t){this._mC.rollRight(t)},N.prototype.acquireResources=function(t,e){this._class.acquireResources(e),a.executeWhenReady(function(){this._alive&&this.pMo.setScaling(this._class.getModel()._scale)}.bind(this))},N.prototype.addToSceneNow=function(t,n,o,r,a,c,_,p){var d,g,m,f,T,E,M,I,C,A,v,N,O;if(this._class){if(!1!==r.self?(g=a.shaderName?u.getManagedShader(a.shaderName):this._class.getShader(),I=new l.ParameterizedMesh(this._class.getModel(),g,a.skipTextures?{}:this._class.getTexturesOfTypes(g.getTextureTypes(),u.getTextureQualityPreferenceList()),a.positionMatrix||this.pMo.pM,a.orientationMatrix||this.pMo.oM,a.scalingMatrix||i.scaling4(this._class.getModel()._scale),!0===o,n,a.smallestSizeWhenDrawn,P,a.replaceVisualModel?null:this.vMo),this._name&&(I._name=this._name),E=this._class._factionColor||R,M=a.factionColor||this._team&&this._team._color||E,I.setUniformValueFunction("originalFactionColor",function(){return E}),I.setUniformValueFunction("replacementFactionColor",function(){return M}),I.setUniformValueFunction("shieldState",function(){return this.getShieldState()}.bind(this)),this.vMo&&!a.replaceVisualModel||(I.hasParameterArray(w)&&I.setParameterArray(w,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&I.hasParameterArray(D)&&I.setParameterArray(D,this._class._defaultLuminosityFactors),this.vMo=I),m=t.addObject(I),a.visualModel&&s.showError("Attempting to specify a visual model for the Spacecraft.addToScene() operation while a new one is also created!",s.ErrorSeverity.MINOR)):(I=a.visualModel||this.vMo,m=I._node),!0===r.weapons)for(N={shaderName:a.shaderName,skipTextures:a.skipTextures},d=0;d<this._ws.length;d++)this._ws[d].addToSceneNow(m,n,o,N,_);if(!0===r.missilesInLaunchers)for(O={shaderName:a.shaderName,skipTextures:a.skipTextures,allMissiles:r.allMissilesInLaunchers},d=0;d<this._mLs.length;d++)this._mLs[d].addToSceneNow(m,n,o,O,p);if(!0===r.thrusterParticles&&this._propulsion&&this._propulsion.addToScene(m,r.thrusterLightSources),!0===r.projectileResources)for(d=0;d<this._ws.length;d++)this._ws[d].addProjectileResourcesToScene(t);if(!0===r.missileResources)for(d=0;d<this._mLs.length;d++)this._mLs[d].addMissileResourcesToScene(t);if(!0===r.explosion&&(f=new y.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,e.NULL3,!0),f.addResourcesToScene(t)),!0===r.cameraConfigurations&&this._addCameraConfigurationsForViews(),V&&!0===r.lightSources)for(T=this._class._lightSources,this._spotLights.length=0,A=[I],d=0;d<T.length;d++)T[d].spotDirection?this._piloted&&(C=new h.SpotLightSource(T[d].color,T[d].intensity,T[d].position,T[d].spotDirection,T[d].spotCutoffAngle,T[d].spotFullIntensityAngle,I),this._spotLights.push(C),t.addSpotLightSource(C)):(C=new h.PointLightSource(T[d].color,T[d].intensity,T[d].position,A),t.addPointLightSource(C,S.SPACECRAFT_LIGHT_PRIORITY));if(!0===r.blinkers)for(d=0;d<this._blinkers.length;d++)this._blinkers[d].addToScene(m,r.lightSources),this._initialBlinkTime>=0?this._blinkers[d].setTime(this._initialBlinkTime):a.randomAnimationTime&&(0===d?v=this._blinkers[d].setRandomTime():this._blinkers[d].setTime(v));this._away&&(this._away=!1,this.setAway(!0)),c&&c(I)}},N.prototype.addToScene=function(t,e,i,s,n,o,r,l){var h,c,u,_,p;if(!n.skipResources){if(this.acquireResources(!1,{overrideShaderName:n.shaderName,omitTextures:n.skipTextures,explosion:s.explosion,damageIndicators:s.damageIndicators,blinkers:s.blinkers,sound:s.sound}),!0===s.weapons)for(u={overrideShaderName:n.shaderName,omitTextures:n.skipTextures,projectileResources:s.projectileResources,sound:s.sound},h=0;h<this._ws.length;h++)this._ws[h].acquireResources(u);if(!0===s.missileResources)for(_={overrideShaderName:n.shaderName,omitTextures:n.skipTextures,missileOnly:!1,sound:s.sound,trail:!0},h=0;h<this._mLs.length;h++)this._mLs[h].acquireResources(_);else if(!0===s.missilesInLaunchers)for(_={overrideShaderName:n.shaderName,omitTextures:n.skipTextures,missileOnly:!0,sound:s.sound},h=0;h<this._mLs.length;h++)this._mLs[h].acquireResources(_);if(p={sound:s.sound,omitTextures:n.skipTextures},!0===s.thrusterParticles&&this._propulsion&&(this._propulsion.addThrusters(this._class._thrusterSlots),this._propulsion.acquireResources(p)),!0===s.jumpEngine&&this._jumpEngine&&this._jumpEngine.acquireResources(p),!0===s.shield&&this._shield&&this._shield.acquireResources(p),!0===s.explosion&&this._class._explosionClass.acquireResources(p),!0===s.blinkers)for(c=this._class._blinkerDescriptors,h=0;h<c.length;h++)c[h].acquireResources(p)}a.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n,o,r,l))},N.prototype.createCameraConfigurationForView=function(t){return t.createCameraConfiguration(this.vMo,d.getDefaultCameraBaseOrientation(),d.getDefaultCameraPointToFallback(),d.getDefaultCameraFOV(),d.getDefaultCameraSpan())},N.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class._views.length;t++)this.vMo._node.addCameraConfiguration(this.createCameraConfigurationForView(this._class._views[t]))},N.prototype._updateScoreValue=function(){var t;for(this._scoreValue=this._class.getScoreValue(),t=0;t<this._ws.length;t++)this._scoreValue+=this._ws[t].getScoreValue();for(t=0;t<this._mLs.length;t++)this._scoreValue+=this._mLs[t].getScoreValue();this._propulsion&&(this._scoreValue+=this._propulsion.getScoreValue()),this._scoreValue+=this._sensorsScoreValue,this._shield&&(this._scoreValue+=this._shield.getScoreValue())},N.prototype._addWeapon=function(t,e){var i,s=this._class._wSlots;(void 0===e||e<0)&&(e=this._ws.length),e<s.length&&(i=s[e],this._ws.push(new E.Weapon(t,this,i)))},N.prototype._setActiveMissileLauncherIndex=function(t){this._activeMissileLauncherIndex=t,this._tC.setMissileLauncher(this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null)},N.prototype._addMissiles=function(t,e,i){var s,n=this._class._mLs;(void 0===i||i<0)&&(i=this._mLs.length),i<n.length&&(s=n[i],this._mLs.push(new E.MissileLauncher(t,this,s,e)),this._activeMissileLauncherIndex<0&&this._setActiveMissileLauncherIndex(0),this._mClasses.indexOf(t)<0&&this._mClasses.push(t))},N.prototype._addPropulsion=function(t){this._propulsion=new E.Propulsion(t,this.pMo),this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._topSpeed=r.getDrag()&&this._class._dragFactor?Math.sqrt(this.getMaxAcceleration()/(r.getDrag()*this._class._dragFactor)):0,this._updateBurnNeedFactors()},N.prototype._addSensors=function(t){this._tC.updateSensors(t),this._sensorsScoreValue=t.getScoreValue()},N.prototype._addJumpEngine=function(t){this._jumpEngine=new E.JumpEngine(t,this)},N.prototype._addShield=function(t){this._shield=new E.Shield(t,this)},N.prototype.unequip=function(){var t;for(t=0;t<this._ws.length;t++)this._ws[t].destroy();for(this._ws=[],t=0;t<this._mLs.length;t++)this._mLs[t].destroy();this._mLs=[],this._mClasses=[],this._setActiveMissileLauncherIndex(-1),this._propulsion&&this._propulsion.destroy(),this._propulsion=null,this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._tC.updateSensors(),this._sensorsScoreValue=0,this._updateScoreValue()},N.prototype.equipLoadout=function(t){var e,i,s;if(t){for(i=t._wDescriptors,e=0;e<i.length;e++)this._addWeapon(p.getWeaponClass(i[e].className),i[e].slotIndex);for(s=t._mDescriptors,e=0;e<s.length;e++)this._addMissiles(p.getMissileClass(s[e].className),s[e].amount,s[e].launcherIndex);null!==t._propulsionDescriptor&&this._addPropulsion(p.getPropulsionClass(t._propulsionDescriptor.className)),null!==t._sensorsDescriptor&&this._addSensors(p.getSensorsClass(t._sensorsDescriptor.className)),null!==t._jumpEngineDescriptor&&this._addJumpEngine(p.getJumpEngineClass(t._jumpEngineDescriptor.className)),null!==t._shieldDescriptor&&this._addShield(p.getShieldClass(t._shieldDescriptor.className))}this._updateScoreValue()},N.prototype.getLoadoutNames=function(){return this._class.getLoadoutNames()},N.prototype.getSoundSourceForFireSound=function(){var t;return t=this.getPositionMatrixInCameraSpace(),Math.abs(t[12])<=O&&Math.abs(t[13])<=O&&Math.abs(t[14])<=O?null:this._soundSource},N.prototype.fire=function(t){var e,i,s,n,o=!1;if(!this._firingDisabled&&!this._isJumping){for(i=this.getScaledOriMatrix(),n=this.getSoundSourceForFireSound(),e=0;e<this._ws.length;e++)s=this._ws[e].fire(i,t,n),o=s>0||o,this._shotsFired+=s;if(o){for(e=0;e<this._tedBy.length;e++)this._tedBy[e].handleEvent(T.TARGET_FIRED);this.handleEvent(T.FIRED)}this._guestPiloted||(this._fired=!0)}},N.prototype.requestFire=function(t){this._guestPiloted?this._fired=!0:this.fire(t)},N.prototype._autoChangeMissileLauncher=function(){var t,e,i;t=this._activeMissileLauncherIndex,e=this._mLs[t]._class,i=this._mLs[t]._salvo;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class!==e));if(this._activeMissileLauncherIndex===t&&!this._mLs[t].hasMissilesLeftToLaunch())do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch());this._activeMissileLauncherIndex===t?this._mLs[t].getMissileCount()<=0&&this._setActiveMissileLauncherIndex(-1):(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),this._mLs[this._activeMissileLauncherIndex]._class===e?this._mLs[this._activeMissileLauncherIndex].setSalvoMode(i):(this._mLs[this._activeMissileLauncherIndex].setMinimumCooldown(500),d.getBattleSetting(d.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0),m.playMissileChangeSound()))},N.prototype.launchMissile=function(){var t,e,i;if(!this._firingDisabled&&!this._isJumping&&this._activeMissileLauncherIndex>=0&&this._tC.isMissileLocked()){if(e=this.getScaledOriMatrix(),i=this._mLs[this._activeMissileLauncherIndex].launch(e,this.getSoundSourceForFireSound(),!1)){for(this._msLaunched++,t=0;t<this._tedBy.length;t++)this._tedBy[t].handleEvent(T.TARGET_FIRED);this.handleEvent(T.FIRED),this._autoChangeMissileLauncher()}return i}return null},N.prototype.handleSalvoMissileLaunched=function(){this._msLaunched++,this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].getMissileCount()<=0&&this._autoChangeMissileLauncher()},N.prototype.changeMissile=function(){var t,e,i;if(this._activeMissileLauncherIndex>=0){t=this._activeMissileLauncherIndex,e=this._mLs[t]._class;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class===e));return i=this._activeMissileLauncherIndex!==t,i&&(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),d.getBattleSetting(d.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0)),i}return!1},N.prototype.toggleSalvo=function(){return this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].toggleSalvoMode()},N.prototype.getActiveMissileLauncher=function(){return this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null},N.prototype.getMissileCount=function(t){var e,i=0;for(e=0;e<this._mLs.length;e++)this._mLs[e]._class===t&&(i+=this._mLs[e].getMissileCount());return i},N.prototype.increaseHitsOnEnemies=function(t){t?this._mHitsOnEnemies++:this._hitsOnEnemies++},N.prototype.setBeingTargeted=function(t){this._tedBy&&(this._tedBy.push(t),this.handleEvent(T.BEING_TARGETED,{spacecraft:t}))},N.prototype.setBeingUntargeted=function(t){this._tedBy&&this._tedBy.splice(this._tedBy.indexOf(t),1)},N.prototype.setTarget=function(t){this._tC.setTarget(t)},N.prototype.targetNextNearestHostile=function(){return this._tC.targetNextNearestHostile()},N.prototype.targetPreviousNearestHostile=function(){return this._tC.targetPreviousNearestHostile()},N.prototype.targetNextBestHostile=function(){return this._tC.targetNextBestHostile()},N.prototype.targetNextNearestNonHostile=function(){return this._tC.targetNextNearestNonHostile()},N.prototype.getTarget=function(){return this._tC.getTarget()},N.prototype.getTargetHitPosition=function(){return this._tC.getTargetHitPosition()},N.prototype.getMissileLockRatio=function(){return this._tC.getMissileLockRatio()},N.prototype.isInLockingRange=function(){return this._tC.isInLockingRange()},N.prototype.getPropulsionDisplayName=function(){return this._propulsion.getDisplayName()},N.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},N.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},N.prototype.updatePropulsionVisuals=function(){this._propulsion.updateVisuals()},N.prototype.isInSensorRange=function(t){return this._tC.isInRange(t)},N.prototype.resetViewCameras=function(){this.vMo._node.resetCameraConfigurations()},N.prototype.damage=function(t,s,n,o,r,a,l){var h,c,u,_,p,d,g,m,S,E;if(h=this._hitpoints,this._shield&&(t=this._shield.damage(t,F)),t=Math.max(0,t-this._class._armor),d=this._hitpoints>0,this._hitpoints-=t,this._hitpoints<=0)F||d&&o&&this.isHostile(o)&&(g=this.getScoreValue(),t+=this._hitpoints,o.gainDamageDealt(t,r),o.gainScore((1-L)*t/this._maxHitpoints*g),o.gainScore(L*g),o.gainKill(),f.isInGame()&&f.registerPlayerKill(o.getID(),this.getID()),o.handleEvent(T.GAIN_KILL,this._anySpacecraftHitData)),this._hitpoints=0;else{for(c=this._activeDamageIndicators.length;c<this._class._damageIndicators.length;c++)u=this._class._damageIndicators[c],_=u.hullIntegrity/100*this._maxHitpoints,this._hitpoints<=_&&this._hitpoints+t>_&&(a>0?(m=[0,0,0,1],E=this.pMo.getBodySize(),e.setSum3(m,s,e.scaled3Aux(n,-E)),m=this.pMo.checkHitRelative(m,e.scaled3(n,-1),E,0),m||(S=e.scaled3(s,-1),E=e.extractLength3(S),m=this.pMo.checkHitRelative(e.NULL4W1,S,E,0)),!m||e.length3Squared(m,s)<.01?m=s:S&&(n=e.scaled3(S,-1))):m=s,p=y.getExplosion(),p.init(u.explosionClass,i.translation4vAux(m),i.IDENTITY4,n,!0),p.addToSceneNow(this.vMo._node,this._soundSource),this._activeDamageIndicators.push(p));F||d&&o&&o._alive&&this.isHostile(o)&&(o.gainDamageDealt(t,r),o.gainScore((1-L)*t/this._maxHitpoints*this.getScoreValue()))}this._hitData.spacecraft=o,this._hitData.hitPosition=s,this._hitData.hullDamage=t,this._hitData.missile=r,l?this.handleEvent(T.COLLIDED,this._hitData):(this.handleEvent(T.BEING_HIT,this._hitData),o._alive&&!o._away&&(o.getTarget()===this&&o.handleEvent(T.TARGET_HIT,this._hitData),o.handleEvent(T.ANY_SPACECRAFT_HIT,this._anySpacecraftHitData))),F?this._hitpoints=h:!l&&this.isHostile(o)&&o.increaseHitsOnEnemies(r)},N.prototype.aimWeapons=function(t,e,i){var s,n,o=this.getTarget();for(o&&this._ws.length>0&&(s=this.getTargetHitPosition()),n=0;n<this._ws.length;n++)!o||this._firingDisabled||this._isJumping?this._ws[n].rotateToDefaultPosition(t,i):this._ws[n].aimTowards(s,t,e,this.getScaledOriMatrix(),i)},N.prototype.jumpOut=function(t){return!(this._away||!this._jumpEngine)&&this._jumpEngine.jumpOut(t)},N.prototype.jumpIn=function(){this._away&&this._jumpEngine&&this._jumpEngine.jumpIn()},N.prototype._startHumSound=function(){this._humSoundClip.setVolume(0),this._humSoundClip.play(),this._humSoundClip.rampVolume(this._humSoundVolume,.02,!0,!0)},N.prototype.playCollisionSound=function(t){this._timeSinceCollisionSoundPlayed>=250&&(this._class.playCollisionSound(t),this._timeSinceCollisionSoundPlayed=0)},N.prototype.respawn=function(t){var e;for(this._alive=!0,this._hitpoints=this._maxHitpoints,this._timeElapsedSinceDestruction=-1,this._humSoundClip&&this._startHumSound(),e=0;e<this._blinkers.length;e++)t?this._blinkers[e].setRandomTime():this._blinkers[e].setTime(0)},N.prototype.setHitpointsToZero=function(){this._hitpoints=0},N.prototype._updateDamageIndicators=function(){var t,e,i;for(t=this._activeDamageIndicators.length-1,e=this._class._damageIndicators;t>=0&&this._hitpoints>e[t].hullIntegrity/100*this._maxHitpoints;)t--;for(i=t+1;t<this._activeDamageIndicators.length-1;)t++,this._activeDamageIndicators[t].finish();this._activeDamageIndicators.length=i},N.DEFAULT_SIMULATE_PARAMS={controlThrusters:!0,applyThrusterForces:!0},N.prototype.simulate=function(t,s){var n,o,r;if(this._alive&&!this._away){if(s=s||N.DEFAULT_SIMULATE_PARAMS,this._tC.simulate(t),o=this.getPositionMatrixInCameraSpace(),this._soundSource.updatePosition(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14])),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0){for(this._timeElapsedSinceDestruction=0,this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this._soundSource,!1)),this._explosion=y.getExplosion(),this._explosion.init(this._class._explosionClass,this.pMo.pM,this.pMo.oM,e.getRowC43Aux(this.pMo.pM),!0,!0,this.pMo._velocityMatrix),this._explosion.addToScene(this.vMo._node._scene._rootNode,this._soundSource),n=0;n<this._activeDamageIndicators.length;n++)this._activeDamageIndicators[n].finish();this._activeDamageIndicators.length=0,r=i.matrix4Aux(this.pMo._velocityMatrix),this.pMo.reset(),this.pMo.setVelocity(r[12],r[13],r[14])}else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class._explosionClass.getTotalDuration()*this._class._showTimeRatioDuringExplosion)return this._alive=!1,void(!1!==this.handleEvent(T.DESTRUCTED)&&this.destroy(!0))}else{for(n=0;n<this._ws.length;n++)this._ws[n].simulate(t);for(n=0;n<this._mLs.length;n++)this._mLs[n].simulate(t),this._activeMissileLauncherIndex<0&&this._mLs[n].hasMissilesLeftToLaunch()&&this._setActiveMissileLauncherIndex(n);this._propulsion&&(s.controlThrusters&&this._mC.controlThrusters(t,this._multiControlled),this._propulsion.simulate(t,this._soundSource,s.applyThrusterForces)),this._jumpEngine&&this._jumpEngine.simulate(t),this._shield&&this._shield.simulate(t,F),this._class.hasHumSound()&&(this._humSoundClip||(this._humSoundClip=this._class.createHumSoundClip(this._soundSource),this._humSoundVolume=this._humSoundClip.getVolume(),this._humSoundClip&&this._startHumSound())),this._timeSinceCollisionSoundPlayed<250&&(this._timeSinceCollisionSoundPlayed+=t)}this.pMo.simulate(t),this._relativeVelocityMatrixValid=!1,this._turningMatrixValid=!1,this.updateScaledOriMatrix(),this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._propulsion&&this._mC.updateSpeedIncrement(t)}},N.prototype.addEventHandler=function(t,e){this._eventHandlers[t]=this._eventHandlers[t]||[],this._eventHandlers[t].push(e)},N.prototype.handleEvent=function(t,e){var i,s;if(this._eventHandlers&&this._eventHandlers[t])for(s=!0,i=0;i<this._eventHandlers[t].length;i++)s=this._eventHandlers[t][i](e)&&s;return s},N.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._ws.length;t++)e+=this._ws[t].getMaxProjectileCount();return e},N.prototype.getMaxMissileCount=function(){var t,e=0;for(t=0;t<this._mLs.length;t++)e+=this._mLs[t].getMaxMissileCount();return e},N.prototype.getMaxExplosionCount=function(){var t,e=0;for(e+=1,e+=this._class._damageIndicators.length,t=0;t<this._ws.length;t++)e+=this._ws[t].getMaxExplosionCount();for(t=0;t<this._mLs.length;t++)e+=this._mLs[t].getMaxExplosionCount();return e},N.prototype.getMaxParticleCount=function(){var t,e,i=0;for(i+=this._class._explosionClass.getMaxParticleCount(),e=this._class._damageIndicators,t=0;t<e.length;t++)i+=e[t].explosionClass.getMaxParticleCount();for(t=0;t<this._ws.length;t++)i+=this._ws[t].getMaxParticleCount();for(t=0;t<this._mLs.length;t++)i+=this._mLs[t].getMaxParticleCount();return i},N.prototype.getLockingTimeFactor=function(){return this._class.getLockingTimeFactor()},N.prototype.toggleSpotLights=function(){var t;if(this._spotLights.length>0)if(this._spotLights[0].isVisible())for(t=0;t<this._spotLights.length;t++)this._spotLights[t].hide();else for(t=0;t<this._spotLights.length;t++)this._spotLights[t].show()},N.prototype.getMultiHostData=function(){var t,e,i;return this._alive?(t=this.pMo.pM,e=this.pMo.oM,i=this.pMo._velocityMatrix,this._multiHostData[0]=t[12],this._multiHostData[1]=t[13],this._multiHostData[2]=t[14],this._multiHostData[3]=e[4],this._multiHostData[4]=e[5],this._multiHostData[5]=e[6],this._multiHostData[6]=e[8],this._multiHostData[7]=e[9],this._multiHostData[8]=e[10],this._multiHostData[9]=this.getHullIntegrity(),this._multiHostData[10]=this.getShieldIntegrity(),this._multiHostData[11]=this._fired?1:0,this._multiHostData[12]=i[12],this._multiHostData[13]=i[13],this._multiHostData[14]=i[14],this._multiHostData[15]=i[0],this._multiHostData[16]=i[1],this._multiHostData[17]=i[2],this._multiHostData[18]=i[4],this._multiHostData[19]=i[5],this._multiHostData[20]=i[6],this._multiHostData[21]=i[8],this._multiHostData[22]=i[9],this._multiHostData[23]=i[10],this._multiHostData[24]=this._mC.getSpeedTarget(),this._multiHostData[25]=this._mC._lastStrafeTarget,this._multiHostData[26]=this._mC._lastLiftTarget,this._multiHostData[27]=this._mC._lastYawTarget,this._multiHostData[28]=this._mC._lastPitchTarget,this._multiHostData[29]=this._mC._lastRollTarget,this._fired=!1,this._multiHostData):this._multiHostData},N.prototype.applyMultiHostData=function(t,e){this._alive&&(this.pMo.setPosition(t[e],t[e+1],t[e+2]),this.pMo.setOrientation(t[e+3],t[e+4],t[e+5],t[e+6],t[e+7],t[e+8]),this.setHullIntegrity(t[e+9]),this.setShieldIntegrity(t[e+10]),t[e+11]&&this.fire(!1),this.pMo.setVelocity(t[e+12],t[e+13],t[e+14]),this.pMo.setAngularVelocity(t[e+15],t[e+16],t[e+17],t[e+18],t[e+19],t[e+20],t[e+21],t[e+22],t[e+23]),this._multiControlled&&(this._mC.setSpeedTarget(t[e+24]),this._mC._strafeTarget=t[e+25],this._mC._liftTarget=t[e+26],this._mC._rollTarget=t[e+29],this._mC._yawTarget=t[e+27],this._mC._pitchTarget=t[e+28]))},N.prototype.getMultiGuestData=function(){return this._alive?(this._multiGuestData[1]=this._mC.getSpeedTarget(),this._multiGuestData[2]=this._mC._lastStrafeTarget,this._multiGuestData[3]=this._mC._lastLiftTarget,this._multiGuestData[4]=this._mC._lastYawTarget,this._multiGuestData[5]=this._mC._lastPitchTarget,this._multiGuestData[6]=this._mC._lastRollTarget,this._multiGuestData[7]=this._fired?1:0,this._fired=!1,this._multiGuestData):this._multiGuestData},N.prototype.applyMultiGuestData=function(t){this._alive&&(this._mC.setSpeedTarget(t[1]),this._mC._strafeTarget=t[2],this._mC._liftTarget=t[3],this._mC._yawTarget=t[4],this._mC._pitchTarget=t[5],this._mC._rollTarget=t[6],t[7]&&this.fire(!1))},N.prototype.destroy=function(t){var e;if(t||(this._class=null),this._ws)for(e=0;e<this._ws.length;e++)this._ws[e]&&(this._ws[e].destroy(),this._ws[e]=null);if(this._ws=null,this._mLs)for(e=0;e<this._mLs.length;e++)this._mLs[e]&&(this._mLs[e].destroy(),this._mLs[e]=null);this._mLs=null,this._mClasses=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._jumpEngine&&(this._jumpEngine.destroy(),this._jumpEngine=null),this._shield&&(this._shield.destroy(),this._shield=null),this._mC&&(this._mC.destroy(),this._mC=null),this._tC&&(this._tC.destroy(),this._tC=null),this._tedBy=null,this._eventHandlers=null,this._explosion=null,
this.vMo&&this.vMo._node&&!this.vMo._node.canBeReused()&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._spotLights=null,this.pMo=null,this._activeDamageIndicators&&(this._activeDamageIndicators=null),this._alive=!1,this._humSoundClip&&(this._humSoundClip.destroy(),this._humSoundClip=null),this._soundSource&&(this._soundSource=null)},d.executeWhenReady(function(){D="luminosityFactors",w=d.getSetting(d.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),O=100,L=.5,u.executeWhenReady(M),u.onSettingsChange(M)}),{MULTI_HOST_DATA_LENGTH:b,MULTI_GUEST_DATA_LENGTH:x,setMultiGuest:I,getSquadName:C,getSquadIndex:A,Spacecraft:N}}),define("armada/logic/ai",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/physics","armada/configuration","armada/logic/SpacecraftEvents","armada/logic/classes","armada/logic/equipment","armada/logic/formations","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h){"use strict";function c(){return Object.keys(H)}function u(){V=Math.seed(4718)}function _(){u(),F=Math.seed(4718),U=Math.seed(4718),B=Math.seed(4718)}function p(s,n,o){var r;if(n.lead&&n.index>0&&n.jump.formation)s.setPhysicalPosition(h.getPositionInFormation(n.jump.formation,n.index,n.lead.getPhysicalPositionVector(),n.lead.pMo.oM)),s.updatePhysicalOrientationMatrix(n.lead.pMo.oM);else if(n.jump.anchor)if(n.clearCache&&(n.jump.anchorSpacecraft=null,n.clearCache=!1),r=n.jump.anchorSpacecraft||o.getSpacecraft(n.jump.anchor))n.jump.anchorSpacecraft=r,n.jump.distance?(s.updatePhysicalOrientationMatrix(i.prod3x3SubOf4Aux(i.rotationX4Aux((V()-.5)*Math.PI),i.rotationZ4Aux(V()*t.DOUBLE_PI))),s.setPhysicalPosition(e.getRowB43ScaledAux(s.pMo.oM,-n.jump.distance))):(n.jump.position&&s.setPhysicalPosition(n.jump.position),n.jump.rotations&&s.updatePhysicalOrientationMatrix(i.rotation4FromJSON(n.jump.rotations))),n.jump.relative&&(s.setPhysicalPosition(e.prodTranslationRotation3Aux(s.pMo.pM,r.pMo.oM)),s.updatePhysicalOrientationMatrix(i.prod3x3SubOf4Aux(s.pMo.oM,r.pMo.oM))),s.setPhysicalPosition(e.sum3Aux(s.getPhysicalPositionVector(),r.getPhysicalPositionVector()));else{if(!n.jump.fallbackPosition)return!1;s.setPhysicalPosition(n.jump.fallbackPosition),n.jump.fallbackRotations&&s.updatePhysicalOrientationMatrix(i.rotation4FromJSON(n.jump.fallbackRotations))}return!0}function d(){var t,e,i;if(0===mt.length)for(t=0;t<tt;t++)mt.push(t);return i=Math.trunc(Math.random()*mt.length),e=mt[i],mt.splice(i,1),e}function g(t,e,i){this._sc=t,this._mission=e,this._standingDown=!1,this._t=null,this._engagedTarget=null,this._tList=null,this._priorityTargets=!1,this._hitCountByNonTarget=0,this._wRange=this._sc&&this._sc._ws.length>0?this._sc._ws[0].getRange(0):0,this._attackingTarget=!1,this._moveCommand=W.NONE,this._moveCommandTarget=null,this._moveCommandMinDistance=0,this._moveCommandMaxDistance=0,this._lastRadioTime=0,this._lastRadioType=-1,this._radioTimeLeft=0,this._radioPriority=0,this._radioSilence=!1,this._radioData={voice:i&&i.voice?"random"===i.voice?d():o.getSetting(o.BS.PILOT_VOICES).indexOf(i.voice):-1,messageType:-1},this._sc&&(this._sc.setSpeedHolding(!0),this._sc.addEventHandler(r.BEING_HIT,this._handleBeingHit.bind(this)),this._sc.addEventHandler(r.COMMAND_RECEIVED,this._handleCommand.bind(this)),this._sc.addEventHandler(r.GAIN_KILL,this._handleGainKill.bind(this)),i&&i.voice||!e._pilotedCraft||!this._sc.isFriendly(e._pilotedCraft)||(this._radioData.voice=d()))}function m(t){var e;for(e=0;e<P.length;e++)if(P[e].name===t)return P[e];return null}function f(t){var e;if(t){if(void 0!==t.evasionDelayFactor)return t.evasionDelayFactor;if((e=t.preset?m(t.preset):null)&&void 0!==e.evasionDelayFactor)return e.evasionDelayFactor}return 1}function S(t){var e;if(t){if(void 0!==t.fireDelayFactor)return t.fireDelayFactor;if((e=t.preset?m(t.preset):null)&&void 0!==e.fireDelayFactor)return e.fireDelayFactor}return 1}function T(t){var e;if(t){if(void 0!==t.aimUpdateInterval)return t.aimUpdateInterval;if((e=t.preset?m(t.preset):null)&&void 0!==e.aimUpdateInterval)return e.aimUpdateInterval}return J}function E(t){var e;if(t){if(void 0!==t.maxAimError)return t.maxAimError;if((e=t.preset?m(t.preset):null)&&void 0!==e.maxAimError)return e.maxAimError}return Q}function y(t){var e;if(t){if(void 0!==t.aimErrorResetDistance)return t.aimErrorResetDistance;if((e=t.preset?m(t.preset):null)&&void 0!==e.aimErrorResetDistance)return e.aimErrorResetDistance}return K}function M(t,e,i){var s=e._pilotedCraft&&e._pilotedCraft.isHostile(t)?e.getDifficultyLevel()._enemyReactionTimeFactor:1;g.call(this,t,e,i),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._evasiveManeuverDelayLeft=0,this._evasiveManeuverDelay=$*s*f(i),this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=j.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=z,this._isBlockedBy=null,this._facingTarget=!1,this._tDistance=0,this._tOffset=[0,0,0],this._tOffsetUpdateInterval=T(i),this._tOffsetUpdateTimeLeft=0,this._aimErrorResetThreshold=y(i),this._aimErrorResetThreshold*=this._aimErrorResetThreshold,this._maxAimError=Math.radians(E(i)),this._currentAimError=0,this._aimError=[0,0],this._fireDelayLeft=0,this._fireDelay=Z*s*S(i),this._msOnTarget=[],this._sc.addEventHandler(r.TARGET_HIT,this._handleTargetHit.bind(this)),this._sc.addEventHandler(r.ANY_SPACECRAFT_HIT,this._handleAnySpacecraftHit.bind(this)),this._sc.addEventHandler(r.TARGET_FIRED,this._handleTargetFired.bind(this))}function I(t,e,i){g.call(this,t,e,i)}function C(t,e,i,s){g.call(this,t,e,i),this._shouldTurn=!!s}function A(t,e,i){C.call(this,t,e,i,!0)}function v(){Ct=[],mt=[]}function N(t,e,i,s){Ct.push(new H[t](e,i,s))}function O(t){var e;for(e=0;e<Ct.length;e++)if(Ct[e].getSpacecraft()===t)return Ct[e].getVoice();return-1}function L(t){var e;for(e=0;e<Ct.length;e++)if(Ct[e].getVoice()===t)return!0;return!1}function R(t,e){var i;for(i=0;i<Ct.length;i++)(!e||e.indexOf(Ct[i].getSpacecraft())>=0)&&(Ct[i]._radioSilence=t)}function b(t){var e;for(e=0;e<Ct.length;e++)Ct[e].control(t)}function x(t,e){var i;for(i=0;i<Ct.length;i++)if(Ct[i].handleSpacecraftEvent(t,e))return}function D(){var t;for(t=0;t<Ct.length;t++)Ct[t].handlePlayerGainKill()}function w(t){var e;for(e=0;e<Ct.length;e++)Ct[e].handleSceneMoved(t)}var P,V,F,U,B,H,G={JUMP:"jump",TARGET:"target",STAND_DOWN:"standDown",REACH_DISTANCE:"reachDistance",CANCEL_MOVE:"cancelMove"},k={IN:"in",OUT:"out"},j={NONE:-1,APPROACH_ATTACK:0,EVADE:1},W={NONE:-1,REACH_DISTANCE:0},Y=1e3/n.ANGULAR_VELOCITY_MATRIX_DURATION,X=Math.radians(45),z=.3,q=Math.radians(45),J=1500,Q=2,K=25,Z=350,$=200,tt=-1,et=-1,it=-1,st=-1,nt=-1,ot=-1,rt=-1,at=-1,lt=-1,ht=-1,ct=-1,ut=-1,_t=-1,pt=-1,dt=-1,gt=-1,mt=[],ft=0,St=0,Tt=0,Et=0,yt={yaw:0,pitch:0,roll:0},Mt=[0,0,0],It=[0,0,0],Ct=[];return g.prototype.getSpacecraft=function(){return this._sc},g.prototype.getVoice=function(){return this._radioData.voice},g.prototype._sendRadio=function(t,e,i){var s=performance.now(),n=s-this._lastRadioTime;return!!(!this._radioSilence&&this._radioData.voice>=0&&this._sc&&this._sc._alive&&!this._sc._away&&(!this._sc._isJumping||t===ut)&&(t!==this._lastRadioType&&n>=St||n>ft||e>0||i>1)&&(this._radioTimeLeft<=0||i>=this._radioPriority)&&Math.random()<=i)&&(this._radioData.messageType=t,n<St&&i<2&&(e=St-n),this._radioTimeLeft=e,this._radioPriority=i,0===e&&(this._sc.handleEvent(r.RADIO,this._radioData),this._lastRadioType=t,this._lastRadioTime=s),!0)},g.prototype._handleDelayedRadio=function(t){this._radioTimeLeft>0&&(this._radioTimeLeft-=t,this._radioTimeLeft<=0&&(this._radioData.messageType!==st||!this._t)&&this._sendRadio(this._radioData.messageType,0,1))},g.prototype.turn=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=Et/(r*s),o=Math.sign(n[4])*e.angle2y(n[4],n[5])*Y,a=Math.max(o*o/(2*r),.002),t>a?this._sc.yawLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[6])*e.angle2x(n[5],n[6])*Y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},g.prototype.rollAndYaw=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=Et/(r*s),o=Math.sign(n[2])*e.angle2x(n[0],n[2])*Y,a=Math.max(o*o/(2*r),.002),t>a?this._sc.rollLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[4])*e.angle2y(n[4],n[5])*Y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.yawLeft(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-i-a)),1))},g.prototype.rollAndPitch=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=Et/(r*s),o=Math.sign(n[2])*e.angle2x(n[0],n[2])*Y,a=Math.max(o*o/(2*r),.002),t>a?this._sc.rollLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[6])*e.angle2x(n[5],n[6])*Y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},g.prototype.approach=function(t,e,i,s){var n,o;n=this._sc.getRelativeVelocityMatrix()[13],o=n*n/(2*this._sc.getMaxAcceleration()),n<0&&(o=-o),t-o>e?this._sc.setSpeedTarget(s):i>=0&&t-o<i?this._sc.setSpeedTarget(-s):this._sc.resetSpeed()},g.prototype.orientToAttackPosition=function(i,s){var n,o,r,l;switch(n=this._sc.getClass()._attackVectorAngles,o=this._sc.getClass()._attackThresholdAngle,this._sc.getClass()._turnStyle){case a.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(yt.yaw-n[0])>o||Math.abs(yt.pitch-n[1])>o)&&this.turn(yt.yaw-n[0],yt.pitch-n[1],s);break;case a.SpacecraftTurnStyle.ROLL_YAW:e.getRollAndYaw(yt,i,!0),r=yt.roll-n[0],l=yt.yaw-n[1],(Math.abs(r)>o||Math.abs(l)>o)&&(Math.abs(l)>t.HALF_PI?r=0:Math.abs(r)>t.HALF_PI&&(l=0),this.rollAndYaw(r,l,s));break;case a.SpacecraftTurnStyle.ROLL_PITCH:e.getRollAndPitch(yt,i,!0),r=yt.roll-n[0],l=yt.pitch-n[1],(Math.abs(r)>o||Math.abs(l)>o)&&(Math.abs(l)>t.HALF_PI?r=0:Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,yt.pitch=-yt.pitch),this.rollAndPitch(r,yt.pitch-n[1],s))}},g.prototype._handleTargetSwitch=function(){this._hitCountByNonTarget=0},g._tListFilterFunction=function(t){return t._alive},g.prototype._updateTarget=function(t){var e,i;if(this._standingDown)return void this._sc.setTarget(null);if(i=this._sc.getTarget(),this._tList&&(this._tList=this._tList.filter(g._tListFilterFunction)),this._tList&&this._tList.length>0){if(this._priorityTargets){if(t)this._tList.indexOf(t)>=0&&this._sc.setTarget(t);else if(!i||this._tList.indexOf(i)<0){for(e=0;e<this._tList.length;e++)if(!this._tList[e]._away){this._sc.setTarget(this._tList[e]);break}!i&&e>=this._tList.length&&this._sc.targetNextBestHostile()}}else if(t)this._sc.setTarget(t);else if(!i){for(e=0;e<this._tList.length;e++)if(!this._tList[e]._away){this._sc.setTarget(this._tList[e]);break}e>=this._tList.length&&this._sc.targetNextBestHostile()}}else t?this._sc.setTarget(t):i||this._sc.targetNextBestHostile();this._sc.getTarget()!==this._t&&(this._handleTargetSwitch(),this._t=this._sc.getTarget(),this._t||this._sendRadio(st,2e3,2))},g.prototype._handleBeingHit=function(t){var e=t.spacecraft;this._sc&&this._sc._alive&&(this._sc._hitpoints<=0?this._sendRadio(rt,0,3):e._alive&&!e._away&&e.isHostile(this._sc)&&(this._sendRadio(this._sc.getHullIntegrity()<.25?ot:lt,0,.9),this._sc.getTarget()&&this._sc.getTarget()!==e&&(this._sc.getTarget().getTarget()===this._sc&&this._attackingTarget||this._updateTarget(e),this._hitCountByNonTarget++)))},g.prototype._handleGainKill=function(){this._sendRadio(ct,0,1.1)},g.prototype._handleCommand=function(t){var e,i;switch(t.command){case G.JUMP:if((t.jump&&t.jump.way?t.jump.way:this._sc._away?k.IN:k.OUT)===k.IN){if(this._sc._away){if(t.jump&&!p(this._sc,t,this._mission))break;this._sc.jumpIn()}}else this._sc.jumpOut(!1)&&this._sendRadio(ut,0,1.2);break;case G.TARGET:if(t.target){if(t.clearCache&&(t.target.targetSpacecrafts=null,t.clearCache=!1),t.target.targetSpacecrafts)this._tList=t.target.targetSpacecrafts.slice();else{if(t.target.single)(i=this._mission.getSpacecraft(t.target.single))&&(this._tList=[i]);else if(t.target.list)for(this._tList=[],e=0;e<t.target.list.length;e++)(i=this._mission.getSpacecraft(t.target.list[e]))&&this._tList.push(i);else if(t.target.squads)for(this._tList=[],e=0;e<t.target.squads.length;e++)this._tList=this._tList.concat(this._mission.getSpacecraftsInSquad(t.target.squads[e]));else t.target.none?this._tList=null:s.showError("'"+this._sc.getDisplayName()+"' has no target specified for targeting command!");this._tList&&(t.target.targetSpacecrafts=this._tList.slice())}this._tList&&this._tList.length>0?(this._sc.setTarget(this._tList[0]),this._standingDown=!1):t.target.none&&this._sc.setTarget(null),this._priorityTargets=!0===t.target.priority}break;case G.STAND_DOWN:this._standingDown=!0,this._cancelMoveCommand(),this._sendRadio(pt,0,1);break;case G.REACH_DISTANCE:t.reachDistance&&(i=this._mission.getSpacecraft(t.reachDistance.target))&&i._alive&&!i._away&&(this._moveCommand=W.REACH_DISTANCE,this._moveCommandTarget=i,this._moveCommandMinDistance=t.reachDistance.minDistance||0,this._moveCommandMaxDistance=t.reachDistance.maxDistance||0);break;case G.CANCEL_MOVE:this._cancelMoveCommand();break;default:s.showError("Unknown spacecraft command: '"+t.command+"'!")}},g.prototype._cancelMoveCommand=function(){this._moveCommand=W.NONE,this._moveCommandTarget=null},g.prototype._executeMoveCommand=function(t,i,s,n){var o,r,a,h,c;switch(this._moveCommand){case W.REACH_DISTANCE:if(!this._moveCommandTarget||!this._moveCommandTarget._alive||this._moveCommandTarget._away)return void this._cancelMoveCommand();o=e.prodMat4Vec3Aux(i,e.diff3Aux(this._moveCommandTarget.getPhysicalPositionVector(),t)),r=e.extractLength3(o),c=!0,0!==this._moveCommandMaxDistance&&r>this._moveCommandMaxDistance&&(e.getYawAndPitch(yt,o),a=Math.abs(yt.yaw)<X&&Math.abs(yt.pitch)<X,this.turn(yt.yaw,yt.pitch,n),h=r>this._moveCommandMaxDistance+1e3,this._sc.changeFlightMode(h?l.FlightMode.CRUISE:l.FlightMode.COMBAT),a?this.approach(r,this._moveCommandMaxDistance,0,s*(h?4:2)):this._sc.resetSpeed(),c=!1),0!==this._moveCommandMinDistance&&r<this._moveCommandMinDistance&&(e.scale3(o,-1),e.getYawAndPitch(yt,o),a=Math.abs(yt.yaw)<X&&Math.abs(yt.pitch)<X,this.turn(yt.yaw,yt.pitch,n),h=r<this._moveCommandMinDistance-1e3,this._sc.changeFlightMode(h?l.FlightMode.CRUISE:l.FlightMode.COMBAT),a?this.approach(this._moveCommandMinDistance-r,0,0,s*(h?4:2)):this._sc.resetSpeed(),c=!1),c&&this._cancelMoveCommand()}},g.prototype.handleSpacecraftEvent=function(t,e){switch(t){case r.ARRIVED:if(this._sc&&this._sc.isHostile(e))return this._sendRadio(ht,500,2);break;case r.DESTRUCTED:if(this._sc&&this._sc.isFriendly(e))return e.isFighter()?this._sendRadio(dt,1500,.5):this._sendRadio(gt,1500,.5)}return!1},g.prototype.handlePlayerGainKill=function(){this._sc&&this._sendRadio(nt,1e3,.5)},M.prototype=new g,M.prototype.constructor=M,M.prototype._updateAimError=function(){this._aimError[0]=2*(F()-.5)*this._currentAimError,this._aimError[1]=2*(F()-.5)*this._currentAimError},M.prototype._startNewAttackRun=function(){this._chargePhase=j.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT),this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=z,this._isBlockedBy=null,this._rollTime=-1,this._tOffset=[0,0,0],this._tOffsetUpdateTimeLeft=this._tOffsetUpdateInterval,this._currentAimError=this._maxAimError,this._fireDelayLeft=this._fireDelay,this._updateAimError()},M.prototype._handleTargetSwitch=function(){g.prototype._handleTargetSwitch.call(this),this._msOnTarget.length=0,this._startNewAttackRun()},M.prototype._triggerEvasiveManeuver=function(){return this._evasiveManeuverTime<0&&(this._evasiveManeuverDelayLeft=this._evasiveManeuverDelay,this._evasiveManeuverTime=0,!0)},M.prototype._handleBeingHit=function(t){this._isBlockedBy||this._triggerEvasiveManeuver()&&(this._evasiveVelocityVector[0]=-t.hitPosition[0],this._evasiveVelocityVector[1]=-t.hitPosition[2],e.normalize2(this._evasiveVelocityVector)),g.prototype._handleBeingHit.call(this,t)},M.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},M.prototype._handleAnySpacecraftHit=function(t){var e=t.spacecraft;this._sc&&this._sc._alive&&e!==this._sc&&this._chargePhase!==j.EVADE&&e!==this._sc.getTarget()&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._sc))&&(this._isBlockedBy=e,this._evasiveManeuverTime=-1,this._chargePhase=j.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT))},M.prototype._handleTargetFired=function(){var i;!this._isBlockedBy&&this._facingTarget&&this._sc&&this._sc.getTarget()&&this._sc.getTarget().getTarget()===this._sc&&this._tDistance>.5*this._wRange&&this._triggerEvasiveManeuver()&&(i=U()*t.DOUBLE_PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,e.rotate2(this._evasiveVelocityVector,i),this._sendRadio(at,0,1))},M.prototype.handleSceneMoved=function(t){e.add3(this._chargeDestination,t)},M.prototype.control=function(s){var n,o,r,h,c,u,_,p,d,g,m,f,S,T,E,y,M,I,C,A,v,N,O,L,R,b,x,D,w,P,V,F,H;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;for(this._handleDelayedRadio(s),P=!1,this._updateTarget(),E=this._sc.getMaxAcceleration(),m=this._sc.vMo.getScaledSize(),h=this._sc.getPhysicalPositionVector(),F=this._sc.pMo.oM,I=this._sc.getRelativeVelocityMatrix()[13],n=this._sc.getTarget(),this._attackingTarget=!1,p=0;p<this._msOnTarget.length;p++)this._msOnTarget[p].getTarget()!==n&&(this._msOnTarget.splice(p,1),p--);if(this._executeMoveCommand(h,F,E,s),this._moveCommand===W.NONE)if(this._chargePhase===j.EVADE)this._attackingTarget=!!n,e.setDiff3(It,this._chargeDestination,h),u=e.prodMat4Vec3Aux(F,It),this._tDistance=e.extractLength3(u),e.getYawAndPitch(yt,u),this.turn(yt.yaw,yt.pitch,s),this._sc.setSpeedTarget(2*E),(this._tDistance<=1||u[1]<0||I<0)&&this._startNewAttackRun();else if(n)if(H=n.pMo.pM,Mt[0]=H[12],Mt[1]=H[13],Mt[2]=H[14],this._tOffsetUpdateTimeLeft<=0?(this._tOffsetUpdateTimeLeft=this._tOffsetUpdateInterval,c=e.diff3Aux(this._sc.getTargetHitPosition(),Mt),e.length3Squared(e.diff3Aux(this._tOffset,c))<this._aimErrorResetThreshold?this._currentAimError*=.5:this._currentAimError=this._maxAimError,this._tOffset[0]=c[0],this._tOffset[1]=c[1],this._tOffset[2]=c[2],this._updateAimError()):this._tOffsetUpdateTimeLeft-=s,e.add3(Mt,this._tOffset),e.setDiff3(It,Mt,h),u=e.prodMat4Vec3Aux(F,It),this._tDistance=e.extractLength3(u),e.getYawAndPitch(yt,u),yt.yaw+=this._aimError[0],yt.pitch+=this._aimError[1],this._facingTarget=Math.abs(yt.yaw)<X&&Math.abs(yt.pitch)<X,this.turn(yt.yaw,yt.pitch,s),this._isBlockedBy&&(w=!1,this._isBlockedBy._alive&&this._facingTarget&&this._isBlockedBy.pMo.checkHit(i.translation4vAux(Mt),i.translation4vAux(It),1e3,.25*m)&&(_=e.prodMat4Vec3Aux(F,e.diffVec3Mat4Aux(h,this._isBlockedBy.pMo.pM)),C=1*E,_[0]>0?(this._sc.strafeRight(C),w=!0):(this._sc.strafeLeft(C),w=!0),_[2]<0?(this._sc.lower(C),w=!0):(this._sc.raise(C),w=!0)),w||(this._isBlockedBy=null,this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()),P=!0),(V=this._sc._ws)&&V.length>0){if(f=n.vMo.getScaledSize(),S=Math.atan(.25*f/this._tDistance),b=V[0].getProjectileVelocity()+I,d=this._tDistance/b*1e3,v=V[0].getCooldown(),this._sc.aimWeapons(.002,S,s),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),D=V[0].getRange(I),T=!1,e.length3Squared(e.diff3Aux(this._sc.getTargetHitPosition(),h))<=D*D?(this._attackingTarget=!0,Math.abs(yt.yaw)<S&&Math.abs(yt.pitch)<S&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._sc))?(T=!0,this._fireDelayLeft>0?this._fireDelayLeft-=s:(this._sc.fire(),this._engagedTarget!==n&&(this._sendRadio(et,0,.7),this._engagedTarget=n),this._isBlockedBy?(this._timeSinceLastTargetHit=0,this._timeSinceLastRoll=0,this._timeSinceLastClosingIn=0):(O=d+3*v,this._timeSinceLastRoll>O&&this._timeSinceLastTargetHit>O&&(L=this._sc.getMaxAngularAcceleration(),R=L*Tt,N=q>R*Tt?Tt+(q-R*Tt)/R:Math.sqrt(4*q/L)/2,this._rollTime=1e3*N)))):(this._fireDelayLeft=this._fireDelay,(Math.abs(yt.yaw)>3*S||Math.abs(yt.pitch)>3*S)&&(this._timeSinceLastRoll=0)),this._engagedTarget===n&&(this._timeSinceLastRoll+=s,this._timeSinceLastTargetHit+=s,this._timeSinceLastClosingIn+=s),this._rollTime>0&&(this._sc.rollLeft(),this._timeSinceLastRoll=0,this._rollTime-=s)):(this._timeSinceLastRoll=0,this._fireDelayLeft=this._fireDelay,this._approachedTarget!==n&&(this._sendRadio(it,0,.7),this._approachedTarget=n)),this._sc.getActiveMissileLauncher())if(r=this._sc.getActiveMissileLauncher()._class,r._antiFighter&&!n.isFighter()||r._antiShip&&n.isFighter())this._sc.changeMissile();else{for(g=n._hitpoints+n.getShieldCapacity(),p=0;p<this._msOnTarget.length;p++)g-=this._msOnTarget[p].getClass().getDamage(0);g>0&&(r._homingMode!==a.MissileHomingMode.NONE||T&&this._sc.isInLockingRange())&&(o=this._sc.launchMissile())&&(this._msOnTarget.push(o),this._sendRadio(_t,0,1))}this._chargePhase===j.NONE&&(this._hitCountByNonTarget>=4||this._timeSinceLastTargetHit>d+15*v)&&(this._chargePhase=j.APPROACH_ATTACK,this._sc.changeFlightMode(l.FlightMode.CRUISE)),this._chargePhase===j.NONE?(x=d+5*v,this._timeSinceLastClosingIn>x&&this._timeSinceLastTargetHit>x&&this._maxDistanceFactor>.125&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-.05,.125),this._timeSinceLastClosingIn=0),A=.5*(m+f),M=A+this._maxDistanceFactor*this._wRange,y=A+.06*this._wRange,this._facingTarget?this.approach(this._tDistance,M,y,2*E):this._sc.resetSpeed()):this._chargePhase===j.APPROACH_ATTACK&&(M=Math.sqrt(2*(f+.5*m)/E)*E*4,this._facingTarget?(this._sc.setSpeedTarget(4*E),this._tDistance<=M&&(this._chargePhase=j.EVADE,this._sc.changeFlightMode(l.FlightMode.COMBAT),e.normalize3(It),e.setSum3(this._chargeDestination,h,e.scaled3Aux(e.diff3Aux(e.sum3Aux(Mt,e.scaled3Aux(e.normalize3(e.prodVec3Mat3Aux(e.perpendicular3(It),i.rotation3Aux(It,B()*t.DOUBLE_PI))),M)),h),1)))):(this._chargePhase=j.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT),this._sc.resetSpeed()))}else this._sc.resetSpeed();else this._facingTarget=!1,this._tDistance=0,this._sc.resetSpeed(),this._sc.aimWeapons(.002,0,s);P||(this._evasiveManeuverTime>=0&&this._evasiveManeuverDelayLeft<=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=1*E,this._evasiveVelocityVector[1]*=1*E,e.rotate2(this._evasiveVelocityVector,(U()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._sc.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._sc.strafeLeft(-this._evasiveVelocityVector[0]):(this._sc.stopLeftStrafe(),this._sc.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._sc.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._sc.lower(-this._evasiveVelocityVector[1]):(this._sc.stopLower(),this._sc.stopRaise()),this._evasiveManeuverTime+=s,this._evasiveManeuverTime>1e3&&(this._evasiveManeuverTime=-1)):(this._evasiveManeuverDelayLeft>0&&(this._evasiveManeuverDelayLeft-=s),this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()))}},I.prototype=new g,I.prototype.constructor=I,I.prototype.handleSceneMoved=function(){},I.prototype.control=function(t){var i,s,n,o,r,a,l,h,c,u,_,p,d,g,m;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;this._handleDelayedRadio(t),this._updateTarget(),h=this._sc.getMaxAcceleration(),r=this._sc.vMo.getScaledSize(),s=this._sc.getPhysicalPositionVector(),m=this._sc.pMo.oM,i=this._sc.getTarget(),this._attackingTarget=!1,this._executeMoveCommand(s,m,h,t),i?(d=i.isHostile(this._sc),n=e.prodMat4Vec3(m,e.diffTranslation3Aux(i.pMo.pM,this._sc.pMo.pM)),o=e.extractLength3(n),d&&(e.getYawAndPitch(yt,n),p=Math.abs(yt.yaw)<X&&Math.abs(yt.pitch)<X),(g=this._sc._ws)&&g.length>0&&(a=i.vMo.getScaledSize(),l=Math.atan(.25*a/o),d&&(u=.25*r,c=u+.9*this._wRange),this._sc.aimWeapons(.002,l,t),d?(this._moveCommand===W.NONE&&(p?this.approach(o,c,0,2*h):this._sc.resetSpeed(),o>c?this.turn(yt.yaw,yt.pitch,t):this.orientToAttackPosition(n,t)),_=g[0].getRange(this._sc.getRelativeVelocityMatrix()[13]),e.length3Squared(e.diff3Aux(this._sc.getTargetHitPosition(),s))-u<=_*_&&(this._sc.fire(!0),this._attackingTarget=!0)):this._sc.resetSpeed())):(this._moveCommand===W.NONE&&this._sc.resetSpeed(),this._sc.aimWeapons(.002,0,t))}},C.prototype=new g,C.prototype.constructor=C,C.prototype.handleSceneMoved=function(){},C.prototype.control=function(t){var i,s,n,o,r,a,l,h,c,u,_,p,d;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;this._handleDelayedRadio(t),this._updateTarget(),h=this._sc.getMaxAcceleration(),r=this._sc.vMo.getScaledSize(),s=this._sc.getPhysicalPositionVector(),d=this._sc.pMo.oM,i=this._sc.getTarget(),this._attackingTarget=!1,this._executeMoveCommand(s,d,h,t),i?(_=i.isHostile(this._sc),n=e.prodMat4Vec3(d,e.diffTranslation3Aux(i.pMo.pM,this._sc.pMo.pM)),o=e.extractLength3(n),this._shouldTurn&&this._moveCommand===W.NONE&&this.orientToAttackPosition(n,t),(p=this._sc._ws)&&p.length>0&&(a=i.vMo.getScaledSize(),l=Math.atan(.25*a/o),_&&(c=.25*r),this._sc.aimWeapons(.002,l,t),_&&(u=p[0].getRange(this._sc.getRelativeVelocityMatrix()[13]),e.length3Squared(e.diff3Aux(this._sc.getTargetHitPosition(),s))-c<=u*u&&(this._sc.fire(!0),this._attackingTarget=!0)))):this._sc.aimWeapons(.002,0,t),this._moveCommand===W.NONE&&this._sc.resetSpeed()}},A.prototype=new C,A.prototype.constructor=A,H={},H.fighter=M,H.ship=I,H.station=C,H.sentry=A,o.executeWhenReady(function(){var t=o.getSetting(o.BS.VOICE_MESSAGES);Tt=.2,Et=1e3/Tt,V=Math.seed(Math.random()),F=Math.seed(Math.random()),U=Math.seed(Math.random()),B=Math.seed(Math.random()),tt=o.getSetting(o.BS.PILOT_VOICES).length,et=t.indexOf("attacking"),it=t.indexOf("approaching"),st=t.indexOf("clear"),nt=t.indexOf("compliment"),ot=t.indexOf("damaged"),rt=t.indexOf("die"),at=t.indexOf("evading"),lt=t.indexOf("hit"),ht=t.indexOf("incoming"),ct=t.indexOf("kill"),ut=t.indexOf("leaving"),_t=t.indexOf("missiles"),pt=t.indexOf("standdown"),dt=t.indexOf("wingmanlost"),gt=t.indexOf("shiplost"),ft=5e3,St=1500,P=o.getSetting(o.BS.AI_PRESETS)}),{SpacecraftCommand:G,JumpCommandWay:k,DEFAULT_AIM_UPDATE_INTERVAL:J,DEFAULT_MAX_AIM_ERROR:Q,DEFAULT_AIM_ERROR_RESET_DISTANCE:K,getAITypes:c,resetJumpInPositionSeed:u,resetRandomSeeds:_,positionForInwardJump:p,clearAIs:v,addAI:N,getVoiceOfSpacecraft:O,isVoiceUsed:L,setRadioSilenceForSpacecrafts:R,control:b,broadcastSpacecraftEvent:x,handlePlayerGainKill:D,handleSceneMoved:w}}),define("armada/logic/missions/conditions",["utils/utils","utils/matrices","modules/application","armada/strings","armada/logic/SpacecraftEvents","utils/polyfill"],function(t,e,i,s,n){"use strict";function o(t){this._descriptor=t||{},this._scs=null,this._shortString=null}function r(e){this._type=e?t.getSafeEnumValue(M,e.type,null):null,this._subjects=e?new o(e.subjects):null,e&&this._checkParams(e.params)}function a(t){r.call(this,t)}function l(t){r.call(this,t)}function h(t){r.call(this,t),this._running=!this._params||!this._params.start,this._trigger=null,this._timeElapsed=this._params?this._params.startValue||0:0,this._count=0,this._canBeImpossible=!!this._params&&(this._params.when===A.BEFORE||this._params.when===A.WITHIN||this._params.when===A.ONCE||this._params.when===A.REPEAT&&this._params.maxCount),this._before=!!this._params&&this._params.when===A.BEFORE,this._impossible=!1}function c(e,i){var s;r.call(this,e),this._subjectIsSelf=!!i&&this._subjects.isPilotedSpacecraft(i),this._ts=this._subjects.getSpacecrafts(i),this._ts?(this._ts=this._ts.slice(),(s=this._ts.indexOf(i._pilotedCraft))>=0&&this._ts.splice(s,1)):this._ts=t.EMPTY_ARRAY}function u(t){r.call(this,t)}function _(t){r.call(this,t),this._distanceSquared=0,this._lastSatisfied=!1,this._impossible=!1,this._active=!0}function p(t,e){var i,s,a;if(r.call(this,t),this._satisfied=!1,e&&this._subjects&&(s=this._subjects.getSpacecrafts(e))&&s.length>0)for(a=this._handleHit.bind(this,this._params&&this._params.by?new o(this._params.by).getSpacecrafts(e):null),i=0;i<s.length;i++)s[i].addEventHandler(n.BEING_HIT,a)}function d(t,e){var i,s,a;if(r.call(this,t),this._satisfied=!1,e&&this._subjects&&(s=this._subjects.getSpacecrafts(e))&&s.length>0)for(a=this._handleCollision.bind(this,this._params&&this._params.with?new o(this._params.with).getSpacecrafts(e):null),i=0;i<s.length;i++)s[i].addEventHandler(n.COLLIDED,a)}function g(t){r.call(this,t)}function m(t){r.call(this,t)}function f(t){r.call(this,t)}function S(t,e){var i,s,a;if(r.call(this,t),this._satisfied=!1,e&&this._subjects&&(s=this._subjects.getSpacecrafts(e))&&s.length>0)for(a=this._handleTargeted.bind(this,this._params&&this._params.by?new o(this._params.by).getSpacecrafts(e):null),i=0;i<s.length;i++)s[i].addEventHandler(n.BEING_TARGETED,a)}function T(t,e){r.call(this,t),this._by=null,e&&this._params&&this._params.by&&(this._by=new o(this._params.by).getSpacecrafts(e))}function E(t,e){return new(y[t.type]||r)(t,e)}var y,M={DESTROYED:"destroyed",COUNT:"count",TIME:"time",HULL_INTEGRITY:"hullIntegrity",SHIELD_INTEGRITY:"shieldIntegrity",DISTANCE:"distance",HIT:"hit",COLLISION:"collision",AWAY:"away",ON_TEAM:"onTeam",MISSION_STATE:"missionState",
GETS_TARGETED:"getsTargeted",IS_TARGETED:"isTargeted"},I={ALL:"all",ANY:"any"},C={BELOW:"below",ABOVE:"above",EQUALS:"equals"},A={BEFORE:"before",AFTER:"after",WITHIN:"within",ONCE:"once",REPEAT:"repeat"},v={NONE:0,BATTLE:1,IN_PROGRESS:2,COMPLETED:3,FAILED:4,DEFEAT:5,ENDED:6};return Object.freeze(M),Object.freeze(I),Object.freeze(C),Object.freeze(A),Object.freeze(v),o.prototype.has=function(t){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.indexOf(t.getID())>=0||this._descriptor.squads&&this._descriptor.squads.indexOf(t._squad)>=0||this._descriptor.teams&&t._team&&this._descriptor.teams.indexOf(t._team._name)>=0},o.prototype._cacheSpacecrafts=function(t){var e,i;for(this._scs=[],i=t.getSpacecrafts(),e=0;e<i.length;e++)this.has(i[e])&&this._scs.push(i[e])},o.prototype.getSpacecrafts=function(t,e){return!t||this._scs&&!e||this._cacheSpacecrafts(t),this._scs},o.prototype.isMulti=function(){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.length>1||this._descriptor.squads&&this._descriptor.squads.length>0||this._descriptor.teams&&this._descriptor.teams.length>0},o.prototype.isSingleSpacecraft=function(){return this._descriptor.spacecrafts&&1===this._descriptor.spacecrafts.length&&(!this._descriptor.squads||0===this._descriptor.squads.length)&&(!this._descriptor.teams||0===this._descriptor.teams.length)},o.prototype.isPilotedSpacecraft=function(t){var e;return!!this.isSingleSpacecraft()&&(e=this.getSpacecrafts(t),1===e.length&&e[0]===t._pilotedCraft)},o.prototype.isEmpty=function(){return!this._descriptor.spacecrafts&&!this._descriptor.squads&&!this._descriptor.teams},o._mapSpacecraftID=function(t){return s.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},o._getMappedSpacecraftIDs=function(t){return s.getList(t.map(o._mapSpacecraftID))},o._mapSquadID=function(t){return t=s.get(s.SQUAD.PREFIX,t,t),s.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},o._getMappedSquadIDs=function(t){return s.getList(t.map(o._mapSquadID))},o._mapTeamID=function(t){return t=s.get(s.FACTION.PREFIX,t,t),s.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},o._getMappedTeamIDs=function(t){return s.getList(t.map(o._mapTeamID))},o.prototype.toString=function(){var e="";return this._descriptor.spacecrafts&&(e+=o._getMappedSpacecraftIDs(this._descriptor.spacecrafts)),this._descriptor.squads&&(e.length>0&&(e+="; "),e+=t.formatString(s.get(this._descriptor.squads.length>1?s.MISSIONS.OBJECTIVE_SUBJECTS_SQUADS:s.MISSIONS.OBJECTIVE_SUBJECTS_SQUAD),{ids:o._getMappedSquadIDs(this._descriptor.squads)})),this._descriptor.teams&&(e.length>0&&(e+="; "),e+=t.formatString(s.get(this._descriptor.teams.length>1?s.MISSIONS.OBJECTIVE_SUBJECTS_TEAMS:s.MISSIONS.OBJECTIVE_SUBJECTS_TEAM),{ids:o._getMappedTeamIDs(this._descriptor.teams)})),e},o.prototype.getLiveSubjectCount=function(t){var e,i=0;for(e=0;e<this._scs.length;e++)!this._scs[e]._alive||t&&this._scs[e]._away||i++;return i},o.prototype.getMinHullIntegrity=function(t){var e,i=100;for(e=0;e<this._scs.length;e++)!this._scs[e]._alive||t&&this._scs[e]._away||(i=Math.min(i,this._scs[e].getHullIntegrity()));return i},o.prototype.getMaxHullIntegrity=function(t){var e,i=0;for(e=0;e<this._scs.length;e++)!this._scs[e]._alive||t&&this._scs[e]._away||(i=Math.max(i,this._scs[e].getHullIntegrity()));return i},o.prototype.getShortString=function(){return this._shortString||(0===this._scs.length?this._shortString="-":!this._descriptor.spacecrafts||this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||!this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||this._descriptor.squads||!this._descriptor.teams?this._shortString=t.formatString(s.get(s.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._descriptor.teams.length>1?this._shortString=t.formatString(s.get(s.BATTLE.OBJECTIVE_SUBJECTS_TEAMS),{count:this._descriptor.teams.length}):this._shortString=s.get(s.FACTION.PREFIX,this._descriptor.teams[0],this._descriptor.teams[0]):this._descriptor.squads.length>1?this._shortString=t.formatString(s.get(s.BATTLE.OBJECTIVE_SUBJECTS_SQUADS),{count:this._descriptor.squads.length}):this._shortString=s.get(s.SQUAD.PREFIX,this._descriptor.squads[0],this._descriptor.squads[0]):this._scs.length>1?this._shortString=t.formatString(s.get(s.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._shortString=this._scs[0].getDisplayName()),this._shortString},r.prototype._handleWrongParams=function(){i.showError("Wrong parameters specified for condition of type: '"+this._type+"'!")},r.prototype.canBeImpossible=function(){return!1},r.prototype.isImpossible=function(){return!1},r.prototype.isActive=function(){return!0},r.prototype.canChangeMultipleTimes=function(){return!1},a.prototype=new r,a.prototype.constructor=a,a.prototype._checkParams=function(e){return this._params=e,this._params&&this._params.which&&!t.getSafeEnumValue(I,this._params.which)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,!0)},a.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t);for(e=0;e<i.length;e++)if(i[e]._alive===this._all)return!this._all;return this._all},a.prototype.getObjectiveString=function(e){var i=t.formatString(s.get(e,this._subjects.isMulti()?this._all?s.OBJECTIVE.DESTROY_SUFFIX.name:s.OBJECTIVE.DESTROY_ANY_SUFFIX.name:s.OBJECTIVE.DESTROY_ONE_SUFFIX.name),{subjects:this._subjects.toString()});return i=i.charAt(0).toUpperCase()+i.slice(1)},a.prototype.getObjectiveStateString=function(e){var i,n,o;return this._subjects.getSpacecrafts()?(n=this._subjects.getLiveSubjectCount(!0),o=n>1?" ("+n+")":"",i=t.formatString(s.get(e,s.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.getShortString()})+o,i=i.charAt(0).toUpperCase()+i.slice(1)):""},a.prototype.getTargetSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},a.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},l.prototype=new r,l.prototype.constructor=l,l.prototype._checkParams=function(e){return this._params=e,!(!this._params||"number"!=typeof this._params.count||!t.getSafeEnumValue(C,this._params.relation))||(this._handleWrongParams(),!1)},l.prototype.isSatisfied=function(t){var e,i,s=this._subjects.getSpacecrafts(t);for(i=0,e=0;e<s.length;e++)s[e]._alive&&i++;switch(this._params.relation){case C.BELOW:return i<this._params.count;case C.ABOVE:return i>this._params.count;case C.EQUALS:return i===this._params.count}return!1},l.prototype.getObjectiveString=function(e){var n;return this._params.relation!==C.BELOW?(i.showError("Count conditions for mission objectives must have relation set to '"+C.BELOW+"'!"),null):(n=t.formatString(s.get(e,s.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.toString(),count:this._params.count}),n=n.charAt(0).toUpperCase()+n.slice(1))},l.prototype.getObjectiveStateString=function(e){var i,n;return this._subjects.getSpacecrafts()?(n=this._subjects.getLiveSubjectCount(),i=t.formatString(s.get(e,s.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.getShortString(),count:this._params.count,live:n,remaining:Math.max(0,n-this._params.count)}),i=i.charAt(0).toUpperCase()+i.slice(1)):""},l.prototype.getTargetSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},l.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},h.prototype=new r,h.prototype.constructor=h,h.prototype._checkParams=function(e){return this._params=e,!(!this._params||"number"!=typeof this._params.time||!t.getSafeEnumValue(A,this._params.when)||void 0!==this._params.start&&"string"!=typeof this._params.start||this._params.when!==A.REPEAT&&void 0!==this._params.maxCount||this._params.when===A.REPEAT&&void 0!==this._params.maxCount&&"number"!=typeof this._params.maxCount||void 0!==this._params.startValue&&"number"!=typeof this._params.startValue)||(this._handleWrongParams(),!1)},h.prototype.isSatisfied=function(t,e){var i=!1;if(this._params.start&&!this._trigger&&(this._trigger=t.getEvent(this._params.start)&&t.getEvent(this._params.start)._trigger,this._trigger||(this._params.start=null)),!this._running&&!this._impossible&&this._trigger&&this._trigger.hasFired()&&(this._running=!0),this._running)switch(this._timeElapsed+=e,this._params.when){case A.BEFORE:case A.WITHIN:if(this._timeElapsed<this._params.time)return!0;this._impossible=!0;break;case A.AFTER:if(this._timeElapsed>this._params.time)return!0;break;case A.ONCE:if(this._timeElapsed>=this._params.time&&0===this._count)return this._running=!1,this._count=1,this._impossible=!0,!0;break;case A.REPEAT:if(!this._params.maxCount||this._count<this._params.maxCount){for(;this._timeElapsed>=this._params.time;)this._timeElapsed-=this._params.time,i=!0;if(i)return this._count++,!0}else this._running=!1,this._impossible=!0}return!!this._before&&this._timeElapsed<this._params.time},h.prototype.getObjectiveString=function(e,n){var o;return n||this._params&&this._params.when===A.AFTER?n&&(!this._params||this._params.when!==A.BEFORE&&this._params.when!==A.WITHIN)?(i.showError("Time conditions used in combination with other conditions for mission objectives must have 'when' = '"+A.BEFORE+NaN+A.WITHIN+"'!"),null):(o=t.formatString(s.get(e,n?s.OBJECTIVE.TIME_MULTI_SUFFIX.name:s.OBJECTIVE.TIME_SUFFIX.name),{time:t.formatTimeToMinutes(this._params.time)}),n||(o=o.charAt(0).toUpperCase()+o.slice(1)),o):(i.showError("Single time conditions for mission objectives must have 'when' = '"+A.AFTER+"'!"),null)},h.prototype.getObjectiveStateString=function(e,i){var n,o;return o=1e3*Math.ceil(.001*Math.max(0,this._params.time-this._timeElapsed)),n=t.formatString(s.get(e,i?s.OBJECTIVE.TIME_MULTI_SUFFIX.name:s.OBJECTIVE.TIME_SUFFIX.name),{time:t.formatTimeToMinutes(o)}),n=n.charAt(0).toUpperCase()+n.slice(1)},h.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},h.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},h.prototype.canBeImpossible=function(){return this._canBeImpossible},h.prototype.isImpossible=function(){return this._impossible},h.prototype.isActive=function(){return this._running&&(!this._params||this._timeElapsed<this._params.time)},h.prototype.canChangeMultipleTimes=function(){return this._params.when===A.REPEAT},c.prototype=new r,c.prototype.constructor=c,c.prototype._checkParams=function(e){return this._params=e,this._params&&(this._params.which&&!t.getSafeEnumValue(I,this._params.which)||void 0!==this._params.minIntegrity&&(this._params.minIntegrity<0||this._params.minIntegrity>100)||void 0!==this._params.maxIntegrity&&(this._params.maxIntegrity<0||this._params.maxIntegrity>100))?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,!0)},c.prototype.isSatisfied=function(t){var e,i,s=this._subjects.getSpacecrafts(t);for(e=0;e<s.length;e++)if(i=100*s[e].getHullIntegrity(),(void 0!==this._params.minIntegrity&&i<this._params.minIntegrity||void 0!==this._params.maxIntegrity&&i>this._params.maxIntegrity)===this._all)return!this._all;return this._all},c.prototype.getObjectiveString=function(e){var n;return this._params&&void 0!==this._params.maxIntegrity&&void 0===this._params.minIntegrity?(n=t.formatString(s.get(e,this._subjectIsSelf?s.OBJECTIVE.MAX_HULL_INTEGRITY_SELF_SUFFIX.name:this._subjects.isMulti()?this._all?s.OBJECTIVE.MAX_HULL_INTEGRITY_SUFFIX.name:s.OBJECTIVE.MAX_HULL_INTEGRITY_ANY_SUFFIX.name:s.OBJECTIVE.MAX_HULL_INTEGRITY_ONE_SUFFIX.name),{subjects:this._subjects.toString(),maxIntegrity:this._params.maxIntegrity}),n=n.charAt(0).toUpperCase()+n.slice(1)):(i.showError("Hull integrity conditions for mission objectives must specify a maximum and no minimum integrity!"),null)},c.prototype.getObjectiveStateString=function(e){var i,n;return this._subjects.getSpacecrafts()?(n=this._subjects.getLiveSubjectCount(!0)>0?" ("+Math.round(100*(this._all?this._subjects.getMaxHullIntegrity(!0):this._subjects.getMinHullIntegrity(!0)))+"/"+this._params.maxIntegrity+"%)":"",i=t.formatString(s.get(e,this._subjectIsSelf?s.OBJECTIVE.MAX_HULL_INTEGRITY_SELF_SUFFIX.name:s.OBJECTIVE.MAX_HULL_INTEGRITY_SUFFIX.name),{subjects:this._subjects.getShortString()})+n,i=i.charAt(0).toUpperCase()+i.slice(1)):""},c.prototype.getTargetSpacecrafts=function(){return this._ts},c.prototype.getEscortedSpacecrafts=function(){return this._ts},c.prototype.canChangeMultipleTimes=function(){return!0},u.prototype=new r,u.prototype.constructor=u,u.prototype._checkParams=function(e){return this._params=e,this._params&&(this._params.which&&!t.getSafeEnumValue(I,this._params.which)||void 0!==this._params.minIntegrity&&(this._params.minIntegrity<0||this._params.minIntegrity>100)||void 0!==this._params.maxIntegrity&&(this._params.maxIntegrity<0||this._params.maxIntegrity>100))?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,!0)},u.prototype.isSatisfied=function(t){var e,i,s=this._subjects.getSpacecrafts(t);for(e=0;e<s.length;e++)if(i=100*s[e].getShieldIntegrity(),(void 0!==this._params.minIntegrity&&i<this._params.minIntegrity||void 0!==this._params.maxIntegrity&&i>this._params.maxIntegrity)===this._all)return!this._all;return this._all},u.prototype.getObjectiveString=function(){return i.showError("Shield integrity conditions cannot be used as win/lose conditions!"),null},u.prototype.getObjectiveStateString=function(){return i.showError("Shield integrity conditions cannot be used as win/lose conditions!"),null},u.prototype.canChangeMultipleTimes=function(){return!0},_.prototype=new r,_.prototype.constructor=_,_.prototype._checkParams=function(e){return this._params=e,this._params&&(this._params.which&&!t.getSafeEnumValue(I,this._params.which)||void 0!==this._params.minDistance&&this._params.minDistance<=0||void 0!==this._params.maxDistance&&this._params.maxDistance<=0||!this._params.target)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,this._minDistanceSquared=void 0!==this._params.minDistance?this._params.minDistance*this._params.minDistance:0,this._maxDistanceSquared=void 0!==this._params.maxDistance?this._params.maxDistance*this._params.maxDistance:0,this._t=new o({spacecrafts:[this._params.target]}),!0)},_.prototype.isSatisfied=function(t){var i,s,n,o=this._subjects.getSpacecrafts(t),r=t.getSpacecraft(this._params.target);if(this._distanceSquared=0,this._active=!0,!r||!r._alive||r._away)return this._active=!1,this._impossible=!r||!r._alive,this._lastSatisfied=!1;for(s=r.pMo.pM,n=0,i=0;i<o.length;i++)if(!o[i]._alive||o[i]._away){if(this._all)return this._active=!1,this._impossible=!o[i]._alive,this._lastSatisfied=!1;o[i]._alive||n++}else if(this._distanceSquared=e.distanceSquared(o[i].pMo.pM,s),(this._minDistanceSquared>0&&this._distanceSquared<this._minDistanceSquared||this._maxDistanceSquared>0&&this._distanceSquared>this._maxDistanceSquared)===this._all)return this._lastSatisfied=!this._all;return n===o.length?(this._active=!1,this._impossible=!0,this._lastSatisfied=!1):this._lastSatisfied=this._all},_.prototype.getObjectiveString=function(e,n,o){var r;return!this._params||void 0===this._params.minDistance&&void 0===this._params.maxDistance||void 0!==this._params.minDistance&&void 0!==this._params.maxDistance?(i.showError("Distance conditions for mission objectives must specify either a minimum or a maximum distance!"),null):this._subjects.isPilotedSpacecraft(o)||this._t.isPilotedSpacecraft(o)?(r=t.formatString(s.get(e,void 0!==this._params.minDistance?s.OBJECTIVE.DISTANCE_MIN_SUFFIX.name:s.OBJECTIVE.DISTANCE_MAX_SUFFIX.name),{minDistance:t.getLengthString(this._params.minDistance,!0),maxDistance:t.getLengthString(this._params.maxDistance,!0),target:this._t.isPilotedSpacecraft(o)?this._subjects.toString():this._t.toString()}),r=r.charAt(0).toUpperCase()+r.slice(1)):(i.showError("Distance conditions for mission objectives must specify the piloted spacecraft as the only subject or as the target!"),null)},_.prototype.getObjectiveStateString=function(e,i,n,o){var r,a,l,h;return(h=this._t.getSpacecrafts(n))&&this._subjects.getSpacecrafts()?(o&&!this._lastSatisfied&&this._distanceSquared>0?(l=Math.sqrt(this._distanceSquared),a=" ("+t.getLengthString(this._params.minDistance?this._params.minDistance-l:l-this._params.maxDistance,!0)+")"):a="",r=t.formatString(s.get(e,void 0!==this._params.minDistance?s.OBJECTIVE.DISTANCE_MIN_SUFFIX.name:s.OBJECTIVE.DISTANCE_MAX_SUFFIX.name),{target:h[0]===n._pilotedCraft?this._subjects.getShortString():this._t.getShortString()})+a,r=r.charAt(0).toUpperCase()+r.slice(1)):""},_.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},_.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},_.prototype.canBeImpossible=function(){return!0},_.prototype.isImpossible=function(){return this._impossible},_.prototype.isActive=function(){return this._active},_.prototype.canChangeMultipleTimes=function(){return!0},p.prototype=new r,p.prototype.constructor=p,p.prototype._checkParams=function(t){return this._params=t,!0},p.prototype._handleHit=function(t,e){(!t||t.indexOf(e.spacecraft)>=0)&&(this._satisfied=!0)},p.prototype.isSatisfied=function(t,e){var i=this._satisfied;return e>0&&(this._satisfied=!1),i},p.prototype.getObjectiveString=function(){return i.showError("Hit conditions cannot be used as win/lose conditions!"),null},p.prototype.getObjectiveStateString=function(){return i.showError("Hit conditions cannot be used as win/lose conditions!"),null},p.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},p.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},p.prototype.canChangeMultipleTimes=function(){return!0},d.prototype=new r,d.prototype.constructor=d,d.prototype._checkParams=function(t){return this._params=t,!0},d.prototype._handleCollision=function(t,e){(!t||t.indexOf(e.spacecraft)>=0)&&(this._satisfied=!0)},d.prototype.isSatisfied=function(t,e){var i=this._satisfied;return e>0&&(this._satisfied=!1),i},d.prototype.getObjectiveString=function(){return i.showError("Collision conditions cannot be used as win/lose conditions!"),null},d.prototype.getObjectiveStateString=function(){return i.showError("Collision conditions cannot be used as win/lose conditions!"),null},d.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},d.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},d.prototype.canChangeMultipleTimes=function(){return!0},g.prototype=new r,g.prototype.constructor=g,g.prototype._checkParams=function(e){return this._params=e,this._params&&this._params.which&&!t.getSafeEnumValue(I,this._params.which)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,this._away=!this._params||!1!==this._params.away,!0)},g.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t);for(e=0;e<i.length;e++)if(i[e]._away===this._away!==this._all)return!this._all;return this._all},g.prototype.getObjectiveString=function(){return i.showError("Away conditions cannot be used as win/lose conditions!"),null},g.prototype.getObjectiveStateString=function(){return i.showError("Away conditions cannot be used as win/lose conditions!"),null},g.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},g.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},g.prototype.canChangeMultipleTimes=function(){return!0},m.prototype=new r,m.prototype.constructor=m,m.prototype._checkParams=function(e){return this._params=e,this._params&&(this._params.which&&!t.getSafeEnumValue(I,this._params.which)||!this._params.team)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===I.ALL,!0)},m.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t),s=t.getTeam(this._params.team);for(e=0;e<i.length;e++)if(i[e]._team===s!==this._all)return!this._all;return this._all},m.prototype.getObjectiveString=function(){return i.showError("OnTeam conditions cannot be used as win/lose conditions!"),null},m.prototype.getObjectiveStateString=function(){return i.showError("OnTeam conditions cannot be used as win/lose conditions!"),null},m.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},m.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},m.prototype.canChangeMultipleTimes=function(){return!0},f.prototype=new r,f.prototype.constructor=f,f.prototype._checkParams=function(e){return this._params=e,this._params&&this._params.missionStates&&this._params.missionStates.every(function(e){return void 0!==v[t.constantName(e)]})?(this._states=this._params.missionStates.map(function(e){return v[t.constantName(e)]}),!0):(this._handleWrongParams(),!1)},f.prototype.isSatisfied=function(t){var e,i=t._state;for(e=0;e<this._states.length;e++)if(i===this._states[e])return!0;return!1},f.prototype.getObjectiveString=function(){return i.showError("Mission state conditions cannot be used as win/lose conditions!"),null},f.prototype.getObjectiveStateString=function(){return i.showError("Mission state conditions cannot be used as win/lose conditions!"),null},f.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},f.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},f.prototype.canChangeMultipleTimes=function(){return!0},S.prototype=new r,S.prototype.constructor=S,S.prototype._checkParams=function(t){return this._params=t,!0},S.prototype._handleTargeted=function(t,e){(!t||t.indexOf(e.spacecraft)>=0)&&(this._satisfied=!0)},S.prototype.isSatisfied=function(t,e){var i=this._satisfied;return e>0&&(this._satisfied=!1),i},S.prototype.getObjectiveString=function(){return i.showError("GetsTargeted conditions cannot be used as win/lose conditions!"),null},S.prototype.getObjectiveStateString=function(){return i.showError("GetsTargeted conditions cannot be used as win/lose conditions!"),null},S.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},S.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},S.prototype.canChangeMultipleTimes=function(){return!0},T.prototype=new r,T.prototype.constructor=T,T.prototype._checkParams=function(t){return this._params=t,this._all=!this._params||!this._params.which||this._params.which===I.ALL,!0},T.prototype.isSatisfied=function(t){var e,i,s,n=this._subjects.getSpacecrafts(t);if(null===this._by){for(e=0;e<n.length;e++)if(n[e]._tedBy.length>0!==this._all)return!this._all}else for(e=0;e<n.length;e++)for(s=n[e]._tedBy,i=0;i<this._by.length;i++)if(s.indexOf(this._by[i])>=0!==this._all)return!this._all;return this._all},T.prototype.getObjectiveString=function(){return i.showError("IsTargeted conditions cannot be used as win/lose conditions!"),null},T.prototype.getObjectiveStateString=function(){return i.showError("IsTargeted conditions cannot be used as win/lose conditions!"),null},T.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},T.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},T.prototype.canChangeMultipleTimes=function(){return!0},y={},y[M.DESTROYED]=a,y[M.COUNT]=l,y[M.TIME]=h,y[M.HULL_INTEGRITY]=c,y[M.SHIELD_INTEGRITY]=u,y[M.DISTANCE]=_,y[M.HIT]=p,y[M.COLLISION]=d,y[M.AWAY]=g,y[M.ON_TEAM]=m,y[M.MISSION_STATE]=f,y[M.GETS_TARGETED]=S,y[M.IS_TARGETED]=T,{ConditionType:M,ConditionSubjectsWhich:I,CountConditionRelation:C,TimeConditionWhen:A,MissionState:v,SubjectGroup:o,createCondition:E}}),define("armada/logic/missions/actions",["utils/utils","modules/application","modules/game","armada/strings","armada/logic/SpacecraftEvents","armada/logic/ai","armada/logic/missions/conditions","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(e,i){this._type=e?t.getSafeEnumValue(E,e.type,null):null,this._delay=e?e.delay||0:0,this._trigger=i,this._trigger&&this._trigger.addFireHandler(this._addToExecutionQueue.bind(this)),this._subjects=e?new r.SubjectGroup(e.subjects):null,e&&this._checkParams(e.params)}function l(t,e){a.call(this,t,e)}function h(t,e){a.call(this,t,e)}function c(t,e){a.call(this,t,e)}function u(t,e){a.call(this,t,e)}function _(t,e){a.call(this,t,e)}function p(t,e){a.call(this,t,e)}function d(t,e){a.call(this,t,e)}function g(t,e){a.call(this,t,e)}function m(t,e){a.call(this,t,e)}function f(t,e){a.call(this,t,e)}function S(t,e){return new(T[t.type]||a)(t,e)}var T,E={MESSAGE:"message",CLEAR_MESSAGES:"clearMessages",COMMAND:"command",SET_PROPERTIES:"setProperties",REPAIR:"repair",DAMAGE:"damage",HUD:"hud",RADIO_SILENCE:"radioSilence",WIN:"win",LOSE:"lose"};return Object.freeze(E),a.prototype.getType=function(){return this._type},a.prototype._handleWrongParams=function(){e.showError("Wrong parameters specified for action of type: '"+this._type+"'!")},a.prototype._addToExecutionQueue=function(t){this._delay>0?t.queueAction(this,this._delay):this.execute(t)},a.prototype.triggerCanBeImpossible=function(){return this._trigger.canBeImpossible()},l.prototype=new a,l.prototype.constructor=l,l.prototype._checkParams=function(){return!0},l.prototype.execute=function(t){t.completeMission()},l.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!0)},l.prototype.getObjectiveStrings=function(t){return this._trigger.getObjectiveStrings(s.MISSIONS.OBJECTIVE_WIN_PREFIX,!0,t)},l.prototype.getObjectivesState=function(t,e,i,s){return this._trigger.getObjectivesState(!0,t,e,i,s)},h.prototype=new a,h.prototype.constructor=h,h.prototype._checkParams=function(){return!0},h.prototype.execute=function(t){t.failMission()},h.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!1)},h.prototype.getObjectiveStrings=function(t){return this._trigger.getObjectiveStrings(s.MISSIONS.OBJECTIVE_LOSE_PREFIX,!1,t)},h.prototype.getObjectivesState=function(t,e,i,s){return this._trigger.getObjectivesState(!1,t,e,i,s)},c.prototype=new a,c.prototype.constructor=c,c.prototype._checkParams=function(t){return this._params=t,!(!this._params||!this._params.text&&!this._params.textID||void 0!==this._params.text&&"string"!=typeof this._params.text&&"object"!=typeof this._params.text||void 0!==this._params.textID&&"string"!=typeof this._params.textID||void 0!==this._params.source&&"string"!=typeof this._params.source||void 0!==this._params.duration&&"number"!=typeof this._params.duration||void 0!==this._params.typewriter&&"boolean"!=typeof this._params.typewriter||void 0!==this._params.permanent&&"boolean"!=typeof this._params.permanent||void 0!==this._params.urgent&&"boolean"!=typeof this._params.urgent||void 0!==this._params.silent&&"boolean"!=typeof this._params.silent||void 0!==this._params.noBackground&&"boolean"!=typeof this._params.noBackground)&&(void 0===this._params.color||"object"==typeof this._params.color&&this._params.color instanceof Array)||(this._handleWrongParams(),!1)},c.prototype.execute=function(e){var n;this._params.source&&!(n=e.getSpacecraft(this._params.source))||i.getScreen().queueHUDMessage({text:s.get(s.MISSION.PREFIX,t.getFilenameWithoutExtension(e._name)+s.MISSION.MESSAGES_SUFFIX.name+this._params.textID,"object"==typeof this._params.text?this._params.text[s.getLanguage()]:this._params.text),duration:this._params.duration,appearAnimation:!1!==this._params.typewriter,permanent:this._params.permanent,color:this._params.color,silent:this._params.silent,noBackground:this._params.noBackground,source:n,id:this._params.textID},this._params.urgent)},c.prototype.getMessageParams=function(){return this._params},u.prototype=new a,u.prototype.constructor=u,u.prototype._checkParams=function(){return!0},u.prototype.execute=function(){i.getScreen().clearHUDMessages()},_.prototype=new a,_.prototype.constructor=_,_.prototype.getSpacecrafts=function(t){return this._subjects.getSpacecrafts(t,!0)},_.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.command&&"string"!=typeof this._params.command)||(this._handleWrongParams(),!1)},_.prototype.execute=function(t){var e,i=this._subjects.getSpacecrafts(t,!0);if(i.length>0)for(this._params.lead=i[0],this._params.clearCache=!0,e=0;e<i.length;e++)this._params.index=e,i[e].handleEvent(n.COMMAND_RECEIVED,this._params)},p.prototype=new a,p.prototype.constructor=p,p.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100)||void 0!==this._params.team&&"string"!=typeof this._params.team||void 0!==this._params.disableFiring&&"boolean"!=typeof this._params.disableFiring)||(this._handleWrongParams(),!1)},p.prototype.execute=function(t){var e,i,s=!1,n=this._subjects.getSpacecrafts(t,!0);if(void 0!==this._params.team&&(i=t.getTeam(this._params.team)),n.length>0)for(e=0;e<n.length;e++)void 0!==this._params.hull&&n[e].setHullIntegrity(.01*this._params.hull),void 0!==this._params.shield&&n[e].setShieldIntegrity(.01*this._params.shield),i&&(i.addSpacecraft(n[e]),s=!0),!0===this._params.disableFiring?n[e].disableFiring():!1===this._params.disableFiring&&n[e].enableFiring();s&&t.handleTeamsChanged()},d.prototype=new a,d.prototype.constructor=d,d.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100))||(this._handleWrongParams(),!1)},d.prototype.execute=function(t){var e,i=this._subjects.getSpacecrafts(t,!0);if(i.length>0)for(e=0;e<i.length;e++)void 0!==this._params.hull&&i[e].setHullIntegrity(i[e].getHullIntegrity()+.01*this._params.hull),void 0!==this._params.shield&&i[e].setShieldIntegrity(i[e].getShieldIntegrity()+.01*this._params.shield)},g.prototype=new a,g.prototype.constructor=g,g.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100))||(this._handleWrongParams(),!1)},g.prototype.execute=function(t){var e,i=this._subjects.getSpacecrafts(t,!0);if(i.length>0)for(e=0;e<i.length;e++)void 0!==this._params.hull&&i[e].setHullIntegrity(i[e].getHullIntegrity()-.01*this._params.hull),void 0!==this._params.shield&&i[e].setShieldIntegrity(i[e].getShieldIntegrity()-.01*this._params.shield)},m.prototype=new a,m.prototype.constructor=m,m.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.state&&"string"!=typeof this._params.state)||(this._handleWrongParams(),!1)},m.prototype.execute=function(t){var e=t._pilotedCraft;e&&e.handleEvent(n.HUD,this._params)},f.prototype=new a,f.prototype.constructor=f,f.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0===this._params.silence||"boolean"!=typeof this._params.silence)||(this._handleWrongParams(),!1)},f.prototype.execute=function(t){var e;e=this._subjects.isEmpty()?null:this._subjects.getSpacecrafts(t,!0),o.setRadioSilenceForSpacecrafts(this._params.silence,e)},T={},T[E.WIN]=l,T[E.LOSE]=h,T[E.MESSAGE]=c,T[E.CLEAR_MESSAGES]=u,T[E.COMMAND]=_,T[E.SET_PROPERTIES]=p,T[E.REPAIR]=d,T[E.DAMAGE]=g,T[E.HUD]=m,T[E.RADIO_SILENCE]=f,{ActionType:E,createAction:S}}),define("armada/logic/missions/events",["utils/utils","modules/application","armada/strings","armada/logic/missions/conditions","armada/logic/missions/actions","utils/polyfill"],function(t,e,i,s,n){"use strict";function o(i,n){var o,r,a;if(this._conditions=null,
i.conditions&&i.conditions.length>0)for(this._conditions=[],o=0;o<i.conditions.length;o++)this._conditions.push(s.createCondition(i.conditions[o],n));if(a=t.getSafeEnumValue(l,i.which,l.ALL),this._all=a===l.ALL,r=t.getSafeEnumValue(h,i.when,h.BECOMES_TRUE),this._falsy=r===h.BECOMES_FALSE,this._all||(this._falsy=!this._falsy),this._once=!0,void 0!==i.once)this._once=i.once;else if(this._conditions)for(o=0;o<this._conditions.length;o++)if(this._conditions[o].canChangeMultipleTimes()){this._once=!1;break}if(this._delay=i.delay||0,this._countDown=!1,this._onFireHandlers=[],this._previousConditionState=!1,this._fired=!1,this._canBeImpossible=!0,this._objectiveState=null,this._conditions)for(this._objectiveState=new Array(this._conditions.length),o=0;o<this._conditions.length;o++)this._objectiveState[o]=c.IN_PROGRESS;if(!this._falsy&&this._conditions)for(this._canBeImpossible=!this._all,o=0;o<this._conditions.length;o++)if(this._conditions[o].canBeImpossible()){this._canBeImpossible=this._all;break}this._conditions||this._once||(e.showError("A trigger has no conditions, 'once' cannot be set to false!"),this._once=!0),!this._once&&this._delay&&(e.showError("Triggers without 'once' cannot have delays!"),this._delay=0)}function r(t,e){var i;for(this._name=t.name,this._trigger=new o(t.trigger,e),this._actions=[],i=0;i<t.actions.length;i++)this._actions.push(n.createAction(t.actions[i],this._trigger))}var a=s.MissionState,l={ALL:"all",ANY:"any"},h={BECOMES_TRUE:"becomesTrue",BECOMES_FALSE:"becomesFalse"},c={IN_PROGRESS:0,COMPLETED:1,FAILED:2};return Object.freeze(l),Object.freeze(h),Object.freeze(c),o.prototype.addFireHandler=function(t){this._onFireHandlers.push(t)},o.prototype.fire=function(t){var e;if(this._delay>0)return void(this._countDown=!0);for(e=0;e<this._onFireHandlers.length;e++)this._onFireHandlers[e](t);this._fired=!0},o.prototype.hasFired=function(){return this._fired},o.prototype.simulate=function(t,e){var i,s;if(this._once){if(this._fired)return;if(this._countDown)return this._delay-=e,void(this._delay<=0&&this.fire(t))}if(!this._conditions)return void this.fire(t);for(i=this._all,s=0;s<this._conditions.length;s++)this._conditions[s].isSatisfied(t,e)===this._falsy&&(i=!this._all);!1===this._previousConditionState&&!0===i&&this.fire(t),this._previousConditionState=i},o.prototype.getObjectiveCount=function(t){return t?this._conditions.length:1},o.prototype.getObjectiveStrings=function(t,i,s){var n,o,r,a=[];if(!this._conditions)return e.showError("Win and lose events must have conditions!"),null;if(!this._all)return e.showError("Triggers for mission objectives must be set to 'which' = '"+l.ALL+"'!"),null;if(this._falsy)return e.showError("Triggers for mission objectives must be set to 'when' = '"+h.BECOMES_TRUE+"'!"),null;if(o=this._conditions.length>1,i)for(n=0;n<this._conditions.length;n++)a.push(this._conditions[n].getObjectiveString(t,o,s));else{for(r="",n=0;n<this._conditions.length;n++)r+=(n>0?" ":"")+this._conditions[n].getObjectiveString(t,o,s);a.push(r)}return a},o.prototype.getObjectivesState=function(t,e,s,n,o){var r,l,h,u,_=this._conditions.length>1;if(t)for(r=0;r<this._conditions.length;r++)this._objectiveState[r]===c.IN_PROGRESS&&(this._objectiveState[r]=this._conditions[r].isSatisfied(e,0)?this._conditions[r].canBeImpossible()&&!s?e._state===a.COMPLETED?c.COMPLETED:c.IN_PROGRESS:c.COMPLETED:this._conditions[r].isImpossible()?c.FAILED:c.IN_PROGRESS),(this._objectiveState[r]!==c.IN_PROGRESS||this._conditions[r].isActive()||s)&&(n[o].text=this._conditions[r].getObjectiveStateString(i.BATTLE.OBJECTIVE_WIN_PREFIX,_,e,this._objectiveState[r]===c.IN_PROGRESS),n[o].state=this._objectiveState[r],n[o].completable=!0,o++);else if(this._conditions.length>0){for(l=!0,h=!1,r=0;r<this._conditions.length;r++)if(!this._conditions[r].isSatisfied(e,0)&&(l=!1,this._conditions[r].isImpossible())){h=!0;break}if(this._objectiveState[0]!==c.FAILED&&(this._objectiveState[0]=l?c.FAILED:h||s||e._state===a.COMPLETED?c.COMPLETED:c.IN_PROGRESS),u=this._conditions[0].getObjectiveStateString(i.BATTLE.OBJECTIVE_LOSE_PREFIX,_,e,this._objectiveState[0]===c.IN_PROGRESS),this._objectiveState[0]===c.IN_PROGRESS)for(r=1;r<this._conditions.length;r++)this._conditions[r].isActive()&&(u+=" "+this._conditions[r].getObjectiveStateString(i.BATTLE.OBJECTIVE_LOSE_PREFIX,_,e,!0));u&&(n[o].text=u,n[o].state=this._objectiveState[0],n[o].completable=this._canBeImpossible,o++)}return o},o.prototype.getTargetSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getTargetSpacecrafts(t));return i},o.prototype.getEscortedSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getEscortedSpacecrafts(t));return i},o.prototype.canBeImpossible=function(){return this._canBeImpossible},r.prototype.getActions=function(){return this._actions},r.prototype.getMessageParams=function(){var t,e,i=[];for(t=0;t<this._actions.length;t++)this._actions[t].getType()===n.ActionType.MESSAGE&&(e=this._actions[t].getMessageParams())&&i.push(e);return i},r.prototype.simulate=function(t,e){this._trigger.simulate(t,e)},{TriggerWhen:h,TriggerWhich:l,MissionState:a,ObjectiveState:c,MissionEvent:r}}),define("armada/logic/missions",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/resource-manager","modules/media-resources","modules/pools","modules/egom-model","modules/physics","modules/scene/camera","modules/scene/renderable-objects","armada/constants","armada/control","armada/graphics","armada/networking","armada/logic/classes","armada/configuration","armada/strings","armada/logic/constants","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","armada/logic/equipment","armada/logic/formations","armada/logic/explosion","armada/logic/ai","armada/logic/missions/actions","armada/logic/missions/events","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T,E,y,M,I,C,A,v,N,O,L){"use strict";function R(t,e){return t._indexInSquad-e._indexInSquad}function b(e){var i,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T=[],E={};for(i=0;i<e.length;i++)if(e[i].count){for(r=e[i].squad,E[r]=E[r]||0,a=e[i].names,l=e[i].loadouts,h=e[i].pilotedIndex,c=e[i].positions,u=e[i].formation,_=s.rotation4FromJSON(e[i].rotations),p=e[i].initialBlinkTime,d=e[i].initialBlinkTimeDelta,g=e[i].aiParams?e[i].aiParams.voices:null,m=t.deepCopy(e[i]),delete m.count,delete m.names,delete m.loadouts,delete m.pilotedIndex,delete m.positions,delete m.formation,m.aiParams&&delete m.aiParams.voices,o=0;o<e[i].count;o++)f=t.deepCopy(m),r&&(f.squad=r+" "+(E[r]+o+1).toString()),a&&(f.name=a[o]),l&&(f.loadout=l[o%l.length]),h===o+1&&(f.piloted=!0,delete f.ai),c&&(f.position=c[o]),u&&(c&&n.showError("Both positions and formation have been defined for spacecraft group - formation will be used!",n.ErrorSeverity.MINOR),f.position=A.getPositionInFormation(u,o,f.position,_)),void 0!==p&&(f.initialBlinkTime=p+o*(d||0)),g&&(f.aiParams.voice=g[o%g.length]),T.push(f);E[r]+=e[i].count}else e[i].squad?(r=I.getSquadName(e[i].squad),S=I.getSquadIndex(e[i].squad),S>0?(S<=E[r]&&n.showError("Spacecraft "+e[i].squad+" defined after squad "+r+" already having "+E[r]+" defined members!",n.ErrorSeverity.MINOR),E[r]=S,T.push(e[i])):(E[r]=E[r]||0,f=t.deepCopy(e[i]),f.squad=r+" "+(E[r]+1).toString(),E[r]+=1,T.push(f))):T.push(e[i]);return T}function x(t){this._name=null,this._faction=null,this._displayNameReplacements={index:-1},this._color=null,"string"==typeof t?(this._name=t,this._faction=t):"object"==typeof t?(this._name=t.name||t.faction||n.showError("Team defined without a name or faction!"),this._faction=t.faction,this._displayNameReplacements.index=t.index,this._color=t.color||null):n.showError("Invalid parameter specified for Team constructor!"),this._initialCount=0,this._squads=[]}function D(t,e,i,s){this._objects=t,this._centerX=0,this._centerY=0,this._centerZ=0,this._boundaries=null,this._objects.length>0&&this._calculateCenter(s),this._subnodes=e>0&&this._objects.length>i?this._generateSubnodes(e-1,i):null}function w(t){this._name=t,this._dataJSON=null,this._nextMissionName=null,this._environment=null,this._grids=null,this._markers=null,this._ownsEnvironment=!1,this._anticipationTheme=null,this._combatTheme=null,this._views=null,this._teams=null,this._events=null,this._actionQueue=null,this._winActions=null,this._loseActions=null,this._scs=null,this._pilotedCraft=null,this._hitObjects=null,this._state=z.NONE,this._defaultObjective=!0,this._objectivesState=null,this._referenceScore=0,this._tSpacecrafts=null,this._escortedSpacecrafts=null,this._difficultyLevel=null,this._onTeamsChanged=null,this._initialTeamMission=!1}function P(t,e){r.JSONResource.call(this,t,e,!0),this._test=!0===this._dataJSON.test,this._custom=!0===this._dataJSON.custom,this._pilotedSpacecraftDescriptor=null,this._localData=JSON.parse(localStorage[this._getLocalStorageID()]||"{}"),this._initLocalData()}function V(t){this._name=t.name,this._playerHitpointsFactor=t.playerHitpointsFactor,this._friendlyHitpointsFactor=t.friendlyHitpointsFactor,this._enemyReactionTimeFactor=t.enemyReactionTimeFactor,this._playerSelfDamage=t.playerSelfDamage,this._playerFriendlyFireDamage=t.playerFriendlyFireDamage,this._hitboxOffset=t.hitboxOffset}function F(t){this._name=t.name,this._referenceBaseScoreFactor=t.referenceBaseScoreFactor,this._referenceHitRatio=t.referenceHitRatio,this._referenceHullIntegrity=t.referenceHullIntegrity,this._referenceTeamSurvival=t.referenceTeamSurvival}function U(){o.AsyncResource.call(this),this._difficulty=null,this._difficultyLevels=null,this._missionPerformanceLevels=null,this._tipIDs=null,this._missionManager=new r.ResourceManager}var B,H,G,k,j,W,Y,X,z=L.MissionState,q=L.ObjectiveState,J=p.LOCAL_STORAGE_PREFIX+"missions_",Q=J+"difficulty",K=null;return x.prototype.getDisplayName=function(){return t.formatString(T.get(T.FACTION.PREFIX,this._faction,this._faction||this._name),this._displayNameReplacements)},x.prototype.addSpacecraft=function(t){var e,i,s=t._team,o=t._squad;if(s&&s._removeSpacecraft(t),t._team=this,o){for(e=0;e<this._squads.length;e++)if(o===this._squads[e].name){this._squads[e].crafts.push(t),this._squads[e].crafts.sort(R);break}e>=this._squads.length&&this._squads.push({name:o,crafts:[t]}),i=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,this._squads[e].crafts.length>i&&n.showError("Warning: squad '"+o+"' of team '"+this._name+"' has more than "+i+" members, and thus cannot be displayed correctly in the wingmen status panel!")}this._initialCount++},x.prototype._removeSpacecraft=function(t){var e,i,s=t._squad;if(s)for(e=0;e<this._squads.length;e++)if(s===this._squads[e].name){i=this._squads[e].crafts.indexOf(t),this._squads[e].crafts.splice(i,1),0===this._squads[e].crafts.length&&this._squads.splice(e,1);break}this._initialCount--},D.prototype._calculateCenter=function(t){var e,i,s,n,o=0,r=0,a=0;for(t&&(s=this._objects[0].pMo.pM,n=this._objects[0].pMo.getSize(),this._boundaries=[s[0]-n,s[0]+n,s[1]-n,s[1]+n,s[2]-n,s[2]+n]),e=0,i=this._objects.length;e<i;e++)s=this._objects[e].pMo.pM,o+=s[12],r+=s[13],a+=s[14],t&&(n=this._objects[e].pMo.getSize(),s[12]-n<this._boundaries[0]&&(this._boundaries[0]=s[12]-n),s[12]+n>this._boundaries[1]&&(this._boundaries[1]=s[12]+n),s[13]-n<this._boundaries[2]&&(this._boundaries[2]=s[13]-n),s[13]+n>this._boundaries[3]&&(this._boundaries[3]=s[13]+n),s[14]-n<this._boundaries[4]&&(this._boundaries[4]=s[14]-n),s[14]+n>this._boundaries[5]&&(this._boundaries[5]=s[14]+n));o/=i,r/=i,a/=i,this._centerX=o,this._centerY=r,this._centerZ=a},D.prototype._generateSubnodes=function(e,i){var s,n,o,r,a,l,h,c,u,_,p,d,g,m;for(s=0,n=this._objects.length;s<n;s++)r=this._objects[s],a=r.pMo.pM,o=r.pMo.getSize(),a[12]-o<this._centerX&&(a[13]-o<this._centerY&&(a[14]-o<this._centerZ&&(l=l||[],l.push(r)),a[14]+o>=this._centerZ&&(h=h||[],h.push(r))),a[13]+o>=this._centerY&&(a[14]-o<this._centerZ&&(c=c||[],c.push(r)),a[14]+o>=this._centerZ&&(u=u||[],u.push(r)))),a[12]+o>=this._centerX&&(a[13]-o<this._centerY&&(a[14]-o<this._centerZ&&(_=_||[],_.push(r)),a[14]+o>=this._centerZ&&(p=p||[],p.push(r))),a[13]+o>=this._centerY&&(a[14]-o<this._centerZ&&(d=d||[],d.push(r)),a[14]+o>=this._centerZ&&(g=g||[],g.push(r))));return m=new Array(8),m[0]=new D(l||t.EMPTY_ARRAY,e,i,!1),m[1]=new D(h||t.EMPTY_ARRAY,e,i,!1),m[2]=new D(c||t.EMPTY_ARRAY,e,i,!1),m[3]=new D(u||t.EMPTY_ARRAY,e,i,!1),m[4]=new D(_||t.EMPTY_ARRAY,e,i,!1),m[5]=new D(p||t.EMPTY_ARRAY,e,i,!1),m[6]=new D(d||t.EMPTY_ARRAY,e,i,!1),m[7]=new D(g||t.EMPTY_ARRAY,e,i,!1),m},D.prototype.executeForObjects=function(t,e,i,s,n,o,r){var a;if(!this._subnodes){for(a=0;a<this._objects.length;a++)if(r(this._objects[a]))return!0;return!1}if(this._boundaries&&(e<this._boundaries[0]||t>this._boundaries[1]||s<this._boundaries[2]||i>this._boundaries[3]||o<this._boundaries[4]||n>this._boundaries[5]))return!1;if(t<this._centerX){if(i<this._centerY){if(n<this._centerZ&&this._subnodes[0].executeForObjects(t,e,i,s,n,o,r))return!0;if(o>=this._centerZ&&this._subnodes[1].executeForObjects(t,e,i,s,n,o,r))return!0}if(s>=this._centerY){if(n<this._centerZ&&this._subnodes[2].executeForObjects(t,e,i,s,n,o,r))return!0;if(o>=this._centerZ&&this._subnodes[3].executeForObjects(t,e,i,s,n,o,r))return!0}}if(e>=this._centerX){if(i<this._centerY){if(n<this._centerZ&&this._subnodes[4].executeForObjects(t,e,i,s,n,o,r))return!0;if(o>=this._centerZ&&this._subnodes[5].executeForObjects(t,e,i,s,n,o,r))return!0}if(s>=this._centerY){if(n<this._centerZ&&this._subnodes[6].executeForObjects(t,e,i,s,n,o,r))return!0;if(o>=this._centerZ&&this._subnodes[7].executeForObjects(t,e,i,s,n,o,r))return!0}}return!1},w.prototype.getData=function(){return this._dataJSON},w.prototype.getId=function(){return this._dataJSON.id},w.prototype.getTitle=function(){return this._title},w.prototype.getNextMissionName=function(){return this._nextMissionName},w.prototype.getAnticipationTheme=function(){return this._anticipationTheme},w.prototype.getCombatTheme=function(){return this._combatTheme},w.prototype.getSpacecraft=function(t){var e;for(e=0;e<this._scs.length;e++)if(this._scs[e].getID()===t)return this._scs[e];return null},w.prototype.getSpacecrafts=function(){return this._scs},w.prototype.getSpacecraftsInSquad=function(t){var e,i=[];for(e=0;e<this._scs.length;e++)this._scs[e]._squad===t&&i.push(this._scs[e]);return i},w.prototype.applyToSpacecrafts=function(t){var e;for(e=0;e<this._scs.length;e++)t(this._scs[e])},w.prototype.isFinished=function(){return this._state===z.COMPLETED||this._state===z.FAILED||this._state===z.DEFEAT||this._state===z.ENDED},w.prototype.getTargetSpacecrafts=function(){return this._tSpacecrafts},w.prototype.getEscortedSpacecrafts=function(){return this._escortedSpacecrafts},w.prototype.getDifficultyLevel=function(){return this._difficultyLevel},w.prototype.getMessageParams=function(){var t,e=[];for(t=0;t<this._events.length;t++)e=e.concat(this._events[t].getMessageParams());return e},w.prototype.completeMission=function(){this._state===z.IN_PROGRESS&&(this._state=z.COMPLETED)},w.prototype.failMission=function(){this._state!==z.IN_PROGRESS&&this._state!==z.COMPLETED||!this._pilotedCraft||this._pilotedCraft._away||(this._state=z.FAILED)},w.prototype._updateState=function(){var t,e;if(this._pilotedCraft){if(this._pilotedCraft._away||this._updateObjectivesState(),!this._pilotedCraft._alive)return void(this._state=z.DEFEAT);if(this._state===z.BATTLE){for(t=0;t<this._scs.length;t++)if(this._scs[t]&&this._scs[t]._alive&&this._pilotedCraft.isHostile(this._scs[t]))return;return void(this._state=z.COMPLETED)}if(this._state===z.IN_PROGRESS&&!this._pilotedCraft._away){for(e=!0,t=0;t<this._objectivesState.length;t++){if(this._objectivesState[t].state===q.FAILED)return void(this._state=z.FAILED);e=e&&(this._objectivesState[t].state===q.COMPLETED||!this._objectivesState[t].completable)&&this._objectivesState[t].text}if(e)return void(this._state=z.COMPLETED)}}else if(this._state===z.BATTLE&&this.noHostilesPresent())return void(this._state=z.ENDED)},w.prototype.noHostilesPresent=function(){var t,e,i=null;for(t=0;t<this._scs.length;t++)if(this._scs[t]&&this._scs[t]._alive){if((e=this._scs[t]._team)&&i&&e!==i)return!1;i=e}return!0},w.prototype.getSpacecraftCountForTeam=function(t){var e,i=0;for(e=0;e<this._scs.length;e++)this._scs[e]&&this._scs[e]._alive&&this._scs[e]._team===t&&i++;return i},w.prototype.getHostileSpacecraftCount=function(t,e){var i,s=0;for(i=0;i<this._scs.length;i++)!this._scs[i]||!this._scs[i]._alive||e&&this._scs[i]._away||this._scs[i].isHostile(t)&&s++;return s},w.prototype.getFollowedSpacecraftForScene=function(t){var e,i;if(t._camera.getFollowedNode())for(e=t._camera.getFollowedNode()._renderableObject,i=0;i<this._scs.length;i++)if(this._scs[i].vMo===e)return this._scs[i];return null},w.prototype.getEnvironment=function(){return this._environment},w.prototype.getTeam=function(t){var e;for(e=0;e<this._teams.length;e++)if(this._teams[e]._name===t)return this._teams[e];return n.showError("No team exists with name '"+t+"'!"),null},w.prototype.getEvent=function(t){var e;for(e=0;e<this._events.length;e++)if(this._events[e]._name===t)return this._events[e];return n.showError("No mission event exists with name '"+t+"'!"),null},w.prototype.getObjectives=function(){var t,e=[];for(this._defaultObjective&&e.push(T.get(T.MISSIONS.OBJECTIVE_WIN_PREFIX,T.OBJECTIVE.DESTROY_ALL_SUFFIX.name)),t=0;t<this._winActions.length;t++)e=e.concat(this._winActions[t].getObjectiveStrings(this));for(t=0;t<this._loseActions.length;t++)e=e.concat(this._loseActions[t].getObjectiveStrings(this));return e},w.prototype.getObjectivesState=function(t){return t&&this._updateObjectivesState(t),this._objectivesState},w.prototype._updateObjectivesState=function(t){var e,i,s,n,o=0;for(this._defaultObjective&&(n=this._pilotedCraft,i="",n&&(s=this.getHostileSpacecraftCount(n,!0))>0&&(i=" ("+s+")"),this._objectivesState[0].text=T.get(T.BATTLE.OBJECTIVE_WIN_PREFIX,T.OBJECTIVE.DESTROY_ALL_SUFFIX.name)+i,this._objectivesState[0].state=n&&n._alive?this.getHostileSpacecraftCount(n,!1)>0?q.IN_PROGRESS:q.COMPLETED:q.FAILED,this._objectivesState[0].completable=!0,o++),e=0;e<this._winActions.length;e++)o=this._winActions[e].getObjectivesState(this,t,this._objectivesState,o);for(e=0;e<this._loseActions.length;e++)o=this._loseActions[e].getObjectivesState(this,t,this._objectivesState,o);for(;o<this._objectivesState.length;)this._objectivesState[o].text="",o++},w.prototype.loadEnvironment=function(t){"string"==typeof t.environment?(this._environment=y.getEnvironment(t.environment),this._environment||n.showError("Cannot load environment '"+t.environment+"' for mission: no such environment exists!"),this._ownsEnvironment=!1):"object"==typeof t.environment?(this._environment=new y.Environment(t.environment),this._ownsEnvironment=!0):n.showError("Invalid environment specified for mission!")},w.prototype.loadObjectives=function(t){var e,i,s,n,o,r;if(!this._scs)for(this._scs=[],r=b(t.spacecrafts),e=0;e<r.length;e++)if(r[e].piloted){this._pilotedCraft=new I.Spacecraft,this._pilotedCraft.loadFromJSON(r[e]),this._scs.push(this._pilotedCraft);break}if(this._events=[],t.events)for(e=0;e<t.events.length;e++)this._events.push(new L.MissionEvent(t.events[e],this));for(this._actionQueue=[],this._state=z.NONE,this._winActions=[],this._loseActions=[],e=0;e<this._events.length;e++)for(s=this._events[e].getActions(),i=0;i<s.length;i++)n=s[i].getType(),n===O.ActionType.WIN?this._winActions.push(s[i]):n===O.ActionType.LOSE&&this._loseActions.push(s[i]);if(this._defaultObjective=0===this._winActions.length,this._defaultObjective)for(e=0;e<this._loseActions.length;e++)if(this._loseActions[e].triggerCanBeImpossible()){this._defaultObjective=!1;break}if(o=this._defaultObjective?1:0,this._pilotedCraft){for(e=0;e<this._winActions.length;e++)o+=this._winActions[e].getObjectiveCount();for(e=0;e<this._loseActions.length;e++)o+=this._loseActions[e].getObjectiveCount()}for(this._objectivesState=new Array(o),e=0;e<o;e++)this._objectivesState[e]={};(this._winActions.length>0||this._loseActions.length>0)&&(this._state=z.IN_PROGRESS)},w.prototype.queueAction=function(t,e){this._actionQueue.push({action:t,delay:e})},w.prototype.getReferenceScore=function(){return this._referenceScore},w.prototype.hasShadows=function(){return this._environment.hasShadows()},w.prototype.loadFromJSON=function(t,e){var i,s,o,r,a,l,h,u,_,p,g,m;if(this._difficultyLevel=X.getDifficultyLevel(e.difficulty),C.handleDifficultySet(this._difficultyLevel),A.resetRandomSeed(),this._dataJSON=t,this._title=t.title||"",this._nextMissionName=t.nextMission||null,this.loadEnvironment(t),c.setDrag(this._environment.getDrag(),this._environment._angularDrag),this._anticipationTheme=t.anticipationTheme,this._combatTheme=t.combatTheme,this._teams=[],t.teams)for(i=0;i<t.teams.length;i++)this._teams.push(new x("string"==typeof t.teams[i]?t.teams[i]:Object.assign({index:(i+1).toString()},t.teams[i])));if(this._views=[],t.views)for(i=0;i<t.views.length;i++)this._views.push(new f.SceneView(t.views[i]));for(this._scs=[],this._hitObjects=[],N.clearAIs(),p=b(t.spacecrafts),i=0;i<p.length;i++)o=new I.Spacecraft,p[i].piloted?(m=Object.assign({},p[i]),e.pilotedSpacecraftClass&&(m.class=e.pilotedSpacecraftClass),e.pilotedSpacecraftLoadout&&(m.loadout=e.pilotedSpacecraftLoadout,m.equipment=void 0)):m=p[i],o.loadFromJSON(m,this._hitObjects,this._environment),!e.demoMode&&p[i].piloted&&(this._pilotedCraft=o,o.multiplyMaxHitpoints(this._difficultyLevel._playerHitpointsFactor),g=function(t,e){d.getInputInterpreter(d.GAMEPAD_NAME).vibrate(t.getHullIntegrity()<=0?"destroyed":e.hullDamage>0?"hull-hit":"shield-hit")}.bind(this,o),o.addEventHandler(M.BEING_HIT,g),o.addEventHandler(M.COLLIDED,g)),p[i].multi&&(o.setAsMultiControlled(p[i].piloted,i),!p[i].piloted&&p[i].multiPiloted&&o.multiplyMaxHitpoints(this._difficultyLevel._playerHitpointsFactor)),o._piloted=!!p[i].piloted||!!p[i].multiPiloted,r=p[i].team,r?(a=this.getTeam(r),a?a.addSpacecraft(o):n.showError("Invalid team ID '"+r+"' specified for "+o.getClassName()+"!")):e.demoMode&&(a=new x({faction:"numbered",index:(this._teams.length+1).toString()}),this._teams.push(a),o._team=a),this._scs.push(o);for(this._referenceScore=0,this._initialTeamMission=!1,a=this._pilotedCraft&&this._pilotedCraft._team,u=1,_=this._difficultyLevel._friendlyHitpointsFactor,i=0;i<p.length;i++)o=this._scs[i],p[i].initialTarget&&o.setTarget(this.getSpacecraft(p[i].initialTarget)),this._pilotedCraft&&(!p[i].excludeFromReferenceScore&&this._pilotedCraft.isHostile(o)&&(this._referenceScore+=o.getScoreValue()),this._pilotedCraft.isFriendly(o)&&o!==this._pilotedCraft&&(p[i].multiPiloted||o.multiplyMaxHitpoints(_),(o.hasWeapons()||o.hasMissiles())&&(this._initialTeamMission=!0,u++))),l=p[i].ai,!l&&e.demoMode&&(l=o.isFighter()?"fighter":"ship"),l&&N.addAI(l,o,this,p[i].aiParams);for(u>1&&(this._referenceScore/=u),this.loadObjectives(t),this._tSpacecrafts=[],i=0;i<this._events.length;i++)for(h=this._events[i].getActions(),s=0;s<h.length;s++)h[s].getType()===O.ActionType.WIN&&(this._tSpacecrafts=this._tSpacecrafts.concat(this._events[i]._trigger.getTargetSpacecrafts(this)));for(this._escortedSpacecrafts=[],i=0;i<this._events.length;i++)for(h=this._events[i].getActions(),s=0;s<h.length;s++)h[s].getType()===O.ActionType.LOSE&&(this._escortedSpacecrafts=this._escortedSpacecrafts.concat(this._events[i]._trigger.getEscortedSpacecrafts(this)));this._pilotedCraft||(this._state=z.NONE),this._state!==z.NONE||this.noHostilesPresent()||(this._state=z.BATTLE)},w.prototype.isTeamMission=function(){return this._pilotedCraft&&this._pilotedCraft._team&&this._pilotedCraft._team._initialCount>1},w.prototype.isInitialTeamMission=function(){return this._initialTeamMission},w.prototype.getScoreStatistics=function(t,e,i,s,n){var o,r,a,l,h=this.isTeamMission();return t=Math.round(t),o=Math.round((t||0)*(e||.5*(n||0))),r=Math.round(i*(h?100:200)),h&&(a=Math.round(100*s)),l=t+o+r+(h?a:0),{baseScore:t,hitRatioBonus:o,hullIntegrityBonus:r,teamSurvivalBonus:a,score:l}},w.prototype.getPerformanceStatistics=function(){var t=this._pilotedCraft,e=this.isTeamMission(),i=e?(this.getSpacecraftCountForTeam(t._team)-(t._alive?1:0))/(t._team._initialCount-1):0,s=this.getScoreStatistics(t.getScore(),t.getHitRatio(),t.getHullIntegrity(),i,t.getMissileHitRatio()),n=X.getPerformanceInfo(this,s.score);return{baseScore:s.baseScore,hitRatioBonus:s.hitRatioBonus,hullIntegrityBonus:s.hullIntegrityBonus,teamSurvival:e?i:void 0,teamSurvivalBonus:s.teamSurvivalBonus,score:s.score,performance:n.performance,nextPerformance:n.nextPerformance,nextPerformanceScore:n.nextPerformanceScore}},w.prototype.getPerformanceLevelScores=function(){return X.getPerformanceLevelScores(this)},w.prototype.createCameraConfigurationForSceneView=function(t,e){var i,n,o=s.getYawAndPitch(t.oM);return i=new u.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),s.copy(t.pM),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new u.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),s.copy(t.oM),Math.degrees(o.yaw),Math.degrees(o.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||S.getDefaultCameraBaseOrientation(),t.getPointToFallback()||S.getDefaultCameraPointToFallback()),new u.CameraConfiguration(t._name,i,n,t.getFOV()||S.getDefaultCameraFOV(),t.getFOVRange(),t.getSpan()||S.getDefaultCameraSpan(),t.resetsOnFocusChange())},w.prototype._handleSpacecraftJumpIn=function(t){this._hitObjects.indexOf(t)<=0&&this._hitObjects.push(t)},w.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxProjectileCount();return e},w.prototype.getMaxMissileCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxMissileCount();return e},w.prototype.getMaxExplosionCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxExplosionCount();return e},w.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxParticleCount();return e},w.prototype.addToScene=function(t,e,i){var s,n=!!i;for(this._environment.addToScene(t),this._scs.length,0,s=0;s<this._scs.length;s++)this._scs[s].addToScene(t,void 0,n,{hitboxes:!1,weapons:!0,missilesInLaunchers:g.areMissilesInLaunchersVisible(),thrusterParticles:!n,thrusterLightSources:!n&&g.shouldCreateLightSourcesForThrusters(),projectileResources:!n,missileResources:!n,explosion:!n,damageIndicators:!n,cameraConfigurations:!n,lightSources:!n,blinkers:!n,jumpEngine:!n,shield:!n,sound:!n},{replaceVisualModel:n,randomAnimationTime:!0,smallestSizeWhenDrawn:void 0,shaderName:null,skipTextures:n},null),e&&this._scs[s].addToScene(e,g.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:"oneColorFaded"}),this._scs[s]._away?this._scs[s].addEventHandler(M.JUMPED_IN,this._handleSpacecraftJumpIn.bind(this,this._scs[s])):this._hitObjects.push(this._scs[s]);a.executeWhenReady(function(){if(this._views.length>0)for(s=0;s<this._views.length;s++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[s],t)),0===s&&t._camera.followNode(null,!0,0);else this._pilotedCraft&&t._camera.followNode(this._pilotedCraft.vMo._node,!0,0,null,S.getDefaultCameraConfigurationName(this._pilotedCraft));t._camera.update(0),H.prefill(Math.ceil(.2*this.getMaxParticleCount())),G.prefill(Math.ceil(.75*this.getMaxProjectileCount()),function(t){t.createVisualModel()}),k.prefill(Math.ceil(.2*this.getMaxMissileCount()),function(t){t.createVisualModel()}),Y.prefill(Math.ceil(.5*this.getMaxExplosionCount()),function(t){t.createVisualModel()}),j.prefill(Math.ceil(.2*this.getMaxMissileCount())),W.prefill(Math.ceil(.2*this.getMaxMissileCount()*50))}.bind(this))},w._handleProjectile=function(t,e,i,s){i.simulate(t,e),i.canBeReused()&&G.markAsFree(s)},w._handleMissile=function(t,e,i,s){i.simulate(t,e),i.canBeReused()&&k.markAsFree(s)},w._handleTrail=function(t,e){t.canBeReused()&&j.markAsFree(e)},w._handleTrailSegment=function(t,e){t.canBeReused()&&W.markAsFree(e)},w._handleExplosion=function(t,e){t.canBeReused()&&Y.markAsFree(e)},w._handleParticle=function(t,e){t.canBeReused()&&H.markAsFree(e)},w._filterActionEntry=function(t){return t.delay>0},w.prototype.onTeamsChanged=function(t){this._onTeamsChanged=t},w.prototype.handleTeamsChanged=function(){this._onTeamsChanged&&this._onTeamsChanged()},w.prototype.prepareScene=function(t){return!!this._environment.addParticleEffectsToScene(t)&&(this._environment.simulate(),!0)},w.prototype.tick=function(t,e,s){var n,o,r,a,l,h,c,u,_,p;for(this._environment.simulate(),n=0;n<this._actionQueue.length;n++)this._actionQueue[n].delay-=t,this._actionQueue[n].delay<=0&&this._actionQueue[n].action.execute(this);for(this._actionQueue=this._actionQueue.filter(w._filterActionEntry),n=0;n<this._events.length;n++)this._events[n].simulate(this,this._pilotedCraft&&this._pilotedCraft._away?0:t);for(n=0;n<this._scs.length;n++)this._scs[n].simulate(t),this._scs[n]._alive&&!this._scs[n]._away||(l=this._hitObjects.indexOf(this._scs[n]),l>=0&&(this._hitObjects[l]=null,this._hitObjects.splice(l,1)),this._scs[n]._alive||(this._scs[n].destroy(!0),s||(this._scs[n]=null,this._scs.splice(n,1),n--)));for(n=0;n<this._scs.length-1;n++)if(this._scs[n]._hitpoints>0&&!this._scs[n]._away)for(o=n+1;o<this._scs.length;o++)this._scs[o]._hitpoints>0&&!this._scs[o]._away&&(h=this._scs[n].pMo.checkCollision(this._scs[o].pMo,t))&&(c=this._scs[h.reverse?o:n],u=this._scs[h.reverse?n:o],_=Math.min(Math.min(h.magnitude*h.magnitude*25e-5,this._scs[n].getClass()._hitpoints),this._scs[o].getClass()._hitpoints),p=i.prodVec4Mat4Aux(h.position,c.pMo.getModelMatrix()),c.damage(_,h.position,i.scaled3(h.direction,-1),u,!1,0,!0),u.damage(_,i.prodVec4Mat4Aux(p,u.pMo.getModelMatrixInverse()),i.normal3(i.prodMat4Vec3Aux(u.pMo.oM,i.prodVec3Mat4Aux(h.direction,c.pMo.oM))),c,!1,0,!0),i.mulVec3ModelMat4(p,e._camera.getViewMatrix()),(c.getClass()._mass<=u.getClass()._mass?c:u).playCollisionSound(p));G.hasLockedObjects()&&(a=new D(this._hitObjects,2,1,!0),G.executeForLockedObjects(w._handleProjectile.bind(this,t,a))),k.hasLockedObjects()&&(a=a||new D(this._hitObjects,2,1,!0),k.executeForLockedObjects(w._handleMissile.bind(this,t,a))),Y.hasLockedObjects()&&Y.executeForLockedObjects(w._handleExplosion),H.hasLockedObjects()&&H.executeForLockedObjects(w._handleParticle),j.hasLockedObjects()&&j.executeForLockedObjects(w._handleTrail),W.hasLockedObjects()&&W.executeForLockedObjects(w._handleTrailSegment),!e||s&&!m.isHost()||(r=e.moveCameraToOrigoIfNeeded(2e3))&&N.handleSceneMoved(r),this._updateState()},w.prototype.destroy=function(){var t;if(this._environment&&(this._ownsEnvironment?this._environment.destroy():this._environment.removeFromScene()),this._environment=null,this._views){
for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._views=null}if(this._scs){for(t=0;t<this._scs.length;t++)this._scs[t]&&(this._scs[t].destroy(),this._scs[t]=null);this._scs=null}if(this._grids){for(t=0;t<this._grids.length;t++)this._grids[t].destroy();this._grids=null}if(this._markers){for(t=0;t<this._markers.length;t++)this._markers[t].destroy();this._markers=null}this._pilotedCraft=null,this._hitObjects=null,H.clear(),G.clear(),k.clear(),Y.clear(),j.clear(),W.clear()},P.prototype=new r.JSONResource,P.prototype.constructor=P,P.prototype._initLocalData=function(){var t,e,i=X.getDifficultyNames();for(t=0;t<i.length;t++)this._localData[i[t]]=this._localData[i[t]]||{},e=this._localData[i[t]],e.winCount=e.winCount||0,e.loseCount=e.loseCount||0},P.prototype._getLocalStorageID=function(){return J+this._name},P.prototype._saveLocalData=function(){localStorage[this._getLocalStorageID()]=JSON.stringify(this._localData)},P.prototype.getTitle=function(){return this._dataJSON.title||""},P.prototype.getDescription=function(){return this._dataJSON.description||""},P.prototype.getAuthor=function(){return this._dataJSON.info?this._dataJSON.info.author:null},P.prototype.getDisplayDescription=function(){return T.get(T.MISSION.PREFIX,t.getFilenameWithoutExtension(this._name)+T.MISSION.DESCRIPTION_SUFFIX.name,this.getDescription()?t.formatString(T.get(T.MISSIONS.NO_TRANSLATED_DESCRIPTION),{originalDescription:this.getDescription()}):T.get(T.MISSIONS.NO_DESCRIPTION))},P.prototype.getPilotedSpacecraftDescriptor=function(){var t,e;if(!this._pilotedSpacecraftDescriptor)for(e=b(this._dataJSON.spacecrafts),t=0;t<e.length;t++)if(e[t].piloted){this._pilotedSpacecraftDescriptor=e[t];break}return this._pilotedSpacecraftDescriptor},P.prototype.getAvailableSpacecraftClasses=function(){var t,e,i=[];if(this.getPilotedSpacecraftDescriptor()&&i.push(this.getPilotedSpacecraftDescriptor().class),this._dataJSON.availableShips)for(e=this._dataJSON.availableShips,t=0;t<e.length;t++)i.indexOf(e[t].class)<0&&i.push(e[t].class);return i},P.prototype.getAvailableLoadouts=function(t){var e,i=this._dataJSON.availableShips;if(i)for(e=0;e<i.length;e++)if(i[e].class===t)return this._pilotedSpacecraftDescriptor.class===i[e].class?[""].concat(i[e].loadouts):i[e].loadouts;return[""]},P.prototype.getEnvironment=function(){var t=null;return this._readyToUse?(t=new w(this._name),t.loadEnvironment(this._dataJSON),t.getEnvironment()):(n.showError("Cannot get mission environment from mission descriptor that has not yet been initialized!"),null)},P.prototype.getMissionObjectives=function(){var t=null;return this._readyToUse?(t=new w(this._name),t.loadObjectives(this._dataJSON),t.getObjectives()):(n.showError("Cannot get mission objectives from mission descriptor that has not yet been initialized!"),null)},P.prototype.getTipIDs=function(){return this._dataJSON.tips},P.prototype.createMission=function(t){var e=null;return this._readyToUse?(e=new w(this._name),e.loadFromJSON(this._dataJSON,t)):n.showError("Cannot create mission from descriptor that has not yet been initialized!"),e},P.prototype.getBestScore=function(t){return t=t||X.getDifficulty(),this._localData[t].bestScore},P.prototype.getBestPerformance=function(t){return t=t||X.getDifficulty(),this._localData[t].bestPerformance},P.prototype.updateBestScore=function(t,e,i){i=i||X.getDifficulty();var s=this._localData[i];return(void 0===s.bestScore||t>s.bestScore)&&(s.bestScore=t,s.bestPerformance=e,this._saveLocalData(),!0)},P.prototype.increasePlaythroughCount=function(t,e){e=e||X.getDifficulty(),t?this._localData[e].winCount++:this._localData[e].loseCount++,this._saveLocalData()},P.prototype.getWinCount=function(t){return t=t||X.getDifficulty(),this._localData[t].winCount},F.prototype.getRequiredScore=function(t){return this._referenceBaseScoreFactor?t.getScoreStatistics(t.getReferenceScore()*(t.isInitialTeamMission()?this._referenceBaseScoreFactor:1),this._referenceHitRatio,this._referenceHullIntegrity,this._referenceTeamSurvival).score:0},U.prototype=new o.AsyncResource,U.prototype.constructor=U,U.prototype.getPerformanceInfo=function(t,e){var i,s={},n=this._missionPerformanceLevels.length;for(i=0;i<n&&!(e<this._missionPerformanceLevels[i].getRequiredScore(t));i++);return s.performance=i>0?this._missionPerformanceLevels[i-1]._name:"failed",s.nextPerformance=i<n?this._missionPerformanceLevels[i]._name:null,s.nextPerformanceScore=s.nextPerformance?this._missionPerformanceLevels[i].getRequiredScore(t):0,s},U.prototype.getPerformanceLevelScores=function(t){var e,i={};for(e=0;e<this._missionPerformanceLevels.length;e++)i[this._missionPerformanceLevels[e]._name]=this._missionPerformanceLevels[e].getRequiredScore(t);return i},U.prototype.loadConfigurationFromJSON=function(t){var e;for(this._difficultyLevels=[],e=0;e<t.difficultyLevels.length;e++)this._difficultyLevels.push(new V(t.difficultyLevels[e]));for(this._missionPerformanceLevels=[],e=0;e<t.missionPerformanceLevels.length;e++)this._missionPerformanceLevels.push(new F(t.missionPerformanceLevels[e]));this._tipIDs=t.tips},U.prototype.loadSettingsFromLocalStorage=function(){var t,i;this._difficulty=X.getDifficultyNames()[0],void 0!==localStorage[Q]&&(i={silentFallback:n.hasVersionChanged(),defaultValue:X.getDifficultyNames()[0]},t=e.getValueOfTypeFromLocalStorage({baseType:"enum",values:X.getDifficultyNames()},Q,i),i.error&&!n.hasVersionChanged()||this.setDifficulty(t,!!i.error&&i.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))},U.prototype.requestLoad=function(t){var e={},i=function(){this.setToReady(),this._missionManager.setToReady()}.bind(this);e.missions=P,this._missionManager.requestConfigLoad(S.getConfigurationSetting(S.CONFIGURATION.MISSION_FILES).filename,S.getConfigurationSetting(S.CONFIGURATION.MISSION_FILES).folder,e,t?function(){this._missionManager.requestAllResources(),this._missionManager.executeWhenReady(i),this._missionManager.requestResourceLoad()}.bind(this):i)},U.prototype.getDifficulty=function(){return this._difficulty},U.prototype.setDifficulty=function(t,e){void 0===e&&(e=!0),this._difficulty!==t&&(this._difficulty=t,e&&(localStorage[Q]=t))},U.prototype.getDifficultyNames=function(){var t,e=[];for(t=0;t<this._difficultyLevels.length;t++)e.push(this._difficultyLevels[t]._name);return e},U.prototype.getDifficultyLevel=function(t){var e;for(e=0;e<this._difficultyLevels.length;e++)if(this._difficultyLevels[e]._name===t)return this._difficultyLevels[e];return null},U.prototype.getTipIDs=function(){return this._tipIDs},U.prototype.getMissionNames=function(t){var e=[];return this._missionManager.executeForAllResourcesOfType("missions",function(i){void 0!==t&&i._custom!==t||e.push(i._name)},!1,!0),e},U.prototype.getMissionDescriptors=function(t){var e=[];return this._missionManager.executeForAllResourcesOfType("missions",function(i){void 0!==t&&i._custom!==t||e.push(i)},!1,!0),e},U.prototype.getMissionDescriptor=function(t){return this._missionManager.getResource("missions",t)},U.prototype.requestMissionDescriptor=function(t,e,i){var s=this._missionManager.getResource("missions",t,i);s?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){e(s)})):e(null)},U.prototype.requestMission=function(t,e,i){var s=this._missionManager.getResource("missions",t);s?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){i(s.createMission(e))})):i(null)},U.prototype.createMissionDescriptor=function(t){this._missionManager.createResource("missions",t)},U.prototype.createMission=function(t,e){return new P(t).createMission(e)},H=l.getPool(E.PARTICLE_POOL_NAME,_.Particle),G=l.getPool(E.PROJECTILE_POOL_NAME,C.Projectile),k=l.getPool(E.MISSILE_POOL_NAME,C.Missile),j=l.getPool(E.TRAIL_POOL_NAME,_.Trail),W=l.getPool(E.TRAIL_SEGMENT_POOL_NAME,_.TrailSegment),Y=l.getPool(E.EXPLOSION_POOL_NAME,v.Explosion),X=new U,S.executeWhenReady(function(){B=!1,K=S.getSetting(S.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME)}),{FAILED_MISSION_PERFORMACE:"failed",MissionDescriptor:P,loadConfigurationFromJSON:X.loadConfigurationFromJSON.bind(X),loadSettingsFromLocalStorage:X.loadSettingsFromLocalStorage.bind(X),requestLoad:X.requestLoad.bind(X),executeWhenReady:X.executeWhenReady.bind(X),getIndividualSpacecraftDescriptors:b,getDifficulty:X.getDifficulty.bind(X),setDifficulty:X.setDifficulty.bind(X),getDifficultyNames:X.getDifficultyNames.bind(X),getTipIDs:X.getTipIDs.bind(X),getMissionNames:X.getMissionNames.bind(X),getMissionDescriptor:X.getMissionDescriptor.bind(X),getMissionDescriptors:X.getMissionDescriptors.bind(X),requestMissionDescriptor:X.requestMissionDescriptor.bind(X),requestMission:X.requestMission.bind(X),createMissionDescriptor:X.createMissionDescriptor.bind(X),createMission:X.createMission.bind(X)}}),define("armada/logic/mission-hub",["modules/application","modules/analytics","armada/constants","armada/logic/missions"],function(t,e,i,s){"use strict";function n(){return!!T}function o(){return!!localStorage[y]&&!!localStorage[M]}function r(t,e){var i;O||(O=!0,i=new XMLHttpRequest,i.onload=function(){var n;return O=!1,"{"!==i.responseText[0]?void e({error:v}):(n=JSON.parse(i.responseText),n.error?void e(n):n.missions&&Array.isArray(n.missions)?(T=n.missions.map(function(t){var e=JSON.parse(t.mission);return e.name=e.info.name+".json",e.custom=!0,e.id=t.id,new s.MissionDescriptor(e)}),S=T.map(function(t){return t.getTitle()}),void t()):void e({error:v}))}.bind(this),i.onerror=function(){O=!1,e({error:I})}.bind(this),i.ontimeout=function(){O=!1,e({error:C})}.bind(this),i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",m+"missions?"+f,!0),i.send(null))}function a(e){m=e,f="version="+t.getVersion().split(" ")[0]}function l(t,e,i){var s=t.sender,n=new XMLHttpRequest;n.onload=function(){var t;return"{"!==n.responseText[0]?void i({error:A}):(t=JSON.parse(n.responseText),t.error?void i(t):t.token?(localStorage[y]=s,localStorage[M]=t.token,void e()):void i({error:A}))}.bind(this),n.onerror=function(){i({error:I})}.bind(this),n.ontimeout=function(){i({error:C})}.bind(this),n.overrideMimeType("text/plain; charset=utf-8"),n.open("POST",m+"submit?"+f,!0),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(t))}function h(t,e){var i,s=localStorage[y],n=localStorage[M];if(s&&n){if(O)return;O=!0,i=new XMLHttpRequest,i.onload=function(){var s;return O=!1,"{"!==i.responseText[0]?void e({error:v}):(s=JSON.parse(i.responseText),s.error?void e(s):s.missions&&Array.isArray(s.missions)?void t(s.missions):void e({error:v}))}.bind(this),i.onerror=function(){O=!1,e({error:I})}.bind(this),i.ontimeout=function(){O=!1,e({error:C})}.bind(this),i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",m+"missions/"+s+"?"+f+"&token="+n,!0),i.send(null)}}function c(t,e,i){var s,n=localStorage[y],o=localStorage[M];n&&o&&(s=new XMLHttpRequest,s.onload=function(){var t;return"{"!==s.responseText[0]?void i({error:N}):(t=JSON.parse(s.responseText),t.error?void i(t):!0!==t.success?void i({error:N}):void e())}.bind(this),s.onerror=function(){i({error:I})}.bind(this),s.ontimeout=function(){i({error:C})}.bind(this),s.overrideMimeType("text/plain; charset=utf-8"),s.open("POST",m+"delete/"+t+"?"+f+"&token="+o,!0),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify({username:n})))}function u(t,i,s){var n,o,r,a;if(e.isEnabled()){if(n=t,i)for(o=0;o<i.length;o++)n+="/"+i[o];if(n+="?"+f,s)for(n+="&",r=Object.keys(s),o=0;o<r.length;o++)n+=r[o]+"="+s[r[o]]+"&";a=new XMLHttpRequest,a.overrideMimeType("text/plain; charset=utf-8"),a.open("POST",m+n,!0),a.send(null)}}function _(){return S||[]}function p(){return T||[]}function d(t){return T.find(function(e){return e.getTitle()===t})}function g(t,e){e(T.find(function(e){return e.getTitle()===t}))}var m,f,S,T,E=i.LOCAL_STORAGE_PREFIX+"missionHub_",y=E+"username",M=E+"token",I=1001,C=1002,A=1003,v=1004,N=1005,O=!1;return{init:a,isReady:n,isSubmitter:o,retrieveMissions:r,submitMission:l,getSubmissions:h,deleteSubmission:c,sendEvent:u,getMissionNames:_,getMissionDescriptor:d,getMissionDescriptors:p,requestMissionDescriptor:g}}),define("armada/announcements",["modules/application","armada/constants","armada/strings"],function(t,e,i){"use strict";function s(){return!!c}function n(t,e){var s;f||(f=!0,s=new XMLHttpRequest,s.onload=function(){var i;return f=!1,"{"!==s.responseText[0]?void e({error:m}):(i=JSON.parse(s.responseText),i.error?void e(i):i.announcements&&Array.isArray(i.announcements)?(c=i.announcements,void t()):void e({error:m}))}.bind(this),s.onerror=function(){f=!1,e({error:d})}.bind(this),s.ontimeout=function(){f=!1,e({error:g})}.bind(this),s.overrideMimeType("text/plain; charset=utf-8"),u=localStorage[p]||0,s.open("GET",l+"announcements?"+h+"&language="+i.getLanguage()+"&lastDisplayed="+u,!0),s.send(null))}function o(e){l=e,h="version="+t.getVersion().split(" ")[0]+"&platform="+t.getPlatform()+"&firstRun="+t.isFirstRun()+"&versionChange="+t.hasVersionChanged()}function r(){return c||[]}function a(){var t,e=0;if(c){for(t=0;t<c.length;t++)e=Math.max(e,c[t].id);localStorage[p]=e,c.length=0}}var l,h,c,u,_=e.LOCAL_STORAGE_PREFIX+"announcements_",p=_+"lastDisplayed",d=1001,g=1002,m=1003,f=!1;return{init:o,isReady:s,retrieveAnnouncements:n,getAnnouncements:r,markAnnouncementsAsRead:a}}),define("modules/screens",["utils/utils","utils/types","modules/application","modules/async-resource","modules/components","modules/managed-gl","modules/strings"],function(t,e,i,s,n,o,r){"use strict";function a(e){var i;return I.enabled?(i=t.getLuminance(e),t.getMixedColor(t.gammaCorrect(t.filterColor([i,i,i,e[3]],I.filter),I.gamma),e,I.originalColorRatio)):e}function l(t,e,i,n,o,r){s.AsyncResource.call(this),this._name=t,this._htmlFilename=e,this._style=i||{},this._cssLoaded=!1,this._model=null,this._background=null,this._container=null,this._superimposed=!1,this._simpleComponents=[],this._externalComponentBindings=[],this._externalComponentsLoaded=0,this._externalComponentsToLoad=0,this._visible=!1,this._onShow=n?n[g]:null,this._onHide=n?n[m]:null,this._onActivate=n?n[f]:null,this._keyDownHandler=o?this._getKeyDownHandler(o):null,this._elementEventHandlers=r||null,e&&this.requestModelLoad()}function h(s){this._left=s.left,this._centerX=s.centerX,this._right=s.right,this._top=s.top,this._centerY=s.centerY,this._bottom=s.bottom,this._width=s.width,this._height=s.height,this._scaleMode=e.getEnumValue(t.ScaleMode,s.scaleMode),this._xScaleMode=e.getEnumValue(t.ScaleMode,s.xScaleMode||t.ScaleMode.ASPECT),this._yScaleMode=e.getEnumValue(t.ScaleMode,s.yScaleMode||t.ScaleMode.ASPECT),this._isValid()||i.showError("Invalid layout specified!")}function c(s,n,o,r,a,l,c,u){this._x=s[0],this._y=s[1],this._text=null,this._font=o,this._size=r,this._scaleMode=e.getEnumValue(t.ScaleMode,a),this._scaleMode===t.ScaleMode.ASPECT&&i.showError("Cannot set the scaling mode to aspect for fonts!"),this._color=null,this._align=c||"left",this._boxLayout=u?new h(u):null,this._boxLeft=-1,this._boxTop=-1,this._boxWidth=-1,this._boxHeight=-1,this._boxValid=!1,this._boxCleared=!1,this._visible=!0,this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1,this._cssFont=null,this._cssColor=null,this._words=null,this._sections=null,this._textLength=0,this._revealState=1,this._lineHeight=-1,this.setText(n),this.setColor(l)}function u(t){this._canvas=document.createElement("canvas"),this._clipSpaceLayout=new h(t),this._context=this._canvas.getContext("2d",{alpha:!0}),this._context.textBaseline="top",this._texts=[],this._visible=!0,this._cleared=!0,this._viewportWidth=-1,this._viewportHeight=-1}function _(t,i,s,n){this._canvas=t,this._resizeable=t.classList.contains(T),this._antialiasing=i,this._alpha=s,this._filtering=e.getEnumValue(o.TextureFiltering,n,{name:"ScreenCanvas.filtering"}),this._context=null,this._textLayers=[]}function p(t,i,s,n,r,a,h,c,u,_){l.call(this,t,i,s,c,u,_),this._antialiasing=n,this._alpha=r,this._filtering=i?e.getEnumValue(o.TextureFiltering,a,{name:"HTMLScreenWithCanvases.filtering"}):null,this._canvases={},this._sceneCanvasBindings=[],this._renderLoop=E,this._renderTimes=[],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._resizeEventListener=null,this._useRequestAnimFrame=h}function d(t,e,i,s,o,r,a,h,c,u){l.call(this,t,e,i,h,this._getKeyCommands(c),u),this._menuOptions=r,this._menuContainerID=a,this._menuComponent=this.registerExternalComponent(new n.MenuComponent(y,s,o,this._menuOptions,h),this._menuContainerID)}var g=n.SHOW_EVENT_NAME,m=n.HIDE_EVENT_NAME,f="activate",S=n.ELEMENT_ID_SEPARATOR,T="resizeable",E=-1,y="menu",M={name:"error.antialiasingChange",defaultValue:"The antialiasing setting has been changed. Please restart the application to apply the new setting!"},I={enabled:!1,originalColorRatio:.5,filter:[1,1,1,1],gamma:1};return l.prototype=new s.AsyncResource,l.prototype.constructor=l,l.prototype._isLoaded=function(){return this._model&&this._cssLoaded&&this._externalComponentsLoaded===this._externalComponentsToLoad},l.prototype._getKeyDownHandler=function(e){var i,s,n={};for(i=Object.keys(e),s=0;s<i.length;s++)n[t.getKeyCodeOf(i[s])]=e[i[s]];return function(t){n[t.keyCode]&&n[t.keyCode].call(this,t)}.bind(this)},l.prototype._addEventListeners=function(){this._keyDownHandler&&document.addEventListener("keydown",this._keyDownHandler)},l.prototype._removeEventListeners=function(){this._keyDownHandler&&document.removeEventListener("keydown",this._keyDownHandler)},l.prototype.requestModelLoad=function(){i.requestTextFile("screen",this._htmlFilename,function(t){var e;this._model=document.createDocumentFragment(),e=document.createElement("div"),e.innerHTML=t,this._model.appendChild(e.firstElementChild),this._isLoaded()&&this.setToReady()}.bind(this)),this._style.cssFilename?(this._cssLoaded=!1,i.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,this._isLoaded()&&this.setToReady()}.bind(this))):this._cssLoaded=!0},l.prototype.setActive=function(t){t?(this._addEventListeners(),this._onActivate&&this._onActivate()):this._removeEventListeners()},l.prototype._addElementEventListeners=function(t){var e,i,s,n,o,r;if(this._elementEventHandlers)for(t=t||this._container,o=Object.keys(this._elementEventHandlers),i=0;i<o.length;i++)for(e=t.querySelectorAll(o[i]),r=Object.keys(this._elementEventHandlers[o[i]]),s=0;s<e.length;s++)for(n=0;n<r.length;n++)e[s].addEventListener(r[n],this._elementEventHandlers[o[i]][r[n]])},l.prototype.addScreenToPage=function(t,e,i,s){s=s||document.body,this.executeWhenReady(function(){var n,o;for(e&&(this._background=document.createElement("div"),this._background.setAttribute("id",this._getElementID("screenBackground")),this._background.className=this._style.backgroundClassName||"screenBackground",this._background.hidden=!0),this._container=document.createElement("div"),this._container.setAttribute("id",this._getElementID("screenContainer")),this._container.className=this._style.containerClassName||"screenContainer",this._container.hidden=!0,i?this._container.appendChild(this._model.firstElementChild.cloneNode(!0)):this._container.appendChild(this._model.firstElementChild),n=this._container.querySelectorAll("[id]"),o=0;o<n.length;o++)n[o].setAttribute("id",this._getElementID(n[o].getAttribute("id")));for(n=this._container.querySelectorAll("[for]"),o=0;o<n.length;o++)n[o].setAttribute("for",this._getElementID(n[o].getAttribute("for")));this._background&&s.appendChild(this._background),s.appendChild(this._container),this._visible=!1,this._initializeComponents(),this._addElementEventListeners(),t&&t(),i||(this._model=null)})},l.prototype.isVisible=function(){return this._visible},l.prototype.show=function(){if(!this._visible){if(this._container)return this._container.hidden=!1,this._visible=!0,this._onShow&&this._onShow(),!0;i.showError("Attempting to show screen '"+this._name+"' before adding it to the page!")}return!1},l.prototype.superimposeOnPage=function(e,i){this._container&&(i=i||document.body,this._background&&(e&&(this._background.style.backgroundColor=t.getCSSColor(e)),this._background.hidden=!1,i.appendChild(this._background)),i.appendChild(this._container),this._superimposed=!0),this.show()},l.prototype.hide=function(){if(this._visible){if(this._container)return this._container.hidden=!0,this._background&&(this._background.hidden=!0),this._visible=!1,this._superimposed=!1,this.setActive(!1),this._onHide&&this._onHide(),!0;i.showError("Attempting to hide screen '"+this._name+"' before adding it to the page!")}return!1},l.prototype._initializeComponents=function(){var t,e;for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();for(t=0;t<this._externalComponentBindings.length;t++)e=this._externalComponentBindings[t].parentNodeID?this.getElement(this._externalComponentBindings[t].parentNodeID):null,this.addExternalComponent(this._externalComponentBindings[t].component,e);this._updateComponents()},l.prototype._getElementID=function(t){return this._name+S+t},l.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._name.length+S.length)},l.prototype._updateComponents=function(){var t,e;if(this._container){for(t=this._container.querySelectorAll(".translatable, ["+n.TRANSLATION_KEY_ATTRIBUTE+"]"),e=0;e<t.length;e++)t[e].innerHTML=r.get({name:t[e].getAttribute(n.TRANSLATION_KEY_ATTRIBUTE)||this._name+"."+this._getOriginalElementID(t[e]),defaultValue:t[e].innerHTML});for(e=0;e<this._externalComponentBindings.length;e++)this._externalComponentBindings[e].component.updateComponents()}},l.prototype.updateScreen=function(){this._updateComponents()},l.prototype.registerSimpleComponent=function(t){var e=new n.SimpleComponent(t,this._getElementID(t));return this._simpleComponents.push(e),e},l.prototype.registerExternalComponent=function(t,e){return this._externalComponentsToLoad++,this._externalComponentBindings.push({component:t,parentNodeID:e}),t.setRootElementID(this._getElementID(t._name)),t.executeWhenReady(function(){this._externalComponentsLoaded++,this._isLoaded()&&this.setToReady()}.bind(this)),t},l.prototype.addExternalComponent=function(t,e){return t.appendToPage(e),t},l.prototype.updateStatus=function(t){this._status?this._status.setContent(t):alert(t)},l.prototype.getElement=function(t){return this._container.querySelector("#"+this._getElementID(t))},h.prototype._isValid=function(){var e;if(void 0!==this._width){if(e=0,void 0!==this._left&&e++,void 0!==this._centerX&&e++,void 0!==this._right&&e++,1!==e)return!1}else{if(void 0===this._left||void 0!==this._centerX||void 0===this._right)return!1;if(this._scaleMode!==t.ScaleMode.ASPECT||this._xScaleMode!==t.ScaleMode.ASPECT)return!1}if(void 0!==this._height){if(e=0,void 0!==this._top&&e++,void 0!==this._centerY&&e++,void 0!==this._bottom&&e++,1!==e)return!1}else{if(void 0===this._top||void 0!==this._centerY||void 0===this._bottom)return!1;if(this._scaleMode!==t.ScaleMode.ASPECT||this._yScaleMode!==t.ScaleMode.ASPECT)return!1}return!0},h.prototype.getClipSpaceCenterX=function(){return void 0!==this._centerX?this._centerX:void 0!==this._width?void 0!==this._left?this._left+this._width/2:this._right-this._width/2:(this._left+this._right)/2},h.prototype.getClipSpaceCenterY=function(){return void 0!==this._centerY?this._centerY:void 0!==this._height?void 0!==this._bottom?this._bottom+this._height/2:this._top-this._height/2:(this._bottom+this._top)/2},h.prototype.getClipSpacePosition=function(){return[this.getClipSpaceCenterX(),this.getClipSpaceCenterY()]},h.prototype.getClipSpaceWidth=function(){return void 0!==this._width?this._width:this._right-this._left},h.prototype.getClipSpaceHeight=function(){return void 0!==this._height?this._height:this._top-this._bottom},h.prototype.getClipSpaceSize=function(){return[this.getClipSpaceWidth(),this.getClipSpaceHeight()]},h.prototype.getClipSpaceLeft=function(){return void 0!==this._left?this._left:this.getClipSpaceCenterX()-this.getClipSpaceWidth()/2},h.prototype.getClipSpaceRight=function(){return void 0!==this._right?this._right:this.getClipSpaceCenterX()+this.getClipSpaceWidth()/2},h.prototype.getClipSpaceBottom=function(){return void 0!==this._bottom?this._bottom:this.getClipSpaceCenterY()-this.getClipSpaceHeight()/2},h.prototype.getClipSpaceTop=function(){return void 0!==this._top?this._top:this.getClipSpaceCenterY()+this.getClipSpaceHeight()/2},h.prototype.getWidth=function(e,i){return this.getClipSpaceWidth()/2*(t.xScalesWithWidth(this._scaleMode,e,i)?e:i)},h.prototype.getHeight=function(e,i){return this.getClipSpaceHeight()/2*(t.yScalesWithHeight(this._scaleMode,e,i)?i:e)},h.prototype.getSize=function(t,e){return[this.getWidth(t,e),this.getHeight(t,e)]},h.prototype.getCenterX=function(e,i){var s;return s=t.xScalesWithWidth(this._xScaleMode,e,i)?e:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*s+this.getWidth(e,i)/2:void 0!==this._centerX?e/2+this.getClipSpaceCenterX()/2*s:e-(1-this.getClipSpaceRight())/2*s-this.getWidth(e,i)/2},h.prototype.getCenterY=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s+this.getHeight(e,i)/2:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s:i-(this.getClipSpaceBottom()+1)/2*s-this.getHeight(e,i)/2},h.prototype.setPosition=function(t,e){this._centerX=t,this._centerY=e},h.prototype.getPosition=function(t,e){return[this.getCenterX(t,e),this.getCenterY(t,e)]},h.prototype.getLeft=function(e,i){var s;return s=t.xScalesWithWidth(this._xScaleMode,e,i)?e:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*s:void 0!==this._centerX?e/2+this.getClipSpaceCenterX()/2*s-this.getWidth(e,i)/2:e-(1-this.getClipSpaceRight())/2*s-this.getWidth(e,i)},h.prototype.getTop=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s-this.getHeight(e,i)/2:i-(this.getClipSpaceBottom()+1)/2*s-this.getHeight(e,i)},h.prototype.getBottom=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s+this.getHeight(e,i):void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s+this.getHeight(e,i)/2:i-(this.getClipSpaceBottom()+1)/2*s},h.prototype.getPositiveLeft=function(t,e){return this.getLeft(t,e)/t},h.prototype.getPositiveBottom=function(t,e){return 1-this.getBottom(t,e)/e},h.prototype.getPositiveWidth=function(t,e){return this.getWidth(t,e)/t},h.prototype.getPositiveHeight=function(t,e){return this.getHeight(t,e)/e},c.prototype._updateCSSFont=function(e,i){t.scalesWithWidth(this._scaleMode,e,i)?this._cssFont=this._size*e+"px":this._cssFont=this._size*i+"px",this._cssFont=this._cssFont+" "+this._font},c.prototype.invalidateLayout=function(){this._boxValid=!1},c.prototype._updateLayout=function(){this._boxLayout&&!this._boxValid&&(this._boxTop=this._boxLayout.getTop(this._lastWidth,this._lastHeight),this._boxLeft=this._boxLayout.getLeft(this._lastWidth,this._lastHeight),this._boxWidth=this._boxLayout.getWidth(this._lastWidth,this._lastHeight),this._boxHeight=this._boxLayout.getHeight(this._lastWidth,this._lastHeight),this._boxValid=!0)},c.prototype._updateSize=function(t,e){t===this._lastWidth&&e===this._lastHeight||(this._lastWidth=t,this._lastHeight=e,this._updateCSSFont(t,e),this._textWidth=-1,this._boxValid=!1)},c.prototype._clearBox=function(t){this._boxLayout&&this._boxWidth>=0&&!this._boxCleared&&(t.clearRect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),this._boxCleared=!0)},c.prototype._breakIntoSections=function(t){var e,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T,E,y,M,I,C,A=function(){var t;for(t=d;t<o.length;t++)switch(r){case"right":o[t].xOffset-=c;break;case"center":o[t].xOffset-=.5*c}},v=function(e){A(),l++,o.push({text:e,xOffset:0,yOffset:l*p,color:g&&g.color}),g&&(g.length=g.text.length,g.startIndex=C,C+=g.length),g=o[o.length-1],d=o.length-1,T=0,c=e.length>0?t.measureText(e).width:0,S=!1},N=function(e){T+=t.measureText(g.text).width,o.push({text:"",xOffset:T,yOffset:l*p,color:e}),g.length=g.text.length,g.startIndex=C,C+=g.length,g=o[o.length-1]},O=function(){if(M.length<2)g.text.length>0?N():delete g.color;else switch(M[0]){case"color":I=M[1].split(",").map(parseFloat),g.text.length>0?N(I):g.color=I;break;default:i.showError("Unrecognized text modifier: '"+M[0]+"'!")}};for(n=this._text.split("\n"),this._words=[],e=0;e<n.length;e++)this._words.push(n[e].split(" "));for(_=this._boxLayout?this._boxWidth:this._lastWidth,this._textWidth=t.measureText(this._text).width,this._lineHeight=1.2*t.measureText("M").width,this._sections=[],o=this._sections,p=this._lineHeight,r=this._align,l=-1,T=0,c=0,d=0,C=0,e=0;e<this._words.length;e++)for(v(""),s=0;s<this._words[e].length;s++){if(m=this._words[e][s],(E=m.indexOf("["))>=0){if(y=m.indexOf("]"),M=m.substring(E+1,y).split(":"),0===E){if(O(),m.length>y+1){this._words[e][s]=m.substr(y+1),s--;continue}continue}f=y<m.length-1?m.substr(y+1):null,m=m.substring(0,E)}else f=null;a=g.text,h=a+(c>0&&!S?" ":"")+m,u=T+t.measureText(h).width,0===s||u<_?(g.text=h,c=u):v(m),S=!1,E>0&&O(),f&&(this._words[e][s]=f,s--,S=!0)}g&&(g.length=g.text.length,g.startIndex=C,C+=g.length),this._textLength=C,A()},c.prototype.render=function(e){var i,s,n,o,r;if(this._visible){for(this._clearBox(e),e.fillStyle=this._cssColor,this._updateSize(e.canvas.width,e.canvas.height),this._updateLayout(),e.font=this._cssFont,e.textAlign="left",this._boxLayout&&this._boxWidth>=0&&(e.save(),e.rect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),e.clip()),this._textWidth<0&&this._breakIntoSections(e),s=this._cssColor,o=Math.round(this._revealState*this._textLength),i=0;i<this._sections.length&&this._sections[i].startIndex<=o;i++)n=this._sections[i].color?t.getCSSColor(a(this._sections[i].color)):this._cssColor,s!==n&&(s=n,e.fillStyle=s),r=this._sections[i].startIndex+this._sections[i].length-1>o?this._sections[i].text.substring(0,o-this._sections[i].startIndex+1):this._sections[i].text,e.fillText(r,(this._x+1)/2*this._lastWidth+this._sections[i].xOffset,(1-this._y)/2*this._lastHeight+this._sections[i].yOffset);return this._boxLayout?(e.restore(),this._boxCleared=0===this._text.length,!1):this._text.length>0}return this._clearBox(e),!1},c.prototype.invalidate=function(){this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1},c.prototype.setPosition=function(t){this._x=t[0],this._y=t[1]},c.prototype.setText=function(e,i){(e=i?t.formatString(e,i):e)!==this._text&&(this._text=e,this._textWidth=-1)},c.prototype.setColor=function(e){this._color=e,this._cssColor=t.getCSSColor(a(e))},c.prototype.isVisible=function(){return this._visible},c.prototype.show=function(){this._visible||(this._visible=!0,this.invalidate())},c.prototype.hide=function(){this._visible&&(this._visible=!1,this.invalidate())},u.prototype.clearContext=function(t){this._cleared||(this._context.clearRect(0,0,this._canvas.width,this._canvas.height),t&&(this._context.strokeStyle=t,this._context.strokeRect(0,0,this._canvas.width,this._canvas.height)),this._cleared=!0)},u.prototype.addText=function(t){this._texts.push(t)},u.prototype.render=function(){var t;if(this._visible)for(this.clearContext(),t=0;t<this._texts.length;t++)this._cleared=!this._texts[t].render(this._context)&&this._cleared},u.prototype.updateLayout=function(){this._canvas.style.top=this._clipSpaceLayout.getTop(this._viewportWidth,this._viewportHeight)+"px",this._canvas.style.left=this._clipSpaceLayout.getLeft(this._viewportWidth,this._viewportHeight)+"px",this._canvas.width=this._clipSpaceLayout.getWidth(this._viewportWidth,this._viewportHeight),this._canvas.height=this._clipSpaceLayout.getHeight(this._viewportWidth,this._viewportHeight),this._cleared=!1},u.prototype.handleResize=function(t,e){this._viewportWidth=t,this._viewportHeight=e,this.updateLayout()},u.prototype.setContainer=function(t){
this.handleResize(t.width,t.height),t.parentNode.appendChild(this._canvas),this._canvas.style.position="absolute",this._canvas.zIndex=t.zIndex+1},u.prototype.isVisible=function(){return this._visible},u.prototype.show=function(){var t;if(!this._visible){for(t=0;t<this._texts.length;t++)this._texts[t].invalidate();this._visible=!0,this._canvas.hidden=!1}},u.prototype.hide=function(){var t;if(this._visible){for(this.clearContext(),t=0;t<this._texts.length;t++)this._texts[t].invalidate();this._visible=!1,this._canvas.hidden=!0}},_.prototype.getManagedContext=function(){return this._context||(this._context=new o.ManagedGLContext(this._canvas.getAttribute("id"),this._canvas,this._antialiasing,this._alpha,this._filtering)),this._context},_.prototype.clearManagedContext=function(){this._context&&this._context.clear()},_.prototype.setAntialiasing=function(t){if(t!==this._antialiasing){if(this._context)return i.showError(r.get(M)),!1;this._antialiasing=t}return!0},_.prototype.setFiltering=function(t){t!==this._filtering&&(this._filtering=t,this._context&&this._context.setFiltering(this._filtering))},_.prototype.handleResize=function(){var t,e=this._canvas.clientWidth,i=this._canvas.clientHeight;if(this._canvas.width!==e||this._canvas.height!==i)for(this._canvas.width=e,this._canvas.height=i,t=0;t<this._textLayers.length;t++)this._textLayers[t].handleResize(e,i)},_.prototype.addTextLayer=function(t){this._textLayers.push(t),t.setContainer(this._canvas)},_.prototype.renderTextLayers=function(){var t;for(t=0;t<this._textLayers.length;t++)this._textLayers[t].render()},p.prototype=new l,p.prototype.constructor=p,p.prototype.handleResize=function(){this.resizeCanvases(),this._renderLoop===E&&this.render()},p.prototype.clearSceneCanvasBindings=function(){var t;for(t=0;t<this._sceneCanvasBindings.length;t++)this._sceneCanvasBindings[t].canvas.clearManagedContext();this._sceneCanvasBindings=[]},p.prototype.hide=function(){return!!l.prototype.hide.call(this)&&(this.stopRenderLoop(),!0)},p.prototype._getAlphaForCanvas=function(t){return"boolean"==typeof this._alpha?this._alpha:"boolean"==typeof this._alpha[t]?this._alpha[t]:(i.showError("No alpha channel support is defined for canvas '"+t+"' of screen '"+this._name+"'!"),!1)},p.prototype._initializeComponents=function(){var t,e;for(l.prototype._initializeComponents.call(this),t=this._container.getElementsByTagName("canvas"),e=0;e<t.length;e++)this._canvases[t[e].getAttribute("id")]=new _(t[e],this._antialiasing,this._getAlphaForCanvas(this._getOriginalElementID(t[e])),this._filtering);this._resizeEventListener=this.handleResize.bind(this),window.addEventListener("resize",this._resizeEventListener)},p.prototype.getScreenCanvas=function(t){return this._canvases[this._getElementID(t)]},p.prototype.bindSceneToCanvas=function(t,e){var i,s=!1;for(i=0;i<this._sceneCanvasBindings.length;i++)this._sceneCanvasBindings[i].scene===t&&this._sceneCanvasBindings[i].canvas===e&&(s=!0);!1===s&&this._sceneCanvasBindings.push({scene:t,canvas:e}),t.addToContext(e.getManagedContext()),this._renderLoop!==E&&e.getManagedContext().setup()},p.prototype.setAntialiasing=function(t){var e;if(t!==this._antialiasing){this._antialiasing=t;for(e in this._canvases)if(this._canvases.hasOwnProperty(e)&&!this._canvases[e].setAntialiasing(this._antialiasing))return}},p.prototype.setFiltering=function(t){var i;if((t=e.getEnumValue(o.TextureFiltering,t,{name:"HTMLScreenWithCanvases.filtering",defaultValue:this._filtering}))!==this._filtering){this._filtering=t;for(i in this._canvases)this._canvases.hasOwnProperty(i)&&this._canvases[i].setFiltering(this._filtering)}},p.prototype._render=function(t){var e,i;for(i=Object.keys(this._canvases),e=0;e<this._sceneCanvasBindings.length;e++)this._sceneCanvasBindings[e].scene.render(this._sceneCanvasBindings[e].canvas.getManagedContext(),t);for(e=0;e<i.length;e++)this._canvases[i[e]].renderTextLayers()},p.prototype.render=function(){var t,e,i,s;if(t=performance.now(),e=this._renderTimes&&this._renderTimes.length>0?t-this._renderTimes[this._renderTimes.length-1]:0,this._render(e),this._renderLoop!==E){for(this._renderTimes.push(t),i=!1;this._renderTimes.length>1&&t-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(s=this._renderTimes.length,(0===this._minFPS||this._minFPS>s)&&(this._minFPS=s),(0===this._maxFPS||this._maxFPS<s)&&(this._maxFPS=s),this._fpsSum+=s,this._fpsFrameCount++)}},p.prototype._renderRequestAnimFrame=function(t){var e,i,s;if(this._renderLoop!==E){for(e=this._renderTimes&&this._renderTimes.length>0?t-this._renderTimes[this._renderTimes.length-1]:0,this._render(e),this._renderTimes.push(t),i=!1;this._renderTimes.length>1&&t-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(s=this._renderTimes.length,(0===this._minFPS||this._minFPS>s)&&(this._minFPS=s),(0===this._maxFPS||this._maxFPS<s)&&(this._maxFPS=s),this._fpsSum+=s,this._fpsFrameCount++),window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))}},p.prototype.startRenderLoop=function(t){var e;if(this._renderLoop===E){for(e=0;e<this._sceneCanvasBindings.length;e++)this._sceneCanvasBindings[e].canvas.getManagedContext().setup();this._renderTimes=[performance.now()],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._useRequestAnimFrame?(this._renderLoop=-2,window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))):this._renderLoop=setInterval(function(){this.render()}.bind(this),t)}},p.prototype.stopRenderLoop=function(){this._renderLoop!==E&&(this._useRequestAnimFrame||clearInterval(this._renderLoop),this._renderLoop=E,this._renderTimes=[])},p.prototype.getFPS=function(){return this._renderTimes.length},p.prototype.getFPSStats=function(){return this._renderTimes.length+" ("+(this._fpsFrameCount>0?Math.round(this._fpsSum/this._fpsFrameCount):"0")+", "+this._minFPS+"-"+this._maxFPS+")"},p.prototype.resizeCanvases=function(){var t;for(t in this._canvases)this._canvases.hasOwnProperty(t)&&!0===this._canvases[t]._resizeable&&this._canvases[t].handleResize()},d.prototype=new l,d.prototype.constructor=d,d.prototype._getKeyCommands=function(t){return t=t||{},t.up=t.up||function(){this._menuComponent.selectPrevious()}.bind(this),t.down=t.down||function(){this._menuComponent.selectNext()}.bind(this),t.enter=t.enter||function(){this._menuComponent.activateSelected()}.bind(this),t},d.prototype.setActive=function(t){l.prototype.setActive.call(this,t),this._menuComponent.unselect(),t&&this._menuComponent.refresh()},{ELEMENT_ID_SEPARATOR:S,HTMLScreen:l,CanvasText:c,ClipSpaceLayout:h,TextLayer:u,HTMLScreenWithCanvases:p,MenuScreen:d}}),define("armada/screens/battle",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/game","modules/components","modules/screens","modules/media-resources","modules/egom-model","modules/scene/renderable-objects","modules/scene/scene-graph","modules/analytics","armada/strings","armada/screens/shared","armada/graphics","armada/audio","armada/networking","armada/logic/classes","armada/configuration","armada/control","armada/logic/SpacecraftEvents","armada/logic/missions","armada/logic/missions/events","armada/logic/mission-hub","armada/logic/equipment","armada/logic/spacecraft","armada/logic/ai","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T,E,y,M,I,C,A,v){"use strict";function N(){Zt=Kt._team?Kt._team._squads:[],Li=[]}function O(){var t,e,i,s,o;if(Rn!==gn){if(e=performance.now(),i=e-Nt,It+=i,T.control(i),Gt&&!m.isHost()&&m.sendGuestUpdate(yt._pilotedCraft),v.control(i),t=yt.getFollowedSpacecraftForScene(Mt),!Ot){if(yt.tick(i,Mt,Gt),Gt)if(m.isHost())for(It>=mn&&(It=0,m.sendHostUpdate(yt.getSpacecrafts())),o=m.getPlayers(),s=1;s<o.length;s++)o[s].left||(Ct[s]+=i,Ct[s]>Ke&&m.guestTimeout(o[s].name));else It>Ke?(Gt=!1,n.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),m.leaveGame(),xt.showMessage(_.get(_.MULTI_BATTLE.CONNECTION_TIMEOUT),function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME)})):It>2e3?At!==cn.LOST&&(At=cn.LOST,xt.clearHUDMessages(Cn),xt.queueHUDMessage({text:_.get(_.MULTI_BATTLE.CONNECTION_LOST),color:on.colors.connectionLost,queue:Cn,permanent:!0,silent:!0},!0),De.play()):It>500?At!==cn.SLOW&&(At=cn.SLOW,xt.clearHUDMessages(Cn),xt.queueHUDMessage({text:_.get(_.MULTI_BATTLE.SLOW_CONNECTION),color:on.colors.slowConnection,queue:Cn,permanent:!0,silent:!0},!0),De.play()):At!==cn.GOOD&&(At=cn.GOOD,xt.clearHUDMessages(Cn));Yt+=i,yt.isFinished()||yt.noHostilesPresent()||(qe+=i)>Je&&g.playMusic(jt)}t&&(!t._alive||t._away?T.isInPilotMode()?T.switchToSpectatorMode(!0):Ht&&(Mt._camera.followNextNode()||T.switchToSpectatorMode(!0,!0),Xt=0):Ht&&S.getBattleSetting(S.BS.DEMO_VIEW_SWITCHING)&&(Xt+=i)>6e3&&(Xt=0,Mt._camera.changeToNextView(),Math.random()<.5&&Mt._camera.changeToNextView())),Nt=e}}function L(){yt&&yt.destroy(),yt=null,Mt&&Mt.clear(!0),Mt=null,di&&di.clear(!0),di=null,Se=null,Re=null,xe=0,Ye=null,g.playMusic(null),g.stopLastClips(),Kt=null,ae=0,le=0,he=0,ce=0,ue=0,_e=0,pe=0,de=0,ge=0,me=0,kt="",rn=null}function R(){var t=wt&&y.getMissionDescriptor(wt).getTipIDs()||y.getTipIDs(),e=Math.min(Math.floor(Math.random()*t.length),t.length-1);kt=_.get(_.TIP.PREFIX,t[e])}function b(){return yt?yt._name:null}function x(){Ot=!0,Mt&&Mt.setShouldAnimate(!1)}function D(){Mt&&Mt.setShouldAnimate(!0),Ot=!1}function w(){Ot?D():x()}function P(){Ze=!1}function V(){Ze=!0}function F(){Ze=!Ze}function U(){var t;for(t=0;t<Dn.length;t++)Dn[t].handleGraphicsSettingsChanged()}function B(){var t=this.getTarget();t&&t.isHostile(this)&&!yt.isFinished()&&(qe=0,Wt&&g.playMusic(Wt))}function H(){return Le={text:_.get(_.BATTLE.MESSAGE_JUMP_ENGAGED),color:on.colors.jump,queue:In,permanent:!0,silent:!0},xt.queueHUDMessage(Le,!0),fe=Mt._camera.getConfiguration(),!0}function G(){return xt.clearHUDMessages(In),Mt._camera.startTransitionToConfiguration(fe),!0}function k(t,e,i){var s=t.vMo._node.getCameraConfigurationsWithName(e);return s.length>0&&(Mt._camera.startTransitionToConfiguration(s[0],i),!0)}function j(e){e.duration===e.timeLeft&&k(this,"jump",e.duration),e.timeLeft<=0?(P(),k(this,"flyby",0)||Mt._camera.setToFreeCamera()):xt.queueHUDMessage({text:t.formatString(_.get(_.BATTLE.MESSAGE_JUMP_PREPARING),{timeLeft:t.formatTimeToSeconds(e.timeLeft)}),color:on.colors.jump,duration:1,queue:In,silent:!0},!0)}function W(){this===yt.getFollowedSpacecraftForScene(Mt)&&(Ht?k(this,"flyby",0):Mt._camera.setToFreeCamera())}function Y(){var t=yt._pilotedCraft;t&&t._alive&&!t._away&&t.isHostile(this)&&(!Re||xe<=0?(Re&&(Re.timeLeft=0),Re={text:"\n\n"+_.get(_.BATTLE.MESSAGE_NEW_HOSTILES),color:on.colors.alert,blinkInterval:500,duration:3250,silent:!0,noBackground:!0,queue:Mn},xt.queueHUDMessage(Re,!0),Ye=[this],be.play()):Ye.push(this),xe=Re.duration),v.broadcastSpacecraftEvent(E.ARRIVED,this)}function X(){v.broadcastSpacecraftEvent(E.DESTRUCTED,this)}function z(){v.handlePlayerGainKill()}function q(t){t.missile?ge=Us:pe=Us}function J(t){var e,i,s,n=yt._pilotedCraft,o=-1;Kt&&n&&n._alive&&!n._away&&!n.isHostile(this)&&(i=performance.now(),Te!==this&&(i-Be>500||t.messageType!==He&&i-Be>250)&&(Ue||((Ge||je)&&(s=we[t.voice][t.messageType],o=1+(Ge?s.play(a.SoundCategory.VOICE):s.getRandomSampleIndex()),e={text:_.get(_.RADIO.PREFIX,Fe[t.messageType]+o),source:this,silent:Ge,appearAnimation:!Ge,queue:An},xt.queueHUDMessage(e,!0)),Be=i,He=t.messageType)))}function Q(e){var i,s;if(s=hn[t.constantName(e.state)],e.section)rn[ln[t.constantName(e.section)]]=s;else for(i=0;i<rn.length;i++)rn[i]=s}function K(t,e,i,s,n,o,r,a){this._class=new f.TexturedModelClass({name:fn,shader:t,texture:e}),this._position=i,this._scale=[.5*s[0],.5*s[1]],this._scaleMode=n,this._color=o,this._angle=0,this._clipCoordinates=h.CLIP_COORDINATES_NO_CLIP.slice(),this._clipColor=r||[0,0,0,0],this._textureCoordinates=a,this.vMo=null,this._node=null}function Z(t){return Dn.push(t),t}function $(){return Z(new K(Tn,S.gHS(S.BS.HUD.SHIP_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.SHIP_INDICATOR).sizes.maximum,S.gHS(S.BS.HUD.SHIP_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.hostile,void 0,S.gHS(S.BS.HUD.SHIP_INDICATOR).mapping))}function tt(t){return Z(new K(Sn,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).texture,[0,0],S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors.friendly,void 0,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[t]))}function et(){return Z(new K(Sn,S.gHS(S.BS.HUD.SHIP_ARROW).texture,[0,0],S.gHS(S.BS.HUD.SHIP_ARROW).sizes.default,S.gHS(S.BS.HUD.SHIP_ARROW).scaleMode,S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,void 0,S.gHS(S.BS.HUD.SHIP_ARROW).mapping))}function it(){return Z(new K(Sn,S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).texture,[0,0],[1,1],S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,void 0,S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).mapping))}function st(){return Z(new K(Tn,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).size,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).scaleMode,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal,void 0,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).mapping))}function nt(e,i,s){var n,o,a;return n=t.deepCopy(S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT)),n.right+=n.width*e,o=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS)[i-1][s],a=sn.size,n.right-=n.width*(.5-.5*(o[0]+a[0])),n.top-=n.height*(.5-.5*(o[1]+a[1])),n.width*=a[0],n.height*=a[1],new r.ClipSpaceLayout(n)}function ot(t,e,i){var s,n;return s=sn.mappings,n=new K(En,sn.texture,t.getClipSpacePosition(),t.getClipSpaceSize(),t._scaleMode,sn.colors.fullIntegrity,void 0,e&&s[e]||s.general),i||Z(n),n}function rt(t){var e=S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).position;return e=[e[0]+2*t*S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT).width/S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout.width,e[1]],new r.CanvasText(e,"",S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontName,S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontSize,ys._scaleMode,S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).color,"center")}function at(t,e){return a.getSoundEffect(t+"_"+e)}function lt(e,i,s){return a.getSoundEffect(e+"_mission_"+t.getFilenameWithoutExtension(i._name)+"_"+s,!0)}function ht(e,i){return a.getSoundEffect("mission_"+t.getFilenameWithoutExtension(e._name)+"_"+i,!0)}function ct(e){var i,s,n,o,l,h,c,u,_,p,d;for($e=$e||Z(new K(Sn,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).texture,[0,0],S.gHS(S.BS.HUD.CENTER_CROSSHAIR).size,fs,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).color,void 0,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).mapping)),$e.addToScene(Mt),Bi=Bi||Z(new K(Sn,S.gHS(S.BS.HUD.DRIFT_ARROW).texture,[0,0],S.gHS(S.BS.HUD.DRIFT_ARROW).size,S.gHS(S.BS.HUD.DRIFT_ARROW).scaleMode,S.gHS(S.BS.HUD.DRIFT_ARROW).colors.maxSpeed,void 0,S.gHS(S.BS.HUD.DRIFT_ARROW).mapping)),Bi.addToScene(Mt),ri||(ri=[et()]),i=0;i<ri.length;i++)ri[i].addToScene(Mt);if(!_i)for(_i=[],l=Object.keys(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings),i=0;i<l.length;i++)_i.push(tt(l[i]));for(i=0;i<_i.length;i++)_i[i].addToScene(Mt);if(!ai)for(ai=[],i=0;i<4;i++)ai.push(it());for(i=0;i<4;i++)ai[i].addToScene(Mt);for(oi||(oi=[$()]),i=0;i<oi.length;i++)oi[i].addToScene(Mt);for(pi=pi||Z(new K(Tn,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).size,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).scaleMode,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile,void 0,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).mapping)),pi.addToScene(Mt),ti||(ti=[st()]),i=0;i<ti.length;i++)ti[i].addToScene(Mt);for(Ti=Ti||Z(new K(En,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).texture,Es.getClipSpacePosition(),Es.getClipSpaceSize(),Es._scaleMode,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).mapping)),Ti.addToScene(Mt),Ci=Ci||Z(new K(En,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).texture,ys.getClipSpacePosition(),ys.getClipSpaceSize(),ys._scaleMode,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).mapping)),Ci.addToScene(Mt),ki=ki||Z(new K(En,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).texture,Ls.getClipSpacePosition(),Ls.getClipSpaceSize(),Ls._scaleMode,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).mapping)),ki.addToScene(Mt),Xi=Xi||Z(new K(En,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).texture,Rs.getClipSpacePosition(),Rs.getClipSpaceSize(),Rs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).mapping)),Xi.addToScene(Mt),rs=rs||Z(new K(En,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).texture,Ds.getClipSpacePosition(),Ds.getClipSpaceSize(),Ds._scaleMode,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).mapping)),rs.addToScene(Mt),cs=cs||Z(new K(En,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).texture,ws.getClipSpacePosition(),ws.getClipSpaceSize(),ws._scaleMode,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).mapping)),cs.addToScene(Mt),es=es||Z(new K(En,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).texture,Ps.getClipSpacePosition(),Ps.getClipSpaceSize(),Ps._scaleMode,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).mapping)),es.addToScene(Mt),Oi||(Li=[],Oi=[]),i=0;i<Oi.length;i++)Oi[i].body.addToScene(Mt),Oi[i].shield.addToScene(Mt);if(Ni&&Ni.addToScene(Mt),Ei=Ei||Z(new K(yn,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).texture,Ms.getClipSpacePosition(),Ms.getClipSpaceSize(),Ms._scaleMode,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.filled,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.empty,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).mapping)),Ei.addToScene(Mt),yi=yi||Z(new K(yn,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).texture,Is.getClipSpacePosition(),Is.getClipSpaceSize(),Is._scaleMode,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).colors.filled,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).colors.empty,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).mapping)),yi.addToScene(Mt),bi=bi||Z(new K(yn,S.gHS(S.BS.HUD.SPEED_BAR).texture,Cs.getClipSpacePosition(),Cs.getClipSpaceSize(),Cs._scaleMode,S.gHS(S.BS.HUD.SPEED_BAR).colors.combatFilled,S.gHS(S.BS.HUD.SPEED_BAR).colors.combatEmpty,S.gHS(S.BS.HUD.SPEED_BAR).mapping)),bi.addToScene(Mt),xi=xi||Z(new K(yn,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).texture,Cs.getClipSpacePosition(),Cs.getClipSpaceSize(),Cs._scaleMode,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).color,void 0,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).mapping)),xi.addToScene(Mt),Di=Di||Z(new K(yn,S.gHS(S.BS.HUD.MISSILE_INDICATOR).texture,vs.getClipSpacePosition(),vs.getClipSpaceSize(),vs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings.single)),Di.addToScene(Mt),u=new K(yn,S.gHS(S.BS.HUD.MISSILE_INDICATOR).texture,vs.getClipSpacePosition(),vs.getClipSpaceSize(),vs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings.salvo),u.addResourcesToScene(Mt),Hi=Hi||Z(new K(yn,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).texture,Ns.getClipSpacePosition(),Ns.getClipSpaceSize(),Ns._scaleMode,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors.filled,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors.empty,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).mapping)),Hi.addToScene(Mt),Gi=Gi||Z(new K(yn,S.gHS(S.BS.HUD.SHIELD_BAR).texture,Os.getClipSpacePosition(),Os.getClipSpaceSize(),Os._scaleMode,S.gHS(S.BS.HUD.SHIELD_BAR).colors.filled,S.gHS(S.BS.HUD.SHIELD_BAR).colors.empty,S.gHS(S.BS.HUD.SHIELD_BAR).mapping)),Gi.addToScene(Mt),ei=ei||Z(new K(yn,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).texture,bs.getClipSpacePosition(),bs.getClipSpaceSize(),bs._scaleMode,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors.hostileFilled,void 0,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).mapping)),ei.addToScene(Mt),ii=ii||Z(new K(yn,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).texture,xs.getClipSpacePosition(),xs.getClipSpaceSize(),xs._scaleMode,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors.filled,void 0,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).mapping)),ii.addToScene(Mt),n=6,!ds)for(ds=[],i=0;i<n;i++)ds.push({}),c=t.deepCopy(en.layouts.hull),c.top+=-.26*i*ws.getClipSpaceHeight()*.5,ds[i].hullLayout=new r.ClipSpaceLayout(c),ds[i].hull=Z(new K(yn,en.texture,ds[i].hullLayout.getClipSpacePosition(),ds[i].hullLayout.getClipSpaceSize(),ds[i].hullLayout._scaleMode,en.colors.fullHull,en.colors.destroyed,en.mapping)),c=t.deepCopy(en.layouts.shield),c.top+=-.26*i*ws.getClipSpaceHeight()*.5,ds[i].shieldLayout=new r.ClipSpaceLayout(c),ds[i].shield=Z(new K(yn,en.texture,ds[i].shieldLayout.getClipSpacePosition(),ds[i].shieldLayout.getClipSpaceSize(),ds[i].shieldLayout._scaleMode,en.colors.shield,en.colors.lostShield,en.mapping));for(i=0;i<n;i++)ds[i].hull.addToScene(Mt),ds[i].shield.addToScene(Mt);for(si=si||Z(new K(Sn,S.gHS(S.BS.HUD.CURSOR).texture,[0,0],S.gHS(S.BS.HUD.CURSOR).size,S.gHS(S.BS.HUD.CURSOR).scaleMode,S.gHS(S.BS.HUD.CURSOR).color,void 0,S.gHS(S.BS.HUD.CURSOR).mappings.still)),si.addToScene(Mt),ni=ni||Z(new K(Sn,S.gHS(S.BS.HUD.CURSOR).texture,[0,0],S.gHS(S.BS.HUD.CURSOR).size,S.gHS(S.BS.HUD.CURSOR).scaleMode,S.gHS(S.BS.HUD.CURSOR).color,void 0,S.gHS(S.BS.HUD.CURSOR).mappings.turn)),ni.addToScene(Mt),o=nt(0,1,0),l=Object.keys(sn.mappings),i=0;i<l.length;i++)h=ot(o,l[i],!0),h.addResourcesToScene(Mt);for(a.getSoundEffect(S.gHS(S.BS.HUD.TARGET_SWITCH_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.TARGET_SWITCH_DENIED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.FLIGHT_MODE_SWITCH_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_CHANGE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_CHANGE_DENIED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_SALVO_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name),Gt&&a.getSoundEffect(S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).name),_=S.getSetting(S.BS.PILOT_VOICES),Fe=S.getSetting(S.BS.VOICE_MESSAGES),p=e.getMessageParams(),i=0;i<_.length;i++)if(v.isVoiceUsed(i)){for(s=0;s<Fe.length;s++)at(_[i],Fe[s]);for(s=0;s<p.length;s++)(d=e.getSpacecraft(p[s].source))&&v.getVoiceOfSpacecraft(d)===i&&lt(_[i],e,p[s].textID)}for(i=0;i<p.length;i++)ht(e,p[i].textID)}function ut(){return"<span class='highlightedText'>"+T.getInputInterpreter(T.KEYBOARD_NAME).getControlStringForAction("quit")+"</span>"}function _t(t){return t._alive&&!t._away&&t!==Kt}function pt(t){return t!==Kt}function dt(t){return t>1e3?(t/1e3).toPrecision(3)+"k":Math.round(t).toString()}function gt(e,i,s,n){return e>.5?t.getMixedColor(s,i,2*(e-.5)):t.getMixedColor(n,s,2*e)}function mt(t){t.setUniformValueFunction(h.UNIFORM_COLOR_NAME,function(){return Si}),t.setScale(1/t.getSize()),mi=t}function ft(t){return rn[t]===hn.VISIBLE||rn[t]===hn.HIGHLIGHTED&&ze}function St(){r.HTMLScreenWithCanvases.call(this,p.BATTLE_SCREEN_NAME,p.BATTLE_SCREEN_SOURCE,{cssFilename:p.BATTLE_SCREEN_CSS,backgroundClassName:p.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:p.SCREEN_CONTAINER_CLASS_NAME},d.getAntialiasing(),!0,d.getFiltering(),!0,{activate:function(){gs=S.gHS(S.BS.HUD.AIM_ASSIST_CROSSHAIRS),ms=S.gHS(S.BS.HUD.RELATIVE_TARGET_ORIENTATION),Zi&&(S.gHS(S.BS.HUD.SHOW_VERSION_INFO)?Zi.show():Zi.hide()),S.gHS(S.BS.HUD.SHOW_FPS_COUNTER)?this._stats.show():this._stats.hide()}}),this._stats=this.registerSimpleComponent(un),this._touchControlSheet=this.registerSimpleComponent(_n),this._loadingBox=this.registerExternalComponent(new o.LoadingBox(pn,p.LOADING_BOX_SOURCE,{cssFilename:p.LOADING_BOX_CSS},_.LOADING.HEADER.name)),this._infoBox=this.registerExternalComponent(new o.InfoBox(dn,p.INFO_BOX_SOURCE,{cssFilename:p.INFO_BOX_CSS},_.INFO_BOX.HEADER.name,_.INFO_BOX.OK_BUTTON.name,{show:function(){if(xt.isVisible()){for(;n.getScreen()!==xt;)n.closeSuperimposedScreen();this.pauseBattle()}}.bind(this),hide:function(){n.getScreen()===xt&&this._doStartBattle()}.bind(this),buttonselect:p.playButtonSelectSound,buttonclick:p.playButtonClickSound}))}function Tt(t){return t.state===an.COMPLETED}function Et(){var e,i,s,o,r,a=!1;if(Gt)return n.setScreen(p.MULTI_SCORE_SCREEN_NAME),void m.leaveGame();i=yt._pilotedCraft,e=yt._state===M.MissionState.COMPLETED,s=i?i.getHitRatio():0,o=i?yt.getPerformanceStatistics():{},wt?(r=y.getMissionDescriptor(yt._name),yt._state!==M.MissionState.NONE&&r.increasePlaythroughCount(e),e&&!r._custom&&(a=r.updateBestScore(o.score,o.performance),u.sendEvent("score",[t.getFilenameWithoutExtension(wt)],{difficulty:Ft,score:o.score}))):e&&yt.getId()&&I.sendEvent("score",[yt.getId()],{difficulty:Ft,score:o.score}),n.getScreen(p.DEBRIEFING_SCREEN_NAME).setData({missionState:yt._state,objectives:yt.getObjectives(),objectivesCompleted:yt.getObjectivesState(!0).map(Tt),performance:e?o.performance:y.FAILED_MISSION_PERFORMACE,nextPerformance:e?o.nextPerformance:null,nextPerformanceScore:e?o.nextPerformanceScore:0,score:e?o.score:0,isRecord:a,elapsedTime:Yt,kills:i?i.getKills():0,damageDealt:i?Math.round(i.getDamageDealt()):0,baseScore:o.baseScore||0,hitRatio:s,hitRatioBonus:o.hitRatioBonus,missileDamageDealt:i?Math.round(i.getMissileDamageDealt()):0,missilesLaunched:i?Math.round(i.getMissilesLaunched()):0,missilesHit:i?Math.round(i.getMissileHitsOnEnemies()):0,hullIntegrity:i?i.getHullIntegrity():0,hullIntegrityBonus:o.hullIntegrityBonus,teamSurvival:o.teamSurvival,teamSurvivalBonus:o.teamSurvivalBonus,nextMissionName:e?yt.getNextMissionName():null}),n.setScreen(p.DEBRIEFING_SCREEN_NAME)}var yt,Mt,It,Ct,At,vt,Nt,Ot,Lt,Rt,bt,xt,Dt,wt,Pt,Vt,Ft,Ut,Bt,Ht,Gt,kt,jt,Wt,Yt,Xt,zt,qt,Jt,Qt,Kt,Zt,$t,te,ee,ie,se,ne,oe,re,ae,le,he,ce,ue,_e,pe,de,ge,me,fe,Se,Te,Ee,ye,Me,Ie,Ce,Ae,ve,Ne,Oe,Le,Re,be,xe,De,we,Pe,Ve,Fe,Ue,Be,He,Ge,ke,je,We,Ye,Xe,ze,qe,Je,Qe,Ke,Ze,$e,ti,ei,ii,si,ni,oi,ri,ai,li,hi,ci,ui,_i,pi,di,gi,mi,fi,Si,Ti,Ei,yi,Mi,Ii,Ci,Ai,vi,Ni,Oi,Li,Ri,bi,xi,Di,wi,Pi,Vi,Fi,Ui,Bi,Hi,Gi,ki,ji,Wi,Yi,Xi,zi,qi,Ji,Qi,Ki,Zi,$i,ts,es,is,ss,ns,os,rs,as,ls,hs,cs,us,_s,ps,ds,gs,ms,fs,Ss,Ts,Es,ys,Ms,Is,Cs,As,vs,Ns,Os,Ls,Rs,bs,xs,Ds,ws,Ps,Vs,Fs,Us,Bs,Hs,Gs,ks,js,Ws,Ys,Xs,zs,qs,Js,Qs,Ks,Zs,$s,tn,en,sn,nn,on,rn,an=M.ObjectiveState,ln={TARGET_INFO:0,TARGET_INDICATOR:1,SHIP_INDICATORS:2,AIM_ASSIST_INDICATOR:3,WEAPON_IMPACT_INDICATORS:4,HULL_BAR:5,SHIELD_BAR:6,SPEED_BAR:7,DRIFT_ARROW:8,FLIGHT_MODE:9,WINGMEN_INFO:10,MISSILE_INFO:11,MISSILE_INDICATOR:12,OBJECTIVES:13,ESCORTS:14,SCORE:15},hn={VISIBLE:0,HIDDEN:1,HIGHLIGHTED:2},cn={GOOD:0,SLOW:1,LOST:2},un="stats",_n="touchControlSheet",pn="loadingBox",dn="infoBox",gn=-1,mn=50,fn="hudElementClass",Sn="ui2d",Tn="ui3d",En="ui2d-mix-viewport",yn="ui2d-clip-viewport",Mn="hostileAlert",In="system",Cn="connection",An="radio",vn=[Cn,In,"mission","info",An,Mn],Nn=["name","class","team","firepower","distance","velocity"],On={weapons:!0},Ln=!!navigator.wakeLock,Rn=gn,bn=-1,xn={},Dn=[],wn=i.identity4();return Object.freeze(ln),Object.freeze(hn),K.prototype._getModelName=function(){return"squareModel"+(this._textureCoordinates?"-"+this._textureCoordinates[0].join("-")+"-"+this._textureCoordinates[1].join("-"):"")},K.prototype._acquireResources=function(){var t,e;t=this._getModelName(),e=a.getModel(t,{allowNullResult:!0}),this._class.acquireResources({model:e||l.squareModel(t,this._textureCoordinates)})},K.prototype._initVisualModel=function(){this.vMo?this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),d.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor):this.vMo=new h.UIElement(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),d.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor)},K.prototype.addToScene=function(t){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),this._node=t.addUIObject(this.vMo)}.bind(this))},K.prototype.addResourcesToScene=function(t){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),t.addResourcesOfObject(this.vMo)}.bind(this))},K.prototype.hide=function(){this._node.hide()},K.prototype.show=function(){this._node.show()},K.prototype.isVisible=function(){return this._node.isVisible()},K.prototype.setPosition=function(t){this._position=t,this.vMo&&this.vMo.setPosition(t)},K.prototype.setPosition2=function(t,e){this._position[0]=t,this._position[1]=e,
this.vMo&&this.vMo.setPosition2(t,e)},K.prototype.setSize=function(t){this._scale[0]=.5*t[0],this._scale[1]=.5*t[1],this.vMo&&this.vMo.setSize(this._scale)},K.prototype.setAngle=function(t){this._angle=t,this.vMo&&this.vMo.setAngle(t)},K.prototype.setColor=function(t){this._color=t,this.vMo&&this.vMo.setColor(t)},K.prototype.clipX=function(e,i){this._textureCoordinates&&(e=t.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],e),i=t.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],i)),this._clipCoordinates[0]=e,this._clipCoordinates[1]=i,this.vMo&&this.vMo.clipX(e,i)},K.prototype.clipY=function(e,i){this._textureCoordinates&&(e=1-t.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],e),i=1-t.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],i)),this._clipCoordinates[2]=1-i,this._clipCoordinates[3]=1-e,this.vMo&&this.vMo.clipY(e,i)},K.prototype.setClipColor=function(t){this._clipColor=t,this.vMo&&this.vMo.setClipColor(t)},K.prototype.setTextureCoordinates=function(t){this._textureCoordinates=t,this.vMo&&this.vMo.setModel(d.getModel(this._getModelName()).getEgomModel())},K.prototype.setScaleMode=function(t){this._scaleMode=t,this.vMo&&this.vMo.setScaleMode(t)},K.prototype.applyLayout=function(t,e,i){this.setPosition(t.getPosition(e,i)),this.setSize(t.getSize(e,i))},K.prototype.handleGraphicsSettingsChanged=function(){this._class.handleGraphicsSettingsChanged()},St.prototype=new r.HTMLScreenWithCanvases,St.prototype.constructor=St,St.prototype.show=function(){return!!r.HTMLScreenWithCanvases.prototype.show.call(this)&&(document.getElementById(p.GAME_VERSION_LABEL_ID).hidden=!0,!0)},St.prototype.hide=function(){var t;return!!r.HTMLScreenWithCanvases.prototype.hide.call(this)&&(Gt&&(Gt=!1),this.pauseBattle(!0),L(),t=d.isShadowMappingEnabled(),d.setShadowMapping(),t!==d.isShadowMappingEnabled()&&d.handleSettingsChanged(),document.getElementById(p.GAME_VERSION_LABEL_ID).hidden=!1,!0)},St.prototype.setActive=function(t){r.HTMLScreen.prototype.setActive.call(this,t),t?(Ge=S.getBattleSetting(S.BS.PLAY_GENERIC_RADIO_MESSAGES),ke=S.getBattleSetting(S.BS.PLAY_MISSION_RADIO_MESSAGES),je=S.getBattleSetting(S.BS.SHOW_GENERIC_RADIO_MESSAGES),Ln&&!Dt&&navigator.wakeLock.request("screen").then(function(t){Dt=t,Dt.onrelease=function(){Dt=null}}).catch(function(){}),Rt&&document.removeEventListener("visibilitychange",Rt),Rt=Rt||function(){"visible"===document.visibilityState||this._touchControlSheet.isVisible()||this._infoBox.isVisible()||T.getController(T.GENERAL_CONTROLLER_NAME).executeAction("quit")}.bind(this),document.addEventListener("visibilitychange",Rt)):(T.exitPointerLock(),Dt&&Dt.release(),Rt&&(document.removeEventListener("visibilitychange",Rt),Rt=null))},St.prototype._initializeComponents=function(){var t;r.HTMLScreenWithCanvases.prototype._initializeComponents.call(this),t=this.getScreenCanvas("battleCanvas")._canvas,Lt&&window.removeEventListener("resize",Lt),Lt=Lt||function(){T.setScreenCenter(t.width/2,t.height/2)},window.addEventListener("resize",Lt),this._touchControlSheet.hide(),this._touchControlSheet._element.onclick=function(){this._touchControlSheet.hide(),this._doStartBattle()}.bind(this),Lt()},St.prototype._updateComponents=function(){r.HTMLScreenWithCanvases.prototype._updateComponents.call(this)},St.prototype._doStartBattle=function(){this.resumeBattle(),D(),Ht?(T.switchToSpectatorMode(!1,!0),Mt._camera.followNextNode(),Xt=0):T.switchToPilotMode(yt._pilotedCraft,!0)},St.prototype.pauseBattle=function(t,e,i){T.stopListening(),vt=document.body.style.cursor,document.body.style.cursor=n.getDefaultCursor(),Gt&&!t||(-2!==Rn&&clearInterval(Rn),Rn=gn,Mt&&Mt.setShouldAnimate(!1),this.stopRenderLoop()),!1!==e&&(g.resetMusicVolume(),g.setMusicVolume(.5*g.getMusicVolume(),!1)),!1!==i&&(g.resetSFXVolume(),g.setSFXVolume(.1*g.getSFXVolume(),!1),g.resetVoiceVolume(),g.setVoiceVolume(.1*g.getVoiceVolume(),!1)),ye&&ye.stopPlaying(.01)},St.prototype.resumeBattle=function(t,e){document.body.style.cursor=vt||n.getDefaultCursor(),Gt&&!t?T.startListening():Rn===gn?(Nt=performance.now(),Mt&&(Ot||Mt.setShouldAnimate(!0)),Rn=-2,T.startListening(),e&&T.getInputInterpreter(T.KEYBOARD_NAME).setEscapeToPressed(),this.startRenderLoop(1e3/60)):s.showError("Trying to resume simulation while it is already going on!",s.ErrorSeverity.MINOR,"No action was taken, to avoid double-running the simulation."),g.resetMusicVolume(),g.resetSFXVolume(),g.resetVoiceVolume(),T.getInputInterpreter(T.MOUSE_NAME).isEnabled()&&this.requestPointerLock(!0)},St.prototype._updateLoadingStatus=function(t,e){void 0!==t&&this._loadingBox.updateStatus(kt+p.getSubParagraph(t)),void 0!==e&&this._loadingBox.updateProgress(e)},St.prototype._updateLoadingBoxForResourceLoad=function(e,i,s,n){this._updateLoadingStatus(t.formatString(_.get(_.LOADING.RESOURCE_READY),{resource:e,resourceType:i,loaded:n,total:s}),20+n/s*60)},St.prototype._addUITexts=function(){var t,e,i,s=this.getScreenCanvas("battleCanvas"),n=function(t,e,i,s){var n,o;return n=S.gHS(t),o=new r.CanvasText(n.position,"",n.fontName,n.fontSize,e._scaleMode,n.color||n.colors[Object.keys(n.colors)[0]],s),i.addText(o),o},o=function(t){return new r.CanvasText(t,"",S.gHS(S.BS.HUD.SPEED_TEXT).fontName,S.gHS(S.BS.HUD.SPEED_TEXT).fontSize,Cs._scaleMode,S.gHS(S.BS.HUD.SPEED_TEXT).colors.combatForward)};if(ci||(ci=new r.TextLayer(S.gHS(S.BS.HUD.DISTANCE_TEXT_LAYER_LAYOUT)),s.addTextLayer(ci)),ui||(ui=new r.CanvasText(S.gHS(S.BS.HUD.DISTANCE_TEXT).position,"",S.gHS(S.BS.HUD.DISTANCE_TEXT).fontName,S.gHS(S.BS.HUD.DISTANCE_TEXT).fontSize,new r.ClipSpaceLayout(Ss)._scaleMode,S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.hostile,"left",S.gHS(S.BS.HUD.DISTANCE_TEXT).layout),ci.addText(ui)),Mi||(Mi=new r.TextLayer(S.gHS(S.BS.HUD.TARGET_INFO_TEXT_LAYER_LAYOUT)),s.addTextLayer(Mi)),!Ii)for(Ii={},t=0;t<Nn.length;t++)Ii[Nn[t]]=function(t){return new r.CanvasText(S.gHS(S.BS.HUD.TARGET_INFO_TEXT).positions[t],"",S.gHS(S.BS.HUD.TARGET_INFO_TEXT).fontName,S.gHS(S.BS.HUD.TARGET_INFO_TEXT).fontSizes["name"===t?"name":"others"],Es._scaleMode,S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.friendly)}(Nn[t]),Mi.addText(Ii[Nn[t]]);if(Ai||(Ai=new r.TextLayer(S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),s.addTextLayer(Ai)),vi=vi||n(S.BS.HUD.WINGMEN_STATUS_HEADER_TEXT,ys,Ai),vi.setText(_.get(_.BATTLE.HUD_WINGMEN_HEADER)),Ri||(Ri=[]),Vi||(Vi=new r.TextLayer(S.gHS(S.BS.HUD.SPEED_TEXT_LAYER_LAYOUT)),s.addTextLayer(Vi)),Fi||(Fi=o(S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxForward),Vi.addText(Fi)),Ui||(Ui=o(S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxReverse),Vi.addText(Ui)),wi||(wi=new r.TextLayer(S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT_LAYOUT)),s.addTextLayer(wi)),Pi||(Pi=new r.CanvasText(S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).position,"",S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).fontSize,vs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).colors.ready,"right"),wi.addText(Pi)),ji||(ji=new r.TextLayer(S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),s.addTextLayer(ji)),Wi=Wi||n(S.BS.HUD.FLIGHT_MODE_HEADER_TEXT,Ls,ji),Wi.setText(_.get(_.BATTLE.HUD_FLIGHT_MODE)),Yi||(Yi=new r.CanvasText(S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).position,"",S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).fontName,S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).fontSize,Ls._scaleMode,S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).colors.combat),ji.addText(Yi)),zi||(zi=new r.TextLayer(S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).layout),s.addTextLayer(zi)),qi=qi||n(S.BS.HUD.MISSILE_INFO_HEADER_TEXT,Rs,zi),qi.setText(_.get(_.BATTLE.HUD_MISSILES)),!Ji)for(Ji=[],Qi=[],e=2,t=0;t<e;t++)Ji.push(function(t){var e=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).positions.name;return e=[e[0],e[1]+-.3*t],new r.CanvasText(e,"",S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontSize,Rs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected)}(t)),zi.addText(Ji[t]),Qi.push(function(t){var e=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).positions.count;return e=[e[0],e[1]+-.3*t],new r.CanvasText(e,"",S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontSize,Rs._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected,"right")}(t)),zi.addText(Qi[t]);if(Ki||(Ki=new r.TextLayer(S.gHS(S.BS.HUD.HEADER_TEXT_LAYER_LAYOUT)),s.addTextLayer(Ki)),Zi=Zi||n(S.BS.HUD.SMALL_HEADER_TEXT,Ki._clipSpaceLayout,Ki,"center"),$i=$i||n(S.BS.HUD.BIG_HEADER_TEXT,Ki._clipSpaceLayout,Ki,"center"),ts=ts||n(S.BS.HUD.SUBHEADER_TEXT,Ki._clipSpaceLayout,Ki,"center"),is||(i=S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).layout,i.width-=.04,is=new r.TextLayer(i),s.addTextLayer(is)),ss=ss||n(S.BS.HUD.MESSAGE_TEXT,is._clipSpaceLayout,is,"center"),ns||(ns=new r.TextLayer(S.gHS(S.BS.HUD.TOP_LEFT_TEXT_LAYER_LAYOUT)),s.addTextLayer(ns)),os=os||n(S.BS.HUD.SCORE_TEXT,ns._clipSpaceLayout,ns,"left"),as||(as=new r.TextLayer(S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).layout),s.addTextLayer(as)),ls=ls||n(S.BS.HUD.OBJECTIVES_HEADER_TEXT,Ds,as),ls.setText(_.get(_.BATTLE.HUD_OBJECTIVES)),!hs)for(hs=[],e=3,t=0;t<e;t++)hs.push(function(t){var e=S.gHS(S.BS.HUD.OBJECTIVES_TEXT).position;return e=[e[0],e[1]+-.42*t],new r.CanvasText(e,"",S.gHS(S.BS.HUD.OBJECTIVES_TEXT).fontName,S.gHS(S.BS.HUD.OBJECTIVES_TEXT).fontSize,Ds._scaleMode,S.gHS(S.BS.HUD.OBJECTIVES_TEXT).colors.inProgress)}(t)),as.addText(hs[t]);if(us||(us=new r.TextLayer(S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).layout),s.addTextLayer(us)),_s=_s||n(S.BS.HUD.ESCORTS_HEADER_TEXT,ws,us),_s.setText(_.get(_.BATTLE.HUD_ESCORTED_SHIPS_HEADER)),!ps)for(ps=[],e=6,t=0;t<e;t++)ps.push(function(t){var e=S.gHS(S.BS.HUD.ESCORTS_TEXT).position;return e=[e[0],e[1]+-.26*t],new r.CanvasText(e,"",S.gHS(S.BS.HUD.ESCORTS_TEXT).fontName,S.gHS(S.BS.HUD.ESCORTS_TEXT).fontSize,ws._scaleMode,S.gHS(S.BS.HUD.ESCORTS_TEXT).colors.alive)}(t)),us.addText(ps[t])},St.prototype.toggleDevInfoVisibility=function(){Zi.isVisible()?(Zi.hide(),S.setHUDSetting(S.BS.HUD.SHOW_VERSION_INFO,!1)):this._stats.isVisible()?(this._stats.hide(),S.setHUDSetting(S.BS.HUD.SHOW_FPS_COUNTER,!1)):(this._stats.show(),Zi.show(),S.setHUDSetting(S.BS.HUD.SHOW_VERSION_INFO,!0),S.setHUDSetting(S.BS.HUD.SHOW_FPS_COUNTER,!0))},St.prototype.showMessage=function(t,e,i){this._infoBox.updateMessage(t,void 0,i),this._infoBox.onButtonClick(function(){p.playButtonClickSound(),e&&e()}),this._infoBox.show(),T.exitPointerLock()},St.prototype.setHeaderContent=function(t,e){$i&&$i.setText(t,e)},St.prototype.setSubheaderContent=function(t,e){ts&&ts.setText(t,e)},St.prototype.queueHUDMessage=function(t,e){var i,n,o,r,a,l,h,c,u;for(i=(t.source?"{spacecrafts/"+t.source.getID()+"}: ":"")+t.text,n=i.indexOf("{");n>=0;n=i.indexOf("{"))if((o=i.indexOf("}"))>=0){switch(l=i.substring(n+1,o).split("/"),l[0]){case"controlStrings":h="[color:"+on.colors.controlString.join(",")+"]"+T.getInputInterpreter(l[1]).getControlStringForAction(l[2])+"[]";break;case"spacecrafts":u=yt.getSpacecraft(l[1]),h="[color:"+(Kt.isHostile(u)?on.colors.hostileSpacecraft:on.colors.friendlySpacecraft).join(",")+"]"+u.getDisplayName()+"[]";break;default:s.showError("Unknown reference type specified in HUD message: '"+l[0]+"'!"),h=""}i=i.substring(0,n)+h+i.substr(o+1)}else s.showError("Unclosed reference in HUD message: '"+t.text+"'!");for(a=0,c=!1,r=0;r<i.length;r++)"["===i[r]?c=!0:"]"===i[r]?c=!1:!1===c&&"\n"!==i[r]&&a++;t.text=i,t.new=!0,t.timeLeft=t.duration||Math.round(70*a+400),t.appearDuration=t.appearAnimation?Math.round(7*a):0,t.appearTimeLeft=t.appearDuration||0,t.queue=t.queue||"info",e?Se[t.queue].unshift(t):Se[t.queue].push(t),t.queue===An&&(We=!0)},St.prototype.clearHUDMessages=function(t){Se[t||"info"]=[]},St.prototype.clearHUDMessageQueues=function(){var t;for(t=0;t<vn.length;t++)Se[vn[t]]=[]},St.prototype._updateHUD=function(n){var o,r,l,h,c,u,p,m,E,y,M,I,A,O,L,R,b,x,D,w,P,V,F,U,B,H,G,k,j,W,Y,X,z,q,J,Q,K,Z,it,at,lt,ht,ct,ut,St,Tt,Et,It,Ct,At,vt,Nt,Ot,Lt,Rt,bt,xt,Dt,wt,Pt,Vt,Ft,Ut,Bt,Gt,kt,jt,Wt,Yt,Xt,zt,qt,Jt,Qt,fe,Le,be,De,we,Fe,Be,He,Ge,qe,Je,Ke,vi,Wi,qi,Ki=yt?yt.getFollowedSpacecraftForScene(Mt):null,Zi=this.getScreenCanvas("battleCanvas")._canvas;if(Le=!1,Ki&&Ze){if(Xe=(Xe+n)%Qe,ze=Xe<.5*Qe,Gt=Ki.getView(Mt._camera.getConfiguration()._name)._isAimingView,$i.show(),T.isInPilotMode()?(ts.hide(),ft(ln.SCORE)?(os.setText(t.formatString(_.get(_.BATTLE.SCORE),{score:Math.round(Ki.getScore())})),os.show()):os.hide()):(ts.setText(Ki.getDisplayName()||Ki.getClass().getDisplayName()),ts.show(),os.hide()),Gt?$e.show():$e.hide(),He=T.getInputInterpreter(T.MOUSE_NAME),T.isListening()&&He.isEnabled()&&T.isInPilotMode()&&!T.isControllerPriority(T.CAMERA_CONTROLLER_NAME)&&!T.isMouseTurningDisabled()&&!Ki.isManeuveringLocked()?(Q=He._mousePosition,Q=[2*(Q[0]/Zi.width-.5),2*(.5-Q[1]/Zi.height)],He.isMouseDisplaced()?(si.hide(),ni.show(),ni.setPosition(Q),z=e.angle2y(Q[0]*Zi.width/Zi.height,Q[1]),ni.setAngle(z*(Q[0]<0?-1:1))):(si.show(),ni.hide(),si.setPosition(Q))):(si.hide(),ni.hide()),Ct=Ki.getRelativeVelocityMatrix(),D=Ct[13],ft(ln.SPEED_BAR)){if(w=Math.abs(D),x=Ki.getMaxAcceleration(),!(P=Ki.getMaxSpeed()))for(P=3*x||10,V=3,F=2;P+F<w;)P*=V;Ki.hasSpeedTarget()&&(B=Ki.getSpeedTarget(),B=D*B>=0?Math.abs(B):0),U=Math.min(w/P,1),Z=S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxForward,it=S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxReverse,Ft=S.gHS(S.BS.HUD.SPEED_BAR).colors,Ge=Ki.getFlightMode(),D>=0?(bi.setColor(Ft[Ge+"Filled"]),bi.setClipColor(Ft[Ge+"Empty"]),bi.clipY(0,U),Fi.setPosition(Z),Fi.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[Ge+"Forward"]),Fi.setText(Math.max(P,D).toFixed()),Ui.setPosition([Z[0],it[1]+(Z[1]-it[1])*U]),Ui.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[Ge+"Forward"]),Ui.setText(w.toFixed()),xi.clipX(.5-As[0]/2,.5+As[0]/2),Ki.hasSpeedTarget()?(xi.clipY(B/P-As[1]/2,B/P+As[1]/2),xi.show()):xi.hide()):(bi.setColor(Ft[Ge+"ReverseFilled"]),bi.setClipColor(Ft[Ge+"ReverseEmpty"]),bi.clipY(1-U,1),Fi.setPosition(it),Fi.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[Ge+"Reverse"]),Fi.setText(Math.min(-P,D).toFixed()),Ui.setPosition([Z[0],Z[1]-(Z[1]-it[1])*U]),Ui.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[Ge+"Reverse"]),Ui.setText("-"+w.toFixed()),xi.clipX(.5-As[0]/2,.5+As[0]/2),Ki.hasSpeedTarget()?(xi.clipY(1-(B/P+As[1]/2),1-(B/P-As[1]/2)),xi.show()):xi.hide()),bi.applyLayout(Cs,Zi.width,Zi.height),bi.show(),xi.applyLayout(Cs,Zi.width,Zi.height),Vi.show()}else bi.hide(),xi.hide(),Vi.hide();if(Gt&&ft(ln.DRIFT_ARROW)?(K=[Ct[12],Ct[14]],H=e.extractLength2(K),H>$s?(Bi.show(),c=Mt._camera._aspect,k=.35*(t.yScalesWithHeight(fs,Zi.width,Zi.height)?1:c),Bi.setPosition2(K[0]/c*k,K[1]*k),Bi.setAngle(Math.acos(K[1])*(K[0]<0?-1:1)),G=tn*x,0===G&&(G=P),Bi.setColor(t.getMixedColor(S.gHS(S.BS.HUD.DRIFT_ARROW).colors.minSpeed,S.gHS(S.BS.HUD.DRIFT_ARROW).colors.maxSpeed,Math.min((H-$s)/(G-$s),1)))):Bi.hide()):Bi.hide(),R=Ki.getHullIntegrity(),b=Ki.getShieldIntegrity(),Ki!==Kt?(Kt=Ki,N(),$t=Ki._mClasses,ie=R,se=b,M=0,I=0,ae=0,le=0):(R<ie?(ae=Bs,M=1):ae>0&&(ae-=n,M=ae/Bs),ie=R,b<se?(le=Hs,I=1):le>0&&(le-=n,I=le/Hs),se=b),Ft=S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors,ft(ln.HULL_BAR)?(ae>0?(Hi.setColor(t.getMixedColor(Ft.filled,Ft.filledWhenDecreasing,M)),Hi.setClipColor(t.getMixedColor(Ft.empty,Ft.emptyWhenDecreasing,M))):(Hi.setColor(Ft.filled),Hi.setClipColor(Ft.empty)),Hi.clipY(0,R),Hi.applyLayout(Ns,Zi.width,Zi.height),Hi.show()):Hi.hide(),Ki.hasShield()&&ft(ln.SHIELD_BAR)?(Ft=S.gHS(S.BS.HUD.SHIELD_BAR).colors,le>0?(Gi.setColor(t.getMixedColor(Ft.filled,Ft.filledWhenDecreasing,I)),Gi.setClipColor(t.getMixedColor(Ft.empty,Ft.emptyWhenDecreasing,I))):(Gi.setColor(Ft.filled),Gi.setClipColor(Ft.empty)),Gi.clipY(0,b),Gi.applyLayout(Os,Zi.width,Zi.height),Gi.show()):Gi.hide(),ft(ln.FLIGHT_MODE)){switch(ki.applyLayout(Ls,Zi.width,Zi.height),ki.show(),Yi.setText(_.get(_.FLIGHT_MODE.PREFIX,Ki.getFlightMode(),Ki.getFlightMode())),Ft=S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).colors,Ki.getFlightMode()){case C.FlightMode.FREE:Yi.setColor(Ft.free);break;case C.FlightMode.COMBAT:Yi.setColor(Ft.combat);break;case C.FlightMode.CRUISE:Yi.setColor(Ft.cruise);break;default:s.showError("Unknown flight mode: "+Ki.getFlightMode()+"!")}ji.show()}else ki.hide(),ji.hide();if(q=0,$t.length>0){for(Ft=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors,l=Ki.getActiveMissileLauncher(),W=0,u=0;u<Ji.length;u++)u<$t.length?(Ge=$t[u]._shortName,m=Ki.getMissileCount($t[u]),Qi[u].setText(m.toString()),m<=0?Nt=Ft.empty:l&&l._class===$t[u]?(Ki.getTarget()&&(q=Ki.getMissileLockRatio()),jt=q>=1||$t[u]._homingMode===f.MissileHomingMode.NONE&&Ki.isInLockingRange(),be=l.isReady(),Nt=be?jt?Ft.readySelected:Ft.lockingSelected:Ft.loadingSelected,l._salvo&&(Ge+=" ("+Math.min(l.getSalvo(),l.getMissileCount())+")"),W=m,jt?(Oe?be&&!Ie&&Me.play():Ne.play(),Oe=!0,$t[u]._homingMode===f.MissileHomingMode.NONE&&(q=-1)):(U=q*Ae,U<=0?ve=0:(U=Math.floor(U)+1,U>ve?(ve++,Ce.play()):U<ve&&(ve=0)),Oe=!1),Ie=be):Nt=Ft.notSelected,Ji[u].setText(Ge),Ji[u].setColor(Nt),Qi[u].setColor(Nt),Ji[u].show(),Qi[u].show()):(Ji[u].hide(),Qi[u].hide());ft(ln.MISSILE_INFO)?(Xi.applyLayout(Rs,Zi.width,Zi.height),Xi.show(),zi.show()):(Xi.hide(),zi.hide()),W>0&&ft(ln.MISSILE_INDICATOR)?(Di.setTextureCoordinates(S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings[l._salvo?"salvo":"single"]),Ft=S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors,U=l.getLoadRatio(),U<1?(Di.setColor(Ft.locking),Di.setClipColor(Ft.loading),Di.clipY(0,U)):(Di.setColor(Ft.ready),Di.setClipColor(Ft.locking),Di.clipY(0,Math.abs(q))),Di.applyLayout(vs,Zi.width,Zi.height),Di.show(),Pi.setText(W.toString()),Ft=S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).colors,Pi.setColor(U>=1?jt?Ft.ready:Ft.locking:Ft.loading),wi.show()):(Di.hide(),wi.hide())}else Xi.hide(),zi.hide(),Di.hide(),wi.hide();if(!Ht&&T.isInPilotMode()){if(ft(ln.OBJECTIVES)){for(rs.applyLayout(Ds,Zi.width,Zi.height),rs.show(),qe=yt.getObjectivesState(),Ft=S.gHS(S.BS.HUD.OBJECTIVES_TEXT).colors,u=0;u<hs.length;u++)if(u<qe.length){switch(hs[u].setText(qe[u].text),qe[u].state){case an.IN_PROGRESS:hs[u].setColor(Ft.inProgress);break;case an.COMPLETED:hs[u].setColor(Ft.completed);break;case an.FAILED:hs[u].setColor(Ft.failed)}hs[u].show()}else hs[u].hide();as.show()}else rs.hide(),as.hide();if(vi=te.filter(pt),vi.length>0&&ft(ln.ESCORTS)){for(cs.applyLayout(ws,Zi.width,Zi.height),cs.show(),u=0;u<ps.length;u++)u<vi.length?(ps[u].setText(vi[u].getDisplayName()||_.get(_.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),Qt=vi[u]._away,Ft=S.gHS(S.BS.HUD.ESCORTS_TEXT).colors,ps[u].setColor(vi[u]._alive?Qt?Ft.away:Ft.alive:Ft.destroyed),ds[u].hull.setColor(Qt?en.colors.awayHull:gt(vi[u].getHullIntegrity(),en.colors.fullHull,en.colors.halfHull,en.colors.zeroHull)),ds[u].hull.clipX(0,vi[u].getHullIntegrity()),ds[u].hull.applyLayout(ds[u].hullLayout,Zi.width,Zi.height),ps[u].show(),ds[u].hull.show(),vi[u].hasShield()&&!Qt?(ds[u].shield.clipX(0,vi[u].getShieldIntegrity()),ds[u].shield.applyLayout(ds[u].shieldLayout,Zi.width,Zi.height),ds[u].shield.show()):ds[u].shield.hide()):(ps[u].hide(),ds[u].hull.hide(),ds[u].shield.hide());us.show()}else for(cs.hide(),us.hide(),u=0;u<ds.length;u++)ds[u].hull.hide(),ds[u].shield.hide()}else for(rs.hide(),as.hide(),cs.hide(),us.hide(),u=0;u<ds.length;u++)ds[u].hull.hide(),ds[u].shield.hide();for(u=0;u<vn.length&&0===Se[vn[u]].length;)u++;if(T.isInPilotMode()&&u<vn.length){if(qi=Se[vn[u]],qi[0].new&&(Ue=!1,ke&&(Ve[qi[0].id]?(g.stopLastClips(),Ve[qi[0].id].play(a.SoundCategory.VOICE,void 0,void 0,void 0,!0),Ue=!0,qi[0].silent=!0):qi[0].source&&(p=v.getVoiceOfSpacecraft(qi[0].source))>=0&&Pe[p][qi[0].id]&&(g.stopLastClips(),Pe[p][qi[0].id].play(a.SoundCategory.VOICE,void 0,void 0,void 0,!0),Ue=!0,qi[0].silent=!0)),qi[0].silent||qi[0].appearTimeLeft||Ee.play(),qi[0].new=!1),Jt=!1,vn[u]===An){if(We){for(Ge=qi[0].text,p=1;p<qi.length&&p<5;p++)qi[p].timeLeft>0?Ge+="\n"+qi[p].text:(qi.splice(p,1),p--);je?ss.setText(Ge):(ss.setText(""),Jt=!0),We=!1}}else ss.setText(qi[0].text);qi[0].appearTimeLeft>0?(ss._revealState=1-qi[0].appearTimeLeft/qi[0].appearDuration,qi[0].appearTimeLeft-=n,qi[0].silent||(ye.setVolume(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).volume),ye.play())):(ss._revealState=1,ye.stopLoop()),Nt=qi[0].color?qi[0].color:on.colors.default,qi[0].blinkInterval>0&&(Nt=Nt.slice(),Nt[3]=Nt[3]*Math.abs((qi[0].duration-qi[0].timeLeft)%qi[0].blinkInterval/qi[0].blinkInterval-.5)*2),ss.setColor(Nt),Te=qi[0].timeLeft>0?qi[0].source:null,qi[0].permanent||(qi[0]===Re?(qi[0].timeLeft=xe,xe<=0&&(Jt=!0)):vn[u]!==An&&(qi[0].timeLeft-=n)),Jt?(is.hide(),es.hide()):(qi[0].noBackground?es.hide():(es.applyLayout(Ps,Zi.width,Zi.height),es.show()),is.show()),qi[0].timeLeft<=0&&(qi.shift(),qi.length>0&&(qi[0].new=!0))}else is.hide(),es.hide(),ye.stopPlaying(.01),Te=null,Ue=!1;for(xe>0&&(xe-=n),qi=Se[An],u=0;u<qi.length;u++)qi[u].timeLeft>0&&(qi[u].timeLeft-=n,qi[u].timeLeft<=0&&(We=!0));if(o=Ki.getTarget(),ne!==o?(ne=o,Yt=!0,ue=Vs,O=1,pe=0,ge=0):ue>0?(ue-=n,O=ue/Vs):O=0,A=_e>0?_e/Fs:0,De=!1,we=!1,Fe=!1,Be=!1,o){if(ut=o.getPhysicalPositionVector(),ct=Ki.getPhysicalPositionVector(),St=e.diff3(ut,ct),h=e.length3(St),J=Ki._ws,Wt=o.isHostile(Ki),J.length>0){for(Tt=Ki.getTargetHitPosition(),!gs&&ft(ln.AIM_ASSIST_INDICATOR)&&(pi.setPosition(Tt),Nt=Wt?S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile:S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.friendly,ue>0||_e>0?(M=Math.max(O,A),pi.setColor(t.getMixedColor(Nt,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.appear,M)),pi.setSize(e.scaled2(Ks,1+(Zs-1)*M))):pe>0?(M=pe/Us,pi.setColor(t.getMixedColor(Nt,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hit,M))):(pi.setColor(Nt),pi.setSize(Ks)),pi.show(),De=!0),y=e.length3(e.diff3Aux(Tt,ct)),Ut=Ki.pMo.oM,E=Ki.vMo.sM[0],Bt=Ki.getScaledOriMatrix(),jt=!1,u=0;u<J.length;u++)ti.length<=u&&(ti.push(st()),ti[u].addToScene(Mt)),J[u]._fixed?(Et=J[u]._origoPositionMatrix,At=e.sum3(ct,e.getRowB43ScaledAux(Ut,y)),e.add3(At,e.scaled3Aux(e.getRowA43Aux(Ut),Et[12]*E)),e.add3(At,e.getRowC43ScaledAux(Ut,Et[14]*E))):(It=J[u].getBasePointPosVector(Bt),At=e.sum3(It,e.getRowB43ScaledAux(J[u].getProjectileOrientationMatrix(),e.length3(e.diff3Aux(Tt,It))))),gs&&e.sub3(At,e.diff3Aux(Tt,ut)),ti[u].setPosition(At),y<=J[u].getRange(D)?(ti[u].setColor(S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal),jt=!0):ti[u].setColor(S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.outOfRange),ue>0?ti[u].setSize(e.scaled2(Js,1+(Qs-1)*O)):ti[u].setSize(Js),ti[u].show();if(ft(ln.WEAPON_IMPACT_INDICATORS)){for(;u<ti.length;)ti[u].hide(),u++;we=!0}!jt||Ki.isFighter()&&e.dot3(e.getRowB43Aux(Ut),St)<0?(De=!1,_e=Fs):_e-=n}R=o.getHullIntegrity(),b=o.getShieldIntegrity(),ft(ln.TARGET_INFO)&&(Ti.applyLayout(Es,Zi.width,Zi.height),Ti.show(),Si=gt(R,S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR),S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR),S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR)),gi!==o&&(di.clearNodes(!0),mi=null,gi=o,gi.addToScene(di,d.getMaxLoadedLOD(),!0,On,fi,mt)),mi&&mi.setOrientationM4(ms?i.prod3x3SubOf4Aux(o.pMo.oM,i.inverseOfRotation4Aux(i.lookTowards4Aux(e.normalize3(e.diffTranslation3Aux(Ki.pMo.pM,o.pMo.pM)),e.getRowC43Aux(Ki.pMo.oM)))):i.IDENTITY4),di.setRelativeViewport(Ts.getPositiveLeft(Zi.width,Zi.height),Ts.getPositiveBottom(Zi.width,Zi.height),Ts.getPositiveWidth(Zi.width,Zi.height),Ts.getPositiveHeight(Zi.width,Zi.height)),Ei.clipX(0,R),Ei.applyLayout(Ms,Zi.width,Zi.height),Ei.show(),o.hasShield()?(yi.clipX(0,b),yi.applyLayout(Is,Zi.width,Zi.height),yi.show()):yi.hide(),Ot=Wt?S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.hostile:S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.friendly,Ii.name.setColor(Ot),Ii.name.setText(o.getDisplayName()||_.get(_.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),Ii.team.setColor(Ot),Ii.team.setText(o._team?o._team.getDisplayName():_.get(_.BATTLE.HUD_TEAM_UNKNOWN)),Ii.class.setColor(Ot),Ii.class.setText(o.getClass().getDisplayName()),Ii.firepower.setColor(Ot),j=o.getTarget()&&o.getTarget().getClass()._armor,Ii.firepower.setText(_.get(_.BATTLE.HUD_FIREPOWER)+": "+(j?o.getFirepower(j).toFixed(1)+" / ":"")+o.getFirepower().toFixed(1)),Ii.distance.setColor(Ot),Ii.distance.setText(_.get(_.BATTLE.HUD_DISTANCE)+": "+t.getLengthString(h)),Ii.velocity.setColor(Ot),Ii.velocity.setText(_.get(_.BATTLE.HUD_VELOCITY)+": "+i.translationLength(o.pMo._velocityMatrix).toFixed()+" m/s"),Mi.show(),Fe=!0),Gt&&(ei.clipX(.5-R/2,.5+R/2),ei.applyLayout(bs,Zi.width,Zi.height),o.hasShield()?(ii.clipX(.5-b/2,.5+b/2),ii.applyLayout(xs,Zi.width,Zi.height),ii.show()):ii.hide(),Yt?(oe=R,re=b,he=0,ce=0,M=0,I=0):(R<oe?(he=Gs,M=1):he>0&&(he-=n,M=he/Gs),oe=R,b<re?(ce=ks,I=1):ce>0&&(ce-=n,I=ce/ks),re=b),Ft=S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors,Lt=Wt?Ft.hostileFilled:Ft.friendlyFilled,Rt=Wt?Ft.hostileEmpty:Ft.friendlyEmpty,he>0?ei.setColor(t.getMixedColor(Lt,Ft.filledWhenDecreasing,M)):ei.setColor(Lt),ei.setClipColor(Rt),ei.show(),o.hasShield()?(Ft=S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors,ce>0?ii.setColor(t.getMixedColor(Ft.filled,Ft.filledWhenDecreasing,I)):ii.setColor(Ft.filled),ii.setClipColor(Ft.empty),ii.show()):ii.hide(),Be=ft(ln.TARGET_INDICATOR))}if(De||pi.hide(),!we)for(u=0;u<ti.length;u++)ti[u].hide();if(Fe||(Ti.hide(),gi&&(di.clearNodes(!0),gi=null,mi=null),Ei.hide(),yi.hide(),Mi.hide()),Be||(ei.hide(),ii.hide(),ci.hide()),Zt.length>0&&ft(ln.WINGMEN_INFO)){for(Ci.applyLayout(ys,Zi.width,Zi.height),Ci.show(),Ai.show(),m=0,zt=!1,u=0;u<Zt.length;u++)for(Ri.length<=u&&(Ri.push(rt(u)),Ai.addText(Ri[u])),Ri[u].setText(_.get(_.SQUAD.PREFIX,Zt[u].name,Zt[u].name)),Ri[u].show(),W=Math.min(Zt[u].crafts.length,nn),p=0;p<W;p++)r=Zt[u].crafts[p],Li.length<=m&&(Li.push(nt(u,W,p)),Oi.length>m&&Oi[m].body.setTextureCoordinates(sn.mappings[r.getTypeName()]||sn.mappings.general)),Oi.length<=m&&(Oi.push({body:ot(Li[m],r.getTypeName()),shield:ot(Li[m],"shield")}),Oi[m].body.addToScene(Mt),Oi[m].shield.addToScene(Mt)),Oi[m].body.applyLayout(Li[m],Zi.width,Zi.height),Oi[m].shield.applyLayout(Li[m],Zi.width,Zi.height),Oi[m].body.setColor(r._alive?r._away?sn.colors.away:gt(r.getHullIntegrity(),sn.colors.fullIntegrity,sn.colors.halfIntegrity,sn.colors.zeroIntegrity):sn.colors.destroyed),Oi[m].body.show(),r._alive&&!r._away&&r.hasShield()?(Oi[m].shield.setColor(gt(r.getShieldIntegrity(),sn.colors.fullShieldIntegrity,sn.colors.halfShieldIntegrity,sn.colors.zeroShieldIntegrity)),Oi[m].shield.show()):Oi[m].shield.hide(),r===Ki&&(Ni||(Ni=ot(Li[m],"player"),Ni.addToScene(Mt)),Ni.applyLayout(Li[m],Zi.width,Zi.height),Ni.setColor(Oi[m].body._color),Ni.show(),zt=!0),m++;for(;u<Ri.length;)Ri[u].hide(),u++;for(u=m;u<Oi.length;u++)Oi[u].body.hide(),Oi[u].shield.hide();!zt&&Ni&&Ni.hide()}else{for(Ci.hide(),Ai.hide(),u=0;u<Oi.length;u++)Oi[u].body.hide(),Oi[u].shield.hide();Ni&&Ni.hide()}for(vi=yt.getSpacecrafts().filter(_t),Wi=Ki._tedBy.filter(_t),c=Mt._camera._aspect,M=Math.abs(2*me/js-1),Ft=S.gHS(S.BS.HUD.SHIP_INDICATOR).colors,bt=t.getMixedColor(Ft.hostile,Ft.hostileHighlight,M),xt=t.getMixedColor(Ft.friendly,Ft.friendlyHighlight,M),Ft=S.gHS(S.BS.HUD.SHIP_ARROW).colors,Dt=t.getMixedColor(Ft.hostile,Ft.hostileHighlight,M),wt=t.getMixedColor(Ft.friendly,Ft.friendlyHighlight,M),T.isInPilotMode()&&Re&&xe>0?(qt=!0,M=2*Math.abs((Re.duration-xe)%Re.blinkInterval/Re.blinkInterval-.5),Pt=t.getMixedColor(S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.hostile,S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.newHostile,M),Vt=t.getMixedColor(S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,S.gHS(S.BS.HUD.SHIP_ARROW).colors.newHostile,M)):qt=!1,X=0,u=0;u<vi.length;u++){if(De=vi[u]===o&&ft(ln.TARGET_INDICATOR)||vi[u]!==o&&ft(ln.SHIP_INDICATORS)&&Ki.isInSensorRange(vi[u]),fe=vi[u]===Te,oi.length<=u&&(oi.push($()),oi[u].addToScene(Mt)),ut=vi[u].getPhysicalPositionVector(),Ke=oi[u],Ke.setPosition(ut),Wt=vi[u].isHostile(Ki),L=vi[u].vMo.updateVisibleSize({camera:Mt._camera},!0).width*Ys,lt=vi[u]===o?Ws.targetMinimum:Ws.minimum,at=[Math.min(Math.max(lt[0],L),Ws.maximum[0]),Math.min(Math.max(lt[1],L),Ws.maximum[1])],Ft=S.gHS(S.BS.HUD.SHIP_INDICATOR).colors,fe&&Ke.setColor(Ft.transmission),vi[u]===o?(fe||Ke.setColor(Wt?qt&&Ye.indexOf(vi[u])>=0?t.getMixedColor(Ft.hostileTarget,Ft.newHostile,M):Ft.hostileTarget:Ft.friendlyTarget),ue>0?Ke.setSize(e.scaled2(at,1+(Xs-1)*O)):Ke.setSize(at)):(fe||Ke.setColor(qt&&Ye.indexOf(vi[u])>=0?Pt:Wi.indexOf(vi[u])>=0?Wt?bt:xt:Wt?Ft.hostile:Ft.friendly),Ke.setSize(at)),De?Ke.show():Ke.hide(),ri.length<=u&&(ri.push(et()),ri[u].addToScene(Mt)),vt=i.getRowD4(vi[u].pMo.pM),e.mulVec3ViewProj(vt,Mt._camera.getViewMatrix(),Mt._camera.getProjectionMatrix()),kt=vt[3]<0,e.normalize4D(vt),Ke=ri[u],kt||vt[0]<-1||vt[0]>1||vt[1]<-1||vt[1]>1)De?Ke.show():Ke.hide(),vt[0]*=c,e.normalize2(vt),kt&&(vt[0]*=-1,vt[1]*=-1),k=.44*(t.yScalesWithHeight(fs,Zi.width,Zi.height)?1/c:1),Ke.setPosition2(vt[0]*k,vt[1]*c*k),Ke.setAngle(Math.acos(vt[1])*(vt[0]<0?-1:1)),Ft=S.gHS(S.BS.HUD.SHIP_ARROW).colors,fe&&Ke.setColor(Ft.transmission),vi[u]===o?(fe||Ke.setColor(Wt?qt&&Ye.indexOf(vi[u])>=0?t.getMixedColor(Ft.hostileTarget,Ft.newHostile,M):Ft.hostileTarget:Ft.friendlyTarget),ue>0?Ke.setSize(e.scaled2(zs.target,1+(qs-1)*O)):Ke.setSize(zs.target),ci.hide()):(fe||Ke.setColor(qt&&Ye.indexOf(vi[u])>=0?Vt:Wi.indexOf(vi[u])>=0?Wt?Dt:wt:Wt?Ft.hostile:Ft.friendly),Ke.setSize(zs.default));else if(Ke.hide(),vi[u]===o&&De)if(ui.setText(dt(h)),
ui.setColor(Wt?S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.hostile:S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.friendly),Y=.5*at[1]*(t.scalesWithWidth(oi[u]._scaleMode,c,1)?c:1),Q=[vt[0],vt[1]-Y],Xt=t.scalesWithWidth(ui._boxLayout._scaleMode,c,1),ht=[Ss.width/(Xt?1:c),Ss.height*(Xt?c:1)],ui._boxLayout.setPosition(Q[0]+.5*ht[0],Q[1]-.5*ht[1]),ui.invalidateLayout(),ui.setPosition([Q[0]+.05*ht[0],Q[1]-.95*ht[1]]),ci.show(),S.gHS(S.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER)||(Q[1]=vt[1]+Y,ei.setPosition([(.5+.5*Q[0])*Zi.width,(.5-.5*(Q[1]+1.5*bs.getClipSpaceHeight()))*Zi.height]),ii.setPosition([(.5+.5*Q[0])*Zi.width,(.5-.5*(Q[1]+1.75*bs.getClipSpaceHeight()+xs.getClipSpaceHeight()))*Zi.height])),q>0){for(k=.5*at[1]*.8*(t.yScalesWithHeight(oi[u]._scaleMode,Zi.width,Zi.height)?1/c:1),q<1?(li+=-.0032*n,hi=0):(li=Math.radians(45),hi=(hi+n/500)%1),z=li,Ft=S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).colors,Nt=Wt?Ft.hostileTarget:Ft.friendlyTarget,ht=e.scaled2(at,.14),p=0;p<ai.length;p++)Ke=ai[p],q<1||hi>.25&&hi<.75?(Ke.setPosition2(vt[0]+Math.cos(z)*k,vt[1]+Math.sin(z)*c*k),Ke.setSize(ht),Ke.setAngle(-.5*Math.PI-z),Ke.setColor(Nt),Ke.show(),z+=2*Math.PI/4):Ke.hide();Le=!0}else if(-1===q&&!gs&&ft(ln.AIM_ASSIST_INDICATOR)&&(D=Ki.getActiveMissileLauncher().getTargetHitTime(),Tt=[ut[0]+(o.pMo._velocityMatrix[12]-Ki.pMo._velocityMatrix[12])*D,ut[1]+(o.pMo._velocityMatrix[13]-Ki.pMo._velocityMatrix[13])*D,ut[2]+(o.pMo._velocityMatrix[14]-Ki.pMo._velocityMatrix[14])*D,1],e.mulVec3ViewProj(Tt,Mt._camera.getViewMatrix(),Mt._camera.getProjectionMatrix()),Tt[3]>0)){for(e.normalize4D(Tt),k=.02*(t.yScalesWithHeight(oi[u]._scaleMode,Zi.width,Zi.height)?1/c:1),z=Math.radians(45),Ft=S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).colors,Nt=Wt?Ft.hostileTarget:Ft.friendlyTarget,E=.015,ue>0||de>0?(M=Math.max(O,de/Fs),Nt=t.getMixedColor(Nt,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.appear,M),k*=1+(Zs-1)*M):ge>0&&(M=ge/Us,Nt=t.getMixedColor(Nt,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hit,M)),p=0;p<ai.length;p++)Ke=ai[p],Ke.setPosition2(Tt[0]+Math.cos(z)*k,Tt[1]+Math.sin(z)*c*k),Ke.setSize([E,E]),Ke.setAngle(-.5*Math.PI-z),Ke.setColor(Nt),Ke.show(),z+=2*Math.PI/4;Le=!0}for(p=0;p<vi.length&&(!vi[p].isHostile(Ki)||ee.indexOf(vi[p])>=0);)p++;if(Je=[],fe&&Je.push("transmission"),te.indexOf(vi[u])>=0&&Je.push("protect"),p<vi.length&&ee.indexOf(vi[u])>=0&&Je.push("destroy"),Je.length>0&&De)if(ri[u].isVisible())_i.length<=X&&(_i.push(tt(Je[0])),_i[X].addToScene(Mt)),Ke=_i[X],X++,Ke.setColor(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors[Je[0]]||ri[u]._color),Ke.setScaleMode(ri[u]._scaleMode),Ke.setSize(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.arrow),Ke.setPosition(e.scaled2([vt[0],vt[1]*c],(.44+1.5*ri[u]._scale[0])*(t.yScalesWithHeight(fs,Zi.width,Zi.height)?1/c:1))),Ke.setTextureCoordinates(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[Je[0]]),Ke.show();else for(Xt=t.scalesWithWidth(oi[u]._scaleMode,c,1),Y=.5*at[1]*(Xt?c:1),Q=[vt[0],vt[1]-Y],ht=S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,ht=[.5*ht[0]/(Xt?1:c),.5*ht[1]*(Xt?c:1)],p=0;p<Je.length;p++)_i.length<=X&&(_i.push(tt(Je[p])),_i[X].addToScene(Mt)),Ke=_i[X],X++,Ke.setColor(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors[Je[p]]||oi[u]._color),Ke.setScaleMode(oi[u]._scaleMode),Ke.setSize(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle),Ke.setPosition2(Q[0]-ht[0]*(1.2+2.1*(Je.length-1-p)),Q[1]-1.2*ht[1]),Ke.setTextureCoordinates(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[Je[p]]),Ke.show()}for(;u<oi.length;)oi[u].hide(),ri[u].hide(),u++;for(;X<_i.length;)_i[X].hide(),X++;Mt.showUI()}else Ze?$i.show():$i.hide(),ts.hide(),os.hide(),Mt.hideUI(),di.clearNodes(!0),gi=null,mi=null,Mi.hide(),Vi.hide(),ji.hide(),zi.hide(),wi.hide(),as.hide(),us.hide(),is.hide(),ye.stopPlaying(.01),ci.hide(),Ai.hide();if(me=(me+n)%js,Le)de-=n;else for(li=Math.radians(45),hi=0,de=Fs,u=0;u<ai.length;u++)ai[u].hide();pe>0?pe-=n:pe=0,ge>0?ge-=n:ge=0},St.prototype._render=function(e){var i,s,o,a;if(-2===Rn&&O(),Mt&&(Mt._camera.update(Rn!==gn?e:0),this._updateHUD(e)),r.HTMLScreenWithCanvases.prototype._render.call(this,e),Mt&&this._stats.isVisible()&&this._stats.setTextContent(this.getFPSStats()),Rn!==gn)if(Ht)yt&&zt!==yt._state&&(zt=yt._state)===M.MissionState.ENDED&&g.playMusic("ambient");else{if((s=yt._pilotedCraft)&&s._alive&&s._away)return void(Qt>1500?Et():Qt+=e);yt&&zt!==yt._state?(zt=yt._state,qt=0):qt<2e3&&(qt+=e)>=2e3&&(i=yt._state===M.MissionState.COMPLETED,o=Math.round(Yt/1e3),(wt&&!y.getMissionDescriptor(yt._name)._custom||yt.getId())&&(a={difficulty:Ft,time:o},bt&&(bt.win?a.prevwin=!0:a.prevlose=!0,a.prevdifficulty=bt.difficulty,a.prevtime=bt.time),yt.getId()?I.sendEvent(i?"win":"lose",[yt.getId()],a):u.sendEvent(i?"win":"lose",[t.getFilenameWithoutExtension(wt)],a),bt={win:i,difficulty:Ft,time:o}),s&&s._alive?this.queueHUDMessage({text:_.get(i?_.BATTLE.MESSAGE_VICTORY:_.BATTLE.MESSAGE_FAIL),queue:"mission",permanent:!0},!0):Gt?Mt._camera.followNextNode()||T.switchToSpectatorMode(!0,!0):(this.pauseBattle(!1,!1,!0),p.openDialog({header:_.get(_.BATTLE.MESSAGE_DEFEAT_HEADER),message:_.get(_.BATTLE.MESSAGE_DEFEAT_MESSAGE),buttons:[{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_DEBRIEFING),action:Et},{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_RESTART),action:function(){n.closeSuperimposedScreen(),this.startNewBattle({restart:!0})}.bind(this)},{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_SPECTATE),action:function(){n.closeSuperimposedScreen(),this.resumeBattle()}.bind(this)}],onClose:function(){this.resumeBattle()}.bind(this)})),g.playMusic(i?"victory":"defeat",i?"ambient":null,.2)),Gt&&m.isHost()&&yt&&yt.noHostilesPresent()&&(Jt+=e)>=2e3&&(n.setScreen(p.MULTI_SCORE_SCREEN_NAME),m.concludeMatch())}},St.prototype._startBattle=function(e){var i,o,r,l,h,f,O,L,R,b,x;for(b=this.getScreenCanvas("battleCanvas")._canvas,yt=e,ee=yt.getTargetSpacecrafts(),te=yt.getEscortedSpacecrafts(),wt?(i=y.getMissionDescriptor(yt._name),o=i._custom,Ht||(yt._pilotedCraft&&yt._state!==M.MissionState.NONE||i.increasePlaythroughCount(!0),o?u.sendEvent("customstart"):(bt=null,u.sendEvent("start",[t.getFilenameWithoutExtension(wt)],{difficulty:Ft})))):(o=!0,e.getId()&&(bt=null,I.sendEvent("start",[e.getId()]))),zt=yt._state,qt=2e3,Jt=0,Qt=0,this._updateLoadingStatus(_.get(_.BATTLE.LOADING_BOX_BUILDING_SCENE),10),Gt&&(C.setFriendlyFire(m.getGameSettings().friendlyFire),v.resetRandomSeeds()),x=d.isShadowMappingEnabled(),yt.hasShadows()?d.setShadowMapping():d.setShadowMapping(!1,!1),x!==d.isShadowMappingEnabled()&&d.handleSettingsChanged(),d.shouldUseShadowMapping()&&d.getShadowMappingShader(),Mt=new c.Scene(0,0,1,1,!0,[!0,!0,!0,!0],[0,0,0,1],!0,d.getLODContext(),d.getMaxDirLights(),d.getMaxPointLights(),d.getMaxSpotLights(),{useVerticalValues:!0,viewDistance:5e3,fov:40,span:.2,transitionDuration:1e3,transitionStyle:"smooth"}),Mt.setShouldUpdateCamera(!1),di=new c.Scene(Ts.getPositiveLeft(b.width,b.height),Ts.getPositiveBottom(b.width,b.height),Ts.getPositiveWidth(b.width,b.height),Ts.getPositiveHeight(b.width,b.height),!1,[!0,!0,!0,!0],[0,0,0,0],!0,d.getLODContext(),0,0,0,{useVerticalValues:!0,viewDistance:5,fov:55,span:.2,transitionDuration:1e3,transitionStyle:"smooth"},!1),di._camera.moveToPosition([0,0,1.1],0),yt.addToScene(Mt,di),ct(e),rn=new Array(Object.keys(ln).length),R=0;R<rn.length;R++)rn[R]=hn.VISIBLE;Xe=0,me=0,this._addUITexts(),Se=Se||{},this.clearHUDMessageQueues(),Be=0,He=-1,Ue=!1,We=!1,yt.onTeamsChanged(N),g.initMusic("ambient","ambient",!0),r=S.getSetting(S.BS.ANTICIPATION_MUSIC),l=yt.getAnticipationTheme(),l?h=r.indexOf(r):(h=Math.min(Math.floor(Math.random()*r.length),r.length-1),l=r[h]),jt=h>=0?"anticipation"+h:l,f=S.getSetting(S.BS.COMBAT_MUSIC),O=yt.getCombatTheme(),O?L=f.indexOf(O):(L=Math.min(Math.floor(Math.random()*f.length),f.length-1),O=f[L]),Wt=L>=0?"combat"+L:O,g.initMusic(l,jt,!0),g.initMusic(O,Wt,!0),g.initMusic("victory","victory",!1),g.initMusic("defeat","defeat",!1),g.initMusic("debriefing_victory",p.DEBRIEFING_VICTORY_THEME,!0),g.initMusic("debriefing_defeat",p.DEBRIEFING_DEFEAT_THEME,!0),T.getController(T.GENERAL_CONTROLLER_NAME).setMission(yt),T.getController(T.GENERAL_CONTROLLER_NAME).setBattle(xn),T.getController(T.CAMERA_CONTROLLER_NAME)._controlledCamera=Mt._camera,this._updateLoadingStatus(_.get(_.LOADING.RESOURCES_START),20),a.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),a.executeWhenReady(function(){Mt.setShadowMapping(yt.hasShadows()?d.getShadowMappingSettings():null),this._updateLoadingStatus(_.get(_.LOADING.INIT_WEBGL),80),t.executeAsync(function(){var i,r,l,h,c;if(this.setAntialiasing(d.getAntialiasing()),this.setFiltering(d.getFiltering()),this.clearSceneCanvasBindings(),this.bindSceneToCanvas(Mt,this.getScreenCanvas("battleCanvas")),this.bindSceneToCanvas(di,this.getScreenCanvas("battleCanvas")),di.clearNodes(!0),this._updateLoadingStatus(_.get(_.LOADING.READY),100),s.log("Game data loaded in "+((performance.now()-Vt)/1e3).toFixed(3)+" seconds!",1),Zi.setText(_.get(_.BATTLE.DEVELOPMENT_VERSION_NOTICE),{version:s.getVersion()}),S.gHS(S.BS.HUD.SHOW_VERSION_INFO)||Zi.hide(),document.body.classList.remove("wait"),T.switchToSpectatorMode(!1,!0),this.setHeaderContent(o?yt.getTitle()||wt&&t.getFilenameWithoutExtension(wt)||yt._name:_.get(_.MISSION.PREFIX,t.getFilenameWithoutExtension(wt)+_.MISSION.NAME_SUFFIX.name)),vt=document.body.style.cursor,!Gt&&S.getBattleSetting(S.BS.SHOW_READY_MESSAGE)&&(t.areTouchEventsSupported()?this._touchControlSheet.show():this.showMessage(t.formatString(_.get(_.BATTLE.MESSAGE_READY),{menuKey:ut()}),void 0,!0)),yt.applyToSpacecrafts(function(t){t.addEventHandler(E.FIRED,B.bind(t)),t===yt._pilotedCraft?(t.addEventHandler(E.JUMP_ENGAGED,H.bind(t)),t.addEventHandler(E.JUMP_CANCELLED,G.bind(t)),t.addEventHandler(E.PREPARING_JUMP,j.bind(t)),t.addEventHandler(E.HUD,Q.bind(t)),t.addEventHandler(E.GAIN_KILL,z),t.addEventHandler(E.TARGET_HIT,q)):(t.addEventHandler(E.JUMP_OUT_STARTED,W.bind(t)),t.addEventHandler(E.ARRIVED,Y.bind(t)),t.addEventHandler(E.DESTRUCTED,X.bind(t)),t.addEventHandler(E.RADIO,J.bind(t)))}),Me=Me||a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).volume),ve=0,Ce=Ce||a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).volume),Ne=Ne||a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).volume),Ee=Ee||a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MESSAGE_SOUND).volume),ye=ye||a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).volume,!0),be=be||a.getSoundEffect(S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).volume),Gt&&(De=De||a.getSoundEffect(S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).volume)),l=S.getSetting(S.BS.PILOT_VOICES),h=e.getMessageParams(),!we)for(we=[],i=0;i<l.length;i++)we.push([]);for(i=0;i<l.length;i++)if(0===we[i].length&&v.isVoiceUsed(i))for(r=0;r<Fe.length;r++)we[i].push(at(l[i],Fe[r]));for(Pe=[],i=0;i<l.length;i++)if(Pe.push({}),v.isVoiceUsed(i))for(r=0;r<h.length;r++)(c=e.getSpacecraft(h[r].source))&&v.getVoiceOfSpacecraft(c)===i&&(Pe[i][h[r].textID]=lt(l[i],e,h[r].textID));for(Ve={},i=0;i<h.length;i++)Ve[h[i].textID]=ht(e,h[i].textID);if(Gt?(this._updateLoadingStatus(_.get(_.MULTI_BATTLE.WAITING_FOR_OTHER_PLAYERS)),m.onGameStart(function(){var t,e;if(this._loadingBox.hide(),this.resumeBattle(!0),D(),It=0,m.isHost())for(Ct=[],e=m.getPlayers(),t=0;t<e.length;t++)Ct.push(0);T.switchToPilotMode(yt._pilotedCraft,!0),m.onGameUpdate(m.isHost()?function(t){yt.getSpacecrafts()[t[0]].applyMultiGuestData(t),Ct[t[0]]=0}:function(t){var e,i=yt.getSpacecrafts();for(e=0;e<i.length;e++)i[e].applyMultiHostData(t,e*A.MULTI_HOST_DATA_LENGTH);It=0})}.bind(this)),m.onDisconnect(function(){Gt=!1,n.getScreen()===xt&&(n.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),this.showMessage(_.get(_.MULTI_GAMES.DISCONNECT_MESSAGE),function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME)}))}.bind(this)),m.onHostLeft(function(){Gt=!1,n.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),this.showMessage(t.formatString(_.get(_.MULTI_BATTLE.HOST_LEFT_MESSAGE),{host:m.getHostName()}),function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME)})}.bind(this)),m.onPlayerLeave(function(i){var s;xt.queueHUDMessage({text:t.formatString(_.get(_.MULTI_BATTLE.PLAYER_LEFT_MESSAGE),{player:i.name})}),m.isHost()&&(s=e.getSpacecraft(i.name))&&s._alive&&s.setHullIntegrity(0),m.getActivePlayers().length<=1&&(Gt=!1,this.showMessage(_.get(_.MULTI_BATTLE.ALL_PLAYERS_LEFT_MESSAGE),function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME),m.leaveGame()}))}.bind(this)),m.onMatchConcluded(function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME)}),m.onGuestTimeout(function(){Gt=!1,n.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),xt.showMessage(_.get(_.MULTI_BATTLE.CONNECTION_TIMEOUT),function(){n.setScreen(p.MULTI_SCORE_SCREEN_NAME)})}),m.markLoaded()):this._loadingBox.hide(),V(),this.startRenderLoop(1e3/60),Yt=0,qe=0,Oe=!1,g.playMusic(yt.noHostilesPresent()?"ambient":jt),yt.prepareScene(Mt)){for(Mt.setShouldAnimate(!0),i=0;i<20;i++)this._render(100);Mt.setShouldAnimate(!1)}Gt||S.getBattleSetting(S.BS.SHOW_READY_MESSAGE)||this._doStartBattle()}.bind(this))}.bind(this)),a.requestResourceLoad()},St.prototype.startNewBattle=function(t){var e,i;Vt=performance.now(),e=this.getScreenCanvas("battleCanvas")._canvas,t=t||{},t.restart&&this.pauseBattle(),void 0!==t.missionData?(wt=null,Pt=t.missionData):void 0!==t.missionSourceFilename&&(wt=t.missionSourceFilename),void 0!==t.difficulty&&(Ft=t.difficulty),void 0!==t.spacecraftClass&&(Ut=t.spacecraftClass),void 0!==t.loadout&&(Bt=t.loadout),void 0!==t.demoMode&&(Ht=t.demoMode),Gt=t.multi,A.setMultiGuest(Gt&&!m.isHost()),L(),R(),document.body.classList.add("wait"),this._loadingBox.show(),this.resizeCanvases(),T.setScreenCenter(e.width/2,e.height/2),this._updateLoadingStatus(_.get(_.BATTLE.LOADING_BOX_LOADING_MISSION),0),i={difficulty:Ft,pilotedSpacecraftClass:Ut,pilotedSpacecraftLoadout:Bt,demoMode:Ht},wt?y.requestMission(wt,i,this._startBattle.bind(this)):this._startBattle(y.createMission(Pt,i))},St.prototype.requestPointerLock=function(t){var e;T.isPointerLockEnabled()&&document.pointerLockElement!==this.getScreenCanvas("battleCanvas")._canvas&&(-1!==bn&&(clearInterval(bn),bn=-1),(e=this.getScreenCanvas("battleCanvas")._canvas.requestPointerLock())instanceof Promise&&e.catch(function(){t&&(bn=setTimeout(function(){bn=-1,n.getScreen()===this&&T.getInputInterpreter(T.MOUSE_NAME).isEnabled()&&this.requestPointerLock(!1)}.bind(this),1e3))}.bind(this)))},T.isPointerLockSupported()&&document.addEventListener("pointerlockchange",function(){-1!==bn&&(clearInterval(bn),bn=-1)}),S.executeWhenReady(function(){fs=S.gHS(S.BS.HUD.CENTER_CROSSHAIR).scaleMode,As=S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).size,Ss=S.gHS(S.BS.HUD.DISTANCE_TEXT).layout,Ts=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_VIEW_LAYOUT)),Es=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).layout),ys=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),Ms=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).layout),Is=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).layout),Cs=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.SPEED_BAR).layout),vs=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MISSILE_INDICATOR).layout),Ns=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).layout),Os=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.SHIELD_BAR).layout),Ls=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),Rs=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).layout),Ds=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).layout),ws=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).layout),Ps=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).layout),Vs=100,Fs=100,Us=300,Bs=300,Hs=300,Gs=1e3,ks=1e3,js=500,Ws=S.gHS(S.BS.HUD.SHIP_INDICATOR).sizes,Ys=2,Xs=1.5,Ks=S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).size,Zs=1.75,zs=S.gHS(S.BS.HUD.SHIP_ARROW).sizes,qs=1.8,Js=S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).size,Qs=1.75,$s=.5,tn=1,bs=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).layout),xs=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).layout),en=S.gHS(S.BS.HUD.ESCORTS_INTEGRITY_BARS),sn=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_INDICATOR),nn=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,on=S.gHS(S.BS.HUD.MESSAGE_TEXT),Ae=5,fi={shaderName:"oneColorFaded",positionMatrix:i.IDENTITY4,orientationMatrix:wn,skipResources:!0},Qe=750,Je=1e4,Ke=1e4}),d.executeWhenReady(function(){}),d.onSettingsChange(U),xn.getBattleScreen=function(){return xt||(xt=new St,xn.pauseBattle=xt.pauseBattle.bind(xt),xn.resumeBattle=xt.resumeBattle.bind(xt)),xt},xn.getMissionName=b,xn.stopTime=x,xn.resumeTime=D,xn.toggleTime=w,xn.showHUD=V,xn.hideHUD=P,xn.toggleHUDVisibility=F,xn.HUDSection=ln,xn.HUDSectionState=hn,xn}),define("armada/screens/menus",["utils/utils","modules/application","modules/screens","modules/game","modules/analytics","armada/constants","armada/screens/shared","armada/strings","armada/audio","armada/networking","armada/announcements","armada/screens/battle"],function(t,e,i,s,n,o,r,a,l,h,c,u){"use strict";function _(){p&&p.length>0&&s.getScreen()!==s.getScreen(r.BATTLE_SCREEN_NAME)&&s.getScreen()!==s.getScreen(r.DIALOG_SCREEN_NAME)&&(r.openDialog({header:a.get(a.ANNOUNCEMENTS.HEADER),message:p.map(function(t){return'<div class="'+r.ANNOUNCEMENT_CLASS_NAME+'">'+t.text+"</div>"}).join(""),messageClass:r.ANNOUNCEMENTS_CLASS_NAME,buttons:[{caption:a.get(a.ANNOUNCEMENTS.BUTTON),action:function(){c.markAnnouncementsAsRead(),s.closeSuperimposedScreen()}}]}),p=null)}var p,d=o.LOCAL_STORAGE_PREFIX+"firstRunNoteShown",g=o.LOCAL_STORAGE_PREFIX+"firstMultiRunNoteShown",m=!1,f=!1,S=[{id:a.MAIN_MENU.SINGLE_PLAYER.name,action:function(){n.sendEvent("newgame"),l.resume(),s.setScreen(r.SINGLE_PLAYER_SCREEN_NAME)}},{id:a.MAIN_MENU.MULTIPLAYER.name,action:function(){var t=function(){n.sendEvent("multi"),l.resume(),s.setScreen(r.MULTI_GAMES_SCREEN_NAME)};"true"===localStorage[g]||f?t():r.openDialog({header:a.get(a.FIRST_MULTI_RUN_NOTE.HEADER),message:a.get(a.FIRST_MULTI_RUN_NOTE.MESSAGE),buttons:[{caption:a.get(a.FIRST_MULTI_RUN_NOTE.CANCEL_BUTTON),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.FIRST_MULTI_RUN_NOTE.OK_BUTTON),action:function(){f=!0,s.closeSuperimposedScreen(),t()}},{caption:a.get(a.FIRST_MULTI_RUN_NOTE.DO_NOT_SHOW_AGAIN_BUTTON),action:function(){localStorage[g]="true",s.closeSuperimposedScreen(),t()}}]})}},{id:a.MAIN_MENU.DATABASE.name,action:function(){n.sendEvent("database"),l.resume(),s.setScreen(r.DATABASE_SCREEN_NAME)}},{id:a.MAIN_MENU.SETTINGS.name,action:function(){n.sendEvent("settings"),l.resume(),s.setScreen(r.SETTINGS_SCREEN_NAME)}},{id:a.MAIN_MENU.ABOUT.name,action:function(){n.sendEvent("about"),l.resume(),s.setScreen(r.ABOUT_SCREEN_NAME)}}];return{getMainMenuScreen:function(){return e.usesElectron()&&S.push({id:a.MAIN_MENU.QUIT.name,action:function(){window.close()}}),new i.MenuScreen(r.MAIN_MENU_SCREEN_NAME,r.MAIN_MENU_SCREEN_SOURCE,{backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,S,r.MAIN_MENU_CONTAINER_ID,{show:function(){var i,o,h;if(l.resetMasterVolume(),l.resetMusicVolume(),null!==p&&c.retrieveAnnouncements(function(){p=c.getAnnouncements(),_()},function(t){}),"true"!==localStorage[d])localStorage[d]="true",r.openDialog({header:a.get(a.FIRST_RUN_NOTE.HEADER),message:t.formatString(a.get(a.FIRST_RUN_NOTE.MESSAGE),{facebook:'<a target="_blank" rel="noopener" href="https://www.facebook.com/interstellar.armada">facebook</a>',patreon:'<a target="_blank" rel="noopener" href="https://www.patreon.com/c/Entian">Patreon</a>'})+(e.usesElectron()?"":t.formatString(a.get(a.FIRST_RUN_NOTE.MESSAGE_WEB),{chrome:'<a target="_blank" rel="noopener" href="https://www.google.com/chrome/">Google Chrome</a>'})),buttons:[{caption:a.get(a.FIRST_RUN_NOTE.BUTTON),action:function(){l.resume(),s.closeSuperimposedScreen(),l.playMusic(r.MENU_THEME),n.login(),_()}}]});else if(e.isFirstRun()||!e.hasVersionChanged()||m)l.playMusic(r.MENU_THEME),n.login(),_();else{if(m=!0,i=t.formatString(a.get(a.RELEASE_NOTES.GENERAL),{version:e.getVersion(),patreon:'<a target="_blank" rel="noopener" href="https://www.patreon.com/c/Entian">Patreon</a>'})+"<br/><br/>",o=e.getNewReleases(),o.length>0)for(h=0;h<o.length;h++)i+="<h2>"+o[h]+"</h2>"+t.formatString(a.get(a.RELEASE_NOTES.PREFIX,o[h]));else i+=t.formatString(a.get(a.RELEASE_NOTES.NO_NEWS),{github:'<a target="_blank" rel="noopener" href="https://github.com/nkrisztian89/interstellar-armada/releases">Github</a>'});r.openDialog({header:a.get(a.RELEASE_NOTES.HEADER),message:i,messageClass:r.RELEASE_NOTES_CLASS_NAME,buttons:[{caption:a.get(a.RELEASE_NOTES.BUTTON),action:function(){l.resume(),s.closeSuperimposedScreen(),l.playMusic(r.MENU_THEME),n.login(),_()}}]})}r.setupFullscreenButton.call(this)},optionselect:r.playButtonSelectSound,optionclick:r.playButtonClickSound})},getSinglePlayerMenuScreen:function(){return new i.MenuScreen(r.SINGLE_PLAYER_SCREEN_NAME,r.SINGLE_PLAYER_SCREEN_SOURCE,{backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,[{id:a.SINGLE_PLAYER_MENU.CAMPAIGN.name,action:function(){s.getScreen(r.MISSIONS_SCREEN_NAME).setup({custom:!1,loadCustom:!1,community:!1}),s.setScreen(r.MISSIONS_SCREEN_NAME)}},{id:a.SINGLE_PLAYER_MENU.MY_MISSIONS.name,action:function(){s.getScreen(r.MISSIONS_SCREEN_NAME).setup({custom:!0,loadCustom:!0,community:!1}),s.setScreen(r.MISSIONS_SCREEN_NAME)}},{id:a.SINGLE_PLAYER_MENU.COMMUNITY_MISSIONS.name,action:function(){s.getScreen(r.MISSIONS_SCREEN_NAME).setup({custom:!0,loadCustom:!1,community:!0}),s.setScreen(r.MISSIONS_SCREEN_NAME)}},{id:a.SCREEN.BACK.name,action:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}],r.SINGLE_PLAYER_MENU_CONTAINER_ID,r.MENU_EVENT_HANDLERS,{escape:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}})},getSettingsMenuScreen:function(){return new i.MenuScreen(r.SETTINGS_SCREEN_NAME,r.SETTINGS_SCREEN_SOURCE,{backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,[{id:a.SETTINGS.GENERAL.name,action:function(){s.setScreen(r.GENERAL_SETTINGS_SCREEN_NAME)}},{id:a.SETTINGS.GRAPHICS.name,action:function(){s.setScreen(r.GRAPHICS_SCREEN_NAME)}},{id:a.SETTINGS.AUDIO.name,action:function(){s.setScreen(r.AUDIO_SCREEN_NAME)}},{id:a.SETTINGS.GAMEPLAY.name,action:function(){s.setScreen(r.GAMEPLAY_SETTINGS_SCREEN_NAME)}},{id:a.SETTINGS.CONTROLS.name,action:function(){s.setScreen(r.CONTROLS_SCREEN_NAME)}},{id:a.SCREEN.BACK.name,action:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}],r.SETTINGS_MENU_CONTAINER_ID,r.MENU_EVENT_HANDLERS,{escape:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}})},getIngameMenuScreen:function(){return new i.MenuScreen(r.INGAME_MENU_SCREEN_NAME,r.INGAME_MENU_SCREEN_SOURCE,{cssFilename:r.INGAME_MENU_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,[{id:a.INGAME_MENU.RESUME.name,action:function(){s.closeSuperimposedScreen(),u.resumeBattle()}},{id:a.SETTINGS.CONTROLS.name,action:function(){s.setScreen(r.CONTROLS_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.SETTINGS.AUDIO.name,action:function(){s.setScreen(r.AUDIO_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.SETTINGS.GAMEPLAY.name,action:function(){s.setScreen(r.GAMEPLAY_SETTINGS_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.INGAME_MENU.RESTART.name,isVisible:function(){return!h.isInGame()},action:function(){r.openDialog({header:a.get(a.INGAME_MENU.RESTART_HEADER),message:a.get(a.INGAME_MENU.RESTART_MESSAGE),buttons:[{caption:a.get(a.SCREEN.CANCEL),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.INGAME_MENU.RESTART_RESTART),action:function(){s.closeSuperimposedScreen(),s.closeSuperimposedScreen(),s.getScreen().startNewBattle({restart:!0})}}]})}},{id:a.INGAME_MENU.QUIT.name,isVisible:function(){return!h.isInGame()},action:function(){r.openDialog({header:a.get(a.INGAME_MENU.QUIT_HEADER),message:a.get(a.INGAME_MENU.QUIT_MESSAGE),buttons:[{caption:a.get(a.SCREEN.CANCEL),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.INGAME_MENU.QUIT_TO_MISSIONS),action:function(){var t=u.getMissionName();s.setScreen(r.MISSIONS_SCREEN_NAME),s.getScreen().selectMission(t)}},{caption:a.get(a.INGAME_MENU.QUIT_TO_MAIN_MENU),action:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}]})}},{id:a.INGAME_MENU.QUIT_MULTI.name,isVisible:function(){return h.isInGame()},action:function(){r.openDialog({header:a.get(a.INGAME_MENU.QUIT_MULTI_HEADER),message:a.get(a.INGAME_MENU.QUIT_MULTI_MESSAGE),buttons:[{caption:a.get(a.SCREEN.CANCEL),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.INGAME_MENU.QUIT_TO_SCORE),action:function(){s.setScreen(r.MULTI_SCORE_SCREEN_NAME),h.leaveGame()}},{caption:a.get(a.INGAME_MENU.QUIT_TO_MAIN_MENU),action:function(){h.onDisconnect(null),h.disconnect(),s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}]})}}],r.INGAME_MENU_CONTAINER_ID,r.MENU_EVENT_HANDLERS,{escape:function(t){t.repeat||(s.closeSuperimposedScreen(),u.resumeBattle(!1,!0))}})}}}),define("armada/screens/missions",["utils/utils","modules/game","modules/screens","modules/components","modules/analytics","armada/strings","armada/audio","armada/configuration","armada/screens/shared","armada/logic/spacecraft","armada/logic/missions","armada/logic/mission-hub"],function(t,e,i,s,n,o,r,a,l,h,c,u){"use strict";function _(t,e,i){return"string"==typeof t&&(void 0===e||t.length>=e)&&(void 0===i||t.length<=i)}function p(t){return o.get(o.SETTING.PREFIX,t)}function d(){return c.getDifficultyNames().map(p)}function g(){i.HTMLScreen.call(this,l.MISSIONS_SCREEN_NAME,l.MISSIONS_SCREEN_SOURCE,{cssFilename:l.MISSIONS_SCREEN_CSS,backgroundClassName:l.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:l.SCREEN_CONTAINER_CLASS_NAME},{show:function(){r.resetMasterVolume(),r.resetMusicVolume(),r.playMusic(l.BRIEFING_THEME,void 0,void 0,!1)}},this._getKeyCommands(),l.BUTTON_EVENT_HANDLERS),this._custom=!1,this._loadCustom=!1,this._community=!1,this._missionToSubmit=null,this._missionProvider=c,this._submitHelpShown=!1,this._listContainerID=l.MISSIONS_LIST_CONTAINER_ID,this._title=this.registerSimpleComponent(I),this._backButton=this.registerSimpleComponent(C),this._missionTitle=this.registerSimpleComponent(L),this._missionLocation=this.registerSimpleComponent(R),this._difficultySelector=null,this._missionDescription=this.registerSimpleComponent(D),this._missionObjectivesTitle=this.registerSimpleComponent("missionObjectivesTitle"),this._missionObjectives=this.registerSimpleComponent("missionObjectives"),this._playerSpacecraftTitle=this.registerSimpleComponent("playerSpacecraftTitle"),this._playerSpacecraftData=this.registerSimpleComponent("playerSpacecraftData"),this._playerSpacecraftWeapons=this.registerSimpleComponent("playerSpacecraftWeapons"),this._playerSpacecraftMissiles=this.registerSimpleComponent("playerSpacecraftMissiles"),this._playerSpacecraftShield=this.registerSimpleComponent("playerSpacecraftShield"),this._playerSpacecraftPropulsion=this.registerSimpleComponent("playerSpacecraftPropulsion"),this._fileInput=this.registerSimpleComponent(F),this._fileButton=this.registerSimpleComponent(w),this._submitButton=this.registerSimpleComponent(P),this._changeShipButton=this.registerSimpleComponent(A),this._changeLoadoutButton=this.registerSimpleComponent(v),this._demoButton=this.registerSimpleComponent(N),this._launchButton=this.registerSimpleComponent(O),this._submitMissionHelpButton=this.registerSimpleComponent(U),this._submitMissionPopupBackground=this.registerSimpleComponent(B),this._submitMissionSenderNameInput=this.registerSimpleComponent(H),this._submitMissionPasswordInput=this.registerSimpleComponent(G),this._submitMissionPasswordEye=this.registerSimpleComponent(k),this._submitMissionCommentInput=this.registerSimpleComponent(j),this._submitFileButton=this.registerSimpleComponent(V),this._submitMissionCancelButton=this.registerSimpleComponent(z),this._submitMissionSubmitButton=this.registerSimpleComponent(X),this._manageSubmissionsButton=this.registerSimpleComponent(q),this._manageSubmissionsPopupBackground=this.registerSimpleComponent(J),this._manageSubmissionsCloseButton=this.registerSimpleComponent(Q),this._submissionsList=this.registerSimpleComponent(K),this._listComponent=this.registerExternalComponent(new s.ListComponent(rt,l.LIST_COMPONENT_SOURCE,{cssFilename:l.LIST_COMPONENT_CSS,listClassName:l.LIST_CLASS_NAME,listContainerClassName:M,elementClassName:l.LIST_ELEMENT_CLASS_NAME,elementContainerClassName:l.LIST_ELEMENT_CONTAINER_CLASS_NAME,captionClassName:l.CAPTION_CLASS_NAME,subcaptionClassName:l.SUBCAPTION_CLASS_NAME,disabledElementClassName:s.DISABLED_CLASS_NAME,selectedElementClassName:s.SELECTED_CLASS_NAME,highlightedElementClassName:s.HIGHLIGHTED_CLASS_NAME},this._getListElements(),!0,{elementhighlight:function(){l.playButtonSelectSound(!0)},elementselect:function(t,e){l.playButtonClickSound(e),this._selectMission(t)}.bind(this)}),this._listContainerID),this._infoBox=this.registerExternalComponent(new s.InfoBox(Z,l.INFO_BOX_SOURCE,{cssFilename:l.INFO_BOX_CSS},o.INFO_BOX.HEADER.name,o.INFO_BOX.OK_BUTTON.name,{buttonselect:l.playButtonSelectSound,buttonclick:l.playButtonClickSound})),this._loadingBox=this.registerExternalComponent(new s.LoadingBox($,l.LOADING_BOX_SOURCE,{cssFilename:l.LOADING_BOX_CSS},o.LOADING.HEADER.name)),this._submitMissionTermsCheckbox=this.registerExternalComponent(new s.CheckGroup(W,l.CHECK_GROUP_SOURCE,{cssFilename:l.CHECK_GROUP_CSS},[{id:o.MISSIONS.SUBMIT_MISSION_ACCEPT_TERMS.name,replacements:{linkBegin:'<a id="'+tt+'" target="_blank" rel="noreferrer">',linkEnd:"</a>"},value:"accept"}],{select:l.playButtonSelectSound,change:function(){l.playButtonClickSound(!0),this._updateSubmitMissionButton()}.bind(this),click:function(t){return"a"!==t.target.tagName.toLowerCase()}}),Y),
c.executeWhenReady(function(){this._difficultySelector=this.registerExternalComponent(new s.Selector(x,l.SELECTOR_SOURCE,{cssFilename:l.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:o.MISSIONS.DIFFICULTY.name},d()),b)}.bind(this)),this._updateSubmitMissionButton=this._updateSubmitMissionButton.bind(this)}var m,f,S,T,E,y,M="missionListContainer",I="title",C="backButton",A="changeShipButton",v="changeLoadoutButton",N="demoButton",O="launchButton",L="missionTitle",R="missionLocation",b="difficultyContainer",x="difficultySelector",D="missionDescription",w="fileButton",P="submitButton",V="submitFileButton",F="fileInput",U="helpButton",B="submitMissionPopupBackground",H="submitMissionSenderName",G="submitMissionPassword",k="submitMissionPasswordEye",j="submitMissionComment",W="submitMissionTermsCheckGroup",Y="submitMissionTermsContainer",X="submitMissionSubmitButton",z="submitMissionCancelButton",q="manageSubmissionsButton",J="manageSubmissionsPopupBackground",Q="manageSubmissionsCloseButton",K="submissionsList",Z="infoBox",$="loadingBox",tt="missionHubTermsLink",et={day:"numeric",month:"long",year:"numeric"},it={AUTHORIZATION:100,INVALID_GENERAL_PARAMS:200,INVALID_SUBMIT_PARAMS:300,DATABASE_OPERATION:400,AUTHENTICATION:500,RATE_LIMIT:600,OTHER:700},st={MISSING_BODY:1,INVALID_NAME:2,INVALID_PASSWORD:3,INVALID_COMMENT:4,WRONG_MISSION_FILE_FORMAT:5,MISSION_FILE_TOO_LARGE:6,SENDER_CREATOR_MISMATCH:7,INVALID_MISSION_TITLE:8,INVALID_MISSION_DESCRIPTON:9,NO_SPACECRAFTS:10,NO_PILOTED_CRAFT:11},nt={TITLE_ALREADY_EXISTS:1},ot={minNameLength:3,maxNameLength:20,minPasswordLength:8,maxPasswordLength:32,maxCommentLength:200,maxFileSize:t.getFileSizeString(102400),minTitleLength:3,maxTitleLength:30,minDescriptionLength:10},rt="list";return g.prototype=new i.HTMLScreen,g.prototype.constructor=g,g.prototype.setup=function(t){this._custom=t.custom,this._loadCustom=t.loadCustom,this._community=t.community,this._missionProvider=t.community?u:c,this._listComponent.setListElements(this._getListElements())},g.prototype._getListElements=function(){var e,i,s=[],n=this._missionProvider.getMissionNames(this._custom);if(this._custom&&!this._community)for(i=[],e=0;e<n.length;e++)i.push(this._missionProvider.getMissionDescriptor(n[e]).getTitle());for(e=0;e<n.length;e++)s.push({captionID:this._community||this._custom?void 0:o.MISSION.PREFIX.name+t.getFilenameWithoutExtension(n[e])+o.MISSION.NAME_SUFFIX.name,caption:this._community?n[e]:this._custom?i[e]||t.getFilenameWithoutExtension(n[e]):void 0,subcaptionID:o.MISSIONS.NOT_COMPLETED.name});return this._loadCustom&&s.push({captionID:o.MISSIONS.CUSTOM_MISSION_CAPTION.name,subcaptionID:o.MISSIONS.CUSTOM_MISSION_SUBCAPTION.name}),s},g.prototype._handleMissionHubError=function(i,s){e.getScreen()===this&&this._community&&(this._loadingBox.hide(),this._showMessage(o.get(o.MISSION_HUB_ERROR.PREFIX,s&&s.error||o.MISSION_HUB_ERROR.DEFAULT_SUFFIX.name,t.formatString(o.get(o.MISSION_HUB_ERROR.GENERAL),{code:s?s.error:0})),function(){i&&e.closeOrNavigateTo(l.SINGLE_PLAYER_SCREEN_NAME)}.bind(this)))},g.prototype._updateSpacecraft=function(){m&&(m.destroy(),m=null),S&&(m=new h.Spacecraft,m.loadFromJSON(Object.assign({},S,{class:E,loadout:y||S.loadout,equipment:y?void 0:S.equipment}))),m?(this._playerSpacecraftData.setContent(o.get(o.MISSIONS.SPACECRAFT_DATA),{class:m.getClass().getDisplayName()}),m.hasWeapons()?(this._playerSpacecraftWeapons.setContent(o.get(o.MISSIONS.SPACECRAFT_WEAPONS),{weapons:m.getWeaponsDisplayText()||"-",firepower:m.getFirepower().toFixed(1),range:m.hasWeapons()?m.getWeaponRangesDisplayText()+" m":"-"}),this._playerSpacecraftWeapons.show()):(this._playerSpacecraftWeapons.setContent(""),this._playerSpacecraftWeapons.hide()),m.hasMissiles()?(this._playerSpacecraftMissiles.setContent(o.get(o.MISSIONS.SPACECRAFT_MISSILES),{missiles:m.getMissilesDisplayText()||"-",firepower:m.getMissileFirepower(),range:m.getMissileRangesDisplayText()+" m"}),this._playerSpacecraftMissiles.show()):(this._playerSpacecraftMissiles.setContent(""),this._playerSpacecraftMissiles.hide()),m.hasShield()?(this._playerSpacecraftShield.setContent(o.get(o.MISSIONS.SPACECRAFT_SHIELD),{shield:m.hasShield()?m.getShieldDisplayName():"-",shieldCapacity:m.hasShield()?m.getShieldCapacity():"-",shieldRechargeRate:m.hasShield()?m.getShieldRechargeRate()+" / s":"-"}),this._playerSpacecraftShield.show()):(this._playerSpacecraftShield.setContent(""),this._playerSpacecraftShield.hide()),m._propulsion?(this._playerSpacecraftPropulsion.setContent(o.get(o.MISSIONS.SPACECRAFT_PROPULSION),{propulsion:m._propulsion?m.getPropulsionDisplayName():"-",speed:m._propulsion?Math.round(m.getMaxCombatSpeed())+" m/s":"-",turnRate:m._propulsion?Math.round(m.getMaxCombatTurnRate())+" /s":"-"}),this._playerSpacecraftPropulsion.show()):(this._playerSpacecraftPropulsion.setContent(""),this._playerSpacecraftPropulsion.hide())):this._playerSpacecraftData.setContent("-")},g.prototype._selectMission=function(i){var n,r;i>=0&&i<this._missionProvider.getMissionNames(this._custom).length?(n=this._missionProvider.getMissionNames(this._custom)[i],r=t.getFilenameWithoutExtension(n),this._missionTitle.setTextContent(o.get({name:o.MISSION.PREFIX.name+r+o.MISSION.NAME_SUFFIX.name},void 0,r)),this._missionDescription.setTextContent(o.get(o.MISSIONS.LOADING_DESCRIPTION)),this._missionObjectivesTitle.hide(),this._missionObjectives.hide(),this._playerSpacecraftTitle.hide(),this._playerSpacecraftData.hide(),this._playerSpacecraftWeapons.hide(),this._playerSpacecraftMissiles.hide(),this._playerSpacecraftShield.hide(),this._playerSpacecraftPropulsion.hide(),this._fileButton.hide(),this._submitButton.hide(),this._manageSubmissionsButton.hide(),this._changeShipButton.hide(),this._changeLoadoutButton.hide(),this._missionProvider.requestMissionDescriptor(n,function(e){var n,r;this._listComponent.getSelectedIndex()===i&&(f=e,e.getTitle()&&(this._missionTitle.setTextContent(e.getTitle()),this._listComponent.setCaption(i,e.getTitle())),S=e.getPilotedSpacecraftDescriptor(),T=e.getAvailableSpacecraftClasses(),T.length>1&&(this._changeShipButton.show(),this._changeLoadoutButton.show(),this._changeLoadoutButton.disable()),S&&(E=S.class,y="",e.getAvailableLoadouts(E).length>1&&this._changeLoadoutButton.enable()),this._updateSpacecraft(),r=e.getMissionObjectives().map(function(t){return"<li>"+t+"</li>"}),this._missionLocation.setTextContent(o.get(o.MISSIONS.LOCATION)+" "+e.getEnvironment().getDisplayName()),this._missionDescription.setContent(""),e._custom?(e.getAuthor()&&(n=document.createElement("span"),n.textContent=t.formatString(o.get(o.MISSIONS.CREATED_BY),{author:e.getAuthor()}),this._missionDescription._element.appendChild(n),this._missionDescription._element.appendChild(document.createElement("br")),this._missionDescription._element.appendChild(document.createElement("br"))),s.appendFormattedContent(this._missionDescription._element,e.getDescription()||e.getDisplayDescription())):s.appendFormattedContent(this._missionDescription._element,e.getDisplayDescription()),this._missionObjectives.setContent(r.join("")),this._missionObjectivesTitle.show(),this._missionObjectives.show(),this._playerSpacecraftTitle.show(),this._playerSpacecraftData.show())}.bind(this)),this._launchButton.enable(),this._demoButton.enable()):(this._missionTitle.setContent(o.get(o.MISSIONS.NO_SELECTED_NAME)),this._missionLocation.setContent(""),this._missionDescription.setContent(o.get(this._loadCustom?o.MISSIONS.CUSTOM_DESCRIPTION:this._community?u.isReady()?o.MISSIONS.MISSION_HUB_DESCRIPTION:o.MISSIONS.MISSION_HUB_CONNECTING_DESCRIPTION:o.MISSIONS.NO_SELECTED_DESCRIPTION),{editor:'<a target="_blank" rel="noopener" href="editor.html#missions">Interstellar Armada editor</a>'}),this._missionObjectivesTitle.hide(),this._missionObjectives.hide(),this._playerSpacecraftTitle.hide(),this._playerSpacecraftData.hide(),this._playerSpacecraftWeapons.hide(),this._playerSpacecraftMissiles.hide(),this._playerSpacecraftShield.hide(),this._playerSpacecraftPropulsion.hide(),this._launchButton.disable(),this._demoButton.disable(),this._changeShipButton.hide(),this._changeLoadoutButton.hide(),this._fileButton.setVisible(this._loadCustom),this._submitButton.setVisible(this._community&&u.isReady()),this._manageSubmissionsButton.setVisible(this._community&&u.isReady()&&u.isSubmitter()),this._community&&!u.isReady()&&u.retrieveMissions(function(){e.getScreen()===this&&this._community&&(this._listComponent.setListElements(this._getListElements()),this._updateScores(),this._selectMission(-1))}.bind(this),this._handleMissionHubError.bind(this,!0)))},g.prototype._getKeyCommands=function(t){return t=t||{},t.up=t.up||function(t){this._submitMissionPopupBackground.isVisible()||this._manageSubmissionsPopupBackground.isVisible()||(this._listComponent.highlightPrevious(),t.preventDefault())}.bind(this),t.down=t.down||function(t){this._submitMissionPopupBackground.isVisible()||this._manageSubmissionsPopupBackground.isVisible()||(this._listComponent.highlightNext(),t.preventDefault())}.bind(this),t.enter=t.enter||function(){this._submitMissionPopupBackground.isVisible()||this._manageSubmissionsPopupBackground.isVisible()||(this._listComponent.getSelectedIndex()>=0&&this._listComponent.getHighlightedIndex()===this._listComponent.getSelectedIndex()?this._launchMission(!1):this._listComponent.selectHighlighted())}.bind(this),t.space=t.space||function(t){this._submitMissionPopupBackground.isVisible()||this._manageSubmissionsPopupBackground.isVisible()||(this._listComponent.selectHighlighted(),t.preventDefault())}.bind(this),t.escape=function(){this._submitMissionPopupBackground.isVisible()&&!this._manageSubmissionsPopupBackground.isVisible()?this._submitMissionPopupBackground.hide():e.closeOrNavigateTo(l.MAIN_MENU_SCREEN_NAME)}.bind(this),t},g.prototype._showMessage=function(t,e){this._infoBox.updateMessage(t),this._infoBox.onButtonClick(function(){l.playButtonClickSound(),e&&e()}),this._infoBox.show()},g.prototype._updateScores=function(){var e,i;e=this._missionProvider.getMissionDescriptors(this._custom),i=0,this._listComponent.executeForListElements(function(s){var n,r,a,h;i<e.length&&(h=s.querySelector("."+l.SUBCAPTION_CLASS_NAME),e[i]._custom?(h.innerHTML=t.formatString(o.get(this._community?o.MISSIONS.COMMUNITY_MISSION_SUBCAPTION:o.MISSIONS.CUSTOM_MISSION_SUBCAPTION),{author:e[i].getAuthor()}),a=0):(n=e[i].getBestScore(),r=e[i].getBestPerformance(),a=e[i].getWinCount(),h.innerHTML=t.formatString(a>0?void 0===n?o.get(o.MISSIONS.SANDBOX_COMPLETED):o.get(o.MISSIONS.BEST_SCORE):o.get(o.MISSIONS.NOT_COMPLETED),{score:n||0,medal:r?t.formatString("<img class='missionMedal' src='assets/images/empire_{performance}_20.png' alt='{performance}'>",{performance:r}):" - "})),a>0?h.classList.add("completed"):h.classList.remove("completed")),i++}.bind(this))},g.prototype.setActive=function(t){i.HTMLScreen.prototype.setActive.call(this,t),t&&(this._title.setContent(o.get(this._community?o.MISSIONS.COMMUNITY_MISSIONS_TITLE:this._loadCustom?o.MISSIONS.MY_MISSIONS_TITLE:o.MISSIONS.CAMPAIGN_TITLE)),this._updateScores(),this._listComponent.reset(),this._selectMission(-1))},g.prototype._launchMission=function(t){var i=this._listComponent.getSelectedIndex(),s=this._missionProvider.getMissionNames(this._custom)[i];i>=0&&(r.playMusic(null),e.setScreen(l.BATTLE_SCREEN_NAME),e.getScreen().startNewBattle({missionSourceFilename:this._community?void 0:s,missionData:this._community?u.getMissionDescriptor(s).getData():void 0,difficulty:c.getDifficultyNames()[this._difficultySelector.getSelectedIndex()],spacecraftClass:E,loadout:y,demoMode:t}))},g.prototype._updateValues=function(){c.executeWhenReady(function(){this._difficultySelector.selectValueWithIndex(c.getDifficultyNames().indexOf(c.getDifficulty()))}.bind(this))},g.prototype._updateSubmitMissionButton=function(){this._submitMissionSenderNameInput._element.value.length>=3&&this._submitMissionPasswordInput._element.value.length>=8&&this._submitMissionTermsCheckbox.getValue().length>0&&this._missionToSubmit?this._submitMissionSubmitButton.enable():this._submitMissionSubmitButton.disable()},g.prototype._showMissionHubClientError=function(e){this._showMessage(t.formatString(o.get(o.MISSION_HUB_CLIENT_ERROR.PREFIX,e,t.formatString(o.get(o.MISSION_HUB_CLIENT_ERROR.GENERAL),{code:e})),ot))},g.prototype._resetSubmitFile=function(){this._fileInput._element.value=null,this._missionToSubmit=null,this._submitFileButton.setTextContent(o.get(o.MISSIONS.SUBMIT_FILE_BUTTON)),this._updateSubmitMissionButton()},g.prototype._validateMissionData=function(t){var e,i,s;if(!t||"object"!=typeof t||!t.info||"object"!=typeof t.info||!_(t.info.author))return st.WRONG_MISSION_FILE_FORMAT;if(t.info.author!==this._submitMissionSenderNameInput._element.value)return st.SENDER_CREATOR_MISMATCH;if(!_(t.title,3,30))return st.INVALID_MISSION_TITLE;if(!_(t.description,10))return st.INVALID_MISSION_DESCRIPTON;if(!Array.isArray(t.spacecrafts))return st.WRONG_MISSION_FILE_FORMAT;if(0===t.spacecrafts.length)return st.NO_SPACECRAFTS;for(e=!1,s=0;s<t.spacecrafts.length;s++){if(!(i=t.spacecrafts[s])||"object"!=typeof i)return st.WRONG_MISSION_FILE_FORMAT;!0===i.piloted?e=!0:"number"!=typeof i.pilotedIndex||isNaN(i.pilotedIndex)||"number"==typeof i.count&&!isNaN(i.count)&&i.pilotedIndex<i.count&&(e=!0)}return e?0:st.NO_PILOTED_CRAFT},g.prototype._showSubmissions=function(){this._loadingBox.show(),u.getSubmissions(function(e){var i,s,n,r,a,h,c=this._submissionsList._element,_=function(){l.playButtonSelectSound(!0)},p=function(t){l.playButtonClickSound(!0),this._loadingBox.show(),u.deleteSubmission(e[t].id,function(){this._loadingBox.hide(),this._showMessage(o.get(o.MISSIONS.DELETE_SUBMISSION_SUCCESS),this._showSubmissions.bind(this))}.bind(this),this._handleMissionHubError.bind(this,!1))};for(c.innerHTML="",i=0;i<e.length;i++)s=document.createElement("tr"),n=document.createElement("td"),n.className="submissionTitleColumn",n.textContent=e[i].title,s.appendChild(n),n=document.createElement("td"),n.className="submissionDateColumn",a=new Date(e[i].time),n.textContent=a.toLocaleDateString(o.getLocale(),et),s.appendChild(n),n=document.createElement("td"),n.className="submissionStatusColumn",h=document.createElement("strong"),h.textContent=e[i].reviewed?o.get(e[i].approved?o.MISSIONS.SUBMISSION_STATUS_APPROVED:o.MISSIONS.SUBMISSION_STATUS_REJECTED):o.get(o.MISSIONS.SUBMISSION_STATUS_PENDING),n.appendChild(h),e[i].reviewed&&e[i].review&&(h=document.createElement("span"),h.textContent=" "+e[i].review,n.appendChild(h)),s.appendChild(n),n=document.createElement("td"),n.className="submissionStatsColumn",n.innerHTML=t.formatString(o.get(o.MISSIONS.SUBMISSION_STATS_STARTED),{count:e[i].start})+"<br>"+t.formatString(o.get(o.MISSIONS.SUBMISSION_STATS_WON),{count:e[i].win})+"<br>"+t.formatString(o.get(o.MISSIONS.SUBMISSION_STATS_LOST),{count:e[i].lose}),s.appendChild(n),n=document.createElement("td"),n.className="submissionActionsColumn",r=document.createElement("button"),r.textContent=o.get(e[i].approved?o.MISSIONS.DELETE_SUBMISSION_BUTTON:o.MISSIONS.REVOKE_SUBMISSION_BUTTON),r.onmouseenter=_,r.onclick=p.bind(this,i),n.appendChild(r),s.appendChild(n),c.appendChild(s);this._loadingBox.hide(),this._manageSubmissionsPopupBackground.show()}.bind(this),this._handleMissionHubError.bind(this,!1))},g.prototype._initializeComponents=function(){var r=function(t){t.preventDefault()};i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return e.closeOrNavigateTo(l.SINGLE_PLAYER_SCREEN_NAME),!1}.bind(this),this._backButton._element.oncontextmenu=r,this._difficultySelector.onChange=function(){c.setDifficulty(c.getDifficultyNames()[this._difficultySelector.getSelectedIndex()]),this._updateScores()}.bind(this),this._changeShipButton._element.onmouseup=function(e){var i,s=T.indexOf(E);return E=T[(e.which===t.MouseButton.LEFT?s+1:s-1+T.length)%T.length],i=f.getAvailableLoadouts(E),y=i[0],i.length>1?this._changeLoadoutButton.enable():this._changeLoadoutButton.disable(),this._updateSpacecraft(),e.preventDefault(),!1}.bind(this),this._changeShipButton._element.oncontextmenu=r,this._changeLoadoutButton._element.onmouseup=function(e){var i,s=f.getAvailableLoadouts(E);return i=s.indexOf(y),y=s[(e.which===t.MouseButton.LEFT?i+1:i-1+s.length)%s.length],this._updateSpacecraft(),e.preventDefault(),!1}.bind(this),this._changeLoadoutButton._element.oncontextmenu=r,this._demoButton._element.onclick=function(){return this._launchMission(!0),!1}.bind(this),this._demoButton._element.oncontextmenu=r,this._launchButton._element.onclick=function(){return this._launchMission(!1),!1}.bind(this),this._launchButton._element.oncontextmenu=r,this._fileInput._element.onchange=function(){var i=this._fileInput._element.files[0];if(i){if(this._community&&i.size>102400)return this._showMissionHubClientError(it.INVALID_SUBMIT_PARAMS+st.MISSION_FILE_TOO_LARGE),void this._resetSubmitFile();i.text().then(function(s){var r,a;try{r=JSON.parse(s)}catch(t){return void(this._community?(this._showMissionHubClientError(it.INVALID_SUBMIT_PARAMS+st.WRONG_MISSION_FILE_FORMAT),this._resetSubmitFile()):e.showError("The selected file is not a valid mission file!",e.ErrorSeverity.MINOR))}r&&(this._loadCustom?(r.name=i.name,r.custom=!0,c.getMissionNames().indexOf(r.name)>=0?e.showError("A mission with this filename already exists!",e.ErrorSeverity.MINOR):(c.createMissionDescriptor(r),this._listComponent.setCaption(c.getMissionNames(this._custom).length-1,r.title||t.getFilenameWithoutExtension(r.name)),this.selectMission(r.name),this._listComponent.addListElement({captionID:o.MISSIONS.CUSTOM_MISSION_CAPTION.name,subcaptionID:o.MISSIONS.CUSTOM_MISSION_SUBCAPTION.name}),n.sendEvent("customload"))):this._community&&(a=this._validateMissionData(r),0===a?(this._missionToSubmit=s,this._submitFileButton.setTextContent(i.name),this._updateSubmitMissionButton()):(this._showMissionHubClientError(it.INVALID_SUBMIT_PARAMS+a),this._resetSubmitFile())))}.bind(this)).catch(function(){e.showError("The selected file doesn't seem to be a valid mission file!",e.ErrorSeverity.MINOR)})}}.bind(this),this._fileButton._element.onclick=function(){return this._fileInput._element.click(),!1}.bind(this),this._submitButton._element.onclick=function(){this._updateSubmitMissionButton(),this._submitMissionPopupBackground.show(),this._submitHelpShown||(this._submitMissionHelpButton._element.click(),this._submitHelpShown=!0)}.bind(this),this._submitMissionHelpButton._element.onclick=function(){l.openDialog({header:o.get(o.INFO_BOX.HEADER),message:t.formatString(o.get(o.MISSIONS.SUBMIT_MISSION_HELP),ot),messageClass:l.RELEASE_NOTES_CLASS_NAME,buttons:[{caption:o.get(o.INFO_BOX.OK_BUTTON),action:function(){e.closeSuperimposedScreen()}}]})}.bind(this),this._submitMissionSenderNameInput._element.maxLength=20,this._submitMissionSenderNameInput._element.onkeyup=this._updateSubmitMissionButton,this._submitMissionPasswordInput._element.maxLength=32,this._submitMissionPasswordInput._element.onkeyup=this._updateSubmitMissionButton,this._submitMissionPasswordEye._element.onmousedown=function(){this._submitMissionPasswordInput._element.classList.add(s.FOCUSING_CLASS_NAME)}.bind(this),this._submitMissionPasswordEye._element.onmouseup=function(){this._submitMissionPasswordInput._element.classList.remove(s.FOCUSING_CLASS_NAME)}.bind(this),this._submitMissionPasswordEye._element.onclick=function(t){var e=this._submitMissionPasswordEye._element.classList;e.toggle(s.EYE_CROSSED_CLASS_NAME),this._submitMissionPasswordInput.setAttribute("type",e.contains(s.EYE_CROSSED_CLASS_NAME)?"text":"password"),this._submitMissionPasswordInput._element.focus(),t.preventDefault()}.bind(this),this._submitMissionCommentInput._element.maxLength=200,this._submitFileButton._element.onclick=function(){return this._fileInput._element.click(),!1}.bind(this),this._submitMissionCancelButton._element.onclick=function(){this._submitMissionPopupBackground.hide()}.bind(this),this._submitMissionSubmitButton._element.onclick=function(){this._loadingBox.show(),u.submitMission({sender:this._submitMissionSenderNameInput._element.value,password:this._submitMissionPasswordInput._element.value,comment:this._submitMissionCommentInput._element.value,mission:this._missionToSubmit},function(){this._loadingBox.hide(),this._submitMissionPopupBackground.hide(),this._showMessage(o.get(o.MISSIONS.SUBMIT_MISSION_SUCCESS)),this._manageSubmissionsButton.show()}.bind(this),function(e){this._loadingBox.hide(),this._showMessage(t.formatString(o.get(o.MISSION_HUB_ERROR.PREFIX,e&&e.error||o.MISSION_HUB_ERROR.DEFAULT_SUFFIX.name,t.formatString(o.get(o.MISSION_HUB_ERROR.GENERAL),{code:e?e.error:0})),ot)),e&&(e.error>=it.INVALID_SUBMIT_PARAMS+st.WRONG_MISSION_FILE_FORMAT&&e.error<it.INVALID_SUBMIT_PARAMS+100||e.error===it.OTHER+nt.TITLE_ALREADY_EXISTS)&&this._resetSubmitFile()}.bind(this))}.bind(this),this._manageSubmissionsButton._element.onclick=this._showSubmissions.bind(this),this._manageSubmissionsCloseButton._element.onclick=function(){this._manageSubmissionsPopupBackground.hide()}.bind(this),this._fileInput.hide(),this._submitMissionPopupBackground.hide(),this._manageSubmissionsPopupBackground.hide(),this._loadingBox.makeIndeterminate()},g.prototype._updateComponents=function(){var t;i.HTMLScreen.prototype._updateComponents.call(this),this._difficultySelector.setValueList(d()),this._updateValues(),this._updateScores(),t=document.getElementById(tt),t&&(t.href="license/mission-hub-"+o.getLanguage()+".txt"),a.getGeneralSetting(a.GENERAL_SETTINGS.SHOW_DEMO_BUTTON)?this._demoButton.show():this._demoButton.hide()},g.prototype.show=function(){return!!i.HTMLScreen.prototype.show.call(this)&&(this._community&&this._resetSubmitFile(),this._updateValues(),!0)},g.prototype.selectMission=function(t){var e=this._missionProvider.getMissionNames(this._custom).indexOf(t);this._listComponent.selectIndex(e,!0),this._selectMission(e)},{getMissionsScreen:function(){return new g},mapDifficultyName:p,getDifficultyValues:d}}),define("armada/screens/multi-games",["utils/utils","modules/game","modules/analytics","modules/screens","modules/components","armada/configuration","armada/audio","armada/networking","armada/strings","armada/screens/shared","armada/logic/classes"],function(t,e,i,s,n,o,r,a,l,h,c){"use strict";function u(t){return l.get(l.MULTI_GAME_MODE.PREFIX,t,t)}function _(t){return t.toString()}function p(t){return{getCaption:function(){return c.getSpacecraftClass(t).getDisplayName()},value:t}}function d(){return Object.values(a.GameMode).map(u)}function g(){return o.getSetting(o.MULTI_SETTINGS.MAX_PLAYER_OPTIONS).map(_)}function m(){return o.getSetting(o.MULTI_SETTINGS.SPACECRAFTS).map(p)}function f(){s.HTMLScreen.call(this,h.MULTI_GAMES_SCREEN_NAME,h.MULTI_GAMES_SCREEN_SOURCE,{cssFilename:h.MULTI_GAMES_SCREEN_CSS,backgroundClassName:h.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:h.SCREEN_CONTAINER_CLASS_NAME},{show:function(){r.resetMasterVolume(),r.resetMusicVolume(),r.playMusic(h.MENU_THEME)}},this._getKeyCommands(),h.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(T),this._refreshButton=this.registerSimpleComponent(E),this._createGameButton=this.registerSimpleComponent(y),this._serverInfoContainer=this.registerSimpleComponent(M),this._connectingLabel=this.registerSimpleComponent(I),this._noAvailableGamesLabel=this.registerSimpleComponent(C),this._serverVersionValue=this.registerSimpleComponent(A),this._serverRegionValue=this.registerSimpleComponent(v),this._onlinePlayersValue=this.registerSimpleComponent(N),this._onlineGamesCount=this.registerSimpleComponent(O),this._serverPingValue=this.registerSimpleComponent(L),this._gamesTable=this.registerSimpleComponent(R),this._gamesList=this.registerSimpleComponent(b),this._createGamePopupBackground=this.registerSimpleComponent(V),this._createGameCreateButton=this.registerSimpleComponent(H),this._createGameCancelButton=this.registerSimpleComponent(G),this._createGameNameInput=this.registerSimpleComponent(k),this._playerPopupBackground=this.registerSimpleComponent(x),this._playerOkButton=this.registerSimpleComponent(w),this._playerCancelButton=this.registerSimpleComponent(P),this._playerNameInput=this.registerSimpleComponent(D),this._createGameModeSelector=null,this._createGameMaxPlayersSelector=null,this._createGameSpacecraftsCheckGroup=null,this._infoBox=this.registerExternalComponent(new n.InfoBox(S,h.INFO_BOX_SOURCE,{cssFilename:h.INFO_BOX_CSS},l.INFO_BOX.HEADER.name,l.INFO_BOX.OK_BUTTON.name,{buttonselect:h.playButtonSelectSound,buttonclick:h.playButtonClickSound})),this._interval=-1,o.executeWhenReady(function(){this._createGameModeSelector=this.registerExternalComponent(new n.Selector(j,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:X},{id:l.MULTI_GAMES.GAME_MODE.name},d()),F),this._createGameMaxPlayersSelector=this.registerExternalComponent(new n.Selector(W,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:X},{id:l.MULTI_GAMES.MAX_PLAYERS.name},g()),U),this._createGameSpacecraftsCheckGroup=this.registerExternalComponent(new n.CheckGroup(Y,h.CHECK_GROUP_SOURCE,{cssFilename:h.CHECK_GROUP_CSS},m(),{select:h.playButtonSelectSound,change:function(){h.playButtonClickSound(!0),this._updateCreateGameCreateButton()}.bind(this)}),B)}.bind(this))}var S="infoBox",T="backButton",E="refreshButton",y="createGameButton",M="serverInfoContainer",I="connectingLabel",C="noAvailableGamesLabel",A="serverVersionValue",v="serverRegionValue",N="onlinePlayersValue",O="onlineGamesCount",L="serverPingValue",R="gamesTable",b="gamesList",x="playerPopupBackground",D="playerNameInput",w="playerOkButton",P="playerCancelButton",V="createGamePopupBackground",F="createGameModeContainer",U="createGameMaxPlayersContainer",B="createGameSpacecraftsContainer",H="createGameCreateButton",G="createGameCancelButton",k="createGameName",j="createGameMode",W="createGameMaxPlayers",Y="createGameSpacecrafts",X="smallNumberSelector";return f.prototype=new s.HTMLScreen,f.prototype.constructor=f,f.prototype._getKeyCommands=function(t){return t=t||{},t.escape=function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)},t},f.prototype._showMessage=function(t,e){this._infoBox.updateMessage(t),this._infoBox.onButtonClick(function(){h.playButtonClickSound(),e&&e()}),this._infoBox.show()},f.prototype._cancelInterval=function(){-1!==this._interval&&(clearInterval(this._interval),this._interval=-1)},f.prototype._updatePlayerOkButton=function(){this._playerNameInput._element.value.length>=2?this._playerOkButton.enable():this._playerOkButton.disable()},f.prototype._updateCreateGameCreateButton=function(){this._createGameNameInput._element.value.length>=3&&this._createGameSpacecraftsCheckGroup.getValue().length>0?this._createGameCreateButton.enable():this._createGameCreateButton.disable()},f.prototype._quitMultiplayer=function(){this._cancelInterval(),a.onConnect(null),a.onDisconnect(null),a.disconnect(),e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)},f.prototype.setActive=function(i){var n=!1,o=a.listGames.bind(this,this._updateGamesList.bind(this));s.HTMLScreen.prototype.setActive.call(this,i),i?(a.isConnected()?(this._interval=setInterval(o,5e3),o()):(this._refreshButton.disable(),this._createGameButton.disable(),this._serverInfoContainer.hide(),this._connectingLabel.show(),a.onConnect(function(){this._interval=setInterval(o,5e3),o(),this._createGameButton.enable(),this._connectingLabel.hide(),this._serverVersionValue.setTextContent(a.getServerApiVersion()),this._serverRegionValue.setTextContent(l.get(l.SERVER_REGION.PREFIX,a.getServerRegion(),a.getServerRegion())),this._serverInfoContainer.show()}.bind(this)),a.connect()),a.onDisconnect(function(t){this._cancelInterval(),this._createGamePopupBackground.hide(),this._playerPopupBackground.hide(),n||this._showMessage(l.get(t?l.MULTI_GAMES.DISCONNECT_MESSAGE:l.MULTI_GAMES.CANNOT_CONNECT_MESSAGE),function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}.bind(this))}.bind(this)),a.onError(function(i){var s,o;switch(i){case a.ERROR_CODE_GAME_NOT_FOUND:s=l.MULTI_GAMES.GAME_NOT_FOUND_ERROR;break;case a.ERROR_CODE_GAME_IS_FULL:s=l.MULTI_GAMES.GAME_IS_FULL_ERROR;break;case a.ERROR_CODE_GAME_ALREADY_STARTED:s=l.MULTI_GAMES.GAME_ALREADY_STARTED_ERROR;break;case a.ERROR_CODE_PLAYER_NAME_ALREADY_EXISTS:s=l.MULTI_GAMES.PLAYER_NAME_ALREADY_EXISTS_ERROR,o=function(){this._playerPopupBackground.show()}.bind(this);break;case a.ERROR_CODE_GAME_NAME_ALREADY_EXISTS:s=l.MULTI_GAMES.GAME_NAME_ALREADY_EXISTS_ERROR;break;case a.ERROR_CODE_INVALID_GAME_SETTINGS:s=l.MULTI_GAMES.INVALID_GAME_SETTINGS_ERROR;break;case a.ERROR_CODE_INVALID_PLAYER_NAME:s=l.MULTI_GAMES.INVALID_PLAYER_NAME_ERROR,o=function(){this._createGamePopupBackground.hide(),this._playerPopupBackground.show()}.bind(this);break;case a.ERROR_CODE_INVALID_TEXT:s=l.MULTI_GAMES.INVALID_TEXT_ERROR;break;case a.ERROR_CODE_SERVER_IS_FULL:s=l.MULTI_GAMES.SERVER_IS_FULL_ERROR,o=function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}.bind(this),n=!0;break;case a.ERROR_CODE_INCOMPATIBLE_API_VERSION:s=l.MULTI_GAMES.INCOMPATIBLE_API_VERSION_ERROR,o=function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}.bind(this),n=!0;break;case a.ERROR_CODE_NO_WELCOME:s=l.MULTI_GAMES.NO_WELCOME_ERROR,o=function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}.bind(this),n=!0}this._showMessage(t.formatString(l.get(s),{serverVersion:a.getServerApiVersion(),clientVersion:a.getClientApiVersion()}),o)}.bind(this)),this._createGamePopupBackground.hide(),a.getPlayerName()||(this._playerPopupBackground.show(),this._playerNameInput._element.focus()),this._updatePlayerOkButton(),this._createGameCreateButton.disable()):(this._cancelInterval(),a.onError(null))},f.prototype._initializeComponents=function(){s.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._quitMultiplayer(),!1}.bind(this),this._refreshButton._element.onclick=function(){return a.listGames(this._updateGamesList.bind(this)),!1}.bind(this),this._createGameButton._element.onclick=function(){return this._createGamePopupBackground.show(),this._updateCreateGameCreateButton(),this._createGameNameInput._element.focus(),!1}.bind(this),this._createGameCancelButton._element.onclick=function(){return this._createGamePopupBackground.hide(),!1}.bind(this),this._createGameNameInput._element.maxLength=18,this._createGameNameInput._element.onkeyup=function(){return this._updateCreateGameCreateButton(),!1}.bind(this),this._createGameCreateButton._element.onclick=function(){return a.createGame({gameName:this._createGameNameInput._element.value,gameMode:Object.values(a.GameMode)[this._createGameModeSelector.getSelectedIndex()],maxPlayers:+this._createGameMaxPlayersSelector.getSelectedValue(),settings:{spacecrafts:this._createGameSpacecraftsCheckGroup.getValue()}},function(){i.sendEvent("multicreate"),e.closeOrNavigateTo(h.MULTI_LOBBY_SCREEN_NAME)}),!1}.bind(this),this._playerCancelButton._element.onclick=function(){return this._quitMultiplayer(),!1}.bind(this),this._playerNameInput._element.maxLength=18,this._playerNameInput._element.onkeyup=function(){this._updatePlayerOkButton()}.bind(this),this._playerOkButton._element.onclick=function(){return a.setPlayerName(this._playerNameInput._element.value),this._playerPopupBackground.hide(),!1}.bind(this),this._createGamePopupBackground.hide()},f.prototype._updateComponents=function(){s.HTMLScreen.prototype._updateComponents.call(this),this._createGameModeSelector.setValueList(d()),this._createGameModeSelector.refreshValue()},f.prototype._updateGamesList=function(t){var s,n,o=t.games,r=function(t){return"join-game-"+t},c=function(t){a.joinGame({gameName:o[t].name},function(){i.sendEvent("multijoin"),e.closeOrNavigateTo(h.MULTI_LOBBY_SCREEN_NAME)})};if(this._onlinePlayersValue.setContent(t.players),this._onlineGamesCount.setContent(o.length),
this._serverPingValue.setContent(Math.round(a.getServerPing())+" ms"),o.length>0){for(this._gamesList.setContent(""),o.forEach(function(t,e){var i,s,n;i=document.createElement("tr"),s=document.createElement("td"),s.textContent=t.name,i.appendChild(s),s=document.createElement("td"),s.textContent=l.get(l.MULTI_GAME_MODE.PREFIX,t.mode,t.mode),i.appendChild(s),s=document.createElement("td"),s.textContent=t.host,i.appendChild(s),s=document.createElement("td"),s.className="playersColumn",s.textContent=t.playerCount+"/"+t.maxPlayers,i.appendChild(s),s=document.createElement("td"),s.className="startedColumn",s.textContent=l.get(t.started?l.MULTI_GAMES.STARTED_YES:l.MULTI_GAMES.STARTED_NO),i.appendChild(s),s=document.createElement("td"),s.className="joinColumn",t.playerCount<t.maxPlayers&&!t.started&&(n=document.createElement("button"),n.id=r(e),n.textContent=l.get(l.MULTI_GAMES.JOIN_BUTTON),s.appendChild(n)),i.appendChild(s),this._gamesList._element.appendChild(i)}.bind(this)),s=0;s<o.length;s++)(n=document.getElementById(r(s)))&&(n.onclick=c.bind(this,s));this._gamesTable.show(),this._noAvailableGamesLabel.hide()}else this._gamesTable.hide(),this._noAvailableGamesLabel.show();this._refreshButton.enable()},{getMultiGamesScreen:function(){return new f}}}),define("armada/screens/multi-lobby",["utils/utils","modules/game","modules/analytics","modules/components","modules/screens","armada/configuration","armada/audio","armada/networking","armada/strings","armada/screens/shared","armada/screens/missions","armada/logic/classes","armada/logic/environments","armada/logic/missions"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p){"use strict";function d(){return a.isHost()||a.getGameMode()===a.GameMode.FFA}function g(t){return _.getEnvironment(t).getDisplayName()}function m(){return _.getEnvironmentNames().map(g)}function f(t){return l.get(l.MULTI_LOBBY.LOADOUT_PREFIX,t,t)}function S(){return o.getSetting(o.MULTI_SETTINGS.LOADOUTS).map(f)}function T(t){return"rgb("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+")"}function E(t){return T(a.getGameMode()===a.GameMode.FFA?t.settings.color:a.getPlayers()[0].settings.color)}function y(t,e){return Math.abs(t[0]-e[0])<.05&&Math.abs(t[1]-e[1])<.05&&Math.abs(t[2]-e[2])<.05}function M(t){var e,i,s=a.getPlayers();if(a.getGameMode()===a.GameMode.FFA){for(e=0;e<q.length&&!y(t,q[e]);e++);for(e=e>=q.length?0:(e+1)%q.length,i=0;i<s.length;i++)!s[i].me&&y(q[e],s[i].settings.color)&&(i=-1,e=(e+1)%q.length);return q[e]}return e=q.findIndex(function(t){return y(t,s[0].settings.color)}),q[(e+1)%q.length]}function I(t){var e=a.getGameSettings().spacecrafts;return e[(e.indexOf(t)+1)%e.length]}function C(){n.HTMLScreen.call(this,h.MULTI_LOBBY_SCREEN_NAME,h.MULTI_LOBBY_SCREEN_SOURCE,{cssFilename:h.MULTI_LOBBY_SCREEN_CSS,backgroundClassName:h.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:h.SCREEN_CONTAINER_CLASS_NAME},{show:function(){r.resetMasterVolume(),r.resetMusicVolume(),r.playMusic(h.MENU_THEME)}},{},h.BUTTON_EVENT_HANDLERS),this._gameTitle=this.registerSimpleComponent(A),this._leaveButton=this.registerSimpleComponent(v),this._readyButton=this.registerSimpleComponent(N),this._startButton=this.registerSimpleComponent(O),this._playersList=this.registerSimpleComponent(L),this._kickColumn=this.registerSimpleComponent(R),this._chatLog=this.registerSimpleComponent(b),this._chatMessage=this.registerSimpleComponent(x),this._remainingMessageChars=this.registerSimpleComponent(D),this._chatSend=this.registerSimpleComponent(w),this._hostSettings=this.registerSimpleComponent(V),this._guestSettings=this.registerSimpleComponent(F),this._locationValue=this.registerSimpleComponent(U),this._loadoutValue=this.registerSimpleComponent(B),this._difficultyValue=this.registerSimpleComponent(H),this._difficultyContainer=this.registerSimpleComponent(G),this._enemiesPerWaveValue=this.registerSimpleComponent(k),this._enemiesPerWaveContainer=this.registerSimpleComponent(j),this._pingInterval=-1,this._locationSelector=null,this._loadoutSelector=null,this._difficultySelector=null,this._enemiesPerWaveSelector=null,this._infoBox=this.registerExternalComponent(new s.InfoBox(P,h.INFO_BOX_SOURCE,{cssFilename:h.INFO_BOX_CSS},l.INFO_BOX.HEADER.name,l.INFO_BOX.OK_BUTTON.name,{buttonselect:h.playButtonSelectSound,buttonclick:h.playButtonClickSound})),o.executeWhenReady(function(){this._difficultySelector=this.registerExternalComponent(new s.Selector(X,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:l.MULTI_LOBBY.DIFFICULTY_LABEL.name},c.getDifficultyValues()),V),_.executeWhenReady(function(){this._locationSelector=this.registerExternalComponent(new s.Selector(W,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:l.MULTI_LOBBY.LOCATION_LABEL.name},m()),V)}.bind(this)),this._loadoutSelector=this.registerExternalComponent(new s.Selector(Y,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:l.MULTI_LOBBY.LOADOUT_LABEL.name},S()),V),this._enemiesPerWaveSelector=this.registerExternalComponent(new s.Selector(z,h.SELECTOR_SOURCE,{cssFilename:h.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:l.MULTI_LOBBY.ENEMIES_PER_WAVE_LABEL.name},J),V)}.bind(this))}var A="gameTitle",v="leaveButton",N="readyButton",O="startButton",L="playersList",R="kickColumn",b="chatLog",x="chatMessage",D="remainingMessageChars",w="chatSend",P="infoBox",V="hostSettings",F="guestSettings",U="locationValue",B="loadoutValue",H="difficultyValue",G="difficultyContainer",k="enemiesPerWaveValue",j="enemiesPerWaveContainer",W="locationSelector",Y="loadoutSelector",X="difficultySelector",z="enemiesPerWaveSelector",q=[[.8,.2,.2],[.2,.2,.8],[.2,.8,.2],[.8,.8,.2],[.8,.2,.8],[.1,.1,.1],[.9,.9,.9]],J=[3,5,7,9];return C.prototype=new n.HTMLScreen,C.prototype.constructor=C,C.prototype._showMessage=function(t,e){this._infoBox.updateMessage(t),this._infoBox.onButtonClick(function(){h.playButtonClickSound(),e&&e()}),this._infoBox.show()},C.prototype._cancelInterval=function(){-1!==this._pingInterval&&(clearInterval(this._pingInterval),this._pingInterval=-1)},C.prototype._logMessage=function(e,i){var s,n=document.createElement("p"),o=new Date;n.innerHTML='<span class="multi-message-time">['+t.getPaddedStringForNumber(o.getHours(),2)+":"+t.getPaddedStringForNumber(o.getMinutes(),2)+"] </span>",i&&(s=document.createElement("span"),s.textContent=i+": ",s.className="multi-message-sender",n.appendChild(s)),s=document.createElement("span"),s.textContent=e,s.className=i?"multi-message":"multi-message-system",n.appendChild(s),this._chatLog._element.appendChild(n),n.scrollIntoView(!1),n.style.background="none"},C.prototype.setActive=function(s){var o;n.HTMLScreen.prototype.setActive.call(this,s),s?(this._gameTitle.setTextContent(l.get(l.MULTI_LOBBY.GAME_TITLE),{name:a.getGameName(),mode:l.get(l.MULTI_GAME_MODE.PREFIX,a.getGameMode())}),this._updatePlayersList(),a.onDisconnect(function(){this._cancelInterval(),this._showMessage(l.get(l.MULTI_GAMES.DISCONNECT_MESSAGE),function(){e.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}.bind(this))}.bind(this)),a.onGameSettingsChanged(function(){this._updateGameSettings()}.bind(this)),a.onPlayerJoin(function(e){this._updatePlayersList(),this._logMessage(t.formatString(l.get(l.MULTI_LOBBY.PLAYER_JOINED_MESSAGE),{name:e}))}.bind(this)),a.onPlayerLeave(function(e){this._updatePlayersList(),this._logMessage(t.formatString(l.get(l.MULTI_LOBBY.PLAYER_LEFT_MESSAGE),{name:e.name}))}.bind(this)),a.onPlayerReady(function(e){this._updatePlayersList(),this._logMessage(t.formatString(l.get(l.MULTI_LOBBY.PLAYER_READY_MESSAGE),{name:e.name}))}.bind(this)),a.onPlayerKicked(function(e){this._updatePlayersList(),this._logMessage(t.formatString(l.get(l.MULTI_LOBBY.PLAYER_KICKED_MESSAGE),{name:e.name}))}.bind(this)),a.onPlayerUpdate(function(){this._updatePlayersList()}.bind(this)),a.onText(function(t){this._logMessage(t.text,t.sender)}.bind(this)),a.onHostLeft(function(){this._cancelInterval(),this._showMessage(l.get(l.MULTI_LOBBY.HOST_LEFT_MESSAGE),function(){e.closeOrNavigateTo(h.MULTI_GAMES_SCREEN_NAME)}.bind(this))}.bind(this)),a.onKicked(function(){this._cancelInterval(),this._showMessage(l.get(l.MULTI_LOBBY.KICKED_MESSAGE),function(){e.closeOrNavigateTo(h.MULTI_GAMES_SCREEN_NAME)}.bind(this))}.bind(this)),a.onGameStart(function(){i.sendEvent(a.isHost()?"multistarthost":"multistartguest"),e.setScreen(h.BATTLE_SCREEN_NAME),e.getScreen().startNewBattle({missionData:a.getMissionData(),difficulty:a.getGameSettings().difficulty,demoMode:!1,multi:!0})}),a.onError(function(t){var e;switch(t){case a.ERROR_CODE_INVALID_TEXT:e=l.MULTI_GAMES.INVALID_TEXT_ERROR}this._showMessage(l.get(e))}.bind(this)),this._readyButton.setVisible(!a.isHost()),this._readyButton.enable(),this._startButton.setVisible(a.isHost()),this._startButton.disable(),this._chatLog.setContent(""),this._logMessage(a.isHost()?t.formatString(l.get(l.MULTI_LOBBY.GAME_CREATED_MESSAGE),{name:a.getGameName()}):l.get(l.MULTI_LOBBY.JOINED_MESSAGE)),this._chatMessage._element.value="",this._chatMessage._element.placeholder=l.get(l.MULTI_LOBBY.CHAT_MESSAGE_PLACEHOLDER),this._chatSend.disable(),this._pingInterval=setInterval(a.ping,3e3),this._updateGameSettings(),o=a.getGameMode()===a.GameMode.COOP,this._difficultyContainer.setVisible(o),this._difficultySelector.setVisible(o),this._enemiesPerWaveContainer.setVisible(o),this._enemiesPerWaveSelector.setVisible(o),this._hostSettings.setVisible(a.isHost()),this._guestSettings.setVisible(!a.isHost())):this._cancelInterval()},C.prototype._sendText=function(){var t=this._chatMessage._element.value;t&&(a.sendText(t),this._logMessage(t,a.getPlayerName())),this._chatMessage._element.value="",this._remainingMessageChars._element.textContent=50,this._chatSend.disable()},C.prototype._initializeComponents=function(){n.HTMLScreen.prototype._initializeComponents.call(this),this._leaveButton._element.onclick=function(){return a.leaveGame(),e.closeOrNavigateTo(h.MULTI_GAMES_SCREEN_NAME),!1}.bind(this),this._readyButton._element.onclick=function(){return a.markReady(),this._logMessage(l.get(l.MULTI_LOBBY.READY_MESSAGE)),this._readyButton.disable(),!1}.bind(this),this._startButton._element.onclick=function(){return a.startGame(),this._startButton.disable(),!1}.bind(this),this._chatSend._element.onclick=function(){return this._sendText(),!1}.bind(this),this._chatMessage._element.maxLength=50,this._remainingMessageChars._element.textContent=50,this._chatMessage._element.oninput=function(){var t=this._chatMessage._element.value;this._remainingMessageChars._element.textContent=t?50-t.length:50}.bind(this),this._chatMessage._element.onkeyup=function(t){13===t.keyCode?this._sendText():this._chatMessage._element.value?this._chatSend.enable():this._chatSend.disable()}.bind(this),this._locationSelector.onChange=function(){a.updateGameSettings({environment:_.getEnvironmentNames()[this._locationSelector.getSelectedIndex()]})}.bind(this),this._loadoutSelector.onChange=function(){a.updateGameSettings({loadout:o.getSetting(o.MULTI_SETTINGS.LOADOUTS)[this._loadoutSelector.getSelectedIndex()]})}.bind(this),this._difficultySelector.onChange=function(){a.updateGameSettings({difficulty:p.getDifficultyNames()[this._difficultySelector.getSelectedIndex()]})}.bind(this),this._enemiesPerWaveSelector.onChange=function(){a.updateGameSettings({enemiesPerWave:this._enemiesPerWaveSelector.getSelectedValue()})}.bind(this)},C.prototype._updateComponents=function(){n.HTMLScreen.prototype._updateComponents.call(this),this._locationSelector.setValueList(m()),this._loadoutSelector.setValueList(S()),this._difficultySelector.setValueList(c.getDifficultyValues())},C.prototype._updatePlayersList=function(){var t,e,i,s=a.getPlayers(),n=function(){var t=M(a.getPlayerSettings().color);a.updatePlayerSettings({color:t}),this._updatePlayersList()},o=function(){var t=I(a.getPlayerSettings().spacecraft);a.updatePlayerSettings({spacecraft:t}),this._updatePlayersList()},r=function(t){return"kick-player-"+t},h=function(t){a.kickPlayer(s[t].name)};if(this._kickColumn.setVisible(a.isHost()),this._playersList.setContent(""),s.forEach(function(t,e){var i,s;i=document.createElement("tr"),s=document.createElement("td"),s.textContent=t.name,i.appendChild(s),i.innerHTML+="<td><div "+(t.me&&d()?'id="player-color-selector"':"")+' class="colorIndicator'+(t.me&&!t.ready&&d()?" colorSelector":"")+'"></div></td><td>'+(t.me&&!t.ready?'<button id="player-spacecraft-selector" class="selectSpacecraft">':"")+u.getSpacecraftClass(t.settings.spacecraft).getDisplayName()+(t.me&&!t.ready?"</button>":"")+"</td><td>"+(t.me?"":l.get(t.peer?l.MULTI_LOBBY.CONNECTION_DIRECT:l.MULTI_LOBBY.CONNECTION_SERVER))+"</td><td>"+(t.me?"":t.ping?Math.round(t.ping)+" ms":"?")+"</td><td>"+l.get(0===e||t.ready?l.MULTI_LOBBY.READY_YES:l.MULTI_LOBBY.READY_NO)+"</td>"+(a.isHost()?"<td>"+(t.me?"":'<button id="'+r(e)+'" class="kickPlayer">'+l.get(l.MULTI_LOBBY.KICK_BUTTON)+"</button>")+"</td>":"")+"</tr>",i.querySelector(".colorIndicator").style.backgroundColor=E(t),this._playersList._element.appendChild(i)}.bind(this)),d()&&(document.getElementById("player-color-selector").onclick=n.bind(this)),i=document.getElementById("player-spacecraft-selector"),i&&(i.onclick=o.bind(this)),a.isHost()){for(t=1;t<s.length;t++)e=document.getElementById(r(t)),e.onclick=h.bind(this,t);a.allPlayersReady()?this._startButton.enable():this._startButton.disable()}},C.prototype._updateGameSettings=function(){var t,e,i,s=a.getGameSettings();t=g(s.environment),e=f(s.loadout),i=c.mapDifficultyName(s.difficulty),this._locationValue.setTextContent(t),this._loadoutValue.setTextContent(e),this._difficultyValue.setTextContent(i),this._enemiesPerWaveValue.setTextContent(s.enemiesPerWave),this._locationSelector.selectValue(t),this._loadoutSelector.selectValue(e),this._difficultySelector.selectValue(i),this._enemiesPerWaveSelector.selectValue(s.enemiesPerWave)},{getMultiLobbyScreen:function(){return new C}}}),define("armada/screens/debriefing",["utils/utils","modules/game","modules/screens","armada/configuration","armada/strings","armada/audio","armada/screens/shared","armada/logic/missions/events"],function(t,e,i,s,n,o,r,a){"use strict";function l(){i.HTMLScreen.call(this,r.DEBRIEFING_SCREEN_NAME,r.DEBRIEFING_SCREEN_SOURCE,{cssFilename:r.DEBRIEFING_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},{show:function(){o.resetMasterVolume(),o.resetMusicVolume(),o.playMusic(h?r.DEBRIEFING_VICTORY_THEME:r.DEBRIEFING_DEFEAT_THEME,void 0,1.5)}},{escape:function(){e.closeOrNavigateTo(r.MAIN_MENU_SCREEN_NAME)}},r.BUTTON_EVENT_HANDLERS),this._nextMissionName=null,this._backButton=this.registerSimpleComponent(c),this._title=this.registerSimpleComponent(u),this._medal=this.registerSimpleComponent(_),this._scoreContainer=this.registerSimpleComponent(p),this._scoreSpan=this.registerSimpleComponent(d),this._newRecord=this.registerSimpleComponent(g),this._descriptionParagraph=this.registerSimpleComponent(m),this._objectivesTable=this.registerSimpleComponent(f),this._scoreBreakdownContainer=this.registerSimpleComponent(S),this._timeCell=this.registerSimpleComponent(T),this._killsCell=this.registerSimpleComponent(E),this._damageCell=this.registerSimpleComponent(y),this._hitRatioCell=this.registerSimpleComponent(M),this._mDamageCell=this.registerSimpleComponent(I),this._mHitRatioCell=this.registerSimpleComponent(C),this._hullIntegrityCell=this.registerSimpleComponent(A),this._teamSurvivalCell=this.registerSimpleComponent(v),this._baseScoreCell=this.registerSimpleComponent(N),this._hitRatioBonusCell=this.registerSimpleComponent(O),this._hullIntegrityBonusCell=this.registerSimpleComponent(L),this._teamSurvivalBonusCell=this.registerSimpleComponent(R),this._restartButton=this.registerSimpleComponent(b),this._nextButton=this.registerSimpleComponent(x)}var h,c="backButton",u="title",_="medal",p="scoreContainer",d="score",g="newRecord",m="description",f="objectivesTable",S="scoreBreakdownContainer",T="timeCell",E="killsCell",y="damageCell",M="hitRatioCell",I="missileDamageCell",C="missileHitRatioCell",A="hullIntegrityCell",v="teamSurvivalCell",N="baseScoreCell",O="hitRatioBonusCell",L="hullIntegrityBonusCell",R="teamSurvivalBonusCell",b="restartButton",x="nextButton";return l.prototype=new i.HTMLScreen,l.prototype.constructor=l,l.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return e.closeOrNavigateTo(r.MISSIONS_SCREEN_NAME),!1}.bind(this),this._restartButton._element.onclick=function(){return e.closeOrNavigateTo(r.BATTLE_SCREEN_NAME),e.getScreen().startNewBattle({restart:!0}),!1}.bind(this),this._nextButton._element.onclick=function(){return e.closeOrNavigateTo(r.MISSIONS_SCREEN_NAME),e.getScreen().selectMission(this._nextMissionName),!1}.bind(this)},l.prototype._updateComponents=function(){i.HTMLScreen.prototype._updateComponents.call(this)},l.prototype.setData=function(e){var i,s,o,r,l;switch(s=e.missionState===a.MissionState.COMPLETED,h=e.missionState===a.MissionState.COMPLETED||e.missionState===a.MissionState.NONE,i=s?n.get(n.PERFORMANCE_LEVEL.PREFIX,e.performance):"",this._title.setContent(e.missionState===a.MissionState.COMPLETED?n.get(n.DEBRIEFING.VICTORY_TITLE):e.missionState===a.MissionState.NONE?n.get(n.DEBRIEFING.GENERIC_TITLE):n.get(n.DEBRIEFING.DEFEAT_TITLE)),this._medal._element.src=t.formatString("assets/images/empire_{performance}_100.png",{performance:e.missionState!==a.MissionState.NONE?e.performance:"white"}),this._scoreContainer.setVisible(s),this._scoreSpan.setVisible(s),this._scoreSpan.isVisible()&&this._scoreSpan.setContent(n.get(n.DEBRIEFING.SCORE),{score:e.score}),this._newRecord.setVisible(s&&e.isRecord),e.missionState){case a.MissionState.COMPLETED:o=t.formatString(n.get(n.DEBRIEFING.DESCRIPTION_VICTORY),{performance:n.getDefiniteArticleForWord(i)+" <strong>"+i+"</strong>"})+(e.nextPerformanceScore?t.formatString(n.get(n.DEBRIEFING.DESCRIPTION_NEXT_PERFORMANCE),{score:e.nextPerformanceScore}):"");break;case a.MissionState.NONE:o=n.get(n.DEBRIEFING.DESCRIPTION_GENERIC);break;case a.MissionState.FAILED:o=n.get(n.DEBRIEFING.DESCRIPTION_FAIL);break;case a.MissionState.DEFEAT:o=n.get(n.DEBRIEFING.DESCRIPTION_DEFEAT);break;default:o=n.get(n.DEBRIEFING.DESCRIPTION_LEFT_EARLY)}for(this._descriptionParagraph.setContent(o),o="",r=0;r<e.objectives.length;r++)l=e.missionState===a.MissionState.COMPLETED||e.objectivesCompleted[r],o+='<tr><td class="'+(l?"completedObjective":"failedObjective")+'">'+(l?n.get(n.DEBRIEFING.COMPLETED):n.get(n.DEBRIEFING.FAILED))+':</td><td class="statLabelCell">'+e.objectives[r]+"</td></tr>";this._objectivesTable.setContent(o),this._timeCell.setContent(t.formatTimeToMinutes(e.elapsedTime)),this._killsCell.setContent(e.kills.toString()),this._damageCell.setContent(e.damageDealt.toString()),this._hitRatioCell.setContent(e.hitRatio>0?Math.round(100*e.hitRatio)+"%":"-"),this._mDamageCell.setContent(e.missileDamageDealt.toString()),this._mHitRatioCell.setContent(e.missilesHit.toString()+" / "+e.missilesLaunched.toString()),this._hullIntegrityCell.setContent(Math.round(100*e.hullIntegrity)+"%"),this._teamSurvivalCell.setContent(void 0!==e.teamSurvival?Math.round(100*e.teamSurvival)+"%":"-"),this._scoreBreakdownContainer.setVisible(s),this._scoreBreakdownContainer.isVisible()&&(this._baseScoreCell.setContent(e.baseScore.toString()),this._hitRatioBonusCell.setContent(e.hitRatioBonus.toString()),this._hullIntegrityBonusCell.setContent(e.hullIntegrityBonus.toString()),this._teamSurvivalBonusCell.setContent(e.teamSurvivalBonus?e.teamSurvivalBonus.toString():"-")),this._nextMissionName=e.nextMissionName,this._nextMissionName?this._nextButton.show():this._nextButton.hide()},{getDebriefingScreen:function(){return new l}}}),define("armada/screens/multi-score",["utils/utils","modules/game","modules/screens","armada/configuration","armada/strings","armada/audio","armada/networking","armada/screens/shared"],function(t,e,i,s,n,o,r,a){"use strict";function l(){i.HTMLScreen.call(this,a.MULTI_SCORE_SCREEN_NAME,a.MULTI_SCORE_SCREEN_SOURCE,{cssFilename:a.MULTI_SCORE_SCREEN_CSS,backgroundClassName:a.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:a.SCREEN_CONTAINER_CLASS_NAME},{show:function(){o.resetMasterVolume(),o.resetMusicVolume(),o.playMusic(a.DEBRIEFING_VICTORY_THEME,void 0,1.5),this.updateData()}.bind(this)},{escape:function(){e.closeOrNavigateTo(a.MULTI_GAMES_SCREEN_NAME)}},a.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(h),this._title=this.registerSimpleComponent(c),this._playersList=this.registerSimpleComponent(u)}var h="backButton",c="title",u="playersList",_=function(t){return 1e3*t.stats.kills-t.stats.deaths};return l.prototype=new i.HTMLScreen,l.prototype.constructor=l,l.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return e.closeOrNavigateTo(a.MULTI_GAMES_SCREEN_NAME),!1}.bind(this)},l.prototype.updateData=function(){var e,i,s;r.isInGame()&&(s=r.getPlayers().slice().sort(function(t,e){return _(e)-_(t)}),this._title.setTextContent(t.formatString(n.get(n.MULTI_SCORE.TITLE),{gameName:r.getGameName()})),e=1,i=0,this._playersList.setContent(""),s.forEach(function(t,s){var n,o,r=_(t);r<i&&(e=s+1),i=r,n=document.createElement("tr"),n.className=t.me?"me":t.left?"left":"",n.innerHTML='<td class="playerRank">'+e+"</td>",o=document.createElement("td"),o.textContent=t.name,n.appendChild(o),o=document.createElement("td"),o.textContent=t.stats.kills,o.className="number",n.appendChild(o),o=document.createElement("td"),o.textContent=t.stats.deaths,o.className="number",n.appendChild(o),this._playersList._element.appendChild(n)}.bind(this)))},{getMultiScoreScreen:function(){return new l}}}),define("armada/screens/database",["utils/utils","utils/vectors","utils/matrices","modules/components","modules/screens","modules/game","modules/media-resources","modules/scene/lights","modules/scene/scene-graph","armada/screens/shared","armada/strings","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/missions","armada/logic/spacecraft","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g){"use strict";function m(){return!!u.isRevealAvailable()}function f(){return u.isRevealAvailable()&&!0}function S(){clearInterval(rt),rt=G}function T(){at=0}function E(){var t,e=performance.now(),i=m()?F:B,s=H;at=i,rt!==G&&clearInterval(rt),rt=setInterval(function(){t=performance.now()-e,t>2e3*B&&(t=Math.max(2e3*B,t-2e3)),at<s?at=Math.min(i+t/2e3,s):(S(),st.setShouldAnimate(!0))},1e3/60)}function y(){clearInterval(lt),lt=G}function M(e){var s=i.prod3x3SubOf4Aux(i.rotationZ4Aux(e*t.RAD),i.rotationX4Aux(60*t.RAD));ht&&ht.setOrientationMatrix(i.copy(s)),ct&&ct.setOrientationMatrix(i.copy(s))}function I(t){var e,i=performance.now();M(t),lt!==G&&clearInterval(lt),lt=setInterval(function(){var t=nt.vMo;e=performance.now(),t&&(ht&&ht.rotate(t.getZDirectionVector(),(e-i)*Math.radians(.09)),ct&&ct.rotate(t.getZDirectionVector(),(e-i)*Math.radians(.09))),i=e},1e3/60)}function C(t){t=Math.min(Math.max(.9*_t,t),1.6*_t),ct&&ct.setScale(t),ht&&ht.setScale(t)}function A(t){var e=t.getMaxY(),i=t.getHeight();P=[0,1,0,1],V=[1,1,1,1],t.setUniformValueFunction(tt,function(){return P}),t.setUniformValueFunction(Q,function(){return at<=U}),t.setUniformValueFunction(K,function(){return e-(at>U?at-U:at)*i*1.15}),t.setUniformValueFunction(Z,function(){return at<=U?.15*i:0}),t.setUniformValueFunction($,function(){return V})}function v(t){var e=t.getMaxY(),i=t.getHeight();V=[1,1,1,1],t.setUniformValueFunction(Q,function(){return!0}),t.setUniformValueFunction(K,function(){return e-(at-B)*i*1.15}),t.setUniformValueFunction(Z,function(){return at<H?.15*i:0}),t.setUniformValueFunction($,function(){return V})}function N(){var t=_.getSpacecraftClassesInArray(!0)[ot];nt=new g.Spacecraft(t,null,i.identity4(),i.identity4(),t._defaultLoadout),u.getShader("oneColorReveal"),u.getShader("reveal"),nt.addToScene(st,u.getMaxLoadedLOD(),!1,{weapons:!0,missilesInLaunchers:!0,lightSources:!0,blinkers:!0},{shaderName:"reveal"},function(t){ht=t,v(ht)},function(t){v(t)},function(t){v(t)}),m()?nt.addToScene(st,u.getMaxLoadedLOD(),!0,{weapons:!0,missilesInLaunchers:!0},{shaderName:"oneColorReveal"},function(t){ct=t,A(ct)},function(t){A(t)},function(t){A(t)}):ct=null}function O(i){ht&&(ht.rotate(e.UNIT3_Y,1*-(i.screenX-ut[0])*t.RAD),ht.rotate(e.UNIT3_X,1*-(i.screenY-ut[1])*t.RAD)),ct&&(ct.rotate(e.UNIT3_Y,1*-(i.screenX-ut[0])*t.RAD),ct.rotate(e.UNIT3_X,1*-(i.screenY-ut[1])*t.RAD)),ut=[i.screenX,i.screenY]}function L(t){return document.body.onmousemove=null,document.body.onmouseup=null,nt&&I(180),t.preventDefault(),!1}function R(t){return ut=[t.screenX,t.screenY],y(),document.body.onmousemove=O,document.body.onmouseup=L,t.preventDefault(),!1}function b(t){var e,i=0;return t.deltaY>0&&(i=it),t.deltaY<1&&(i=et),i&&(e=nt.vMo.sM[0],C(e*i)),!1}function x(t){return(t?c.get(c.DATABASE.HEIGHT)+": {height}<br/>":c.get(c.DATABASE.LENGTH)+": {length}<br/>")+c.get(c.SPACECRAFT_STATS.ARMOR)+": {armor} ("+c.get(c.SPACECRAFT_STATS.ARMOR_RATING)+")<br/>"+c.get(c.DATABASE.WEAPON_SLOTS)+": {weaponSlots}<br/>"+c.get(c.DATABASE.MISSILE_LAUNCHERS)+": {missileLaunchers}<br/>"+c.get(c.DATABASE.LOCK_RESIST)+": {lockResist}<br/>"}function D(){S(),y(),o.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}function w(){n.HTMLScreenWithCanvases.call(this,h.DATABASE_SCREEN_NAME,h.DATABASE_SCREEN_SOURCE,{cssFilename:h.DATABASE_SCREEN_CSS,backgroundClassName:h.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:h.SCREEN_CONTAINER_CLASS_NAME},u.getAntialiasing(),!0,u.getFiltering(),!0,void 0,{escape:D,left:this.selectPreviousShip.bind(this),right:this.selectNextShip.bind(this)},h.BUTTON_EVENT_HANDLERS),this._itemNameHeader=this.registerSimpleComponent(k),this._itemTypeHeader=this.registerSimpleComponent(j),this._itemStatsParagraph=this.registerSimpleComponent(W),this._itemDescriptionParagraph=this.registerSimpleComponent(Y),this._backButton=this.registerSimpleComponent(X),this._prevButton=this.registerSimpleComponent(z),this._nextButton=this.registerSimpleComponent(q),this._loadingBox=this.registerExternalComponent(new s.LoadingBox(J,h.LOADING_BOX_SOURCE,{cssFilename:h.LOADING_BOX_CSS},c.LOADING.HEADER.name))}var P,V,F=0,U=F+1,B=U,H=B+1,G=-1,k="itemName",j="itemType",W="itemStats",Y="itemDescription",X="backButton",z="prevButton",q="nextButton",J="loadingBox",Q="revealFront",K="revealStart",Z="revealTransitionLength",$="revealColor",tt="color",et=1.05,it=.95,st=(p.DATABASE_SETTINGS,null),nt=null,ot=0,rt=-1,at=0,lt=-1,ht=null,ct=null,ut=null,_t=0,pt=0,dt=0,gt=!0;return w.prototype=new n.HTMLScreenWithCanvases,w.prototype.constructor=w,w.prototype._initializeComponents=function(){n.HTMLScreenWithCanvases.prototype._initializeComponents.call(this),this._backButton._element.onclick=D,this._prevButton._element.onclick=function(){this.selectPreviousShip()}.bind(this),this._nextButton._element.onclick=function(){this.selectNextShip()}.bind(this)},w.prototype._updateItemInfo=function(){var e,i,s,n,o=_.getSpacecraftClassesInArray(!0)[ot];if(pt=nt&&nt.vMo?nt.vMo.getHeightInMeters():0,dt=nt&&nt.vMo?nt.vMo.getDepthInMeters():0,this._itemNameHeader.setContent(o.getDisplayName()),this._itemTypeHeader.setContent(o._scType.getDisplayName()),o._mLs.length>0)for(n="",i=o.getMissileLaunchersBySize(),s=Object.keys(i),e=0;e<s.length;e++)e>0&&(n+=", "),n+=i[s[e]].length+" "+c.get(c.MISSILE_SIZE.PREFIX,s[e],s[e]);this._itemStatsParagraph.setContent(x(!o.isFighterClass()&&dt>pt),{length:pt&&t.getLengthString(pt)||"-",height:dt&&t.getLengthString(dt)||"-",armor:o._hitpoints||"-",rating:o._armor||"0",weaponSlots:o._wSlots.length||"-",missileLaunchers:o._mLs.length>0?n:"-",lockResist:o.getLockingTimeFactor()||"-"}),this._itemDescriptionParagraph.setContent(o.getDisplayDescription()+"<br/><br/>"+o._scType.getDisplayDescription())},w.prototype._updateComponents=function(){n.HTMLScreenWithCanvases.prototype._updateComponents.call(this),this._updateItemInfo()},w.prototype._updateLoadingStatus=function(t,e){void 0!==t&&this._loadingBox.updateStatus(h.getSubParagraph(t)),void 0!==e&&this._loadingBox.updateProgress(e)},w.prototype._updateLoadingBoxForResourceLoad=function(e,i,s,n){this._updateLoadingStatus(t.formatString(c.get(c.LOADING.RESOURCE_READY),{resource:e,resourceType:i,loaded:n,total:s}),15+n/s*60)},w.prototype._initializeCanvas=function(){var t,e,i,s;if(gt=!0,document.body.classList.add("wait"),this._loadingBox.show(),this._updateLoadingStatus(c.get(c.DATABASE.LOADING_BOX_INITIALIZING),0),this.getScreenCanvas("databaseCanvas").handleResize(),u.shouldUseShadowMapping()&&u.getShadowMappingShader(),t=this.getScreenCanvas("databaseCanvas")._canvas,st=new l.Scene(0,0,1,1,!0,[!0,!0,!0,!0],[0,0,0,0],!0,u.getLODContext(),u.getMaxDirLights(),u.getMaxPointLights(),u.getMaxSpotLights(),{useVerticalValues:!0,viewDistance:2e3,fov:60,span:.2}),i=[{color:[1,1,1],direction:[0,1,1]},{color:[1,1,1],direction:[1,0,0]}])for(e=0;e<i.length;e++)st.addDirectionalLightSource(new a.DirectionalLightSource(i[e].color,i[e].direction));r.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),r.executeWhenReady(function(){s=u.getShadowMappingSettings(),s&&(s.ranges=[],s.deferSetup=!0),st.setShadowMapping(s)}.bind(this)),this._updateLoadingStatus(c.get(c.LOADING.RESOURCES_START),15),ot=0,this.loadShip(),t.onmousedown=R,t.onwheel=b},w.prototype.show=function(){return!!n.HTMLScreenWithCanvases.prototype.show.call(this)&&(this.executeWhenReady(function(){this._initializeCanvas()}),!0)},w.prototype.hide=function(){return!!n.HTMLScreenWithCanvases.prototype.hide.call(this)&&(this.executeWhenReady(function(){st.clearNodes(!0),st.clearPointLights(),st.clearSpotLights(),this.render()}),rt!==G&&(clearInterval(rt),rt=G),lt!==G&&(clearInterval(lt),lt=G),!0)},w.prototype.selectPreviousShip=function(){ot-=1,-1===ot&&(ot=_.getSpacecraftClassesInArray(!0).length-1),this.loadShip()},w.prototype.selectNextShip=function(){ot=(ot+1)%_.getSpacecraftClassesInArray(!0).length,this.loadShip()},w.prototype.loadShip=function(e){e&&(ot=_.getSpacecraftClassesInArray(!0).indexOf(_.getSpacecraftClass(e))),document.body.classList.add("wait"),S(),y(),this.stopRenderLoop(),st.clearNodes(!0),st.clearPointLights(),st.clearSpotLights(),st.setShouldAnimate(!1),nt&&nt.destroy(),nt=null,this.render(),d.executeWhenReady(function(){this._updateItemInfo(),N(),r.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),r.executeWhenReady(function(){var e,i,s,n=nt.vMo;if(!n)return void o.log("WARNING! No visual item to load for database, loading aborted!");if(this._updateItemInfo(),this.bindSceneToCanvas(st,this.getScreenCanvas("databaseCanvas")),st._camera.moveToPosition([0,0,n.getScaledSize()],0),u.shouldUseShadowMapping()){for(e=new Array(u.getNumShadowMapRanges()),s=n.getScaledSize()/e.length,i=0;i<e.length;i++)e[i]=(i+1)*s;st.setShadowMapRanges(e),st.enableShadowMapping()}else st.disableShadowMapping();_t=n.sM[0],C(1*_t),this._updateLoadingStatus(c.get(c.LOADING.INIT_WEBGL),75),this._sceneCanvasBindings[0].canvas.getManagedContext().setup(),f()&&T(),this.render(),t.executeAsync(function(){this.startRenderLoop(1e3/60),I(f()?90:180),f()?E():(at=H,st.setShouldAnimate(!0)),document.body.classList.remove("wait"),!gt&&gt||(this._updateLoadingStatus(c.get(c.LOADING.READY),100),this._loadingBox.hide()),gt=!1}.bind(this))}.bind(this),function(){gt||this._loadingBox.show()
}.bind(this),!0),this._updateLoadingStatus(c.get(c.LOADING.RESOURCES_START),15),r.requestResourceLoad()}.bind(this),function(){gt||this._loadingBox.show()}.bind(this),!0)},{getDatabaseScreen:function(){return new w}}}),define("armada/screens/general-settings",["modules/components","modules/screens","modules/game","modules/analytics","armada/constants","armada/strings","armada/screens/shared","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r,a){"use strict";function l(){e.HTMLScreen.call(this,r.GENERAL_SETTINGS_SCREEN_NAME,r.GENERAL_SETTINGS_SCREEN_SOURCE,{cssFilename:r.GENERAL_SETTINGS_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},r.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(c),this._defaultsButton=this.registerSimpleComponent(u),this._languageSelector=this._registerSelector(_,o.GENERAL_SETTINGS.LANGUAGE.name,h),this._analyticsSelector=this._registerSelector(p,o.GENERAL_SETTINGS.ANALYTICS.name,o.getOnOffSettingValues()),this._analyticsNote=this.registerSimpleComponent(m),this._showDemoButtonSelector=null,a.executeWhenReady(function(){this._showDemoButtonSelector=this._registerSelector(d,o.GENERAL_SETTINGS.SHOW_DEMO_BUTTON.name,o.getOnOffSettingValues(),g)}.bind(this))}var h,c="backButton",u="defaultsButton",_="languageSelector",p="analyticsSelector",d="showDemoButtonSelector",g="lowerSettingsDiv",m="analyticsNote",f=o.getOnOffSettingValues().indexOf(o.get(o.SETTING.ON)),S=o.getOnOffSettingValues().indexOf(o.get(o.SETTING.OFF));return l.prototype=new e.HTMLScreen,l.prototype.constructor=l,l.prototype._applyAndClose=function(){s.setEnabled(this._analyticsSelector.getSelectedIndex()===f),a.setGeneralSetting(a.GENERAL_SETTINGS.SHOW_DEMO_BUTTON,this._showDemoButtonSelector.getSelectedIndex()===f),document.body.style.cursor="wait",i.requestLanguageChange(this._languageSelector.getSelectedValue(),o,function(){document.body.style.cursor=i.getDefaultCursor(),localStorage.setItem(n.LANGUAGE_LOCAL_STORAGE_ID,i.getLanguage()),i.closeOrNavigateTo(r.SETTINGS_SCREEN_NAME)})},l.prototype._registerSelector=function(e,i,s,n){return this.registerExternalComponent(new t.Selector(e,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS},{id:i},s),n||"settingsDiv")},l.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return s.enable(),localStorage.removeItem(n.LANGUAGE_LOCAL_STORAGE_ID),a.resetGeneralSettings(),document.body.style.cursor="wait",i.requestLanguageChange(i.getDefaultLanguage(),o,function(){document.body.style.cursor=i.getDefaultCursor()}),this._updateValues(),!1}.bind(this)},l.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(o.get(o.SETTINGS.DEFAULTS)),this._analyticsSelector.setValueList(o.getOnOffSettingValues()),this._showDemoButtonSelector.setValueList(o.getOnOffSettingValues()),this._updateValues()},l.prototype._updateValues=function(){this._languageSelector.selectValue(i.getLanguage()),this._analyticsSelector.selectValueWithIndex(!0===s.isEnabled()?f:S),this._showDemoButtonSelector.selectValueWithIndex(a.getGeneralSetting(a.GENERAL_SETTINGS.SHOW_DEMO_BUTTON)?f:S)},l.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},{getGeneralSettingsScreen:function(){return h=i.getLanguages(),new l}}}),define("armada/screens/graphics-settings",["utils/utils","modules/application","modules/components","modules/screens","modules/managed-gl","modules/game","armada/strings","armada/screens/shared","armada/graphics","utils/polyfill"],function(t,e,i,s,n,o,r,a,l){"use strict";function h(){s.HTMLScreen.call(this,a.GRAPHICS_SCREEN_NAME,a.GRAPHICS_SCREEN_SOURCE,{cssFilename:a.GRAPHICS_SCREEN_CSS,backgroundClassName:a.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:a.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},a.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(v),this._titleHeading=this.registerSimpleComponent(N),this._defaultsButton=this.registerSimpleComponent(O),this._generalLevelSelector=null,this._antialiasingSelector=null,this._filteringSelector=null,this._textureQualitySelector=null,this._cubemapQualitySelector=null,this._lodSelector=null,this._msInLaunchersSelector=null,this._thrusterLightSourcesSelector=null,this._shaderComplexitySelector=null,this._shadowMappingSelector=null,this._shadowQualitySelector=null,this._shadowDistanceSelector=null,this._maxDynamicLightsSelector=null,this._particleAmountSelector=null,this._dustParticleAmountSelector=null,l.executeWhenReady(function(){this._generalLevelSelector=this._registerSelector(L,r.GRAPHICS.GENERAL_LEVEL.name,d().map(p),X,R,b),this._antialiasingSelector=this._registerSelector(x,r.GRAPHICS.ANTIALIASING.name,r.getOnOffSettingValues(),z),this._filteringSelector=this._registerSelector(D,r.GRAPHICS.FILTERING.name,g().map(p),z),this._textureQualitySelector=this._registerSelector(w,r.GRAPHICS.TEXTURE_QUALITY.name,m().map(p),z),this._cubemapQualitySelector=this._registerSelector(P,r.GRAPHICS.BACKGROUND_QUALITY.name,f().map(p),z),this._lodSelector=this._registerSelector(V,r.GRAPHICS.MODEL_DETAILS.name,S().map(p),z),this._msInLaunchersSelector=this._registerSelector(F,r.GRAPHICS.MISSILES_IN_LAUNCHERS.name,r.getOnOffSettingValues(),z),this._shaderComplexitySelector=this._registerSelector(B,r.GRAPHICS.SHADERS.name,T().map(p),q),this._shadowMappingSelector=this._registerSelector(H,r.GRAPHICS.SHADOWS.name,r.getOnOffSettingValues(),q),this._shadowQualitySelector=this._registerSelector(G,r.GRAPHICS.SHADOW_QUALITY.name,E().map(p),q),this._shadowDistanceSelector=this._registerSelector(k,r.GRAPHICS.SHADOW_DISTANCE.name,y().map(p),q),this._maxDynamicLightsSelector=this._registerSelector(j,r.GRAPHICS.MAX_DYNAMIC_LIGHTS.name,M().map(p),q),this._thrusterLightSourcesSelector=this._registerSelector(U,r.GRAPHICS.THRUSTER_LIGHT_SOURCES.name,r.getOnOffSettingValues(),q),this._particleAmountSelector=this._registerSelector(W,r.GRAPHICS.PARTICLE_AMOUNT.name,I().map(p),z),this._dustParticleAmountSelector=this._registerSelector(Y,r.GRAPHICS.DUST_PARTICLE_AMOUNT.name,C().map(p),q)}.bind(this))}var c=["custom"],u=function(t){return function(i){var s,n=t.PREFIX;return n?(s=r.get(n,i),[s,i]):(e.showError("Cannot find caption string specified for setting '"+i+"', because no prefix is available for the corresponding string category!"),[i,i])}},_=function(t){return n.isAnisotropicFilteringAvailable()||t!==n.TextureFiltering.ANISOTROPIC},p=function(t){return t[0]},d=function(){return l.getGeneralLevelNames().concat(c).map(u(r.SETTING))},g=function(){return t.getEnumValues(n.TextureFiltering).filter(_).map(u(r.GRAPHICS))},m=function(){return l.getTextureQualities().map(u(r.SETTING))},f=function(){return l.getCubemapQualities().map(u(r.SETTING))},S=function(){return l.getLODLevels().map(u(r.SETTING))},T=function(){return l.getShaderComplexities().map(u(r.SETTING))},E=function(){return l.getShadowMapQualities().map(u(r.SETTING))},y=function(){return l.getShadowDistances().map(u(r.SETTING))},M=function(){return l.getPointLightAmounts().map(u(r.SETTING))},I=function(){return l.getParticleAmounts().map(u(r.SETTING))},C=function(){return l.getDustParticleAmounts().map(u(r.SETTING))},A=function(t,e){return e.findIndex(function(e){return e[1]===t})},v="backButton",N="title",O="defaultsButton",L="generalLevelSelector",R="separateSelector",b="smallSelectorPropertyContainer",x="aaSelector",D="filteringSelector",w="textureQualitySelector",P="cubemapQualitySelector",V="lodSelector",F="missilesInLaunchersSelector",U="thrusterLightSourcesSelector",B="shaderComplexitySelector",H="shadowMappingSelector",G="shadowQualitySelector",k="shadowDistanceSelector",j="maxDynamicLightSelector",W="particleAmountSelector",Y="dustParticleAmountSelector",X="generalLevelDiv",z="settingsDivLeft",q="settingsDivRight",J=r.getOnOffSettingValues().indexOf(r.get(r.SETTING.ON)),Q=r.getOnOffSettingValues().indexOf(r.get(r.SETTING.OFF));return h.prototype=new s.HTMLScreen,h.prototype.constructor=h,h.prototype._registerSelector=function(t,e,s,n,o,r){return this.registerExternalComponent(new i.Selector(t,a.SELECTOR_SOURCE,{cssFilename:a.SELECTOR_CSS,selectorClassName:o,propertyContainerClassName:r},{id:e},s),n)},h.prototype._applyAndClose=function(){l.setAntialiasing(this._antialiasingSelector.getSelectedIndex()===J),l.setFiltering(g()[this._filteringSelector.getSelectedIndex()][1]),l.setTextureQuality(m()[this._textureQualitySelector.getSelectedIndex()][1]),l.setCubemapQuality(f()[this._cubemapQualitySelector.getSelectedIndex()][1]),l.setLODLevel(S()[this._lodSelector.getSelectedIndex()][1]),l.setMissilesInLaunchersVisible(this._msInLaunchersSelector.getSelectedIndex()===J),l.setLightSourcesForThrusters(this._thrusterLightSourcesSelector.getSelectedIndex()===J),l.setParticleAmount(I()[this._particleAmountSelector.getSelectedIndex()][1]),l.setDustParticleAmount(C()[this._dustParticleAmountSelector.getSelectedIndex()][1]),l.handleSettingsChanged(),o.closeOrNavigateTo(a.SETTINGS_SCREEN_NAME)},h.prototype._initializeComponents=function(){var t;s.HTMLScreen.prototype._initializeComponents.call(this),t=function(t){0!==t&&this._generalLevelSelector.selectValueWithIndex(d().length-1,0)}.bind(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return l.restoreDefaults(),t(),this._updateValues(),!1}.bind(this),this._generalLevelSelector.onChange=function(t){if(0!==t&&this._generalLevelSelector.getSelectedIndex()===d().length-1)return void(t>0?this._generalLevelSelector.selectNextValue():this._generalLevelSelector.selectPreviousValue());this._generalLevelSelector.getSelectedIndex()!==d().length-1?(l.setGeneralLevel(l.getGeneralLevelNames()[this._generalLevelSelector.getSelectedIndex()]),this._updateComponents()):l.setGeneralLevel(null)}.bind(this),this._antialiasingSelector.onChange=t,this._filteringSelector.onChange=t,this._textureQualitySelector.onChange=t,this._cubemapQualitySelector.onChange=t,this._lodSelector.onChange=t,this._msInLaunchersSelector.onChange=t,this._thrusterLightSourcesSelector.onChange=function(e){l.setLightSourcesForThrusters(this._thrusterLightSourcesSelector.getSelectedIndex()===J),t(e)}.bind(this),this._particleAmountSelector.onChange=t,this._dustParticleAmountSelector.onChange=t,this._shaderComplexitySelector.onChange=function(e){l.setShaderComplexity(T()[this._shaderComplexitySelector.getSelectedIndex()][1]),this._updateShadowMappingSelector(),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),this._updateThrusterLightSourcesSelector(),t(e)}.bind(this),this._shadowMappingSelector.onChange=function(e){l.setShadowMapping(this._shadowMappingSelector.getSelectedIndex()===J),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),t(e)}.bind(this),this._shadowQualitySelector.onChange=function(e){l.setShadowMapQuality(E()[this._shadowQualitySelector.getSelectedIndex()][1]),t(e)}.bind(this),this._shadowDistanceSelector.onChange=function(e){l.setShadowDistance(y()[this._shadowDistanceSelector.getSelectedIndex()][1]),this._updateMaxDynamicLightsSelector(),t(e)}.bind(this),this._maxDynamicLightsSelector.onChange=function(e){l.setPointLightAmount(M()[this._maxDynamicLightsSelector.getSelectedIndex()][1]),this._updateShadowMappingSelector(),this._updateShadowDistanceSelector(),this._updateThrusterLightSourcesSelector(),t(e)}.bind(this)},h.prototype._updateComponents=function(){s.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(r.get(r.SETTINGS.DEFAULTS)),this._generalLevelSelector.setValueList(d().map(p)),this._antialiasingSelector.setValueList(n.isAntialiasingAvailable()?r.getOnOffSettingValues():r.getOffSettingValue()),this._filteringSelector.setValueList(g().map(p)),this._textureQualitySelector.setValueList(m().map(p)),this._cubemapQualitySelector.setValueList(f().map(p)),this._lodSelector.setValueList(S().map(p)),this._msInLaunchersSelector.setValueList(r.getOnOffSettingValues()),this._thrusterLightSourcesSelector.setValueList(r.getOnOffSettingValues()),this._shaderComplexitySelector.setValueList(T().map(p)),this._shadowMappingSelector.setValueList(r.getOnOffSettingValues()),this._shadowQualitySelector.setValueList(E().map(p)),this._shadowDistanceSelector.setValueList(y().map(p)),this._maxDynamicLightsSelector.setValueList(M().map(p)),this._particleAmountSelector.setValueList(I().map(p)),this._dustParticleAmountSelector.setValueList(C().map(p)),this._updateValues()},h.prototype._updateShadowMappingSelector=function(){l.canEnableShadowMapping()?(this._shadowMappingSelector.setValueList(r.getOnOffSettingValues()),this._shadowMappingSelector.selectValueWithIndex(!0===l.isShadowMappingEnabled()?J:Q)):(this._shadowMappingSelector.setValueList(r.getOffSettingValue()),this._shadowMappingSelector.selectValueWithIndex(Q))},h.prototype._updateShadowQualitySelector=function(){l.canEnableShadowMapping()&&l.isShadowMappingEnabled()?(this._shadowQualitySelector.setValueList(E().map(p)),this._shadowQualitySelector.selectValueWithIndex(A(l.getShadowMapQuality(),E()))):(this._shadowQualitySelector.setValueList(r.getOffSettingValue()),this._shadowQualitySelector.selectValueWithIndex(Q))},h.prototype._updateShadowDistanceSelector=function(){l.canEnableShadowMapping()&&l.isShadowMappingEnabled()?(this._shadowDistanceSelector.setValueList(y().map(p)),this._shadowDistanceSelector.selectValueWithIndex(A(l.getShadowDistance(),y()))):(this._shadowDistanceSelector.setValueList(r.getOffSettingValue()),this._shadowDistanceSelector.selectValueWithIndex(Q))},h.prototype._updateMaxDynamicLightsSelector=function(){l.areDynamicLightsAvailable()?(this._maxDynamicLightsSelector.setValueList(M().map(p)),this._maxDynamicLightsSelector.selectValueWithIndex(A(l.getPointLightAmount(),M()))):(this._maxDynamicLightsSelector.setValueList(r.getOffSettingValue()),this._maxDynamicLightsSelector.selectValueWithIndex(Q))},h.prototype._updateThrusterLightSourcesSelector=function(){l.areDynamicLightsAvailable()&&l.getMaxPointLights()>0?(this._thrusterLightSourcesSelector.setValueList(r.getOnOffSettingValues()),this._thrusterLightSourcesSelector.selectValueWithIndex(!0===l.shouldCreateLightSourcesForThrusters()?J:Q)):(this._thrusterLightSourcesSelector.setValueList(r.getOffSettingValue()),this._thrusterLightSourcesSelector.selectValueWithIndex(Q))},h.prototype._updateValues=function(){l.executeWhenReady(function(){var t=l.getGeneralLevel();this._generalLevelSelector.selectValueWithIndex(t?A(t,d()):d().length-1),this._antialiasingSelector.selectValueWithIndex(!0===l.getAntialiasing()?J:Q),this._filteringSelector.selectValueWithIndex(A(l.getFiltering(),g())),this._textureQualitySelector.selectValueWithIndex(A(l.getTextureQuality(),m())),this._cubemapQualitySelector.selectValueWithIndex(A(l.getCubemapQuality(),f())),this._lodSelector.selectValueWithIndex(A(l.getLODLevel(),S())),this._msInLaunchersSelector.selectValueWithIndex(!0===l.areMissilesInLaunchersVisible()?J:Q),this._updateThrusterLightSourcesSelector(),this._shaderComplexitySelector.selectValueWithIndex(A(l.getShaderComplexity(),T())),this._updateShadowMappingSelector(),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),this._particleAmountSelector.selectValueWithIndex(A(l.getParticleAmount(),I())),this._dustParticleAmountSelector.selectValueWithIndex(A(l.getDustParticleAmount(),C()))}.bind(this))},h.prototype.show=function(){return!!s.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},{getGraphicsScreen:function(){return new h}}}),define("armada/screens/audio-settings",["modules/components","modules/screens","modules/game","armada/strings","armada/screens/shared","armada/audio","utils/polyfill"],function(t,e,i,s,n,o){"use strict";function r(){e.HTMLScreen.call(this,n.AUDIO_SCREEN_NAME,n.AUDIO_SCREEN_SOURCE,{backgroundClassName:n.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:n.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._saveAndClose.bind(this)},n.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(a),this._defaultsButton=this.registerSimpleComponent(l),this._masterVolumeSlider=this._registerSlider(h,s.AUDIO.MASTER_VOLUME.name,o.setMasterVolume),this._musicVolumeSlider=this._registerSlider(c,s.AUDIO.MUSIC_VOLUME.name,o.setMusicVolume),this._sfxVolumeSlider=this._registerSlider(u,s.AUDIO.SFX_VOLUME.name,o.setSFXVolume),this._voiceVolumeSlider=this._registerSlider(_,s.AUDIO.VOICE_VOLUME.name,o.setVoiceVolume),this._uiVolumeSlider=this._registerSlider(p,s.AUDIO.UI_VOLUME.name,o.setUIVolume)}var a="backButton",l="defaultsButton",h="masterVolumeSlider",c="musicVolumeSlider",u="sfxVolumeSlider",_="voiceVolumeSlider",p="uiVolumeSlider";return r.prototype=new e.HTMLScreen,r.prototype.constructor=r,r.prototype._saveAndClose=function(){o.setMasterVolume(this._masterVolumeSlider.getValue()),o.setMusicVolume(this._musicVolumeSlider.getValue()),o.setSFXVolume(this._sfxVolumeSlider.getValue()),o.setVoiceVolume(this._voiceVolumeSlider.getValue()),o.setUIVolume(this._uiVolumeSlider.getValue()),i.closeOrNavigateTo(n.SETTINGS_SCREEN_NAME)},r.prototype._registerSlider=function(e,i,s){return this.registerExternalComponent(new t.Slider(e,n.SLIDER_SOURCE,{cssFilename:n.SLIDER_CSS},{id:i},{min:0,max:1,step:.01,default:1},function(t){s(t,!1)}),"settingsDiv")},r.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._saveAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return o.restoreDefaults(),this._updateValues(),!1}.bind(this)},r.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(s.get(s.SETTINGS.DEFAULTS)),this._updateValues()},r.prototype._updateValues=function(){this._masterVolumeSlider.setNumericValue(o.getMasterVolume()),this._musicVolumeSlider.setNumericValue(o.getMusicVolume()),this._sfxVolumeSlider.setNumericValue(o.getSFXVolume()),this._voiceVolumeSlider.setNumericValue(o.getVoiceVolume()),this._uiVolumeSlider.setNumericValue(o.getUIVolume())},r.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(o.resetMasterVolume(),o.resetMusicVolume(),o.resetSFXVolume(),o.resetVoiceVolume(),o.resetUIVolume(),this._updateValues(),!0)},{getAudioScreen:function(){return new r}}}),define("armada/screens/gameplay-settings",["modules/application","modules/components","modules/screens","modules/game","armada/strings","armada/screens/shared","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){i.HTMLScreen.call(this,o.GAMEPLAY_SETTINGS_SCREEN_NAME,o.GAMEPLAY_SETTINGS_SCREEN_SOURCE,{cssFilename:o.GAMEPLAY_SETTINGS_SCREEN_CSS,backgroundClassName:o.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:o.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},o.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(d),this._defaultsButton=this.registerSimpleComponent(g),this._tHullAtCenterSelector=null,this._offsetImpactIndicatorsSelector=null,this._relativeTargetOrientationSelector=null,this._showVersionInfoSelector=null,this._showFpsCounterSelector=null,this._preferredFighterViewSelector=null,this._preferredShipViewSelector=null,this._demoViewSwitchingSelector=null,this._defaultSalvoModeSelector=null,this._showGenericRadioMessagesSelector=null,this._playRadioMessagesSelector=null,this._showReadyMessageSelector=null,r.executeWhenReady(function(){this._tHullAtCenterSelector=this._registerSelector(m,n.GAMEPLAY_SETTINGS.TARGET_HEALTH_AT_CENTER.name),this._offsetImpactIndicatorsSelector=this._registerSelector(f,n.GAMEPLAY_SETTINGS.OFFSET_IMPACT_INDICATORS.name),this._relativeTargetOrientationSelector=this._registerSelector(S,n.GAMEPLAY_SETTINGS.RELATIVE_TARGET_ORIENTATION.name),this._showVersionInfoSelector=this._registerSelector(T,n.GAMEPLAY_SETTINGS.SHOW_VERSION_INFO.name),this._showFpsCounterSelector=this._registerSelector(E,n.GAMEPLAY_SETTINGS.SHOW_FPS_COUNTER.name),this._preferredFighterViewSelector=this._registerSelector(y,n.GAMEPLAY_SETTINGS.PREFERRED_FIGHTER_VIEW.name,O,u()),this._preferredShipViewSelector=this._registerSelector(M,n.GAMEPLAY_SETTINGS.PREFERRED_SHIP_VIEW.name,O,_()),this._demoViewSwitchingSelector=this._registerSelector(I,n.GAMEPLAY_SETTINGS.DEMO_VIEW_SWITCHING.name,O),this._defaultSalvoModeSelector=this._registerSelector(C,n.GAMEPLAY_SETTINGS.DEFAULT_SALVO_MODE.name,L),this._showGenericRadioMessagesSelector=this._registerSelector(A,n.GAMEPLAY_SETTINGS.SHOW_GENERIC_RADIO_MESSAGES.name,R),this._playRadioMessagesSelector=this._registerSelector(v,n.GAMEPLAY_SETTINGS.PLAY_RADIO_MESSAGES.name,R),this._showReadyMessageSelector=this._registerSelector(N,n.GAMEPLAY_SETTINGS.SHOW_READY_MESSAGE.name,b)}.bind(this))}var l,h,c=function(e){return function(i){var s=e.PREFIX;return s?n.get(s,i):(t.showError("Cannot find caption string specified for setting '"+i+"', because no prefix is available for the corresponding string category!"),i)}},u=function(){return l.map(c(n.OBJECT_VIEW))},_=function(){return h.map(c(n.OBJECT_VIEW))},p=function(){return[n.get(n.SETTING.OFF),n.get(n.SETTING.ALL),n.get(n.SETTING.MISSION_ONLY)]},d="backButton",g="defaultsButton",m="targetHullAtCenterSelector",f="offsetImpactIndicatorsSelector",S="relativeTargetOrientationSelector",T="showVersionInfoSelector",E="showFpsCounterSelector",y="preferredFighterViewSelector",M="preferredShipViewSelector",I="demoViewSwitchSelector",C="defaultSalvoModeSelector",A="showGenericRadioMessagesSelector",v="playRadioMessagesSelector",N="showReadyMessage",O="cameraSettingsDiv",L="controlsSettingsDiv",R="radioSettingsDiv",b="otherSettingsDiv",x=n.getOnOffSettingValues().indexOf(n.get(n.SETTING.ON)),D=n.getOnOffSettingValues().indexOf(n.get(n.SETTING.OFF)),w=p().indexOf(n.get(n.SETTING.ALL)),P=p().indexOf(n.get(n.SETTING.MISSION_ONLY));return a.prototype=new i.HTMLScreen,a.prototype.constructor=a,a.prototype._registerSelector=function(t,i,s,r){return this.registerExternalComponent(new e.Selector(t,o.SELECTOR_SOURCE,{cssFilename:o.SELECTOR_CSS},{id:i},r||n.getOnOffSettingValues()),s||"hudSettingsDiv")},a.prototype._applyAndClose=function(){r.setHUDSetting(r.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER,this._tHullAtCenterSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.AIM_ASSIST_CROSSHAIRS,this._offsetImpactIndicatorsSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.RELATIVE_TARGET_ORIENTATION,this._relativeTargetOrientationSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.SHOW_VERSION_INFO,this._showVersionInfoSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.SHOW_FPS_COUNTER,this._showFpsCounterSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME,l[this._preferredFighterViewSelector.getSelectedIndex()]),r.setBattleSetting(r.BS.DEFAULT_SHIP_VIEW_NAME,h[this._preferredShipViewSelector.getSelectedIndex()]),r.setBattleSetting(r.BS.DEMO_VIEW_SWITCHING,this._demoViewSwitchingSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.DEFAULT_SALVO_MODE,this._defaultSalvoModeSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.SHOW_GENERIC_RADIO_MESSAGES,this._showGenericRadioMessagesSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.PLAY_GENERIC_RADIO_MESSAGES,this._playRadioMessagesSelector.getSelectedIndex()===w),r.setBattleSetting(r.BS.PLAY_MISSION_RADIO_MESSAGES,this._playRadioMessagesSelector.getSelectedIndex()!==D),r.setBattleSetting(r.BS.SHOW_READY_MESSAGE,this._showReadyMessageSelector.getSelectedIndex()===x),s.closeOrNavigateTo(o.SETTINGS_SCREEN_NAME)},a.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return r.resetHUDSettings(),r.resetBattleSettings(),this._updateValues(),!1}.bind(this)},a.prototype._updateComponents=function(){i.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(n.get(n.SETTINGS.DEFAULTS)),this._tHullAtCenterSelector.setValueList(n.getOnOffSettingValues()),this._offsetImpactIndicatorsSelector.setValueList(n.getOnOffSettingValues()),this._relativeTargetOrientationSelector.setValueList(n.getOnOffSettingValues()),this._showVersionInfoSelector.setValueList(n.getOnOffSettingValues()),this._showFpsCounterSelector.setValueList(n.getOnOffSettingValues()),this._preferredFighterViewSelector.setValueList(u()),this._preferredShipViewSelector.setValueList(_()),this._demoViewSwitchingSelector.setValueList(n.getOnOffSettingValues()),this._defaultSalvoModeSelector.setValueList(n.getOnOffSettingValues()),this._showGenericRadioMessagesSelector.setValueList(n.getOnOffSettingValues()),this._playRadioMessagesSelector.setValueList(p()),this._showReadyMessageSelector.setValueList(n.getOnOffSettingValues()),r.getGeneralSetting(r.GENERAL_SETTINGS.SHOW_DEMO_BUTTON)?this._demoViewSwitchingSelector.show():this._demoViewSwitchingSelector.hide(),this._updateValues()},a.prototype._updateValues=function(){r.executeWhenReady(function(){this._tHullAtCenterSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER)?x:D),this._offsetImpactIndicatorsSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.AIM_ASSIST_CROSSHAIRS)?x:D),this._relativeTargetOrientationSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.RELATIVE_TARGET_ORIENTATION)?x:D),this._showVersionInfoSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.SHOW_VERSION_INFO)?x:D),this._showFpsCounterSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.SHOW_FPS_COUNTER)?x:D),this._preferredFighterViewSelector.selectValueWithIndex(l.indexOf(r.getBattleSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME))),this._preferredShipViewSelector.selectValueWithIndex(h.indexOf(r.getBattleSetting(r.BS.DEFAULT_SHIP_VIEW_NAME))),this._demoViewSwitchingSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.DEMO_VIEW_SWITCHING)?x:D),this._defaultSalvoModeSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.DEFAULT_SALVO_MODE)?x:D),this._showGenericRadioMessagesSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.SHOW_GENERIC_RADIO_MESSAGES)?x:D),this._playRadioMessagesSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.PLAY_GENERIC_RADIO_MESSAGES)?w:!0===r.getBattleSetting(r.BS.PLAY_MISSION_RADIO_MESSAGES)?P:D),this._showReadyMessageSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.SHOW_READY_MESSAGE)?x:D)}.bind(this))},a.prototype.show=function(){return!!i.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},r.executeWhenReady(function(){l=r.getSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME_OPTIONS),h=r.getSetting(r.BS.DEFAULT_SHIP_VIEW_NAME_OPTIONS)}),{getGameplaySettingsScreen:function(){return new a}}}),define("armada/screens/control-settings",["utils/utils","modules/screens","modules/components","modules/game","modules/control/gamepad","armada/strings","armada/screens/shared","armada/control"],function(t,e,i,s,n,o,r,a){"use strict";function l(e){var i;return i=e.indexOf(" (Vendor:"),i<0&&(i=e.indexOf(" (STANDARD GAMEPAD")),i>=0?e.substring(0,i):e.length>10&&t.isHexString(e.substring(0,4))&&"-"===e[4]&&t.isHexString(e.substring(5,9))&&"-"===e[9]?e.substring(10):e}function h(){return a.getInputInterpreter(a.GAMEPAD_NAME).getProfiles().map(function(t){return o.get(o.CONTROLLER_PROFILE.PREFIX,t,t)})}function c(){return[o.get(o.CONTROLLER_PROFILE.NONE)]}function u(t,e){document.getElementById(e).innerHTML=a.getInputInterpreter(t).getControlStringForAction(e),document.getElementById(e).className=b}function _(){null!==B&&(u(a.KEYBOARD_NAME,B),B=null,document.onkeydown=null,document.onkeyup=null)}function p(t){t.keyCode===w&&(H=!0),t.keyCode===P&&(G=!0),t.keyCode===V&&(k=!0)}function d(e){e.keyCode===w?H=!1:e.keyCode===P?G=!1:e.keyCode===V&&(k=!1),a.getInputInterpreter(a.KEYBOARD_NAME).setAndStoreBinding({action:B,key:t.getKeyOfCode(e.keyCode),shift:H,ctrl:G,alt:k}),_()}function g(t){var e=t.getAttribute("id");B===e?_():(_(),B=e,t.innerHTML=D,t.className=x,H=!1,G=!1,k=!1,document.onkeydown=function(t){p(t),t.preventDefault()},document.onkeyup=function(t){d(t),t.preventDefault()})}function m(){e.HTMLScreen.call(this,r.CONTROLS_SCREEN_NAME,r.CONTROLS_SCREEN_SOURCE,{cssFilename:r.CONTROLS_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:function(){B?"quit"!==B&&_():this._applyAndClose()}.bind(this)},r.BUTTON_EVENT_HANDLERS),this._detectGamepadsInterval=-1,this._gamepadOptions=null,this._backButton=this.registerSimpleComponent(f),this._titleHeading=this.registerSimpleComponent(S),this._settingsTitle=this.registerSimpleComponent(E),this._settingsContainer=this.registerSimpleComponent(y),this._controllerSettingsContainer=this.registerSimpleComponent(C),this._noController=this.registerSimpleComponent(I),this._mouseTurnSensitivitySlider=this.registerExternalComponent(new i.Slider(A,r.SLIDER_SOURCE,{cssFilename:r.SLIDER_CSS},{id:o.CONTROLS.MOUSE_TURN_SENSITIVITY.name},{min:.1,max:.5,step:.01,default:.25},function(t){a.getInputInterpreter(a.MOUSE_NAME).setAndStoreDisplacementAreaRelativeSize(1-t)}),M),this._pointerLockSelector=this.registerExternalComponent(new i.Selector(v,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS,selectorClassName:N},{id:o.CONTROLS.POINTER_LOCK.name},o.getOnOffSettingValues()),M),this._controllerSelector=this.registerExternalComponent(new i.Selector(O,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS},{id:o.CONTROLS.CONTROLLER.name},[]),C),this._controllerProfileSelector=this.registerExternalComponent(new i.Selector(L,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS},{id:o.CONTROLS.CONTROLLER_PROFILE.name},h()),C),this._vibrationEnabledSelector=this.registerExternalComponent(new i.Selector(R,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS},{id:o.CONTROLS.VIBRATION_ENABLED.name},o.getOnOffSettingValues()),C),this._defaultsButton=this.registerSimpleComponent(T)}var f="backButton",S="title",T="defaultsButton",E="settingsTitle",y="settingsContainer",M="mouseSettingsContainer",I="noController",C="controllerSettingsContainer",A="mouseTurnSensitivitySlider",v="pointerLockSelector",N="pointerLock selector",O="controllerSelector",L="controllerProfileSelector",R="vibrationEnabledSelector",b="clickable",x="highlightedItem",D="?",w=16,P=17,V=18,F=o.getOnOffSettingValues().indexOf(o.get(o.SETTING.ON)),U=o.getOnOffSettingValues().indexOf(o.get(o.SETTING.OFF)),B=null,H=!1,G=!1,k=!1;return m.prototype=new e.HTMLScreen,m.prototype.constructor=m,m.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return _(),a.restoreDefaults(),this._updateValues(),this._generateTables(),!1}.bind(this),this._settingsTitle._element.onclick=function(){this._settingsContainer.setVisible(!this._settingsContainer.isVisible()),
r.playButtonClickSound(!0)}.bind(this),this._settingsTitle._element.onmouseenter=function(){r.playButtonSelectSound(!0)}.bind(this),this._controllerSelector.onChange=function(t){var e;0!==t&&(e=this._controllerSelector.getSelectedIndex(),a.getInputInterpreter(a.GAMEPAD_NAME).setGamepad(e<this._gamepadOptions.length?this._gamepadOptions[e]:null)),this._updateValues()}.bind(this),this._controllerProfileSelector.onChange=function(t){var e,i;0!==t&&(e=this._controllerProfileSelector.getSelectedIndex(),i=a.getInputInterpreter(a.GAMEPAD_NAME),i.setProfile(i.getProfiles()[e],!0)),this._generateTables()}.bind(this),this._vibrationEnabledSelector.onChange=function(t){0!==t&&a.getInputInterpreter(a.GAMEPAD_NAME).setVibrationEnabled(this._vibrationEnabledSelector.getSelectedIndex()===F),this._generateTables()}.bind(this),this._settingsContainer.hide()},m.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._pointerLockSelector.setValueList(a.isPointerLockSupported()?o.getOnOffSettingValues():o.getOffSettingValue()),this._defaultsButton.setContent(o.get(o.SETTINGS.DEFAULTS)),this._updateValues(),this._generateTables()},m.prototype._applyAndClose=function(){_(),a.setPointerLockEnabled(this._pointerLockSelector.getSelectedIndex()===F),s.closeOrNavigateTo(r.SETTINGS_SCREEN_NAME)},m.prototype._generateTables=function(){a.executeWhenReady(function(){var e,i,s,n,l,h,c,u,_,p,d,m,f,S,T=this.getElement("tablesContainer"),E=a.getControllers(),y={},M=function(t){var e=this.getElement(t);e.hidden=!e.hidden,r.playButtonClickSound(!0)},I=function(){r.playButtonSelectSound(!0)},C=function(){g(this)};for(T.innerHTML="",e=0;e<E.length;e++){for(l="table_"+E[e].getType(),h=document.createElement("h2"),h.innerHTML=t.formatString(o.get(o.CONTROLS.CONTROLLER_TYPE_HEADING),{controllerType:o.get(o.CONTOLLER.PREFIX,E[e].getType())}),h.className="controls tableTitle",h.onclick=M.bind(this,l),h.onmouseenter=I,T.appendChild(h),c=document.createElement("table"),c.id=this._getElementID(l),c.className="controlsTable outerContainer",u=document.createElement("thead"),i=0,n=a.getInputInterpreters().length;i<n;i++)_=document.createElement("th"),_.innerHTML=o.get(o.INPUT.DEVICE_NAME_PREFIX,a.getInputInterpreters()[i].getDeviceName()),u.appendChild(_);for(u.innerHTML+="<th>"+o.get(o.CONTROLS.ACTION)+"</th>",p=document.createElement("tbody"),d=E[e].getActions(),i=0;i<d.length;i++)y[d[i]._name]=o.ACTION_DESCRIPTIONS.PREFIX.name+d[i]._name;for(i=0;i<d.length;i++){for(m=document.createElement("tr"),s=0,n=a.getInputInterpreters().length;s<n;s++)f=document.createElement("td"),a.getInputInterpreters()[s].getDeviceName()===a.KEYBOARD_NAME&&(f.setAttribute("id",d[i]._name),f.className=b,f.onclick=C),f.innerHTML=a.getInputInterpreters()[s].getControlStringForAction(d[i]._name),m.appendChild(f);S=document.createElement("td"),S.innerHTML=o.get(o.ACTION_DESCRIPTIONS.PREFIX,d[i]._name),m.appendChild(S),p.appendChild(m)}c.appendChild(u),c.appendChild(p),c.hidden=!0,T.appendChild(c)}}.bind(this))},m.prototype._updateControllers=function(){var t,e,i,s,r,u;for(u=a.getInputInterpreter(a.GAMEPAD_NAME),t=n.getDevices(),e=[],this._gamepadOptions=[],i=0;i<t.length;i++)t[i]&&(e.push(l(t[i].id)),this._gamepadOptions.push(t[i]));e.length>0?(e.push(o.get(o.CONTROLS.CONTROLLER_DISABLED)),this._controllerSelector.setValueList(e),r=u.updateGamepad(),s=this._gamepadOptions.indexOf(r),this._controllerSelector.selectValueWithIndex(r?s>=0?s:0:this._gamepadOptions.length),this._noController.hide(),this._controllerSettingsContainer.show()):(this._noController.show(),this._controllerSettingsContainer.hide()),this._controllerSelector.getSelectedIndex()<this._gamepadOptions.length?(this._controllerProfileSelector.setValueList(h()),this._controllerProfileSelector.selectValueWithIndex(u.getProfiles().indexOf(u.getProfile())),this._vibrationEnabledSelector.setValueList(u.isVibrationSupported()?o.getOnOffSettingValues():o.getOffSettingValue()),this._vibrationEnabledSelector.selectValueWithIndex(u.isVibrationSupported()&&u._vibrationEnabled?F:U)):(this._controllerProfileSelector.setValueList(c()),this._controllerProfileSelector.selectValueWithIndex(0),this._vibrationEnabledSelector.setValueList(o.getOffSettingValue()),this._vibrationEnabledSelector.selectValueWithIndex(0))},m.prototype._updateValues=function(){this._mouseTurnSensitivitySlider.setNumericValue(1-a.getInputInterpreter(a.MOUSE_NAME).getDisplacementAreaRelativeSize()),this._pointerLockSelector.selectValueWithIndex(a.isPointerLockEnabled()?F:U),this._updateControllers()},m.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},m.prototype.setActive=function(t){e.HTMLScreen.prototype.setActive.call(this,t),t?this._detectGamepadsInterval=setInterval(this._updateControllers.bind(this),1e3):this._detectGamepadsInterval>=0&&(clearInterval(this._detectGamepadsInterval),this._detectGamepadsInterval=-1)},{getControlsScreen:function(){return new m}}}),define("armada/screens/about",["modules/game","modules/screens","armada/strings","armada/screens/shared"],function(t,e,i,s){"use strict";function n(t,e){return t.textContent.localeCompare(e.textContent)}function o(t,e){return'<a target="_blank" rel="noopener" href="'+t+'">'+e+"</a>"}function r(){e.HTMLScreen.call(this,s.ABOUT_SCREEN_NAME,s.ABOUT_SCREEN_SOURCE,{cssFilename:s.ABOUT_SCREEN_CSS,backgroundClassName:s.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:s.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:function(){t.closeOrNavigateTo(s.MAIN_MENU_SCREEN_NAME)}},s.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(a),this._versionParagraph=this.registerSimpleComponent(l),this._aboutGameDevParagraph=this.registerSimpleComponent(h),this._aboutLicenseParagraph=this.registerSimpleComponent(u),this._aboutUsedSoftwareParagraph=this.registerSimpleComponent(c),this._aboutLicenseElectronParagraph=this.registerSimpleComponent(_)}var a="backButton",l="versionParagraph",h="aboutGameDevParagraph",c="usedSoftwareParagraph",u="licenseParagraph",_="licenseElectronParagraph";return r.prototype=new e.HTMLScreen,r.prototype.constructor=r,r.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return t.closeOrNavigateTo(s.MAIN_MENU_SCREEN_NAME),!1}.bind(this)},r.prototype._updateComponents=function(){var s,r,a,l,h,c,u;for(e.HTMLScreen.prototype._updateComponents.call(this),this._versionParagraph.customizeContent({version:t.getVersion()+" ("+t.getPlatform()+")"}),this._aboutGameDevParagraph.customizeContent({facebook:o("https://www.facebook.com/interstellar.armada","facebook"),github:o("https://github.com/nkrisztian89/interstellar-armada","github"),patreon:o("https://www.patreon.com/c/Entian","Patreon"),email:o("mailto:armada.galactic.ace@gmail.com","email")}),this._aboutUsedSoftwareParagraph.customizeContent({inkscape:o("https://inkscape.org","Inkscape"),blender:o("https://www.blender.org/","Blender"),gimp:o("https://www.gimp.org","GIMP"),audacity:o("https://www.audacityteam.org","Audacity"),bfxr:o("https://www.bfxr.net","Bfxr"),lmms:o("https://lmms.io","LMMS"),fontforge:o("https://fontforge.org/en-US","FontForge"),netbeans:o("https://netbeans.apache.org","Netbeans"),vscode:o("https://code.visualstudio.com","Visual Studio Code"),git:o("https://git-scm.com/","git"),npm:o("https://www.npmjs.com/","npm"),grunt:o("https://gruntjs.com/","Grunt"),sass:o("https://sass-lang.com","Sass"),lazarus:o("https://www.lazarus-ide.org","Lazarus"),chrome:o("https://www.google.com/chrome","Google Chrome"),firefox:o("https://www.mozilla.org/firefox","Firefox"),ubuntu:o("https://ubuntu.com/desktop","Ubuntu"),elevenlabs:o("https://elevenlabs.io","ElevenLabs")}),this._aboutLicenseParagraph.customizeContent({license:o("https://www.gnu.org/licenses/gpl-3.0-standalone.html","GNU GPLv3"),sansation:o("https://www.dafont.com/sansation.font","Sansation"),aldrich:o("https://fonts.google.com/specimen/Aldrich","Aldrich"),audiowide:o("https://fonts.google.com/specimen/Audiowide","Audiowide"),fontlog:o("assets/fonts/FONTLOG.txt","fontlog"),requireJS:o("https://requirejs.org","RequireJS"),requireJSLicense:o("license/RequireJS-License.txt",i.get(i.ABOUT.REQUIRE_JS_LICENSE)),assetLicense:o("https://creativecommons.org/licenses/by/4.0/","CC BY 4.0"),soundLicense:o("license/sfx-license.txt",i.get(i.ABOUT.HERE)),elevenlabs:o("https://elevenlabs.io","ElevenLabs"),elevenlabsTerms:o("https://elevenlabs.io/terms-of-use-eu",i.get(i.ABOUT.ELEVENLABS_TERMS))}),t.usesElectron()?(this._aboutLicenseElectronParagraph.customizeContent({electron:o("https://www.electronjs.org","Electron"),electronLicense:o("https://github.com/electron/electron/blob/main/LICENSE",i.get(i.ABOUT.ELECTRON_LICENSE))}),this._aboutLicenseElectronParagraph.show()):this._aboutLicenseElectronParagraph.hide(),"magyar"===i.getLanguage()?(c=!0,s=this._container.querySelectorAll(".huName:not(.reversed)")):(c=!1,s=this._container.querySelectorAll(".huName.reversed")),r=0;r<s.length;r++)l=c?s[r].textContent.lastIndexOf(" "):s[r].textContent.indexOf(" "),h=[s[r].textContent.substring(0,l),s[r].textContent.substring(l+1)],s[r].textContent=h[1]+" "+h[0],s[r].classList.toggle("reversed");for(u=this._container.querySelectorAll(".orderedNameList"),r=0;r<u.length;r++)for(s=Array.prototype.slice.call(u[r].getElementsByTagName("li")),s.sort(n),a=0;a<s.length;a++)u[r].appendChild(s[a])},{getAboutScreen:function(){return new r}}}),define("armada/screens/dialog",["modules/game","modules/screens","armada/screens/shared"],function(t,e,i){"use strict";function s(){e.HTMLScreen.call(this,i.DIALOG_SCREEN_NAME,i.DIALOG_SCREEN_SOURCE,{cssFilename:i.DIALOG_SCREEN_CSS,backgroundClassName:i.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:i.SCREEN_CONTAINER_CLASS_NAME},void 0,{left:this._selectPrevious.bind(this),right:this._selectNext.bind(this),enter:this._activateSelected.bind(this),escape:function(){t.closeSuperimposedScreen(),this._onClose&&this._onClose()}.bind(this)}),this._header=this.registerSimpleComponent(n),this._message=this.registerSimpleComponent(o),this._leftButton=this.registerSimpleComponent(r),this._middleButton=this.registerSimpleComponent(a),this._rightButton=this.registerSimpleComponent(l),this._buttons=[this._leftButton,this._middleButton,this._rightButton],this._selectedIndex=-1,this._activeButtonCount=0,this._buttonLeaveHandler=this._selectIndex.bind(this,-1),this._onClose=null}var n="header",o="message",r="leftButton",a="middleButton",l="rightButton";return s.prototype=new e.HTMLScreen,s.prototype.constructor=s,s.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&this._buttons[this._selectedIndex].unselect(),this._selectedIndex=t,this._selectedIndex>=0&&(this._buttons[this._selectedIndex].select(),i.playButtonSelectSound(!0)))},s.prototype._selectNext=function(){this._selectIndex((this._selectedIndex+1)%this._activeButtonCount)},s.prototype._selectPrevious=function(){var t=this._selectedIndex>0?this._selectedIndex:this._activeButtonCount;this._selectIndex((t-1)%this._buttons.length)},s.prototype._activateSelected=function(){this._selectedIndex>=0&&this._buttons[this._selectedIndex]._element.onclick()},s.prototype.setActive=function(t){e.HTMLScreen.prototype.setActive.call(this,t),this._selectIndex(-1)},s.prototype._createButtonClickHandler=function(t){return function(){t(),i.playButtonClickSound(!0)}},s.prototype.setup=function(t){var e;for(this._onClose=t.onClose,this._header.setVisible(t.header&&t.header.length>0),this._header.isVisible()&&this._header.setContent(t.header),t.messageClass&&(this._message._element.className+=" "+t.messageClass),this._message.setContent(t.message),e=0;e<this._buttons.length;e++)this._buttons[e]._element.onclick=null,this._buttons[e]._element.onmousemove=null,this._buttons[e]._element.onmouseleave=null;for(e=0;e<t.buttons.length;e++)this._buttons[e].setContent(t.buttons[e].caption),this._buttons[e]._element.onclick=this._createButtonClickHandler(t.buttons[e].action),this._buttons[e]._element.onmousemove=this._selectIndex.bind(this,e),this._buttons[e]._element.onmouseleave=this._buttonLeaveHandler,this._buttons[e].show();for(this._activeButtonCount=t.buttons.length;e<this._buttons.length;)this._buttons[e].hide(!0),e++},{getDialogScreen:function(){return new s}}}),define("armada/armada",["modules/game","modules/components","modules/analytics","modules/scene/lights","armada/constants","armada/graphics","armada/audio","armada/configuration","armada/logic/environments","armada/logic/missions","armada/logic/mission-hub","armada/control","armada/strings","armada/networking","armada/announcements","armada/screens/shared","armada/screens/menus","armada/screens/missions","armada/screens/multi-games","armada/screens/multi-lobby","armada/screens/battle","armada/screens/debriefing","armada/screens/multi-score","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/audio-settings","armada/screens/gameplay-settings","armada/screens/control-settings","armada/screens/about","armada/screens/dialog"],function(t,e,i,s,n,o,r,a,l,h,c,u,_,p,d,g,m,f,S,T,E,y,M,I,C,A,v,N,O,L,R){"use strict";var b=document.getElementById("splashProgress");return b.max=6,t.setGameName(n.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(!1),t.setPreviouslyRunVersion(localStorage[n.VERSION_LOCAL_STORAGE_ID]),t._loadGameSettingsAndExecuteCallback=function(t,e){o.loadSettingsFromJSON(t.graphics),o.loadSettingsFromLocalStorage(),r.loadSettingsFromJSON(t.audio),r.loadSettingsFromLocalStorage(),a.loadSettingsFromJSON(t.logic),u.loadSettingsFromJSON(t.control),u.loadSettingsFromLocalStorage(),h.loadSettingsFromLocalStorage(),o.executeWhenReady(function(){s.setupLiSPSM(o.getLispsmMinimumNear(),o.getLispsmNearFactor())}),a.executeWhenReady(function(){l.requestLoad(),l.executeWhenReady(function(){b.value=2,h.requestLoad(!1),h.executeWhenReady(function(){b.value=3,e()})})})},t._loadGameConfigurationAndExecuteCallback=function(e,s){var n=t.showError;a.loadConfigurationFromJSON(e.dataFiles.logic),o.loadConfigurationFromJSON(e.graphics),r.loadConfigurationFromJSON(e.audio),h.loadConfigurationFromJSON(e.logic),u.loadConfigurationFromJSON(e.control),b.value=1,e.analyticsEnabled&&i.init(e.analyticsUrl),p.init(e.multiUrl),c.init(e.missionHubUrl),d.init(e.announcementsUrl),t.showError=function(t,e,s){i.sendEvent("error",void 0,{message:t.length>120?t.substr(0,120)+"...":t}),n(t,e,s)},document.getElementById(g.GAME_VERSION_LABEL_ID).textContent=t.getVersion(),s()},t._buildScreensAndExecuteCallback=function(i){t.addScreen(m.getMainMenuScreen()),t.addScreen(m.getSinglePlayerMenuScreen()),t.addScreen(f.getMissionsScreen()),t.addScreen(S.getMultiGamesScreen()),t.addScreen(T.getMultiLobbyScreen()),t.addScreen(E.getBattleScreen()),t.addScreen(y.getDebriefingScreen()),t.addScreen(M.getMultiScoreScreen()),t.addScreen(I.getDatabaseScreen()),t.addScreen(m.getSettingsMenuScreen()),t.addScreen(C.getGeneralSettingsScreen()),t.addScreen(A.getGraphicsScreen()),t.addScreen(v.getAudioScreen()),t.addScreen(N.getGameplaySettingsScreen()),t.addScreen(O.getControlsScreen()),t.addScreen(L.getAboutScreen()),t.addScreen(m.getIngameMenuScreen(),!0),t.addScreen(R.getDialogScreen(),!0),b.value=4,t.executeWhenAllScreensReady(function(){b.value=5,t.requestLanguageChange(localStorage.getItem(n.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),_,function(){b.value=6,e.clearStoredDOMModels(),localStorage[n.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),g.initAudio(i)})})},t}),requirejs(["armada/armada"],function(t){"use strict";t.initialize({electron:location.hash.indexOf("electron")>=0,local:location.hash.indexOf("local")>=0})}),define("main",function(){});